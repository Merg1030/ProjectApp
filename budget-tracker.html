<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNZA ¬∑ Project Gantt (Daily, no Sundays)</title>
    
    <!-- Firebase SDK v8 (compat) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        html, body {
            height: 100%;
            background: #0b1a2b;
            overflow: hidden;
        }
        .gantt-full {
            height: 100vh;
            width: 100vw;
            background: #fafcff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        /* professional header */
        .top-space {
            padding: 0.8rem 2rem 0.8rem 2rem;
            background: #ffffff;
            border-bottom: 1px solid #dde3ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .project-headline {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .project-headline h2 {
            font-weight: 500;
            font-size: 1.2rem;
            color: #0c2b4b;
            letter-spacing: -0.01em;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .project-headline h2 span {
            background: #e9eff7;
            padding: 0.2rem 0.8rem;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #1b4c7c;
            margin-left: 0.5rem;
        }
        .project-badge {
            background: #e2eaf3;
            border-radius: 40px;
            padding: 0.25rem 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: #1c4b77;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            border: 1px solid #c6d6eb;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f1f5fb;
            padding: 0.3rem 1rem;
            border-radius: 40px;
            font-size: 0.75rem;
            color: #1e3e64;
            border: 1px solid #c8d7ec;
        }
        .filter-toggle input {
            accent-color: #2b6c9e;
            width: 16px; height: 16px;
            margin: 0;
        }
        .toggle-form-btn {
            background: #ffffff;
            border: 1px solid #b9cae6;
            padding: 0.4rem 1.2rem;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 500;
            color: #1e3a5c;
            cursor: pointer;
            transition: 0.1s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .toggle-form-btn:hover {
            background: #ecf3fd;
            border-color: #7f9bc2;
        }
        .nav-buttons {
            display: flex;
            gap: 0.6rem;
        }
        .nav-btn {
            background: #f2f6fc;
            border: 1px solid #c6d4e8;
            padding: 0.4rem 1rem;
            border-radius: 40px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            color: #1f4172;
            transition: 0.1s;
        }
        .nav-btn:hover {
            background: #e2ebf7;
            border-color: #8fa9cc;
        }
        /* form */
        .form-popup {
            background: #f5f9ff;
            border-bottom: 2px solid #b1c8e5;
            padding: 1rem 2rem;
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(150px, auto));
            gap: 20px;
            align-items: end;
            flex-shrink: 0;
        }
        .form-popup.visible {
            display: grid;
        }
        .form-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.7rem;
            color: #1e4170;
        }
        .form-field input, .form-field select {
            padding: 0.5rem 1rem;
            border: 1px solid #b9ceec;
            border-radius: 30px;
            font-size: 0.75rem;
            background: white;
        }
        .form-field button {
            background: #1c3f64;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 14px;
        }
        /* Gantt scroll - FULL HEIGHT */
        .gantt-scroll {
            flex: 1;
            overflow: auto;
            background: #ffffff;
            display: flex;
            flex-direction: column;
        }
        .gantt-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
            table-layout: fixed;
            font-size: 0.7rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        thead {
            flex-shrink: 0;
        }
        tbody {
            flex: 1;
            display: block;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
        }
        .gantt-table th {
            background: #1d344c;
            color: #ffffff;
            font-weight: 500;
            padding: 0.7rem 0.2rem;
            border-right: 1px solid #3f5670;
            border-bottom: 2px solid #577599;
            position: sticky;
            top: 0;
            z-index: 20;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: table-cell;
        }
        .gantt-table td {
            padding: 0.5rem 0.2rem;
            border-bottom: 1px solid #e3e9f2;
            border-right: 1px solid #dce3ef;
            vertical-align: middle;
            display: table-cell;
        }
        .gantt-table tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        .task-col {
            width: 260px;
            background: white;
            position: sticky;
            left: 0;
            z-index: 15;
            cursor: context-menu;
            font-weight: 400;
            min-width: 260px;
        }
        .task-col-header {
            position: sticky;
            left: 0;
            z-index: 21;
            background: #1d344c;
        }
        .date-col-header {
            position: sticky;
            left: 260px;
            z-index: 21;
        }
        .task-main {
            font-weight: 600;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            background: #2e7d32;
            padding: 6px 10px;
            border-radius: 4px;
            margin: -2px;
        }
        .task-main .task-number {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
        }
        .subtask-item {
            padding-left: 32px;
            font-size: 0.75rem;
            color: #2f4b70;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .subtask-item .task-number {
            color: #5f7b9c;
            min-width: 35px;
        }
        /* hidden columns */
        .hide-col .date-col,
        .hide-col .pred-col,
        .hide-col .budget-col,
        .hide-col .status-col {
            display: none;
        }
        .date-col { width: 55px; text-align: center; font-family: 'JetBrains Mono', monospace; }
        .pred-col { width: 50px; text-align: center; }
        .budget-col { width: 65px; text-align: right; padding-right: 8px; }
        .status-col { width: 70px; text-align: center; }
        .gantt-col { padding: 0.2rem 0 !important; }
        .timeline-box {
            position: relative;
            width: 100%;
            height: 36px;
            background: #f1f7fe;
            border-radius: 3px;
        }
        .task-bar {
            position: absolute;
            height: 22px;
            top: 7px;
            background: #2b5f8a;
            border-radius: 4px;
            border: 1px solid #153a58;
            min-width: 6px;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .subtask-bar {
            background: #60758b;
            height: 18px;
            top: 9px;
            border-color: #3a4d63;
        }
        .completion-overlay {
            position: absolute;
            height: 22px;
            top: 7px;
            background: #2f8b5e;
            border-radius: 4px 0 0 4px;
            opacity: 0.9;
            pointer-events: none;
            z-index: 5;
        }
        .subtask-bar + .completion-overlay {
            height: 18px;
            top: 9px;
        }
        .hold-marker {
            position: absolute;
            width: 6px;
            height: 30px;
            background: #e68a2e;
            top: 3px;
            border-radius: 2px;
            z-index: 12;
            pointer-events: none;
        }
        .milestone-dot {
            position: absolute;
            width: 8px; height: 8px;
            background: #947c5c;
            transform: rotate(45deg);
            top: 14px;
            border: 1px solid white;
        }
        /* Calendar Header - Month and Day labels */
        .calendar-header-row {
            background: #e8f0fb;
            position: sticky;
            top: 0;
            z-index: 19;
        }
        .calendar-header-row td {
            padding: 0 !important;
            height: auto;
        }
        .calendar-month-cell {
            text-align: center;
            font-weight: 700;
            color: #1d344c;
            font-size: 0.9rem;
            padding: 8px !important;
            position: sticky;
            left: 0;
            z-index: 20;
            background: #e8f0fb;
            min-width: 260px;
        }
        .day-header-row {
            background: #d4e4f5;
            position: sticky;
            top: 32px;
            z-index: 19;
        }
        .day-header-row td {
            padding: 0 !important;
        }
        .day-header-cell {
            text-align: center;
            font-weight: 600;
            color: #1d344c;
            font-size: 0.7rem;
            padding: 6px 0 !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .day-header-task-col {
            position: sticky;
            left: 0;
            z-index: 20;
            background: #d4e4f5;
            min-width: 260px;
        }
        .date-number-row {
            background: #ffffff;
            position: sticky;
            top: 60px;
            z-index: 19;
        }
        .date-number-row td {
            padding: 0 !important;
        }
        .date-number-cell {
            text-align: center;
            font-weight: 700;
            color: #2d5a8c;
            font-size: 0.75rem;
            padding: 4px 0 !important;
            border-bottom: 2px solid #c2d2e8;
        }
        .date-number-task-col {
            position: sticky;
            left: 0;
            z-index: 20;
            background: #ffffff;
            min-width: 260px;
            border-right: 1px solid #dce3ef;
        }
        /* daily ticks container */
        .daily-tick-container {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: flex-end;
            background: #ffffff08;
        }
        .day-tick {
            flex: 1 0 auto;
            font-size: 0.55rem;
            color: #1b3c62;
            border-left: 1px solid #bed4f0;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 2px;
            background: rgba(255,255,255,0.2);
            white-space: nowrap;
        }
        .day-tick span {
            background: #f2f8ff;
            padding: 2px 2px;
            border-radius: 3px;
            font-weight: 500;
        }
        .sunday-tick {
            background: #ffe9e9;
            display: none;
        }
        .bottom-space {
            padding: 0.8rem 2rem 0.9rem 2rem;
            background: #ffffff;
            border-top: 1px solid #c2d2e8;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .completion-bar-container {
            flex: 1;
            height: 14px;
            background: #e2e9f3;
            border-radius: 30px;
            overflow: hidden;
            border: 1px solid #a5bbda;
        }
        .completion-bar-fill {
            height: 100%;
            background: #2e7d5e;
            width: 0%;
            transition: width 0.2s;
        }
        .completion-label {
            font-size: 0.7rem;
            color: #1d3a5c;
            min-width: 100px;
            font-weight: 500;
        }
        .context-menu, .date-picker-popup {
            position: absolute;
            background: white;
            border: 1px solid #a0b9d9;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
            padding: 5px 0;
        }
        .context-menu-item {
            padding: 8px 18px;
            font-size: 0.75rem;
            cursor: pointer;
            color: #1a3455;
        }
        .context-menu-item:hover {
            background: #e2ecfc;
        }
        .date-picker-popup {
            padding: 16px;
            gap: 12px;
        }
        .date-picker-popup input {
            padding: 8px 12px;
            border: 1px solid #b0c7e7;
            border-radius: 30px;
        }
        .date-picker-popup button {
            background: #1f3f64;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 30px;
            cursor: pointer;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 30px;
            font-size: 0.6rem;
            font-weight: 500;
        }
        .status-not-started { background: #edf2f9; color: #4a6382; }
        .status-in-progress { background: #fff3d8; color: #b85e00; }
        .status-completed { background: #dff0e4; color: #1e6f3f; }
        .status-on-hold { background: #fee9e7; color: #b3382c; }
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 2000;
            font-size: 0.8rem;
            animation: slideIn 0.3s ease;
        }
        .message.success { background: #dff0e4; color: #1e6f3f; }
        .message.error { background: #fee9e7; color: #b3382c; }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .loading { text-align: center; padding: 50px; color: #666; }
    </style>
</head>
<body>
<div class="gantt-full">
    <!-- Professional header with clean typography -->
    <div class="top-space">
        <div class="project-headline">
            <h2>
                <span style="font-weight: 300;">üìä</span> Gantt ¬∑ <span id="projectNameDisplay">UNZA</span>
                <span id="projectCodeDisplay" class="project-badge">we3e3</span>
            </h2>
            <div class="filter-toggle">
                <input type="checkbox" id="hideColumnsCheckbox"> 
                <label for="hideColumnsCheckbox">Hide extra columns</label>
            </div>
        </div>
        <div class="header-controls">
            <div class="nav-buttons">
                <a href="#" class="nav-btn" onclick="goToProjects()">‚Üê Projects</a>
            </div>
            <button class="toggle-form-btn" id="toggleFormBtn">Ôºã New task</button>
        </div>
    </div>

    <!-- Add Task Form -->
    <div class="form-popup" id="addForm">
        <div class="form-field">
            <label>Task name</label>
            <input type="text" id="taskName" placeholder="e.g. Foundation Work">
        </div>
        <div class="form-field">
            <label>Budget ($)</label>
            <input type="number" id="budgetAmount" value="5000">
        </div>
        <div class="form-field">
            <label>Parent task</label>
            <select id="parentTaskSelect"><option value="">‚Äî Main ‚Äî</option></select>
        </div>
        <div class="form-field">
            <label>Predecessor</label>
            <select id="predSelect"><option value="">‚Äî None ‚Äî</option></select>
        </div>
        <div class="form-field">
            <button id="submitTaskBtn">Add Task</button>
        </div>
    </div>

    <!-- Gantt area with sticky headers -->
    <div class="gantt-scroll" id="ganttScroll">
        <table class="gantt-table" id="ganttTable">
            <thead>
                <tr>
                    <th class="task-col task-col-header">Task (right‚Äëclick)</th>
                    <th class="date-col date-col-header">Start</th>
                    <th class="date-col">End</th>
                    <th class="pred-col">Pred</th>
                    <th class="budget-col">Budget</th>
                    <th class="status-col">Status</th>
                    <th style="min-width:420px;">Daily timeline (Feb 17 ‚Äì Jun 30, no Sundays)</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="7" class="loading">Loading tasks...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Bottom progress -->
    <div class="bottom-space">
        <div class="completion-label">Overall Progress</div>
        <div class="completion-bar-container"><div class="completion-bar-fill" id="completionBarFill"></div></div>
        <div class="completion-label" id="completionPercent">0%</div>
    </div>
</div>

<!-- Context menus -->
<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" id="menuStart">üìÖ Set Start Date</div>
    <div class="context-menu-item" id="menuEnd">üìÖ Set End Date</div>
    <div class="context-menu-item" id="menuHold">‚è∏Ô∏è Toggle Hold</div>
    <div class="context-menu-item" id="menuComplete">‚úÖ Mark Completed</div>
    <div class="context-menu-item" id="menuInProgress">üîÑ Mark In Progress</div>
</div>
<div class="date-picker-popup" id="datePickerPopup">
    <input type="date" id="datePickerInput" value="2026-03-01">
    <button id="datePickerSave">Save Date</button>
</div>

<script>
    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
        authDomain: "project-task-588c4.firebaseapp.com",
        projectId: "project-task-588c4",
        storageBucket: "project-task-588c4.firebasestorage.app",
        messagingSenderId: "411882772509",
        appId: "1:411882772509:web:08d613186c101a99f38ef4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('project');
    if (!projectId) window.location.href = 'projects.html';

    // DOM
    const tbody = document.getElementById('tableBody');
    const toggleBtn = document.getElementById('toggleFormBtn');
    const form = document.getElementById('addForm');
    const parentSelect = document.getElementById('parentTaskSelect');
    const predSelect = document.getElementById('predSelect');
    const submitBtn = document.getElementById('submitTaskBtn');
    const completionBar = document.getElementById('completionBarFill');
    const completionPercentEl = document.getElementById('completionPercent');
    const contextMenu = document.getElementById('contextMenu');
    const datePickerPopup = document.getElementById('datePickerPopup');
    const datePickerInput = document.getElementById('datePickerInput');
    const datePickerSave = document.getElementById('datePickerSave');
    const projectNameDisplay = document.getElementById('projectNameDisplay');
    const projectCodeDisplay = document.getElementById('projectCodeDisplay');
    const hideCheckbox = document.getElementById('hideColumnsCheckbox');
    const ganttTable = document.getElementById('ganttTable');

    // state
    let tasks = [];
    let selectedTaskId = null;
    let currentAction = null;
    let currentProject = null;

    // Helper: show message
    function showMessage(text, type = 'success') {
        const msg = document.createElement('div');
        msg.className = `message ${type}`;
        msg.textContent = text;
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
    }

    function formatDate(dateStr) {
        if (!dateStr) return '‚Äî';
        try {
            const d = new Date(dateStr + 'T12:00:00');
            return d.toLocaleDateString('en-US', { month:'short', day:'numeric' });
        } catch { return dateStr; }
    }

    function getStatusClass(status) {
        switch(status) {
            case 'completed': return 'status-completed';
            case 'in-progress': return 'status-in-progress';
            case 'on-hold': return 'status-on-hold';
            default: return 'status-not-started';
        }
    }
    function getStatusText(status) {
        switch(status) {
            case 'completed': return 'Completed';
            case 'in-progress': return 'In Progress';
            case 'on-hold': return 'On Hold';
            default: return 'Not Started';
        }
    }
    function getCompletionFromStatus(status) {
        switch(status) {
            case 'completed': return 100;
            case 'in-progress': return 50;
            case 'on-hold': return 25;
            default: return 0;
        }
    }

    // timeline range: Feb 17 2026 ‚Üí Jun 30 2026 (excluding Sundays)
    function generateDailyTicks() {
        const start = new Date('2026-02-17T12:00:00');
        const end = new Date('2026-06-30T12:00:00');
        let days = [];
        let current = new Date(start);
        while (current <= end) {
            if (current.getDay() !== 0) { // skip Sunday (0)
                const day = current.getDate();
                const month = current.toLocaleString('en-us', { month:'short' });
                days.push({ date: new Date(current), label: `${month} ${day}` });
            }
            current.setDate(current.getDate() + 1);
        }
        return days;
    }

    function calculateBarPositionWithDailyTicks(task, dailyTicks) {
        if (!task.start || !task.end || dailyTicks.length === 0) return { left: 2, width: 10 };
        try {
            const taskStart = new Date(task.start + 'T12:00:00');
            const taskEnd = new Date(task.end + 'T12:00:00');
            const firstTick = dailyTicks[0].date;
            const lastTick = dailyTicks[dailyTicks.length-1].date;
            if (taskEnd < firstTick || taskStart > lastTick) return { left: 0, width: 0 };

            let startIdx = dailyTicks.findIndex(t => t.date >= taskStart);
            if (startIdx === -1) startIdx = 0;
            let endIdx = dailyTicks.findIndex(t => t.date > taskEnd);
            if (endIdx === -1) endIdx = dailyTicks.length - 1;
            else endIdx = endIdx - 1;
            if (endIdx < startIdx) endIdx = startIdx;

            const totalTicks = dailyTicks.length;
            const left = (startIdx / totalTicks) * 100;
            const width = ((endIdx - startIdx + 1) / totalTicks) * 100;
            return { left: Math.max(0, Math.min(95, left)), width: Math.max(2, width) };
        } catch (e) {
            return { left: 5, width: 10 };
        }
    }

    function updateCompletion() {
        const totalBudget = tasks.reduce((sum, t) => sum + (t.budget || 0), 0);
        const completedBudget = tasks.reduce((sum, t) => {
            const completion = getCompletionFromStatus(t.status);
            return sum + ((t.budget || 0) * completion / 100);
        }, 0);
        const percent = totalBudget > 0 ? Math.round((completedBudget / totalBudget) * 100) : 0;
        completionBar.style.width = percent + '%';
        completionPercentEl.innerText = percent + '%';
    }

    function updateDropdowns() {
        parentSelect.innerHTML = '<option value="">‚Äî Main Task ‚Äî</option>';
        predSelect.innerHTML = '<option value="">‚Äî None ‚Äî</option>';
        tasks.filter(t => t.isMain).forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.firebaseId;
            opt.textContent = `${t.displayId} - ${t.name}`;
            parentSelect.appendChild(opt);
        });
        tasks.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.firebaseId;
            opt.textContent = `${t.displayId} - ${t.name}`;
            predSelect.appendChild(opt);
        });
    }

    function generateTaskId(isMain, parentId = null) {
        if (isMain) {
            const mainTasks = tasks.filter(t => t.isMain);
            const maxNum = mainTasks.length > 0 ? Math.max(...mainTasks.map(t => {
                const num = parseInt(t.displayId);
                return isNaN(num) ? 0 : num;
            })) : 0;
            return (maxNum + 1).toString();
        } else {
            if (!parentId) return null;
            const parentTask = tasks.find(t => t.firebaseId === parentId);
            if (!parentTask) return null;
            const parentDisplayId = parentTask.displayId;
            const subtasks = tasks.filter(t => t.parentFirebaseId === parentId);
            const maxNum = subtasks.length > 0 ? Math.max(...subtasks.map(t => {
                const parts = t.displayId.split('.');
                const num = parseInt(parts[parts.length-1]);
                return isNaN(num) ? 0 : num;
            })) : 0;
            return `${parentDisplayId}.${maxNum + 1}`;
        }
    }

    function applyColumnVisibility() {
        const hide = hideCheckbox.checked;
        if (hide) ganttTable.classList.add('hide-col');
        else ganttTable.classList.remove('hide-col');
        localStorage.setItem('ganttHideColumns', hide ? 'true' : 'false');
    }

    function loadFilterSetting() {
        const saved = localStorage.getItem('ganttHideColumns');
        hideCheckbox.checked = saved === 'true';
        applyColumnVisibility();
    }

    // Generate calendar header rows
    function generateCalendarHeaders(dailyTicks) {
        const headerHTML = [];

        // Month header row
        let currentMonth = null;
        let monthStart = 0;
        for (let i = 0; i < dailyTicks.length; i++) {
            const month = dailyTicks[i].date.toLocaleString('en-us', { month:'short' });
            if (month !== currentMonth) {
                if (currentMonth !== null) {
                    const span = i - monthStart;
                    const width = (span / dailyTicks.length) * 100;
                    headerHTML.push({ type: 'month', month: currentMonth, width });
                }
                currentMonth = month;
                monthStart = i;
            }
        }
        if (currentMonth !== null) {
            const span = dailyTicks.length - monthStart;
            const width = (span / dailyTicks.length) * 100;
            headerHTML.push({ type: 'month', month: currentMonth, width });
        }

        // Day header (MON, TUE, WED, etc.)
        const dayNames = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        const dayHeaders = dailyTicks.map(tick => {
            const dayName = dayNames[tick.date.getDay()];
            return dayName;
        });

        return { headerHTML, dayHeaders };
    }

    // render with daily ticks
    function renderTable() {
        if (!tasks) return;
        const dailyTicks = generateDailyTicks();

        if (tasks.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;">No tasks. Click "New task" to add.</td></tr>`;
            updateCompletion();
            return;
        }
        tbody.innerHTML = '';

        const { headerHTML, dayHeaders } = generateCalendarHeaders(dailyTicks);

        // Month header row
        const monthRow = document.createElement('tr');
        monthRow.className = 'calendar-header-row';
        monthRow.innerHTML = `<td class="calendar-month-cell">${headerHTML[0]?.month || 'FEB'}</td>`;
        for (const header of headerHTML) {
            const colCount = Math.ceil((header.width / 100) * dailyTicks.length);
            const cellHTML = `<td colspan="${colCount}" style="text-align:center; font-weight:700; color:#1d344c; padding:8px; background:#e8f0fb;">${header.month}</td>`;
            if (monthRow.cells.length > 1) {
                monthRow.innerHTML += cellHTML;
            }
        }
        tbody.appendChild(monthRow);

        // Day header row (MON, TUE, WED, etc.)
        const dayRow = document.createElement('tr');
        dayRow.className = 'day-header-row';
        dayRow.innerHTML = `<td class="day-header-task-col"></td>`;
        dayHeaders.forEach(day => {
            dayRow.innerHTML += `<td class="day-header-cell">${day}</td>`;
        });
        tbody.appendChild(dayRow);

        // Date number row
        const dateRow = document.createElement('tr');
        dateRow.className = 'date-number-row';
        dateRow.innerHTML = `<td class="date-number-task-col"></td>`;
        dailyTicks.forEach(tick => {
            const dateNum = tick.date.getDate();
            dateRow.innerHTML += `<td class="date-number-cell">${dateNum}</td>`;
        });
        tbody.appendChild(dateRow);

        // Task rows
        const sortedTasks = [...tasks].sort((a,b) => (a.displayId||'').localeCompare(b.displayId||'', undefined, {numeric:true}));
        sortedTasks.forEach(task => {
            const pos = calculateBarPositionWithDailyTicks(task, dailyTicks);
            const row = document.createElement('tr');
            const taskDisplay = task.isMain ? 
                `<span class="task-main"><span class="task-number">${task.displayId}</span> ${task.name}</span>` : 
                `<span class="subtask-item"><span class="task-number">${task.displayId}</span> ${task.name}</span>`;
            const barClass = task.isMain ? 'task-bar' : 'task-bar subtask-bar';
            const statusClass = getStatusClass(task.status);
            const statusText = getStatusText(task.status);
            const completionPercent = getCompletionFromStatus(task.status);
            const completionWidth = (completionPercent / 100) * pos.width;

            let predDisplay = '‚Äî';
            if (task.pred) {
                const predTask = tasks.find(t => t.firebaseId === task.pred);
                predDisplay = predTask ? predTask.displayId : '‚Äî';
            }

            row.innerHTML = `
                <td class="task-col" data-task-id="${task.firebaseId}">${taskDisplay}</td>
                <td class="date-col">${formatDate(task.start)}</td>
                <td class="date-col">${formatDate(task.end)}</td>
                <td class="pred-col">${predDisplay}</td>
                <td class="budget-col">$${task.budget || 0}</td>
                <td class="status-col"><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td class="gantt-col">
                    <div class="timeline-box">
                        <div class="${barClass}" style="left:${pos.left}%; width:${pos.width}%;" data-task-id="${task.firebaseId}"></div>
                        <div class="completion-overlay ${!task.isMain ? 'subtask-bar' : ''}" style="left:${pos.left}%; width:${completionWidth}%;"></div>
                        ${task.onHold ? `<div class="hold-marker" style="left:${pos.left + pos.width/2}%;"></div>` : ''}
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });

        // milestone row (light)
        const mileRow = document.createElement('tr');
        mileRow.style.background = '#eaf1fb';
        const mileDots = dailyTicks.filter((_,idx) => idx % Math.floor(dailyTicks.length/4) === 0).map(t => {
            const leftPos = (dailyTicks.indexOf(t) / dailyTicks.length)*100;
            return `<div class="milestone-dot" style="left:${leftPos}%;" title="‚ö°"></div>`;
        }).join('');
        mileRow.innerHTML = `
            <td class="task-col">üéØ Milestones</td>
            <td class="date-col">‚Äî</td><td class="date-col">‚Äî</td><td class="pred-col">‚Äî</td>
            <td class="budget-col">‚Äî</td><td class="status-col">‚Äî</td>
            <td class="gantt-col"><div class="timeline-box" style="background:transparent;">${mileDots}</div></td>
        `;
        tbody.appendChild(mileRow);

        // event listeners
        document.querySelectorAll('.task-col[data-task-id]').forEach(cell => {
            cell.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                selectedTaskId = cell.dataset.taskId;
                contextMenu.style.display = 'flex';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
            });
        });
        document.querySelectorAll('.task-bar').forEach(bar => {
            bar.addEventListener('click', async (e) => {
                e.stopPropagation();
                const taskId = bar.dataset.taskId;
                const task = tasks.find(t => t.firebaseId === taskId);
                if (!task) return;
                let newStatus;
                if (task.status === 'not-started') newStatus = 'in-progress';
                else if (task.status === 'in-progress') newStatus = 'completed';
                else if (task.status === 'completed') newStatus = 'not-started';
                else if (task.status === 'on-hold') newStatus = 'in-progress';
                else newStatus = 'in-progress';
                await updateTask(task.firebaseId, { status: newStatus });
            });
        });

        updateDropdowns();
        updateCompletion();
        applyColumnVisibility();
    }

    // Firestore loaders
    async function loadProjectInfo() {
        try {
            const doc = await db.collection('projects').doc(projectId).get();
            if (doc.exists) {
                currentProject = { id: doc.id, ...doc.data() };
                projectNameDisplay.textContent = currentProject.name || 'UNZA';
                projectCodeDisplay.textContent = currentProject.code || 'we3e3';
            }
        } catch (error) { console.error(error); }
    }

    function loadTasks() {
        db.collection('gantt_tasks').where('projectId', '==', projectId).get()
        .then(snapshot => {
            tasks = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                tasks.push({
                    firebaseId: doc.id,
                    parentFirebaseId: data.parentId || null,
                    displayId: data.displayId || data.id || doc.id,
                    name: data.name || 'Unnamed',
                    start: data.start || null,
                    end: data.end || null,
                    pred: data.pred || '',
                    budget: data.budget || 0,
                    isMain: data.isMain || false,
                    status: data.status || 'not-started',
                    onHold: data.onHold || false,
                    parentId: data.parentId || null
                });
            });
            renderTable();
            setupRealtimeListener();
        }).catch(error => {
            tbody.innerHTML = `<tr><td colspan="7" style="color:red;">Error loading</td></tr>`;
        });
    }

    function setupRealtimeListener() {
        db.collection('gantt_tasks').where('projectId', '==', projectId).onSnapshot(snapshot => {
            tasks = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                tasks.push({
                    firebaseId: doc.id,
                    parentFirebaseId: data.parentId || null,
                    displayId: data.displayId || data.id || doc.id,
                    name: data.name || 'Unnamed',
                    start: data.start || null,
                    end: data.end || null,
                    pred: data.pred || '',
                    budget: data.budget || 0,
                    isMain: data.isMain || false,
                    status: data.status || 'not-started',
                    onHold: data.onHold || false,
                    parentId: data.parentId || null
                });
            });
            renderTable();
        }, error => console.log('listener error'));
    }

    async function updateTask(taskId, updates) {
        try {
            await db.collection('gantt_tasks').doc(taskId).update({
                ...updates,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showMessage('Updated');
        } catch (error) {
            showMessage('Error updating', 'error');
        }
    }

    async function addTask(taskData) {
        try {
            await db.collection('gantt_tasks').add({
                ...taskData,
                projectId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showMessage('Task added');
            return true;
        } catch (error) {
            showMessage('Error: ' + error.message, 'error');
            return false;
        }
    }

    window.goToProjects = () => window.location.href = 'projects.html';

    // Event listeners
    toggleBtn.addEventListener('click', () => {
        form.classList.toggle('visible');
        toggleBtn.textContent = form.classList.contains('visible') ? '‚àí Hide form' : 'Ôºã New task';
    });

    submitBtn.addEventListener('click', async () => {
        const name = document.getElementById('taskName').value.trim();
        const budget = parseFloat(document.getElementById('budgetAmount').value) || 0;
        const parentId = document.getElementById('parentTaskSelect').value;
        const predId = document.getElementById('predSelect').value;
        if (!name) return showMessage('Enter name', 'error');
        submitBtn.disabled = true;
        const isMain = !parentId;
        const displayId = generateTaskId(isMain, parentId);
        if (!displayId) { showMessage('ID error','error'); submitBtn.disabled=false; return; }
        const success = await addTask({ displayId, id: displayId, name, budget, isMain, status:'not-started', onHold:false, parentId:parentId||null, pred:predId||'' });
        if (success) {
            document.getElementById('taskName').value = '';
            document.getElementById('budgetAmount').value = '5000';
            document.getElementById('parentTaskSelect').value = '';
            document.getElementById('predSelect').value = '';
            form.classList.remove('visible');
            toggleBtn.textContent = 'Ôºã New task';
        }
        submitBtn.disabled = false;
    });

    // context menu listeners
    document.getElementById('menuStart').addEventListener('click', ()=>{
        if(!selectedTaskId) return; currentAction='start';
        datePickerPopup.style.display='flex'; datePickerPopup.style.left = contextMenu.style.left; datePickerPopup.style.top = contextMenu.style.top; contextMenu.style.display='none';
    });
    document.getElementById('menuEnd').addEventListener('click', ()=>{
        if(!selectedTaskId) return; currentAction='end';
        datePickerPopup.style.display='flex'; datePickerPopup.style.left = contextMenu.style.left; datePickerPopup.style.top = contextMenu.style.top; contextMenu.style.display='none';
    });
    document.getElementById('menuHold').addEventListener('click', async ()=>{
        if(selectedTaskId) { const task = tasks.find(t=>t.firebaseId===selectedTaskId);
            if(task) { const newOnHold = !task.onHold; await updateTask(selectedTaskId, { onHold: newOnHold, status: newOnHold ? 'on-hold' : 'not-started' }); }
            contextMenu.style.display='none'; }
    });
    document.getElementById('menuComplete').addEventListener('click', async ()=>{
        if(selectedTaskId) { await updateTask(selectedTaskId, {status:'completed'}); contextMenu.style.display='none'; }
    });
    document.getElementById('menuInProgress').addEventListener('click', async ()=>{
        if(selectedTaskId) { await updateTask(selectedTaskId, {status:'in-progress'}); contextMenu.style.display='none'; }
    });

    datePickerSave.addEventListener('click', async ()=>{
        if(selectedTaskId && currentAction) {
            const date = datePickerInput.value;
            if(date) {
                const updates = {};
                updates[currentAction === 'start' ? 'start' : 'end'] = date;
                await updateTask(selectedTaskId, updates);
            }
            datePickerPopup.style.display='none';
            selectedTaskId=null; currentAction=null;
        }
    });

    document.addEventListener('click', (e)=>{
        if (!contextMenu.contains(e.target) && !datePickerPopup.contains(e.target)) {
            contextMenu.style.display='none'; datePickerPopup.style.display='none';
        }
    });

    hideCheckbox.addEventListener('change', applyColumnVisibility);

    async function init() {
        loadFilterSetting();
        await loadProjectInfo();
        loadTasks();
    }
    init();
</script>
</body>
</html>
