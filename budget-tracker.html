<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt ¬∑ months & days on separate rows ¬∑ continuous</title>
    
    <!-- Firebase v8 (compat) ‚Äî unchanged -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        html, body {
            height: 100%;
            background: #1e3146;
            overflow: hidden;
        }
        .gantt-full {
            height: 100vh;
            width: 100vw;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .top-space {
            padding: 0.6rem 1.5rem;
            background: white;
            border-bottom: 1px solid #c2d2e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .top-space h2 {
            font-weight: 400;
            color: #1a3455;
            font-size: 0.95rem;
        }
        .project-info {
            font-size: 0.75rem;
            color: #2c4d78;
            background: #e8f0fe;
            padding: 0.2rem 1rem;
            border-radius: 30px;
        }
        .toggle-form-btn {
            background: #ffffff;
            border: 1px solid #dfdfdf;
            padding: 0.2rem 1rem;
            border-radius: 30px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        .nav-buttons {
            display: flex;
            gap: 8px;
        }
        .nav-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            padding: 0.2rem 1rem;
            border-radius: 30px;
            font-size: 0.7rem;
            cursor: pointer;
            text-decoration: none;
            color: #555;
        }
        .form-popup {
            background: #f5f9ff;
            border-bottom: 2px solid #98b3d9;
            padding: 0.8rem 1.5rem;
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(140px, auto));
            gap: 12px;
            align-items: end;
            flex-shrink: 0;
        }
        .form-popup.visible {
            display: grid;
        }
        .form-field {
            display: flex;
            flex-direction: column;
            gap: 3px;
            font-size: 0.7rem;
            color: #1c3a5c;
        }
        .form-field input, .form-field select {
            padding: 0.3rem 0.8rem;
            border: 1px solid #b0c7e7;
            border-radius: 30px;
            font-size: 0.7rem;
            background: white;
        }
        .form-field button {
            background: #1f3f64;
            color: white;
            border: none;
            padding: 0.3rem 1.2rem;
            border-radius: 30px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-top: 12px;
        }
        .gantt-scroll {
            flex: 1;
            overflow: auto;
            position: relative;
            background: white;
        }
        .gantt-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 750px;
            table-layout: fixed;
            font-size: 0.7rem;
        }
        .gantt-table th {
            background: #1e2b3a;
            color: #ffffff;
            font-weight: 500;
            padding: 0.6rem 0.2rem;
            border-right: 1px solid #3a4a5a;
            border-bottom: 2px solid #4a5a6a;
            position: sticky;
            top: 0;
            z-index: 20;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .gantt-table td {
            padding: 0.4rem 0.2rem;
            border-bottom: 1px solid #e0e5ec;
            border-right: 1px solid #e0e5ec;
            vertical-align: middle;
        }
        .task-col {
            width: 260px;
            background: white;
            position: sticky;
            left: 0;
            z-index: 15;
            cursor: context-menu;
            font-weight: 400;
        }
        .task-main {
            font-weight: 600;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            background: #2e7d32;
            padding: 4px 10px;
            border-radius: 4px;
            margin: -2px;
        }
        .subtask-item {
            padding-left: 32px;
            font-size: 0.75rem;
            color: #2f4b70;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .date-col { width: 58px; text-align: center; font-family: monospace; }
        .pred-col { width: 50px; text-align: center; }
        .budget-col { width: 65px; text-align: right; padding-right: 8px; }
        .status-col { width: 70px; text-align: center; }
        .gantt-col { padding: 0.2rem 0.3rem !important; }
        .timeline-box {
            position: relative;
            width: 100%;
            height: 30px;
            background: #f0f5fd;
            border-radius: 3px;
        }
        .task-bar {
            position: absolute;
            height: 18px;
            top: 6px;
            border-radius: 3px;
            border: 1px solid #122b44;
            min-width: 6px;
            cursor: pointer;
        }
        /* base bar colors */
        .task-bar.status-not-started { background: #5f7d9c; }
        .task-bar.status-in-progress { background: #f9a95d; }
        .task-bar.status-completed { background: #2e7d5e; }
        .task-bar.status-on-hold { background: #d97777; }
        .subtask-bar {
            height: 14px;
            top: 8px;
            border: 1px solid #2c3e4e;
        }
        .completion-overlay {
            position: absolute;
            height: 18px;
            top: 6px;
            background: #1e4a3a;
            border-radius: 3px 0 0 3px;
            opacity: 0.2;
            pointer-events: none;
            z-index: 5;
        }
        .subtask-bar + .completion-overlay {
            height: 14px;
            top: 8px;
        }
        .bottom-space {
            padding: 0.4rem 1.5rem 0.5rem;
            background: white;
            border-top: 1px solid #c2d2e8;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .completion-bar-container {
            flex: 1;
            height: 12px;
            background: #e2e9f3;
            border-radius: 30px;
            overflow: hidden;
            border: 1px solid #a5bbda;
        }
        .completion-bar-fill {
            height: 100%;
            background: #2e7d5e;
            width: 0%;
            transition: width 0.2s;
        }
        .completion-label {
            font-size: 0.7rem;
            color: #1d3a5c;
            min-width: 90px;
            font-weight: 500;
        }
        /* NEW: two‚Äërow calendar header */
        .calendar-header-wrapper {
            width: 100%;
            background: #eef4fc;
            border-bottom: 2px solid #9fb7d3;
            border-top: 1px solid #c0d2e8;
            margin: 0;
        }
        .month-row {
            display: flex;
            width: 100%;
            background: #dae6f5;
            font-weight: 600;
            font-size: 0.7rem;
            color: #113355;
            border-bottom: 1px solid #aac0dd;
        }
        .day-row {
            display: flex;
            width: 100%;
            background: #f7faff;
            font-size: 0.6rem;
            color: #1d4063;
        }
        .month-cell {
            flex: 1 1 0px;
            padding: 5px 0 3px 8px;
            border-right: 1px solid #bfd2ea;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .day-cell {
            flex: 1 0 auto;
            text-align: center;
            padding: 3px 0 2px 0;
            border-right: 1px dotted #b3c7e0;
            font-weight: 500;
        }
        .day-cell:last-child {
            border-right: none;
        }
        .context-menu, .date-picker-popup {
            position: absolute;
            background: white;
            border: 1px solid #a0b9d9;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
            padding: 4px 0;
        }
        .context-menu-item {
            padding: 6px 16px;
            font-size: 0.75rem;
            cursor: pointer;
            color: #1a3455;
        }
        .context-menu-item:hover {
            background: #e2ecfc;
        }
        .date-picker-popup {
            padding: 12px;
            gap: 8px;
        }
        .date-picker-popup input {
            padding: 6px;
            border: 1px solid #b0c7e7;
            border-radius: 30px;
        }
        .date-picker-popup button {
            background: #1f3f64;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 30px;
            cursor: pointer;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 30px;
            font-size: 0.6rem;
            font-weight: 500;
        }
        .status-not-started { background: #edf2f9; color: #4a6382; }
        .status-in-progress { background: #fff3d8; color: #b85e00; }
        .status-completed { background: #dff0e4; color: #1e6f3f; }
        .status-on-hold { background: #fee9e7; color: #b3382c; }

        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 12px;
            font-size: 0.7rem;
            background: #eef3fc;
            padding: 0.2rem 0.8rem;
            border-radius: 30px;
            color: #1a3b5e;
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 18px;
            border-radius: 8px;
            z-index: 2000;
            font-size: 0.8rem;
            animation: slideIn 0.3s ease;
        }
        .message.success { background: #dff0e4; color: #1e6f3f; }
        .message.error { background: #fee9e7; color: #b3382c; }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .loading { text-align: center; padding: 40px; color: #666; }
        .blank-row td {
            background: white;
            color: transparent;
            border-bottom: 1px solid #e0e5ec;
            height: 32px;
        }
        .hide-col .date-col,
        .hide-col .pred-col,
        .hide-col .budget-col,
        .hide-col .status-col {
            display: none;
        }
        /* make timeline cell align with header */
        .timeline-cell {
            padding: 0 !important;
            vertical-align: top;
        }
        .timeline-outer {
            width: 100%;
            position: relative;
        }
    </style>
</head>
<body>
<div class="gantt-full">
    <div class="top-space">
        <div style="display: flex; align-items: center; gap: 12px;">
            <h2>üìã Gantt ¬∑ <span id="projectNameDisplay">Loading...</span></h2>
            <span class="project-info" id="projectInfo">Project ID: ‚Äî</span>
            <label class="filter-toggle">
                <input type="checkbox" id="hideColumnsCheckbox"> Hide extra columns
            </label>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <div class="nav-buttons">
                <a href="#" class="nav-btn" onclick="goToProjects()">‚Üê Projects</a>
            </div>
            <button class="toggle-form-btn" id="toggleFormBtn">Ôºã Show form</button>
        </div>
    </div>

    <div class="form-popup" id="addForm">
        <div class="form-field">
            <label>Task name</label>
            <input type="text" id="taskName" placeholder="e.g. Foundation Work">
        </div>
        <div class="form-field">
            <label>Budget ($)</label>
            <input type="number" id="budgetAmount" value="5000">
        </div>
        <div class="form-field">
            <label>Parent task</label>
            <select id="parentTaskSelect"><option value="">‚Äî Main ‚Äî</option></select>
        </div>
        <div class="form-field">
            <label>Predecessor</label>
            <select id="predSelect"><option value="">‚Äî None ‚Äî</option></select>
        </div>
        <div class="form-field">
            <button id="submitTaskBtn">Add Task</button>
        </div>
    </div>

    <div class="gantt-scroll" id="ganttScroll">
        <table class="gantt-table" id="ganttTable">
            <thead>
                <tr>
                    <th class="task-col">Task (right‚Äëclick)</th>
                    <th class="date-col">Start</th>
                    <th class="date-col">End</th>
                    <th class="pred-col">Pred</th>
                    <th class="budget-col">Budget</th>
                    <th class="status-col">Status</th>
                    <th style="min-width:420px;">Timeline</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="7" class="loading">Loading tasks...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="bottom-space">
        <div class="completion-label">Overall Progress</div>
        <div class="completion-bar-container"><div class="completion-bar-fill" id="completionBarFill"></div></div>
        <div class="completion-label" id="completionPercent">0%</div>
    </div>
</div>

<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" id="menuStart">üìÖ Set Start Date</div>
    <div class="context-menu-item" id="menuEnd">üìÖ Set End Date</div>
    <div class="context-menu-item" id="menuHold">‚è∏Ô∏è Toggle Hold</div>
    <div class="context-menu-item" id="menuComplete">‚úÖ Mark Completed</div>
    <div class="context-menu-item" id="menuInProgress">üîÑ Mark In Progress</div>
</div>
<div class="date-picker-popup" id="datePickerPopup">
    <input type="date" id="datePickerInput" value="2026-03-01">
    <button id="datePickerSave">Save Date</button>
</div>

<script>
    (function() {
    // Firebase Config ‚Äî exactly as provided
    const firebaseConfig = {
        apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
        authDomain: "project-task-588c4.firebaseapp.com",
        projectId: "project-task-588c4",
        storageBucket: "project-task-588c4.firebasestorage.app",
        messagingSenderId: "411882772509",
        appId: "1:411882772509:web:08d613186c101a99f38ef4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('project');
    if (!projectId) window.location.href = 'projects.html';

    const tbody = document.getElementById('tableBody');
    const toggleBtn = document.getElementById('toggleFormBtn');
    const form = document.getElementById('addForm');
    const parentSelect = document.getElementById('parentTaskSelect');
    const predSelect = document.getElementById('predSelect');
    const submitBtn = document.getElementById('submitTaskBtn');
    const completionBar = document.getElementById('completionBarFill');
    const completionPercentEl = document.getElementById('completionPercent');
    const contextMenu = document.getElementById('contextMenu');
    const datePickerPopup = document.getElementById('datePickerPopup');
    const datePickerInput = document.getElementById('datePickerInput');
    const datePickerSave = document.getElementById('datePickerSave');
    const projectNameDisplay = document.getElementById('projectNameDisplay');
    const projectInfo = document.getElementById('projectInfo');
    const hideCheckbox = document.getElementById('hideColumnsCheckbox');
    const ganttTable = document.getElementById('ganttTable');
    const ganttScroll = document.getElementById('ganttScroll');

    let tasks = [];
    let selectedTaskId = null;
    let currentAction = null;
    let currentProject = null;

    // ---------- global range (continuous calendar) ----------
    // We'll use project start/end from Firestore or fallback
    let globalRangeStart = new Date('2026-02-17T12:00:00');
    let globalRangeEnd = new Date('2026-06-30T12:00:00');

    function showMessage(text, type = 'success') {
        const msg = document.createElement('div');
        msg.className = `message ${type}`;
        msg.textContent = text;
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
    }

    function formatDate(dateStr) {
        if (!dateStr) return '‚Äî';
        try {
            const d = new Date(dateStr + 'T12:00:00');
            return d.toLocaleDateString('en-US', { month:'short', day:'numeric' });
        } catch { return dateStr; }
    }

    function getStatusClass(status) {
        switch(status) {
            case 'completed': return 'status-completed';
            case 'in-progress': return 'status-in-progress';
            case 'on-hold': return 'status-on-hold';
            default: return 'status-not-started';
        }
    }
    function getStatusText(status) {
        switch(status) {
            case 'completed': return 'Completed';
            case 'in-progress': return 'In Progress';
            case 'on-hold': return 'On Hold';
            default: return 'Not Started';
        }
    }
    function getCompletionFromStatus(status) {
        switch(status) {
            case 'completed': return 100;
            case 'in-progress': return 50;
            case 'on-hold': return 25;
            default: return 0;
        }
    }

    // ----- build two‚Äërow calendar header (months row, days row) -----
    function renderCalendarHeader(start, end) {
        if (start > end) return '<tr><td colspan="7">Invalid date range</td></tr>';
        const startDate = new Date(start);
        const endDate = new Date(end);
        startDate.setHours(12,0,0,0);
        endDate.setHours(12,0,0,0);

        let current = new Date(startDate);
        let monthMap = new Map(); // key: year-month, value: { year, month, days: [] }

        while (current <= endDate) {
            const year = current.getFullYear();
            const month = current.getMonth();
            const key = `${year}-${month}`;
            if (!monthMap.has(key)) {
                monthMap.set(key, { year, month, days: [], monthName: current.toLocaleString('default', { month:'long' }) + ' ' + year });
            }
            monthMap.get(key).days.push(new Date(current));
            current.setDate(current.getDate() + 1);
        }

        // Build month row and day row HTML
        let monthRowHtml = '<div class="month-row">';
        let dayRowHtml = '<div class="day-row">';

        for (let [key, monthData] of monthMap.entries()) {
            const dayCount = monthData.days.length;
            monthRowHtml += `<div class="month-cell" style="flex:${dayCount} 1 0px;" title="${monthData.monthName}">${monthData.monthName}</div>`;

            monthData.days.forEach(dayDate => {
                const dayNum = dayDate.getDate();
                const weekday = dayDate.toLocaleString('default', { weekday:'short' }).substring(0,2);
                dayRowHtml += `<div class="day-cell" title="${dayDate.toDateString()}">${dayNum} ${weekday}</div>`;
            });
        }
        monthRowHtml += '</div>';
        dayRowHtml += '</div>';

        return { monthRow: monthRowHtml, dayRow: dayRowHtml };
    }

    // ----- calculate bar position based on globalRangeStart/End -----
    function calculateBarPosition(task) {
        if (task.start && task.end) {
            try {
                const startDate = new Date(task.start + 'T12:00:00');
                const endDate = new Date(task.end + 'T12:00:00');
                if (isNaN(startDate)||isNaN(endDate)) return { left:8, width:15 };
                const totalMs = globalRangeEnd - globalRangeStart;
                if (totalMs <= 0) return { left:8, width:15 };
                let leftMs = Math.max(0, startDate - globalRangeStart);
                let rightMs = Math.min(totalMs, endDate - globalRangeStart);
                if (rightMs < leftMs) rightMs = leftMs + 86400000; // min 1 day
                const left = (leftMs / totalMs) * 100;
                const width = ((rightMs - leftMs) / totalMs) * 100;
                return { left: Math.max(0, Math.min(95, left)), width: Math.max(2, Math.min(95-left, width)) };
            } catch (error) {
                console.error(error);
            }
        }
        return { left: 8, width: 15 };
    }

    function updateCompletion() {
        const totalBudget = tasks.reduce((sum, t) => sum + (t.budget || 0), 0);
        const completedBudget = tasks.reduce((sum, t) => {
            const completion = getCompletionFromStatus(t.status);
            return sum + ((t.budget || 0) * completion / 100);
        }, 0);
        const percent = totalBudget > 0 ? Math.round((completedBudget / totalBudget) * 100) : 0;
        completionBar.style.width = percent + '%';
        completionPercentEl.innerText = percent + '%';
    }

    function updateDropdowns() {
        parentSelect.innerHTML = '<option value="">‚Äî Main Task ‚Äî</option>';
        predSelect.innerHTML = '<option value="">‚Äî None ‚Äî</option>';
        tasks.filter(t => t.isMain).forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.firebaseId;
            opt.textContent = `${t.displayId} - ${t.name}`;
            parentSelect.appendChild(opt);
        });
        tasks.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.firebaseId;
            opt.textContent = `${t.displayId} - ${t.name}`;
            predSelect.appendChild(opt);
        });
    }

    function generateTaskId(isMain, parentId = null) {
        if (isMain) {
            const mainTasks = tasks.filter(t => t.isMain);
            const maxNum = mainTasks.length > 0 ? Math.max(...mainTasks.map(t => {
                const num = parseInt(t.displayId);
                return isNaN(num) ? 0 : num;
            })) : 0;
            return (maxNum + 1).toString();
        } else {
            if (!parentId) return null;
            const parentTask = tasks.find(t => t.firebaseId === parentId);
            if (!parentTask) return null;
            const parentDisplayId = parentTask.displayId;
            const subtasks = tasks.filter(t => t.parentFirebaseId === parentId);
            const maxNum = subtasks.length > 0 ? Math.max(...subtasks.map(t => {
                const parts = t.displayId.split('.');
                const num = parseInt(parts[parts.length-1]);
                return isNaN(num) ? 0 : num;
            })) : 0;
            return `${parentDisplayId}.${maxNum + 1}`;
        }
    }

    function applyColumnVisibility() {
        const hide = hideCheckbox.checked;
        if (hide) ganttTable.classList.add('hide-col');
        else ganttTable.classList.remove('hide-col');
        localStorage.setItem('ganttHideColumns', hide ? 'true' : 'false');
    }

    function loadFilterSetting() {
        const saved = localStorage.getItem('ganttHideColumns');
        hideCheckbox.checked = saved === 'true';
        applyColumnVisibility();
    }

    // main render: includes two‚Äërow calendar inside the timeline cell of a special row
    function renderTable() {
        tbody.innerHTML = '';

        // ---- insert two‚Äërow calendar as a separate row (occupies full width) ----
        const { monthRow, dayRow } = renderCalendarHeader(globalRangeStart, globalRangeEnd);
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = `
            <td class="task-col" style="background:#eef4fc; font-weight:600; color:#113355;">üìÖ Project calendar</td>
            <td class="date-col" style="background:#eef4fc;"></td>
            <td class="date-col" style="background:#eef4fc;"></td>
            <td class="pred-col" style="background:#eef4fc;"></td>
            <td class="budget-col" style="background:#eef4fc;"></td>
            <td class="status-col" style="background:#eef4fc;"></td>
            <td class="timeline-cell" style="padding:0!important; background:#eef4fc;">
                <div class="calendar-header-wrapper">
                    ${monthRow}
                    ${dayRow}
                </div>
            </td>
        `;
        tbody.appendChild(headerRow);

        // sort tasks
        const sortedTasks = [...tasks].sort((a,b) => (a.displayId||'').localeCompare(b.displayId||'', undefined, {numeric:true}));
        sortedTasks.forEach(task => {
            const pos = calculateBarPosition(task);
            const row = document.createElement('tr');
            const taskDisplay = task.isMain ? 
                `<span class="task-main"><span class="task-number">${task.displayId}</span> ${task.name}</span>` : 
                `<span class="subtask-item"><span class="task-number">${task.displayId}</span> ${task.name}</span>`;
            
            const barBaseClass = 'task-bar';
            const statusSpecific = `status-${task.status || 'not-started'}`;
            const barClass = `${barBaseClass} ${statusSpecific} ${!task.isMain ? 'subtask-bar' : ''}`;
            
            const statusClass = getStatusClass(task.status);
            const statusText = getStatusText(task.status);
            const completionPercent = getCompletionFromStatus(task.status);
            const completionWidth = (completionPercent / 100) * pos.width;

            let predDisplay = '‚Äî';
            if (task.pred) {
                const predTask = tasks.find(t => t.firebaseId === task.pred);
                predDisplay = predTask ? predTask.displayId : '‚Äî';
            }

            row.innerHTML = `
                <td class="task-col" data-task-id="${task.firebaseId}">${taskDisplay}</td>
                <td class="date-col">${formatDate(task.start)}</td>
                <td class="date-col">${formatDate(task.end)}</td>
                <td class="pred-col">${predDisplay}</td>
                <td class="budget-col">$${task.budget || 0}</td>
                <td class="status-col"><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td class="gantt-col" style="padding:0!important;">
                    <div class="timeline-box" style="background:#f5f9ff; height:32px;">
                        <div class="${barClass}" style="left:${pos.left}%; width:${pos.width}%;" data-task-id="${task.firebaseId}"></div>
                        <div class="completion-overlay ${!task.isMain ? 'subtask-bar' : ''}" style="left:${pos.left}%; width:${completionWidth}%;"></div>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });

        // event listeners
        document.querySelectorAll('.task-col[data-task-id]').forEach(cell => {
            cell.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                selectedTaskId = cell.dataset.taskId;
                contextMenu.style.display = 'flex';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
            });
        });
        document.querySelectorAll('.task-bar').forEach(bar => {
            bar.addEventListener('click', async (e) => {
                e.stopPropagation();
                const taskId = bar.dataset.taskId;
                const task = tasks.find(t => t.firebaseId === taskId);
                if (!task) return;
                let newStatus;
                if (task.status === 'not-started') newStatus = 'in-progress';
                else if (task.status === 'in-progress') newStatus = 'completed';
                else if (task.status === 'completed') newStatus = 'not-started';
                else if (task.status === 'on-hold') newStatus = 'in-progress';
                else newStatus = 'in-progress';
                await updateTask(task.firebaseId, { status: newStatus });
            });
        });

        updateDropdowns();
        updateCompletion();
        applyColumnVisibility();

        // blank rows
        setTimeout(() => addBlankRowsToFillPage(), 20);
    }

    function addBlankRowsToFillPage() {
        if (!tbody) return;
        const scrollDiv = ganttScroll;
        const viewportHeight = scrollDiv.clientHeight;
        if (viewportHeight < 50) return;

        const rowHeight = 34;
        const existingRows = tbody.children.length;
        const totalRowsNeeded = Math.ceil(viewportHeight / rowHeight) + 2;
        let blanksToAdd = totalRowsNeeded - existingRows;
        if (blanksToAdd < 0) blanksToAdd = 0;

        for (let i = 0; i < blanksToAdd; i++) {
            const blankRow = document.createElement('tr');
            blankRow.className = 'blank-row';
            blankRow.innerHTML = `
                <td class="task-col"></td>
                <td class="date-col"></td>
                <td class="date-col"></td>
                <td class="pred-col"></td>
                <td class="budget-col"></td>
                <td class="status-col"></td>
                <td class="gantt-col"><div class="timeline-box" style="background:transparent;"></div></td>
            `;
            tbody.appendChild(blankRow);
        }
    }

    const resizeObserver = new ResizeObserver(() => {
        if (tbody) {
            Array.from(tbody.querySelectorAll('.blank-row')).forEach(br => br.remove());
            addBlankRowsToFillPage();
        }
    });
    if (ganttScroll) resizeObserver.observe(ganttScroll);

    async function loadProjectInfo() {
        try {
            const doc = await db.collection('projects').doc(projectId).get();
            if (doc.exists) {
                currentProject = { id: doc.id, ...doc.data() };
                projectNameDisplay.textContent = currentProject.name || 'Unnamed';
                projectInfo.textContent = `Code: ${currentProject.code || '‚Äî'}`;
                // if project has start/end dates, update global range (optional)
                if (currentProject.startDate) globalRangeStart = new Date(currentProject.startDate + 'T12:00:00');
                if (currentProject.endDate) globalRangeEnd = new Date(currentProject.endDate + 'T12:00:00');
            } else {
                projectNameDisplay.textContent = 'Demo Project';
                projectInfo.textContent = 'Code: DEMO';
            }
        } catch (error) { console.error(error); }
    }

    async function seedSampleTasksIfEmpty() {
        try {
            const snapshot = await db.collection('gantt_tasks').where('projectId', '==', projectId).get();
            if (!snapshot.empty) return;
            const batch = db.batch();
            const sampleMain = [
                { name: 'Site preparation', budget: 8000, start: '2026-02-20', end: '2026-03-10', status: 'completed' },
                { name: 'Foundation', budget: 15000, start: '2026-03-05', end: '2026-04-10', status: 'in-progress' },
                { name: 'Framing', budget: 22000, start: '2026-04-01', end: '2026-05-15', status: 'not-started' },
                { name: 'Roofing', budget: 12000, start: '2026-05-10', end: '2026-06-05', status: 'not-started' },
                { name: 'Electrical', budget: 18000, start: '2026-04-20', end: '2026-06-20', status: 'on-hold' }
            ];
            const mainRefs = [];
            for (let i = 0; i < sampleMain.length; i++) {
                const m = sampleMain[i];
                const mainId = (i + 1).toString();
                const mainDoc = db.collection('gantt_tasks').doc();
                batch.set(mainDoc, {
                    displayId: mainId,
                    name: m.name,
                    budget: m.budget,
                    start: m.start,
                    end: m.end,
                    status: m.status,
                    isMain: true,
                    onHold: m.status === 'on-hold',
                    parentId: null,
                    pred: '',
                    projectId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                mainRefs.push({ id: mainDoc.id, displayId: mainId, name: m.name });
            }
            const subTasks = [
                { parentIdx: 0, name: 'Clear area', budget: 2000, start: '2026-02-20', end: '2026-02-25', status: 'completed' },
                { parentIdx: 0, name: 'Survey', budget: 1500, start: '2026-02-26', end: '2026-03-02', status: 'completed' },
                { parentIdx: 1, name: 'Excavation', budget: 5000, start: '2026-03-05', end: '2026-03-18', status: 'completed' },
                { parentIdx: 1, name: 'Concrete pour', budget: 7000, start: '2026-03-15', end: '2026-04-02', status: 'in-progress' },
                { parentIdx: 4, name: 'Rough wiring', budget: 4000, start: '2026-04-25', end: '2026-05-30', status: 'on-hold' }
            ];
            for (const s of subTasks) {
                const parent = mainRefs[s.parentIdx];
                if (!parent) continue;
                const parentDisplay = parent.displayId;
                const subIndex = subTasks.findIndex(x => x.name === s.name) + 1;
                const displayId = `${parentDisplay}.${subIndex}`;
                const subDoc = db.collection('gantt_tasks').doc();
                batch.set(subDoc, {
                    displayId,
                    name: s.name,
                    budget: s.budget,
                    start: s.start,
                    end: s.end,
                    status: s.status,
                    isMain: false,
                    onHold: s.status === 'on-hold',
                    parentId: parent.id,
                    pred: '',
                    projectId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            await batch.commit();
        } catch (e) { console.warn('seed issue', e); }
    }

    function loadTasks() {
        db.collection('gantt_tasks').where('projectId', '==', projectId).get()
        .then(async snapshot => {
            if (snapshot.empty) {
                await seedSampleTasksIfEmpty();
                const newSnap = await db.collection('gantt_tasks').where('projectId', '==', projectId).get();
                tasks = [];
                newSnap.forEach(doc => {
                    const data = doc.data();
                    tasks.push({
                        firebaseId: doc.id,
                        parentFirebaseId: data.parentId || null,
                        displayId: data.displayId || data.id || doc.id,
                        name: data.name || 'Unnamed',
                        start: data.start || null,
                        end: data.end || null,
                        pred: data.pred || '',
                        budget: data.budget || 0,
                        isMain: data.isMain || false,
                        status: data.status || 'not-started',
                        onHold: data.onHold || false,
                        parentId: data.parentId || null
                    });
                });
                renderTable();
                setupRealtimeListener();
            } else {
                tasks = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    tasks.push({
                        firebaseId: doc.id,
                        parentFirebaseId: data.parentId || null,
                        displayId: data.displayId || data.id || doc.id,
                        name: data.name || 'Unnamed',
                        start: data.start || null,
                        end: data.end || null,
                        pred: data.pred || '',
                        budget: data.budget || 0,
                        isMain: data.isMain || false,
                        status: data.status || 'not-started',
                        onHold: data.onHold || false,
                        parentId: data.parentId || null
                    });
                });
                renderTable();
                setupRealtimeListener();
            }
        }).catch(error => {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="7" style="color:red;">Error loading tasks</td></tr>`;
        });
    }

    function setupRealtimeListener() {
        db.collection('gantt_tasks').where('projectId', '==', projectId).onSnapshot(snapshot => {
            tasks = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                tasks.push({
                    firebaseId: doc.id,
                    parentFirebaseId: data.parentId || null,
                    displayId: data.displayId || data.id || doc.id,
                    name: data.name || 'Unnamed',
                    start: data.start || null,
                    end: data.end || null,
                    pred: data.pred || '',
                    budget: data.budget || 0,
                    isMain: data.isMain || false,
                    status: data.status || 'not-started',
                    onHold: data.onHold || false,
                    parentId: data.parentId || null
                });
            });
            renderTable();
        }, error => console.log('listener error', error));
    }

    async function updateTask(taskId, updates) {
        try {
            await db.collection('gantt_tasks').doc(taskId).update({
                ...updates,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showMessage('Updated');
        } catch (error) {
            showMessage('Error updating', 'error');
        }
    }

    async function addTask(taskData) {
        try {
            await db.collection('gantt_tasks').add({
                ...taskData,
                projectId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showMessage('Task added');
            return true;
        } catch (error) {
            showMessage('Error: ' + error.message, 'error');
            return false;
        }
    }

    window.goToProjects = () => window.location.href = 'projects.html';

    toggleBtn.addEventListener('click', () => {
        form.classList.toggle('visible');
        toggleBtn.textContent = form.classList.contains('visible') ? '‚àí Hide form' : 'Ôºã Show form';
    });

    submitBtn.addEventListener('click', async () => {
        const name = document.getElementById('taskName').value.trim();
        const budget = parseFloat(document.getElementById('budgetAmount').value) || 0;
        const parentId = document.getElementById('parentTaskSelect').value;
        const predId = document.getElementById('predSelect').value;
        if (!name) return showMessage('Enter name', 'error');
        submitBtn.disabled = true;
        const isMain = !parentId;
        const displayId = generateTaskId(isMain, parentId);
        if (!displayId) {
            showMessage('ID error', 'error');
            submitBtn.disabled = false;
            return;
        }
        const success = await addTask({
            displayId, id: displayId, name, budget, isMain,
            status:'not-started', onHold:false, parentId:parentId||null, pred:predId||''
        });
        if (success) {
            document.getElementById('taskName').value = '';
            document.getElementById('budgetAmount').value = '5000';
            document.getElementById('parentTaskSelect').value = '';
            document.getElementById('predSelect').value = '';
            form.classList.remove('visible');
            toggleBtn.textContent = 'Ôºã Show form';
        }
        submitBtn.disabled = false;
    });

    document.getElementById('menuStart').addEventListener('click', ()=>{
        if(!selectedTaskId) return;
        currentAction='start';
        datePickerPopup.style.display='flex';
        datePickerPopup.style.left = contextMenu.style.left;
        datePickerPopup.style.top = contextMenu.style.top;
        contextMenu.style.display='none';
    });
    document.getElementById('menuEnd').addEventListener('click', ()=>{
        if(!selectedTaskId) return;
        currentAction='end';
        datePickerPopup.style.display='flex';
        datePickerPopup.style.left = contextMenu.style.left;
        datePickerPopup.style.top = contextMenu.style.top;
        contextMenu.style.display='none';
    });
    document.getElementById('menuHold').addEventListener('click', async ()=>{
        if(selectedTaskId) {
            const task = tasks.find(t=>t.firebaseId===selectedTaskId);
            if(task) {
                const newOnHold = !task.onHold;
                await updateTask(selectedTaskId, { onHold: newOnHold, status: newOnHold ? 'on-hold' : 'not-started' });
            }
            contextMenu.style.display='none';
        }
    });
    document.getElementById('menuComplete').addEventListener('click', async ()=>{
        if(selectedTaskId) { await updateTask(selectedTaskId, {status:'completed'}); contextMenu.style.display='none'; }
    });
    document.getElementById('menuInProgress').addEventListener('click', async ()=>{
        if(selectedTaskId) { await updateTask(selectedTaskId, {status:'in-progress'}); contextMenu.style.display='none'; }
    });

    datePickerSave.addEventListener('click', async ()=>{
        if(selectedTaskId && currentAction) {
            const date = datePickerInput.value;
            if(date) {
                const updates = {};
                updates[currentAction === 'start' ? 'start' : 'end'] = date;
                await updateTask(selectedTaskId, updates);
            }
            datePickerPopup.style.display='none';
            selectedTaskId=null; currentAction=null;
        }
    });

    document.addEventListener('click', (e)=>{
        if (!contextMenu.contains(e.target) && !datePickerPopup.contains(e.target)) {
            contextMenu.style.display='none';
            datePickerPopup.style.display='none';
        }
    });

    hideCheckbox.addEventListener('change', applyColumnVisibility);

    async function init() {
        loadFilterSetting();
        await loadProjectInfo();
        loadTasks();
    }
    init();
    })();
</script>
</body>
</html>
