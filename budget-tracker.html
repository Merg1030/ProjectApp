<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNZA ¬∑ Project Gantt</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        html, body {
            height: 100%;
            width: 100%;
            background: #0b1a2b;
            overflow: hidden;
        }
        .gantt-full {
            height: 100vh;
            width: 100vw;
            background: #fafcff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        /* Header */
        .top-space {
            padding: 0.8rem 2rem;
            background: #ffffff;
            border-bottom: 1px solid #dde3ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .project-headline {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .project-headline h2 {
            font-weight: 500;
            font-size: 1.1rem;
            color: #0c2b4b;
        }
        .project-badge {
            background: #e2eaf3;
            border-radius: 40px;
            padding: 0.3rem 0.8rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #1c4b77;
            border: 1px solid #c6d6eb;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f1f5fb;
            padding: 0.3rem 1rem;
            border-radius: 40px;
            font-size: 0.75rem;
            color: #1e3e64;
            border: 1px solid #c8d7ec;
        }
        .filter-toggle input {
            accent-color: #2b6c9e;
            width: 16px;
            height: 16px;
            margin: 0;
        }
        .toggle-form-btn {
            background: #ffffff;
            border: 1px solid #b9cae6;
            padding: 0.4rem 1.2rem;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 500;
            color: #1e3a5c;
            cursor: pointer;
            transition: 0.1s;
        }
        .toggle-form-btn:hover {
            background: #ecf3fd;
            border-color: #7f9bc2;
        }
        .nav-btn {
            background: #f2f6fc;
            border: 1px solid #c6d4e8;
            padding: 0.4rem 1rem;
            border-radius: 40px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            color: #1f4172;
            text-decoration: none;
        }
        .nav-btn:hover {
            background: #e2ebf7;
        }
        /* Form */
        .form-popup {
            background: #f5f9ff;
            border-bottom: 2px solid #b1c8e5;
            padding: 1rem 2rem;
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(150px, auto));
            gap: 20px;
            align-items: end;
            flex-shrink: 0;
        }
        .form-popup.visible {
            display: grid;
        }
        .form-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.7rem;
            color: #1e4170;
        }
        .form-field input, 
        .form-field select {
            padding: 0.5rem 1rem;
            border: 1px solid #b9ceec;
            border-radius: 30px;
            font-size: 0.75rem;
            background: white;
        }
        .form-field button {
            background: #1c3f64;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 14px;
        }
        /* Gantt Container */
        .gantt-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #ffffff;
        }
        /* Calendar Header - Fixed */
        .calendar-header {
            flex-shrink: 0;
            display: flex;
            background: #ffffff;
            border-bottom: 2px solid #dde3ed;
            overflow-x: auto;
            overflow-y: hidden;
        }
        .calendar-left {
            width: 320px;
            flex-shrink: 0;
            border-right: 1px solid #dde3ed;
        }
        .calendar-right {
            flex: 1;
            display: flex;
            overflow-x: auto;
        }
        .month-row {
            display: flex;
            width: 100%;
            border-bottom: 1px solid #dde3ed;
        }
        .month-cell {
            flex: 1;
            padding: 8px;
            text-align: center;
            font-weight: 700;
            font-size: 0.85rem;
            color: #1d344c;
            background: #e8f0fb;
            border-right: 1px solid #c2d2e8;
        }
        .day-row {
            display: flex;
            width: 100%;
        }
        .day-cell {
            flex: 1;
            padding: 6px 2px;
            text-align: center;
            font-weight: 600;
            font-size: 0.7rem;
            color: #1d344c;
            background: #d4e4f5;
            border-right: 1px solid #c2d2e8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        /* Task List & Gantt Scroll */
        .gantt-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .task-list {
            width: 320px;
            flex-shrink: 0;
            overflow-y: auto;
            overflow-x: hidden;
            background: #ffffff;
            border-right: 1px solid #dde3ed;
        }
        .task-list-header {
            display: flex;
            padding: 0.8rem 1rem;
            background: #f5f9ff;
            border-bottom: 1px solid #dde3ed;
            font-weight: 600;
            font-size: 0.75rem;
            color: #1d344c;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0;
            align-items: center;
            gap: 0.5rem;
        }
        .task-item {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid #e8ecf2;
            font-size: 0.75rem;
            color: #2f4b70;
            cursor: context-menu;
            transition: 0.1s;
        }
        .task-item:hover {
            background: #f5f9ff;
        }
        .task-item-main {
            font-weight: 600;
            color: #ffffff;
            background: #2e7d32;
            padding: 6px 10px;
            border-radius: 4px;
            margin: -2px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
        }
        .task-item-main .task-num {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.65rem;
        }
        .task-item-sub {
            padding-left: 30px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .task-item-sub .task-num {
            color: #5f7b9c;
            min-width: 30px;
            font-size: 0.7rem;
        }
        .gantt-chart {
            flex: 1;
            overflow: auto;
            background: #ffffff;
        }
        .gantt-grid {
            display: flex;
            width: 100%;
            min-height: 100%;
        }
        .gantt-row {
            display: flex;
            width: 100%;
            border-bottom: 1px solid #e3e9f2;
        }
        .gantt-cell {
            flex: 1;
            padding: 0.6rem 0.2rem;
            position: relative;
            height: 40px;
            display: flex;
            align-items: center;
            border-right: 1px solid #dce3ef;
            background: #ffffff;
        }
        .bar-container {
            position: relative;
            width: 100%;
            height: 24px;
        }
        .task-bar {
            position: absolute;
            height: 22px;
            top: 1px;
            background: #2b5f8a;
            border-radius: 3px;
            border: 1px solid #153a58;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            min-width: 4px;
            z-index: 5;
        }
        .task-bar:hover {
            background: #1e4566;
        }
        .task-bar.sub {
            background: #60758b;
            border-color: #3a4d63;
            height: 18px;
            top: 3px;
        }
        .task-bar.completed {
            background: #2f8b5e;
        }
        .task-bar.in-progress {
            background: #d4a537;
        }
        .task-bar.on-hold {
            background: #c24d3d;
        }
        .milestone-marker {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #947c5c;
            transform: rotate(45deg);
            top: 8px;
            border: 2px solid white;
            z-index: 6;
        }
        /* Bottom */
        .bottom-space {
            padding: 0.8rem 2rem;
            background: #ffffff;
            border-top: 1px solid #c2d2e8;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .completion-bar-container {
            flex: 1;
            height: 14px;
            background: #e2e9f3;
            border-radius: 30px;
            overflow: hidden;
            border: 1px solid #a5bbda;
        }
        .completion-bar-fill {
            height: 100%;
            background: #2e7d5e;
            width: 0%;
            transition: width 0.2s;
        }
        .completion-label {
            font-size: 0.7rem;
            color: #1d3a5c;
            min-width: 100px;
            font-weight: 500;
        }
        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #a0b9d9;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
            padding: 5px 0;
        }
        .context-menu-item {
            padding: 8px 18px;
            font-size: 0.75rem;
            cursor: pointer;
            color: #1a3455;
            white-space: nowrap;
        }
        .context-menu-item:hover {
            background: #e2ecfc;
        }
        /* Date Picker */
        .date-picker-popup {
            position: absolute;
            background: white;
            border: 1px solid #a0b9d9;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
            padding: 16px;
            gap: 12px;
        }
        .date-picker-popup input {
            padding: 8px 12px;
            border: 1px solid #b0c7e7;
            border-radius: 30px;
        }
        .date-picker-popup button {
            background: #1f3f64;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        /* Message */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 2000;
            font-size: 0.8rem;
            animation: slideIn 0.3s ease;
        }
        .message.success {
            background: #dff0e4;
            color: #1e6f3f;
        }
        .message.error {
            background: #fee9e7;
            color: #b3382c;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .loading {
            padding: 40px;
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
<div class="gantt-full">
    <!-- Header -->
    <div class="top-space">
        <div class="project-headline">
            <h2>üìä Gantt ¬∑ <span id="projectNameDisplay">UNZA</span></h2>
            <span id="projectCodeDisplay" class="project-badge">we3e3</span>
        </div>
        <div class="header-controls">
            <div class="filter-toggle">
                <input type="checkbox" id="hideColumnsCheckbox"> 
                <label for="hideColumnsCheckbox" style="margin: 0;">Hide columns</label>
            </div>
            <button class="nav-btn" onclick="goToProjects()">‚Üê Projects</button>
            <button class="toggle-form-btn" id="toggleFormBtn">Ôºã New task</button>
        </div>
    </div>

    <!-- Form -->
    <div class="form-popup" id="addForm">
        <div class="form-field">
            <label>Task name</label>
            <input type="text" id="taskName" placeholder="e.g. Foundation">
        </div>
        <div class="form-field">
            <label>Budget ($)</label>
            <input type="number" id="budgetAmount" value="5000">
        </div>
        <div class="form-field">
            <label>Parent task</label>
            <select id="parentTaskSelect"><option value="">‚Äî Main ‚Äî</option></select>
        </div>
        <div class="form-field">
            <label>Predecessor</label>
            <select id="predSelect"><option value="">‚Äî None ‚Äî</option></select>
        </div>
        <div class="form-field">
            <button id="submitTaskBtn">Add Task</button>
        </div>
    </div>

    <!-- Gantt -->
    <div class="gantt-container">
        <!-- Calendar Header (Fixed) -->
        <div class="calendar-header" id="calendarHeader">
            <div class="calendar-left"></div>
            <div class="calendar-right" id="calendarRight"></div>
        </div>

        <!-- Body -->
        <div class="gantt-body">
            <!-- Task List -->
            <div class="task-list">
                <div class="task-list-header">üìã Task</div>
                <div id="taskListContainer"></div>
            </div>

            <!-- Gantt Chart -->
            <div class="gantt-chart">
                <div class="gantt-grid" id="ganttGrid"></div>
            </div>
        </div>
    </div>

    <!-- Bottom -->
    <div class="bottom-space">
        <div class="completion-label">Overall Progress</div>
        <div class="completion-bar-container">
            <div class="completion-bar-fill" id="completionBarFill"></div>
        </div>
        <div class="completion-label" id="completionPercent">0%</div>
    </div>
</div>

<!-- Context Menu -->
<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" id="menuStart">üìÖ Set Start</div>
    <div class="context-menu-item" id="menuEnd">üìÖ Set End</div>
    <div class="context-menu-item" id="menuHold">‚è∏Ô∏è Toggle Hold</div>
    <div class="context-menu-item" id="menuComplete">‚úÖ Completed</div>
    <div class="context-menu-item" id="menuInProgress">üîÑ In Progress</div>
</div>

<!-- Date Picker -->
<div class="date-picker-popup" id="datePickerPopup">
    <input type="date" id="datePickerInput">
    <button id="datePickerSave">Save</button>
</div>

<script>
    // Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
        authDomain: "project-task-588c4.firebaseapp.com",
        projectId: "project-task-588c4",
        storageBucket: "project-task-588c4.firebasestorage.app",
        messagingSenderId: "411882772509",
        appId: "1:411882772509:web:08d613186c101a99f38ef4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('project');
    if (!projectId) window.location.href = 'projects.html';

    // State
    let tasks = [];
    let dailyTicks = [];
    let selectedTaskId = null;
    let currentAction = null;

    // Helper Functions
    function showMessage(text, type = 'success') {
        const msg = document.createElement('div');
        msg.className = `message ${type}`;
        msg.textContent = text;
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
    }

    function generateDailyTicks() {
        const start = new Date('2026-02-17');
        const end = new Date('2026-06-30');
        let ticks = [];
        let current = new Date(start);
        
        while (current <= end) {
            if (current.getDay() !== 0) { // Skip Sunday
                ticks.push({
                    date: new Date(current),
                    day: current.toLocaleString('en-us', { weekday: 'short' }),
                    date_num: current.getDate(),
                    month: current.toLocaleString('en-us', { month: 'short' })
                });
            }
            current.setDate(current.getDate() + 1);
        }
        return ticks;
    }

    function calculatePosition(task, ticks) {
        if (!task.start || !task.end || ticks.length === 0) {
            return { left: 0, width: 2 };
        }
        try {
            const taskStart = new Date(task.start);
            const taskEnd = new Date(task.end);
            const firstTick = ticks[0].date;
            const lastTick = ticks[ticks.length - 1].date;

            if (taskEnd < firstTick || taskStart > lastTick) {
                return { left: 0, width: 0 };
            }

            let startIdx = ticks.findIndex(t => t.date >= taskStart);
            if (startIdx === -1) startIdx = 0;
            let endIdx = ticks.findIndex(t => t.date > taskEnd);
            if (endIdx === -1) endIdx = ticks.length - 1;
            else endIdx--;

            const total = ticks.length;
            const left = (startIdx / total) * 100;
            const width = ((endIdx - startIdx + 1) / total) * 100;
            return { left: Math.max(0, left), width: Math.max(1, width) };
        } catch (e) {
            return { left: 0, width: 2 };
        }
    }

    function getStatusClass(status) {
        switch(status) {
            case 'completed': return 'completed';
            case 'in-progress': return 'in-progress';
            case 'on-hold': return 'on-hold';
            default: return '';
        }
    }

    function updateCompletion() {
        const total = tasks.length;
        if (total === 0) {
            document.getElementById('completionBarFill').style.width = '0%';
            document.getElementById('completionPercent').innerText = '0%';
            return;
        }
        const completed = tasks.filter(t => t.status === 'completed').length;
        const percent = Math.round((completed / total) * 100);
        document.getElementById('completionBarFill').style.width = percent + '%';
        document.getElementById('completionPercent').innerText = percent + '%';
    }

    // Render Calendar Header
    function renderCalendarHeader() {
        if (dailyTicks.length === 0) return;

        let monthMap = {};
        dailyTicks.forEach((tick, idx) => {
            const key = tick.month;
            if (!monthMap[key]) monthMap[key] = { count: 0, start: idx };
            monthMap[key].count++;
        });

        let monthHTML = '';
        Object.entries(monthMap).forEach(([month, data]) => {
            const width = (data.count / dailyTicks.length) * 100;
            monthHTML += `<div class="month-cell" style="width:${width}%">${month}</div>`;
        });

        let dayHTML = '';
        dailyTicks.forEach((tick) => {
            const width = (1 / dailyTicks.length) * 100;
            dayHTML += `<div class="day-cell" style="width:${width}%">${tick.day}</div>`;
        });

        document.getElementById('calendarRight').innerHTML = `
            <div class="month-row">${monthHTML}</div>
            <div class="day-row">${dayHTML}</div>
        `;
    }

    // Render Tasks and Chart
    function render() {
        if (!dailyTicks || dailyTicks.length === 0) {
            dailyTicks = generateDailyTicks();
            renderCalendarHeader();
        }

        // Task List
        const taskListHTML = tasks.map(task => {
            if (task.isMain) {
                return `<div class="task-item" data-task-id="${task.firebaseId}">
                    <div class="task-item-main">
                        <span class="task-num">${task.displayId}</span>
                        <span>${task.name}</span>
                    </div>
                </div>`;
            } else {
                return `<div class="task-item" data-task-id="${task.firebaseId}">
                    <div class="task-item-sub">
                        <span class="task-num">${task.displayId}</span>
                        <span>${task.name}</span>
                    </div>
                </div>`;
            }
        }).join('');

        document.getElementById('taskListContainer').innerHTML = taskListHTML || '<div class="loading">No tasks</div>';

        // Gantt Chart
        const ganttHTML = tasks.map(task => {
            const pos = calculatePosition(task, dailyTicks);
            const cells = dailyTicks.map(() => {
                return `<div class="gantt-cell"></div>`;
            }).join('');

            const statusClass = getStatusClass(task.status);
            const barHTML = pos.width > 0 ? `
                <div class="task-bar ${task.isMain ? '' : 'sub'} ${statusClass}" 
                    style="left:${pos.left}%; width:${pos.width}%;" 
                    data-task-id="${task.firebaseId}">
                </div>
            ` : '';

            return `<div class="gantt-row">${cells}${barHTML}</div>`;
        }).join('');

        document.getElementById('ganttGrid').innerHTML = ganttHTML || '<div class="loading">No tasks</div>';

        // Event listeners
        document.querySelectorAll('[data-task-id]').forEach(el => {
            el.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                selectedTaskId = el.dataset.taskId;
                showContextMenu(e.pageX, e.pageY);
            });
        });

        document.querySelectorAll('.task-bar').forEach(bar => {
            bar.addEventListener('click', async (e) => {
                e.stopPropagation();
                const taskId = bar.dataset.taskId;
                const task = tasks.find(t => t.firebaseId === taskId);
                if (!task) return;
                
                const newStatus = task.status === 'completed' ? 'not-started' : 'completed';
                await updateTask(taskId, { status: newStatus });
            });
        });

        updateCompletion();
    }

    // Context Menu
    function showContextMenu(x, y) {
        const menu = document.getElementById('contextMenu');
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        menu.style.display = 'flex';
    }

    document.getElementById('menuStart').addEventListener('click', () => {
        if (!selectedTaskId) return;
        currentAction = 'start';
        const menu = document.getElementById('contextMenu');
        document.getElementById('datePickerPopup').style.left = menu.style.left;
        document.getElementById('datePickerPopup').style.top = menu.style.top;
        document.getElementById('datePickerPopup').style.display = 'flex';
        menu.style.display = 'none';
    });

    document.getElementById('menuEnd').addEventListener('click', () => {
        if (!selectedTaskId) return;
        currentAction = 'end';
        const menu = document.getElementById('contextMenu');
        document.getElementById('datePickerPopup').style.left = menu.style.left;
        document.getElementById('datePickerPopup').style.top = menu.style.top;
        document.getElementById('datePickerPopup').style.display = 'flex';
        menu.style.display = 'none';
    });

    document.getElementById('menuHold').addEventListener('click', async () => {
        if (!selectedTaskId) return;
        const task = tasks.find(t => t.firebaseId === selectedTaskId);
        if (!task) return;
        await updateTask(selectedTaskId, { onHold: !task.onHold });
        document.getElementById('contextMenu').style.display = 'none';
    });

    document.getElementById('menuComplete').addEventListener('click', async () => {
        if (!selectedTaskId) return;
        await updateTask(selectedTaskId, { status: 'completed' });
        document.getElementById('contextMenu').style.display = 'none';
    });

    document.getElementById('menuInProgress').addEventListener('click', async () => {
        if (!selectedTaskId) return;
        await updateTask(selectedTaskId, { status: 'in-progress' });
        document.getElementById('contextMenu').style.display = 'none';
    });

    document.getElementById('datePickerSave').addEventListener('click', async () => {
        if (!selectedTaskId || !currentAction) return;
        const date = document.getElementById('datePickerInput').value;
        if (!date) return;
        const updates = {};
        updates[currentAction === 'start' ? 'start' : 'end'] = date;
        await updateTask(selectedTaskId, updates);
        document.getElementById('datePickerPopup').style.display = 'none';
        selectedTaskId = null;
        currentAction = null;
    });

    document.addEventListener('click', (e) => {
        const menu = document.getElementById('contextMenu');
        const picker = document.getElementById('datePickerPopup');
        if (!menu.contains(e.target) && !picker.contains(e.target)) {
            menu.style.display = 'none';
            picker.style.display = 'none';
        }
    });

    // Firebase Functions
    async function loadProjectInfo() {
        try {
            const doc = await db.collection('projects').doc(projectId).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('projectNameDisplay').textContent = data.name || 'UNZA';
                document.getElementById('projectCodeDisplay').textContent = data.code || 'we3e3';
            }
        } catch (error) {
            console.error(error);
        }
    }

    function loadTasks() {
        db.collection('gantt_tasks')
            .where('projectId', '==', projectId)
            .orderBy('displayId')
            .get()
            .then(snapshot => {
                tasks = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    tasks.push({
                        firebaseId: doc.id,
                        displayId: data.displayId || doc.id,
                        name: data.name || 'Unnamed',
                        start: data.start,
                        end: data.end,
                        budget: data.budget || 0,
                        status: data.status || 'not-started',
                        isMain: data.isMain || false,
                        onHold: data.onHold || false,
                        parentId: data.parentId || null
                    });
                });
                render();
                setupListener();
            })
            .catch(error => console.error(error));
    }

    function setupListener() {
        db.collection('gantt_tasks')
            .where('projectId', '==', projectId)
            .onSnapshot(snapshot => {
                tasks = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    tasks.push({
                        firebaseId: doc.id,
                        displayId: data.displayId || doc.id,
                        name: data.name || 'Unnamed',
                        start: data.start,
                        end: data.end,
                        budget: data.budget || 0,
                        status: data.status || 'not-started',
                        isMain: data.isMain || false,
                        onHold: data.onHold || false,
                        parentId: data.parentId || null
                    });
                });
                render();
            });
    }

    async function updateTask(taskId, updates) {
        try {
            await db.collection('gantt_tasks').doc(taskId).update(updates);
            showMessage('Updated');
        } catch (error) {
            showMessage('Error: ' + error.message, 'error');
        }
    }

    // Form Functions
    document.getElementById('toggleFormBtn').addEventListener('click', () => {
        const form = document.getElementById('addForm');
        form.classList.toggle('visible');
        document.getElementById('toggleFormBtn').textContent = 
            form.classList.contains('visible') ? '‚àí Hide' : 'Ôºã New task';
    });

    document.getElementById('submitTaskBtn').addEventListener('click', async () => {
        const name = document.getElementById('taskName').value.trim();
        const budget = parseFloat(document.getElementById('budgetAmount').value) || 0;
        const parentId = document.getElementById('parentTaskSelect').value;
        
        if (!name) {
            showMessage('Enter task name', 'error');
            return;
        }

        const isMain = !parentId;
        const displayId = isMain ? 
            (Math.max(...tasks.filter(t => t.isMain).map(t => parseInt(t.displayId) || 0), 0) + 1).toString() :
            'sub';

        try {
            await db.collection('gantt_tasks').add({
                projectId,
                displayId,
                name,
                budget,
                isMain,
                status: 'not-started',
                onHold: false,
                parentId: parentId || null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            document.getElementById('taskName').value = '';
            document.getElementById('budgetAmount').value = '5000';
            document.getElementById('parentTaskSelect').value = '';
            document.getElementById('addForm').classList.remove('visible');
            document.getElementById('toggleFormBtn').textContent = 'Ôºã New task';
            showMessage('Task added');
        } catch (error) {
            showMessage('Error: ' + error.message, 'error');
        }
    });

    window.goToProjects = () => {
        window.location.href = 'projects.html';
    };

    // Init
    loadProjectInfo();
    loadTasks();
</script>
</body>
</html>
