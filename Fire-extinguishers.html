<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PENTA · extinguisher tracker</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- Bootstrap 5 (light) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">
  <style>
    :root {
      --primary: #1a365d;
      --secondary: #ed8936;
      --border-color: #e2e8f0;
      --success: #48bb78;
      --warning: #ed8936;
      --danger: #e53e3e;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: white;
      color: #171923;
      line-height: 1.6;
      overflow-x: hidden;
      transition: all 0.3s ease;
    }

    /* Simple White Sidebar */
    .sidebar {
      width: 250px;
      background: white;
      color: #171923;
      padding: 1rem 0;
      position: fixed;
      height: 100vh;
      z-index: 1000;
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
      border-right: 1px solid var(--border-color);
      left: 0;
    }

    .sidebar.collapsed {
      transform: translateX(-100%);
      box-shadow: none;
    }

    .sidebar-header {
      padding: 0 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1rem;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--primary);
      border-radius: 0.375rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: white;
    }

    .logo-text h2 {
      font-size: 1.25rem;
      font-weight: 700;
      margin: 0;
      color: var(--primary);
    }

    .logo-text span {
      font-size: 0.75rem;
      color: #718096;
    }

    .nav-section {
      padding: 0 1rem;
      margin-bottom: 1.5rem;
    }

    .nav-section h3 {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #718096;
      margin-bottom: 0.75rem;
    }

    .nav-links {
      list-style: none;
    }

    .nav-item {
      margin-bottom: 0.25rem;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      color: #4a5568;
      text-decoration: none;
      border-radius: 0.375rem;
      transition: all 0.15s ease;
    }

    .nav-link:hover {
      background: #f7fafc;
      color: var(--primary);
    }

    .nav-link.active {
      background: #ebf8ff;
      color: var(--primary);
      font-weight: 500;
    }

    .nav-icon {
      font-size: 1rem;
      width: 20px;
      text-align: center;
    }

    .sidebar-toggle {
      position: absolute;
      top: 1rem;
      right: -12px;
      width: 24px;
      height: 24px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 2px solid white;
      font-size: 0.75rem;
      z-index: 1001;
    }

    .main-content {
      flex: 1;
      margin-left: 250px;
      transition: all 0.3s ease;
      padding: 2rem;
      min-height: 100vh;
      background: white;
      width: calc(100% - 250px);
    }

    .main-content.expanded {
      margin-left: 0;
      width: 100%;
    }

    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .welcome-section {
      margin-bottom: 2rem;
    }

    .welcome-section h1 {
      font-size: 2rem;
      font-weight: 700;
      margin: 0;
      color: var(--primary);
    }

    .welcome-section p {
      color: #718096;
      margin: 0.5rem 0 0;
      font-size: 1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }

    .stat-card:hover {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transform: translateY(-2px);
      border-color: var(--primary);
    }

    .stat-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 0.375rem;
      background: #ebf8ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 1.25rem;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      color: #718096;
      font-size: 0.875rem;
    }

    /* filter bar – new location filter */
    .filter-bar {
      background: white;
      border-radius: 0.5rem;
      padding: 1rem 1.5rem;
      border: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 1.5rem;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .filter-group label {
      font-size: 0.8rem;
      font-weight: 600;
      color: #4a5568;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .location-filter-select {
      padding: 0.5rem 2rem 0.5rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 2rem;
      font-size: 0.9rem;
      background: white;
      min-width: 220px;
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%234a5568' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      appearance: none;
    }

    .location-filter-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
    }

    .clear-filter-btn {
      background: none;
      border: 1px solid var(--border-color);
      padding: 0.4rem 1rem;
      border-radius: 2rem;
      font-size: 0.8rem;
      color: #4a5568;
      transition: all 0.1s;
    }

    .clear-filter-btn:hover {
      background: #f7fafc;
      border-color: var(--primary);
      color: var(--primary);
    }

    .add-form-section {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      border: 1px solid var(--border-color);
      margin-bottom: 2rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .section-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary);
      margin: 0;
    }

    .toggle-form-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
    }

    .toggle-form-btn:hover {
      background: #0d2b50;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      align-items: end;
      transition: all 0.3s ease;
    }

    .form-grid.hidden {
      display: none;
    }

    .form-group {
      margin-bottom: 0;
    }

    .form-group label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: #718096;
      margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.625rem 0.875rem;
      border: 1px solid var(--border-color);
      border-radius: 0.375rem;
      font-size: 0.875rem;
      transition: all 0.15s ease;
      background: white;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.625rem 1.25rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: background 0.2s ease;
      height: fit-content;
    }

    .btn-primary:hover {
      background: #0d2b50;
    }

    .btn-success {
      background: var(--success);
      color: white;
      border: none;
      padding: 0.625rem 1.25rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .service-bar {
      background: #f7fafc;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .service-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .selected-count {
      background: var(--primary);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 2rem;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 0.5rem;
      padding: 2rem;
      max-width: 1000px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal-content.large {
      max-width: 1500px;
      max-height: 1000px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      position: sticky;
      top: 0;
      background: white;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
      z-index: 10;
    }

    .modal-header h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary);
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #718096;
    }

    .close-modal:hover {
      color: var(--danger);
    }

    .password-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 0.375rem;
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    /* Table */
    .table-section {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      border: 1px solid var(--border-color);
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .ext-table {
      width: 100%;
      border-collapse: collapse;
    }

    .ext-table th {
      text-align: left;
      padding: 1rem;
      font-weight: 600;
      background: #f7fafc;
      color: var(--primary);
      font-size: 0.75rem;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border-color);
    }

    .ext-table td {
      padding: 1rem;
      color: #4a5568;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.875rem;
      vertical-align: middle;
    }

    .ext-table tr:hover {
      background: #f7fafc;
    }

    .ext-table tr.expired-row {
      background: #fff5f5;
    }

    .ext-table tr.expired-row:hover {
      background: #fee;
    }

    .location-cell {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .location-icon {
      width: 32px;
      height: 32px;
      border-radius: 0.375rem;
      background: #ebf8ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 1rem;
    }

    .badge, .type-badge, .code-badge, .next-service-badge, .expiration-badge, .service-count {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .badge-success { background: #c6f6d5; color: #22543d; }
    .badge-warning { background: #feebc8; color: #c05621; }
    .badge-danger { background: #fed7d7; color: #9b2c2c; }
    .badge-info { background: #e6f7ff; color: #0e5a8a; }
    .type-badge { background: #e9d8fd; color: #553c9a; }
    .code-badge { background: #e6fffa; color: #234e52; font-family: monospace; }
    .next-service-badge { background: #feebc8; color: #c05621; }
    .expiration-badge { background: #e6f7ff; color: #0e5a8a; }
    .service-count { background: #ebf8ff; color: var(--primary); }

    .checkbox-cell { width: 40px; text-align: center; }
    .checkbox-cell input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    .menu-container { position: relative; }
    .menu-button { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: #718096; padding: 0.25rem 0.5rem; border-radius: 0.375rem; }
    .menu-button:hover { background: #e2e8f0; color: var(--primary); }
    .dropdown-menu { position: absolute; right: 0; top: 100%; background: white; border: 1px solid var(--border-color); border-radius: 0.375rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 100; min-width: 180px; display: none; }
    .dropdown-menu.active { display: block; }
    .dropdown-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: #4a5568; text-decoration: none; transition: background 0.15s ease; width: 100%; border: none; background: none; font-size: 0.875rem; cursor: pointer; }
    .dropdown-item:hover { background: #f7fafc; color: var(--primary); }
    .dropdown-item.delete-item:hover { color: var(--danger); }

    .empty-state { padding: 3rem; text-align: center; color: #718096; }
    .empty-state i { font-size: 2rem; margin-bottom: 1rem; display: block; }

    .mobile-toggle {
      display: none;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.375rem;
      padding: 0.5rem;
      cursor: pointer;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1100;
    }

    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.active { transform: translateX(0); }
      .main-content { margin-left: 0; width: 100%; padding: 1rem; }
      .mobile-toggle { display: block; }
      .sidebar-toggle { display: none; }
      .stats-grid { grid-template-columns: 1fr; }
      .filter-bar { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <button class="mobile-toggle" id="mobileToggle"><i class="fas fa-bars"></i></button>

  <!-- sidebar (omitted identical, keep same) -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-chevron-left" id="toggleIcon"></i></div>
    <div class="sidebar-header"><div class="logo-container"><div class="logo-icon"><i class="fas fa-building"></i></div><div class="logo-text"><h2>PENTA</h2><span>Construction Pro</span></div></div></div>
    <nav class="nav-section"><h3>Dashboard</h3><ul class="nav-links"><li class="nav-item"><a href="#" class="nav-link"><i class="fas fa-gauge-high nav-icon"></i><span>Overview</span></a></li><li class="nav-item"><a href="#" class="nav-link"><i class="fas fa-diagram-project nav-icon"></i><span>Projects</span></a></li><li class="nav-item"><a href="#" class="nav-link"><i class="fas fa-user-tie nav-icon"></i><span>Team</span></a></li></ul></nav>
    <nav class="nav-section"><h3>Resources</h3><ul class="nav-links"><li class="nav-item"><a href="#" class="nav-link active"><i class="fas fa-fire-extinguisher nav-icon"></i><span>Fire Extinguishers</span></a></li><li class="nav-item"><a href="#" class="nav-link"><i class="fas fa-screwdriver-wrench nav-icon"></i><span>Equipment</span></a></li><li class="nav-item"><a href="#" class="nav-link"><i class="fas fa-truck-ramp-box nav-icon"></i><span>Materials</span></a></li></ul></nav>
    <nav class="nav-section"><h3>Management</h3><ul class="nav-links"><li class="nav-item"><a href="#" class="nav-link"><i class="fas fa-file-invoice-dollar nav-icon"></i><span>Finances</span></a></li><li class="nav-item"><a href="#" class="nav-link"><i class="fas fa-chart-column nav-icon"></i><span>Reports</span></a></li></ul></nav>
  </aside>

  <main class="main-content" id="mainContent">
    <div class="dashboard-container">
      <div class="welcome-section">
        <h1>Fire Extinguisher Tracker</h1>
        <p>Manage and monitor all fire extinguishers across site locations</p>
      </div>

      <!-- stats grid -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon"><i class="fas fa-fire-extinguisher"></i></div><div><div class="stat-value" id="totalCount">0</div><div class="stat-label">Total</div></div></div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon"><i class="fas fa-check-circle"></i></div><div><div class="stat-value" id="goodCount">0</div><div class="stat-label">Good</div></div></div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div><div><div class="stat-value" id="expiringCount">0</div><div class="stat-label">Expiring soon</div></div></div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon"><i class="fas fa-times-circle"></i></div><div><div class="stat-value" id="expiredCount">0</div><div class="stat-label">Expired</div></div></div></div>
      </div>

      <!-- LOCATION FILTER (the man asked for it) -->
      <div class="filter-bar">
        <div class="filter-group">
          <label for="locationFilter"><i class="fas fa-location-dot" style="margin-right: 4px;"></i> Filter by location</label>
          <select id="locationFilter" class="location-filter-select">
            <option value="all">All locations</option>
            <!-- dynamic options will be injected from existing locations -->
          </select>
          <button class="clear-filter-btn" id="clearFilterBtn"><i class="fas fa-times"></i> Clear</button>
        </div>
        <div style="font-size:0.85rem; color:#4a5568;" id="filterHint"></div>
      </div>

      <!-- service bar -->
      <div class="service-bar">
        <div class="service-info"><span class="selected-count" id="selectedCount">0 selected</span><span id="serviceInfo">Select extinguishers to service</span></div>
        <div style="display: flex; gap: 1rem;">
          <button class="btn-success" id="serviceSelectedBtn"><i class="fas fa-tools"></i> Service Selected</button>
          <button class="btn-primary" id="viewServiceHistoryBtn"><i class="fas fa-history"></i> View Service History</button>
        </div>
      </div>

      <!-- add form (hidden by default) -->
      <div class="add-form-section">
        <div class="section-header"><h2>Add New Extinguisher</h2><button class="toggle-form-btn" id="toggleFormBtn"><i class="fas fa-eye" id="toggleFormIcon"></i> Show Form</button></div>
        <div class="form-grid hidden" id="addForm">
          <div class="form-group"><label>Code/Serial</label><input type="text" id="codeInput" placeholder="e.g. EXT-001"></div>
          <div class="form-group"><label>Location</label><input type="text" id="locationInput" placeholder="e.g. Main Office"></div>
          <div class="form-group"><label>Type</label><select id="typeInput"><option value="DCP">DCP</option><option value="CO2">CO2</option><option value="Foam">Foam</option><option value="Wet Chemical">Wet Chemical</option><option value="Water">Water</option></select></div>
          <div class="form-group"><label>Capacity (kg)</label><input type="number" id="capacityInput" min="1" step="0.5" value="4"></div>
          <div class="form-group"><label>Expiration</label><input type="date" id="expirationInput"></div>
          <div class="form-group"><label>Last Service</label><input type="date" id="serviceInput"></div>
          <div><button class="btn-primary" id="addBtn"><i class="fas fa-plus"></i> Add Extinguisher</button></div>
        </div>
      </div>

      <!-- table section -->
      <div class="table-section">
        <div class="section-header"><h2>All Extinguishers</h2></div>
        <div class="table-wrapper">
          <table class="ext-table" id="extTable">
            <thead><tr><th class="checkbox-cell"><input type="checkbox" id="selectAllCheckbox"></th><th>Code</th><th>Location</th><th>Type</th><th>Capacity</th><th>Expiration</th><th>Last Service</th><th>Next Service</th><th>Status</th><th>Service Count</th><th>Actions</th></tr></thead>
            <tbody id="tableBody"><tr><td colspan="11" class="empty-state"><i class="fas fa-fire-extinguisher"></i> No extinguishers found.</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- modals (unchanged, keep same) -->
  <div class="modal" id="passwordModal"><div class="modal-content"><div class="modal-header"><h3>Authentication Required</h3><button class="close-modal" id="closePasswordModal">&times;</button></div><p>Enter password (1030):</p><input type="password" class="password-input" id="passwordInput"><div style="display:flex; gap:1rem; justify-content:flex-end;"><button class="btn-primary" id="submitPassword">Submit</button><button class="toggle-form-btn" id="cancelPassword">Cancel</button></div></div></div>
  <div class="modal" id="historyModal"><div class="modal-content large"><div class="modal-header"><h3 id="historyModalTitle">Service History</h3><button class="close-modal" id="closeHistoryModal">&times;</button></div><div class="history-tabs"><button class="history-tab active" data-tab="individual">Individual</button><button class="history-tab" data-tab="bulk">Bulk View</button></div><div id="individualHistory" class="history-panel active"><ul class="service-history-list" id="serviceHistoryList"></ul></div><div id="bulkHistory" class="history-panel"><div id="bulkServiceContent"></div></div></div></div>
  <div class="modal" id="serviceModal"><div class="modal-content"><div class="modal-header"><h3>Service Extinguishers</h3><button class="close-modal" id="closeServiceModal">&times;</button></div><p>Selected: <span id="serviceSelectedCount">0</span></p><div class="form-group"><label>Service Date</label><input type="date" id="serviceDate" readonly></div><div class="form-group"><label>Next Service Date *</label><input type="date" id="nextServiceDate" required></div><div class="form-group"><label>New Expiration Date *</label><input type="date" id="newExpirationDate" required></div><div style="display:flex; gap:1rem; justify-content:flex-end;"><button class="btn-success" id="confirmService">Confirm</button><button class="toggle-form-btn" id="cancelService">Cancel</button></div></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
      authDomain: "project-task-588c4.firebaseapp.com",
      projectId: "project-task-588c4",
      storageBucket: "project-task-588c4.appspot.com",
      messagingSenderId: "411882772509",
      appId: "1:411882772509:web:08d613186c101a99f38ef4",
      measurementId: "G-JMFLFYEM0F"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- DOM elements ---
    const sidebar = document.getElementById('sidebar'), sidebarToggle = document.getElementById('sidebarToggle'), toggleIcon = document.getElementById('toggleIcon'), mainContent = document.getElementById('mainContent'), mobileToggle = document.getElementById('mobileToggle');
    const codeInput = document.getElementById('codeInput'), locationInput = document.getElementById('locationInput'), typeInput = document.getElementById('typeInput'), capacityInput = document.getElementById('capacityInput'), expirationInput = document.getElementById('expirationInput'), serviceInput = document.getElementById('serviceInput'), addBtn = document.getElementById('addBtn'), tableBody = document.getElementById('tableBody'), selectAllCheckbox = document.getElementById('selectAllCheckbox'), selectedCount = document.getElementById('selectedCount'), serviceSelectedBtn = document.getElementById('serviceSelectedBtn'), viewServiceHistoryBtn = document.getElementById('viewServiceHistoryBtn');
    const totalCount = document.getElementById('totalCount'), goodCount = document.getElementById('goodCount'), expiringCount = document.getElementById('expiringCount'), expiredCount = document.getElementById('expiredCount');
    // modal elements
    const passwordModal = document.getElementById('passwordModal'), closePasswordModal = document.getElementById('closePasswordModal'), cancelPassword = document.getElementById('cancelPassword'), passwordInput = document.getElementById('passwordInput'), submitPassword = document.getElementById('submitPassword');
    const historyModal = document.getElementById('historyModal'), closeHistoryModal = document.getElementById('closeHistoryModal'), serviceHistoryList = document.getElementById('serviceHistoryList'), historyModalTitle = document.getElementById('historyModalTitle'), historyTabs = document.querySelectorAll('.history-tab'), individualHistory = document.getElementById('individualHistory'), bulkHistory = document.getElementById('bulkHistory'), bulkServiceContent = document.getElementById('bulkServiceContent');
    const serviceModal = document.getElementById('serviceModal'), closeServiceModal = document.getElementById('closeServiceModal'), cancelService = document.getElementById('cancelService'), confirmService = document.getElementById('confirmService'), serviceSelectedCount = document.getElementById('serviceSelectedCount'), serviceDate = document.getElementById('serviceDate'), nextServiceDate = document.getElementById('nextServiceDate'), newExpirationDate = document.getElementById('newExpirationDate');
    const toggleFormBtn = document.getElementById('toggleFormBtn'), toggleFormIcon = document.getElementById('toggleFormIcon'), addForm = document.getElementById('addForm');

    // --- FILTER elements ---
    const locationFilter = document.getElementById('locationFilter');
    const clearFilterBtn = document.getElementById('clearFilterBtn');
    const filterHint = document.getElementById('filterHint');

    // --- state ---
    let currentAction = null, currentExtinguisherId = null, selectedExtinguishers = new Set(), extinguishersData = [];
    let activeLocationFilter = 'all'; // 'all' or specific location string

    // set default dates
    const today = new Date(); const nextYear = new Date(); nextYear.setFullYear(nextYear.getFullYear()+1);
    const nextMonth = new Date(); nextMonth.setMonth(nextMonth.getMonth()+1);
    expirationInput.valueAsDate = nextYear; serviceInput.valueAsDate = today; serviceDate.valueAsDate = today; nextServiceDate.valueAsDate = nextMonth; newExpirationDate.valueAsDate = nextYear; capacityInput.value = '4';

    // --- sidebar / mobile (identical) ---
    if (localStorage.getItem('sidebarCollapsed')==='true') { sidebar.classList.add('collapsed'); mainContent.classList.add('expanded'); toggleIcon.classList.replace('fa-chevron-left','fa-chevron-right'); }
    sidebarToggle.addEventListener('click',()=>{ sidebar.classList.toggle('collapsed'); mainContent.classList.toggle('expanded'); if(sidebar.classList.contains('collapsed')){ toggleIcon.classList.replace('fa-chevron-left','fa-chevron-right'); localStorage.setItem('sidebarCollapsed','true'); } else { toggleIcon.classList.replace('fa-chevron-right','fa-chevron-left'); localStorage.setItem('sidebarCollapsed','false'); } });
    mobileToggle.addEventListener('click',()=> sidebar.classList.toggle('active'));
    document.addEventListener('click',(e)=>{ if(window.innerWidth<=768 && !sidebar.contains(e.target) && !mobileToggle.contains(e.target) && sidebar.classList.contains('active')) sidebar.classList.remove('active'); });

    // form toggle hidden by default
    addForm.classList.add('hidden'); toggleFormIcon.classList.add('fa-eye'); toggleFormBtn.innerHTML = '<i class="fas fa-eye" id="toggleFormIcon"></i> Show Form';
    toggleFormBtn.addEventListener('click', ()=>{ addForm.classList.toggle('hidden'); addForm.classList.contains('hidden') ? toggleFormBtn.innerHTML = '<i class="fas fa-eye" id="toggleFormIcon"></i> Show Form' : toggleFormBtn.innerHTML = '<i class="fas fa-eye-slash" id="toggleFormIcon"></i> Hide Form'; });

    // --- filter update function ---
    function renderFilteredTable() {
      let filtered = extinguishersData;
      if (activeLocationFilter !== 'all') {
        filtered = extinguishersData.filter(ext => ext.location === activeLocationFilter);
      }
      // update hint
      filterHint.innerText = activeLocationFilter === 'all' ? `showing all ${extinguishersData.length} locations` : `filtered by "${activeLocationFilter}" (${filtered.length} items)`;
      
      // render table with filtered data (but keep extinguishersData global for stats unchanged)
      renderTable(filtered);
    }

    // update location dropdown options from current data
    function refreshLocationFilterOptions() {
      const uniqueLocs = [...new Set(extinguishersData.map(e => e.location).filter(Boolean))].sort();
      const currentValue = locationFilter.value;
      locationFilter.innerHTML = '<option value="all">All locations</option>';
      uniqueLocs.forEach(loc => {
        const option = document.createElement('option');
        option.value = loc;
        option.textContent = loc;
        if (loc === activeLocationFilter) option.selected = true;
        locationFilter.appendChild(option);
      });
      if (!uniqueLocs.includes(activeLocationFilter) && activeLocationFilter !== 'all') {
        activeLocationFilter = 'all'; // reset if location no longer exists
      }
      locationFilter.value = activeLocationFilter;
    }

    // event listener for filter change
    locationFilter.addEventListener('change', (e) => {
      activeLocationFilter = e.target.value;
      renderFilteredTable();
    });

    clearFilterBtn.addEventListener('click', () => {
      activeLocationFilter = 'all';
      locationFilter.value = 'all';
      renderFilteredTable();
    });

    // --- MODALS (unchanged) ---
    function showPasswordModal(action,id){ currentAction=action; currentExtinguisherId=id; passwordInput.value=''; passwordModal.classList.add('active'); }
    function hidePasswordModal(){ passwordModal.classList.remove('active'); currentAction=null; currentExtinguisherId=null; }
    function showServiceModal(){ if(selectedExtinguishers.size===0) return; serviceSelectedCount.textContent=selectedExtinguishers.size; serviceModal.classList.add('active'); }
    function hideServiceModal(){ serviceModal.classList.remove('active'); }
    function showHistoryModal(){ historyModal.classList.add('active'); loadIndividualHistory(null); loadBulkHistory(); }
    function showIndividualHistory(id){ historyModal.classList.add('active'); historyTabs.forEach(t=>t.classList.toggle('active', t.dataset.tab==='individual')); individualHistory.classList.add('active'); bulkHistory.classList.remove('active'); const ext = extinguishersData.find(e=>e.id===id); loadIndividualHistory(ext); }
    function loadIndividualHistory(ext){ if(!ext){ serviceHistoryList.innerHTML='<li class="service-history-item"><span>Select extinguisher from menu</span></li>'; historyModalTitle.textContent='Service History'; return; } historyModalTitle.textContent=`History – ${ext.code||ext.location}`; const hist=ext.serviceHistory||[]; if(hist.length===0) serviceHistoryList.innerHTML='<li class="service-history-item"><span>No history</span></li>'; else serviceHistoryList.innerHTML=hist.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(e=>`<li class="service-history-item"><div><span class="service-date">${formatDate(e.date)}</span><div style="display:flex;gap:0.5rem;">${e.nextServiceDate?`<span class="next-service-badge">Next:${formatDate(e.nextServiceDate)}</span>`:''}${e.newExpirationDate?`<span class="expiration-badge">Exp:${formatDate(e.newExpirationDate)}</span>`:''}</div></div><span class="service-count">#${e.serviceNumber}</span></li>`).join(''); }
    function loadBulkHistory(){ const all=[]; extinguishersData.forEach(ext=>(ext.serviceHistory||[]).forEach(e=>all.push({...e,code:ext.code,loc:ext.location,type:ext.type}))); const grouped={}; all.forEach(s=>{ const d=s.date; if(!grouped[d]) grouped[d]=[]; grouped[d].push(s); }); const sorted=Object.keys(grouped).sort((a,b)=>new Date(b)-new Date(a)); if(sorted.length===0) bulkServiceContent.innerHTML='<div class="empty-state"><i class="fas fa-calendar"></i>No history</div>'; else bulkServiceContent.innerHTML=sorted.map(date=>`<div class="bulk-service-group"><div class="bulk-service-date"><i class="fas fa-calendar"></i> ${formatDate(date)}<span class="service-count">${grouped[date].length}</span></div><ul class="bulk-service-list">${grouped[date].map(s=>`<li class="bulk-service-item"><span class="bulk-service-code">${s.code||'N/A'}</span><span class="bulk-service-location">${s.loc}</span><span class="bulk-service-type">${s.type||''}</span><span class="service-info-badge">#${s.serviceNumber}</span>${s.nextServiceDate?`<span class="next-service-badge">Next:${formatDate(s.nextServiceDate)}</span>`:''}${s.newExpirationDate?`<span class="expiration-badge">Exp:${formatDate(s.newExpirationDate)}</span>`:''}</li>`).join('')}</ul></div>`).join(''); }

    historyTabs.forEach(t=>t.addEventListener('click',()=>{ historyTabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); if(t.dataset.tab==='individual'){ individualHistory.classList.add('active'); bulkHistory.classList.remove('active'); } else { individualHistory.classList.remove('active'); bulkHistory.classList.add('active'); loadBulkHistory(); } }));
    closePasswordModal.addEventListener('click',hidePasswordModal); cancelPassword.addEventListener('click',hidePasswordModal); closeHistoryModal.addEventListener('click',()=>historyModal.classList.remove('active')); closeServiceModal.addEventListener('click',hideServiceModal); cancelService.addEventListener('click',hideServiceModal);
    window.addEventListener('click',(e)=>{ if(e.target===passwordModal)hidePasswordModal(); if(e.target===historyModal)historyModal.classList.remove('active'); if(e.target===serviceModal)hideServiceModal(); });
    
    submitPassword.addEventListener('click',async()=>{ if(passwordInput.value==='1030'){ hidePasswordModal(); if(currentAction==='delete'&&currentExtinguisherId){ if(confirm('Delete?')) await deleteDoc(doc(db,"fireExtinguishers",currentExtinguisherId)); } else if(currentAction==='edit'&&currentExtinguisherId){ const ext=extinguishersData.find(e=>e.id===currentExtinguisherId); if(ext){ codeInput.value=ext.code||''; locationInput.value=ext.location; typeInput.value=ext.type||'DCP'; capacityInput.value=ext.capacity||'4'; expirationInput.value=ext.expiration; serviceInput.value=ext.lastService; addForm.scrollIntoView({behavior:'smooth'}); if(addForm.classList.contains('hidden')) toggleFormBtn.click(); addBtn.innerHTML='<i class="fas fa-save"></i> Update'; const newBtn=addBtn.cloneNode(true); addBtn.replaceWith(newBtn); document.getElementById('addBtn').addEventListener('click',async()=>{ if(!codeInput.value.trim()||!locationInput.value.trim()) return alert('fill fields'); await updateDoc(doc(db,"fireExtinguishers",currentExtinguisherId),{code:codeInput.value.trim(),location:locationInput.value.trim(),type:typeInput.value,capacity:capacityInput.value,expiration:expirationInput.value,lastService:serviceInput.value,updatedAt:serverTimestamp()}); codeInput.value=''; locationInput.value=''; typeInput.value='DCP'; capacityInput.value='4'; expirationInput.valueAsDate=nextYear; serviceInput.valueAsDate=new Date(); newBtn.innerHTML='<i class="fas fa-plus"></i> Add Extinguisher'; }); } } } else { alert('Incorrect'); passwordInput.value=''; } });

    confirmService.addEventListener('click',async()=>{ if(selectedExtinguishers.size===0){ hideServiceModal(); return; } const sDate=serviceDate.value, nxt=nextServiceDate.value, newExp=newExpirationDate.value; if(!nxt||!newExp){ alert('select dates'); return; } for(const id of selectedExtinguishers){ const ext=extinguishersData.find(e=>e.id===id); const cnt=(ext.serviceCount||0)+1; await updateDoc(doc(db,"fireExtinguishers",id),{lastService:sDate,nextServiceDate:nxt,expiration:newExp,serviceCount:cnt,serviceHistory:arrayUnion({date:sDate,serviceNumber:cnt,nextServiceDate:nxt,newExpirationDate:newExp,timestamp:new Date().toISOString()}),updatedAt:serverTimestamp()}); } selectedExtinguishers.clear(); selectAllCheckbox.checked=false; updateSelectedCount(); hideServiceModal(); alert('Serviced'); });

    viewServiceHistoryBtn.addEventListener('click',showHistoryModal);

    // helpers
    function calculateDaysLeft(d){ const t=new Date(); t.setHours(0,0,0,0); const e=new Date(d); e.setHours(0,0,0,0); return Math.ceil((e-t)/(1000*60*60*24)); }
    function getStatusInfo(d){ if(d<0) return {class:'badge-danger',text:'Expired',icon:'fa-times-circle'}; else if(d<=30) return {class:'badge-warning',text:'Expiring Soon',icon:'fa-exclamation-triangle'}; else return {class:'badge-success',text:'Good',icon:'fa-check-circle'}; }
    function formatDate(d){ return new Date(d).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }
    function updateStats(exts){ let g=0,e30=0,ex=0; exts.forEach(ext=>{ const d=calculateDaysLeft(ext.expiration); if(d<0) ex++; else if(d<=30) e30++; else g++; }); totalCount.textContent=exts.length; goodCount.textContent=g; expiringCount.textContent=e30; expiredCount.textContent=ex; }
    function updateSelectedCount(){ const sz=selectedExtinguishers.size; selectedCount.textContent=sz+' selected'; serviceSelectedBtn.disabled=sz===0; }
    selectAllCheckbox.addEventListener('change',(e)=>{ if(e.target.checked) extinguishersData.forEach(ext=>selectedExtinguishers.add(ext.id)); else selectedExtinguishers.clear(); updateSelectedCount(); renderFilteredTable(); });
    serviceSelectedBtn.addEventListener('click',showServiceModal);

    function renderTable(extinguishersToRender){
      if(!extinguishersToRender.length) { tableBody.innerHTML='<tr><td colspan="11" class="empty-state"><i class="fas fa-fire-extinguisher"></i>No extinguishers</td></tr>'; return; }
      const sorted=[...extinguishersToRender].sort((a,b)=>calculateDaysLeft(a.expiration)-calculateDaysLeft(b.expiration));
      let html='';
      sorted.forEach(ext=>{
        const dl=calculateDaysLeft(ext.expiration); const st=getStatusInfo(dl); const rc=dl<0?'expired-row':''; const chk=selectedExtinguishers.has(ext.id); const next=ext.nextServiceDate?formatDate(ext.nextServiceDate):'Not set';
        html+=`<tr class="${rc}"><td class="checkbox-cell"><input type="checkbox" class="ext-checkbox" data-id="${ext.id}" ${chk?'checked':''}></td><td><span class="code-badge">${ext.code||'N/A'}</span></td><td><div class="location-cell"><div class="location-icon"><i class="fas fa-fire-extinguisher"></i></div>${ext.location}</div></td><td><span class="type-badge">${ext.type||'DCP'}</span></td><td>${ext.capacity||'4'} kg</td><td>${formatDate(ext.expiration)}</td><td>${formatDate(ext.lastService)}</td><td><span class="next-service-badge">${next}</span></td><td><span class="badge ${st.class}"><i class="fas ${st.icon}"></i> ${st.text}</span></td><td><span class="service-count">${ext.serviceCount||0}</span></td><td><div class="menu-container"><button class="menu-button" onclick="toggleMenu('${ext.id}')"><i class="fas fa-ellipsis-vertical"></i></button><div class="dropdown-menu" id="menu-${ext.id}"><button class="dropdown-item view-history" data-id="${ext.id}"><i class="fas fa-history"></i> History</button><button class="dropdown-item edit-item" data-id="${ext.id}"><i class="fas fa-edit"></i> Edit</button><button class="dropdown-item delete-item" data-id="${ext.id}"><i class="fas fa-trash"></i> Delete</button></div></div></td></tr>`;
      });
      tableBody.innerHTML=html;
      // attach checkbox events
      document.querySelectorAll('.ext-checkbox').forEach(cb=>cb.addEventListener('change',(e)=>{ const id=e.target.dataset.id; e.target.checked?selectedExtinguishers.add(id):selectedExtinguishers.delete(id); selectAllCheckbox.checked=selectedExtinguishers.size===extinguishersData.length&&extinguishersData.length>0; updateSelectedCount(); }));
      document.querySelectorAll('.view-history').forEach(btn=>btn.addEventListener('click',(e)=>{ showIndividualHistory(e.currentTarget.dataset.id); closeAllMenus(); }));
      document.querySelectorAll('.edit-item').forEach(btn=>btn.addEventListener('click',(e)=>{ showPasswordModal('edit',e.currentTarget.dataset.id); closeAllMenus(); }));
      document.querySelectorAll('.delete-item').forEach(btn=>btn.addEventListener('click',(e)=>{ showPasswordModal('delete',e.currentTarget.dataset.id); closeAllMenus(); }));
    }
    window.toggleMenu = function(id){ closeAllMenus(); document.getElementById(`menu-${id}`)?.classList.add('active'); };
    function closeAllMenus(){ document.querySelectorAll('.dropdown-menu').forEach(m=>m.classList.remove('active')); }
    document.addEventListener('click',(e)=>{ if(!e.target.closest('.menu-container')) closeAllMenus(); });

    // Firestore realtime
    const q = query(collection(db,"fireExtinguishers"), orderBy("createdAt","desc"));
    onSnapshot(q, (snapshot)=>{
      const exts = snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
      extinguishersData = exts;
      // update stats always from full dataset
      updateStats(exts);
      // refresh dropdown options
      refreshLocationFilterOptions();
      // apply active filter
      renderFilteredTable();
    }, (err)=>{ console.error(err); tableBody.innerHTML='<tr><td colspan="11" class="empty-state"><i class="fas fa-exclamation-triangle"></i>Error loading</td></tr>'; });

    // Add new extinguisher
    addBtn.addEventListener('click', async()=>{
      const code=codeInput.value.trim(), loc=locationInput.value.trim(), type=typeInput.value, cap=capacityInput.value, exp=expirationInput.value, last=serviceInput.value;
      if(!code||!loc||!type||!cap||!exp||!last) return alert('Fill all');
      await addDoc(collection(db,"fireExtinguishers"),{code,location:loc,type,capacity:cap,expiration:exp,lastService:last,serviceCount:0,serviceHistory:[],createdAt:serverTimestamp(),updatedAt:serverTimestamp()});
      codeInput.value=''; locationInput.value=''; typeInput.value='DCP'; capacityInput.value='4'; expirationInput.valueAsDate=nextYear; serviceInput.valueAsDate=new Date();
    });

    // enter key
    [codeInput,locationInput,typeInput,capacityInput,expirationInput,serviceInput].forEach(i=>i.addEventListener('keypress',e=>{ if(e.key==='Enter'){ e.preventDefault(); addBtn.click(); } }));
  </script>
</body>
</html>
