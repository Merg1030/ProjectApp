<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Penta Construction Â· Cash Flow</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    .container { margin: 0 auto; padding: 20px; }
    .header {
      background: white; padding: 20px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;
    }
    .company-name h1 { color: #1976d2; font-size: 24px; margin-bottom: 5px; }
    .company-name p { color: #666; font-size: 14px; }
    .header-controls { display: flex; gap: 10px; align-items: center; }
    .search-container {
      display: flex; align-items: center; background: white; border-radius: 4px;
      padding: 8px 12px; border: 1px solid #ddd; min-width: 300px;
    }
    .search-container i { color: #666; margin-right: 8px; }
    .search-container input { border: none; outline: none; width: 100%; font-size: 14px; background: transparent; }
    .btn {
      padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;
      font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s;
    }
    .btn-primary { background: #1976d2; color: white; }
    .btn-primary:hover { background: #1565c0; }
    .btn-secondary { background: #4CAF50; color: white; }
    .btn-secondary:hover { background: #388E3C; }
    .btn-download { background: #a5a5a5; color: white; }
    .btn-download:hover { background: #666467; }
    .filters {
      background: white; padding: 15px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;
      display: flex; gap: 20px; flex-wrap: wrap; align-items: center;
    }
    .filter-group { display: flex; align-items: center; gap: 10px; }
    .filter-group label { font-weight: 600; font-size: 14px; min-width: 60px; }
    select {
      padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;
      background: white; font-size: 14px; min-width: 150px;
    }
    .form-container {
      background: white; padding: 20px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    .form-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #1976d2;
    }
    .form-header h2 { color: #1976d2; font-size: 18px; }
    .close-btn {
      background: #f44336; color: white; border: none; width: 30px; height: 30px;
      border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .form-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
    .form-group { flex: 1; min-width: 200px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; color: #555; }
    .form-group input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .form-group input:focus { outline: none; border-color: #1976d2; }
    .form-actions {
      display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;
    }
    .btn-submit { background: #9f9f9f; color: white; }
    .btn-reset { background: #9e9e9e; color: white; }
    .hide { display: none; }
    .table-container {
      background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden; height: 600px; display: flex; flex-direction: column;
    }
    .table-responsive { overflow-y: auto; overflow-x: auto; flex: 1; }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    thead { background: #4c4c4c; position: sticky; top: 0; z-index: 10; }
    th {
      color: rgb(0,0,0); text-align: left; padding: 15px; font-weight: 600; font-size: 14px;
      position: sticky; top: 0; background: #e5e5e5; z-index: 11;
    }
    tbody tr { border-bottom: 1px solid #eee; transition: background 0.3s; }
    tbody tr:hover { background: #f9f9f9; }
    tbody tr:nth-child(even) { background: #fafafa; }
    tbody tr:nth-child(even):hover { background: #f5f5f5; }
    td { padding: 12px 15px; font-size: 14px; }
    .text-right { text-align: right; font-family: monospace; font-weight: 500; }
    .debit { color: #d32f2f; font-weight: 600; }
    .credit { color: #388E3C; font-weight: 600; }
    .balance { color: #1976d2; font-weight: 600; }
    tfoot {
      background: #f8f9fa; position: sticky; bottom: 0; z-index: 10;
    }
    tfoot td {
      font-weight: 600; padding: 15px; border-top: 2px solid #1976d2;
      background: #f8f9fa; position: sticky; bottom: 0;
    }
    .empty-state { text-align: center; padding: 50px; color: #666; }
    .empty-state i { font-size: 48px; color: #ddd; margin-bottom: 20px; }
    .loading { text-align: center; padding: 40px; color: #666; }
    .action-menu-container { position: relative; width: 40px; text-align: center; }
    .three-dots-btn {
      background: none; border: none; cursor: pointer; font-size: 18px;
      color: #666; padding: 5px 10px; border-radius: 4px; transition: all 0.3s;
    }
    .three-dots-btn:hover { background-color: #f0f0f0; color: #1976d2; }
    .action-menu {
      position: absolute; top: 100%; right: 0; background: white; border-radius: 6px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.15); min-width: 160px; z-index: 1000; overflow: hidden; display: none;
    }
    .action-menu.show { display: block; }
    .action-menu-item {
      display: flex; align-items: center; gap: 10px; padding: 12px 15px;
      text-decoration: none; color: #333; font-size: 14px; border-bottom: 1px solid #f0f0f0;
      cursor: pointer; transition: all 0.2s; background: white; border: none; width: 100%; text-align: left;
    }
    .action-menu-item:hover { background-color: #f5f5f5; }
    .action-menu-item:last-child { border-bottom: none; }
    .action-menu-item i { width: 20px; text-align: center; }
    .reverse { color: #1976d2; }
    .edit { color: #4CAF50; }
    .delete { color: #f44336; }
    @media (max-width: 768px) {
      .header { flex-direction: column; text-align: center; }
      .header-controls { flex-direction: column; width: 100%; }
      .search-container { min-width: 100%; }
      .filters { flex-direction: column; }
      .filter-group { flex-direction: column; align-items: flex-start; }
      select { width: 100%; }
      .form-row { flex-direction: column; }
      .form-group { width: 100%; }
      .action-menu { position: fixed; top: auto; right: 10px; left: 10px; bottom: 10px; min-width: auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="company-name">
        <h1>Penta Construction Cash Flow</h1>
      </div>
      <div class="header-controls">
        <div class="search-container">
          <i class="fa fa-search"></i>
          <input type="text" id="search-bar" placeholder="Search transactions...">
        </div>
        <a href="Accountsdashboart.html" class="btn btn-secondary">
          <i class="fa fa-book"></i> Journal
        </a>
        <button id="download-pdf-btn" class="btn btn-download">
          <i class="fa fa-download"></i> Download PDF
        </button>
        <button id="show-form-btn" class="btn btn-primary">
          <i class="fa fa-plus"></i> New Transaction
        </button>
      </div>
    </header>

    <!-- FILTERS â€“ WITH PERSISTENT STORAGE (remembers week/month until you change them) -->
    <div class="filters">
      <div class="filter-group">
        <label>Period:</label>
        <select id="period-filter">
          <option value="all">All Time</option>
          <option value="today">Today</option>
          <option value="week">This Week</option>
          <option value="week-number">By Week Number</option>
          <option value="month">This Month</option>
          <option value="specific-month">By Month</option>
          <option value="quarter">This Quarter</option>
          <option value="year">This Year</option>
        </select>
      </div>

      <!-- Week Number Filter (hidden unless week-number selected) -->
      <div class="filter-group" id="week-number-filter" style="display: none;">
        <label>Week:</label>
        <select id="week-select"></select>
      </div>

      <!-- Month Filter (hidden unless specific-month selected) -->
      <div class="filter-group" id="month-filter" style="display: none;">
        <label>Month:</label>
        <select id="month-select">
          <option value="1">January</option><option value="2">February</option><option value="3">March</option>
          <option value="4">April</option><option value="5">May</option><option value="6">June</option>
          <option value="7">July</option><option value="8">August</option><option value="9">September</option>
          <option value="10">October</option><option value="11">November</option><option value="12">December</option>
        </select>
      </div>
      <div class="filter-group" id="month-year-filter" style="display: none;">
        <label>Year:</label>
        <select id="month-year-select"></select>
      </div>

      <div class="filter-group">
        <label>Type:</label>
        <select id="type-filter">
          <option value="all">All Transactions</option>
          <option value="debit">Debits Only</option>
          <option value="credit">Credits Only</option>
        </select>
      </div>
    </div>

    <!-- Add/Edit Form -->
    <div class="form-container hide" id="form-section">
      <div class="form-header">
        <h2><i class="fa fa-plus-circle"></i> Add New Transaction</h2>
        <button class="close-btn" id="close-form-btn"><i class="fa fa-times"></i></button>
      </div>
      <form id="cashflow-form">
        <div class="form-row">
          <div class="form-group"><label for="tx-date">Date</label><input type="date" id="tx-date" required></div>
          <div class="form-group"><label for="tx-desc">Description</label><input type="text" id="tx-desc" placeholder="Enter description" required></div>
          <div class="form-group"><label for="tx-supplier">Supplier / Category</label><input type="text" id="tx-supplier" placeholder="Supplier or category"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label for="tx-debit">Debit Amount</label><input type="number" id="tx-debit" step="0.01" min="0" value="0" placeholder="0.00"></div>
          <div class="form-group"><label for="tx-credit">Credit Amount</label><input type="number" id="tx-credit" step="0.01" min="0" value="0" placeholder="0.00"></div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-reset" id="reset-form"><i class="fa fa-refresh"></i> Reset</button>
          <button type="submit" class="btn btn-submit"><i class="fa fa-check"></i> Add Transaction</button>
        </div>
      </form>
    </div>

    <!-- Transactions Table -->
    <div class="table-container">
      <div class="table-responsive">
        <table>
          <thead><tr><th style="width:120px">Date</th><th>Description</th><th style="width:180px">Supplier / Category</th><th style="width:120px">Debit</th><th style="width:120px">Credit</th><th style="width:140px">Balance</th><th style="width:80px">Actions</th></tr></thead>
          <tbody id="cashflow-body"><tr><td colspan="7" class="loading"><i class="fa fa-spinner fa-spin"></i> Loading transactions...</td></tr></tbody>
          <tfoot><tr><td colspan="3" style="text-align:right; font-weight:600;">TOTALS:</td><td class="text-right" id="total-debit">0.00</td><td class="text-right" id="total-credit">0.00</td><td class="text-right" id="ending-balance">0.00</td><td></td></tr></tfoot>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    // -------------------- ðŸ”¥ PERSISTENT FILTERS (week/month stored, only change when user picks new) ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, Timestamp,
      query, orderBy, serverTimestamp, deleteDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
      authDomain: "project-task-588c4.firebaseapp.com",
      projectId: "project-task-588c4",
      storageBucket: "project-task-588c4.appspot.com",
      messagingSenderId: "411882772509",
      appId: "1:411882772509:web:08d613186c101a99f38ef4",
      measurementId: "G-JMFLFYEM0F"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COLLECTION = "cashflow";

    // ---------- DOM refs ----------
    const showFormBtn = document.getElementById("show-form-btn");
    const closeFormBtn = document.getElementById("close-form-btn");
    const formSection = document.getElementById("form-section");
    const cashflowForm = document.getElementById("cashflow-form");
    const txDate = document.getElementById("tx-date");
    const txDesc = document.getElementById("tx-desc");
    const txSupplier = document.getElementById("tx-supplier");
    const txDebit = document.getElementById("tx-debit");
    const txCredit = document.getElementById("tx-credit");
    const resetFormBtn = document.getElementById("reset-form");
    const cashflowBody = document.getElementById("cashflow-body");
    const totalDebitEl = document.getElementById("total-debit");
    const totalCreditEl = document.getElementById("total-credit");
    const endingBalanceEl = document.getElementById("ending-balance");
    const periodFilter = document.getElementById("period-filter");
    const typeFilter = document.getElementById("type-filter");
    const searchBar = document.getElementById("search-bar");
    const weekNumberFilterDiv = document.getElementById("week-number-filter");
    const weekSelect = document.getElementById("week-select");
    const monthFilterDiv = document.getElementById("month-filter");
    const monthSelect = document.getElementById("month-select");
    const monthYearFilterDiv = document.getElementById("month-year-filter");
    const monthYearSelect = document.getElementById("month-year-select");
    const downloadPdfBtn = document.getElementById("download-pdf-btn");

    // ---------- STORAGE KEYS â€“ persist filters like a boss ----------
    const STORAGE_PERIOD = 'penta_cashflow_period';
    const STORAGE_WEEK = 'penta_cashflow_week';        // e.g. "2025-14"
    const STORAGE_MONTH = 'penta_cashflow_month';      // e.g. "3"
    const STORAGE_MONTH_YEAR = 'penta_cashflow_month_year'; // e.g. "2025"
    const STORAGE_TYPE = 'penta_cashflow_type';

    // ---------- global state ----------
    let allTransactions = [];
    let filteredTransactions = [];
    let searchTerm = '';
    let activeMenu = null;

    // ---------- helper functions ----------
    function closeAllMenus() { if (activeMenu) { activeMenu.classList.remove('show'); activeMenu = null; } }
    document.addEventListener('click', (e) => { if (!e.target.closest('.action-menu-container')) closeAllMenus(); });

    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
    }
    function getWeekRange(year, weekNumber) {
      const firstDayOfYear = new Date(year, 0, 1);
      const days = 2 + (weekNumber - 1) * 7 - firstDayOfYear.getDay();
      const start = new Date(year, 0, days); start.setHours(0,0,0,0);
      const end = new Date(year, 0, days + 6); end.setHours(23,59,59,999);
      return { start, end };
    }
    function getMonthRange(year, month) {
      const start = new Date(year, month - 1, 1); start.setHours(0,0,0,0);
      const end = new Date(year, month, 0); end.setHours(23,59,59,999);
      return { start, end };
    }

    // --- populate dropdowns based on actual transactions + keep stored values ---
    function populateWeekSelect() {
      weekSelect.innerHTML = '';
      const years = [...new Set(allTransactions.map(tx => tx.date.getFullYear()))].sort((a,b)=>b-a);
      if (years.length === 0) {
        const currentYear = new Date().getFullYear();
        for (let i=1; i<=52; i++) {
          const opt = document.createElement('option');
          opt.value = `${currentYear}-${i}`;
          opt.textContent = `${currentYear} - Week ${i}`;
          weekSelect.appendChild(opt);
        }
      } else {
        years.forEach(year => {
          for (let week=1; week<=52; week++) {
            const opt = document.createElement('option');
            opt.value = `${year}-${week}`;
            opt.textContent = `${year} - Week ${week}`;
            weekSelect.appendChild(opt);
          }
        });
      }
      // RESTORE stored week â€” this keeps user's selection until they manually change it
      const savedWeek = localStorage.getItem(STORAGE_WEEK);
      if (savedWeek && [...weekSelect.options].some(opt => opt.value === savedWeek)) {
        weekSelect.value = savedWeek;
      } else {
        const currentWeek = getWeekNumber(new Date());
        const currentYear = new Date().getFullYear();
        weekSelect.value = `${currentYear}-${currentWeek}`;
      }
    }

    function populateYearSelect() {
      monthYearSelect.innerHTML = '';
      const years = [...new Set(allTransactions.map(tx => tx.date.getFullYear()))].sort((a,b)=>b-a);
      if (years.length === 0) {
        const currentYear = new Date().getFullYear();
        const opt = document.createElement('option');
        opt.value = currentYear; opt.textContent = currentYear;
        monthYearSelect.appendChild(opt);
      } else {
        years.forEach(year => {
          const opt = document.createElement('option');
          opt.value = year; opt.textContent = year;
          monthYearSelect.appendChild(opt);
        });
      }
      // RESTORE stored month/year
      const savedMonthYear = localStorage.getItem(STORAGE_MONTH_YEAR);
      if (savedMonthYear && [...monthYearSelect.options].some(opt => opt.value === savedMonthYear)) {
        monthYearSelect.value = savedMonthYear;
      } else {
        monthYearSelect.value = new Date().getFullYear();
      }
    }

    // --- RESTORE filter states from localStorage (persist until user changes) ---
    function restoreFiltersFromStorage() {
      const savedPeriod = localStorage.getItem(STORAGE_PERIOD);
      if (savedPeriod) periodFilter.value = savedPeriod;
      else periodFilter.value = 'month';  // default as per original

      const savedType = localStorage.getItem(STORAGE_TYPE);
      if (savedType) typeFilter.value = savedType;

      // show/hide based on restored period
      const val = periodFilter.value;
      if (val === 'week-number') {
        weekNumberFilterDiv.style.display = 'flex';
        monthFilterDiv.style.display = 'none';
        monthYearFilterDiv.style.display = 'none';
        // weekSelect will be populated later with saved value
      } else if (val === 'specific-month') {
        weekNumberFilterDiv.style.display = 'none';
        monthFilterDiv.style.display = 'flex';
        monthYearFilterDiv.style.display = 'flex';
        // restore month + year
        const savedMonth = localStorage.getItem(STORAGE_MONTH);
        if (savedMonth) monthSelect.value = savedMonth;
        // year restored inside populateYearSelect later
      } else {
        weekNumberFilterDiv.style.display = 'none';
        monthFilterDiv.style.display = 'none';
        monthYearFilterDiv.style.display = 'none';
      }
    }

    // --- STORE current filter choices to localStorage ---
    function storeFilters() {
      localStorage.setItem(STORAGE_PERIOD, periodFilter.value);
      localStorage.setItem(STORAGE_TYPE, typeFilter.value);
      
      if (periodFilter.value === 'week-number') {
        if (weekSelect.value) localStorage.setItem(STORAGE_WEEK, weekSelect.value);
      } else if (periodFilter.value === 'specific-month') {
        localStorage.setItem(STORAGE_MONTH, monthSelect.value);
        localStorage.setItem(STORAGE_MONTH_YEAR, monthYearSelect.value);
      }
    }

    // --- get date range based on period + stored week/month (always consistent) ---
    function getDateRange(period) {
      const now = new Date();
      if (period === 'today') {
        const start = new Date(); start.setHours(0,0,0,0);
        const end = new Date(); end.setHours(23,59,59,999);
        return { start, end };
      }
      if (period === 'week') {
        const start = new Date(now); const day = now.getDay(); const diff = now.getDate() - day + (day===0?-6:1);
        start.setDate(diff); start.setHours(0,0,0,0);
        const end = new Date(start); end.setDate(diff+6); end.setHours(23,59,59,999);
        return { start, end };
      }
      if (period === 'week-number') {
        if (weekSelect.value) {
          const [year, week] = weekSelect.value.split('-').map(Number);
          return getWeekRange(year, week);
        }
      }
      if (period === 'month') {
        const start = new Date(now.getFullYear(), now.getMonth(), 1); start.setHours(0,0,0,0);
        const end = new Date(now.getFullYear(), now.getMonth()+1, 0); end.setHours(23,59,59,999);
        return { start, end };
      }
      if (period === 'specific-month') {
        if (monthSelect.value && monthYearSelect.value) {
          return getMonthRange(parseInt(monthYearSelect.value), parseInt(monthSelect.value));
        }
      }
      if (period === 'quarter') {
        const quarter = Math.floor(now.getMonth() / 3);
        const start = new Date(now.getFullYear(), quarter*3, 1); start.setHours(0,0,0,0);
        const end = new Date(now.getFullYear(), quarter*3+3, 0); end.setHours(23,59,59,999);
        return { start, end };
      }
      if (period === 'year') {
        const start = new Date(now.getFullYear(), 0, 1); start.setHours(0,0,0,0);
        const end = new Date(now.getFullYear(), 11, 31); end.setHours(23,59,59,999);
        return { start, end };
      }
      return { start: null, end: null };
    }

    // --- filter transactions using stored state & search ---
    function filterTransactions() {
      const period = periodFilter.value;
      const type = typeFilter.value;

      let filtered = [...allTransactions];
      if (searchTerm) {
        filtered = filtered.filter(tx => 
          tx.description.toLowerCase().includes(searchTerm) ||
          tx.supplier.toLowerCase().includes(searchTerm) ||
          tx.date.toISOString().split('T')[0].includes(searchTerm)
        );
      }

      if (period !== 'all') {
        const { start, end } = getDateRange(period);
        if (start && end) {
          filtered = filtered.filter(tx => tx.date >= start && tx.date <= end);
        }
      }

      if (type === 'debit') filtered = filtered.filter(tx => tx.debit > 0);
      else if (type === 'credit') filtered = filtered.filter(tx => tx.credit > 0);

      filtered.sort((a,b) => a.date - b.date); // asc (oldest first)
      filteredTransactions = filtered;
      renderTransactions();
    }

    // --- render ---
    function formatMoney(amount) { return amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    function renderTransactions() {
      if (filteredTransactions.length === 0) {
        cashflowBody.innerHTML = `<tr><td colspan="7" class="empty-state"><i class="fa fa-inbox"></i><div>No transactions found</div></td></tr>`;
        totalDebitEl.textContent = "0.00"; totalCreditEl.textContent = "0.00"; endingBalanceEl.textContent = "0.00";
        return;
      }

      let totalDebit = 0, totalCredit = 0, runningBalance = 0;
      const rowsHtml = filteredTransactions.map(tx => {
        runningBalance += tx.credit - tx.debit;
        totalDebit += tx.debit;
        totalCredit += tx.credit;

        return `<tr>
          <td>${tx.date.toISOString().split('T')[0]}</td>
          <td>${escapeHtml(tx.description)}</td>
          <td>${escapeHtml(tx.supplier || '-')}</td>
          <td class="text-right">${tx.debit > 0 ? `<span class="debit">${formatMoney(tx.debit)}</span>` : ''}</td>
          <td class="text-right">${tx.credit > 0 ? `<span class="credit">${formatMoney(tx.credit)}</span>` : ''}</td>
          <td class="text-right"><span class="balance">${formatMoney(runningBalance)}</span></td>
          <td class="action-menu-container">
            <button class="three-dots-btn" data-id="${tx.id}">&#8942;</button>
            <div class="action-menu" data-menu-id="${tx.id}">
              <button class="action-menu-item reverse" data-action="reverse" data-txid="${tx.id}"><i class="fa fa-exchange"></i> Reverse</button>
              <button class="action-menu-item edit" data-action="edit" data-txid="${tx.id}"><i class="fa fa-edit"></i> Edit</button>
              <button class="action-menu-item delete" data-action="delete" data-txid="${tx.id}"><i class="fa fa-trash"></i> Delete</button>
            </div>
          </td>
        </tr>`;
      }).join('');

      cashflowBody.innerHTML = rowsHtml;
      totalDebitEl.textContent = formatMoney(totalDebit);
      totalCreditEl.textContent = formatMoney(totalCredit);
      endingBalanceEl.textContent = formatMoney(runningBalance);

      // reattach event listeners for menus (since innerHTML replaced)
      attachMenuListeners();
    }

    function escapeHtml(unsafe) {
      if (!unsafe) return unsafe;
      return unsafe.replace(/[&<>"]/g, function(m) {
        if (m === '&') return '&amp;'; if (m === '<') return '&lt;'; if (m === '>') return '&gt;'; if (m === '"') return '&quot;';
        return m;
      });
    }

    function attachMenuListeners() {
      document.querySelectorAll('.three-dots-btn').forEach(btn => {
        btn.removeEventListener('click', menuToggleHandler);
        btn.addEventListener('click', menuToggleHandler);
      });
    }
    function menuToggleHandler(e) {
      e.stopPropagation();
      const menu = this.nextElementSibling;
      if (!menu) return;
      if (activeMenu === menu) {
        menu.classList.remove('show');
        activeMenu = null;
      } else {
        closeAllMenus();
        menu.classList.add('show');
        activeMenu = menu;
      }
    }

    // --- actions (reverse, edit, delete) using delegated events ---
    document.addEventListener('click', async (e) => {
      const reverseBtn = e.target.closest('.reverse[data-action="reverse"]');
      if (reverseBtn) {
        e.preventDefault(); e.stopPropagation();
        const txId = reverseBtn.dataset.txid;
        const tx = allTransactions.find(t => t.id === txId);
        if (tx) await reverseTransaction(tx);
        closeAllMenus();
        return;
      }
      const editBtn = e.target.closest('.edit[data-action="edit"]');
      if (editBtn) {
        e.preventDefault(); e.stopPropagation();
        const txId = editBtn.dataset.txid;
        const tx = allTransactions.find(t => t.id === txId);
        if (tx) editTransaction(tx);
        closeAllMenus();
        return;
      }
      const deleteBtn = e.target.closest('.delete[data-action="delete"]');
      if (deleteBtn) {
        e.preventDefault(); e.stopPropagation();
        const txId = deleteBtn.dataset.txid;
        if (txId) await deleteTransaction(txId);
        closeAllMenus();
        return;
      }
    });

    async function reverseTransaction(tx) {
      if (!confirm('Reverse this transaction? Opposite entry will be created.')) return;
      try {
        await addDoc(collection(db, COLLECTION), {
          date: Timestamp.fromDate(new Date()),
          description: `Reversal: ${tx.description}`,
          supplier: tx.supplier,
          debit: tx.credit,
          credit: tx.debit,
          createdAt: serverTimestamp(),
          reversedFrom: tx.id
        });
        alert('Transaction reversed.');
      } catch (err) { console.error(err); alert('Error reversing'); }
    }
    async function deleteTransaction(id) {
      if (!confirm('Delete permanently? This cannot be undone.')) return;
      try { await deleteDoc(doc(db, COLLECTION, id)); alert('Deleted.'); } catch(err) { console.error(err); alert('Error'); }
    }
    function editTransaction(tx) {
      txDate.value = tx.date.toISOString().split('T')[0];
      txDesc.value = tx.description;
      txSupplier.value = tx.supplier || '';
      txDebit.value = tx.debit;
      txCredit.value = tx.credit;
      formSection.classList.remove('hide');
      formSection.querySelector('.form-header h2').innerHTML = '<i class="fa fa-edit"></i> Edit Transaction';
      cashflowForm.querySelector('.btn-submit').innerHTML = '<i class="fa fa-check"></i> Update Transaction';
      cashflowForm.dataset.editId = tx.id;
    }

    // ---------- PERSISTENCE: store filters on ANY change ----------
    periodFilter.addEventListener('change', function() {
      const val = this.value;
      if (val === 'week-number') {
        weekNumberFilterDiv.style.display = 'flex'; monthFilterDiv.style.display = 'none'; monthYearFilterDiv.style.display = 'none';
        populateWeekSelect();  // rebuild but keeps stored week
      } else if (val === 'specific-month') {
        weekNumberFilterDiv.style.display = 'none'; monthFilterDiv.style.display = 'flex'; monthYearFilterDiv.style.display = 'flex';
        populateYearSelect();  // rebuild and restore saved month/year
      } else {
        weekNumberFilterDiv.style.display = 'none'; monthFilterDiv.style.display = 'none'; monthYearFilterDiv.style.display = 'none';
      }
      storeFilters();
      filterTransactions();
    });

    weekSelect.addEventListener('change', () => { storeFilters(); filterTransactions(); });
    monthSelect.addEventListener('change', () => { storeFilters(); filterTransactions(); });
    monthYearSelect.addEventListener('change', () => { storeFilters(); filterTransactions(); });
    typeFilter.addEventListener('change', () => { storeFilters(); filterTransactions(); });
    searchBar.addEventListener('input', function(e) { searchTerm = e.target.value.toLowerCase().trim(); filterTransactions(); });

    // --- also store when user manually picks week/month (extra safety) ---
    weekSelect.addEventListener('change', storeFilters);
    monthSelect.addEventListener('change', storeFilters);
    monthYearSelect.addEventListener('change', storeFilters);

    // ---------- FORM ----------
    showFormBtn.addEventListener("click", () => { formSection.classList.remove("hide"); resetFormToAddMode(); });
    closeFormBtn.addEventListener("click", () => { formSection.classList.add("hide"); resetFormToAddMode(); });
    function resetFormToAddMode() {
      cashflowForm.reset();
      txDate.value = new Date().toISOString().split('T')[0];
      txDebit.value = "0"; txCredit.value = "0";
      formSection.querySelector('.form-header h2').innerHTML = '<i class="fa fa-plus-circle"></i> Add New Transaction';
      cashflowForm.querySelector('.btn-submit').innerHTML = '<i class="fa fa-check"></i> Add Transaction';
      delete cashflowForm.dataset.editId;
    }
    resetFormBtn.addEventListener("click", resetFormToAddMode);

    cashflowForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!txDate.value || !txDesc.value.trim()) { alert('Date & description required'); return; }
      const debit = parseFloat(txDebit.value) || 0, credit = parseFloat(txCredit.value) || 0;
      const transaction = {
        date: Timestamp.fromDate(new Date(txDate.value)),
        description: txDesc.value.trim(),
        supplier: txSupplier.value.trim(),
        debit: parseFloat(debit.toFixed(2)),
        credit: parseFloat(credit.toFixed(2)),
        createdAt: serverTimestamp()
      };
      try {
        if (cashflowForm.dataset.editId) {
          await updateDoc(doc(db, COLLECTION, cashflowForm.dataset.editId), { ...transaction, updatedAt: serverTimestamp() });
          alert('Updated!');
        } else {
          await addDoc(collection(db, COLLECTION), transaction);
          alert('Added!');
        }
        resetFormToAddMode();
        formSection.classList.add('hide');
      } catch (err) { console.error(err); alert('Error saving.'); }
    });

    // ---------- PDF ----------
    downloadPdfBtn.addEventListener('click', downloadPDF);
    function downloadPDF() {
      if (filteredTransactions.length === 0) { alert('No transactions'); return; }
      const { jsPDF } = window.jspdf; const doc = new jsPDF('landscape');
      doc.setFontSize(20); doc.setTextColor(25,118,210); doc.text('Penta Construction', 20, 20);
      doc.setFontSize(14); doc.setTextColor(0,0,0); doc.text('Cash Flow Report', 20, 30);
      const period = periodFilter.options[periodFilter.selectedIndex].text;
      const type = typeFilter.options[typeFilter.selectedIndex].text;
      doc.setFontSize(10); doc.setTextColor(100,100,100);
      doc.text(`Period: ${period} | Type: ${type} | Total: ${filteredTransactions.length}`, 20, 40);
      doc.text(`Generated: ${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}`, 20, 48);
      
      let totalDebit=0, totalCredit=0, runningBalance=0;
      const bodyData = filteredTransactions.map(tx => {
        runningBalance += tx.credit - tx.debit;
        totalDebit += tx.debit; totalCredit += tx.credit;
        return [
          tx.date.toISOString().split('T')[0], tx.description, tx.supplier||"-",
          tx.debit>0 ? formatMoney(tx.debit) : "", tx.credit>0 ? formatMoney(tx.credit) : "", formatMoney(runningBalance)
        ];
      });
      bodyData.push(['','','TOTALS:', formatMoney(totalDebit), formatMoney(totalCredit), formatMoney(runningBalance)]);
      doc.autoTable({
        head: [['Date','Description','Supplier/Category','Debit','Credit','Balance']],
        body: bodyData, startY: 60, theme: 'grid',
        headStyles: { fillColor: [131,131,131] },
        columnStyles: { 0: {cellWidth:30},1:{cellWidth:60},2:{cellWidth:40},3:{cellWidth:30,halign:'right'},4:{cellWidth:30,halign:'right'},5:{cellWidth:35,halign:'right'} }
      });
      doc.save(`Penta_CashFlow_${period.replace(/ /g,'_')}_${Date.now()}.pdf`);
    }

    // ---------- FIREBASE REAL-TIME: load data & then apply RESTORED filters ----------
    const q = query(collection(db, COLLECTION), orderBy("date", "asc"));
    onSnapshot(q, (snapshot) => {
      allTransactions = snapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          date: data.date?.toDate() || new Date(),
          description: data.description || '',
          supplier: data.supplier || '',
          debit: parseFloat(data.debit || 0),
          credit: parseFloat(data.credit || 0),
        };
      });

      // 1ï¸âƒ£ populate dropdowns with fresh data, but keep stored values
      populateWeekSelect();
      populateYearSelect();

      // 2ï¸âƒ£ restore saved filters (period, week, month, year) â€” overrides defaults
      restoreFiltersFromStorage();

      // 3ï¸âƒ£ now apply filters and render
      filterTransactions();
    }, (error) => {
      console.error("Firestore error:", error);
      cashflowBody.innerHTML = `<tr><td colspan="7" style="color:#f44336; text-align:center;"><i class="fa fa-exclamation-triangle"></i> Error loading data</td></tr>`;
    });

    // set default date for new transaction
    txDate.value = new Date().toISOString().split('T')[0];

    // Extra: save month/year selections to storage immediately after they change
    monthSelect.addEventListener('change', storeFilters);
    monthYearSelect.addEventListener('change', storeFilters);
  </script>
</body>
</html>
