<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Penta Construction | Cash Flow</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Header */
    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .company-name h1 {
      color: #1976d2;
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .company-name p {
      color: #666;
      font-size: 14px;
    }
    
    .header-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    /* Search Bar */
    .search-container {
      display: flex;
      align-items: center;
      background: white;
      border-radius: 4px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      min-width: 300px;
    }
    
    .search-container i {
      color: #666;
      margin-right: 8px;
    }
    
    .search-container input {
      border: none;
      outline: none;
      width: 100%;
      font-size: 14px;
      background: transparent;
    }
    
    .search-container input::placeholder {
      color: #999;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #1976d2;
      color: white;
    }
    
    .btn-primary:hover {
      background: #1565c0;
    }
    
    .btn-secondary {
      background: #4CAF50;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #388E3C;
    }
    
    .btn-download {
      background: #9C27B0;
      color: white;
    }
    
    .btn-download:hover {
      background: #7B1FA2;
    }
    
    /* Filters */
    .filters {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .filter-group label {
      font-weight: 600;
      font-size: 14px;
      min-width: 60px;
    }
    
    select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      font-size: 14px;
      min-width: 150px;
    }
    
    /* Form */
    .form-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #1976d2;
    }
    
    .form-header h2 {
      color: #1976d2;
      font-size: 18px;
    }
    
    .close-btn {
      background: #f44336;
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 14px;
      color: #555;
    }
    
    .form-group input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #1976d2;
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    
    .btn-submit {
      background: #4CAF50;
      color: white;
    }
    
    .btn-submit:hover {
      background: #388E3C;
    }
    
    .btn-reset {
      background: #9e9e9e;
      color: white;
    }
    
    .btn-reset:hover {
      background: #757575;
    }
    
    .hide {
      display: none;
    }
    
    /* Table */
    .table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
      height: 600px; /* Fixed height for scrolling */
      display: flex;
      flex-direction: column;
    }
    
    .table-responsive {
      overflow-y: auto;
      overflow-x: auto;
      flex: 1;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }
    
    thead {
      background: #838383;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    th {
      color: white;
      text-align: left;
      padding: 15px;
      font-weight: 600;
      font-size: 14px;
      position: sticky;
      top: 0;
      background: #838383;
      z-index: 11;
    }
    
    tbody tr {
      border-bottom: 1px solid #eee;
      transition: background 0.3s;
    }
    
    tbody tr:hover {
      background: #f9f9f9;
    }
    
    tbody tr:nth-child(even) {
      background: #fafafa;
    }
    
    tbody tr:nth-child(even):hover {
      background: #f5f5f5;
    }
    
    td {
      padding: 12px 15px;
      font-size: 14px;
    }
    
    .text-right {
      text-align: right;
      font-family: monospace;
      font-weight: 500;
    }
    
    .debit {
      color: #d32f2f;
      font-weight: 600;
    }
    
    .credit {
      color: #388E3C;
      font-weight: 600;
    }
    
    .balance {
      color: #1976d2;
      font-weight: 600;
    }
    
    tfoot {
      background: #f8f9fa;
      position: sticky;
      bottom: 0;
      z-index: 10;
    }
    
    tfoot td {
      font-weight: 600;
      padding: 15px;
      border-top: 2px solid #1976d2;
      background: #f8f9fa;
      position: sticky;
      bottom: 0;
    }
    
    .empty-state {
      text-align: center;
      padding: 50px;
      color: #666;
    }
    
    .empty-state i {
      font-size: 48px;
      color: #ddd;
      margin-bottom: 20px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    /* Action Menu Styles */
    .action-menu-container {
      position: relative;
      width: 40px;
      text-align: center;
    }
    
    .three-dots-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      color: #666;
      padding: 5px 10px;
      border-radius: 4px;
      transition: all 0.3s;
    }
    
    .three-dots-btn:hover {
      background-color: #f0f0f0;
      color: #1976d2;
    }
    
    .action-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.15);
      min-width: 160px;
      z-index: 1000;
      overflow: hidden;
      display: none;
    }
    
    .action-menu.show {
      display: block;
    }
    
    .action-menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      text-decoration: none;
      color: #333;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
      border: none;
      width: 100%;
      text-align: left;
    }
    
    .action-menu-item:hover {
      background-color: #f5f5f5;
    }
    
    .action-menu-item:last-child {
      border-bottom: none;
    }
    
    .action-menu-item i {
      width: 20px;
      text-align: center;
    }
    
    .reverse {
      color: #1976d2;
    }
    
    .edit {
      color: #4CAF50;
    }
    
    .delete {
      color: #f44336;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
      }
      
      .header-controls {
        flex-direction: column;
        width: 100%;
      }
      
      .search-container {
        min-width: 100%;
      }
      
      .filters {
        flex-direction: column;
      }
      
      .filter-group {
        flex-direction: column;
        align-items: flex-start;
      }
      
      select {
        width: 100%;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .form-group {
        width: 100%;
      }
      
      .action-menu {
        position: fixed;
        top: auto;
        right: 10px;
        left: 10px;
        bottom: 10px;
        min-width: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="company-name">
        <h1>Penta Construction Cash Flow</h1>
      </div>
      <div class="header-controls">
        <!-- Search Bar -->
        <div class="search-container">
          <i class="fa fa-search"></i>
          <input type="text" id="search-bar" placeholder="Search transactions...">
        </div>
        
        <a href="Accountsdashboart.html" class="btn btn-secondary">
          <i class="fa fa-book"></i> Journal
        </a>
        
        <!-- Download PDF Button -->
        <button id="download-pdf-btn" class="btn btn-download">
          <i class="fa fa-download"></i> Download PDF
        </button>
        
        <button id="show-form-btn" class="btn btn-primary">
          <i class="fa fa-plus"></i> New Transaction
        </button>
      </div>
    </header>
    
    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label>Period:</label>
        <select id="period-filter">
          <option value="all">All Time</option>
          <option value="today">Today</option>
          <option value="week">This Week</option>
          <option value="week-number">By Week Number</option>
          <option value="month" selected>This Month</option>
          <option value="specific-month">By Month</option>
          <option value="quarter">This Quarter</option>
          <option value="year">This Year</option>
        </select>
      </div>
      
      <!-- Week Number Filter (Hidden by default) -->
      <div class="filter-group" id="week-number-filter" style="display: none;">
        <label>Week:</label>
        <select id="week-select">
          <!-- Will be populated with JavaScript -->
        </select>
      </div>
      
      <!-- Month Filter (Hidden by default) -->
      <div class="filter-group" id="month-filter" style="display: none;">
        <label>Month:</label>
        <select id="month-select">
          <option value="1">January</option>
          <option value="2">February</option>
          <option value="3">March</option>
          <option value="4">April</option>
          <option value="5">May</option>
          <option value="6">June</option>
          <option value="7">July</option>
          <option value="8">August</option>
          <option value="9">September</option>
          <option value="10">October</option>
          <option value="11">November</option>
          <option value="12">December</option>
        </select>
      </div>
      
      <!-- Year Filter for Month (Hidden by default) -->
      <div class="filter-group" id="month-year-filter" style="display: none;">
        <label>Year:</label>
        <select id="month-year-select">
          <!-- Will be populated with JavaScript -->
        </select>
      </div>
      
      <div class="filter-group">
        <label>Type:</label>
        <select id="type-filter">
          <option value="all">All Transactions</option>
          <option value="debit">Debits Only</option>
          <option value="credit">Credits Only</option>
        </select>
      </div>
    </div>
    
    <!-- Form (Hidden by default) -->
    <div class="form-container hide" id="form-section">
      <div class="form-header">
        <h2><i class="fa fa-plus-circle"></i> Add New Transaction</h2>
        <button class="close-btn" id="close-form-btn">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <form id="cashflow-form">
        <div class="form-row">
          <div class="form-group">
            <label for="tx-date">Date</label>
            <input type="date" id="tx-date" required>
          </div>
          
          <div class="form-group">
            <label for="tx-desc">Description</label>
            <input type="text" id="tx-desc" placeholder="Enter description" required>
          </div>
          
          <div class="form-group">
            <label for="tx-supplier">Supplier / Category</label>
            <input type="text" id="tx-supplier" placeholder="Supplier or category">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="tx-debit">Debit Amount</label>
            <input type="number" id="tx-debit" step="0.01" min="0" value="0" placeholder="0.00">
          </div>
          
          <div class="form-group">
            <label for="tx-credit">Credit Amount</label>
            <input type="number" id="tx-credit" step="0.01" min="0" value="0" placeholder="0.00">
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-reset" id="reset-form">
            <i class="fa fa-refresh"></i> Reset
          </button>
          <button type="submit" class="btn btn-submit">
            <i class="fa fa-check"></i> Add Transaction
          </button>
        </div>
      </form>
    </div>
    
    <!-- Table -->
    <div class="table-container">
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th style="width: 120px">Date</th>
              <th>Description</th>
              <th style="width: 180px">Supplier / Category</th>
              <th style="width: 120px">Debit</th>
              <th style="width: 120px">Credit</th>
              <th style="width: 140px">Balance</th>
              <th style="width: 80px">Actions</th>
            </tr>
          </thead>
          <tbody id="cashflow-body">
            <tr>
              <td colspan="7" class="loading">
                <i class="fa fa-spinner fa-spin"></i> Loading transactions...
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align: right; font-weight: 600;">TOTALS:</td>
              <td class="text-right" id="total-debit">0.00</td>
              <td class="text-right" id="total-credit">0.00</td>
              <td class="text-right" id="ending-balance">0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      Timestamp,
      query,
      orderBy,
      serverTimestamp,
      deleteDoc,
      doc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
      authDomain: "project-task-588c4.firebaseapp.com",
      projectId: "project-task-588c4",
      storageBucket: "project-task-588c4.appspot.com",
      messagingSenderId: "411882772509",
      appId: "1:411882772509:web:08d613186c101a99f38ef4",
      measurementId: "G-JMFLFYEM0F"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COLLECTION = "cashflow";

    // DOM elements
    const showFormBtn = document.getElementById("show-form-btn");
    const closeFormBtn = document.getElementById("close-form-btn");
    const formSection = document.getElementById("form-section");
    const cashflowForm = document.getElementById("cashflow-form");
    const txDate = document.getElementById("tx-date");
    const txDesc = document.getElementById("tx-desc");
    const txSupplier = document.getElementById("tx-supplier");
    const txDebit = document.getElementById("tx-debit");
    const txCredit = document.getElementById("tx-credit");
    const resetFormBtn = document.getElementById("reset-form");
    const cashflowBody = document.getElementById("cashflow-body");
    const totalDebitEl = document.getElementById("total-debit");
    const totalCreditEl = document.getElementById("total-credit");
    const endingBalanceEl = document.getElementById("ending-balance");
    const periodFilter = document.getElementById("period-filter");
    const typeFilter = document.getElementById("type-filter");
    const searchBar = document.getElementById("search-bar");
    const weekNumberFilter = document.getElementById("week-number-filter");
    const weekSelect = document.getElementById("week-select");
    const monthFilter = document.getElementById("month-filter");
    const monthSelect = document.getElementById("month-select");
    const monthYearFilter = document.getElementById("month-year-filter");
    const monthYearSelect = document.getElementById("month-year-select");
    const downloadPdfBtn = document.getElementById("download-pdf-btn");

    // Set today's date by default
    const today = new Date();
    txDate.value = today.toISOString().split('T')[0];

    // Filter and sort variables
    let allTransactions = [];
    let filteredTransactions = [];
    let searchTerm = '';

    // Action menu management
    let activeMenu = null;

    // Close all open menus
    function closeAllMenus() {
      if (activeMenu) {
        activeMenu.classList.remove('show');
        activeMenu = null;
      }
    }

    // Handle clicks outside menus
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.action-menu-container')) {
        closeAllMenus();
      }
    });

    // Get week number from date
    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
    }

    // Get start and end of week by week number
    function getWeekRange(year, weekNumber) {
      const firstDayOfYear = new Date(year, 0, 1);
      const days = 2 + (weekNumber - 1) * 7 - firstDayOfYear.getDay();
      const start = new Date(year, 0, days);
      const end = new Date(year, 0, days + 6);
      
      // Set to beginning and end of day
      start.setHours(0, 0, 0, 0);
      end.setHours(23, 59, 59, 999);
      
      return { start, end };
    }

    // Get start and end of month
    function getMonthRange(year, month) {
      const start = new Date(year, month - 1, 1);
      const end = new Date(year, month, 0);
      
      start.setHours(0, 0, 0, 0);
      end.setHours(23, 59, 59, 999);
      
      return { start, end };
    }

    // Populate week select options
    function populateWeekSelect() {
      weekSelect.innerHTML = '';
      
      // Get available years from transactions
      const years = [...new Set(allTransactions.map(tx => tx.date.getFullYear()))].sort((a, b) => b - a);
      
      if (years.length === 0) {
        // Default to current year if no transactions
        const currentYear = new Date().getFullYear();
        for (let i = 1; i <= 52; i++) {
          const option = document.createElement('option');
          option.value = `${currentYear}-${i}`;
          option.textContent = `${currentYear} - Week ${i}`;
          weekSelect.appendChild(option);
        }
      } else {
        // Create options for each year and week
        years.forEach(year => {
          // Add 52 weeks for each year
          for (let week = 1; week <= 52; week++) {
            const option = document.createElement('option');
            option.value = `${year}-${week}`;
            option.textContent = `${year} - Week ${week}`;
            weekSelect.appendChild(option);
          }
        });
      }
      
      // Set current week as default
      const currentWeek = getWeekNumber(new Date());
      const currentYear = new Date().getFullYear();
      weekSelect.value = `${currentYear}-${currentWeek}`;
    }

    // Populate year select for month filter
    function populateYearSelect() {
      monthYearSelect.innerHTML = '';
      
      // Get available years from transactions
      const years = [...new Set(allTransactions.map(tx => tx.date.getFullYear()))].sort((a, b) => b - a);
      
      if (years.length === 0) {
        // Default to current year if no transactions
        const currentYear = new Date().getFullYear();
        const option = document.createElement('option');
        option.value = currentYear;
        option.textContent = currentYear;
        monthYearSelect.appendChild(option);
      } else {
        years.forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          monthYearSelect.appendChild(option);
        });
      }
      
      // Set current month and year as default
      const currentDate = new Date();
      monthSelect.value = currentDate.getMonth() + 1;
      monthYearSelect.value = currentDate.getFullYear();
    }

    // Handle period filter change
    periodFilter.addEventListener('change', function() {
      const value = this.value;
      
      // Show/hide additional filter controls
      if (value === 'week-number') {
        weekNumberFilter.style.display = 'flex';
        monthFilter.style.display = 'none';
        monthYearFilter.style.display = 'none';
        populateWeekSelect();
      } else if (value === 'specific-month') {
        weekNumberFilter.style.display = 'none';
        monthFilter.style.display = 'flex';
        monthYearFilter.style.display = 'flex';
        populateYearSelect();
      } else {
        weekNumberFilter.style.display = 'none';
        monthFilter.style.display = 'none';
        monthYearFilter.style.display = 'none';
      }
      
      filterTransactions();
    });

    // Add event listeners for week and month filters
    weekSelect.addEventListener('change', filterTransactions);
    monthSelect.addEventListener('change', filterTransactions);
    monthYearSelect.addEventListener('change', filterTransactions);

    // Search functionality
    searchBar.addEventListener('input', function() {
      searchTerm = this.value.toLowerCase().trim();
      filterTransactions();
    });

    // Download PDF functionality
    downloadPdfBtn.addEventListener('click', downloadPDF);

    // Download PDF function
    function downloadPDF() {
      if (filteredTransactions.length === 0) {
        alert('No transactions to download!');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape');
      
      // Company header
      doc.setFontSize(20);
      doc.setTextColor(25, 118, 210);
      doc.text('Penta Construction', 20, 20);
      
      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      doc.text('Cash Flow Report', 20, 30);
      
      // Report details
      const period = periodFilter.options[periodFilter.selectedIndex].text;
      const type = typeFilter.options[typeFilter.selectedIndex].text;
      const filterDetails = `Period: ${period} | Type: ${type} | Total Transactions: ${filteredTransactions.length}`;
      
      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      doc.text(filterDetails, 20, 40);
      
      // Date of report
      const reportDate = new Date().toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      doc.text(`Generated on: ${reportDate}`, 20, 48);
      
      // Calculate totals
      let totalDebit = 0;
      let totalCredit = 0;
      let runningBalance = 0;
      
      const transactionsWithBalance = filteredTransactions.map(tx => {
        runningBalance = runningBalance + tx.credit - tx.debit;
        totalDebit += tx.debit;
        totalCredit += tx.credit;
        
        return {
          date: tx.date.toISOString().split('T')[0],
          description: tx.description,
          supplier: tx.supplier || "-",
          debit: tx.debit > 0 ? formatMoney(tx.debit) : "",
          credit: tx.credit > 0 ? formatMoney(tx.credit) : "",
          balance: formatMoney(runningBalance)
        };
      });
      
      // Prepare table data
      const tableData = transactionsWithBalance.map(tx => [
        tx.date,
        tx.description,
        tx.supplier,
        tx.debit,
        tx.credit,
        tx.balance
      ]);
      
      // Add totals row
      tableData.push([
        '',
        '',
        'TOTALS:',
        formatMoney(totalDebit),
        formatMoney(totalCredit),
        formatMoney(runningBalance)
      ]);
      
      // Create the table
      doc.autoTable({
        head: [['Date', 'Description', 'Supplier/Category', 'Debit', 'Credit', 'Balance']],
        body: tableData,
        startY: 60,
        theme: 'grid',
        headStyles: { fillColor: [131, 131, 131] },
        columnStyles: {
          0: { cellWidth: 30 },
          1: { cellWidth: 60 },
          2: { cellWidth: 40 },
          3: { cellWidth: 30, halign: 'right' },
          4: { cellWidth: 30, halign: 'right' },
          5: { cellWidth: 35, halign: 'right' }
        },
        didDrawPage: function(data) {
          // Footer
          doc.setFontSize(10);
          doc.setTextColor(128, 128, 128);
          doc.text(`Page ${doc.internal.getNumberOfPages()}`, 
                   doc.internal.pageSize.width / 2, 
                   doc.internal.pageSize.height - 10,
                   { align: 'center' });
        }
      });
      
      // Generate filename
      const filename = `Penta_CashFlow_${period.replace(/ /g, '_')}_${new Date().getTime()}.pdf`;
      
      // Save the PDF
      doc.save(filename);
    }

    // Form visibility
    showFormBtn.addEventListener("click", () => {
      formSection.classList.remove("hide");
      setTimeout(() => txDesc.focus(), 100);
    });

    closeFormBtn.addEventListener("click", () => {
      formSection.classList.add("hide");
      resetFormToAddMode();
    });

    // Reset form to "add new" mode
    function resetFormToAddMode() {
      cashflowForm.reset();
      txDate.value = today.toISOString().split('T')[0];
      txDebit.value = "0";
      txCredit.value = "0";
      
      const formHeader = formSection.querySelector('.form-header h2');
      formHeader.innerHTML = '<i class="fa fa-plus-circle"></i> Add New Transaction';
      
      const submitBtn = cashflowForm.querySelector('.btn-submit');
      submitBtn.innerHTML = '<i class="fa fa-check"></i> Add Transaction';
      
      // Remove any edit mode data
      if (cashflowForm.dataset.editId) {
        delete cashflowForm.dataset.editId;
      }
    }

    // Reset form
    resetFormBtn.addEventListener("click", () => {
      resetFormToAddMode();
    });

    // Form submission
    cashflowForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      // Validation
      if (!txDate.value) {
        alert("Please select a date.");
        return;
      }
      
      if (!txDesc.value.trim()) {
        alert("Please enter a description.");
        txDesc.focus();
        return;
      }
      
      const debit = parseFloat(txDebit.value) || 0;
      const credit = parseFloat(txCredit.value) || 0;
      
      if (debit === 0 && credit === 0) {
        if (!confirm("Both Debit and Credit are zero. Continue anyway?")) {
          return;
        }
      }
      
      // Check if we're in edit mode
      const isEditMode = cashflowForm.dataset.editId;
      
      // Prepare transaction
      const transaction = {
        date: Timestamp.fromDate(new Date(txDate.value)),
        description: txDesc.value.trim(),
        supplier: txSupplier.value.trim(),
        debit: parseFloat(debit.toFixed(2)),
        credit: parseFloat(credit.toFixed(2)),
        createdAt: serverTimestamp()
      };
      
      try {
        if (isEditMode) {
          // Update existing transaction
          await updateDoc(doc(db, COLLECTION, isEditMode), {
            ...transaction,
            updatedAt: serverTimestamp()
          });
          alert('Transaction updated successfully!');
        } else {
          // Add new transaction
          await addDoc(collection(db, COLLECTION), transaction);
          alert('Transaction added successfully!');
        }
        
        // Reset and hide form
        resetFormToAddMode();
        formSection.classList.add("hide");
        
      } catch (error) {
        console.error("Error saving transaction:", error);
        alert("Error saving transaction. Please check console.");
      }
    });

    // Date filter functions
    function getDateRange(period) {
      const now = new Date();
      const start = new Date();
      const end = new Date();
      
      switch(period) {
        case 'today':
          start.setHours(0, 0, 0, 0);
          end.setHours(23, 59, 59, 999);
          return { start, end };
          
        case 'week':
          const day = now.getDay();
          const diff = now.getDate() - day + (day === 0 ? -6 : 1);
          start.setDate(diff);
          start.setHours(0, 0, 0, 0);
          end.setDate(diff + 6);
          end.setHours(23, 59, 59, 999);
          return { start, end };
          
        case 'week-number':
          if (weekSelect.value) {
            const [year, week] = weekSelect.value.split('-').map(Number);
            return getWeekRange(year, week);
          }
          break;
          
        case 'month':
          start.setDate(1);
          start.setHours(0, 0, 0, 0);
          end.setMonth(end.getMonth() + 1);
          end.setDate(0);
          end.setHours(23, 59, 59, 999);
          return { start, end };
          
        case 'specific-month':
          if (monthSelect.value && monthYearSelect.value) {
            const month = parseInt(monthSelect.value);
            const year = parseInt(monthYearSelect.value);
            return getMonthRange(year, month);
          }
          break;
          
        case 'last-month':
          start.setMonth(start.getMonth() - 1);
          start.setDate(1);
          start.setHours(0, 0, 0, 0);
          end.setMonth(end.getMonth());
          end.setDate(0);
          end.setHours(23, 59, 59, 999);
          return { start, end };
          
        case 'quarter':
          const quarter = Math.floor(now.getMonth() / 3);
          start.setMonth(quarter * 3);
          start.setDate(1);
          start.setHours(0, 0, 0, 0);
          end.setMonth(quarter * 3 + 3);
          end.setDate(0);
          end.setHours(23, 59, 59, 999);
          return { start, end };
          
        case 'year':
          start.setMonth(0, 1);
          start.setHours(0, 0, 0, 0);
          end.setMonth(11, 31);
          end.setHours(23, 59, 59, 999);
          return { start, end };
          
        default:
          return { start: null, end: null };
      }
      
      return { start: null, end: null };
    }

    // Filter transactions
    function filterTransactions() {
      const period = periodFilter.value;
      const type = typeFilter.value;
      
      let filtered = [...allTransactions];
      
      // Apply search filter
      if (searchTerm) {
        filtered = filtered.filter(tx => {
          return (
            tx.description.toLowerCase().includes(searchTerm) ||
            tx.supplier.toLowerCase().includes(searchTerm) ||
            tx.date.toISOString().split('T')[0].includes(searchTerm)
          );
        });
      }
      
      // Apply date filter
      if (period !== 'all') {
        const { start, end } = getDateRange(period);
        if (start && end) {
          filtered = filtered.filter(tx => {
            const txDate = tx.date;
            return txDate >= start && txDate <= end;
          });
        }
      }
      
      // Apply type filter
      if (type === 'debit') {
        filtered = filtered.filter(tx => tx.debit > 0);
      } else if (type === 'credit') {
        filtered = filtered.filter(tx => tx.credit > 0);
      }
      
      // Sort in ASCENDING order (oldest to newest) - recent at the bottom
      filtered.sort((a, b) => a.date - b.date);
      
      filteredTransactions = filtered;
      renderTransactions();
    }

    // Event listeners for filters
    periodFilter.addEventListener('change', filterTransactions);
    typeFilter.addEventListener('change', filterTransactions);
    searchBar.addEventListener('input', filterTransactions);

    // Action handlers
    async function reverseTransaction(transaction) {
      if (!confirm('Are you sure you want to reverse this transaction? This will create an opposite entry.')) {
        return;
      }
      
      try {
        const reversedTransaction = {
          date: Timestamp.fromDate(new Date()),
          description: `Reversal: ${transaction.description}`,
          supplier: transaction.supplier,
          debit: transaction.credit,
          credit: transaction.debit,
          createdAt: serverTimestamp(),
          reversedFrom: transaction.id
        };
        
        await addDoc(collection(db, COLLECTION), reversedTransaction);
        alert('Transaction reversed successfully!');
        closeAllMenus();
      } catch (error) {
        console.error('Error reversing transaction:', error);
        alert('Error reversing transaction.');
      }
    }

    async function deleteTransaction(transactionId) {
      if (!confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
        return;
      }
      
      try {
        await deleteDoc(doc(db, COLLECTION, transactionId));
        alert('Transaction deleted successfully!');
        closeAllMenus();
      } catch (error) {
        console.error('Error deleting transaction:', error);
        alert('Error deleting transaction.');
      }
    }

    function editTransaction(transaction) {
      // Populate form with transaction data
      txDate.value = transaction.date.toISOString().split('T')[0];
      txDesc.value = transaction.description;
      txSupplier.value = transaction.supplier || '';
      txDebit.value = transaction.debit;
      txCredit.value = transaction.credit;
      
      // Show form
      formSection.classList.remove("hide");
      
      // Change form header to edit mode
      const formHeader = formSection.querySelector('.form-header h2');
      formHeader.innerHTML = '<i class="fa fa-edit"></i> Edit Transaction';
      
      // Change submit button text
      const submitBtn = cashflowForm.querySelector('.btn-submit');
      submitBtn.innerHTML = '<i class="fa fa-check"></i> Update Transaction';
      
      // Store the transaction ID for updating
      cashflowForm.dataset.editId = transaction.id;
      
      closeAllMenus();
    }

    // Real-time data listener - SORT BY DATE ASCENDING
    const q = query(collection(db, COLLECTION), orderBy("date", "asc"));
    
    onSnapshot(q, (snapshot) => {
      const transactions = [];
      snapshot.forEach((doc) => {
        const data = doc.data();
        transactions.push({
          id: doc.id,
          date: data.date?.toDate() || new Date(),
          description: data.description || "",
          supplier: data.supplier || "",
          debit: parseFloat(data.debit || 0),
          credit: parseFloat(data.credit || 0),
          createdAt: data.createdAt?.toDate() || new Date()
        });
      });
      
      // Store all transactions
      allTransactions = transactions;
      
      // Populate filter options
      populateWeekSelect();
      populateYearSelect();
      
      // Apply filters and render
      filterTransactions();
    }, (error) => {
      console.error("Firestore error:", error);
      cashflowBody.innerHTML = `
        <tr>
          <td colspan="7" style="text-align: center; padding: 40px; color: #f44336;">
            <i class="fa fa-exclamation-triangle"></i>
            <div style="margin-top: 10px;">Error loading data</div>
          </td>
        </tr>`;
    });

    // Format currency
    function formatMoney(amount) {
      return amount.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // Render transactions in ASCENDING order (oldest to newest, recent at bottom)
    function renderTransactions() {
      cashflowBody.innerHTML = "";
      
      if (filteredTransactions.length === 0) {
        cashflowBody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <i class="fa fa-inbox"></i>
              <div>No transactions found</div>
            </td>
          </tr>`;
        totalDebitEl.textContent = "0.00";
        totalCreditEl.textContent = "0.00";
        endingBalanceEl.textContent = "0.00";
        return;
      }
      
      // Calculate totals and running balance
      let totalDebit = 0;
      let totalCredit = 0;
      let runningBalance = 0;
      
      // Already sorted by date ascending, so we can use filteredTransactions directly
      const transactionsWithBalance = filteredTransactions.map(tx => {
        runningBalance = runningBalance + tx.credit - tx.debit;
        totalDebit += tx.debit;
        totalCredit += tx.credit;
        
        return {
          ...tx,
          balance: runningBalance
        };
      });
      
      // Render in ASCENDING order (oldest first, recent at bottom)
      transactionsWithBalance.forEach(tx => {
        const row = document.createElement("tr");
        
        // Date
        const dateCell = document.createElement("td");
        dateCell.textContent = tx.date.toISOString().split('T')[0];
        row.appendChild(dateCell);
        
        // Description
        const descCell = document.createElement("td");
        descCell.textContent = tx.description;
        row.appendChild(descCell);
        
        // Supplier
        const supCell = document.createElement("td");
        supCell.textContent = tx.supplier || "-";
        row.appendChild(supCell);
        
        // Debit - blank if zero
        const debitCell = document.createElement("td");
        debitCell.className = "text-right";
        if (tx.debit > 0) {
          debitCell.innerHTML = `<span class="debit">${formatMoney(tx.debit)}</span>`;
        } else {
          debitCell.innerHTML = ""; // Blank instead of "-"
        }
        row.appendChild(debitCell);
        
        // Credit - blank if zero
        const creditCell = document.createElement("td");
        creditCell.className = "text-right";
        if (tx.credit > 0) {
          creditCell.innerHTML = `<span class="credit">${formatMoney(tx.credit)}</span>`;
        } else {
          creditCell.innerHTML = ""; // Blank instead of "-"
        }
        row.appendChild(creditCell);
        
        // Balance
        const balanceCell = document.createElement("td");
        balanceCell.className = "text-right";
        balanceCell.innerHTML = `<span class="balance">${formatMoney(tx.balance)}</span>`;
        row.appendChild(balanceCell);
        
        // Actions cell with 3-dots menu
        const actionsCell = document.createElement("td");
        const menuContainer = document.createElement("div");
        menuContainer.className = "action-menu-container";
        
        // 3-dots button
        const dotsBtn = document.createElement("button");
        dotsBtn.className = "three-dots-btn";
        dotsBtn.innerHTML = "&#8942;";
        dotsBtn.title = "Actions";
        
        // Action menu
        const actionMenu = document.createElement("div");
        actionMenu.className = "action-menu";
        
        // Reverse option
        const reverseBtn = document.createElement("button");
        reverseBtn.className = "action-menu-item reverse";
        reverseBtn.innerHTML = '<i class="fa fa-exchange"></i> Reverse';
        reverseBtn.onclick = () => reverseTransaction(tx);
        
        // Edit option
        const editBtn = document.createElement("button");
        editBtn.className = "action-menu-item edit";
        editBtn.innerHTML = '<i class="fa fa-edit"></i> Edit';
        editBtn.onclick = () => editTransaction(tx);
        
        // Delete option
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "action-menu-item delete";
        deleteBtn.innerHTML = '<i class="fa fa-trash"></i> Delete';
        deleteBtn.onclick = () => deleteTransaction(tx.id);
        
        // Append menu items
        actionMenu.appendChild(reverseBtn);
        actionMenu.appendChild(editBtn);
        actionMenu.appendChild(deleteBtn);
        
        // Toggle menu on button click
        dotsBtn.onclick = (e) => {
          e.stopPropagation();
          if (activeMenu === actionMenu) {
            actionMenu.classList.remove('show');
            activeMenu = null;
          } else {
            closeAllMenus();
            actionMenu.classList.add('show');
            activeMenu = actionMenu;
          }
        };
        
        menuContainer.appendChild(dotsBtn);
        menuContainer.appendChild(actionMenu);
        actionsCell.appendChild(menuContainer);
        row.appendChild(actionsCell);
        
        cashflowBody.appendChild(row);
      });
      
      // Update totals
      totalDebitEl.textContent = formatMoney(totalDebit);
      totalCreditEl.textContent = formatMoney(totalCredit);
      endingBalanceEl.textContent = formatMoney(runningBalance);
    }

    // Auto-focus description field when form is shown
    formSection.addEventListener('transitionend', () => {
      if (!formSection.classList.contains('hide')) {
        txDesc.focus();
      }
    });
  </script>
</body>
</html>
