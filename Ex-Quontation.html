<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hazida ¬∑ professional quotation (save + hide)</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background-color: #eef2f5;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    /* main card */
    .app {
      max-width: 1400px;
      width: 100%;
      background: white;
      border-radius: 28px;
      box-shadow: 0 25px 50px -12px rgba(0,32,64,0.25);
      padding: 2rem 2.2rem;
    }

    /* header */
    .company-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      border-bottom: 2px solid #cfddee;
      padding-bottom: 1.2rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .company-title h1 {
      font-size: 2.4rem;
      font-weight: 600;
      color: #0b2942;
    }

    .company-title .sub {
      color: #2c577c;
      font-weight: 500;
    }

    .doc-number {
      background: #eaf1fb;
      padding: 0.4rem 1.2rem;
      border-radius: 40px;
      font-weight: 600;
      color: #003366;
    }

    /* customer panel */
    .customer-panel {
      background: #f2f7fd;
      border-radius: 24px;
      padding: 1.5rem 2rem;
      margin-bottom: 2rem;
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      border: 1px solid #dbe7f2;
    }

    .customer-field {
      display: flex;
      flex-direction: column;
      min-width: 220px;
    }

    .customer-field label {
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      color: #2f557a;
      margin-bottom: 0.2rem;
    }

    .customer-field input {
      border: 1px solid #c1d4e8;
      border-radius: 14px;
      padding: 0.7rem 1.2rem;
      font-size: 1rem;
      background: white;
    }

    /* toggle buttons */
    .toggle-section {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .toggle-btn {
      background: #eaf1fb;
      border: none;
      padding: 0.6rem 1.8rem;
      border-radius: 40px;
      font-weight: 600;
      color: #1d446b;
      cursor: pointer;
      border: 1px solid #b9cee6;
    }

    .toggle-btn.active {
      background: #0b2942;
      color: white;
      border-color: #0b2942;
    }

    .section {
      transition: opacity 0.2s;
    }

    .hidden-section {
      display: none !important;
    }

    /* job card */
    .job-card {
      background: #ffffff;
      border: 1px solid #e2eaf2;
      border-radius: 24px;
      padding: 1.8rem 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 6px 14px rgba(0,0,0,0.02);
    }

    .job-header {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 1.8rem;
      flex-wrap: wrap;
    }

    .job-header input {
      font-size: 1.2rem;
      font-weight: 600;
      border: 1px solid #c6d8ec;
      border-radius: 40px;
      padding: 0.6rem 1.5rem;
      width: 320px;
      background: #f9fcff;
    }

    .job-header .remove-job {
      background: none;
      border: 1px solid #e0b3b3;
      padding: 0.4rem 1.5rem;
      border-radius: 40px;
      color: #aa4a4a;
      font-weight: 500;
      cursor: pointer;
      margin-left: auto;
    }

    /* materials table */
    .mat-table-wrapper {
      border-radius: 18px;
      border: 1px solid #d9e5f0;
      overflow: auto;
      margin: 1rem 0 1.2rem;
      background: white;
    }

    .mat-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    .mat-table th {
      background: #ecf3fa;
      color: #1d446b;
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      padding: 1rem 1rem;
      text-align: left;
      border-bottom: 1px solid #c9daec;
    }

    .mat-table td {
      padding: 0.9rem 1rem;
      border-bottom: 1px solid #e2ecf5;
      vertical-align: middle;
    }

    .mat-table input {
      width: 100%;
      border: 1px solid #d0ddee;
      border-radius: 12px;
      padding: 0.5rem 0.8rem;
      background: white;
      font-size: 0.95rem;
    }

    .mat-table input:focus {
      border-color: #1f6eaf;
      outline: none;
      box-shadow: 0 0 0 2px rgba(20,100,180,0.1);
    }

    .remove-mat {
      background: none;
      border: none;
      font-size: 1.2rem;
      color: #b24747;
      cursor: pointer;
      padding: 0 0.3rem;
    }

    .add-material-btn {
      background: white;
      border: 1.5px dashed #9bb4cf;
      border-radius: 30px;
      padding: 0.5rem 1.8rem;
      font-weight: 500;
      color: #1e4870;
      cursor: pointer;
      margin-top: 0.5rem;
    }

    .add-job-btn {
      background: white;
      border: 2px dashed #9bb4cf;
      border-radius: 40px;
      padding: 1rem 2.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: #1e4870;
      cursor: pointer;
      margin: 1rem 0 2rem;
      width: fit-content;
    }

    /* indirect costs */
    .indirect-section {
      background: #f5faff;
      border-radius: 24px;
      padding: 1.8rem 2rem;
      margin: 2.2rem 0 1.8rem;
      border: 1px solid #cde0f0;
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #113753;
      margin-bottom: 1.2rem;
    }

    .indirect-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid #d2e1f2;
    }

    .indirect-table th {
      background: #e6f0fa;
      padding: 1rem 1.5rem;
      font-weight: 600;
      color: #1d4a79;
    }

    .indirect-table td {
      padding: 0.8rem 1.5rem;
      border-bottom: 1px solid #deeaf5;
    }

    .indirect-table input {
      border: 1px solid #c7d9ec;
      border-radius: 12px;
      padding: 0.6rem 1.2rem;
      width: 240px;
    }

    .add-indirect-btn {
      background: white;
      border: 1.5px dashed #98b6d4;
      border-radius: 30px;
      padding: 0.6rem 2rem;
      font-weight: 500;
      color: #1e4870;
      cursor: pointer;
      margin-top: 1rem;
    }

    /* labour, markup, grand */
    .labour-markup-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      background: #f3f9ff;
      border-radius: 22px;
      padding: 1.4rem 2rem;
      margin: 1.5rem 0 2rem;
      border: 1px solid #c9dcf0;
    }

    .lm-block {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .lm-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .lm-item label {
      font-weight: 600;
      color: #20466b;
      width: 80px;
    }

    .lm-item input {
      border: 1px solid #b5ceea;
      border-radius: 30px;
      padding: 0.7rem 1.4rem;
      width: 160px;
    }

    .grand-total-box {
      font-size: 1.9rem;
      font-weight: 800;
      color: #003366;
      background: #e2edfe;
      padding: 0.6rem 2rem;
      border-radius: 60px;
      border: 1px solid #aac3e0;
    }

    .action-buttons {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      margin: 1.5rem 0;
    }

    .save-btn, .pdf-btn {
      background: #0b2942;
      border: none;
      color: white;
      font-weight: 600;
      padding: 0.9rem 2.5rem;
      border-radius: 40px;
      cursor: pointer;
      border: 1px solid #204b70;
      font-size: 1rem;
    }

    .save-btn { background: #1d4e7c; }

    /* saved list */
    .saved-list {
      background: #f8fbfe;
      border-radius: 24px;
      padding: 1.5rem;
      margin-top: 2rem;
      border: 1px solid #c9dcf0;
    }

    .saved-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 1rem;
      border-bottom: 1px solid #d9e6f5;
    }

    .load-saved {
      background: #eaf1fb;
      border: none;
      padding: 0.3rem 1.2rem;
      border-radius: 30px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="company-header">
    <div class="company-title">
      <h1>HAZIDA LIMITED</h1>
      <div class="sub">construction ¬∑ supplies ¬∑ engineering</div>
    </div>
    <div class="doc-number">QUOTATION #Q-<span id="quoteNum">0426</span></div>
  </div>

  <!-- toggle visibility -->
  <div class="toggle-section">
    <button class="toggle-btn active" data-target="jobs">jobs & materials</button>
    <button class="toggle-btn" data-target="indirect">indirect costs</button>
    <button class="toggle-btn" data-target="preview">preview & save</button>
  </div>

  <!-- main dynamic container -->
  <div id="dynamicContent"></div>

  <!-- saved quotations list -->
  <div class="saved-list" id="savedList"></div>
</div>

<script>
  (function() {
    // --- STATE ---
    let jobs = [];
    let indirectItems = [];
    let labour = 1950;
    let markup = 13.5;
    let customer = { name: 'John Mwale', address: 'Plot 17, Lusaka' };
    let savedQuotes = JSON.parse(localStorage.getItem('hazida_quotes')) || [];

    // generate unique quote number
    let quoteNum = Math.floor(Math.random() * 9000 + 1000);
    document.getElementById('quoteNum').innerText = quoteNum;

    const container = document.getElementById('dynamicContent');

    function genId() { return 'job_' + Date.now() + Math.random().toString(36).substring(2,6); }
    function matId() { return 'mat_' + Date.now() + Math.random().toString(36).substring(2,8); }

    // --- TOGGLE SECTIONS ---
    let visibleSection = 'jobs'; // jobs, indirect, preview

    function setupToggles() {
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          visibleSection = btn.dataset.target;
          render();
        });
      });
    }

    // --- RENDER ---
    function render() {
      let jobsHtml = '';
      if (visibleSection === 'jobs') {
        // customer panel always visible
        jobsHtml += `
          <div class="customer-panel">
            <div class="customer-field"><label>customer name</label><input type="text" id="custName" value="${customer.name}"></div>
            <div class="customer-field"><label>customer address</label><input type="text" id="custAddress" value="${customer.address}"></div>
          </div>
        `;

        if (jobs.length === 0) {
          jobsHtml += `<div style="background:#f9fcff; border-radius:28px; padding:3rem; text-align:center; color:#5f7d9c; border:1px dashed #bcd0e6; margin-bottom:1.5rem;">‚Äî no jobs added ‚Äî</div>`;
        } else {
          jobs.forEach((job, jIdx) => {
            jobsHtml += `<div class="job-card" data-job-id="${job.id}">`;
            jobsHtml += `<div class="job-header">`;
            jobsHtml += `<input type="text" value="${job.name}" placeholder="job description" class="job-name-input" data-job-idx="${jIdx}">`;
            jobsHtml += `<button class="remove-job" data-job-id="${job.id}">remove job</button>`;
            jobsHtml += `</div>`;

            jobsHtml += `<div class="mat-table-wrapper"><table class="mat-table"><thead><tr><th>material</th><th>qty</th><th>unit price (ZMW)</th><th>supplier</th><th>amount</th><th></th></tr></thead><tbody id="mat-body-${job.id}">`;

            if (job.materials.length === 0) {
              jobsHtml += `<tr><td colspan="6" style="padding:1.5rem; text-align:center;">‚Äî no materials ‚Äî</td></tr>`;
            } else {
              job.materials.forEach((mat, mIdx) => {
                let amt = (mat.qty * mat.price).toFixed(2);
                jobsHtml += `<tr>
                  <td><input type="text" value="${mat.desc}" data-job-idx="${jIdx}" data-mat-idx="${mIdx}" class="mat-desc"></td>
                  <td><input type="number" value="${mat.qty}" step="0.1" min="0" data-job-idx="${jIdx}" data-mat-idx="${mIdx}" class="mat-qty"></td>
                  <td><input type="number" value="${mat.price}" step="0.01" min="0" data-job-idx="${jIdx}" data-mat-idx="${mIdx}" class="mat-price"></td>
                  <td><input type="text" value="${mat.supplier}" data-job-idx="${jIdx}" data-mat-idx="${mIdx}" class="mat-supplier"></td>
                  <td>${amt} ZMW</td>
                  <td><button class="remove-mat" data-job-id="${job.id}" data-mat-id="${mat.id}">‚úï</button></td>
                </tr>`;
              });
            }
            jobsHtml += `</tbody></table></div>`;
            jobsHtml += `<button class="add-material-btn" data-job-id="${job.id}">‚ûï add material</button>`;
            jobsHtml += `</div>`;
          });
        }
        jobsHtml += `<button class="add-job-btn" id="addJobBtn">‚ûï add new job</button>`;
      }

      // indirect section
      let indirectHtml = '';
      if (visibleSection === 'indirect') {
        indirectHtml += `<div class="indirect-section"><div class="section-title">indirect costs (ZMW)</div>`;
        indirectHtml += `<table class="indirect-table"><thead><tr><th>description</th><th>amount</th><th></th></tr></thead><tbody id="indirectBody">`;
        if (indirectItems.length === 0) {
          indirectHtml += `<tr><td colspan="3" style="padding:1rem; text-align:center;">‚Äî none ‚Äî</td></tr>`;
        } else {
          indirectItems.forEach((item, idx) => {
            indirectHtml += `<tr>
              <td><input type="text" value="${item.name}" data-ind-idx="${idx}" class="indirect-name"></td>
              <td><input type="number" value="${item.value}" step="1" min="0" data-ind-idx="${idx}" class="indirect-value"></td>
              <td><button class="remove-indirect-btn" data-ind-idx="${idx}">‚úï</button></td>
            </tr>`;
          });
        }
        indirectHtml += `</tbody></table><button class="add-indirect-btn" id="addIndirectBtn">‚ûï add indirect cost</button></div>`;
      }

      // labour & grand always visible
      let labourHtml = `
        <div class="labour-markup-row">
          <div class="lm-block">
            <div class="lm-item"><label>labour</label><input type="number" id="labourInput" value="${labour}"></div>
            <div class="lm-item"><label>markup %</label><input type="number" id="markupInput" value="${markup}" step="0.5"></div>
          </div>
          <div class="grand-total-box" id="grandTotalDisplay">0.00 ZMW</div>
        </div>
      `;

      // preview section
      let previewHtml = '';
      if (visibleSection === 'preview') {
        previewHtml = `
          <div class="action-buttons">
            <button class="save-btn" id="saveQuoteBtn">üíæ save quotation</button>
            <button class="pdf-btn" id="downloadPdfBtn">üìé PDF quotation</button>
          </div>
          <div class="preview-panel" style="background:#f6faff; border-radius:26px; padding:2rem;">
            <div style="font-size:1.4rem; font-weight:650; margin-bottom:1.5rem;">üìã quotation preview</div>
            <table class="preview-table" style="width:100%; border-collapse:collapse; background:white; border-radius:18px;">
              <thead><tr><th>job / material</th><th>qty</th><th>unit price</th><th>supplier</th><th>total</th></tr></thead>
              <tbody id="previewBody"></tbody>
            </table>
            <div class="totals-sage" id="previewTotals" style="margin-top:1.5rem; background:white; border-radius:18px; padding:1.2rem 2rem;"></div>
          </div>
        `;
      }

      // combine based on visible section
      let fullHtml = '';
      if (visibleSection === 'jobs') fullHtml = jobsHtml + labourHtml;
      else if (visibleSection === 'indirect') fullHtml = indirectHtml + labourHtml;
      else fullHtml = previewHtml;  // preview includes its own totals, labour already shown? we keep labour separate

      // for preview we also show labour? but preview has its own totals, so labourHtml optional
      if (visibleSection === 'preview') {
        // we already added previewHtml, but labour input is not needed in preview? we keep it minimal
        fullHtml = labourHtml + previewHtml; // show labour + markup + grand + preview
      }

      container.innerHTML = fullHtml;

      // attach events
      attachEvents();
      updateTotalsAndPreview();

      // update saved list
      renderSavedList();
    }

    function attachEvents() {
      // customer
      document.getElementById('custName')?.addEventListener('input', (e) => customer.name = e.target.value);
      document.getElementById('custAddress')?.addEventListener('input', (e) => customer.address = e.target.value);

      // job name
      document.querySelectorAll('.job-name-input').forEach(inp => {
        inp.addEventListener('input', (e) => {
          let idx = e.target.dataset.jobIdx;
          if (idx !== undefined) jobs[idx].name = e.target.value;
        });
      });

      // remove job
      document.querySelectorAll('.remove-job').forEach(btn => {
        btn.addEventListener('click', (e) => {
          let jobId = e.target.dataset.jobId;
          jobs = jobs.filter(j => j.id !== jobId);
          render();
        });
      });

      // add material - FIX: now works without locking
      document.querySelectorAll('.add-material-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          let jobId = e.target.dataset.jobId;
          let job = jobs.find(j => j.id === jobId);
          if (job) {
            job.materials.push({ id: matId(), desc: 'new material', qty: 1, price: 100, supplier: '‚Äî' });
            render(); // full render to show new row
          }
        });
      });

      // remove material
      document.querySelectorAll('.remove-mat').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          let jobId = e.target.dataset.jobId;
          let matId = e.target.dataset.matId;
          let job = jobs.find(j => j.id === jobId);
          if (job) {
            job.materials = job.materials.filter(m => m.id !== matId);
            render();
          }
        });
      });

      // material input updates - using input event with target
      document.querySelectorAll('.mat-desc, .mat-qty, .mat-price, .mat-supplier').forEach(inp => {
        inp.addEventListener('input', function(e) {
          let jIdx = this.dataset.jobIdx;
          let mIdx = this.dataset.matIdx;
          if (jIdx === undefined || mIdx === undefined) return;
          let job = jobs[jIdx];
          let mat = job.materials[mIdx];
          if (this.classList.contains('mat-desc')) mat.desc = this.value;
          else if (this.classList.contains('mat-qty')) mat.qty = parseFloat(this.value) || 0;
          else if (this.classList.contains('mat-price')) mat.price = parseFloat(this.value) || 0;
          else if (this.classList.contains('mat-supplier')) mat.supplier = this.value;
          // update amount column via rerender (simplest)
          render();
        });
      });

      document.getElementById('addJobBtn')?.addEventListener('click', () => {
        jobs.push({ id: genId(), name: 'New job', materials: [] });
        render();
      });

      // indirect events
      document.querySelectorAll('.indirect-name').forEach(inp => {
        inp.addEventListener('input', function(e) {
          let idx = this.dataset.indIdx;
          if (idx !== undefined) indirectItems[idx].name = this.value;
          updateTotalsAndPreview();
        });
      });
      document.querySelectorAll('.indirect-value').forEach(inp => {
        inp.addEventListener('input', function(e) {
          let idx = this.dataset.indIdx;
          if (idx !== undefined) {
            let val = parseFloat(this.value);
            indirectItems[idx].value = isNaN(val) ? 0 : val;
            updateTotalsAndPreview();
          }
        });
      });
      document.querySelectorAll('.remove-indirect-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          let idx = e.target.dataset.indIdx;
          if (idx !== undefined) { indirectItems.splice(idx, 1); render(); }
        });
      });
      document.getElementById('addIndirectBtn')?.addEventListener('click', () => {
        indirectItems.push({ name: 'new cost', value: 150 });
        render();
      });

      // labour & markup
      const labourInp = document.getElementById('labourInput');
      const markupInp = document.getElementById('markupInput');
      if (labourInp) labourInp.addEventListener('input', function() { labour = parseFloat(this.value) || 0; updateTotalsAndPreview(); });
      if (markupInp) markupInp.addEventListener('input', function() { labour = parseFloat(document.getElementById('labourInput')?.value) || 0; markup = parseFloat(this.value) || 0; updateTotalsAndPreview(); });

      // save quote
      document.getElementById('saveQuoteBtn')?.addEventListener('click', saveQuote);

      // pdf
      document.getElementById('downloadPdfBtn')?.addEventListener('click', generatePDF);
    }

    function updateTotalsAndPreview() {
      let previewBody = document.getElementById('previewBody');
      let previewTotals = document.getElementById('previewTotals');
      let grandSpan = document.getElementById('grandTotalDisplay');
      if (!grandSpan) return;

      let materialsTotal = 0;
      if (previewBody) {
        let previewRows = '';
        jobs.forEach(job => {
          job.materials.forEach(mat => {
            let amt = mat.qty * mat.price;
            materialsTotal += amt;
            previewRows += `<tr><td>${job.name} / ${mat.desc}</td><td>${mat.qty}</td><td>${mat.price.toFixed(2)}</td><td>${mat.supplier}</td><td>${amt.toFixed(2)} ZMW</td></tr>`;
          });
        });
        if (previewRows === '') previewRows = '<tr><td colspan="5" style="padding:2rem; text-align:center;">‚Äî no items ‚Äî</td></tr>';
        previewBody.innerHTML = previewRows;
      }

      let indirectSum = indirectItems.reduce((acc, i) => acc + (i.value || 0), 0);
      let labourVal = parseFloat(document.getElementById('labourInput')?.value) || 0;
      let markupVal = parseFloat(document.getElementById('markupInput')?.value) || 0;
      let subtotal = materialsTotal + indirectSum + labourVal;
      let markupAmount = subtotal * (markupVal / 100);
      let grand = subtotal + markupAmount;

      grandSpan.innerText = grand.toFixed(2) + ' ZMW';

      if (previewTotals) {
        let indPreview = '';
        indirectItems.forEach(i => { indPreview += `<div style="display:flex;justify-content:space-between;"><span>${i.name}</span><span>${i.value.toFixed(2)} ZMW</span></div>`; });
        previewTotals.innerHTML = `
          <div style="display:flex; justify-content:space-between; padding:0.5rem 0;"><span>materials total</span><span>${materialsTotal.toFixed(2)} ZMW</span></div>
          ${indPreview}
          <div style="display:flex; justify-content:space-between; padding:0.5rem 0;"><span>indirect total</span><span>${indirectSum.toFixed(2)} ZMW</span></div>
          <div style="display:flex; justify-content:space-between; padding:0.5rem 0;"><span>labour</span><span>${labourVal.toFixed(2)} ZMW</span></div>
          <div style="display:flex; justify-content:space-between; padding:0.5rem 0;"><span>markup (${markupVal}%)</span><span>${markupAmount.toFixed(2)} ZMW</span></div>
          <div style="display:flex; justify-content:space-between; padding:0.5rem 0; font-weight:800; font-size:1.6rem; border-top:2px solid #aac3e0; margin-top:0.5rem;"><span>GRAND TOTAL</span><span>${grand.toFixed(2)} ZMW</span></div>
        `;
      }
    }

    function saveQuote() {
      let materialsTotal = jobs.reduce((acc, job) => acc + job.materials.reduce((s, m) => s + (m.qty * m.price), 0), 0);
      let indirectSum = indirectItems.reduce((acc, i) => acc + (i.value || 0), 0);
      let labourVal = parseFloat(document.getElementById('labourInput')?.value) || 0;
      let markupVal = parseFloat(document.getElementById('markupInput')?.value) || 0;
      let subtotal = materialsTotal + indirectSum + labourVal;
      let grand = subtotal + (subtotal * markupVal / 100);

      let quote = {
        id: Date.now(),
        quoteNum: quoteNum,
        customer: { ...customer },
        jobs: JSON.parse(JSON.stringify(jobs)),
        indirect: JSON.parse(JSON.stringify(indirectItems)),
        labour: labourVal,
        markup: markupVal,
        grand: grand,
        date: new Date().toLocaleDateString()
      };
      savedQuotes.push(quote);
      localStorage.setItem('hazida_quotes', JSON.stringify(savedQuotes));
      renderSavedList();
      alert('Quotation saved!');
    }

    function renderSavedList() {
      let listDiv = document.getElementById('savedList');
      let html = '<h3 style="margin-bottom:1rem;">üìÅ saved quotations</h3>';
      if (savedQuotes.length === 0) {
        html += '<p style="color:#6f8eb0;">‚Äî no saved quotations ‚Äî</p>';
      } else {
        savedQuotes.slice().reverse().forEach((q, idx) => {
          html += `<div class="saved-item">
            <span><strong>#Q-${q.quoteNum}</strong> | ${q.customer.name} | ${q.date} | total: ${q.grand.toFixed(2)} ZMW</span>
            <button class="load-saved" data-idx="${savedQuotes.length - 1 - idx}">load</button>
          </div>`;
        });
      }
      listDiv.innerHTML = html;

      document.querySelectorAll('.load-saved').forEach(btn => {
        btn.addEventListener('click', (e) => {
          let idx = e.target.dataset.idx;
          let quote = savedQuotes[idx];
          if (quote) {
            jobs = quote.jobs;
            indirectItems = quote.indirect;
            customer = quote.customer;
            labour = quote.labour;
            markup = quote.markup;
            render();
            // switch to jobs view
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-target="jobs"]').classList.add('active');
            visibleSection = 'jobs';
            render();
          }
        });
      });
    }

    function generatePDF() {
      let materialsTotal = jobs.reduce((acc, job) => acc + job.materials.reduce((s, m) => s + (m.qty * m.price), 0), 0);
      let indirectSum = indirectItems.reduce((acc, i) => acc + (i.value || 0), 0);
      let labourVal = parseFloat(document.getElementById('labourInput')?.value) || 0;
      let markupVal = parseFloat(document.getElementById('markupInput')?.value) || 0;
      let subtotal = materialsTotal + indirectSum + labourVal;
      let markupAmount = subtotal * (markupVal / 100);
      let grand = subtotal + markupAmount;

      let rows = '';
      jobs.forEach(job => {
        job.materials.forEach(mat => {
          rows += `<tr><td>${job.name} ‚Äì ${mat.desc}</td><td>${mat.qty}</td><td>${mat.price.toFixed(2)} ZMW</td><td>${mat.supplier}</td><td>${(mat.qty*mat.price).toFixed(2)} ZMW</td></tr>`;
        });
      });
      if (!rows) rows = '<tr><td colspan="5">‚Äî</td></tr>';

      let indRows = '';
      indirectItems.forEach(i => { indRows += `<div style="display:flex;justify-content:space-between;"><span>${i.name}</span><span>${i.value.toFixed(2)} ZMW</span></div>`; });

      let printWin = window.open('', '_blank');
      printWin.document.write(`
        <html><head><title>Hazida Quotation</title><style>
          body { font-family: Inter, Arial; padding:2rem; max-width:1000px; margin:auto; }
          h2 { color:#0b2942; } .customer { margin:1rem 0; }
          table { width:100%; border-collapse:collapse; margin:1.5rem 0; }
          th { background:#ecf3fa; padding:0.8rem; text-align:left; }
          td { padding:0.7rem; border-bottom:1px solid #d5e2f0; }
          .totals { background:#f5f9ff; padding:1.5rem; border-radius:20px; margin-top:2rem; }
          .row { display:flex; justify-content:space-between; padding:0.4rem 0; }
          .grand { font-weight:800; font-size:1.8rem; border-top:2px solid #a0b8d0; }
        </style></head>
        <body>
        <h2>HAZIDA LIMITED</h2>
        <div class="customer"><strong>Customer:</strong> ${customer.name}<br><strong>Address:</strong> ${customer.address}</div>
        <table><thead><tr><th>job / material</th><th>qty</th><th>unit price</th><th>supplier</th><th>total</th></tr></thead><tbody>${rows}</tbody></table>
        <div class="totals">
          <div class="row"><span>Materials</span><span>${materialsTotal.toFixed(2)} ZMW</span></div>
          ${indRows}
          <div class="row"><span>Indirect total</span><span>${indirectSum.toFixed(2)} ZMW</span></div>
          <div class="row"><span>Labour</span><span>${labourVal.toFixed(2)} ZMW</span></div>
          <div class="row"><span>Markup ${markupVal}%</span><span>${markupAmount.toFixed(2)} ZMW</span></div>
          <div class="row grand"><span>GRAND TOTAL</span><span>${grand.toFixed(2)} ZMW</span></div>
        </div>
        <p style="margin-top:2rem;">‚Äî Hazida Limited ¬∑ valid for 30 days ‚Äî</p>
        <script>window.onload=()=>window.print();<\/script>
        </body></html>
      `);
      printWin.document.close();
    }

    // initial render
    setupToggles();
    render();
  })();
</script>
</body>
</html>
