<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PENTA | Personnel Expenses Tracker</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">
  <style>
    :root {
      --primary: #1a365d;
      --secondary: #ed8936;
      --border-color: #e2e8f0;
      --success: #48bb78;
      --danger: #f56565;
      --warning: #ed8936;
      --info: #4299e1;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: white;
      color: #171923;
      line-height: 1.6;
      overflow-x: hidden;
      transition: all 0.3s ease;
    }

    /* Simple White Sidebar */
    .sidebar {
      width: 250px;
      background: white;
      color: #171923;
      padding: 1rem 0;
      position: fixed;
      height: 100vh;
      z-index: 1000;
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
      border-right: 1px solid var(--border-color);
      left: 0;
    }

    .sidebar.collapsed {
      transform: translateX(-100%);
      box-shadow: none;
    }

    .sidebar-header {
      padding: 0 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1rem;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--primary);
      border-radius: 0.375rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: white;
    }

    .logo-text h2 {
      font-size: 1.25rem;
      font-weight: 700;
      margin: 0;
      color: var(--primary);
    }

    .logo-text span {
      font-size: 0.75rem;
      color: #718096;
    }

    /* Navigation */
    .nav-section {
      padding: 0 1rem;
      margin-bottom: 1.5rem;
    }

    .nav-section h3 {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #718096;
      margin-bottom: 0.75rem;
    }

    .nav-links {
      list-style: none;
    }

    .nav-item {
      margin-bottom: 0.25rem;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      color: #4a5568;
      text-decoration: none;
      border-radius: 0.375rem;
      transition: all 0.15s ease;
    }

    .nav-link:hover {
      background: #f7fafc;
      color: var(--primary);
    }

    .nav-link.active {
      background: #ebf8ff;
      color: var(--primary);
      font-weight: 500;
    }

    .nav-icon {
      font-size: 1rem;
      width: 20px;
      text-align: center;
    }

    /* Sidebar Toggle */
    .sidebar-toggle {
      position: absolute;
      top: 1rem;
      right: -12px;
      width: 24px;
      height: 24px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 2px solid white;
      font-size: 0.75rem;
      z-index: 1001;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 250px;
      transition: all 0.3s ease;
      padding: 1.5rem;
      min-height: 100vh;
      background: white;
      width: calc(100% - 250px);
    }

    .main-content.expanded {
      margin-left: 0;
      width: 100%;
    }

    /* Top Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .top-left h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      color: var(--primary);
    }

    .top-left p {
      color: #718096;
      margin: 0.25rem 0 0;
      font-size: 0.875rem;
    }

    /* Panel */
    .panel {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      border: 1px solid var(--border-color);
    }

    .panel-heading {
      color: var(--primary);
      padding: 0 0 1rem;
      font-size: 1.25rem;
      font-weight: bold;
      margin: 0 0 1rem;
      border-bottom: 2px solid var(--primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .back-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.375rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
    }

    .back-btn:hover {
      background: #0d2b50;
      color: white;
      text-decoration: none;
    }

    /* Top Actions */
    .top-actions {
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn-action {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      transition: background 0.2s ease;
    }

    .btn-action:hover {
      background: #0d2b50;
      color: white;
      text-decoration: none;
    }

    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--border-color);
    }

    .btn-outline:hover {
      background: #f7fafc;
      border-color: var(--primary);
    }

    /* Controls Panel */
    .controls-panel {
      background: white;
      border-radius: 0.5rem;
      padding: 1rem;
      border: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
      display: none;
    }

    .controls-panel.show {
      display: block;
    }

    .controls-content {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .control-group label {
      font-weight: 500;
      font-size: 0.875rem;
      color: #4a5568;
    }

    .filter-select {
      background: #f7fafc;
      color: #171923;
      border: 1px solid var(--border-color);
      border-radius: 0.375rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      min-width: 150px;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
    }

    /* Form */
    .form-container {
      background: white;
      border-radius: 0.5rem;
      padding: 0;
      border: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .form-container.visible {
      max-height: 1000px;
      opacity: 1;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
    }

    .form-label {
      font-weight: 500;
      font-size: 0.875rem;
      color: #4a5568;
    }

    .form-control {
      padding: 0.5rem 0.75rem;
      background: #f7fafc;
      border: 1px solid var(--border-color);
      border-radius: 0.375rem;
      color: #171923;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    /* Company Summary */
    .company-summary {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .company-card {
      background: white;
      border-radius: 0.5rem;
      padding: 1rem;
      border: 1px solid var(--border-color);
      text-align: center;
      transition: all 0.2s ease;
    }

    .company-card:hover {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transform: translateY(-2px);
    }

    .company-label {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .company-cost {
      font-weight: 700;
      font-size: 1.125rem;
      color: #171923;
      background: #f7fafc;
      padding: 0.375rem;
      border-radius: 0.25rem;
    }

    /* Table */
    .table-responsive {
      overflow-x: auto;
      border-radius: 0.375rem;
      border: 1px solid var(--border-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }

    th {
      text-align: left;
      padding: 0.75rem;
      font-weight: 600;
      background: #f7fafc;
      color: var(--primary);
      font-size: 0.75rem;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border-color);
    }

    td {
      padding: 0.75rem;
      font-size: 0.875rem;
      color: #4a5568;
      border-bottom: 1px solid var(--border-color);
    }

    tr:hover {
      background: #f7fafc;
    }

    .total-row {
      font-weight: 700;
      background: #f7fafc;
    }

    .total-row td {
      border-top: 2px solid var(--primary);
    }

    /* 3-dots Dropdown */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dots-btn {
      background: none;
      border: none;
      color: #718096;
      cursor: pointer;
      padding: 0.25rem;
      font-size: 1rem;
    }

    .dots-btn:hover {
      color: var(--primary);
    }

    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background: white;
      min-width: 120px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 0.375rem;
      border: 1px solid var(--border-color);
      z-index: 100;
    }

    .dropdown-content.show {
      display: block;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      text-decoration: none;
      color: #4a5568;
      font-size: 0.875rem;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .dropdown-item:hover {
      background: #f7fafc;
    }

    .dropdown-item.edit:hover {
      color: var(--primary);
    }

    .dropdown-item.delete:hover {
      color: var(--danger);
    }

    /* Mobile Menu Toggle */
    .mobile-toggle {
      display: none;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.375rem;
      padding: 0.5rem;
      cursor: pointer;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1100;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
        width: 100%;
        padding: 1rem;
      }
      
      .mobile-toggle {
        display: block;
      }
      
      .sidebar-toggle {
        display: none;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .controls-content {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }
      
      .company-summary {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="mobile-toggle" id="mobileToggle">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-toggle" id="sidebarToggle">
      <i class="fas fa-chevron-left" id="toggleIcon"></i>
    </div>
    
    <div class="sidebar-header">
      <div class="logo-container">
        <div class="logo-icon">
          <i class="fas fa-building"></i>
        </div>
        <div class="logo-text">
          <h2>PENTA</h2>
          <span>Construction Pro</span>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="nav-section">
      <h3>Dashboard</h3>
      <ul class="nav-links">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link">
            <i class="fas fa-gauge-high nav-icon"></i>
            <span>Overview</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="projectdashboard.html" class="nav-link">
            <i class="fas fa-diagram-project nav-icon"></i>
            <span>Projects</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="Employees.html" class="nav-link">
            <i class="fas fa-user-tie nav-icon"></i>
            <span>Team</span>
          </a>
        </li>
      </ul>
    </nav>

    <nav class="nav-section">
      <h3>Resources</h3>
      <ul class="nav-links">
        <li class="nav-item">
          <a href="Tool.html" class="nav-link">
            <i class="fas fa-screwdriver-wrench nav-icon"></i>
            <span>Equipment</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="material.html" class="nav-link">
            <i class="fas fa-truck-ramp-box nav-icon"></i>
            <span>Materials</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="inventory.html" class="nav-link">
            <i class="fas fa-warehouse nav-icon"></i>
            <span>Inventory</span>
          </a>
        </li>
      </ul>
    </nav>

    <nav class="nav-section">
      <h3>Management</h3>
      <ul class="nav-links">
        <li class="nav-item">
          <a href="HazidExpense.html" class="nav-link active">
            <i class="fas fa-file-invoice-dollar nav-icon"></i>
            <span>Finances</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="Table.html" class="nav-link">
            <i class="fas fa-chart-column nav-icon"></i>
            <span>Reports</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content" id="mainContent">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="top-left">
        <h1>Personnel Expenses Tracker</h1>
        <p id="currentDate">Track daily personnel expenses by company</p>
      </div>
    </div>

    <!-- Main Panel -->
    <div class="panel">
      <div class="panel-heading">
        <span>Expense Management</span>
        <a href="dashboard.html" class="back-btn">
          <i class="fas fa-arrow-left"></i> Back
        </a>
      </div>

      <!-- Top Actions -->
      <div class="top-actions">
        <button class="btn-action" id="toggleFormBtn">
          <i class="fas fa-plus"></i> Add Entry
        </button>
        <button class="btn-action btn-outline" id="toggleControlsBtn">
          <i class="fas fa-filter"></i> Show Filters
        </button>
      </div>

      <!-- Controls Panel -->
      <div class="controls-panel" id="controlsPanel">
        <div class="controls-content">
          <div class="control-group">
            <label for="weekFilter">Week Filter:</label>
            <select id="weekFilter" class="filter-select">
              <option value="ALL">All Weeks</option>
            </select>
          </div>
          
          <div class="control-group">
            <label for="companyFilter">Company:</label>
            <select id="companyFilter" class="filter-select">
              <option value="ALL">All Companies</option>
              <option value="FPS">FPS</option>
              <option value="HML">HML</option>
              <option value="HL">HL</option>
              <option value="HFL">HFL</option>
              <option value="HEL">HEL</option>
            </select>
          </div>
          
          <button class="btn-action" id="downloadAllBtn">
            <i class="fas fa-download"></i> Download All Data
          </button>
          
          <button class="btn-action btn-outline" id="downloadFilteredBtn">
            <i class="fas fa-download"></i> Download Filtered Data
          </button>
        </div>
      </div>

      <!-- Entry Form -->
      <div class="form-container" id="formContainer">
        <form id="expenseForm" autocomplete="off">
          <input type="hidden" id="editId" value="">
          <div class="form-grid">
            <div class="form-group">
              <label for="expDate" class="form-label">Date</label>
              <input type="date" id="expDate" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="expPersonnel" class="form-label">Personnel</label>
              <input type="text" id="expPersonnel" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="expPurpose" class="form-label">Purpose</label>
              <input type="text" id="expPurpose" class="form-control">
            </div>
            <div class="form-group">
              <label for="expCompany" class="form-label">Company</label>
              <select id="expCompany" class="form-control" required>
                <option value="">--Choose--</option>
                <option value="FPS">FPS</option>
                <option value="HML">HML</option>
                <option value="HL">HL</option>
                <option value="HFL">HFL</option>
                <option value="HEL">HEL</option>
              </select>
            </div>
            <div class="form-group">
              <label for="expTaskId" class="form-label">Task ID</label>
              <input type="text" id="expTaskId" class="form-control">
            </div>
            <div class="form-group">
              <label for="expLocation" class="form-label">Location</label>
              <input type="text" id="expLocation" class="form-control">
            </div>
            <div class="form-group">
              <label for="expTransport" class="form-label">Transport (ZMW)</label>
              <input type="number" id="expTransport" class="form-control" min="0" value="0" step="0.01">
            </div>
            <div class="form-group">
              <label for="expAirtime" class="form-label">Airtime (ZMW)</label>
              <input type="number" id="expAirtime" class="form-control" min="0" value="0" step="0.01">
            </div>
            <div class="form-group">
              <label for="expLunch" class="form-label">Lunch (ZMW)</label>
              <input type="number" id="expLunch" class="form-control" min="0" value="0" step="0.01">
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-action btn-outline" id="cancelEditBtn">
              <i class="fas fa-times"></i> Cancel
            </button>
            <button type="submit" class="btn-action" id="submitBtn">
              <i class="fas fa-save"></i> Add Entry
            </button>
          </div>
          <div id="formError" style="color: var(--danger); font-size: 0.875rem; margin-top: 0.5rem;"></div>
        </form>
      </div>

      <!-- Company Summary -->
      <div class="company-summary" id="companySummary"></div>

      <!-- Expenses Table -->
      <div class="table-responsive">
        <table id="expensesTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Personnel</th>
              <th>Purpose</th>
              <th>Company</th>
              <th>Task ID</th>
              <th>Location</th>
              <th>Transport</th>
              <th>Airtime</th>
              <th>Lunch</th>
              <th>Total</th>
              <th style="width: 50px;">Actions</th>
            </tr>
          </thead>
          <tbody id="expensesTableBody"></tbody>
          <tfoot>
            <tr class="total-row" id="expensesTableTotal"></tr>
          </tfoot>
        </table>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      onSnapshot,
      Timestamp,
      getDocs,
      orderBy,
      query,
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
      authDomain: "project-task-588c4.firebaseapp.com",
      projectId: "project-task-588c4",
      storageBucket: "project-task-588c4.appspot.com",
      messagingSenderId: "411882772509",
      appId: "1:411882772509:web:08d613186c101a99f38ef4",
      measurementId: "G-JMFLFYEM0F"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM Elements
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const toggleIcon = document.getElementById('toggleIcon');
    const mainContent = document.getElementById('mainContent');
    const mobileToggle = document.getElementById('mobileToggle');
    const toggleFormBtn = document.getElementById('toggleFormBtn');
    const toggleControlsBtn = document.getElementById('toggleControlsBtn');
    const formContainer = document.getElementById('formContainer');
    const expenseForm = document.getElementById('expenseForm');
    const controlsPanel = document.getElementById('controlsPanel');
    const weekFilter = document.getElementById('weekFilter');
    const companyFilter = document.getElementById('companyFilter');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const downloadFilteredBtn = document.getElementById('downloadFilteredBtn');
    const companySummary = document.getElementById('companySummary');
    const expensesTableBody = document.getElementById('expensesTableBody');
    const expensesTableTotal = document.getElementById('expensesTableTotal');
    const formError = document.getElementById('formError');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const submitBtn = document.getElementById('submitBtn');
    const editId = document.getElementById('editId');
    
    let allExpenses = [];
    let uniqueWeeks = [];
    let dropdownOpen = null;
    let formVisible = false;
    let controlsVisible = false;
    let isEditing = false;

    // Filter Storage
    const FILTER_STORAGE_KEY = 'personnelExpensesFilters';
    let currentFilters = JSON.parse(localStorage.getItem(FILTER_STORAGE_KEY) || '{"week":"ALL","company":"ALL"}');

    // Check sidebar state from localStorage
    const isSidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (isSidebarCollapsed) {
      sidebar.classList.add('collapsed');
      mainContent.classList.add('expanded');
      toggleIcon.classList.remove('fa-chevron-left');
      toggleIcon.classList.add('fa-chevron-right');
    }

    // Sidebar Toggle
    sidebarToggle.addEventListener('click', function() {
      sidebar.classList.toggle('collapsed');
      mainContent.classList.toggle('expanded');
      
      if (sidebar.classList.contains('collapsed')) {
        toggleIcon.classList.remove('fa-chevron-left');
        toggleIcon.classList.add('fa-chevron-right');
        localStorage.setItem('sidebarCollapsed', 'true');
      } else {
        toggleIcon.classList.remove('fa-chevron-right');
        toggleIcon.classList.add('fa-chevron-left');
        localStorage.setItem('sidebarCollapsed', 'false');
      }
    });

    // Mobile Menu Toggle
    mobileToggle.addEventListener('click', function() {
      sidebar.classList.toggle('active');
    });

    // Close mobile menu when clicking outside
    document.addEventListener('click', function(event) {
      if (window.innerWidth <= 768 && 
          !sidebar.contains(event.target) && 
          !mobileToggle.contains(event.target) &&
          sidebar.classList.contains('active')) {
        sidebar.classList.remove('active');
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      if (dropdownOpen && !dropdownOpen.contains(event.target) && !event.target.classList.contains('dots-btn')) {
        const dropdown = dropdownOpen.querySelector('.dropdown-content');
        if (dropdown) {
          dropdown.classList.remove('show');
        }
        dropdownOpen = null;
      }
    });

    // Toggle form visibility
    toggleFormBtn.addEventListener('click', function() {
      formVisible = !formVisible;
      formContainer.classList.toggle('visible', formVisible);
      this.innerHTML = formVisible 
        ? '<i class="fas fa-eye-slash"></i> Hide Form' 
        : '<i class="fas fa-plus"></i> Add Entry';
    });

    // Toggle controls visibility
    toggleControlsBtn.addEventListener('click', function() {
      controlsVisible = !controlsVisible;
      controlsPanel.classList.toggle('show', controlsVisible);
      this.innerHTML = controlsVisible 
        ? '<i class="fas fa-times"></i> Hide Filters' 
        : '<i class="fas fa-filter"></i> Show Filters';
    });

    // Cancel edit
    cancelEditBtn.addEventListener('click', function() {
      cancelEdit();
    });

    // Save filters
    function saveFilters() {
      localStorage.setItem(FILTER_STORAGE_KEY, JSON.stringify(currentFilters));
    }

    // Apply saved filters
    function applySavedFilters() {
      weekFilter.value = currentFilters.week;
      companyFilter.value = currentFilters.company;
    }

    // Week logic
    function getWeekYear(date) {
      let d = new Date(date);
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
      var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return {week: weekNo, year: d.getUTCFullYear()};
    }

    function getUniqueWeeksFromData(data) {
      const weeksSet = new Set();
      data.forEach(exp => {
        if (exp._weekyear) {
          weeksSet.add(`${exp._weekyear.year}-${exp._weekyear.week}`);
        }
      });
      
      return Array.from(weeksSet)
        .map(w => {
          const [year, week] = w.split('-').map(Number);
          return { year, week, label: `Week ${week}, ${year}` };
        })
        .sort((a, b) => {
          if (a.year !== b.year) return b.year - a.year;
          return b.week - a.week;
        });
    }

    function fillWeekFilter(weeks) {
      let options = '<option value="ALL">All Weeks</option>';
      
      weeks.forEach(w => {
        const value = `${w.year}-${w.week}`;
        const selected = value === currentFilters.week ? ' selected' : '';
        options += `<option value="${value}"${selected}>${w.label}</option>`;
      });
      
      weekFilter.innerHTML = options;
    }

    // Get filtered data
    function getFilteredData() {
      const selectedCompany = currentFilters.company;
      
      let filtered = [...allExpenses];
      
      if (currentFilters.week !== 'ALL') {
        const [selectedYear, selectedWeek] = currentFilters.week.split('-').map(Number);
        filtered = filtered.filter(exp =>
          exp._weekyear && 
          exp._weekyear.week === selectedWeek && 
          exp._weekyear.year === selectedYear
        );
      }
      
      if (selectedCompany !== "ALL") {
        filtered = filtered.filter(exp => exp.company === selectedCompany);
      }
      
      return filtered;
    }

    // Format date
    function formatDate(isoDateStr) {
      const date = new Date(isoDateStr);
      if (isNaN(date.getTime())) return isoDateStr;
      const dd = String(date.getUTCDate()).padStart(2, '0');
      const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
      const yyyy = date.getUTCFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    // Toggle dropdown
    function toggleDropdown(button) {
      const dropdown = button.parentElement.querySelector('.dropdown-content');
      const isOpen = dropdown.classList.contains('show');
      
      document.querySelectorAll('.dropdown-content').forEach(d => {
        d.classList.remove('show');
      });
      
      if (!isOpen) {
        dropdown.classList.add('show');
        dropdownOpen = button.parentElement;
      } else {
        dropdownOpen = null;
      }
    }

    // Cancel edit mode
    function cancelEdit() {
      isEditing = false;
      editId.value = "";
      submitBtn.innerHTML = '<i class="fas fa-save"></i> Add Entry';
      expenseForm.reset();
      formError.textContent = "";
    }

    // Edit entry
    window.editEntry = function(docId, expense) {
      isEditing = true;
      editId.value = docId;
      document.getElementById('expDate').value = expense.date || "";
      document.getElementById('expPersonnel').value = expense.personnel || "";
      document.getElementById('expPurpose').value = expense.purpose || "";
      document.getElementById('expCompany').value = expense.company || "";
      document.getElementById('expTaskId').value = expense.taskId || "";
      document.getElementById('expLocation').value = expense.location || "";
      document.getElementById('expTransport').value = expense.transport || 0;
      document.getElementById('expAirtime').value = expense.airtime || 0;
      document.getElementById('expLunch').value = expense.lunch || 0;
      
      submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Entry';
      
      if (!formVisible) {
        formVisible = true;
        formContainer.classList.add('visible');
        toggleFormBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Form';
      }
      
      if (dropdownOpen) {
        const dropdown = dropdownOpen.querySelector('.dropdown-content');
        if (dropdown) dropdown.classList.remove('show');
        dropdownOpen = null;
      }
    };

    // Delete entry
    window.deleteEntry = async function(docId) {
      if (confirm("Are you sure you want to delete this entry?")) {
        try {
          await deleteDoc(doc(db, "PersonnelExpenses", docId));
          if (dropdownOpen) {
            const dropdown = dropdownOpen.querySelector('.dropdown-content');
            if (dropdown) dropdown.classList.remove('show');
            dropdownOpen = null;
          }
        } catch (err) {
          alert("Error deleting entry: " + (err.message || err));
        }
      }
    };

    // Form submission
    expenseForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      formError.textContent = "";

      const dateVal = document.getElementById('expDate').value;
      const personnelVal = document.getElementById('expPersonnel').value.trim();
      const purposeVal = document.getElementById('expPurpose').value.trim();
      const companyVal = document.getElementById('expCompany').value.trim();
      const taskIdVal = document.getElementById('expTaskId').value.trim();
      const locationVal = document.getElementById('expLocation').value.trim();
      const transportVal = parseFloat(document.getElementById('expTransport').value) || 0;
      const airtimeVal = parseFloat(document.getElementById('expAirtime').value) || 0;
      const lunchVal = parseFloat(document.getElementById('expLunch').value) || 0;

      if (!dateVal || !personnelVal || !companyVal) {
        formError.textContent = "Please fill in required fields: Date, Personnel, and Company.";
        return;
      }

      const expenseData = {
        date: dateVal,
        personnel: personnelVal,
        purpose: purposeVal,
        company: companyVal,
        taskId: taskIdVal,
        location: locationVal,
        transport: transportVal,
        airtime: airtimeVal,
        lunch: lunchVal,
        updatedAt: Timestamp.now()
      };

      try {
        if (isEditing && editId.value) {
          const docRef = doc(db, "PersonnelExpenses", editId.value);
          await updateDoc(docRef, expenseData);
          cancelEdit();
        } else {
          expenseData.createdAt = Timestamp.now();
          await addDoc(collection(db, "PersonnelExpenses"), expenseData);
          expenseForm.reset();
        }
      } catch (err) {
        formError.textContent = "Error saving entry: " + (err.message || err);
      }
    });

    // Render company summary
    function renderCompanySummary() {
      const filtered = getFilteredData();
      const companies = ["FPS", "HML", "HL", "HFL", "HEL"];
      const totals = {};
      companies.forEach(c => totals[c] = 0);
      
      filtered.forEach(exp => {
        if (companies.includes(exp.company)) {
          const t = (parseFloat(exp.lunch) || 0) + (parseFloat(exp.transport) || 0);
          totals[exp.company] += t;
        }
      });
      
      let html = "";
      companies.forEach(c => {
        html += `
          <div class="company-card">
            <div class="company-label">${c}</div>
            <div class="company-cost">ZMW ${totals[c].toLocaleString(undefined,{maximumFractionDigits:2,minimumFractionDigits:2})}</div>
          </div>
        `;
      });
      companySummary.innerHTML = html;
    }

    // Render table
    function renderTable() {
      let filtered = getFilteredData();
      
      filtered.sort((a, b) => {
        if ((a.date || "") === (b.date || "")) {
          return ((b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        }
        return (b.date || "") < (a.date || "") ? -1 : 1;
      });

      expensesTableBody.innerHTML = "";
      let sumTransport = 0, sumAirtime = 0, sumLunch = 0, sumTotal = 0;
      let rowIndex = 0;
      
      filtered.forEach(exp => {
        const tval = (parseFloat(exp.transport) || 0) + (parseFloat(exp.airtime) || 0) + (parseFloat(exp.lunch) || 0);
        sumTransport += parseFloat(exp.transport) || 0;
        sumAirtime += parseFloat(exp.airtime) || 0;
        sumLunch += parseFloat(exp.lunch) || 0;
        sumTotal += tval;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${exp.date ? formatDate(exp.date) : "-"}</td>
          <td>${exp.personnel || "-"}</td>
          <td>${exp.purpose || "-"}</td>
          <td>${exp.company || "-"}</td>
          <td>${exp.taskId || "-"}</td>
          <td>${exp.location || "-"}</td>
          <td>${exp.transport !== undefined ? exp.transport.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${exp.airtime !== undefined ? exp.airtime.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${exp.lunch !== undefined ? exp.lunch.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${tval ? tval.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>
            <div class="dropdown">
              <button class="dots-btn" onclick="toggleDropdown(this)">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div class="dropdown-content">
                <button class="dropdown-item edit" onclick="editEntry('${exp.id}', ${JSON.stringify(exp).replace(/'/g, "\\'")})">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="dropdown-item delete" onclick="deleteEntry('${exp.id}')">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
          </td>
        `;
        expensesTableBody.appendChild(tr);
        rowIndex++;
      });

      let totalRowHTML = '';
      
      if (currentFilters.week === 'ALL') {
        totalRowHTML = `
          <td colspan="6"><b>TOTAL (${filtered.length} entries)</b></td>
          <td>${sumTransport ? sumTransport.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${sumAirtime ? sumAirtime.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${sumLunch ? sumLunch.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${sumTotal ? sumTotal.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td></td>
        `;
      } else {
        const [selectedYear, selectedWeek] = currentFilters.week.split('-').map(Number);
        const satDate = getSaturdayOfWeek(selectedYear, selectedWeek);
        const satString = formatDate(satDate.toISOString().split("T")[0]);
        
        totalRowHTML = `
          <td>${satString}<br><b>TOTAL</b></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td>${sumTransport ? sumTransport.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${sumAirtime ? sumAirtime.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${sumLunch ? sumLunch.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${sumTotal ? sumTotal.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td></td>
        `;
      }
      
      expensesTableTotal.innerHTML = totalRowHTML;
    }

    function getSaturdayOfWeek(year, week) {
      let d = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
      let day = d.getUTCDay();
      let isoSat = new Date(d);
      isoSat.setUTCDate(d.getUTCDate() + (6 - (day === 0 ? 7 : day)));
      return isoSat;
    }

    // Event listeners for filters
    weekFilter.addEventListener('change', function() {
      currentFilters.week = this.value;
      saveFilters();
      renderCompanySummary();
      renderTable();
    });

    companyFilter.addEventListener('change', function() {
      currentFilters.company = this.value;
      saveFilters();
      renderCompanySummary();
      renderTable();
    });

    // Function to generate PDF with all data
    async function generateAllDataPDF() {
      try {
        // Fetch ALL data from Firestore, sorted by date
        const expensesRef = collection(db, "PersonnelExpenses");
        const q = query(expensesRef, orderBy("date", "desc"));
        const querySnapshot = await getDocs(q);
        
        const allData = [];
        querySnapshot.forEach(docSnap => {
          const exp = docSnap.data();
          exp.id = docSnap.id;
          allData.push(exp);
        });

        if (allData.length === 0) {
          alert("No data available to download.");
          return;
        }

        // Create PDF
        generatePDF(allData, "ALL DATA REPORT - COMPLETE", "personnel-expenses-complete");
      } catch (error) {
        console.error("Error generating PDF:", error);
        alert("Error generating PDF: " + error.message);
      }
    }

    // Function to generate PDF with filtered data
    function generateFilteredPDF() {
      const filtered = getFilteredData();
      
      if (filtered.length === 0) {
        alert("No data available with current filters.");
        return;
      }

      let title = '';
      
      if (currentFilters.week === 'ALL') {
        title = 'ALL WEEKS REPORT';
      } else {
        const [selectedYear, selectedWeek] = currentFilters.week.split('-').map(Number);
        title = `WEEK ${selectedWeek}, ${selectedYear}`;
      }
      
      if (currentFilters.company !== "ALL") {
        title += ` - ${currentFilters.company}`;
      }

      // Create PDF with filtered data
      generatePDF(filtered, title, "filtered-report");
    }

    // Main PDF generation function
    function generatePDF(data, title, filenamePrefix) {
      if (data.length === 0) {
        alert("No data to generate PDF.");
        return;
      }

      // Calculate totals
      let totalTransport = 0, totalAirtime = 0, totalLunch = 0, grandTotal = 0;
      const companyTotals = { FPS: 0, HML: 0, HL: 0, HFL: 0, HEL: 0 };
      
      data.forEach(exp => {
        const transport = parseFloat(exp.transport) || 0;
        const airtime = parseFloat(exp.airtime) || 0;
        const lunch = parseFloat(exp.lunch) || 0;
        const total = transport + airtime + lunch;
        
        totalTransport += transport;
        totalAirtime += airtime;
        totalLunch += lunch;
        grandTotal += total;
        
        if (exp.company && companyTotals.hasOwnProperty(exp.company)) {
          companyTotals[exp.company] += total;
        }
      });

      // Create PDF HTML
      let pdfHTML = `
        <div style="font-family: 'Inter', Arial, sans-serif; max-width: 100%;">
          <div style="color: #1a365d; font-size: 18px; font-weight: bold; margin-bottom: 10px; text-align:center;">
            PENTA CONSTRUCTION PRO
          </div>
          <div style="color: #1a365d; font-size: 16px; font-weight: bold; margin-bottom: 5px; text-align:center;">
            PERSONNEL EXPENSES TRACKER - ${title}
          </div>
          <div style="color: #718096; font-size: 12px; margin-bottom: 15px; text-align:center;">
            ${data.length} entries | Generated on ${new Date().toLocaleDateString()}
          </div>
          
          <!-- Company Summary -->
          <div style="margin-bottom:20px;">
            <div style="font-weight:bold;color:#4a5568;font-size:14px;margin-bottom:8px;">Company Totals</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
      `;
      
      Object.keys(companyTotals).forEach(company => {
        pdfHTML += `
          <div style="display:flex;flex-direction:column;align-items:center;background:#f7fafc;border:1px solid #1a365d;border-radius:6px;min-width:90px;padding:8px;margin-bottom:4px;">
            <span style="font-weight:bold;color:#1a365d;font-size:12px;margin-bottom:3px;">${company}</span>
            <span style="font-weight:bold;color:#171923;font-size:14px;background:white;border-radius:4px;padding:4px 8px;">ZMW ${companyTotals[company].toLocaleString(undefined,{maximumFractionDigits:2,minimumFractionDigits:2})}</span>
          </div>
        `;
      });
      
      pdfHTML += `
            </div>
          </div>
          
          <!-- Data Table -->
          <div style="margin-bottom:10px;">
            <table style="width:100%;border-collapse:collapse;background:#fff; font-size: 9px; border: 1px solid #e2e8f0;">
              <thead>
                <tr>
                  <th style="padding:6px;border:1px solid #e2e8f0;background:#f7fafc;font-size:9px;font-weight:bold;">Date</th>
                  <th style="padding:6px;border:1px solid #e2e8f0;background:#f7fafc;font-size:9px;font-weight:bold;">Personnel</th>
                  <th style="padding:6px;border:1px solid #e2e8f0;background:#f7fafc;font-size:9px;font-weight:bold;">Purpose</th>
                  <th style="padding:6px;border:1px solid #e2e8f0;background:#f7fafc;font-size:9px;font-weight:bold;">Company</th>
                  <th style="padding:6px;border:1px solid #e2e8f0;background:#f7fafc;font-size:9px;font-weight:bold;">Task ID</th>
                  <th style="padding:6px;border:1px solid #e2e8f0;background:#f7fafc;font-size:9px;font-weight:bold;">Location</th>
                  <th style="padding:6px;border:1px solid #e2e8f0;background:#f7fafc;font-size:9px;font-weight:bold;">Transport</th>
                  <th style="padding:6px;border:1px solid #e2e8f0;background:#f7fafc;font-size:9px;font-weight:bold;">Airtime</th>
                  <th style="padding:6px;border:1px solid #e2e8f0;background:#f7fafc;font-size:9px;font-weight:bold;">Lunch</th>
                  <th style="padding:6px;border:1px solid #e2e8f0;background:#f7fafc;font-size:9px;font-weight:bold;">Total</th>
                </tr>
              </thead>
              <tbody>
      `;
      
      // Add all rows
      data.forEach(exp => {
        const transport = parseFloat(exp.transport) || 0;
        const airtime = parseFloat(exp.airtime) || 0;
        const lunch = parseFloat(exp.lunch) || 0;
        const total = transport + airtime + lunch;
        
        pdfHTML += `
          <tr>
            <td style="padding:5px;border:1px solid #e2e8f0;font-size:9px;">${exp.date ? formatDate(exp.date) : "-"}</td>
            <td style="padding:5px;border:1px solid #e2e8f0;font-size:9px;">${exp.personnel || "-"}</td>
            <td style="padding:5px;border:1px solid #e2e8f0;font-size:9px;">${exp.purpose || "-"}</td>
            <td style="padding:5px;border:1px solid #e2e8f0;font-size:9px;">${exp.company || "-"}</td>
            <td style="padding:5px;border:1px solid #e2e8f0;font-size:9px;">${exp.taskId || "-"}</td>
            <td style="padding:5px;border:1px solid #e2e8f0;font-size:9px;">${exp.location || "-"}</td>
            <td style="padding:5px;border:1px solid #e2e8f0;font-size:9px;text-align:right;">${transport.toLocaleString(undefined, {maximumFractionDigits:2})}</td>
            <td style="padding:5px;border:1px solid #e2e8f0;font-size:9px;text-align:right;">${airtime.toLocaleString(undefined, {maximumFractionDigits:2})}</td>
            <td style="padding:5px;border:1px solid #e2e8f0;font-size:9px;text-align:right;">${lunch.toLocaleString(undefined, {maximumFractionDigits:2})}</td>
            <td style="padding:5px;border:1px solid #e2e8f0;font-size:9px;text-align:right;">${total.toLocaleString(undefined, {maximumFractionDigits:2})}</td>
          </tr>
        `;
      });
      
      // Add totals row
      pdfHTML += `
              </tbody>
              <tfoot>
                <tr style="font-weight:bold;background:#f7fafc;font-size:9px;">
                  <td colspan="6" style="padding:6px;border:1px solid #e2e8f0;">GRAND TOTAL (${data.length} entries)</td>
                  <td style="padding:6px;border:1px solid #e2e8f0;text-align:right;">${totalTransport.toLocaleString(undefined, {maximumFractionDigits:2})}</td>
                  <td style="padding:6px;border:1px solid #e2e8f0;text-align:right;">${totalAirtime.toLocaleString(undefined, {maximumFractionDigits:2})}</td>
                  <td style="padding:6px;border:1px solid #e2e8f0;text-align:right;">${totalLunch.toLocaleString(undefined, {maximumFractionDigits:2})}</td>
                  <td style="padding:6px;border:1px solid #e2e8f0;text-align:right;">${grandTotal.toLocaleString(undefined, {maximumFractionDigits:2})}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      `;

      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = pdfHTML;
      document.body.appendChild(tempDiv);

      const options = {
        margin: 0.5,
        filename: `${filenamePrefix}-${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 2,
          width: 1400,
          height: tempDiv.scrollHeight,
          windowWidth: 1400
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'landscape',
          compress: true
        }
      };

      html2pdf().set(options).from(tempDiv).save().then(() => {
        document.body.removeChild(tempDiv);
      });
    }

    // Download buttons
    downloadAllBtn.addEventListener('click', generateAllDataPDF);
    downloadFilteredBtn.addEventListener('click', generateFilteredPDF);

    // Load data from Firestore
    onSnapshot(collection(db, "PersonnelExpenses"), (snapshot) => {
      allExpenses = [];
      snapshot.forEach(docSnap => {
        const exp = docSnap.data();
        exp.id = docSnap.id;
        if (exp.date) exp._weekyear = getWeekYear(exp.date);
        allExpenses.push(exp);
      });
      
      uniqueWeeks = getUniqueWeeksFromData(allExpenses);
      fillWeekFilter(uniqueWeeks);
      applySavedFilters();
      renderCompanySummary();
      renderTable();
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Make toggleDropdown available globally
      window.toggleDropdown = toggleDropdown;
      
      // Update current date
      const currentDate = document.getElementById('currentDate');
      const now = new Date();
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      };
      currentDate.textContent = `${now.toLocaleDateString('en-US', options)}`;
      
      // Keyboard shortcuts
      document.addEventListener('keydown', function(event) {
        // Escape to close dropdowns
        if (event.key === 'Escape') {
          document.querySelectorAll('.dropdown-content').forEach(d => {
            d.classList.remove('show');
          });
          dropdownOpen = null;
        }
      });
    });
  </script>
</body>
</html>
