<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>IMS | Personnel Expenses Tracker</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    body { font-family: 'Open Sans', Arial, sans-serif; background: #f4f7fa; margin: 0; }
    .panel { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(44,62,80,0.06); margin: 40px auto; padding: 30px; }
    .panel-heading { background: #1976d2; color: #fff; padding: 18px 24px; font-size: 1.18rem; font-weight: bold; border-radius: 8px 8px 0 0; margin: -30px -30px 24px -30px; }
    #toggle-form-btn {
      margin-bottom: 16px; background: #1976d2; color: #fff; border: none;
      font-size: 15px; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;
      transition: background 0.2s;
    }
    #toggle-form-btn:hover { background: #125195; }
    .controls-bar { display: flex; flex-wrap: wrap; gap: 16px; align-items: center; margin-bottom: 15px; }
    .week-selector { padding: 7px 10px; font-size: 1rem; border-radius: 4px; border: 1px solid #aaa; }
    .company-filter { padding: 7px 10px; font-size: 1rem; border-radius: 4px; border: 1px solid #aaa; }
    .download-btn {
      background:  #1976d2;
      color: #fff;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      padding: 8px 18px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.18s;
    }
    .download-btn:hover { background: #2d669f; }
    form { display: flex; flex-wrap: wrap; gap: 14px 18px; align-items: flex-end; margin-bottom: 22px; }
    form label { font-weight: bold; }
    form input, form select, form button { padding: 7px 12px; font-size: 15px; border-radius: 4px; border: 1px solid #bbb; }
    form input[type="date"] { min-width: 140px;}
    form input[type="text"], form input[type="number"], form select { min-width: 100px;}
    form button { background: #1976d2; color: #fff; border: none; cursor: pointer; font-weight: bold;}
    form button:hover { background: #0d47a1;}
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { padding: 11px 10px; text-align: left; font-size: 15px; }
    th { font-weight: 700; }
    tr:nth-child(even) { background: #f7fafc; }
    tr:hover { background: #eafaf1; }
    .hide { display: none !important; }
    #expense-form-error { color: rgb(208, 208, 208); font-size: 0.97rem; margin-bottom: 7px; }
    .company-summary-row {
      margin-bottom: 18px;
      display: flex;
      gap: 18px;
      flex-wrap: wrap;
      padding-left: 12px;
      padding-bottom: 10px;
    }
    .company-summary-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #f1f6ff;
      border: 2px solid #1976d2;
      border-radius: 8px;
      min-width: 120px;
      max-width: 160px;
      box-shadow: 0 2px 8px #1976d218;
      padding: 10px 20px 8px 20px;
      margin-right: 4px;
      margin-bottom: 8px;
      font-size: 1.07em;
    }
    .company-summary-card .company-label {
      font-weight: bold;
      color: #1976d2;
      font-size: 1.12em;
      margin-bottom: 7px;
    }
    .company-summary-card .company-cost {
      font-weight: bold;
      color: #000000;
      font-size: 1.25em;
      background: #fff;
      border-radius: 6px;
      
      padding: 2px 8px;
      margin-top: 3px;
    }
    .total-row {font-weight:bold; background:#f9eee2;}
    .total-row td {border-top: 2px solid #d1e4fc;}
    .pdf-heading-main {
      color: #1976d2;
      font-size: 1.7em;
      font-weight: bold;
      margin-bottom: 5px;
      text-align:center;
    }
    .pdf-heading-sub {
      color: #333;
      font-size: 1.19em;
      font-weight: bold;
      letter-spacing: 0.06em;
      margin-bottom: 18px;
      text-align:center;
    }
    /* Three dots button and dropdown styling */
    .dots-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: #666;
      padding: 5px 10px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .dots-btn:hover {
      background-color: #f0f0f0;
      color: #1976d2;
    }
    .dropdown-menu {
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-width: 120px;
      z-index: 100;
      display: none;
    }
    .dropdown-menu.show {
      display: block;
    }
    .dropdown-item {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
      border-bottom: 1px solid #f0f0f0;
    }
    .dropdown-item:last-child {
      border-bottom: none;
    }
    .dropdown-item:hover {
      background: #f5f5f5;
    }
    .dropdown-item.edit {
      color: #1976d2;
    }
    .dropdown-item.delete {
      color: #d32f2f;
    }
    .dropdown-container {
      position: relative;
      display: inline-block;
    }
    /* Collapsible controls panel */
    .toggle-controls-btn {
      background: #6c757d;
      color: #fff;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      padding: 8px 18px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.18s;
      margin-bottom: 16px;
    }
    .toggle-controls-btn:hover {
      background: #5a6268;
    }
    .controls-panel {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      display: none;
    }
    .controls-panel.show {
      display: block;
    }
    .controls-panel-content {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .control-group label {
      font-weight: bold;
      font-size: 0.9rem;
      color: #495057;
    }
    .btn.btn-outline{color: white; margin-right: 20PX;}
    @media (max-width: 900px) {
      .panel { padding: 5vw 2vw; }
      form { flex-direction: column; gap: 8px;}
      table th, table td { white-space: nowrap; }
      .company-summary-row { flex-direction: column; gap: 10px;}
      .company-summary-card { min-width:unset; max-width:unset; width:100%; }
      .controls-panel-content { flex-direction: column; align-items: stretch; gap: 15px;}
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div class="panel" id="panel-to-export">
    <div class="panel-heading"><a href="dashboard.html" class="btn btn-outline">
  <i class="fas fa-arrow-left"></i> Back
</a>Personnel & Daily Expenses Tracker</div>
    
    <button class="toggle-controls-btn" id="toggle-controls-btn">
      <i class="fa fa-filter"></i> Show Filters & Tools
    </button>
    
    <div class="controls-panel" id="controls-panel">
      <div class="controls-panel-content">
        <div class="control-group">
          <label for="week-selector">Week Filter:</label>
          <select id="week-selector" class="week-selector">
            <option value="ALL">All Weeks</option>
          </select>
        </div>
        
        <div class="control-group">
          <label for="company-filter">Company:</label>
          <select id="company-filter" class="company-filter">
            <option value="ALL">All Companies</option>
            <option value="FPS">FPS</option>
            <option value="HML">HML</option>
            <option value="HL">HL</option>
            <option value="HFL">HFL</option>
            <option value="HEL">HEL</option>
          </select>
        </div>
        
        <button id="download-week-btn" class="download-btn" type="button">
          <i class="fa fa-download"></i> Download Report
        </button>
      </div>
    </div>

    <button id="toggle-form-btn" type="button">Add Entry</button>
    
    <form id="expense-form" autocomplete="off" class="hide">
      <input type="hidden" id="edit-id" value="">
      <div><label for="exp-date">Date</label><br><input type="date" id="exp-date"></div>
      <div><label for="exp-personnel">Personnel</label><br><input type="text" id="exp-personnel"></div>
      <div><label for="exp-purpose">Purpose</label><br><input type="text" id="exp-purpose"></div>
      <div>
        <label for="exp-company">Company</label><br>
        <select id="exp-company">
          <option value="">--Choose--</option>
          <option value="FPS">FPS</option>
          <option value="HML">HML</option>
          <option value="HL">HL</option>
          <option value="HFL">HFL</option>
          <option value="HEL">HEL</option>
        </select>
      </div>
      <div><label for="exp-taskid">Task ID</label><br><input type="text" id="exp-taskid"></div>
      <div><label for="exp-location">Location</label><br><input type="text" id="exp-location"></div>
      <div><label for="exp-transport">Transport</label><br><input type="number" id="exp-transport" min="0" value="0" step="any"></div>
      <div><label for="exp-airtime">Airtime</label><br><input type="number" id="exp-airtime" min="0" value="0" step="any"></div>
      <div><label for="exp-lunch">Lunch</label><br><input type="number" id="exp-lunch" min="0" value="0" step="any"></div>
      <div style="align-self: flex-end;">
        <button type="submit" id="submit-btn">Add Entry</button>
        <button type="button" id="cancel-edit-btn" class="hide" style="margin-left: 10px; background: #6c757d;">Cancel Edit</button>
      </div>
      <div id="expense-form-error"></div>
    </form>

    <div class="company-summary-row" id="company-summary"></div>
    <div class="table-responsive">
      <table id="expenses-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Personnel</th>
            <th>Purpose</th>
            <th>Company</th>
            <th>Task ID</th>
            <th>Location</th>
            <th>Transport</th>
            <th>Airtime</th>
            <th>Lunch</th>
            <th>Total</th>
            <th style="width: 50px;">•••</th>
          </tr>
        </thead>
        <tbody id="expenses-table-body"></tbody>
        <tfoot>
          <tr class="total-row" id="expenses-table-total-row"></tr>
        </tfoot>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      onSnapshot,
      Timestamp,
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
      authDomain: "project-task-588c4.firebaseapp.com",
      projectId: "project-task-588c4",
      storageBucket: "project-task-588c4.appspot.com",
      messagingSenderId: "411882772509",
      appId: "1:411882772509:web:08d613186c101a99f38ef4",
      measurementId: "G-JMFLFYEM0F"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Elements ---
    const expenseForm = document.getElementById("expense-form");
    const expensesTableBody = document.getElementById("expenses-table-body");
    const expensesTableTotalRow = document.getElementById("expenses-table-total-row");
    const formError = document.getElementById("expense-form-error");
    const toggleFormBtn = document.getElementById("toggle-form-btn");
    const companySummaryDiv = document.getElementById("company-summary");
    const weekSelector = document.getElementById("week-selector");
    const companyFilter = document.getElementById("company-filter");
    const downloadWeekBtn = document.getElementById("download-week-btn");
    const submitBtn = document.getElementById("submit-btn");
    const cancelEditBtn = document.getElementById("cancel-edit-btn");
    const editIdInput = document.getElementById("edit-id");
    const toggleControlsBtn = document.getElementById("toggle-controls-btn");
    const controlsPanel = document.getElementById("controls-panel");

    // --- Toggle Controls Panel ---
    let controlsVisible = false;
    toggleControlsBtn.onclick = function() {
      controlsVisible = !controlsVisible;
      controlsPanel.classList.toggle("show", controlsVisible);
      toggleControlsBtn.innerHTML = controlsVisible ? 
        '<i class="fa fa-times"></i> Hide Filters & Tools' : 
        '<i class="fa fa-filter"></i> Show Filters & Tools';
    };

    // --- Filter Persistence ---
    const FILTER_STORAGE_KEY = 'personnelExpensesFilters';
    
    let savedFilters = JSON.parse(localStorage.getItem(FILTER_STORAGE_KEY) || '{}');
    let currentFilters = {
      week: savedFilters.week || 'ALL',
      company: savedFilters.company || 'ALL'
    };

    function saveFilters() {
      localStorage.setItem(FILTER_STORAGE_KEY, JSON.stringify(currentFilters));
    }

    function applySavedFilters() {
      weekSelector.value = currentFilters.week;
      companyFilter.value = currentFilters.company;
    }

    // --- Show/Hide Form Logic ---
    let formVisible = false;
    let isEditing = false;
    expenseForm.classList.add("hide");
    toggleFormBtn.textContent = "Add Entry";
    toggleFormBtn.onclick = function() {
      formVisible = !formVisible;
      expenseForm.classList.toggle("hide", !formVisible);
      toggleFormBtn.textContent = formVisible ? "Hide Form" : "Add Entry";
    };

    // --- Add/Edit Entry Handler ---
    expenseForm.onsubmit = async function(e) {
      e.preventDefault();
      formError.textContent = "";

      const dateVal = document.getElementById("exp-date").value;
      const personnelVal = document.getElementById("exp-personnel").value.trim();
      const purposeVal = document.getElementById("exp-purpose").value.trim();
      const companyVal = document.getElementById("exp-company").value.trim();
      const taskIdVal = document.getElementById("exp-taskid").value.trim();
      const locationVal = document.getElementById("exp-location").value.trim();
      const transportVal = parseFloat(document.getElementById("exp-transport").value) || 0;
      const airtimeVal = parseFloat(document.getElementById("exp-airtime").value) || 0;
      const lunchVal = parseFloat(document.getElementById("exp-lunch").value) || 0;

      if (!dateVal || !personnelVal || !companyVal) {
        formError.textContent = "Please fill in required fields: Date, Personnel, and Company.";
        return;
      }

      const expenseData = {
        date: dateVal,
        personnel: personnelVal,
        purpose: purposeVal,
        company: companyVal,
        taskId: taskIdVal,
        location: locationVal,
        transport: transportVal,
        airtime: airtimeVal,
        lunch: lunchVal,
        updatedAt: Timestamp.now()
      };

      try {
        if (isEditing && editIdInput.value) {
          const docRef = doc(db, "PersonnelExpenses", editIdInput.value);
          await updateDoc(docRef, expenseData);
          cancelEdit();
        } else {
          expenseData.createdAt = Timestamp.now();
          await addDoc(collection(db, "PersonnelExpenses"), expenseData);
          expenseForm.reset();
        }
      } catch (err) {
        formError.textContent = "Error saving entry: " + (err.message || err);
      }
    };

    // Cancel edit mode
    cancelEditBtn.onclick = cancelEdit;

    function cancelEdit() {
      isEditing = false;
      editIdInput.value = "";
      submitBtn.textContent = "Add Entry";
      cancelEditBtn.classList.add("hide");
      expenseForm.reset();
      if (formVisible) {
        expenseForm.classList.remove("hide");
      }
    }

    // --- Edit Entry Function ---
    function editEntry(docId, expense) {
      isEditing = true;
      editIdInput.value = docId;
      document.getElementById("exp-date").value = expense.date || "";
      document.getElementById("exp-personnel").value = expense.personnel || "";
      document.getElementById("exp-purpose").value = expense.purpose || "";
      document.getElementById("exp-company").value = expense.company || "";
      document.getElementById("exp-taskid").value = expense.taskId || "";
      document.getElementById("exp-location").value = expense.location || "";
      document.getElementById("exp-transport").value = expense.transport || 0;
      document.getElementById("exp-airtime").value = expense.airtime || 0;
      document.getElementById("exp-lunch").value = expense.lunch || 0;
      
      submitBtn.textContent = "Update Entry";
      cancelEditBtn.classList.remove("hide");
      
      if (!formVisible) {
        formVisible = true;
        expenseForm.classList.remove("hide");
        toggleFormBtn.textContent = "Hide Form";
      }
      
      // Hide any open dropdowns
      hideAllDropdowns();
    }

    // --- Delete Entry Function ---
    async function deleteEntry(docId) {
      if (confirm("Are you sure you want to delete this entry?")) {
        try {
          await deleteDoc(doc(db, "PersonnelExpenses", docId));
          // Hide any open dropdowns after deletion
          hideAllDropdowns();
        } catch (err) {
          alert("Error deleting entry: " + (err.message || err));
        }
      }
    }

    // --- Dropdown Management ---
    let activeDropdown = null;

    function showDropdown(dropdownId, docId, expense) {
      // Hide any currently open dropdown
      hideAllDropdowns();
      
      const dropdown = document.getElementById(dropdownId);
      if (dropdown) {
        dropdown.classList.add('show');
        activeDropdown = dropdownId;
        
        // Update dropdown button actions
        const editBtn = dropdown.querySelector('.dropdown-item.edit');
        const deleteBtn = dropdown.querySelector('.dropdown-item.delete');
        
        if (editBtn) {
          editBtn.onclick = () => editEntry(docId, expense);
        }
        if (deleteBtn) {
          deleteBtn.onclick = () => deleteEntry(docId);
        }
        
        // Close dropdown when clicking outside
        setTimeout(() => {
          document.addEventListener('click', closeDropdownOnClickOutside);
        }, 10);
      }
    }

    function hideAllDropdowns() {
      document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
        dropdown.classList.remove('show');
      });
      activeDropdown = null;
      document.removeEventListener('click', closeDropdownOnClickOutside);
    }

    function closeDropdownOnClickOutside(event) {
      if (!event.target.closest('.dropdown-container') && !event.target.closest('.dropdown-menu')) {
        hideAllDropdowns();
      }
    }

    // --- Week Logic ---
    function getWeekYear(date) {
      let d = new Date(date);
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
      var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return {week: weekNo, year: d.getUTCFullYear()};
    }

    function getUniqueWeeksFromData(data) {
      const weeksSet = new Set();
      data.forEach(exp => {
        if (exp._weekyear) {
          weeksSet.add(`${exp._weekyear.year}-${exp._weekyear.week}`);
        }
      });
      
      return Array.from(weeksSet)
        .map(w => {
          const [year, week] = w.split('-').map(Number);
          return { year, week, label: `Week ${week}, ${year}` };
        })
        .sort((a, b) => {
          if (a.year !== b.year) return b.year - a.year;
          return b.week - a.week;
        });
    }

    function fillWeekSelector(weeks) {
      let options = '<option value="ALL">All Weeks</option>';
      
      weeks.forEach(w => {
        const value = `${w.year}-${w.week}`;
        const selected = value === currentFilters.week ? ' selected' : '';
        options += `<option value="${value}"${selected}>${w.label}</option>`;
      });
      
      weekSelector.innerHTML = options;
    }

    // --- Real-time Table Sync ---
    let allExpenses = [];
    let uniqueWeeks = [];
    
    onSnapshot(
      collection(db, "PersonnelExpenses"),
      (snapshot) => {
        allExpenses = [];
        snapshot.forEach(docSnap => {
          const exp = docSnap.data();
          exp.id = docSnap.id;
          if (exp.date) exp._weekyear = getWeekYear(exp.date);
          allExpenses.push(exp);
        });
        
        uniqueWeeks = getUniqueWeeksFromData(allExpenses);
        fillWeekSelector(uniqueWeeks);
        
        renderSummaryBar();
        renderTable();
      }
    );

    // --- Get filtered data based on current filters ---
    function getFilteredData() {
      const selectedCompany = currentFilters.company;
      
      let filtered = [...allExpenses];
      
      if (currentFilters.week !== 'ALL') {
        const [selectedYear, selectedWeek] = currentFilters.week.split('-').map(Number);
        filtered = filtered.filter(exp =>
          exp._weekyear && 
          exp._weekyear.week === selectedWeek && 
          exp._weekyear.year === selectedYear
        );
      }
      
      if (selectedCompany !== "ALL") {
        filtered = filtered.filter(exp => exp.company === selectedCompany);
      }
      
      return filtered;
    }

    function renderSummaryBar() {
      const filtered = getFilteredData();
      const companies = ["FPS", "HML", "HL", "HFL", "HEL"];
      const totals = {};
      companies.forEach(c => totals[c] = 0);
      
      filtered.forEach(exp => {
        if (companies.includes(exp.company)) {
          const t = (parseFloat(exp.lunch) || 0) + (parseFloat(exp.transport) || 0);
          totals[exp.company] += t;
        }
      });
      
      let html = "";
      companies.forEach(c => {
        html += `<div class="company-summary-card">
          <span class="company-label">${c}</span>
          <span class="company-cost">ZMW ${totals[c].toLocaleString(undefined,{maximumFractionDigits:2,minimumFractionDigits:2})}</span>
        </div>`;
      });
      companySummaryDiv.innerHTML = html;
    }

    function getSaturdayOfWeek(year, week) {
      let d = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
      let day = d.getUTCDay();
      let isoSat = new Date(d);
      isoSat.setUTCDate(d.getUTCDate() + (6 - (day === 0 ? 7 : day)));
      return isoSat;
    }

    function renderTable() {
      let filtered = getFilteredData();
      
      filtered.sort((a, b) => {
        if ((a.date || "") === (b.date || "")) {
          return ((b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        }
        return (b.date || "") < (a.date || "") ? -1 : 1;
      });

      expensesTableBody.innerHTML = "";
      let sumTransport = 0, sumAirtime = 0, sumLunch = 0, sumTotal = 0;
      let rowIndex = 0;
      
      filtered.forEach(exp => {
        const tval = (parseFloat(exp.transport) || 0) + (parseFloat(exp.airtime) || 0) + (parseFloat(exp.lunch) || 0);
        sumTransport += parseFloat(exp.transport) || 0;
        sumAirtime += parseFloat(exp.airtime) || 0;
        sumLunch += parseFloat(exp.lunch) || 0;
        sumTotal += tval;
        
        const dropdownId = `dropdown-${rowIndex}`;
        const tRow = document.createElement("tr");
        tRow.innerHTML = `
          <td>${exp.date ? formatDate(exp.date) : "-"}</td>
          <td>${exp.personnel || "-"}</td>
          <td>${exp.purpose || "-"}</td>
          <td>${exp.company || "-"}</td>
          <td>${exp.taskId || "-"}</td>
          <td>${exp.location || "-"}</td>
          <td>${exp.transport !== undefined ? exp.transport : ""}</td>
          <td>${exp.airtime !== undefined ? exp.airtime : ""}</td>
          <td>${exp.lunch !== undefined ? exp.lunch : ""}</td>
          <td>${tval ? tval.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>
            <div class="dropdown-container">
              <button class="dots-btn" onclick="showDropdown('${dropdownId}', '${exp.id}', ${JSON.stringify(exp).replace(/'/g, "\\'")})">
                •••
              </button>
              <div id="${dropdownId}" class="dropdown-menu">
                <div class="dropdown-item edit">
                  <i class="fa fa-edit"></i> Edit
                </div>
                <div class="dropdown-item delete">
                  <i class="fa fa-trash"></i> Delete
                </div>
              </div>
            </div>
          </td>
        `;
        expensesTableBody.appendChild(tRow);
        rowIndex++;
      });

      let totalRowHTML = '';
      
      if (currentFilters.week === 'ALL') {
        totalRowHTML = `
          <td colspan="6"><b>TOTAL (${filtered.length} entries)</b></td>
          <td>${sumTransport ? sumTransport.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${sumAirtime ? sumAirtime.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${sumLunch ? sumLunch.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${sumTotal ? sumTotal.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td></td>
        `;
      } else {
        const [selectedYear, selectedWeek] = currentFilters.week.split('-').map(Number);
        const satDate = getSaturdayOfWeek(selectedYear, selectedWeek);
        const satString = formatDate(satDate.toISOString().split("T")[0]);
        
        totalRowHTML = `
          <td>${satString}<br><b>TOTAL</b></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td>${sumTransport ? sumTransport.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${sumAirtime ? sumAirtime.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${sumLunch ? sumLunch.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td>${sumTotal ? sumTotal.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          <td></td>
        `;
      }
      
      expensesTableTotalRow.innerHTML = totalRowHTML;
    }

    function formatDate(isoDateStr) {
      const date = new Date(isoDateStr);
      if (isNaN(date.getTime())) return isoDateStr;
      const dd = String(date.getUTCDate()).padStart(2, '0');
      const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
      const yyyy = date.getUTCFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    // --- Event Listeners ---
    weekSelector.addEventListener("change", ()=>{
      currentFilters.week = weekSelector.value;
      saveFilters();
      renderSummaryBar(); 
      renderTable();
    });

    companyFilter.addEventListener("change", ()=>{
      currentFilters.company = companyFilter.value;
      saveFilters();
      renderSummaryBar(); 
      renderTable();
    });

    // Apply saved filters on load
    applySavedFilters();

    // --- Download Filtered Report Logic ---
    downloadWeekBtn.onclick = function() {
      const filtered = getFilteredData();
      const selectedCompany = currentFilters.company;
      
      let title = '';
      let filename = '';
      
      if (currentFilters.week === 'ALL') {
        title = 'ALL WEEKS REPORT';
        filename = `all-weeks-report-${new Date().toISOString().split('T')[0]}`;
      } else {
        const [selectedYear, selectedWeek] = currentFilters.week.split('-').map(Number);
        title = `WEEK ${selectedWeek}, ${selectedYear}`;
        filename = `week${selectedWeek}-${selectedYear}`;
      }
      
      if (selectedCompany !== "ALL") {
        title += ` - ${selectedCompany}`;
        filename += `-${selectedCompany}`;
      }
      
      const sortedForPDF = [...filtered].sort((a, b) => {
        if ((a.date || "") === (b.date || "")) {
          return ((b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        }
        return (b.date || "") < (a.date || "") ? -1 : 1;
      });
      
      let pdfHTML = `
        <div style="font-family: Arial, sans-serif; max-width: 100%; font-size: 10px;">
          <div style="color: #1976d2; font-size: 16px; font-weight: bold; margin-bottom: 5px; text-align:center;">
            Personnel & Daily Expenses Tracker
          </div>
          <div style="color: #333; font-size: 12px; font-weight: bold; letter-spacing: 0.06em; margin-bottom: 5px; text-align:center;">
            ${title}
          </div>
          <div style="color: #666; font-size: 11px; margin-top: 2px; margin-bottom: 8px; text-align:center;">
            ${filtered.length} entries | Generated on ${new Date().toLocaleDateString()}
          </div>
      `;

      if (selectedCompany === "ALL") {
        pdfHTML += `<div style="margin-bottom:8px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">`;
        
        const companies = ["FPS", "HML", "HL", "HFL", "HEL"];
        const totals = {};
        companies.forEach(c => totals[c] = 0);

        filtered.forEach(exp => {
          if (companies.includes(exp.company)) {
            const t = (parseFloat(exp.lunch) || 0) + (parseFloat(exp.transport) || 0);
            totals[exp.company] += t;
          }
        });
        companies.forEach(c => {
          pdfHTML += `
            <div style="display:flex;flex-direction:column;align-items:center;background:#f1f6ff;border:1px solid #1976d2;border-radius:6px;min-width:90px;max-width:110px;padding:6px 10px 4px 10px;margin-right:2px;margin-bottom:4px;">
              <span style="font-weight:bold;color:#1976d2;font-size:10px;margin-bottom:3px;">${c}</span>
              <span style="font-weight:bold;color:#b71c1c;font-size:11px;background:#fff;border-radius:4px;border:1px solid #b71c1c;padding:1px 4px;">ZMW ${totals[c].toLocaleString(undefined,{maximumFractionDigits:2,minimumFractionDigits:2})}</span>
            </div>
          `;
        });
        pdfHTML += `</div>`;
      }

      pdfHTML += `
        <table style="width:100%;border-collapse:collapse;background:#fff;margin-bottom:10px; font-size: 9px;">
          <thead>
            <tr>
              <th style="padding:4px 3px;border:1px solid #ddd;background:#f1f6ff;font-size:9px;">Date</th>
              <th style="padding:4px 3px;border:1px solid #ddd;background:#f1f6ff;font-size:9px;">Personnel</th>
              <th style="padding:4px 3px;border:1px solid #ddd;background:#f1f6ff;font-size:9px;">Purpose</th>
              <th style="padding:4px 3px;border:1px solid #ddd;background:#f1f6ff;font-size:9px;">Company</th>
              <th style="padding:4px 3px;border:1px solid #ddd;background:#f1f6ff;font-size:9px;">Task ID</th>
              <th style="padding:4px 3px;border:1px solid #ddd;background:#f1f6ff;font-size:9px;">Location</th>
              <th style="padding:4px 3px;border:1px solid #ddd;background:#f1f6ff;font-size:9px;">Transport</th>
              <th style="padding:4px 3px;border:1px solid #ddd;background:#f1f6ff;font-size:9px;">Airtime</th>
              <th style="padding:4px 3px;border:1px solid #ddd;background:#f1f6ff;font-size:9px;">Lunch</th>
              <th style="padding:4px 3px;border:1px solid #ddd;background:#f1f6ff;font-size:9px;">Total</th>
            </tr>
          </thead>
          <tbody>
      `;
      let sumTransport = 0, sumAirtime = 0, sumLunch = 0, sumTotal = 0;
      sortedForPDF.forEach(exp => {
        const tval = (parseFloat(exp.transport) || 0) + (parseFloat(exp.airtime) || 0) + (parseFloat(exp.lunch) || 0);
        sumTransport += parseFloat(exp.transport) || 0;
        sumAirtime += parseFloat(exp.airtime) || 0;
        sumLunch += parseFloat(exp.lunch) || 0;
        sumTotal += tval;
        
        pdfHTML += `
          <tr>
            <td style="padding:4px 3px;border:1px solid #eee;font-size:9px;">${exp.date ? formatDate(exp.date) : "-"}</td>
            <td style="padding:4px 3px;border:1px solid #eee;font-size:9px;">${exp.personnel || "-"}</td>
            <td style="padding:4px 3px;border:1px solid #eee;font-size:9px;">${exp.purpose || "-"}</td>
            <td style="padding:4px 3px;border:1px solid #eee;font-size:9px;">${exp.company || "-"}</td>
            <td style="padding:4px 3px;border:1px solid #eee;font-size:9px;">${exp.taskId || "-"}</td>
            <td style="padding:4px 3px;border:1px solid #eee;font-size:9px;">${exp.location || "-"}</td>
            <td style="padding:4px 3px;border:1px solid #eee;font-size:9px;text-align:right;">${exp.transport !== undefined ? exp.transport.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
            <td style="padding:4px 3px;border:1px solid #eee;font-size:9px;text-align:right;">${exp.airtime !== undefined ? exp.airtime.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
            <td style="padding:4px 3px;border:1px solid #eee;font-size:9px;text-align:right;">${exp.lunch !== undefined ? exp.lunch.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
            <td style="padding:4px 3px;border:1px solid #eee;font-size:9px;text-align:right;">${tval ? tval.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
          </tr>
        `;
      });
      
      pdfHTML += `
          </tbody>
          <tfoot>
            <tr style="font-weight:bold;background:#f9eee2;font-size:9px;">
      `;
      
      if (currentFilters.week === 'ALL') {
        pdfHTML += `
              <td colspan="6" style="padding:4px 3px;border:1px solid #eee;">TOTAL (${filtered.length} entries)</td>
        `;
      } else {
        const [selectedYear, selectedWeek] = currentFilters.week.split('-').map(Number);
        const satDate = getSaturdayOfWeek(selectedYear, selectedWeek);
        const satString = formatDate(satDate.toISOString().split("T")[0]);
        pdfHTML += `
              <td style="padding:4px 3px;border:1px solid #eee;">${satString}<br><b>TOTAL</b></td>
              <td style="border:1px solid #eee;"></td>
              <td style="border:1px solid #eee;"></td>
              <td style="border:1px solid #eee;"></td>
              <td style="border:1px solid #eee;"></td>
              <td style="border:1px solid #eee;"></td>
        `;
      }
      
      pdfHTML += `
              <td style="padding:4px 3px;border:1px solid #eee;text-align:right;">${sumTransport ? sumTransport.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
              <td style="padding:4px 3px;border:1px solid #eee;text-align:right;">${sumAirtime ? sumAirtime.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
              <td style="padding:4px 3px;border:1px solid #eee;text-align:right;">${sumLunch ? sumLunch.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
              <td style="padding:4px 3px;border:1px solid #eee;text-align:right;">${sumTotal ? sumTotal.toLocaleString(undefined, {maximumFractionDigits:2}) : ""}</td>
            </tr>
          </tfoot>
        </table>
      </div>
      `;

      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = pdfHTML;
      document.body.appendChild(tempDiv);

      html2pdf().from(tempDiv).set({
        margin: 0.3,
        filename: `${filename}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 2,
          width: 1200,
          height: tempDiv.scrollHeight
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'landscape',
          compress: true
        }
      }).save().then(() => {
        document.body.removeChild(tempDiv);
      });
    };

    // Make functions available globally for onclick handlers
    window.showDropdown = showDropdown;
    window.editEntry = editEntry;
    window.deleteEntry = deleteEntry;
  </script>
</body>
</html>
