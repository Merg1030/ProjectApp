<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Tasks | Task Management</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Bootstrap 5 (minimal, only for grid if needed) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">
    <style>
        /* ===== SIDEBAR STYLES (exactly from first file) ===== */
        :root {
            --primary: #1a365d;
            --secondary: #ed8936;
            --border-color: #e2e8f0;
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --info: #4299e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: white;
            color: #171923;
            line-height: 1.6;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }

        /* Simple White Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            color: #171923;
            padding: 1rem 0;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
            border-right: 1px solid var(--border-color);
            left: 0;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
            box-shadow: none;
        }

        .sidebar-header {
            padding: 0 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: var(--primary);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
        }

        .logo-text h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
            color: var(--primary);
        }

        .logo-text span {
            font-size: 0.75rem;
            color: #718096;
        }

        /* Navigation */
        .nav-section {
            padding: 0 1rem;
            margin-bottom: 1.5rem;
        }

        .nav-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #718096;
            margin-bottom: 0.75rem;
        }

        .nav-links {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.25rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            color: #4a5568;
            text-decoration: none;
            border-radius: 0.375rem;
            transition: all 0.15s ease;
        }

        .nav-link:hover {
            background: #f7fafc;
            color: var(--primary);
        }

        .nav-link.active {
            background: #ebf8ff;
            color: var(--primary);
            font-weight: 500;
        }

        .nav-icon {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        /* Sidebar Toggle */
        .sidebar-toggle {
            position: absolute;
            top: 1rem;
            right: -12px;
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid white;
            font-size: 0.75rem;
            z-index: 1001;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            transition: margin-left 0.3s ease, width 0.3s ease;
            padding: 0;
            min-height: 100vh;
            background: white;
            width: calc(100% - 250px);
        }

        .main-content.expanded {
            margin-left: 0;
            width: 100%;
        }

        /* Mobile Menu Toggle */
        .mobile-toggle {
            display: none;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem;
            cursor: pointer;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1100;
        }

        /* ===== ORIGINAL TASK PAGE STYLES (adapted) ===== */
        .container { 
            width: 100%;
            padding: 1.5rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px 0;
            background: #ffffff;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .project-title { 
            font-size: 24px; 
            margin: 0;
            color: #000000; 
            font-weight: 700;
        }
        
        .btn { 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 16px; 
            border-radius: 4px; 
            font-weight: 600; 
            cursor: pointer; 
            text-decoration: none; 
            border: 1px solid #000000; 
            font-size: 14px; 
            transition: all 0.2s ease; 
            background: #ffffff;
            color: #000000;
        }
        
        .btn:hover { 
            background: #f0f0f0; 
        }
        
        .btn-primary { 
            background: #000000; 
            color: #ffffff; 
            border: 1px solid #000000;
        }
        
        .btn-primary:hover { 
            background: #333333;
        }
        
        .filters-bar { 
            display: flex; 
            flex-wrap: wrap; 
            align-items: center; 
            gap: 15px; 
            padding: 15px 0; 
            background: #f8f8f8; 
            border-bottom: 1px solid #ddd;
        }
        
        .filter-group { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            background: #ffffff; 
            border-radius: 4px; 
            padding: 8px 12px; 
            border: 1px solid #ddd;
            flex: 1 1 150px; 
            min-width: 150px; 
            max-width: 200px; 
        }
        
        .filter-label { 
            font-size: 12px; 
            font-weight: 600; 
            color: #000000; 
            text-transform: uppercase;
        }
        
        select { 
            border: none; 
            background: transparent; 
            color: #000000; 
            font-size: 14px; 
            font-weight: 500;
            width: 100%;
            outline: none;
            cursor: pointer;
        }
        
        .search-container {
            display: flex;
            align-items: center;
            background: #ffffff;
            border-radius: 4px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            flex: 1 1 250px;
            min-width: 250px;
            max-width: 350px;
        }
        
        .search-input {
            border: none;
            background: transparent;
            padding: 0 10px;
            width: 100%;
            outline: none;
            color: #000000;
            font-size: 14px;
        }
        
        .search-input::placeholder {
            color: #888;
        }
        
        .main-table-wrap { 
            display: flex; 
            flex-direction: row; 
            align-items: stretch; 
            width: 100%; 
            height: 100%;
            transition: all 0.3s; 
            gap: 0;
            overflow: hidden;
            flex: 1;
        }
        
        .card { 
            background: #ffffff; 
            padding: 0;
            border-radius: 0;
            border-right: 1px solid #ddd; 
            margin-bottom: 0; 
            flex: 1 1 70%; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .card.full-width { 
            flex: 1 1 100% !important;
            border-right: none;
        }
        
        .table-responsive { 
            width: 100%; 
            overflow: auto;
            flex: 1;
        }
        
        .task-table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            font-size: 14px;
            min-width: 1200px;
        }
        
        .task-table th, .task-table td { 
            padding: 12px 15px; 
            border-bottom: 1px solid #ddd; 
            text-align: left;
            white-space: nowrap;
        }
        
        .task-table th { 
            background: #f8f8f8; 
            font-weight: 600; 
            font-size: 12px; 
            text-transform: uppercase; 
            position: sticky; 
            top: 0; 
            z-index: 1;
            color: #000000;
            border-bottom: 2px solid #000000;
        }
        
        .task-table tr:nth-child(even) { 
            background: #f8f8f8;
        }
        
        .task-table tr:hover { 
            background: #f0f0f0;
        }
        
        .status-badge { 
            display: inline-flex; 
            align-items: center; 
            gap: 6px;
            padding: 6px 12px; 
            border-radius: 4px; 
            font-size: 12px; 
            font-weight: 600; 
        }
        
        .status-completed { 
            background: #e8e8e8; 
            color: #000000; 
            border: 1px solid #ccc; 
        }
        
        .status-ongoing { 
            background: #f0f0f0; 
            color: #000000; 
            border: 1px solid #ccc; 
        }
        
        .status-pending { 
            background: #f8f8f8; 
            color: #000000; 
            border: 1px solid #ccc; 
        }
        
        .status-overdue {
            background: #f0f0f0;
            color: #000000;
            border: 1px solid #ccc;
        }
        
        .editable { 
            cursor: pointer; 
            border-radius: 4px; 
            transition: background 0.2s;
        }
        
        .editable:hover { 
            background: #f0f0f0;
        }
        
        .editable-input, .editable-select { 
            width: 100%; 
            padding: 6px 10px !important; 
            border-radius: 4px; 
            border: 1px solid #ccc; 
            background: #ffffff; 
            color: #000000; 
            font-size: 14px; 
        }
        
        .cost-badge { 
            display: inline-block; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            font-weight: 600; 
            background: #f0f0f0; 
            color: #000000; 
            border: 1px solid #ccc; 
        }
        
        .empty-state { 
            text-align: center; 
            padding: 60px 20px; 
            color: #888; 
        }
        
        .empty-state i { 
            font-size: 48px; 
            margin-bottom: 20px;
            color: #ddd;
        }
        
        .gantt-table-card { 
            background: #ffffff; 
            border-radius: 0;
            border: none;
            margin-bottom: 0; 
            min-width: 400px; 
            max-width: 100%; 
            flex: 1 1 30%; 
            display: flex; 
            flex-direction: column; 
            justify-content: stretch; 
            transition: max-width 0.3s, min-width 0.3s;
            border-left: 1px solid #ddd;
        }
        
        .gantt-table-card.hide { 
            display: none !important; 
        }
        
        .gantt-table-header { 
            padding: 15px; 
            display: flex; 
            align-items: center; 
            font-size: 16px; 
            color: #000000; 
            font-weight: 600; 
            justify-content: space-between; 
            border-bottom: 1px solid #ddd;
            background: #f8f8f8;
        }
        
        .gantt-table-toggle { 
            color: #000000; 
            background: none; 
            border: none; 
            font-size: 16px; 
            cursor: pointer; 
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .gantt-table-toggle:hover {
            background: #f0f0f0;
        }
        
        .toggle-bar { 
            position: absolute; 
            right: 0; 
            top: 50%; 
            transform: translateY(-50%);
            z-index: 50; 
            background: #000000; 
            color: #ffffff; 
            border: none; 
            border-radius: 4px 0 0 4px; 
            padding: 10px 6px; 
            font-size: 14px; 
            cursor: pointer; 
            min-width: 20px; 
            text-align: center;
        }
        
        .toggle-bar:hover { 
            background: #333333; 
        }
        
        .gantt-table-scroll { 
            overflow: auto;
            height: 100%; 
            padding: 15px;
        }
        
        .gantt-table { 
            width: max-content; 
            border-collapse: collapse; 
            font-size: 13px; 
            min-width: 600px;
        }
        
        .gantt-table th, .gantt-table td { 
            border: 1px solid #ddd; 
            padding: 6px 8px; 
            text-align: center; 
            background: #ffffff;
        }
        
        .gantt-table th { 
            background: #f8f8f8; 
            color: #000000; 
            position: sticky; 
            top: 0; 
            z-index: 2; 
            font-size: 12px;
            font-weight: 600;
            border-bottom: 2px solid #000000;
        }
        
        .gantt-bar { 
            background: #000000; 
            border-radius: 2px; 
            height: 12px; 
            width: 90%; 
            margin: 0 auto;
        }
        
        .gantt-bar-empty { 
            background: #f8f8f8; 
            border: 1px dashed #ccc;
        }
        
        .subtask-row td { 
            background: #f8f8f8; 
            color: #000000 !important; 
        }
        
        .subtask-row td.subtask-desc { 
            padding-left: 40px !important; 
        }
        
        .subtask-arrow { 
            text-align: left; 
            padding-left: 20px; 
            color: #000000; 
            font-size: 14px; 
        }
        
        .main-task-expand { 
            cursor: pointer; 
            color: #000000; 
            margin-right: 8px; 
        }
        
        .subsubtask-row td { 
            background: #f0f0f0; 
            color: #000000 !important; 
        }
        
        .action-btn {
            background: #ffffff;
            color: #000000;
            border: 1px solid #000000;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin: 2px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .action-btn:hover {
            background: #000000;
            color: #ffffff;
        }
        
        .delete-btn {
            background: #ffffff;
            color: #000000;
            border: 1px solid #000000;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
        }
        
        .delete-btn:hover {
            background: #000000;
            color: #ffffff;
        }
        
        .total-row {
            font-weight: 700;
            background-color: #f8f8f8 !important;
            border-top: 2px solid #000000;
        }
        
        .total-row td {
            border-top: 2px solid #000000;
        }
        
        .category-header {
            background: #000000;
            color: #ffffff;
            padding: 20px 25px;
            border-radius: 0;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .category-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .category-icon {
            font-size: 20px;
        }
        
        .category-back-btn {
            background: #ffffff;
            color: #000000;
            border: 1px solid #ffffff;
        }
        
        .category-back-btn:hover {
            background: #f0f0f0;
            color: #000000;
        }
        
        .hide-completed-btn {
            background: #ffffff;
            color: #000000;
            border: 1px solid #000000;
        }
        
        .hide-completed-btn:hover {
            background: #f0f0f0;
        }
        
        .show-completed-btn {
            background: #ffffff;
            color: #000000;
            border: 1px solid #000000;
        }
        
        .show-completed-btn:hover {
            background: #f0f0f0;
        }
        
        .today-highlight {
            background-color: #f0f0f0 !important;
            color: #000000 !important;
            font-weight: bold;
            border: 1px solid #000000 !important;
        }
        
        .current-month {
            background-color: #f8f8f8 !important;
        }
        
        .project-info-container {
            margin: 0;
            padding: 20px 0;
            background: #f8f8f8;
            border-bottom: 1px solid #ddd;
        }
        
        .project-header-card {
            background: #ffffff;
            border-radius: 4px;
            padding: 20px;
            border: 1px solid #ddd;
        }
        
        .project-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .project-label {
            font-weight: 600;
            color: #000000;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .project-value {
            font-size: 16px;
            color: #000000;
            font-weight: 500;
        }
        
        @media (max-width: 1024px) {
            .main-table-wrap { 
                flex-direction: column; 
                height: auto;
                min-height: 0;
                flex: 1;
                overflow: auto;
            }
            .gantt-table-card { 
                max-width: 100%; 
                min-width: 100%;
                border-left: none;
                border-top: 1px solid #ddd;
                flex: 0 0 300px;
            }
            .card { 
                flex: 1 1 auto;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
            .toggle-bar {
                right: 20px;
                top: auto;
                bottom: 20px;
                border-radius: 4px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            .mobile-toggle {
                display: block;
            }
            .sidebar-toggle {
                display: none;
            }
            .header { 
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            .filters-bar {
                padding: 10px 0;
            }
            .filter-group {
                min-width: 120px;
                flex: 1 1 120px;
            }
            .search-container {
                min-width: 100%;
                max-width: 100%;
            }
        }
        
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
        .table-responsive {
            overflow: auto !important;
        }
        .gantt-table-scroll {
            overflow: auto !important;
        }
        body {
            overflow: auto;
        }
        .container {
            min-height: calc(100vh - 2rem);
            height: auto;
            overflow: auto;
        }
        .main-content {
            padding: 0;
        }
        .main-content .container {
            padding: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-toggle" id="mobileToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar (exact copy from first file) -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-chevron-left" id="toggleIcon"></i>
        </div>
        
        <div class="sidebar-header">
            <div class="logo-container">
                <div class="logo-icon">
                    <i class="fas fa-building"></i>
                </div>
                <div class="logo-text">
                    <h2>PENTA</h2>
                    <span>Construction Pro</span>
                </div>
            </div>
        </div>

        <nav class="nav-section">
            <h3>Dashboard</h3>
            <ul class="nav-links">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <i class="fas fa-gauge-high nav-icon"></i>
                        <span>Overview</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="projectdashboard.html" class="nav-link">
                        <i class="fas fa-diagram-project nav-icon"></i>
                        <span>Projects</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="Employees.html" class="nav-link">
                        <i class="fas fa-user-tie nav-icon"></i>
                        <span>Team</span>
                    </a>
                </li>
            </ul>
        </nav>

        <nav class="nav-section">
            <h3>Resources</h3>
            <ul class="nav-links">
                <li class="nav-item">
                    <a href="Tool.html" class="nav-link">
                        <i class="fas fa-screwdriver-wrench nav-icon"></i>
                        <span>Equipment</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="material.html" class="nav-link">
                        <i class="fas fa-truck-ramp-box nav-icon"></i>
                        <span>Materials</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="inventory.html" class="nav-link">
                        <i class="fas fa-warehouse nav-icon"></i>
                        <span>Inventory</span>
                    </a>
                </li>
            </ul>
        </nav>

        <nav class="nav-section">
            <h3>Management</h3>
            <ul class="nav-links">
                <li class="nav-item">
                    <a href="Accountsdash.html" class="nav-link">
                        <i class="fas fa-file-invoice-dollar nav-icon"></i>
                        <span>Finances</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="Table.html" class="nav-link">
                        <i class="fas fa-chart-column nav-icon"></i>
                        <span>Reports</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content with sidebar integration - takes FULL WIDTH when sidebar hidden -->
    <main class="main-content" id="mainContent">
        <div class="container">
            <!-- Category Header -->
            <div class="category-header" id="categoryHeader">
                <div class="category-title">
                    <i class="fas fa-tasks category-icon" id="categoryIcon"></i>
                    <span id="categoryTitle">All Tasks</span>
                </div>
                <a href="cards.html?id=PROJECT_ID" class="btn category-back-btn" id="backToCategoriesBtn">
                    <i class="fas fa-layer-group"></i> Back to Categories
                </a>
            </div>

            <!-- Project Info - ONLY PROJECT MANAGER CHRISTOPHER, supervisor removed as requested -->
            <div class="project-info-container">
                <div class="project-header-card">
                    <div class="project-details-grid">
                        <div class="detail-item">
                            <a href="dashboard.html" class="btn btn-outline">
                                <i class="fas fa-arrow-left"></i> Back to Dashboard
                            </a>
                            <span class="project-label">PROJECT MANAGER:</span>
                            <span class="project-value">Christopher Chishela</span>
                        </div>
                        <!-- SUPERVISOR LINE REMOVED per request -->
                    </div>
                </div>
            </div>

            <div class="header">
                <div class="actions">
                    <button class="btn btn-primary action-btn" id="addTaskBtn">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                    <button class="btn hide-completed-btn" id="toggleCompletedBtn">
                        <i class="fas fa-eye-slash"></i> Hide Completed
                    </button>
                    <a href="#" class="btn btn-outline action-btn" id="completedtasksBtn">
                        <i class="fas fa-check-circle"></i> Completed Tasks
                    </a>
                </div>
            </div>

            <div class="filters-bar">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search all fields...">
                </div>
                <div class="filter-group"><span class="filter-label">Status:</span>
                    <select id="statusFilter">
                        <option value="">All</option>
                        <option value="COMPLETED">Completed</option>
                        <option value="ONGOING">Ongoing</option>
                        <option value="PENDING">Pending</option>
                        <option value="OVERDUE">Overdue</option>
                    </select>
                </div>
                <div class="filter-group"><span class="filter-label">Month:</span>
                    <select id="monthFilter">
                        <option value="">All Months</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="filter-group"><span class="filter-label">Year:</span>
                    <select id="yearFilter">
                        <option value="">All Years</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
            </div>

            <div class="main-table-wrap" id="mainTableWrap" style="position:relative;">
                <div class="card" id="mainCard">
                    <div class="card-header" style="padding: 10px 0 15px 0;">
                        <h2 class="card-title" style="font-size:14px; margin:0; color:#000000; font-weight:500">
                            <i class="fas fa-tasks"></i> <span id="tasksTitle">All Tasks</span>
                        </h2>
                    </div>
                    <div class="table-responsive">
                        <table class="task-table" id="taskTable">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>TASK ID</th>
                                    <th>TASK LINE</th>
                                    <th>DESCRIPTION</th>
                                    <th>ASSIGNED</th>
                                    <th class="editable">STATUS</th>
                                    <th class="editable">START DATE</th>
                                    <th class="editable">END DATE</th>
                                    <th>GIVE TARGET</th>
                                    <th class="duration">DURATION (Hrs)</th>
                                    <th>MATERIAL COST</th>
                                    <th>MAN COST</th>
                                    <th>TOTAL COST</th>
                                    <th>LOCATION</th>
                                    <th>ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="taskList"></tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="9" style="text-align: right; font-weight: bold;">TOTAL:</td>
                                    <td id="totalDuration"></td>
                                    <td id="totalMaterialCost"></td>
                                    <td id="totalManCost"></td>
                                    <td id="totalCost"></td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="empty-state" id="emptyState" style="display:none;">
                        <i class="fas fa-tasks"></i>
                        <p>No tasks found.</p>
                    </div>
                </div>
                <!-- Gantt Chart Side -->
                <div class="gantt-table-card hide" id="ganttTableCard">
                    <div class="gantt-table-header">
                        <span><i class="fas fa-calendar-alt"></i> Gantt Calendar</span>
                        <div>
                            <button class="current-month-btn" id="currentMonthBtn" title="Show current month">Current Month</button>
                            <button class="gantt-table-toggle action-btn" id="toggleGanttBtn" title="Show/hide calendar"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>
                    <div class="gantt-table-scroll" id="ganttTableScroll" style="height:100%">
                        <table class="gantt-table" style="height:100%">
                            <thead id="ganttCalendarHead"></thead>
                            <tbody id="ganttCalendarBody"></tbody>
                        </table>
                    </div>
                </div>
                <button id="showGanttBtn" class="toggle-bar action-btn" title="Show Gantt Calendar"><i class="fas fa-calendar-alt"></i></button>
            </div>
        </div>
    </main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getFirestore, doc, collection, query, where, onSnapshot, addDoc, updateDoc, deleteDoc, getDocs, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    // ========== SIDEBAR FUNCTIONALITY ==========
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const toggleIcon = document.getElementById('toggleIcon');
    const mainContent = document.getElementById('mainContent');
    const mobileToggle = document.getElementById('mobileToggle');

    // Check sidebar state from localStorage
    const isSidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (isSidebarCollapsed) {
        sidebar.classList.add('collapsed');
        mainContent.classList.add('expanded'); // This makes margin-left:0 and width:100% -> FULL SCREEN
        toggleIcon.classList.remove('fa-chevron-left');
        toggleIcon.classList.add('fa-chevron-right');
    }

    // Sidebar Toggle
    sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('expanded'); // Toggles FULL WIDTH when collapsed
        
        if (sidebar.classList.contains('collapsed')) {
            toggleIcon.classList.remove('fa-chevron-left');
            toggleIcon.classList.add('fa-chevron-right');
            localStorage.setItem('sidebarCollapsed', 'true');
        } else {
            toggleIcon.classList.remove('fa-chevron-right');
            toggleIcon.classList.add('fa-chevron-left');
            localStorage.setItem('sidebarCollapsed', 'false');
        }
    });

    // Mobile Menu Toggle
    mobileToggle.addEventListener('click', function() {
        sidebar.classList.toggle('active');
    });

    // Close mobile menu when clicking outside
    document.addEventListener('click', function(event) {
        if (window.innerWidth <= 768 && 
            !sidebar.contains(event.target) && 
            !mobileToggle.contains(event.target) &&
            sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
        }
    });

    // ========== END SIDEBAR ==========

    // Debugging function
    function debugLog(message, data = null) {
        console.log(`[DEBUG] ${message}`, data);
    }

    // Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
        authDomain: "project-task-588c4.firebaseapp.com",
        projectId: "project-task-588c4",
        storageBucket: "project-task-588c4.appspot.com",
        messagingSenderId: "411882772509",
        appId: "1:411882772509:web:08d613186c101a99f38ef4",
        measurementId: "G-JMFLFYEM0F"
    };

    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        debugLog("Firebase initialized successfully");
    } catch (e) {
        debugLog("Firebase initialization error", e);
        alert("Failed to initialize Firebase: " + e.message);
    }

    // Get project ID from URL
    function getProjectIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');
        if (!projectId) {
            debugLog("No project ID found in URL");
            const errorMsg = "Project ID is missing from URL. Please access this page from the dashboard.";
            alert(errorMsg);
            throw new Error(errorMsg);
        }
        return projectId;
    }

    // Get category from URL
    function getCategoryFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('category');
    }

    const projectId = getProjectIdFromURL();
    const currentCategory = getCategoryFromURL();

    // Update back button URL
    document.getElementById('backToCategoriesBtn').href = `cards.html?id=${projectId}`;
    document.getElementById('completedtasksBtn').href = `completedtask.html?id=${projectId}`;

    // DOM Elements
    const ganttTableCard = document.getElementById('ganttTableCard');
    const toggleGanttBtn = document.getElementById('toggleGanttBtn');
    const showGanttBtn = document.getElementById('showGanttBtn');
    const mainCard = document.getElementById('mainCard');
    const currentMonthBtn = document.getElementById('currentMonthBtn');
    const statusFilter = document.getElementById('statusFilter');
    const monthFilter = document.getElementById('monthFilter');
    const yearFilter = document.getElementById('yearFilter');
    const searchInput = document.getElementById('searchInput');
    const taskList = document.getElementById('taskList');
    const emptyState = document.getElementById('emptyState');
    const ganttCalendarBody = document.getElementById('ganttCalendarBody');
    const ganttCalendarHead = document.getElementById('ganttCalendarHead');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const toggleCompletedBtn = document.getElementById('toggleCompletedBtn');
    const categoryTitle = document.getElementById('categoryTitle');
    const categoryIcon = document.getElementById('categoryIcon');
    const tasksTitle = document.getElementById('tasksTitle');

    // Category definitions
    const categories = {
        'general': { name: 'General Work', icon: 'fas fa-tools', keywords: ['general', 'maintenance', 'repair', 'work', 'task', 'service'] },
        'electrical': { name: 'Electrical Maintenance', icon: 'fas fa-bolt', keywords: ['electrical', 'wiring', 'circuit', 'power', 'lighting', 'socket', 'switch', 'breaker'] },
        'plumbing': { name: 'Plumbing Maintenance', icon: 'fas fa-faucet', keywords: ['plumbing', 'pipe', 'water', 'drain', 'faucet', 'toilet', 'sink', 'leak', 'valve'] },
        'carpentry': { name: 'Carpentry Maintenance', icon: 'fas fa-hammer', keywords: ['carpentry', 'wood', 'carpenter', 'frame', 'door', 'window', 'cabinet', 'furniture'] },
        'welding': { name: 'Welding Maintenance', icon: 'fas fa-fire', keywords: ['welding', 'weld', 'metal', 'steel', 'arc', 'solder', 'fabrication'] },
        'networking': { name: 'Networking and IT Maintenance', icon: 'fas fa-network-wired', keywords: ['network', 'it', 'computer', 'internet', 'wifi', 'server', 'cable', 'ethernet', 'router'] },
        'gardening': { name: 'Plants and Gardening Maintenance', icon: 'fas fa-leaf', keywords: ['gardening', 'garden', 'plant', 'landscape', 'lawn', 'tree', 'flower', 'irrigation'] }
    };

    // State variables
    let ganttVisible = false;
    let showCurrentMonthOnly = false;
    let allTasks = [];
    let unsubMain = null;
    let subUnsubs = {};
    let expandedTasks = {};
    let hideCompleted = false;

    function updateCategoryUI() {
        if (currentCategory && categories[currentCategory]) {
            const category = categories[currentCategory];
            categoryTitle.textContent = category.name;
            categoryIcon.className = category.icon + ' category-icon';
            tasksTitle.textContent = `${category.name} Tasks`;
            document.title = `${category.name} | Task Management`;
        } else {
            categoryTitle.textContent = 'All Tasks';
            categoryIcon.className = 'fas fa-tasks category-icon';
            tasksTitle.textContent = 'All Tasks';
            document.title = 'Project Tasks | Task Management';
        }
    }

    function autoCategorizeTask(taskDescription) {
        if (!taskDescription) return 'general';
        const desc = taskDescription.toLowerCase();
        for (const [categoryId, category] of Object.entries(categories)) {
            if (categoryId === 'general') continue;
            for (const keyword of category.keywords) {
                if (desc.includes(keyword.toLowerCase())) return categoryId;
            }
        }
        return 'general';
    }

    async function getProjectName(projectId) {
        const docRef = doc(db, "projectDashboard", projectId);
        const snap = await getDoc(docRef);
        return snap.exists() ? snap.data().name : "";
    }

    function getInitials(name) {
        return (name.match(/\b\w/g) || []).join('').toUpperCase();
    }

    async function getNextMainTaskNumber(projectId) {
        const snap = await getDocs(query(collection(db, "projectTasks"), where("projectId", "==", projectId)));
        let max = 0;
        snap.forEach(doc => {
            const task = doc.data();
            if (task.taskId) {
                const m = task.taskId.match(/-(\d+)$/);
                if (m) max = Math.max(max, parseInt(m[1], 10));
            }
        });
        return max + 1;
    }

    async function getNextSubtaskNumber(mainTaskId, mainDocId) {
        const snap = await getDocs(collection(db, "projectTasks", mainDocId, "subtasks"));
        let max = 0;
        snap.forEach(doc => {
            const task = doc.data();
            if (task.taskId && task.taskId.startsWith(mainTaskId + "-")) {
                const m = task.taskId.match(/-(\d+)$/);
                if (m) max = Math.max(max, parseInt(m[1], 10));
            }
        });
        return max + 1;
    }

    async function getNextSubSubtaskNumber(subTaskId, mainDocId, subDocId) {
        const snap = await getDocs(collection(db, "projectTasks", mainDocId, "subtasks", subDocId, "subsubtasks"));
        let max = 0;
        snap.forEach(doc => {
            const task = doc.data();
            if (task.taskId && task.taskId.startsWith(subTaskId + "-")) {
                const m = task.taskId.match(/-(\d+)$/);
                if (m) max = Math.max(max, parseInt(m[1], 10));
            }
        });
        return max + 1;
    }

    async function getWorkedHoursForTaskId(taskId) {
        if (!taskId) return 0;
        const q = query(collection(db, "locationHistory"), where("taskId", "==", taskId));
        let sum = 0;
        const snap = await getDocs(q);
        snap.forEach(doc => {
            const d = doc.data();
            if (d.mh && !isNaN(d.mh)) sum += Number(d.mh);
        });
        return sum;
    }

    async function getMaterialCostForTaskId(taskId) {
        if (!taskId) return 0;
        const q = query(collection(db, "materialsUsage"), where("taskId", "==", taskId));
        let sum = 0;
        const snap = await getDocs(q);
        const materialIds = new Set();
        snap.forEach(doc => {
            const d = doc.data();
            if (d.materialId) materialIds.add(d.materialId);
        });
        const materialPriceMap = {};
        await Promise.all([...materialIds].map(async materialId => {
            const matSnap = await getDoc(doc(db, "materials", materialId));
            if (matSnap.exists()) {
                materialPriceMap[materialId] = matSnap.data().unitPrice || 0;
            }
        }));
        snap.forEach(doc => {
            const d = doc.data();
            if (!d.reversed) {
                if (d.quantity && d.materialId) {
                    const price = materialPriceMap[d.materialId] || 0;
                    sum += Number(d.quantity) * Number(price);
                }
                else if (d.boughtFromSupplier && d.amount) {
                    sum += Number(d.amount);
                }
                else if (d.quantity && d.unitPrice && !d.materialId) {
                    sum += Number(d.quantity) * Number(d.unitPrice);
                }
            }
        });
        return sum;
    }

    function checkTaskOverdue(task) {
        if (task.status === 'COMPLETED') return false;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        if (task.giveTarget) {
            const targetDate = task.giveTarget.toDate ? task.giveTarget.toDate() : new Date(task.giveTarget);
            targetDate.setHours(0, 0, 0, 0);
            return targetDate < today;
        }
        if (task.endDate) {
            const endDate = task.endDate.toDate ? task.endDate.toDate() : new Date(task.endDate);
            endDate.setHours(0, 0, 0, 0);
            return endDate < today;
        }
        return false;
    }

    async function updateParentTaskStatusIfNeeded(mainTaskId) {
        const mainTask = allTasks.find(t => t.id === mainTaskId);
        if (!mainTask) return;
        if (checkAllSubtasksCompleted(mainTask)) {
            if (mainTask.status !== 'COMPLETED') {
                await updateDoc(doc(db, "projectTasks", mainTaskId), { 
                    status: 'COMPLETED',
                    updatedAt: new Date()
                });
            }
        }
    }

    function checkAllSubtasksCompleted(task) {
        if (!task.subTasks || task.subTasks.length === 0) return task.status === 'COMPLETED';
        for (const subTask of task.subTasks) {
            if (subTask.status !== 'COMPLETED') return false;
            if (subTask.subSubtasks && subTask.subSubtasks.length > 0) {
                for (const subSubTask of subTask.subSubtasks) {
                    if (subSubTask.status !== 'COMPLETED') return false;
                }
            }
        }
        return true;
    }

    async function loadAllTasks() {
        try {
            if (unsubMain) unsubMain();
            if (subUnsubs) Object.values(subUnsubs).forEach(fn => fn && fn());
            subUnsubs = {};
            allTasks = [];
            
            unsubMain = onSnapshot(
                query(collection(db, "projectTasks"), where("projectId", "==", projectId)), 
                async (snapshot) => {
                    allTasks = [];
                    let promises = [];
                    
                    if (snapshot.empty) {
                        renderTasks(filterTasks(allTasks));
                        renderGanttCalendar(filterTasks(allTasks));
                        return;
                    }
                    
                    snapshot.forEach(docSnap => {
                        const docData = { id: docSnap.id, ...docSnap.data(), subTasks: [] };
                        docData.expanded = expandedTasks[docSnap.id] || false;
                        if (!docData.category && docData.taskDescription) {
                            docData.category = autoCategorizeTask(docData.taskDescription);
                        }
                        if (checkTaskOverdue(docData)) docData.status = 'OVERDUE';
                        allTasks.push(docData);
                        
                        promises.push(new Promise((resolve) => {
                            const unsub = onSnapshot(
                                collection(db, "projectTasks", docSnap.id, "subtasks"), 
                                async (subSnap) => {
                                    docData.subTasks = [];
                                    let subPromises = [];
                                    subSnap.forEach(subDoc => {
                                        let subData = { id: subDoc.id, ...subDoc.data(), subSubtasks: [] };
                                        if (!subData.category && subData.taskDescription) {
                                            subData.category = autoCategorizeTask(subData.taskDescription);
                                        }
                                        if (checkTaskOverdue(subData)) subData.status = 'OVERDUE';
                                        docData.subTasks.push(subData);
                                        
                                        subPromises.push(Promise.all([
                                            getWorkedHoursForTaskId(subData.taskId),
                                            getMaterialCostForTaskId(subData.taskId)
                                        ]).then(([hours, materialCost]) => {
                                            subData._durationHours = hours;
                                            subData._materialCost = materialCost;
                                        }));
                                        
                                        subPromises.push(getSubSubtasks(docData.id, subDoc.id).then(subsubtasks => {
                                            subData.subSubtasks = subsubtasks;
                                            let subSubPromises = subsubtasks.map(subsub => {
                                                if (!subsub.category && subsub.taskDescription) {
                                                    subsub.category = autoCategorizeTask(subsub.taskDescription);
                                                }
                                                if (checkTaskOverdue(subsub)) subsub.status = 'OVERDUE';
                                                return Promise.all([
                                                    getWorkedHoursForTaskId(subsub.taskId),
                                                    getMaterialCostForTaskId(subsub.taskId)
                                                ]).then(([hours, materialCost]) => {
                                                    subsub._durationHours = hours;
                                                    subsub._materialCost = materialCost;
                                                });
                                            });
                                            return Promise.all(subSubPromises);
                                        }));
                                    });
                                    await Promise.all(subPromises);
                                    if (docData.status !== 'COMPLETED' && checkAllSubtasksCompleted(docData)) {
                                        await updateDoc(doc(db, "projectTasks", docData.id), { 
                                            status: 'COMPLETED',
                                            updatedAt: new Date()
                                        });
                                    }
                                    resolve();
                                },
                                (error) => { resolve(); }
                            );
                            subUnsubs[docSnap.id] = unsub;
                        }));
                    });

                    await Promise.all(promises);
                    await Promise.all(allTasks.map(async (task) => {
                        const [hours, materialCost] = await Promise.all([
                            getWorkedHoursForTaskId(task.taskId),
                            getMaterialCostForTaskId(task.taskId)
                        ]);
                        task._durationHours = hours;
                        task._materialCost = materialCost;
                        if (task.subTasks && task.subTasks.length > 0) {
                            let totalHours = hours;
                            let totalMaterialCost = materialCost;
                            task.subTasks.forEach(sub => {
                                totalHours += sub._durationHours || 0;
                                totalMaterialCost += sub._materialCost || 0;
                                if (sub.subSubtasks && sub.subSubtasks.length > 0) {
                                    sub.subSubtasks.forEach(subsub => {
                                        totalHours += subsub._durationHours || 0;
                                        totalMaterialCost += subsub._materialCost || 0;
                                    });
                                }
                            });
                            task._aggregatedDurationHours = totalHours;
                            task._aggregatedMaterialCost = totalMaterialCost;
                        }
                    }));

                    renderTasks(filterTasks(allTasks));
                    renderGanttCalendar(filterTasks(allTasks));
                },
                (error) => { alert("Error loading tasks: " + error.message); }
            );
        } catch (e) { alert("Failed to load tasks: " + e.message); }
    }

    function filterTasks(tasks) {
        const statusVal = statusFilter.value;
        const monthVal = monthFilter.value;
        const yearVal = yearFilter.value;
        const searchVal = searchInput.value.toLowerCase();
        return tasks.filter(task => {
            if (hideCompleted && task.status === 'COMPLETED') return false;
            let matchesCategory = true;
            if (currentCategory) {
                if (currentCategory === 'general') matchesCategory = (!task.category || task.category === 'general');
                else matchesCategory = (task.category === currentCategory);
            }
            let matchesStatus = true;
            if (statusVal) {
                if (statusVal.toUpperCase() === 'OVERDUE') matchesStatus = checkTaskOverdue(task);
                else matchesStatus = (task.status && task.status.toUpperCase() === statusVal.toUpperCase());
            }
            let matchesMonth = true;
            if (monthVal) {
                if (task.startDate) {
                    const date = task.startDate.toDate ? task.startDate.toDate() : new Date(task.startDate);
                    matchesMonth = date.getMonth() + 1 === parseInt(monthVal);
                } else matchesMonth = false;
            }
            let matchesYear = true;
            if (yearVal) {
                if (task.startDate) {
                    const date = task.startDate.toDate ? task.startDate.toDate() : new Date(task.startDate);
                    matchesYear = date.getFullYear() === parseInt(yearVal);
                } else matchesYear = false;
            }
            let matchesSearch = true;
            if (searchVal) {
                matchesSearch = (
                    (task.taskId && task.taskId.toLowerCase().includes(searchVal)) ||
                    (task.taskDescription && task.taskDescription.toLowerCase().includes(searchVal)) ||
                    (task.assignedTo && task.assignedTo.toLowerCase().includes(searchVal)) ||
                    (task.status && task.status.toLowerCase().includes(searchVal)) ||
                    (task.location && task.location.toLowerCase().includes(searchVal)) ||
                    (task.taskLine && task.taskLine.toString().includes(searchVal))
                );
                if (!matchesSearch && task.subTasks) {
                    for (const sub of task.subTasks) {
                        if ( (sub.taskId && sub.taskId.toLowerCase().includes(searchVal)) ||
                             (sub.taskDescription && sub.taskDescription.toLowerCase().includes(searchVal)) ||
                             (sub.assignedTo && sub.assignedTo.toLowerCase().includes(searchVal)) ||
                             (sub.status && sub.status.toLowerCase().includes(searchVal)) ||
                             (sub.location && sub.location.toLowerCase().includes(searchVal)) ) {
                            matchesSearch = true; break;
                        }
                        if (!matchesSearch && sub.subSubtasks) {
                            for (const subsub of sub.subSubtasks) {
                                if ( (subsub.taskId && subsub.taskId.toLowerCase().includes(searchVal)) ||
                                     (subsub.taskDescription && subsub.taskDescription.toLowerCase().includes(searchVal)) ||
                                     (subsub.assignedTo && subsub.assignedTo.toLowerCase().includes(searchVal)) ||
                                     (subsub.status && subsub.status.toLowerCase().includes(searchVal)) ||
                                     (subsub.location && subsub.location.toLowerCase().includes(searchVal)) ) {
                                    matchesSearch = true; break;
                                }
                            }
                        }
                        if (matchesSearch) break;
                    }
                }
            }
            return matchesCategory && matchesStatus && matchesMonth && matchesYear && matchesSearch;
        });
    }

    function formatGiveTargetDisplay(giveTarget, status) {
        if (!giveTarget) return '';
        const today = new Date(); today.setHours(0,0,0,0);
        const targetDate = giveTarget.toDate ? giveTarget.toDate() : new Date(giveTarget);
        targetDate.setHours(0,0,0,0);
        const formattedDate = formatDate(giveTarget);
        if (status === 'COMPLETED') return formattedDate;
        else if (targetDate < today) return `${formattedDate} (Overdue)`;
        else return formattedDate;
    }

    function makeEditableInput(cell, type, field, inputType='text') {
        if (cell.querySelector('input')) return;
        const val = cell.textContent.trim();
        const input = document.createElement('input');
        input.type = inputType;
        if (inputType === 'date') input.value = val ? formatDateForInput(val) : '';
        else input.value = val;
        input.className = 'editable-input';
        input.setAttribute('data-field', field);
        if (field === 'taskDescription' || field === 'assignedTo') input.style.textAlign = 'left';
        else input.style.textAlign = 'center';
        cell.innerHTML = '';
        cell.appendChild(input);
        input.focus();
        input.onblur = async () => {
            let newValue = input.value;
            if (inputType === 'date' && newValue) newValue = new Date(newValue);
            await saveEditable(cell, type, field, newValue);
        };
        input.onkeypress = async (e) => { if (e.key === 'Enter') input.blur(); };
    }

    function makeEditableSelect(cell, type, field) {
        if (cell.querySelector('select')) return;
        const val = cell.textContent.trim();
        const select = document.createElement('select');
        select.className = 'editable-select';
        select.setAttribute('data-field', field);
        if (field === 'taskDescription' || field === 'assignedTo') select.style.textAlign = 'left';
        else select.style.textAlign = 'center';
        ['COMPLETED', 'ONGOING', 'PENDING', 'OVERDUE'].forEach(opt => {
            const o = document.createElement('option');
            o.value = opt; o.textContent = opt;
            if (val.toUpperCase() === opt) o.selected = true;
            select.appendChild(o);
        });
        cell.innerHTML = '';
        cell.appendChild(select);
        select.focus();
        select.onblur = async () => { await saveEditable(cell, type, field, select.value); };
        select.onchange = () => select.blur();
    }

    async function saveEditable(cell, type, field, newVal) {
        const mainId = cell.dataset.mainid || cell.dataset.id;
        try {
            if (type === 'main') {
                const updateData = { [field]: newVal, updatedAt: new Date() };
                if (field === 'giveTarget') {
                    const task = allTasks.find(t => t.id === mainId);
                    if (task && checkTaskOverdue({...task, giveTarget: newVal})) updateData.status = 'OVERDUE';
                }
                await updateDoc(doc(db, "projectTasks", mainId), updateData);
                if (field === 'status' && newVal === 'COMPLETED') await updateParentTaskStatusIfNeeded(mainId);
            } else if (type === 'sub') {
                const updateData = { [field]: newVal, updatedAt: new Date() };
                if (field === 'giveTarget') {
                    const mainTask = allTasks.find(t => t.id === mainId);
                    if (mainTask) {
                        const subtask = mainTask.subTasks.find(s => s.id === cell.dataset.id);
                        if (subtask && checkTaskOverdue({...subtask, giveTarget: newVal})) updateData.status = 'OVERDUE';
                    }
                }
                await updateDoc(doc(db, "projectTasks", mainId, "subtasks", cell.dataset.id), updateData);
                if (field === 'status') await updateParentTaskStatusIfNeeded(mainId);
            } else if (type === 'subsub') {
                const updateData = { [field]: newVal, updatedAt: new Date() };
                if (field === 'giveTarget') {
                    const mainTask = allTasks.find(t => t.id === cell.dataset.mainid);
                    if (mainTask) {
                        const subtask = mainTask.subTasks.find(s => s.id === cell.dataset.subid);
                        if (subtask) {
                            const subsubtask = subtask.subSubtasks.find(ss => ss.id === cell.dataset.id);
                            if (subsubtask && checkTaskOverdue({...subsubtask, giveTarget: newVal})) updateData.status = 'OVERDUE';
                        }
                    }
                }
                await updateDoc(doc(db, "projectTasks", cell.dataset.mainid, "subtasks", cell.dataset.subid, "subsubtasks", cell.dataset.id), updateData);
                if (field === 'status') {
                    const subDoc = await getDoc(doc(db, "projectTasks", cell.dataset.mainid, "subtasks", cell.dataset.subid));
                    if (subDoc.exists()) {
                        const subData = subDoc.data();
                        if (newVal === 'COMPLETED') {
                            const subSubtasks = await getSubSubtasks(cell.dataset.mainid, cell.dataset.subid);
                            const allCompleted = subSubtasks.every(s => s.status === 'COMPLETED');
                            if (allCompleted && subData.status !== 'COMPLETED') {
                                await updateDoc(doc(db, "projectTasks", cell.dataset.mainid, "subtasks", cell.dataset.subid), { 
                                    status: 'COMPLETED', updatedAt: new Date()
                                });
                                await updateParentTaskStatusIfNeeded(cell.dataset.mainid);
                            }
                        }
                    }
                }
            }
        } catch (e) { alert("Error saving changes: " + e.message); }
    }

    window.deleteTask = async function(type, mainId, subId, subSubId) {
        if (!confirm("Are you sure you want to delete this task?")) return;
        try {
            if (type === 'main') await deleteDoc(doc(db, "projectTasks", mainId));
            else if (type === 'sub') await deleteDoc(doc(db, "projectTasks", mainId, "subtasks", subId));
            else if (type === 'subsub') await deleteDoc(doc(db, "projectTasks", mainId, "subtasks", subId, "subsubtasks", subSubId));
            alert("Task deleted successfully!");
        } catch (e) { alert("Error deleting task: " + e.message); }
    };

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = dateString.toDate ? dateString.toDate() : new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatDateForInput(dateString) {
        if (!dateString) return '';
        const date = dateString.toDate ? dateString.toDate() : new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatCurrency(amount, curr='ZMW') {
        if (!amount && amount !== 0) return '';
        const formatter = new Intl.NumberFormat(undefined, { style: 'currency', currency: curr || 'ZMW', minimumFractionDigits: 2 });
        return formatter.format(amount);
    }

    function getStatusBadge(status) {
        if (!status) return '';
        status = status.toUpperCase();
        if (status === 'COMPLETED') return 'status-badge status-completed';
        if (status === 'ONGOING') return 'status-badge status-ongoing';
        if (status === 'OVERDUE') return 'status-badge status-overdue';
        return 'status-badge status-pending';
    }

    async function getSubSubtasks(mainId, subId) {
        const snap = await getDocs(collection(db, "projectTasks", mainId, "subtasks", subId, "subsubtasks"));
        let subsubtasks = [];
        snap.forEach(subSubDoc => { subsubtasks.push({ id: subSubDoc.id, ...subSubDoc.data() }); });
        return subsubtasks;
    }

    function toggleHideCompleted() {
        hideCompleted = !hideCompleted;
        updateHideCompletedButton();
        localStorage.setItem('hideCompleted', hideCompleted.toString());
        renderTasks(filterTasks(allTasks));
        renderGanttCalendar(filterTasks(allTasks));
    }

    function updateHideCompletedButton() {
        if (hideCompleted) {
            toggleCompletedBtn.innerHTML = '<i class="fas fa-eye"></i> Show Completed';
            toggleCompletedBtn.classList.remove('hide-completed-btn');
            toggleCompletedBtn.classList.add('show-completed-btn');
        } else {
            toggleCompletedBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Completed';
            toggleCompletedBtn.classList.remove('show-completed-btn');
            toggleCompletedBtn.classList.add('hide-completed-btn');
        }
    }

    function renderTasks(tasks) {
        taskList.innerHTML = '';
        let visibleCount = 0;
        tasks.sort((a, b) => (a.taskLine || 0) - (b.taskLine || 0));
        let totalDuration = 0, totalMaterialCost = 0, totalManCost = 0, totalCost = 0;
        
        tasks.forEach(task => {
            if (hideCompleted && task.status === 'COMPLETED') return;
            visibleCount++;
            const hours = task._durationHours || 0;
            const materialCost = task._materialCost || 0;
            const manCost = hours * 20;
            const taskTotalCost = manCost + materialCost;
            const displayHours = task._aggregatedDurationHours !== undefined ? task._aggregatedDurationHours : hours;
            const displayMaterialCost = task._aggregatedMaterialCost !== undefined ? task._aggregatedMaterialCost : materialCost;
            const displayManCost = displayHours * 20;
            const displayTotalCost = displayManCost + displayMaterialCost;
            totalDuration += displayHours;
            totalMaterialCost += displayMaterialCost;
            totalManCost += displayManCost;
            totalCost += displayTotalCost;
            
            const tr = document.createElement('tr'); tr.classList.add('main-task-row');
            tr.innerHTML = `
                <td><span class="main-task-expand" data-id="${task.id}" style="font-size:17px"><i class="fas fa-${task.expanded ? "caret-down" : "caret-right"}"></i></span></td>
                <td data-id="${task.id}">${task.taskId || ''}</td>
                <td class="editable" data-type="main" data-field="taskLine" data-id="${task.id}">${task.taskLine || ''}</td>
                <td class="editable" data-type="main" data-field="taskDescription" data-id="${task.id}">${task.taskDescription || ''}</td>
                <td class="editable" data-type="main" data-field="assignedTo" data-id="${task.id}">${task.assignedTo || ''}</td>
                <td class="editable" data-type="main" data-field="status" data-id="${task.id}"><span class="${getStatusBadge(task.status)}">${task.status || ''}</span></td>
                <td class="editable" data-type="main" data-field="startDate" data-id="${task.id}">${formatDate(task.startDate) || ''}</td>
                <td class="editable" data-type="main" data-field="endDate" data-id="${task.id}">${formatDate(task.endDate) || ''}</td>
                <td class="editable give-target-cell" data-type="main" data-field="giveTarget" data-id="${task.id}">${formatGiveTargetDisplay(task.giveTarget, task.status)}</td>
                <td>${displayHours}</td>
                <td><span class="cost-badge">${formatCurrency(displayMaterialCost)}</span></td>
                <td><span class="cost-badge">${formatCurrency(displayManCost)}</span></td>
                <td><span class="cost-badge">${formatCurrency(displayTotalCost)}</span></td>
                <td>${task.location || ''}</td>
                <td>
                    <button class="add-subtask-btn action-btn" data-mainid="${task.id}"><i class="fas fa-plus"></i> Subtask</button>
                    <button class="delete-btn" onclick="deleteTask('main', '${task.id}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
            taskList.appendChild(tr);
            
            if (task.expanded) {
                if (!task.subTasks || !task.subTasks.length) {
                    const trSub = document.createElement('tr'); trSub.classList.add('subtask-row');
                    trSub.innerHTML = `<td></td><td colspan="14">No sub tasks yet.</td>`;
                    taskList.appendChild(trSub);
                } else {
                    task.subTasks.forEach(sub => {
                        if (hideCompleted && sub.status === 'COMPLETED') return;
                        const subHours = sub._durationHours || 0;
                        const subMaterialCost = sub._materialCost || 0;
                        const subManCost = subHours * 20;
                        const subTotalCost = subManCost + subMaterialCost;
                        totalDuration += subHours; totalMaterialCost += subMaterialCost; totalManCost += subManCost; totalCost += subTotalCost;
                        const trSub = document.createElement('tr'); trSub.classList.add('subtask-row');
                        trSub.innerHTML = `
                            <td class="subtask-arrow"></td>
                            <td data-mainid="${task.id}" data-id="${sub.id}">${sub.taskId || ''}</td>
                            <td></td>
                            <td class="editable subtask-desc" data-type="sub" data-mainid="${task.id}" data-field="taskDescription" data-id="${sub.id}">${sub.taskDescription || ''}</td>
                            <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="assignedTo" data-id="${sub.id}">${sub.assignedTo || ''}</td>
                            <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="status" data-id="${sub.id}"><span class="${getStatusBadge(sub.status)}">${sub.status || ''}</span></td>
                            <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="startDate" data-id="${sub.id}">${formatDate(sub.startDate) || ''}</td>
                            <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="endDate" data-id="${sub.id}">${formatDate(sub.endDate) || ''}</td>
                            <td class="editable give-target-cell" data-type="sub" data-mainid="${task.id}" data-field="giveTarget" data-id="${sub.id}">${formatGiveTargetDisplay(sub.giveTarget, sub.status)}</td>
                            <td>${subHours}</td>
                            <td><span class="cost-badge">${formatCurrency(subMaterialCost)}</span></td>
                            <td><span class="cost-badge">${formatCurrency(subManCost)}</span></td>
                            <td><span class="cost-badge">${formatCurrency(subTotalCost)}</span></td>
                            <td>${sub.location || ''}</td>
                            <td>
                                <button class="add-subsubtask-btn action-btn" data-mainid="${task.id}" data-subid="${sub.id}"><i class="fas fa-plus"></i> Sub-Subtask</button>
                                <button class="delete-btn" onclick="deleteTask('sub', '${task.id}', '${sub.id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                        taskList.appendChild(trSub);
                        if (sub.subSubtasks && sub.subSubtasks.length) {
                            sub.subSubtasks.forEach(subsub => {
                                if (hideCompleted && subsub.status === 'COMPLETED') return;
                                const subsubHours = subsub._durationHours || 0;
                                const subsubMaterialCost = subsub._materialCost || 0;
                                const subsubManCost = subsubHours * 20;
                                const subsubTotalCost = subsubManCost + subsubMaterialCost;
                                totalDuration += subsubHours; totalMaterialCost += subsubMaterialCost; totalManCost += subsubManCost; totalCost += subsubTotalCost;
                                const trSubSub = document.createElement('tr'); trSubSub.classList.add('subsubtask-row');
                                trSubSub.innerHTML = `
                                    <td class="subtask-arrow"></td>
                                    <td data-mainid="${task.id}" data-subid="${sub.id}" data-id="${subsub.id}">${subsub.taskId || ''}</td>
                                    <td></td>
                                    <td class="editable subtask-desc" style="padding-left:40px" data-type="subsub" data-mainid="${task.id}" data-subid="${sub.id}" data-field="taskDescription" data-id="${subsub.id}">${subsub.taskDescription || ''}</td>
                                    <td class="editable" data-type="subsub" data-mainid="${task.id}" data-subid="${sub.id}" data-field="assignedTo" data-id="${subsub.id}">${subsub.assignedTo || ''}</td>
                                    <td class="editable" data-type="subsub" data-mainid="${task.id}" data-subid="${sub.id}" data-field="status" data-id="${subsub.id}"><span class="${getStatusBadge(subsub.status)}">${subsub.status || ''}</span></td>
                                    <td class="editable" data-type="subsub" data-mainid="${task.id}" data-subid="${sub.id}" data-field="startDate" data-id="${subsub.id}">${formatDate(subsub.startDate) || ''}</td>
                                    <td class="editable" data-type="subsub" data-mainid="${task.id}" data-subid="${sub.id}" data-field="endDate" data-id="${subsub.id}">${formatDate(subsub.endDate) || ''}</td>
                                    <td class="editable give-target-cell" data-type="subsub" data-mainid="${task.id}" data-subid="${sub.id}" data-field="giveTarget" data-id="${subsub.id}">${formatGiveTargetDisplay(subsub.giveTarget, subsub.status)}</td>
                                    <td>${subsubHours}</td>
                                    <td><span class="cost-badge">${formatCurrency(subsubMaterialCost)}</span></td>
                                    <td><span class="cost-badge">${formatCurrency(subsubManCost)}</span></td>
                                    <td><span class="cost-badge">${formatCurrency(subsubTotalCost)}</span></td>
                                    <td>${subsub.location || ''}</td>
                                    <td>
                                        <button class="delete-btn" onclick="deleteTask('subsub', '${task.id}', '${sub.id}', '${subsub.id}')"><i class="fas fa-trash"></i></button>
                                    </td>
                                `;
                                taskList.appendChild(trSubSub);
                            });
                        }
                    });
                }
            }
        });

        document.getElementById('totalDuration').textContent = totalDuration;
        document.getElementById('totalMaterialCost').textContent = formatCurrency(totalMaterialCost);
        document.getElementById('totalManCost').textContent = formatCurrency(totalManCost);
        document.getElementById('totalCost').textContent = formatCurrency(totalCost);
        emptyState.style.display = visibleCount === 0 ? 'block' : 'none';

        document.querySelectorAll('.main-task-expand').forEach(btn => {
            btn.onclick = () => {
                const mainId = btn.dataset.id;
                expandedTasks[mainId] = !expandedTasks[mainId];
                saveExpandedTasks();
                allTasks.find(t => t.id === mainId).expanded = expandedTasks[mainId];
                renderTasks(filterTasks(allTasks));
                renderGanttCalendar(filterTasks(allTasks));
            };
        });
        document.querySelectorAll('.add-subtask-btn').forEach(btn => {
            btn.classList.add("action-btn");
            btn.onclick = () => { const mainId = btn.dataset.mainid; addSubtask(mainId); };
        });
        document.querySelectorAll('.add-subsubtask-btn').forEach(btn => {
            btn.classList.add("action-btn");
            btn.onclick = () => { const mainId = btn.dataset.mainid; const subId = btn.dataset.subid; addSubSubtask(mainId, subId); };
        });
        document.querySelectorAll('.editable').forEach(cell => {
            cell.onclick = function() {
                const type = this.dataset.type;
                const field = this.dataset.field;
                if (field === 'status') makeEditableSelect(this, type, field);
                else if (field === 'startDate' || field === 'endDate' || field === 'giveTarget') makeEditableInput(this, type, field, 'date');
                else if (field === 'taskLine') makeEditableInput(this, type, field, 'number');
                else makeEditableInput(this, type, field);
            };
        });
    }

    addTaskBtn.onclick = async () => {
        const projectName = await getProjectName(projectId);
        const initials = getInitials(projectName);
        const nextNum = await getNextMainTaskNumber(projectId);
        const taskId = `${initials}-${nextNum}`;
        const taskDesc = prompt("Main Task Description:"); if (!taskDesc) return;
        const assignedTo = prompt("Assigned To:");
        const location = prompt("Location:");
        const taskLine = parseInt(prompt("Task Line (number, optional):") || 0);
        const category = autoCategorizeTask(taskDesc);
        const startDate = prompt("Start Date (YYYY-MM-DD, required):"); if (!startDate) { alert("Start date is required!"); return; }
        const giveTarget = prompt("Give Target Date (YYYY-MM-DD, optional):");
        try {
            await addDoc(collection(db, "projectTasks"), {
                projectId, taskId, taskLine, taskDescription: taskDesc, assignedTo, location, category,
                status: "PENDING", startDate: new Date(startDate), giveTarget: giveTarget ? new Date(giveTarget) : null,
                createdAt: new Date(), updatedAt: new Date()
            });
            alert('Main task added! Category: ' + categories[category].name);
        } catch (e) { alert("Error adding main task: " + e.message); }
    };

    async function addSubtask(mainId) {
        const mainDoc = await getDoc(doc(db, "projectTasks", mainId));
        if (!mainDoc.exists()) return alert("Main task not found!");
        const mainTaskId = mainDoc.data().taskId;
        const nextNum = await getNextSubtaskNumber(mainTaskId, mainId);
        const subTaskId = `${mainTaskId}-${nextNum}`;
        const taskDesc = prompt("Sub Task Description:"); if (!taskDesc) return;
        const assignedTo = prompt("Assigned To:"); const location = prompt("Location:");
        const status = prompt("Status (COMPLETED, ONGOING, PENDING):", "PENDING") || "PENDING";
        const startDate = prompt("Start Date (YYYY-MM-DD):"); const endDate = prompt("End Date (YYYY-MM-DD):");
        const giveTarget = prompt("Give Target Date (YYYY-MM-DD, optional):");
        const duration = parseFloat(prompt("Duration (number, hour, optional):") || 0);
        const category = autoCategorizeTask(taskDesc);
        try {
            await addDoc(collection(db, "projectTasks", mainId, "subtasks"), {
                taskId: subTaskId, taskDescription: taskDesc, assignedTo, location, category,
                status: status.toUpperCase(), startDate: startDate ? new Date(startDate) : null,
                endDate: endDate ? new Date(endDate) : null, giveTarget: giveTarget ? new Date(giveTarget) : null,
                duration, createdAt: new Date(), updatedAt: new Date()
            });
        } catch (e) { alert("Error adding sub task: " + e.message); }
    }

    async function addSubSubtask(mainId, subtaskId) {
        const subDoc = await getDoc(doc(db, "projectTasks", mainId, "subtasks", subtaskId));
        if (!subDoc.exists()) return alert("Subtask not found!");
        const subTaskId = subDoc.data().taskId;
        const nextNum = await getNextSubSubtaskNumber(subTaskId, mainId, subtaskId);
        const subSubTaskId = `${subTaskId}-${nextNum}`;
        const taskDesc = prompt("Sub-Subtask Description:"); if (!taskDesc) return;
        const assignedTo = prompt("Assigned To:"); const location = prompt("Location:");
        const status = prompt("Status (COMPLETED, ONGOING, PENDING):", "PENDING") || "PENDING";
        const startDate = prompt("Start Date (YYYY-MM-DD):"); const endDate = prompt("End Date (YYYY-MM-DD):");
        const giveTarget = prompt("Give Target Date (YYYY-MM-DD, optional):");
        const duration = parseFloat(prompt("Duration (number, hour, optional):") || 0);
        const category = autoCategorizeTask(taskDesc);
        try {
            await addDoc(collection(db, "projectTasks", mainId, "subtasks", subtaskId, "subsubtasks"), {
                taskId: subSubTaskId, taskDescription: taskDesc, assignedTo, location, category,
                status: status.toUpperCase(), startDate: startDate ? new Date(startDate) : null,
                endDate: endDate ? new Date(endDate) : null, giveTarget: giveTarget ? new Date(giveTarget) : null,
                duration, createdAt: new Date(), updatedAt: new Date()
            });
            alert('Sub-subtask added! Category: ' + categories[category].name);
        } catch (e) { alert("Error adding sub-subtask: " + e.message); }
    }

    function buildGanttCalendarHeaders(baseYear, showCurrentMonthOnly) {
        const months = [
            {name:"Jan",days:31},{name:"Feb",days:28},{name:"Mar",days:31},{name:"Apr",days:30},
            {name:"May",days:31},{name:"Jun",days:30},{name:"Jul",days:31},{name:"Aug",days:31},
            {name:"Sep",days:30},{name:"Oct",days:31},{name:"Nov",days:30},{name:"Dec",days:31}
        ];
        if ((baseYear % 4 === 0 && baseYear % 100 !== 0) || baseYear % 400 === 0) months[1].days = 29;
        const today = new Date(); const currentMonth = today.getMonth(); const currentYear = today.getFullYear();
        let row1 = `<tr><th rowspan="3" style="min-width:160px;text-align:left;">TASK</th>`;
        let row2 = "<tr>"; let row3 = "<tr>";
        for (let m = 0; m < months.length; m++) {
            const month = months[m];
            const monthClass = (showCurrentMonthOnly && m === currentMonth && baseYear === currentYear) ? "current-month" : "";
            if (!showCurrentMonthOnly || (m === currentMonth && baseYear === currentYear)) {
                row1 += `<th colspan="${month.days}" class="${monthClass}">${month.name}</th>`;
                for(let d=1; d<=month.days; d++) {
                    const dt = new Date(baseYear, m, d);
                    const wd = ["S","M","T","W","R","F","S"][dt.getDay()];
                    const isToday = dt.getDate() === today.getDate() && dt.getMonth() === today.getMonth() && dt.getFullYear() === today.getFullYear();
                    const dayClass = isToday ? "today-highlight" : "";
                    row2 += `<th class="${dayClass}">${d}</th>`;
                    row3 += `<th class="${dayClass}">${wd}</th>`;
                }
            }
        }
        row1 += "</tr>"; row2 += "</tr>"; row3 += "</tr>";
        ganttCalendarHead.innerHTML = row1 + row2 + row3;
        return {months};
    }

    function renderGanttCalendar(tasks) {
        let allRows = [];
        let minYear = new Date().getFullYear();
        const today = new Date(); today.setHours(0,0,0,0);
        tasks.forEach(main => {
            if (hideCompleted && main.status === 'COMPLETED') return;
            allRows.push({ isSub: false, description: main.taskDescription || '', status: main.status, startDate: main.startDate, endDate: main.endDate, giveTarget: main.giveTarget });
            if (main.startDate) { const y = (main.startDate?.toDate ? main.startDate.toDate() : new Date(main.startDate)).getFullYear(); if (y < minYear) minYear = y; }
            (main.subTasks || []).forEach(sub => {
                if (hideCompleted && sub.status === 'COMPLETED') return;
                allRows.push({ isSub: true, description: sub.taskDescription || '', status: sub.status, startDate: sub.startDate, endDate: sub.endDate, giveTarget: sub.giveTarget });
                if (sub.startDate) { const y = (sub.startDate?.toDate ? sub.startDate.toDate() : new Date(sub.startDate)).getFullYear(); if (y < minYear) minYear = y; }
                (sub.subSubtasks || []).forEach(subsub => {
                    if (hideCompleted && subsub.status === 'COMPLETED') return;
                    allRows.push({ isSubSub: true, description: subsub.taskDescription || '', status: subsub.status, startDate: subsub.startDate, endDate: subsub.endDate, giveTarget: subsub.giveTarget });
                    if (subsub.startDate) { const y = (subsub.startDate?.toDate ? subsub.startDate.toDate() : new Date(subsub.startDate)).getFullYear(); if (y < minYear) minYear = y; }
                });
            });
        });
        const { months } = buildGanttCalendarHeaders(minYear, showCurrentMonthOnly);
        ganttCalendarBody.innerHTML = "";
        allRows.forEach(rowTask => {
            let pct = "";
            if (rowTask.status && rowTask.status.toUpperCase() === "COMPLETED") pct = "100%";
            else if (rowTask.status && rowTask.status.toUpperCase() === "ONGOING") pct = "60%";
            else if (rowTask.status && rowTask.status.toUpperCase() === "PENDING" || rowTask.status === "OVERDUE") pct = "0%";
            let desc = rowTask.isSubSub
                ? '<span style="margin-left:32px;color:#666;font-size:12px;vertical-align:middle;"></span> <span style="opacity:.8;">' + rowTask.description + '</span>'
                : rowTask.isSub
                ? '<span style="margin-left:12px;color:#333;font-size:13px;vertical-align:middle;"></span> <span style="opacity:.8;">' + rowTask.description + '</span>'
                : '<span style="font-weight:bold;color:#000;">' + rowTask.description + '</span>';
            let row = `<tr><td style="text-align:left">${desc}</td>`;
            let start = null, end = null;
            if (rowTask.giveTarget) {
                start = rowTask.giveTarget.toDate ? rowTask.giveTarget.toDate() : new Date(rowTask.giveTarget);
                start = new Date(start.getFullYear(), start.getMonth(), start.getDate());
                if (rowTask.status === 'ONGOING' || rowTask.status === 'PENDING' || rowTask.status === 'OVERDUE') end = today;
            } else if (rowTask.startDate) {
                start = rowTask.startDate.toDate ? rowTask.startDate.toDate() : new Date(rowTask.startDate);
                start = new Date(start.getFullYear(), start.getMonth(), start.getDate());
                if ((rowTask.status === 'ONGOING' || rowTask.status === 'PENDING' || rowTask.status === 'OVERDUE') && !rowTask.endDate) end = today;
                else if (rowTask.endDate) { end = rowTask.endDate.toDate ? rowTask.endDate.toDate() : new Date(rowTask.endDate); end = new Date(end.getFullYear(), end.getMonth(), end.getDate()); }
            }
            let colDate = new Date(minYear, 0, 1);
            const currentMonth = today.getMonth(); const currentYear = today.getFullYear();
            for (let m = 0; m < months.length; m++) {
                const month = months[m];
                if (showCurrentMonthOnly && (m !== currentMonth || minYear !== currentYear)) {
                    colDate.setMonth(colDate.getMonth()+1); colDate.setDate(1); continue;
                }
                for (let d = 1; d <= month.days; d++) {
                    let bar = '';
                    if (start) {
                        let testDate = new Date(colDate.getFullYear(), colDate.getMonth(), colDate.getDate());
                        if (testDate >= start && (!end || testDate <= end)) {
                            if (!rowTask.isSub && !rowTask.isSubSub) {
                                if (pct === "100%") bar = '<div class="gantt-bar"></div>';
                                else if (pct === "60%") bar = '<div class="gantt-bar"></div>';
                                else bar = '<div class="gantt-bar gantt-bar-empty"></div>';
                            } else if (rowTask.isSub) {
                                if (pct === "100%") bar = '<div class="gantt-bar" style="opacity:.6"></div>';
                                else if (pct === "60%") bar = '<div class="gantt-bar" style="opacity:.8"></div>';
                                else bar = '<div class="gantt-bar gantt-bar-empty"></div>';
                            } else if (rowTask.isSubSub) {
                                if (pct === "100%") bar = '<div class="gantt-bar" style="opacity:.4"></div>';
                                else if (pct === "60%") bar = '<div class="gantt-bar" style="opacity:.6"></div>';
                                else bar = '<div class="gantt-bar gantt-bar-empty"></div>';
                            }
                        }
                    }
                    row += `<td>${bar}</td>`;
                    colDate.setDate(colDate.getDate()+1);
                }
            }
            row += `</tr>`;
            ganttCalendarBody.innerHTML += row;
        });
    }

    function toggleGanttVisibility() {
        ganttVisible = !ganttVisible;
        if (ganttVisible) {
            ganttTableCard.classList.remove('hide');
            showGanttBtn.classList.add('hide');
            mainCard.style.flexBasis = '65%'; ganttTableCard.style.flexBasis = '35%';
            localStorage.setItem('ganttVisible', 'true');
        } else {
            ganttTableCard.classList.add('hide');
            showGanttBtn.classList.remove('hide');
            mainCard.style.flexBasis = '100%';
            localStorage.setItem('ganttVisible', 'false');
        }
    }

    function toggleCurrentMonthView() {
        showCurrentMonthOnly = !showCurrentMonthOnly;
        currentMonthBtn.textContent = showCurrentMonthOnly ? "All Months" : "Current Month";
        localStorage.setItem('showCurrentMonthOnly', showCurrentMonthOnly.toString());
        renderGanttCalendar(filterTasks(allTasks));
    }

    statusFilter.addEventListener('change', () => { saveFilterStates(); renderTasks(filterTasks(allTasks)); renderGanttCalendar(filterTasks(allTasks)); });
    monthFilter.addEventListener('change', () => { saveFilterStates(); renderTasks(filterTasks(allTasks)); renderGanttCalendar(filterTasks(allTasks)); });
    yearFilter.addEventListener('change', () => { saveFilterStates(); renderTasks(filterTasks(allTasks)); renderGanttCalendar(filterTasks(allTasks)); });
    searchInput.addEventListener('input', () => { renderTasks(filterTasks(allTasks)); renderGanttCalendar(filterTasks(allTasks)); });
    toggleGanttBtn.addEventListener('click', toggleGanttVisibility);
    showGanttBtn.addEventListener('click', toggleGanttVisibility);
    currentMonthBtn.addEventListener('click', toggleCurrentMonthView);
    toggleCompletedBtn.addEventListener('click', toggleHideCompleted);

    function loadFilterStates() {
        const savedStatus = localStorage.getItem('taskStatusFilter');
        const savedMonth = localStorage.getItem('taskMonthFilter');
        const savedYear = localStorage.getItem('taskYearFilter');
        const savedSearch = localStorage.getItem('taskSearchFilter');
        const savedGanttVisible = localStorage.getItem('ganttVisible');
        const savedShowCurrentMonthOnly = localStorage.getItem('showCurrentMonthOnly');
        const savedHideCompleted = localStorage.getItem('hideCompleted');
        if (savedStatus) statusFilter.value = savedStatus;
        if (savedMonth) monthFilter.value = savedMonth;
        if (savedYear) yearFilter.value = savedYear;
        if (savedSearch) searchInput.value = savedSearch;
        if (savedGanttVisible === 'true') { ganttVisible = true; toggleGanttBtn.innerHTML = '<i class="fas fa-eye-slash"></i>'; } 
        else { ganttVisible = false; toggleGanttBtn.innerHTML = '<i class="fas fa-eye"></i>'; }
        if (savedShowCurrentMonthOnly === 'true') { showCurrentMonthOnly = true; currentMonthBtn.textContent = "All Months"; }
        if (savedHideCompleted === 'true') { hideCompleted = true; }
    }
    function saveFilterStates() {
        localStorage.setItem('taskStatusFilter', statusFilter.value);
        localStorage.setItem('taskMonthFilter', monthFilter.value);
        localStorage.setItem('taskYearFilter', yearFilter.value);
        localStorage.setItem('taskSearchFilter', searchInput.value);
    }
    function loadExpandedTasks() { try { expandedTasks = JSON.parse(localStorage.getItem("expanded_tasks") || "{}"); } catch (e) { expandedTasks = {}; } }
    function saveExpandedTasks() { localStorage.setItem("expanded_tasks", JSON.stringify(expandedTasks)); }

    updateCategoryUI();
    loadFilterStates();
    loadExpandedTasks();
    updateHideCompletedButton();
    if (ganttVisible) {
        ganttTableCard.classList.remove('hide'); showGanttBtn.classList.add('hide');
        mainCard.style.flexBasis = '65%'; ganttTableCard.style.flexBasis = '35%';
    } else {
        ganttTableCard.classList.add('hide'); showGanttBtn.classList.remove('hide');
        mainCard.style.flexBasis = '100%';
    }
    loadAllTasks();
    setInterval(() => { renderGanttCalendar(filterTasks(allTasks)); }, 60000);
</script>
</body>
</html>
