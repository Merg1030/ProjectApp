<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Tasks | Clean View</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #d3dfed; color: #0a1c2f; height: 100vh; overflow: hidden;
        }

        .main-content { height: 100vh; width: 100vw; display: flex; flex-direction: column; background: white; overflow: hidden; }

        .project-header {
            padding: 4px 10px; background: #0a1c2f; color: white;
            border-bottom: 2px solid #1f3d62; display: flex; align-items: center;
            justify-content: space-between; flex-shrink: 0; min-height: 48px;
        }
        .title-section { display: flex; align-items: center; gap: 6px; }
        .title-section h2 { font-size: 14px; font-weight: 500; color: white; }

        .back-link {
            color: #0b1f33; text-decoration: none; padding: 0.2rem 1rem;
            border: none; background: white; border-radius: 30px; font-size: 0.7rem;
            font-weight: 600; display: flex; align-items: center; gap: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .back-link:hover { background: #e6efff; }

        .project-info { padding: 4px 10px; background: #f2f6fc; border-bottom: 1px solid #b3c7e0; flex-shrink: 0; }
        .manager-info { display: flex; align-items: center; gap: 16px; font-size: 11px; }
        .label { font-weight: 600; color: #1f3d62; }
        .value { color: #0a1c2f; margin-left: 4px; }

        .actions-container { padding: 4px 10px; background: #f2f6fc; border-bottom: 1px solid #b3c7e0; flex-shrink: 0; }
        .actions-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 2px 0; }
        .actions-header h3 { font-size: 12px; font-weight: 600; color: #0a1c2f; }
        .actions-header i { font-size: 12px; transition: transform 0.2s; color: #1f3d62; }

        .actions-panel {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 6px; padding: 6px 0; transition: all 0.2s; max-height: 180px; overflow: hidden;
        }
        .actions-panel.collapsed { max-height: 0; padding: 0; opacity: 0; pointer-events: none; }

        .btn {
            padding: 0.2rem 1rem; border: 1px solid #2b4a73; background: white;
            border-radius: 30px; font-size: 0.7rem; font-weight: 600; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center;
            gap: 4px; transition: 0.2s; color: #0b1f33; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-primary { background: #0a1c2f; color: white; border: none; }
        .btn-primary:hover { background: #1f3d62; }
        .btn:hover { background: #e6efff; }
        /* Active filter state ‚Äî used for Hide Completed when active */
        .btn.btn-active { background: #0a1c2f; color: white; border-color: #0a1c2f; }
        .btn.btn-active:hover { background: #1f3d62; }

        .filter-group {
            display: flex; align-items: center; gap: 4px; background: white;
            border: 1px solid #b3c7e0; border-radius: 30px; padding: 0.2rem 0.8rem;
        }
        .filter-group label { font-size: 10px; font-weight: 600; color: #1f3d62; }
        .filter-group select { border: none; outline: none; font-size: 11px; background: transparent; cursor: pointer; color: #0a1c2f; }

        .search-box {
            display: flex; align-items: center; background: white;
            border: 1px solid #b3c7e0; border-radius: 30px; padding: 0.2rem 0.8rem;
        }
        .search-box input { border: none; padding: 2px 4px; width: 100%; outline: none; font-size: 11px; background: transparent; color: #0a1c2f; }
        .search-box input::placeholder { color: #7f96b3; }

        /* ‚îÄ‚îÄ SPLIT CONTAINER ‚îÄ‚îÄ */
        .split-container { flex: 1; display: flex; min-height: 0; overflow: hidden; border-top: 2px solid #1f3d62; }

        /* Left panel ‚Äî flex:1 so it expands when gantt hidden */
        .left-panel {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
            background: white; border-right: 2px solid #1f3d62;
            transition: border-right 0.25s;
        }
        .left-panel.gantt-hidden { border-right: none; }

        /* Panel header with gantt toggle */
        .panel-header {
            padding: 4px 8px; background: #b8cde0; border-bottom: 2px solid #1f3d62;
            font-weight: 700; font-size: 12px; color: #0a1c2f;
            display: flex; align-items: center; justify-content: space-between;
        }
        .panel-header-left { display: flex; align-items: center; gap: 6px; }

        /* Gantt toggle button */
        .toggle-gantt-btn {
            padding: 2px 10px; border: 1px solid #2b4a73; background: white;
            border-radius: 20px; font-size: 0.62rem; font-weight: 700; cursor: pointer;
            display: inline-flex; align-items: center; gap: 4px; color: #0b1f33;
            transition: 0.15s; white-space: nowrap; line-height: 1.7;
        }
        .toggle-gantt-btn:hover { background: #0a1c2f; color: white; border-color: #0a1c2f; }
        .toggle-gantt-btn.is-off { background: #ecf3fc; border-color: #97adc9; color: #7f96b3; }
        .toggle-gantt-btn.is-off:hover { background: #0a1c2f; color: white; border-color: #0a1c2f; }

        .table-container { flex: 1; overflow: auto !important; position: relative; background: white; scrollbar-width: thin; scrollbar-color: #97adc9 #ecf2fa; }
        .table-container::-webkit-scrollbar { width: 10px; height: 10px; background: #ecf2fa; }
        .table-container::-webkit-scrollbar-thumb { background: #97adc9; border-radius: 8px; border: 2px solid #ecf2fa; }

        .task-table { border-collapse: collapse; font-size: 11px; min-width: 1000px; width: 100%; }

        .task-table th {
            background: #d4e2f2; font-weight: 700; font-size: 0.65rem; padding: 6px 4px;
            border: 1px solid #9bb1cc; position: sticky; top: 0; z-index: 20;
            white-space: nowrap; text-align: center; color: #0a1c2f; border-bottom: 2px solid #1f3d62;
        }
        .task-table td { padding: 4px 4px; border: 1px solid #c7d6ec; white-space: nowrap; vertical-align: middle; color: #0a1c2f; font-size: 0.68rem; }
        .task-table tbody tr:hover td { background: #e3ecf7; }

        .main-task-row td { font-weight: 700; background: #ecf3fc; }
        .main-task-row td:first-child { font-weight: 700; padding-left: 6px; }

        /* Compact TASK ID column */
        .task-table th:nth-child(1)  { min-width: 52px; width: 58px; }
        .task-table td:nth-child(1)  { max-width: 65px; overflow: hidden; text-overflow: ellipsis; font-size: 0.62rem; }
        .task-table th:nth-child(2)  { min-width: 35px; }
        .task-table th:nth-child(3)  { min-width: 160px; }
        .task-table th:nth-child(4)  { min-width: 80px; }
        .task-table th:nth-child(5)  { min-width: 65px; }
        .task-table th:nth-child(6)  { min-width: 60px; }
        .task-table th:nth-child(7)  { min-width: 60px; }
        .task-table th:nth-child(8)  { min-width: 35px; }
        .task-table th:nth-child(9)  { min-width: 65px; }
        .task-table th:nth-child(10) { min-width: 65px; }
        .task-table th:nth-child(11) { min-width: 65px; }
        .task-table th:nth-child(12) { min-width: 75px; }
        .task-table th:nth-child(13) { min-width: 45px; }

        .status-badge {
            display: inline-block; padding: 2px 6px; border-radius: 30px;
            font-size: 0.55rem; font-weight: 700; border: 1px solid #9bb7da;
            background: #e1ecfe; color: #1d3a5c; text-align: center; width: 100%;
        }
        .status-COMPLETED { background: #d4e2f2; border-color: #2b4a73; }
        .status-ONGOING   { background: #b8cde0; border-color: #1f3d62; }
        .status-PENDING   { background: #ecf3fc; border-color: #97adc9; }

        .total-cost { font-size: 0.68rem; font-weight: 600; color: #0a1c2f; text-align: right; width: 100%; }

        .subtask-row td    { background: #f8f8f8; font-weight: 400; }
        .subtask-desc      { padding-left: 24px !important; position: relative; }
        .subtask-desc::before { content: "‚Ü≥"; position: absolute; left: 12px; color: #1f3d62; font-size: 0.7rem; }
        .subsubtask-row td { background: #f0f0f0; font-weight: 400; }
        .task-prefix { color: #4a6a8a; font-size: 10px; margin-right: 3px; display: inline-block; font-weight: 500; }

        .empty-row td { background: #f9fcff; padding: 4px 4px; border: 1px solid #c7d6ec; }
        .empty-row:hover td { background: #e3ecf7; }
        .empty-row .empty-text { display: block; min-width: 80px; outline: none; color: #4a6a8a; font-size: 0.68rem; }

        .menu-container  { position: relative; display: inline-block; }
        .menu-trigger    { cursor: pointer; padding: 2px 6px; border: none; background: transparent; font-size: 14px; font-weight: bold; color: #2b4a73; }
        .menu-trigger:hover { background: #e6efff; border-radius: 30px; }
        .menu-dropdown   { position: absolute; right: 0; top: 100%; background: white; border: 2px solid #1f3d62; border-radius: 6px; min-width: 110px; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,20,40,0.2); }
        .menu-dropdown.show { display: block; }
        .menu-item { padding: 6px 10px; cursor: pointer; font-size: 11px; border-bottom: 1px solid #b3c7e0; display: flex; align-items: center; gap: 6px; color: #0a1c2f; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:hover { background: #e6efff; }

        .empty-state { text-align: center; padding: 40px; color: #7f96b3; font-size: 0.8rem; }

        /* ‚îÄ‚îÄ RIGHT PANEL ‚Äî collapses smoothly to 0 when gantt hidden ‚îÄ‚îÄ */
        .right-panel {
            width: 50%; flex-shrink: 0; display: flex; flex-direction: column;
            overflow: hidden; background: white;
            transition: width 0.28s ease, opacity 0.2s ease;
        }
        .right-panel.gantt-hidden { width: 0 !important; opacity: 0; pointer-events: none; }

        .gantt-header { padding: 4px 8px; background: #b8cde0; border-bottom: 2px solid #1f3d62; display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 12px; color: #0a1c2f; white-space: nowrap; }
        .gantt-container { flex: 1; overflow: auto !important; padding: 6px; background: white; scrollbar-width: thin; scrollbar-color: #97adc9 #ecf2fa; }
        .gantt-container::-webkit-scrollbar { width: 10px; height: 10px; background: #ecf2fa; }
        .gantt-container::-webkit-scrollbar-thumb { background: #97adc9; border-radius: 8px; border: 2px solid #ecf2fa; }
        .gantt-table { border-collapse: collapse; font-size: 10px; min-width: 800px; }
        .gantt-table th { background: #d4e2f2; padding: 4px 2px; border: 1px solid #9bb1cc; border-bottom: 2px solid #1f3d62; position: sticky; top: 0; z-index: 10; font-size: 0.6rem; font-weight: 700; color: #0a1c2f; }
        .gantt-table td { border: 1px solid #c7d6ec; padding: 0; text-align: center; color: #0a1c2f; cursor: pointer; font-size: 0.6rem; height: 18px; }
        .gantt-table td:hover { filter: brightness(0.88); }
        /* Solid filled cells ‚Äî no divs inside, entire TD gets background */
        .gantt-td-main   { background: #2b4a73 !important; border-color: #1f3562 !important; }
        .gantt-td-sub    { background: #4a7aaa !important; border-color: #3a6090 !important; }
        .gantt-td-subsub { background: #7fb3d9 !important; border-color: #6a9fbf !important; }
        .gantt-td-pending-main   { background: #7f96b3 !important; border-color: #6a82a0 !important; }
        .gantt-td-pending-sub    { background: #a0b8d0 !important; border-color: #8aa8c0 !important; }
        .gantt-td-pending-subsub { background: #c0d4e6 !important; border-color: #b0c8da !important; }
        .gantt-td-done   { background: #059669 !important; border-color: #047857 !important; }
        .today-highlight { background: #fce3cd !important; font-weight: bold; }
        .current-month-btn { padding: 0.2rem 1.2rem; border: 1px solid #2b4a73; background: white; border-radius: 30px; cursor: pointer; font-size: 0.65rem; font-weight: 600; color: #0b1f33; }
        .current-month-btn:hover { background: #0a1c2f; color: white; }

        tr.budget-exceeded td { background-color: #f22626 !important; color: #000 !important; border-color: #f22626; }
        tr.budget-exceeded .status-badge { background: white !important; color: #ff6b6b !important; border-color: white !important; }

        .cost-clickable {
            cursor: pointer; color: #2b4a73; font-weight: 600;
            text-decoration: none; display: block; width: 100%;
            min-height: 18px; text-align: right; padding: 1px 3px; border-radius: 3px;
        }
        .cost-clickable:hover { background: #fbcba5 !important; text-decoration: none; }
        .cost-clickable.cost-zero::before { content: '+'; color: #97adc9; font-size: 0.7rem; font-weight: 700; }

        /* =============================================
           MODALS
           ============================================= */
        .allocation-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.55); align-items: center; justify-content: center; z-index: 2000;
        }
        .allocation-overlay.active { display: flex; }

        .allocation-modal {
            background: white; width: 96vw; max-width: 1200px; max-height: 92vh;
            border-radius: 14px; box-shadow: 0 24px 60px rgba(0,20,40,0.45);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .allocation-modal.labor-modal { max-width: 1100px; }

        .modal-head {
            padding: 0.9rem 1.4rem; background: #0a1c2f; color: white;
            display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
        }
        .modal-head h3 { font-size: 0.95rem; font-weight: 600; }
        .modal-head-right { display: flex; align-items: center; gap: 12px; }
        .modal-head .modal-close { cursor: pointer; font-size: 1.1rem; color: #97adc9; transition: color 0.15s; }
        .modal-head .modal-close:hover { color: white; }

        .history-link {
            font-size: 0.68rem; color: #97adc9; text-decoration: none;
            border: 1px solid rgba(255,255,255,0.2); border-radius: 20px;
            padding: 3px 10px; display: flex; align-items: center; gap: 5px; transition: 0.15s;
        }
        .history-link:hover { background: rgba(255,255,255,0.1); color: white; border-color: white; }

        .task-context-bar {
            background: #f2f6fc; border-bottom: 2px solid #d0dff0;
            padding: 8px 16px; display: flex; gap: 20px; flex-shrink: 0; flex-wrap: wrap;
        }
        .ctx-item  { display: flex; align-items: center; gap: 5px; }
        .ctx-label { font-size: 0.62rem; font-weight: 700; color: #7f96b3; text-transform: uppercase; letter-spacing: 0.4px; }
        .ctx-value { font-size: 0.75rem; font-weight: 700; color: #0a1c2f; }
        .ctx-badge { background: #e6efff; color: #0a1c2f; padding: 2px 8px; border-radius: 20px; font-size: 0.68rem; font-weight: 700; }

        .modal-body { flex: 1; overflow-y: auto; padding: 0; }
        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-thumb { background: #97adc9; border-radius: 4px; }

        .entry-table-wrap { overflow-x: auto; padding: 12px 16px 0; }

        /* Material entry table */
        .entry-table { width: 100%; border-collapse: collapse; font-size: 0.72rem; min-width: 900px; }
        .entry-table th {
            background: #d4e2f2; color: #0a1c2f; font-weight: 700;
            font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.4px;
            padding: 8px 10px; border: 1px solid #b3c7e0; border-bottom: 2px solid #1f3d62;
            white-space: nowrap; text-align: left; position: sticky; top: 0; z-index: 5;
        }
        .entry-table td { padding: 6px 6px; border: 1px solid #d0dff0; vertical-align: middle; background: white; }
        .entry-table tr:hover td { background: #f4f8fd; }

        /* Labor entry table ‚Äî full 12-column form */
        .labor-entry-table { width: 100%; border-collapse: collapse; font-size: 0.72rem; min-width: 1100px; }
        .labor-entry-table th {
            background: #d4e2f2; color: #0a1c2f; font-weight: 700;
            font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.4px;
            padding: 8px 10px; border: 1px solid #b3c7e0; border-bottom: 2px solid #1f3d62;
            white-space: nowrap; text-align: left; position: sticky; top: 0; z-index: 5;
        }
        .labor-entry-table td { padding: 6px 6px; border: 1px solid #d0dff0; vertical-align: middle; background: white; }
        .labor-entry-table tr:hover td { background: #f4f8fd; }

        .cell-readonly {
            font-size: 0.72rem; color: #0a1c2f; font-weight: 600; padding: 4px 6px;
            background: #f4f8fd; border-radius: 4px; display: block; white-space: nowrap;
        }
        .cell-input {
            width: 100%; padding: 5px 7px; border: 1px solid #b3c7e0; border-radius: 6px;
            font-size: 0.75rem; background: white; outline: none; color: #0a1c2f; transition: border-color 0.15s;
        }
        .cell-input:focus { border-color: #2b4a73; box-shadow: 0 0 0 2px rgba(43,74,115,0.12); }
        .cell-input.is-invalid { border-color: #cc0000; background: #fff5f5; }
        .cell-select {
            width: 100%; padding: 5px 7px; border: 1px solid #b3c7e0; border-radius: 6px;
            font-size: 0.72rem; background: white; outline: none; color: #0a1c2f;
        }
        .cell-select:focus { border-color: #2b4a73; }

        .amount-cell { font-weight: 700; color: #059669; font-size: 0.82rem; white-space: nowrap; text-align: right; padding-right: 4px; }
        .amount-cell.zero { color: #b3c7e0; }

        .remove-entry-btn {
            width: 26px; height: 26px; border: none; background: #ffe5e5; color: #cc0000;
            border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold;
            display: flex; align-items: center; justify-content: center; margin: auto;
            transition: background 0.15s; flex-shrink: 0;
        }
        .remove-entry-btn:hover { background: #ffc0c0; }

        .add-entry-row { padding: 0 16px 10px; margin-top: 6px; }
        .add-entry-btn {
            display: inline-flex; align-items: center; gap: 6px; padding: 7px 16px;
            background: #eaf2ff; border: 1px dashed #2b4a73; border-radius: 8px;
            font-size: 0.75rem; font-weight: 600; color: #1f3d62; cursor: pointer;
            transition: background 0.15s; width: 100%; justify-content: center;
        }
        .add-entry-btn:hover { background: #d4e4ff; }

        .stock-warning {
            color: #cc0000; font-size: 0.72rem; margin: 6px 16px 0; padding: 7px 10px;
            background: #ffe5e5; border-radius: 6px; border-left: 3px solid #cc0000; display: none;
        }

        .grand-total-bar {
            display: flex; align-items: center; justify-content: space-between;
            background: #0a1c2f; color: white; padding: 10px 20px;
            margin: 10px 16px 12px; border-radius: 8px; flex-shrink: 0;
        }
        .grand-total-bar .gt-label { font-size: 0.75rem; opacity: 0.75; }
        .grand-total-bar .gt-value  { font-size: 1.15rem; font-weight: 700; letter-spacing: -0.5px; }

        .modal-foot {
            padding: 0.75rem 1.4rem; border-top: 1px solid #e0e8f5;
            display: flex; gap: 8px; flex-shrink: 0; background: #fafcff; align-items: center;
        }
        .modal-foot button { padding: 0.6rem 1.4rem; border-radius: 8px; border: none; font-weight: 600; font-size: 0.78rem; cursor: pointer; transition: all 0.15s; }
        .btn-cancel { background: white; border: 1px solid #b3c7e0 !important; color: #0a1c2f; }
        .btn-cancel:hover { background: #e6efff; }
        .btn-save { background: #059669; color: white; margin-left: auto; }
        .btn-save:hover { background: #047857; }
        .modal-foot .enter-hint { font-size: 0.62rem; color: #97adc9; display: flex; align-items: center; gap: 5px; }
        .enter-hint kbd { background: #e6efff; color: #2b4a73; border: 1px solid #b3c7e0; border-radius: 4px; padding: 1px 5px; font-size: 0.65rem; font-family: monospace; }

        /* ‚îÄ‚îÄ PURCHASE MODE TOGGLE ‚îÄ‚îÄ */
        .purchase-toggle-bar {
            display: flex; align-items: center; gap: 0;
            background: #f2f6fc; border-bottom: 2px solid #d0dff0;
            padding: 8px 16px; flex-shrink: 0;
        }
        .ptb-label {
            font-size: 0.7rem; font-weight: 700; color: #7f96b3;
            text-transform: uppercase; letter-spacing: 0.5px; margin-right: 14px;
        }
        .ptb-option {
            display: flex; align-items: center; gap: 7px;
            padding: 5px 16px; border-radius: 30px; cursor: pointer;
            font-size: 0.72rem; font-weight: 600; color: #4a6a8a;
            border: 2px solid transparent; transition: all 0.18s; user-select: none;
        }
        .ptb-option.active-inventory {
            background: #0a1c2f; color: white; border-color: #0a1c2f;
        }
        .ptb-option.active-direct {
            background: #d97706; color: white; border-color: #d97706;
        }
        .ptb-option:not(.active-inventory):not(.active-direct):hover {
            background: #e6efff; border-color: #b3c7e0;
        }
        .ptb-divider {
            width: 1px; height: 20px; background: #b3c7e0; margin: 0 4px;
        }
        .ptb-desc {
            margin-left: 14px; font-size: 0.65rem; color: #7f96b3; font-style: italic;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           TASK FILTER PICKER DROPDOWN
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .task-filter-dropdown {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 3000; display: none; align-items: flex-start; justify-content: flex-start;
        }
        .task-filter-dropdown.open { display: flex; }
        .task-filter-backdrop {
            position: absolute; inset: 0; background: rgba(0,0,0,0.25);
        }
        .task-filter-panel {
            position: absolute; background: white; border-radius: 12px;
            box-shadow: 0 12px 40px rgba(0,20,40,0.3); border: 2px solid #1f3d62;
            min-width: 280px; max-width: 360px; max-height: 70vh;
            display: flex; flex-direction: column; overflow: hidden; z-index: 1;
        }
        .tfp-head {
            background: #0a1c2f; color: white; padding: 10px 14px;
            display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
        }
        .tfp-head h4 { font-size: 0.85rem; font-weight: 600; }
        .tfp-head-actions { display: flex; gap: 6px; align-items: center; }
        .tfp-btn {
            padding: 3px 10px; border-radius: 20px; font-size: 0.65rem; font-weight: 700;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.3); background: transparent;
            color: white; transition: 0.15s;
        }
        .tfp-btn:hover { background: rgba(255,255,255,0.15); }
        .tfp-search {
            padding: 8px 12px; border-bottom: 1px solid #e0e8f5; flex-shrink: 0;
        }
        .tfp-search input {
            width: 100%; padding: 6px 10px; border: 1px solid #b3c7e0; border-radius: 20px;
            font-size: 0.72rem; outline: none; color: #0a1c2f;
        }
        .tfp-search input:focus { border-color: #2b4a73; }
        .tfp-list {
            flex: 1; overflow-y: auto; padding: 6px 0;
            scrollbar-width: thin; scrollbar-color: #97adc9 #ecf2fa;
        }
        .tfp-list::-webkit-scrollbar { width: 6px; }
        .tfp-list::-webkit-scrollbar-thumb { background: #97adc9; border-radius: 4px; }
        .tfp-item {
            display: flex; align-items: center; gap: 10px; padding: 8px 14px;
            cursor: pointer; transition: background 0.12s; border-bottom: 1px solid #f0f4fa;
        }
        .tfp-item:last-child { border-bottom: none; }
        .tfp-item:hover { background: #f0f5ff; }
        .tfp-item input[type="checkbox"] {
            width: 15px; height: 15px; accent-color: #0a1c2f; cursor: pointer; flex-shrink: 0;
        }
        .tfp-item-label {
            font-size: 0.72rem; color: #0a1c2f; font-weight: 500; flex: 1; line-height: 1.3;
        }
        .tfp-item-id {
            font-size: 0.6rem; color: #7f96b3; font-weight: 600; background: #e6efff;
            padding: 1px 5px; border-radius: 10px; flex-shrink: 0;
        }
        .tfp-foot {
            padding: 10px 14px; border-top: 2px solid #1f3d62; display: flex; gap: 6px;
            flex-shrink: 0; background: #f7faff;
        }
        .tfp-apply {
            flex: 1; padding: 7px; background: #0a1c2f; color: white; border: none;
            border-radius: 8px; font-size: 0.75rem; font-weight: 700; cursor: pointer;
            transition: background 0.15s;
        }
        .tfp-apply:hover { background: #1f3d62; }
        .tfp-clear {
            padding: 7px 14px; background: white; color: #0a1c2f; border: 1px solid #b3c7e0;
            border-radius: 8px; font-size: 0.75rem; font-weight: 600; cursor: pointer;
            transition: 0.15s;
        }
        .tfp-clear:hover { background: #e6efff; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           FLOATING NOTES PANEL
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .notes-panel {
            position: fixed; bottom: 20px; right: 20px; width: 320px;
            background: white; border-radius: 14px; border: 2px solid #1f3d62;
            box-shadow: 0 12px 40px rgba(0,20,40,0.3); z-index: 3500;
            display: flex; flex-direction: column; overflow: hidden;
            transform: translateY(calc(100% + 30px)); opacity: 0;
            transition: transform 0.28s cubic-bezier(.4,0,.2,1), opacity 0.22s ease;
            pointer-events: none; max-height: 480px;
        }
        .notes-panel.open {
            transform: translateY(0); opacity: 1; pointer-events: all;
        }
        .notes-fab {
            position: fixed; bottom: 20px; right: 20px; width: 46px; height: 46px;
            background: #0a1c2f; color: white; border: none; border-radius: 50%;
            font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 14px rgba(0,20,40,0.35);
            display: flex; align-items: center; justify-content: center; z-index: 3600;
            transition: background 0.15s, transform 0.2s;
        }
        .notes-fab:hover { background: #1f3d62; transform: scale(1.08); }
        .notes-fab.panel-open { background: #1f3d62; }
        /* Dot indicator when notes have content */
        .notes-fab .notes-dot {
            position: absolute; top: 6px; right: 6px; width: 8px; height: 8px;
            background: #fbbf24; border-radius: 50%; border: 2px solid white;
            display: none;
        }
        .notes-fab .notes-dot.has-content { display: block; }
        .notes-panel-head {
            background: #0a1c2f; color: white; padding: 10px 14px;
            display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
        }
        .notes-panel-head span { font-size: 0.82rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .notes-close-btn {
            background: none; border: none; color: #97adc9; font-size: 1rem;
            cursor: pointer; transition: color 0.15s; padding: 2px 4px;
        }
        .notes-close-btn:hover { color: white; }
        .notes-textarea {
            flex: 1; border: none; outline: none; resize: none;
            padding: 14px 14px; font-size: 0.78rem; font-family: inherit;
            color: #0a1c2f; line-height: 1.7; min-height: 220px;
            scrollbar-width: thin; scrollbar-color: #97adc9 #ecf2fa;
        }
        .notes-textarea::-webkit-scrollbar { width: 5px; }
        .notes-textarea::-webkit-scrollbar-thumb { background: #97adc9; border-radius: 4px; }
        .notes-textarea::placeholder { color: #b3c7e0; }
        .notes-foot {
            padding: 8px 12px; border-top: 1px solid #e0e8f5;
            display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
            background: #f7faff;
        }
        .notes-saved-txt { font-size: 0.62rem; color: #7f96b3; display: flex; align-items: center; gap: 4px; }
        .notes-clear-btn {
            padding: 4px 10px; background: white; border: 1px solid #e0e8f5;
            border-radius: 6px; font-size: 0.65rem; color: #cc3333; cursor: pointer;
            font-weight: 600; transition: 0.12s;
        }
        .notes-clear-btn:hover { background: #ffe5e5; border-color: #cc3333; }
</style>
</head>
<body>
<main class="main-content">
    <div class="project-header">
        <div class="title-section">
            <i class="fas fa-tasks" style="font-size:16px;"></i>
            <h2 id="projectTitle">Project Tasks</h2>
        </div>
        <a href="dashboard.html" class="back-link"><i class="fas fa-arrow-left"></i> Dashboard</a>
    </div>

    <div class="project-info">
        <div class="manager-info">
            <div><span class="label">PM:</span> <span class="value">Christopher Chishela</span></div>
        </div>
    </div>

    <div class="actions-container">
        <div class="actions-header" id="actionsHeader">
            <h3><i class="fas fa-sliders-h"></i> Filters & Actions</h3>
            <i class="fas fa-chevron-down" id="toggleIcon"></i>
        </div>
        <div class="actions-panel" id="actionsPanel">
            <button class="btn btn-primary" id="addTaskBtn"><i class="fas fa-plus"></i> Add Task</button>
            <button class="btn" id="toggleCompletedBtn"><i class="fas fa-eye-slash"></i> Hide Completed</button>
            <a href="#" class="btn" id="completedtasksBtn"><i class="fas fa-check-circle"></i> Completed</a>
            <button class="btn" id="addEmptyRowBtn"><i class="fas fa-plus-circle"></i> Add Empty Row</button>
            <button class="btn" id="taskFilterBtn"><i class="fas fa-filter"></i> Filter Tasks <span id="taskFilterCount" style="display:none;background:#0a1c2f;color:white;border-radius:20px;padding:1px 6px;font-size:0.6rem;margin-left:2px;"></span></button>
            <a href="#" class="btn" id="matHistoryNavBtn" style="background:#0a1c2f;color:white;border:none">
                <i class="fas fa-history"></i> Material History
            </a>
            <a href="#" class="btn" id="labHistoryNavBtn" style="background:#0a1c2f;color:white;border:none">
                <i class="fas fa-history"></i> Labor History
            </a>
            <div class="search-box">
                <i class="fas fa-search" style="color:#000;"></i>
                <input type="text" id="searchInput" placeholder="Search...">
            </div>
            <div class="filter-group">
                <label>Status:</label>
                <select id="statusFilter">
                    <option value="">All</option>
                    <option value="COMPLETED">Completed</option>
                    <option value="ONGOING">Ongoing</option>
                    <option value="PENDING">Pending</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Month:</label>
                <select id="monthFilter">
                    <option value="">All</option>
                    <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
                    <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
                    <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
                    <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Year:</label>
                <select id="yearFilter">
                    <option value="">All</option>
                    <option value="2023">2023</option><option value="2024">2024</option>
                    <option value="2025">2025</option><option value="2026">2026</option>
                </select>
            </div>
        </div>
    </div>

    <div class="split-container">
        <!-- LEFT: task list -->
        <div class="left-panel" id="leftPanel">
            <div class="panel-header">
                <div class="panel-header-left">
                    <i class="fas fa-tasks"></i>
                    <span>Task List</span>
                </div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <!-- Notes toggle -->
                    <button class="toggle-gantt-btn" id="toggleNotesBtn" title="Notes">
                        <i class="fas fa-sticky-note"></i>
                        <span>Notes</span>
                    </button>
                    <!-- Gantt toggle ‚Äî always visible -->
                    <button class="toggle-gantt-btn" id="toggleGanttBtn">
                        <i class="fas fa-eye-slash" id="toggleGanttIcon"></i>
                        <span id="toggleGanttLabel">Hide Gantt</span>
                    </button>
                </div>
            </div>
            <div class="table-container" id="tableContainer">
                <table class="task-table" id="taskTable">
                    <thead>
                        <tr>
                            <th>TASK ID</th><th>LINE</th><th>DESCRIPTION</th><th>ASSIGNED</th>
                            <th>STATUS</th><th>START</th><th>END</th><th>HRS</th>
                            <th>MAT COST</th><th>MAN COST</th><th>TOTAL</th><th>LOCATION</th><th>‚ö°</th>
                        </tr>
                    </thead>
                    <tbody id="taskList"></tbody>
                </table>
                <div class="empty-state" id="emptyState" style="display:none;">
                    <i class="fas fa-tasks fa-3x"></i><p>No tasks found</p>
                </div>
            </div>
        </div>

        <!-- RIGHT: Gantt -->
        <div class="right-panel" id="rightPanel">
            <div class="gantt-header">
                <span><i class="fas fa-calendar-alt"></i> Gantt Calendar</span>
                <button class="current-month-btn" id="currentMonthBtn">Current Month</button>
            </div>
            <div class="gantt-container" id="ganttContainer">
                <table class="gantt-table">
                    <thead id="ganttHead"></thead>
                    <tbody id="ganttBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TASK FILTER PICKER
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="task-filter-dropdown" id="taskFilterDropdown">
    <div class="task-filter-backdrop" id="taskFilterBackdrop"></div>
    <div class="task-filter-panel" id="taskFilterPanel">
        <div class="tfp-head">
            <h4><i class="fas fa-filter"></i> Filter Main Tasks</h4>
            <div class="tfp-head-actions">
                <button class="tfp-btn" id="tfpSelectAll">All</button>
                <button class="tfp-btn" id="tfpClearAll">None</button>
            </div>
        </div>
        <div class="tfp-search">
            <input type="text" id="tfpSearch" placeholder="Search tasks...">
        </div>
        <div class="tfp-list" id="tfpList"></div>
        <div class="tfp-foot">
            <button class="tfp-clear" id="tfpClearFilter">Show All</button>
            <button class="tfp-apply" id="tfpApply"><i class="fas fa-check"></i> Apply Filter</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FLOATING NOTES FAB + PANEL
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<button class="notes-fab" id="notesFab" title="Notes">
    <i class="fas fa-sticky-note"></i>
    <div class="notes-dot" id="notesDot"></div>
</button>

<div class="notes-panel" id="notesPanel">
    <div class="notes-panel-head">
        <span><i class="fas fa-sticky-note"></i> Project Notes</span>
        <button class="notes-close-btn" id="notesCloseBtn" title="Close notes"><i class="fas fa-times"></i></button>
    </div>
    <textarea class="notes-textarea" id="notesTextarea" placeholder="Write your project notes here‚Ä¶"></textarea>
    <div class="notes-foot">
        <span class="notes-saved-txt" id="notesSavedTxt"><i class="fas fa-check-circle" style="color:#059669"></i> Saved</span>
        <button class="notes-clear-btn" onclick="clearNotes()">Clear</button>
    </div>
</div>

<!-- =============================================
     MATERIAL MODAL
     ============================================= -->
<div class="allocation-overlay" id="materialAllocOverlay">
    <div class="allocation-modal">
        <div class="modal-head">
            <h3>üì¶ Assign Materials ‚Äî <span id="taskNameMaterial">Task</span></h3>
            <div class="modal-head-right">
                <a href="#" class="history-link" id="matHistoryLink" target="_blank">
                    <i class="fas fa-history"></i> View History
                </a>
                <i class="fas fa-times modal-close" onclick="closeMaterialAllocModal()"></i>
            </div>
        </div>
        <div class="task-context-bar">
            <div class="ctx-item"><span class="ctx-label">Task ID</span><span class="ctx-badge" id="ctxTaskId">‚Äî</span></div>
            <div class="ctx-item"><span class="ctx-label">Line</span><span class="ctx-value" id="ctxLine">‚Äî</span></div>
            <div class="ctx-item"><span class="ctx-label">Description</span><span class="ctx-value" id="ctxDescription">‚Äî</span></div>
            <div class="ctx-item"><span class="ctx-label">Location</span><span class="ctx-value" id="ctxLocation">‚Äî</span></div>
        </div>

        <!-- ‚îÄ‚îÄ PURCHASE MODE TOGGLE ‚îÄ‚îÄ -->
        <div class="purchase-toggle-bar">
            <span class="ptb-label">Source:</span>
            <div class="ptb-option active-inventory" id="ptbInventory" onclick="setPurchaseMode('inventory')">
                <i class="fas fa-warehouse"></i> Assign from Inventory
            </div>
            <div class="ptb-divider"></div>
            <div class="ptb-option" id="ptbDirect" onclick="setPurchaseMode('direct')">
                <i class="fas fa-shopping-cart"></i> Direct Purchase
            </div>
            <span class="ptb-desc" id="ptbDesc">Deducts from stock</span>
        </div>

        <div class="modal-body">
            <div class="entry-table-wrap">
                <table class="entry-table">
                    <thead>
                        <tr id="matEntryHead">
                            <th style="min-width:36px">#</th>
                            <th style="min-width:70px">Task ID</th>
                            <th style="min-width:40px">Line</th>
                            <th style="min-width:140px">Description</th>
                            <th style="min-width:220px" id="matColMaterial">Material</th>
                            <th style="min-width:85px">Quantity</th>
                            <th style="min-width:100px">Unit Price</th>
                            <th style="min-width:100px">Amount</th>
                            <th style="min-width:130px">Location</th>
                            <th style="min-width:160px">Assigned At</th>
                            <th style="min-width:40px;text-align:center">‚úï</th>
                        </tr>
                    </thead>
                    <tbody id="matEntryBody"></tbody>
                </table>
            </div>
            <div class="add-entry-row">
                <button class="add-entry-btn" onclick="addMaterialEntryRow()">
                    <i class="fas fa-plus"></i> Add Another Row
                </button>
            </div>
            <div id="matStockWarning" class="stock-warning"></div>
            <div class="grand-total-bar">
                <span class="gt-label">Total Material Cost</span>
                <span class="gt-value" id="matGrandTotal">0.00</span>
            </div>
        </div>
        <div class="modal-foot">
            <span class="enter-hint"><kbd>Enter</kbd> next row &nbsp;|&nbsp; <kbd>Tab</kbd> between fields</span>
            <button class="btn-cancel" onclick="closeMaterialAllocModal()">Cancel</button>
            <button class="btn-save" onclick="assignMaterials()"><i class="fas fa-check"></i> Save All</button>
        </div>
    </div>
</div>

<!-- =============================================
     LABOR MODAL ‚Äî FULL 12-COLUMN TABLE
     # | EMPLOYEE ID | NAME | PROJECT NAME | LOCATION | TASK ID | DESCRIPTION | STATUS | TRANSFER DATE | MH | COST | ‚úï
     ============================================= -->
<div class="allocation-overlay" id="laborAllocOverlay">
    <div class="allocation-modal labor-modal">
        <div class="modal-head">
            <h3>üë∑ Assign Labor ‚Äî <span id="taskNameLabor">Task</span></h3>
            <div class="modal-head-right">
                <a href="#" class="history-link" id="labHistoryLink" target="_blank">
                    <i class="fas fa-history"></i> View History
                </a>
                <i class="fas fa-times modal-close" onclick="closeLaborAllocModal()"></i>
            </div>
        </div>
        <div class="task-context-bar">
            <div class="ctx-item"><span class="ctx-label">TASK ID</span><span class="ctx-badge" id="labCtxTaskId">‚Äî</span></div>
            <div class="ctx-item"><span class="ctx-label">DESCRIPTION</span><span class="ctx-value" id="labCtxDesc">‚Äî</span></div>
            <div class="ctx-item"><span class="ctx-label">LOCATION</span><span class="ctx-value" id="labCtxLoc">‚Äî</span></div>
            <div class="ctx-item"><span class="ctx-label">PROJECT</span><span class="ctx-value" id="labCtxProject">‚Äî</span></div>
        </div>
        <div class="modal-body">
            <div class="entry-table-wrap">
                <table class="labor-entry-table" id="laborEntryTable">
                    <thead>
                        <tr>
                            <th style="min-width:36px">#</th>
                            <th style="min-width:100px">EMPLOYEE ID</th>
                            <th style="min-width:140px">NAME</th>
                            <th style="min-width:120px">PROJECT NAME</th>
                            <th style="min-width:120px">LOCATION</th>
                            <th style="min-width:80px">TASK ID</th>
                            <th style="min-width:200px">DESCRIPTION</th>
                            <th style="min-width:100px">STATUS</th>
                            <th style="min-width:140px">TRANSFER DATE</th>
                            <th style="min-width:70px">MH</th>
                            <th style="min-width:100px">COST</th>
                            <th style="min-width:36px">‚úï</th>
                        </tr>
                    </thead>
                    <tbody id="labEntryBody"></tbody>
                </table>
            </div>
            <div class="add-entry-row">
                <button class="add-entry-btn" onclick="addLaborEntryRow()">
                    <i class="fas fa-plus"></i> Add Another Worker
                </button>
            </div>
            <div class="grand-total-bar">
                <span class="gt-label">Total Labor Cost</span>
                <span class="gt-value" id="labGrandTotal">0.00</span>
            </div>
        </div>
        <div class="modal-foot">
            <span class="enter-hint"><kbd>Enter</kbd> to save last row &nbsp;|&nbsp; <kbd>Tab</kbd> to move between fields</span>
            <button class="btn-cancel" onclick="closeLaborAllocModal()">Cancel</button>
            <button class="btn-save" onclick="assignLabors()"><i class="fas fa-check"></i> Save All</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import {
    getFirestore, doc, collection, query, where,
    onSnapshot, addDoc, updateDoc, deleteDoc, getDocs, getDoc, Timestamp
} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

document.addEventListener('DOMContentLoaded', function() {

    const firebaseConfig = {
        apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
        authDomain: "project-task-588c4.firebaseapp.com",
        projectId: "project-task-588c4",
        storageBucket: "project-task-588c4.appspot.com",
        messagingSenderId: "411882772509",
        appId: "1:411882772509:web:08d613186c101a99f38ef4"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('id');
    if (!projectId) alert("Project ID missing!");

    // Nav links
    document.getElementById('completedtasksBtn').href = `completedtask.html?id=${projectId}`;
    document.getElementById('matHistoryNavBtn').href  = `material-usage-history.html?id=${projectId}`;
    document.getElementById('matHistoryLink').href    = `material-usage-history.html?id=${projectId}`;
    document.getElementById('labHistoryNavBtn').href  = `employee-assignment-history.html?id=${projectId}`;
    document.getElementById('labHistoryLink').href    = `employee-assignment-history.html?id=${projectId}`;
    document.getElementById('projectTitle').textContent = `Project ${projectId.slice(0,6)}...`;

    // DOM refs
    const actionsHeader      = document.getElementById('actionsHeader');
    const actionsPanel       = document.getElementById('actionsPanel');
    const toggleIcon         = document.getElementById('toggleIcon');
    const currentMonthBtn    = document.getElementById('currentMonthBtn');
    const statusFilter       = document.getElementById('statusFilter');
    const monthFilter        = document.getElementById('monthFilter');
    const yearFilter         = document.getElementById('yearFilter');
    const searchInput        = document.getElementById('searchInput');
    const taskListEl         = document.getElementById('taskList');
    const emptyStateEl       = document.getElementById('emptyState');
    const ganttBodyEl        = document.getElementById('ganttBody');
    const ganttHeadEl        = document.getElementById('ganttHead');
    const addTaskBtn         = document.getElementById('addTaskBtn');
    const addEmptyRowBtn     = document.getElementById('addEmptyRowBtn');
    const toggleCompletedBtn = document.getElementById('toggleCompletedBtn');
    const materialModal      = document.getElementById('materialAllocOverlay');
    const laborModal         = document.getElementById('laborAllocOverlay');
    const matEntryBody       = document.getElementById('matEntryBody');
    const labEntryBody       = document.getElementById('labEntryBody');
    const matGrandTotalEl    = document.getElementById('matGrandTotal');
    const labGrandTotalEl    = document.getElementById('labGrandTotal');
    const matStockWarning    = document.getElementById('matStockWarning');
    const leftPanel          = document.getElementById('leftPanel');
    const rightPanel         = document.getElementById('rightPanel');
    const toggleGanttBtn     = document.getElementById('toggleGanttBtn');
    const toggleGanttLabel   = document.getElementById('toggleGanttLabel');
    const toggleGanttIcon    = document.getElementById('toggleGanttIcon');

    const LABOR_RATE = 18;

    let materials    = [];
    let laborWorkers = [];
    let currentAssigningTaskId      = null;
    let currentAssigningDocId       = null;
    let currentAssigningTaskLevel   = null;
    let currentAssigningParentDocId = null;
    let currentAssigningSubDocId    = null;
    let currentTaskContext          = {};
    let matRowCounter  = 0;
    let labRowCounter  = 0;
    let allTasks       = [];
    let emptyRows      = JSON.parse(localStorage.getItem(`emptyRows_${projectId}`)) || [];
    let showCurrentMonthOnly = false;
    let actionsCollapsed     = localStorage.getItem('actionsCollapsed') === 'true';
    let unsubMain      = null;
    let subUnsubs      = {};
    let openMenuId     = null;
    let unsubMaterials = null;
    let unsubLabor     = null;

    function saveEmptyRows() { localStorage.setItem(`emptyRows_${projectId}`, JSON.stringify(emptyRows)); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HIDE COMPLETED ‚Äî persisted per project in localStorage
    // Stays hidden across page refreshes until user clicks again
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const HIDE_COMPLETED_KEY = `hideCompleted_${projectId}`;
    let hideCompleted = localStorage.getItem(HIDE_COMPLETED_KEY) === 'true';

    function applyHideCompletedUI() {
        if (hideCompleted) {
            toggleCompletedBtn.innerHTML = '<i class="fas fa-eye"></i> Show Completed';
            toggleCompletedBtn.classList.add('btn-active');
        } else {
            toggleCompletedBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Completed';
            toggleCompletedBtn.classList.remove('btn-active');
        }
    }
    // Apply on page load immediately (before tasks even render)
    applyHideCompletedUI();

    toggleCompletedBtn.onclick = () => {
        hideCompleted = !hideCompleted;
        // Persist ‚Äî survives refresh, browser close, everything
        localStorage.setItem(HIDE_COMPLETED_KEY, String(hideCompleted));
        applyHideCompletedUI();
        renderTasks(filterTasks());
        renderGantt();
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GANTT HIDE/SHOW ‚Äî persisted per project in localStorage
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const GANTT_KEY = `ganttVisible_${projectId}`;
    let ganttVisible = localStorage.getItem(GANTT_KEY) !== 'false'; // default visible

    function applyGanttState() {
        if (ganttVisible) {
            rightPanel.classList.remove('gantt-hidden');
            leftPanel.classList.remove('gantt-hidden');
            toggleGanttLabel.textContent = 'Hide Gantt';
            toggleGanttIcon.className    = 'fas fa-eye-slash';
            toggleGanttBtn.classList.remove('is-off');
        } else {
            rightPanel.classList.add('gantt-hidden');
            leftPanel.classList.add('gantt-hidden');
            toggleGanttLabel.textContent = 'Show Gantt';
            toggleGanttIcon.className    = 'fas fa-calendar-alt';
            toggleGanttBtn.classList.add('is-off');
        }
    }
    applyGanttState(); // apply immediately on load

    toggleGanttBtn.addEventListener('click', () => {
        ganttVisible = !ganttVisible;
        localStorage.setItem(GANTT_KEY, String(ganttVisible));
        applyGanttState();
        if (ganttVisible) renderGantt();
    });

    // Actions panel collapse
    if (actionsCollapsed) { actionsPanel.classList.add('collapsed'); toggleIcon.style.transform = 'rotate(-90deg)'; }
    actionsHeader.addEventListener('click', () => {
        actionsPanel.classList.toggle('collapsed');
        toggleIcon.style.transform = actionsPanel.classList.contains('collapsed') ? 'rotate(-90deg)' : '';
        localStorage.setItem('actionsCollapsed', actionsPanel.classList.contains('collapsed'));
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.menu-container')) {
            openMenuId = null;
            document.querySelectorAll('.menu-dropdown.show').forEach(m => m.classList.remove('show'));
        }
    });
    window.onclick = (e) => {
        if (e.target === materialModal) closeMaterialAllocModal();
        if (e.target === laborModal)    closeLaborAllocModal();
    };
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') { closeMaterialAllocModal(); closeLaborAllocModal(); }
    });

    const fmt        = (n) => (+(n||0)).toFixed(2);
    const formatDate = (d) => d ? new Date(d.toDate ? d.toDate() : d).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '';

    const makeCostCell = (value, taskId, type) => {
        const hasVal    = value && value > 0;
        const zeroClass = hasVal ? '' : ' cost-zero';
        const fn        = type === 'material' ? 'openMaterialAssign' : 'openLaborAssign';
        return `<span class="cost-clickable${zeroClass}" id="${type==='material'?'matCell':'labCell'}_${taskId}" onclick="${fn}('${taskId}')">${hasVal ? fmt(value) : ''}</span>`;
    };

    function updateCostCellInDom(taskId, type, newValue) {
        const id = `${type === 'material' ? 'matCell' : 'labCell'}_${taskId}`;
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = newValue > 0 ? fmt(newValue) : '';
        el.classList.toggle('cost-zero', !(newValue > 0));
        const tr = el.closest('tr');
        if (tr) {
            const matSpan = tr.querySelector('[id^="matCell_"]');
            const labSpan = tr.querySelector('[id^="labCell_"]');
            const totTd   = tr.querySelector('.total-cost');
            if (totTd) {
                const tot = (parseFloat(matSpan?.textContent)||0) + (parseFloat(labSpan?.textContent)||0);
                totTd.textContent = tot > 0 ? fmt(tot) : '';
            }
        }
    }

    function updateHoursCellInDom(taskId, newHours) {
        // HRS column = index 7 (0-based), 13 columns total with ASSIGNED present
        const allRows = document.querySelectorAll('#taskList tr');
        for (const row of allRows) {
            if (row.querySelector(`[id^="matCell_${taskId}"]`) || row.querySelector(`[id^="labCell_${taskId}"]`)) {
                const hrsCell = row.cells[7];
                if (hrsCell) hrsCell.textContent = newHours > 0 ? newHours : '';
                break;
            }
        }
    }

    async function loadResources() {
        try {
            const mSnap = await getDocs(collection(db, "materials"));
            materials = []; mSnap.forEach(d => materials.push({ docId: d.id, ...d.data() }));
            const lSnap = await getDocs(collection(db, "employees"));
            laborWorkers = []; lSnap.forEach(d => laborWorkers.push({ docId: d.id, ...d.data() }));
        } catch(e) { console.error('loadResources:', e); }
    }

    // ‚îÄ‚îÄ‚îÄ Real-time listeners for history collections ‚îÄ‚îÄ‚îÄ
    function listenForMaterialChanges() {
        if (unsubMaterials) unsubMaterials();
        unsubMaterials = onSnapshot(
            query(collection(db, "materialsUsage"), where("projectId", "==", projectId)),
            (snapshot) => {
                const totals = {};
                snapshot.docs.forEach(d => {
                    const x = d.data(); if (x.reversed) return;
                    const tid = x.taskId || x.taskDocId; if (!tid) return;
                    totals[tid] = (totals[tid]||0) + (x.cost || ((parseFloat(x.quantity)||0)*(parseFloat(x.unitPrice)||0)));
                });
                allTasks.forEach(t => {
                    updateTaskMaterialCost(t.id, totals[t.id]||0);
                    t.subTasks?.forEach(sub => {
                        updateTaskMaterialCost(sub.id, totals[sub.id]||0);
                        sub.subSubtasks?.forEach(ss => updateTaskMaterialCost(ss.id, totals[ss.id]||0));
                    });
                });
            },
            (err) => console.error('Material listener:', err)
        );
    }

    function listenForLaborChanges() {
        if (unsubLabor) unsubLabor();
        unsubLabor = onSnapshot(
            query(collection(db, "locationHistory"), where("projectId", "==", projectId)),
            (snapshot) => {
                const costTot = {}, hrsTot = {};
                snapshot.docs.forEach(d => {
                    const x = d.data(); if (x.reversed) return;
                    const tid = x.taskId || x.taskDocId; if (!tid) return;
                    costTot[tid] = (costTot[tid]||0) + (x.cost || ((parseFloat(x.mh)||0)*(parseFloat(x.rate)||LABOR_RATE)));
                    hrsTot[tid]  = (hrsTot[tid]||0)  + (parseFloat(x.mh)||0);
                });
                allTasks.forEach(t => {
                    updateTaskLaborCost(t.id, costTot[t.id]||0);
                    updateTaskHours(t.id, hrsTot[t.id]||0);
                    t.subTasks?.forEach(sub => {
                        updateTaskLaborCost(sub.id, costTot[sub.id]||0);
                        updateTaskHours(sub.id, hrsTot[sub.id]||0);
                        sub.subSubtasks?.forEach(ss => {
                            updateTaskLaborCost(ss.id, costTot[ss.id]||0);
                            updateTaskHours(ss.id, hrsTot[ss.id]||0);
                        });
                    });
                });
            },
            (err) => console.error('Labor listener:', err)
        );
    }

    function findPathFor(taskId) {
        for (const t of allTasks) {
            if (t.id === taskId) return { found: t, level: 'main', parentDocId: null, subDocId: null };
            for (const sub of (t.subTasks||[])) {
                if (sub.id === taskId) return { found: sub, level: 'sub', parentDocId: t.id, subDocId: null };
                for (const ss of (sub.subSubtasks||[])) {
                    if (ss.id === taskId) return { found: ss, level: 'subsub', parentDocId: t.id, subDocId: sub.id };
                }
            }
        }
        return { found: null, level: 'main', parentDocId: null, subDocId: null };
    }

    async function updateTaskMaterialCost(taskId, val) {
        const obj = findTaskObj(taskId); if (obj) obj._matCost = val;
        updateCostCellInDom(taskId, 'material', val);
        const { found, level, parentDocId, subDocId } = findPathFor(taskId);
        if (found) { const r = getTaskDocRef(taskId, level, parentDocId, subDocId); if (r) try { await updateDoc(r, { matCost: val }); } catch(e) { console.warn(e); } }
    }
    async function updateTaskLaborCost(taskId, val) {
        const obj = findTaskObj(taskId); if (obj) obj._labCost = val;
        updateCostCellInDom(taskId, 'labor', val);
        const { found, level, parentDocId, subDocId } = findPathFor(taskId);
        if (found) { const r = getTaskDocRef(taskId, level, parentDocId, subDocId); if (r) try { await updateDoc(r, { labCost: val }); } catch(e) { console.warn(e); } }
    }
    async function updateTaskHours(taskId, val) {
        const obj = findTaskObj(taskId); if (obj) obj._hours = val;
        updateHoursCellInDom(taskId, val);
        const { found, level, parentDocId, subDocId } = findPathFor(taskId);
        if (found) { const r = getTaskDocRef(taskId, level, parentDocId, subDocId); if (r) try { await updateDoc(r, { totalHours: val }); } catch(e) { console.warn(e); } }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MATERIAL MODAL ‚Äî INVENTORY + DIRECT PURCHASE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let currentPurchaseMode = 'inventory'; // 'inventory' | 'direct'

    window.setPurchaseMode = function(mode) {
        currentPurchaseMode = mode;
        const invBtn  = document.getElementById('ptbInventory');
        const dirBtn  = document.getElementById('ptbDirect');
        const desc    = document.getElementById('ptbDesc');
        const colHead = document.getElementById('matColMaterial');

        if (mode === 'inventory') {
            invBtn.className  = 'ptb-option active-inventory';
            dirBtn.className  = 'ptb-option';
            desc.textContent  = 'Deducts from stock';
            colHead.textContent = 'Material (Stock)';
        } else {
            invBtn.className  = 'ptb-option';
            dirBtn.className  = 'ptb-option active-direct';
            desc.textContent  = 'Does not touch inventory ‚Äî direct supplier purchase';
            colHead.textContent = 'Material / Supplier';
        }

        // Rebuild all existing rows to match new mode
        const rids = [...matEntryBody.querySelectorAll('tr')].map(r => r.dataset.rid);
        matEntryBody.innerHTML = '';
        matRowCounter = 0;
        if (rids.length === 0) { window.addMaterialEntryRow(); }
        else { rids.forEach(() => window.addMaterialEntryRow()); }
    };

    function matOptions(selectedId) {
        return '<option value="">‚Äî Select Material ‚Äî</option>' +
            materials.map(m => {
                const name  = m.materialName || m.name || 'Unnamed';
                const price = +(m.price || m.unitPrice || 0);
                const stock = +(m.quantity || 0);
                const sel   = m.docId === selectedId ? 'selected' : '';
                return `<option value="${m.docId}" data-price="${price}" data-stock="${stock}" ${sel}>${name} (Stock: ${stock})</option>`;
            }).join('');
    }

    function nowInputVal() { return new Date().toISOString().slice(0,16); }

    window.addMaterialEntryRow = function(prefill = {}) {
        matRowCounter++;
        const rid  = matRowCounter;
        const ctx  = currentTaskContext;
        const tr   = document.createElement('tr');
        tr.dataset.rid = rid;
        tr.dataset.mode = currentPurchaseMode;

        // Material cell differs by mode
        const materialCell = currentPurchaseMode === 'inventory'
            ? `<select class="cell-select mat-material" data-rid="${rid}" onchange="onMatEntrySelect(${rid})">${matOptions(prefill.materialId||'')}</select>`
            : `<input class="cell-input mat-material-name" data-rid="${rid}" type="text"
                  value="${prefill.materialName||''}" placeholder="Material name / supplier"
                  style="min-width:200px">`;

        tr.innerHTML = `
            <td><span class="cell-readonly">${rid}</span></td>
            <td><span class="cell-readonly">${ctx.taskId||'‚Äî'}</span></td>
            <td><span class="cell-readonly">${ctx.taskLine||'‚Äî'}</span></td>
            <td><input class="cell-input mat-desc" data-rid="${rid}" type="text"
                value="${prefill.description||ctx.taskDescription||''}"
                placeholder="Description" style="min-width:120px"></td>
            <td>${materialCell}</td>
            <td><input class="cell-input mat-qty" data-rid="${rid}" type="number" min="0" step="0.01"
                placeholder="0" value="${prefill.qty||''}" oninput="recalcMatEntry(${rid})"
                style="min-width:70px;text-align:right"></td>
            <td><input class="cell-input mat-uprice" data-rid="${rid}" type="number" min="0" step="0.01"
                placeholder="0.00" value="${prefill.price||''}" oninput="recalcMatEntry(${rid})"
                style="min-width:80px;text-align:right"></td>
            <td><span class="amount-cell zero" id="matAmount_${rid}">‚Äî</span></td>
            <td><input class="cell-input mat-location" data-rid="${rid}" type="text"
                value="${prefill.location||ctx.location||''}" placeholder="Location" style="min-width:110px"></td>
            <td><input class="cell-input mat-assignedAt" data-rid="${rid}" type="datetime-local"
                value="${prefill.assignedAt||nowInputVal()}" style="min-width:150px;font-size:0.68rem"></td>
            <td style="text-align:center">
                <button class="remove-entry-btn" onclick="removeMatEntryRow(${rid})" title="Remove row">√ó</button>
            </td>
        `;

        // Highlight direct-purchase rows with a subtle orange tint
        if (currentPurchaseMode === 'direct') {
            tr.style.background = '#fffbf0';
        }

        matEntryBody.appendChild(tr);
        if (prefill.qty && prefill.price) recalcMatEntry(rid);

        const inputs = tr.querySelectorAll('input, select');
        inputs.forEach((inp, idx) => {
            inp.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                e.preventDefault();
                if (idx === inputs.length - 1) {
                    window.addMaterialEntryRow();
                    setTimeout(() => {
                        const rows = matEntryBody.querySelectorAll('tr');
                        const lastRow = rows[rows.length - 1];
                        const firstInput = lastRow?.querySelector('input, select');
                        firstInput?.focus();
                    }, 30);
                } else { inputs[idx+1]?.focus(); }
            });
        });
        return tr;
    };

    window.onMatEntrySelect = function(rid) {
        const row = matEntryBody.querySelector(`tr[data-rid="${rid}"]`); if (!row) return;
        const sel = row.querySelector('.mat-material');
        if (!sel) return;
        const opt = sel.options[sel.selectedIndex];
        if (parseFloat(opt?.dataset?.price||0)) row.querySelector('.mat-uprice').value = parseFloat(opt.dataset.price).toFixed(2);
        recalcMatEntry(rid);
    };

    window.recalcMatEntry = function(rid) {
        const row = matEntryBody.querySelector(`tr[data-rid="${rid}"]`); if (!row) return;
        const amt = (parseFloat(row.querySelector('.mat-qty').value)||0) * (parseFloat(row.querySelector('.mat-uprice').value)||0);
        const el  = row.querySelector(`#matAmount_${rid}`);
        el.textContent = amt > 0 ? amt.toFixed(2) : '‚Äî';
        el.classList.toggle('zero', amt <= 0);
        updateMatGrandTotal();
    };

    window.removeMatEntryRow = function(rid) {
        matEntryBody.querySelector(`tr[data-rid="${rid}"]`)?.remove();
        updateMatGrandTotal();
    };

    function updateMatGrandTotal() {
        let t = 0;
        matEntryBody.querySelectorAll('.amount-cell').forEach(el => { const v=parseFloat(el.textContent); if(!isNaN(v)) t+=v; });
        matGrandTotalEl.textContent = t.toFixed(2);
    }

    window.openMaterialAssign = function(taskId) {
        currentAssigningTaskId = taskId;
        const { found, level, parentDocId, subDocId } = findPathFor(taskId);
        currentAssigningDocId       = found?.id || taskId;
        currentAssigningTaskLevel   = level || 'main';
        currentAssigningParentDocId = parentDocId;
        currentAssigningSubDocId    = subDocId;
        currentTaskContext = {
            taskId: found?.taskId||'', taskLine: found?.taskLine||'',
            taskDescription: found?.taskDescription||'', location: found?.location||''
        };
        document.getElementById('taskNameMaterial').textContent = found?.taskDescription || 'Task';
        document.getElementById('ctxTaskId').textContent        = currentTaskContext.taskId || '‚Äî';
        document.getElementById('ctxLine').textContent          = currentTaskContext.taskLine || '‚Äî';
        document.getElementById('ctxDescription').textContent   = currentTaskContext.taskDescription || '‚Äî';
        document.getElementById('ctxLocation').textContent      = currentTaskContext.location || '‚Äî';
        matEntryBody.innerHTML = '';
        matStockWarning.style.display = 'none';
        matRowCounter = 0;
        // Reset to inventory mode on open
        currentPurchaseMode = 'inventory';
        setPurchaseMode('inventory');
        loadResources().then(() => {
            window.addMaterialEntryRow();
            materialModal.classList.add('active');
            setTimeout(() => matEntryBody.querySelector('select,input')?.focus(), 80);
        });
    };
    window.closeMaterialAllocModal = function() { materialModal.classList.remove('active'); currentAssigningTaskId = null; };

    window.assignMaterials = async function() {
        matStockWarning.style.display = 'none';
        const entries = [];

        for (const row of matEntryBody.querySelectorAll('tr')) {
            const mode = row.dataset.mode || 'inventory';
            const qty   = parseFloat(row.querySelector('.mat-qty')?.value);
            const price = parseFloat(row.querySelector('.mat-uprice')?.value);

            if (!qty  || qty   <= 0) { alert('Enter a valid quantity for all rows.');   return; }
            if (!price|| price <= 0) { alert('Enter a valid unit price for all rows.'); return; }

            const assignedAt = row.querySelector('.mat-assignedAt')?.value
                ? Timestamp.fromDate(new Date(row.querySelector('.mat-assignedAt').value))
                : Timestamp.now();
            const desc     = row.querySelector('.mat-desc')?.value.trim() || '';
            const location = row.querySelector('.mat-location')?.value.trim() || '';

            if (mode === 'inventory') {
                // ‚îÄ‚îÄ Inventory row ‚îÄ‚îÄ
                const matId = row.querySelector('.mat-material')?.value;
                if (!matId) { alert('Select a material from inventory for all inventory rows.'); return; }
                const mat = materials.find(m => m.docId === matId);
                if (!mat) continue;
                if (qty > +(mat.quantity||0)) {
                    matStockWarning.innerHTML = `‚ö†Ô∏è <b>${mat.materialName||mat.name}</b>: only ${mat.quantity} in stock, you entered ${qty}.`;
                    matStockWarning.style.display = 'block';
                    return;
                }
                entries.push({ mode: 'inventory', matId, mat, qty, price, cost: qty*price, desc, location, assignedAt });

            } else {
                // ‚îÄ‚îÄ Direct purchase row ‚îÄ‚îÄ
                const materialName = row.querySelector('.mat-material-name')?.value.trim();
                if (!materialName) { alert('Enter a material name / supplier for all direct purchase rows.'); return; }
                entries.push({ mode: 'direct', materialName, qty, price, cost: qty*price, desc, location, assignedAt });
            }
        }

        if (!entries.length) { alert('Add at least one material row.'); return; }

        try {
            for (const e of entries) {
                if (e.mode === 'inventory') {
                    // Deduct stock
                    await updateDoc(doc(db,"materials",e.matId), { quantity: (+(e.mat.quantity||0)) - e.qty });
                    await addDoc(collection(db,"materialsUsage"), {
                        taskId: currentAssigningTaskId, taskDocId: currentAssigningDocId,
                        taskLevel: currentAssigningTaskLevel, taskLine: currentTaskContext.taskLine||'',
                        taskDescription: e.desc||currentTaskContext.taskDescription||'',
                        materialId: e.matId, materialName: e.mat.materialName||e.mat.name,
                        quantity: e.qty, unitPrice: e.price, cost: e.cost,
                        location: e.location||currentTaskContext.location||'',
                        assignedAt: e.assignedAt, projectId,
                        savedAt: Timestamp.now(), reversed: false,
                        purchaseType: 'inventory'
                    });
                } else {
                    // Direct purchase ‚Äî no stock deduction
                    await addDoc(collection(db,"materialsUsage"), {
                        taskId: currentAssigningTaskId, taskDocId: currentAssigningDocId,
                        taskLevel: currentAssigningTaskLevel, taskLine: currentTaskContext.taskLine||'',
                        taskDescription: e.desc||currentTaskContext.taskDescription||'',
                        materialId: null, materialName: e.materialName,
                        quantity: e.qty, unitPrice: e.price, cost: e.cost,
                        location: e.location||currentTaskContext.location||'',
                        assignedAt: e.assignedAt, projectId,
                        savedAt: Timestamp.now(), reversed: false,
                        purchaseType: 'direct'
                    });
                }
            }
            closeMaterialAllocModal();
        } catch(err) { alert('Error saving: ' + err.message); }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LABOR MODAL ‚Äî FULL TABLE FORM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function employeeOptions(selectedId) {
        return '<option value="">‚Äî Select Employee ‚Äî</option>' +
            laborWorkers.map(e => {
                const name  = `${e.name||''} ${e.surname||''}`.trim() || 'Unnamed';
                const empId = e.employeeId || e.id || e.docId || '';
                const sel   = e.docId === selectedId ? 'selected' : '';
                return `<option value="${e.docId}" data-empid="${empId}" data-name="${name}" ${sel}>${empId} - ${name}</option>`;
            }).join('');
    }

    window.addLaborEntryRow = function(prefill = {}) {
        labRowCounter++;
        const rid = labRowCounter;
        const ctx = currentTaskContext;
        const tr  = document.createElement('tr');
        tr.dataset.rid = rid;
        const projectName = projectId ? `Project ${projectId.slice(0,6)}...` : 'Current Project';

        tr.innerHTML = `
            <td><span class="cell-readonly">${rid}</span></td>
            <td>
                <select class="cell-select lab-employee" data-rid="${rid}" onchange="onLaborEmployeeSelect(${rid})">
                    ${employeeOptions(prefill.employeeId||'')}
                </select>
            </td>
            <td>
                <span class="cell-readonly lab-name" id="lab_name_${rid}">${prefill.employeeName||''}</span>
                <input type="hidden" class="lab-name-hidden" value="${prefill.employeeName||''}">
            </td>
            <td>
                <input class="cell-input lab-project" data-rid="${rid}" type="text"
                    value="${prefill.projectName||projectName}" placeholder="Project Name" readonly>
            </td>
            <td>
                <input class="cell-input lab-location" data-rid="${rid}" type="text"
                    value="${prefill.location||ctx.location||''}" placeholder="Location">
            </td>
            <td>
                <span class="cell-readonly lab-taskid" id="lab_taskid_${rid}">${ctx.taskId||'‚Äî'}</span>
            </td>
            <td>
                <input class="cell-input lab-description" data-rid="${rid}" type="text"
                    value="${prefill.description||ctx.taskDescription||''}" placeholder="Description">
            </td>
            <td>
                <select class="cell-select lab-status" data-rid="${rid}">
                    <option value="PENDING"   ${(prefill.status||'PENDING')==='PENDING'  ?'selected':''}>PENDING</option>
                    <option value="ONGOING"   ${prefill.status==='ONGOING'  ?'selected':''}>ONGOING</option>
                    <option value="COMPLETED" ${prefill.status==='COMPLETED'?'selected':''}>COMPLETED</option>
                </select>
            </td>
            <td>
                <input class="cell-input lab-transferdate" data-rid="${rid}" type="datetime-local"
                    value="${prefill.transferDate||nowInputVal()}" style="min-width:140px">
            </td>
            <td>
                <input class="cell-input lab-mh" data-rid="${rid}" type="number" min="0" step="0.5"
                    value="${prefill.mh||''}" placeholder="MH"
                    oninput="recalcLaborEntry(${rid})"
                    style="min-width:70px;text-align:right">
            </td>
            <td>
                <span class="amount-cell lab-cost" id="labCost_${rid}">‚Äî</span>
                <input type="hidden" class="lab-cost-hidden" value="0">
            </td>
            <td style="text-align:center">
                <button class="remove-entry-btn" onclick="removeLaborEntryRow(${rid})" title="Remove row">√ó</button>
            </td>
        `;

        labEntryBody.appendChild(tr);
        recalcLaborEntry(rid);

        // Enter/Tab navigation ‚Äî skip readonly inputs
        const inputs = tr.querySelectorAll('input, select');
        inputs.forEach((inp, idx) => {
            inp.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                e.preventDefault();
                if (idx === inputs.length - 1) {
                    window.addLaborEntryRow();
                    setTimeout(() => {
                        const rows = labEntryBody.querySelectorAll('tr');
                        rows[rows.length-1]?.querySelector('select')?.focus();
                    }, 30);
                } else {
                    let next = idx + 1;
                    while (next < inputs.length && inputs[next].readOnly) next++;
                    inputs[next]?.focus();
                }
            });
        });
        return tr;
    };

    window.onLaborEmployeeSelect = function(rid) {
        const row = labEntryBody.querySelector(`tr[data-rid="${rid}"]`); if (!row) return;
        const opt  = row.querySelector('.lab-employee').options[row.querySelector('.lab-employee').selectedIndex];
        const name = opt?.dataset?.name || '';
        const nameSpan = row.querySelector('.lab-name');
        if (nameSpan) nameSpan.textContent = name;
        const nameHid = row.querySelector('.lab-name-hidden');
        if (nameHid) nameHid.value = name;
        recalcLaborEntry(rid);
    };

    window.recalcLaborEntry = function(rid) {
        const row = labEntryBody.querySelector(`tr[data-rid="${rid}"]`); if (!row) return;
        const mh   = parseFloat(row.querySelector('.lab-mh').value)||0;
        const cost = mh * LABOR_RATE;
        const el   = row.querySelector(`#labCost_${rid}`);
        const hid  = row.querySelector('.lab-cost-hidden');
        if (cost > 0) { el.textContent = cost.toFixed(2); el.classList.remove('zero'); if (hid) hid.value = cost; }
        else          { el.textContent = '‚Äî'; el.classList.add('zero'); if (hid) hid.value = 0; }
        updateLaborGrandTotal();
    };

    window.removeLaborEntryRow = function(rid) {
        labEntryBody.querySelector(`tr[data-rid="${rid}"]`)?.remove();
        updateLaborGrandTotal();
    };

    function updateLaborGrandTotal() {
        let t = 0;
        labEntryBody.querySelectorAll('.lab-cost').forEach(el => { const v=parseFloat(el.textContent); if(!isNaN(v)) t+=v; });
        labGrandTotalEl.textContent = t.toFixed(2);
    }

    window.openLaborAssign = function(taskId) {
        currentAssigningTaskId = taskId;
        const { found, level, parentDocId, subDocId } = findPathFor(taskId);
        currentAssigningDocId       = found?.id || taskId;
        currentAssigningTaskLevel   = level || 'main';
        currentAssigningParentDocId = parentDocId;
        currentAssigningSubDocId    = subDocId;
        currentTaskContext = { taskId: found?.taskId||'', taskLine: found?.taskLine||'', taskDescription: found?.taskDescription||'', location: found?.location||'', status: found?.status||'PENDING' };

        document.getElementById('taskNameLabor').textContent    = found?.taskDescription || 'Task';
        document.getElementById('labCtxTaskId').textContent     = currentTaskContext.taskId || '‚Äî';
        document.getElementById('labCtxDesc').textContent       = currentTaskContext.taskDescription || '‚Äî';
        document.getElementById('labCtxLoc').textContent        = currentTaskContext.location || '‚Äî';
        document.getElementById('labCtxProject').textContent    = projectId ? `Project ${projectId.slice(0,6)}...` : '‚Äî';

        labEntryBody.innerHTML = ''; labRowCounter = 0;
        loadResources().then(() => { window.addLaborEntryRow(); laborModal.classList.add('active'); setTimeout(() => labEntryBody.querySelector('select')?.focus(), 80); });
    };
    window.closeLaborAllocModal = function() { laborModal.classList.remove('active'); currentAssigningTaskId = null; };

    window.assignLabors = async function() {
        const entries = [];
        for (const row of labEntryBody.querySelectorAll('tr')) {
            const empId = row.querySelector('.lab-employee')?.value; if (!empId) continue;
            const mh    = parseFloat(row.querySelector('.lab-mh').value);
            if (!mh || mh <= 0) { alert('Please enter valid Man Hours (MH) for all rows.'); return; }
            const emp = laborWorkers.find(e => e.docId === empId); if (!emp) continue;
            entries.push({
                employeeId:       emp.docId,
                employeeIdNumber: emp.employeeId || emp.docId,
                employeeName:     `${emp.name||''} ${emp.surname||''}`.trim() || 'Unknown',
                projectName:      row.querySelector('.lab-project').value,
                location:         row.querySelector('.lab-location').value.trim() || currentTaskContext.location||'',
                taskDescription:  row.querySelector('.lab-description').value.trim() || currentTaskContext.taskDescription||'',
                status:           row.querySelector('.lab-status').value,
                transferDate:     row.querySelector('.lab-transferdate').value ? Timestamp.fromDate(new Date(row.querySelector('.lab-transferdate').value)) : Timestamp.now(),
                mh, rate: LABOR_RATE, cost: mh * LABOR_RATE
            });
        }
        if (!entries.length) { alert('Please add at least one employee with MH entered.'); return; }
        try {
            for (const e of entries) {
                await addDoc(collection(db,"locationHistory"), {
                    projectId, taskId: currentAssigningTaskId, taskDocId: currentAssigningDocId,
                    taskLevel: currentAssigningTaskLevel,
                    employeeId: e.employeeId, employeeIdNumber: e.employeeIdNumber,
                    employeeName: e.employeeName, projectName: e.projectName,
                    location: e.location, taskIdDisplay: currentTaskContext.taskId,
                    taskDescription: e.taskDescription, status: e.status,
                    transferDate: e.transferDate, mh: e.mh, rate: e.rate, cost: e.cost,
                    savedAt: Timestamp.now(), reversed: false
                });
            }
            closeLaborAllocModal();
        } catch(err) { console.error('Error saving labor:', err); alert('Error saving labor: ' + err.message); }
    };

    // ‚îÄ‚îÄ‚îÄ Firestore helpers ‚îÄ‚îÄ‚îÄ
    function getTaskDocRef(docId, level, parentDocId, subDocId) {
        if (!docId) return null;
        if (level==='main')   return doc(db,"projectTasks",docId);
        if (level==='sub'    && parentDocId)             return doc(db,"projectTasks",parentDocId,"subtasks",docId);
        if (level==='subsub' && parentDocId && subDocId) return doc(db,"projectTasks",parentDocId,"subtasks",subDocId,"subsubtasks",docId);
        return null;
    }
    function findTaskObj(taskId) {
        for (const t of allTasks) {
            if (t.id === taskId) return t;
            for (const sub of (t.subTasks||[])) {
                if (sub.id === taskId) return sub;
                for (const ss of (sub.subSubtasks||[])) { if (ss.id === taskId) return ss; }
            }
        }
        return null;
    }
    async function getNextTaskNumber(pId) {
        const snap = await getDocs(query(collection(db,"projectTasks"),where("projectId","==",pId)));
        let max = 0;
        snap.forEach(d => { const m=(d.data().taskId||'').match(/PRJ-(\d+)$/); if(m) max=Math.max(max,parseInt(m[1])); });
        return max + 1;
    }

    // ‚îÄ‚îÄ‚îÄ Load tasks ‚îÄ‚îÄ‚îÄ
    async function loadTasks() {
        if (unsubMain) unsubMain();
        Object.values(subUnsubs).forEach(fn => fn?.());

        unsubMain = onSnapshot(
            query(collection(db,"projectTasks"), where("projectId","==",projectId)),
            async (snap) => {
                allTasks = [];
                const promises = [];
                snap.docs.forEach(docSnap => {
                    const task = { id: docSnap.id, ...docSnap.data(), subTasks: [] };
                    allTasks.push(task);
                    promises.push(new Promise(resolve => {
                        const unsub = onSnapshot(collection(db,"projectTasks",docSnap.id,"subtasks"), async (subSnap) => {
                            task.subTasks = [];
                            const sp = [];
                            subSnap.docs.forEach(subDoc => {
                                const sub = { id: subDoc.id, ...subDoc.data(), subSubtasks: [] };
                                task.subTasks.push(sub);
                                sub._matCost = sub.matCost||0; sub._labCost = sub.labCost||0; sub._hours = sub.totalHours||0;
                                sp.push(new Promise(async res2 => {
                                    const ssSnap = await getDocs(collection(db,"projectTasks",docSnap.id,"subtasks",subDoc.id,"subsubtasks"));
                                    sub.subSubtasks = [];
                                    ssSnap.docs.forEach(ssDoc => {
                                        const ss = { id: ssDoc.id, ...ssDoc.data() };
                                        sub.subSubtasks.push(ss);
                                        ss._matCost = ss.matCost||0; ss._labCost = ss.labCost||0; ss._hours = ss.totalHours||0;
                                    });
                                    res2();
                                }));
                            });
                            await Promise.all(sp);
                            resolve();
                        });
                        subUnsubs[docSnap.id] = unsub;
                    }));
                });
                await Promise.all(promises);
                allTasks.forEach(t => {
                    t._matCost = t.matCost||0; t._labCost = t.labCost||0; t._hours = t.totalHours||0;
                    if (t.subTasks.length) {
                        let amc=t._matCost, alc=t._labCost;
                        t.subTasks.forEach(sub => { amc+=sub._matCost||0; alc+=sub._labCost||0; sub.subSubtasks?.forEach(ss=>{amc+=ss._matCost||0;alc+=ss._labCost||0;}); });
                        t._aggMatCost=amc; t._aggLabCost=alc;
                    }
                });
                renderTasks(filterTasks());
                renderGantt();
                listenForMaterialChanges();
                listenForLaborChanges();
                listenForAssignedNames();
                // Refresh the filter picker state whenever tasks change
                applyTaskFilterCount();
            }
        );
    }

    function filterTasks() {
        const status=statusFilter.value, month=monthFilter.value, year=yearFilter.value, search=searchInput.value.toLowerCase();
        return allTasks
            .filter(task => {
                // Main task picker filter ‚Äî persisted
                if (selectedTaskIds !== null && !selectedTaskIds.has(task.id)) return false;
                if (hideCompleted && task.status==='COMPLETED') return false;
                if (status && task.status!==status) return false;
                if (month||year) {
                    if (!task.startDate) return false;
                    const d=task.startDate.toDate?task.startDate.toDate():new Date(task.startDate);
                    if (month && d.getMonth()+1!==parseInt(month)) return false;
                    if (year  && d.getFullYear()!==parseInt(year))  return false;
                }
                if (search) {
                    const s=[task.taskId,task.taskDescription,task.assignedTo,task.status,task.location,task.taskLine?.toString()].filter(Boolean).join(' ').toLowerCase();
                    return s.includes(search);
                }
                return true;
            })
            .map(task => {
                // Deep-clone task with filtered subtasks so we don't mutate allTasks
                const filteredSubs = (task.subTasks||[])
                    .filter(sub => !(hideCompleted && sub.status==='COMPLETED'))
                    .map(sub => ({
                        ...sub,
                        subSubtasks: (sub.subSubtasks||[])
                            .filter(ss => !(hideCompleted && ss.status==='COMPLETED'))
                    }));
                return { ...task, subTasks: filteredSubs };
            });
    }

    // ‚îÄ‚îÄ‚îÄ Assigned names: listen to locationHistory for this project ‚îÄ‚îÄ‚îÄ
    // Maps taskDocId ‚Üí array of first names of assigned workers
    let taskAssignedNames = {}; // taskDocId ‚Üí "John, Jane"
    let unsubAssignedNames = null;

    function listenForAssignedNames() {
        if (unsubAssignedNames) unsubAssignedNames();
        unsubAssignedNames = onSnapshot(
            query(collection(db, "locationHistory"), where("projectId", "==", projectId)),
            (snapshot) => {
                const nameMap = {}; // taskId ‚Üí Set of first names
                snapshot.docs.forEach(d => {
                    const x = d.data(); if (x.reversed) return;
                    const tid = x.taskId || x.taskDocId; if (!tid) return;
                    if (!nameMap[tid]) nameMap[tid] = new Set();
                    // Use first name only
                    const fullName = x.employeeName || '';
                    const firstName = fullName.trim().split(' ')[0];
                    if (firstName) nameMap[tid].add(firstName);
                });
                // Convert sets to comma-separated strings
                taskAssignedNames = {};
                Object.keys(nameMap).forEach(tid => {
                    taskAssignedNames[tid] = [...nameMap[tid]].join(', ');
                });
                // Update ASSIGNED cells in DOM without full re-render
                updateAssignedCellsInDom();
            }
        );
    }

    function updateAssignedCellsInDom() {
        // Update each row's assigned cell (col index 3) based on data-task-id
        document.querySelectorAll('#taskList tr[data-task-id]').forEach(row => {
            const tid = row.dataset.taskId;
            if (!tid) return;
            // Find assigned cell ‚Äî it's the editable cell with data-field="assignedTo"
            const cell = row.querySelector('[data-field="assignedTo"]');
            if (cell && !cell.querySelector('input') && !cell.querySelector('select')) {
                // Only update if not currently being edited
                const names = taskAssignedNames[tid] || '';
                if (cell.textContent !== names) cell.textContent = names;
            }
        });
    }

    addEmptyRowBtn.addEventListener('click', () => {
        const id='empty-'+Date.now()+'-'+Math.random().toString(36).substr(2,9);
        emptyRows.push({id,type:'empty',description:'',location:'',createdAt:new Date().toISOString()});
        saveEmptyRows(); renderTasks(filterTasks());
    });
    window.insertRow = (pos,tid) => {
        const id='empty-'+Date.now()+'-'+Math.random().toString(36).substr(2,9);
        emptyRows.push({id,type:'empty',position:pos,targetId:tid,description:'',location:'',createdAt:new Date().toISOString()});
        saveEmptyRows(); renderTasks(filterTasks());
    };
    window.updateEmptyRow = (id,field,val) => { const r=emptyRows.find(r=>r.id===id); if(r){r[field]=val;saveEmptyRows();} };
    window.removeEmptyRow = (id) => { emptyRows=emptyRows.filter(r=>r.id!==id); saveEmptyRows(); renderTasks(filterTasks()); };
    window.toggleMenu = (menuId) => {
        if (openMenuId===menuId) { openMenuId=null; document.querySelectorAll('.menu-dropdown.show').forEach(m=>m.classList.remove('show')); }
        else { openMenuId=menuId; document.querySelectorAll('.menu-dropdown.show').forEach(m=>m.classList.remove('show')); document.getElementById(`menu-${menuId}`)?.classList.add('show'); }
    };

    // ‚îÄ‚îÄ‚îÄ Render tasks ‚îÄ‚îÄ‚îÄ
    function renderTasks(tasks) {
        taskListEl.innerHTML = '';
        tasks.sort((a,b) => (a.taskLine||0)-(b.taskLine||0));

        const byTarget = {};
        emptyRows.forEach(e => {
            if (e.targetId) {
                if (!byTarget[e.targetId]) byTarget[e.targetId]={before:[],after:[]};
                byTarget[e.targetId][e.position].push(e);
            }
        });
        emptyRows.filter(e=>!e.targetId).forEach(e=>renderEmptyRow(e));

        tasks.forEach(task => {
            byTarget[task.id]?.before.forEach(e=>renderEmptyRow(e));
            const matCost = task._aggMatCost ?? task._matCost ?? 0;
            const labCost = task._aggLabCost ?? task._labCost ?? 0;
            const total   = matCost + labCost;
            const hours   = task._hours || 0;

            const tr = document.createElement('tr');
            tr.className = 'main-task-row';
            tr.dataset.taskId = task.id;
            // Assigned: from labor history (first names) OR manual assignedTo field
            const mainAssigned = taskAssignedNames[task.id] || task.assignedTo || '';
            tr.innerHTML = `
                <td>${task.taskId||''}</td>
                <td class="editable" data-type="main" data-field="taskLine" data-id="${task.id}">${task.taskLine||''}</td>
                <td class="editable" data-type="main" data-field="taskDescription" data-id="${task.id}">${task.taskDescription||''}</td>
                <td class="editable" data-type="main" data-field="assignedTo" data-id="${task.id}">${mainAssigned}</td>
                <td class="editable" data-type="main" data-field="status" data-id="${task.id}"><span class="status-badge status-${task.status||'PENDING'}">${task.status||'PENDING'}</span></td>
                <td class="editable" data-type="main" data-field="startDate" data-id="${task.id}">${formatDate(task.startDate)}</td>
                <td class="editable" data-type="main" data-field="endDate" data-id="${task.id}">${formatDate(task.endDate)}</td>
                <td>${hours||''}</td>
                <td>${makeCostCell(matCost, task.id, 'material')}</td>
                <td>${makeCostCell(labCost, task.id, 'labor')}</td>
                <td><span class="total-cost">${total>0?fmt(total):''}</span></td>
                <td class="editable" data-type="main" data-field="location" data-id="${task.id}">${task.location||''}</td>
                <td>
                    <div class="menu-container">
                        <button class="menu-trigger" onclick="toggleMenu('${task.id}')">‚ãÆ</button>
                        <div class="menu-dropdown" id="menu-${task.id}">
                            <div class="menu-item" onclick="addSubtask('${task.id}')"><i class="fas fa-plus"></i> Add Subtask</div>
                            <div class="menu-item" onclick="insertRow('before','${task.id}')"><i class="fas fa-arrow-up"></i> Insert Above</div>
                            <div class="menu-item" onclick="insertRow('after','${task.id}')"><i class="fas fa-arrow-down"></i> Insert Below</div>
                            <div class="menu-item" onclick="deleteTask('main','${task.id}')"><i class="fas fa-trash"></i> Delete</div>
                        </div>
                    </div>
                </td>`;
            taskListEl.appendChild(tr);

            task.subTasks.forEach(sub => {
                const sMat=sub._matCost||0, sLab=sub._labCost||0, sTotal=sMat+sLab;
                const subTr = document.createElement('tr');
                subTr.className = 'subtask-row';
                subTr.dataset.taskId = sub.id;
                const subAssigned = taskAssignedNames[sub.id] || sub.assignedTo || '';
                subTr.innerHTML = `
                    <td>${sub.taskId||''}</td><td></td>
                    <td class="editable subtask-desc" data-type="sub" data-mainid="${task.id}" data-field="taskDescription" data-id="${sub.id}"><span class="task-prefix">‚Ü™</span> ${sub.taskDescription||''}</td>
                    <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="assignedTo" data-id="${sub.id}">${subAssigned}</td>
                    <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="status" data-id="${sub.id}"><span class="status-badge status-${sub.status||'PENDING'}">${sub.status||'PENDING'}</span></td>
                    <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="startDate" data-id="${sub.id}">${formatDate(sub.startDate)}</td>
                    <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="endDate" data-id="${sub.id}">${formatDate(sub.endDate)}</td>
                    <td>${sub._hours||''}</td>
                    <td>${makeCostCell(sMat, sub.id, 'material')}</td>
                    <td>${makeCostCell(sLab, sub.id, 'labor')}</td>
                    <td><span class="total-cost">${sTotal>0?fmt(sTotal):''}</span></td>
                    <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="location" data-id="${sub.id}">${sub.location||''}</td>
                    <td>
                        <div class="menu-container">
                            <button class="menu-trigger" onclick="toggleMenu('${sub.id}')">‚ãÆ</button>
                            <div class="menu-dropdown" id="menu-${sub.id}">
                                <div class="menu-item" onclick="addSubSubtask('${task.id}','${sub.id}')"><i class="fas fa-plus"></i> Add Sub-subtask</div>
                                <div class="menu-item" onclick="insertRow('before','${task.id}')"><i class="fas fa-arrow-up"></i> Insert Above</div>
                                <div class="menu-item" onclick="insertRow('after','${task.id}')"><i class="fas fa-arrow-down"></i> Insert Below</div>
                                <div class="menu-item" onclick="deleteTask('sub','${task.id}','${sub.id}')"><i class="fas fa-trash"></i> Delete</div>
                            </div>
                        </div>
                    </td>`;
                taskListEl.appendChild(subTr);

                sub.subSubtasks?.forEach(ss => {
                    const ssMat=ss._matCost||0, ssLab=ss._labCost||0, ssTotal=ssMat+ssLab;
                    const ssTr = document.createElement('tr');
                    ssTr.className = 'subsubtask-row';
                    ssTr.dataset.taskId = ss.id;
                    const ssAssigned = taskAssignedNames[ss.id] || ss.assignedTo || '';
                    ssTr.innerHTML = `
                        <td>${ss.taskId||''}</td><td></td>
                        <td class="editable" style="padding-left:35px" data-type="subsub" data-mainid="${task.id}" data-subid="${sub.id}" data-field="taskDescription" data-id="${ss.id}"><span class="task-prefix">‚Ü™‚Ü™</span> ${ss.taskDescription||''}</td>
                        <td class="editable" data-type="subsub" data-mainid="${task.id}" data-subid="${sub.id}" data-field="assignedTo" data-id="${ss.id}">${ssAssigned}</td>
                        <td class="editable" data-type="subsub" data-mainid="${task.id}" data-subid="${sub.id}" data-field="status" data-id="${ss.id}"><span class="status-badge status-${ss.status||'PENDING'}">${ss.status||'PENDING'}</span></td>
                        <td class="editable" data-type="subsub" data-mainid="${task.id}" data-subid="${sub.id}" data-field="startDate" data-id="${ss.id}">${formatDate(ss.startDate)}</td>
                        <td class="editable" data-type="subsub" data-mainid="${task.id}" data-subid="${sub.id}" data-field="endDate" data-id="${ss.id}">${formatDate(ss.endDate)}</td>
                        <td>${ss._hours||''}</td>
                        <td>${makeCostCell(ssMat, ss.id, 'material')}</td>
                        <td>${makeCostCell(ssLab, ss.id, 'labor')}</td>
                        <td><span class="total-cost">${ssTotal>0?fmt(ssTotal):''}</span></td>
                        <td class="editable" data-type="subsub" data-mainid="${task.id}" data-subid="${sub.id}" data-field="location" data-id="${ss.id}">${ss.location||''}</td>
                        <td>
                            <div class="menu-container">
                                <button class="menu-trigger" onclick="toggleMenu('${ss.id}')">‚ãÆ</button>
                                <div class="menu-dropdown" id="menu-${ss.id}">
                                    <div class="menu-item" onclick="insertRow('before','${task.id}')"><i class="fas fa-arrow-up"></i> Insert Above</div>
                                    <div class="menu-item" onclick="insertRow('after','${task.id}')"><i class="fas fa-arrow-down"></i> Insert Below</div>
                                    <div class="menu-item" onclick="deleteTask('subsub','${task.id}','${sub.id}','${ss.id}')"><i class="fas fa-trash"></i> Delete</div>
                                </div>
                            </div>
                        </td>`;
                    taskListEl.appendChild(ssTr);
                });
            });

            byTarget[task.id]?.after.forEach(e=>renderEmptyRow(e));
        });

        emptyStateEl.style.display = tasks.length===0 && emptyRows.length===0 ? 'block' : 'none';

        document.querySelectorAll('.editable').forEach(cell => {
            cell.onclick = (e) => {
                e.stopPropagation();
                const {type,field} = cell.dataset;
                const val = cell.textContent.trim().replace(/‚Ü™/g,'').trim();
                if (field==='status') {
                    const sel=document.createElement('select');
                    ['COMPLETED','ONGOING','PENDING'].forEach(s=>{const o=document.createElement('option');o.value=s;o.text=s;if(val===s)o.selected=true;sel.appendChild(o);});
                    cell.innerHTML=''; cell.appendChild(sel); sel.focus();
                    sel.onblur = () => saveEdit(cell,type,field,sel.value);
                } else if (field==='startDate'||field==='endDate') {
                    const inp=document.createElement('input'); inp.type='date';
                    if(val) inp.value=formatDateForInput(val);
                    cell.innerHTML=''; cell.appendChild(inp); inp.focus();
                    inp.onblur = () => saveEdit(cell,type,field,inp.value?new Date(inp.value):null);
                } else {
                    const inp=document.createElement('input');
                    inp.type=field==='taskLine'?'number':'text'; inp.value=val;
                    cell.innerHTML=''; cell.appendChild(inp); inp.focus();
                    inp.onblur = () => saveEdit(cell,type,field,inp.value);
                }
            };
        });
    }

    function renderEmptyRow(empty) {
        const tr=document.createElement('tr');
        tr.className='empty-row'; tr.dataset.emptyId=empty.id;
        tr.innerHTML=`
            <td></td><td></td>
            <td><span class="empty-text" contenteditable="true" onblur="updateEmptyRow('${empty.id}','description',this.textContent)">${empty.description||''}</span></td>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
            <td><span class="empty-text" contenteditable="true" onblur="updateEmptyRow('${empty.id}','location',this.textContent)">${empty.location||''}</span></td>
            <td>
                <div class="menu-container">
                    <button class="menu-trigger" onclick="toggleMenu('${empty.id}')">‚ãÆ</button>
                    <div class="menu-dropdown" id="menu-${empty.id}">
                        <div class="menu-item" onclick="removeEmptyRow('${empty.id}')"><i class="fas fa-trash"></i> Delete Row</div>
                    </div>
                </div>
            </td>`;
        taskListEl.appendChild(tr);
    }

    async function saveEdit(cell, type, field, value) {
        const mainId = cell.dataset.mainid || cell.dataset.id;
        try {
            if (type==='main')        await updateDoc(doc(db,"projectTasks",mainId),{[field]:value,updatedAt:new Date()});
            else if (type==='sub')    await updateDoc(doc(db,"projectTasks",mainId,"subtasks",cell.dataset.id),{[field]:value,updatedAt:new Date()});
            else if (type==='subsub') await updateDoc(doc(db,"projectTasks",mainId,"subtasks",cell.dataset.subid,"subsubtasks",cell.dataset.id),{[field]:value,updatedAt:new Date()});
        } catch(e) { alert("Error saving: "+e.message); }
    }

    window.deleteTask = async (type,mainId,subId,subSubId) => {
        if (!confirm("Delete task?")) return;
        try {
            if (type==='main')        await deleteDoc(doc(db,"projectTasks",mainId));
            else if (type==='sub')    await deleteDoc(doc(db,"projectTasks",mainId,"subtasks",subId));
            else                      await deleteDoc(doc(db,"projectTasks",mainId,"subtasks",subId,"subsubtasks",subSubId));
        } catch(e) { alert("Delete error: "+e.message); }
    };

    function formatDateForInput(date) {
        if (!date) return '';
        const d = date.toDate ? date.toDate() : new Date(date);
        return d.toISOString().split('T')[0];
    }

    // ‚îÄ‚îÄ‚îÄ Gantt ‚îÄ‚îÄ‚îÄ
    function renderGantt() {
        if (!ganttVisible) return; // skip when hidden
        const tasks = filterTasks();
        if (!tasks.length) return;
        const today = new Date(); today.setHours(0,0,0,0);
        let minYear = today.getFullYear();
        tasks.forEach(t => { if(t.startDate){const y=new Date(t.startDate.toDate?t.startDate.toDate():t.startDate).getFullYear();if(y<minYear)minYear=y;} });
        const md=[31,28+(minYear%4===0?1:0),31,30,31,30,31,31,30,31,30,31];
        const mn=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        let h1='<tr><th rowspan="3" style="min-width:120px">TASK</th>', r2='<tr>', r3='<tr>';
        for(let m=0;m<12;m++){
            if(showCurrentMonthOnly&&m!==today.getMonth()) continue;
            h1+=`<th colspan="${md[m]}">${mn[m]}</th>`;
            for(let d=1;d<=md[m];d++){const dt=new Date(minYear,m,d),it=dt.toDateString()===today.toDateString();r2+=`<th class="${it?'today-highlight':''}">${d}</th>`;r3+=`<th class="${it?'today-highlight':''}">${['S','M','T','W','R','F','S'][dt.getDay()]}</th>`;}
        }
        ganttHeadEl.innerHTML=h1+'</tr>'+r2+'</tr>'+r3+'</tr>';
        let body='';
        tasks.forEach(t=>{body+=ganttRow(t,'main',minYear,today);t.subTasks.forEach(s=>{body+=ganttRow(s,'sub',minYear,today);s.subSubtasks?.forEach(ss=>{body+=ganttRow(ss,'subsub',minYear,today);});});});
        ganttBodyEl.innerHTML=body;
    }

    function ganttRow(task, level, minYear, today) {
        const desc = level==='main'
            ? `<b>${task.taskDescription||''}</b>`
            : level==='sub'
                ? `<span style="margin-left:14px">‚Ü™ ${task.taskDescription||''}</span>`
                : `<span style="margin-left:28px">‚Ü™‚Ü™ ${task.taskDescription||''}</span>`;

        const status = (task.status||'PENDING').toUpperCase();

        let start = null, end = null;
        if (task.startDate) {
            start = task.startDate.toDate ? task.startDate.toDate() : new Date(task.startDate);
            start.setHours(0,0,0,0);
            if (task.endDate) {
                end = task.endDate.toDate ? task.endDate.toDate() : new Date(task.endDate);
                end.setHours(23,59,59,999);
            } else if (status !== 'COMPLETED') {
                end = new Date(today); end.setHours(23,59,59,999);
            }
        }

        // Pick solid color classes based on level + status
        let hitClass = '';
        if (status === 'COMPLETED') {
            hitClass = 'gantt-td-done';
        } else if (status === 'ONGOING') {
            hitClass = level==='main' ? 'gantt-td-main' : level==='sub' ? 'gantt-td-sub' : 'gantt-td-subsub';
        } else {
            hitClass = level==='main' ? 'gantt-td-pending-main' : level==='sub' ? 'gantt-td-pending-sub' : 'gantt-td-pending-subsub';
        }

        const md = [31,28+(minYear%4===0?1:0),31,30,31,30,31,31,30,31,30,31];
        let row = `<tr><td style="text-align:left;padding:3px 6px;white-space:nowrap;min-width:120px">${desc}</td>`;
        for (let m = 0; m < 12; m++) {
            if (showCurrentMonthOnly && m !== today.getMonth()) continue;
            for (let d = 1; d <= md[m]; d++) {
                const dt = new Date(minYear, m, d);
                const isToday = dt.toDateString() === today.toDateString();
                const inRange = start && dt >= start && (!end || dt <= end);
                const cls = isToday
                    ? (inRange ? hitClass + ' today-highlight' : 'today-highlight')
                    : (inRange ? hitClass : '');
                row += `<td class="${cls}" title="${dt.toDateString()}"></td>`;
            }
        }
        return row + '</tr>';
    }

    // ‚îÄ‚îÄ‚îÄ Task CRUD ‚îÄ‚îÄ‚îÄ
    addTaskBtn.onclick = async () => {
        const desc=prompt("Task description:"); if(!desc) return;
        const num=await getNextTaskNumber(projectId);
        await addDoc(collection(db,"projectTasks"),{projectId,taskId:`PRJ-${num}`,taskDescription:desc,status:"PENDING",matCost:0,labCost:0,totalHours:0,createdAt:new Date(),updatedAt:new Date()});
    };

    window.addSubtask = async (mainId) => {
        const main=await getDoc(doc(db,"projectTasks",mainId)); if(!main.exists()) return;
        const desc=prompt("Subtask description:"); if(!desc) return;
        // Sequential: PRJ-1-1, PRJ-1-2, etc.
        const existSnap = await getDocs(collection(db,"projectTasks",mainId,"subtasks"));
        const nextNum   = existSnap.size + 1;
        const parentId  = main.data().taskId || 'PRJ';
        await addDoc(collection(db,"projectTasks",mainId,"subtasks"),{taskId:`${parentId}-${nextNum}`,taskDescription:desc,status:"PENDING",matCost:0,labCost:0,totalHours:0,createdAt:new Date(),updatedAt:new Date()});
    };

    window.addSubSubtask = async (mainId,subId) => {
        const sub=await getDoc(doc(db,"projectTasks",mainId,"subtasks",subId)); if(!sub.exists()) return;
        const desc=prompt("Sub-subtask description:"); if(!desc) return;
        // Sequential: PRJ-1-1-1, PRJ-1-1-2, etc.
        const existSnap = await getDocs(collection(db,"projectTasks",mainId,"subtasks",subId,"subsubtasks"));
        const nextNum   = existSnap.size + 1;
        const parentId  = sub.data().taskId || 'PRJ-1';
        await addDoc(collection(db,"projectTasks",mainId,"subtasks",subId,"subsubtasks"),{taskId:`${parentId}-${nextNum}`,taskDescription:desc,status:"PENDING",matCost:0,labCost:0,totalHours:0,createdAt:new Date(),updatedAt:new Date()});
    };

    currentMonthBtn.onclick = () => {
        showCurrentMonthOnly=!showCurrentMonthOnly;
        currentMonthBtn.textContent=showCurrentMonthOnly?"All Months":"Current Month";
        renderGantt();
    };

    statusFilter.onchange=monthFilter.onchange=yearFilter.onchange=searchInput.oninput=()=>{ renderTasks(filterTasks()); renderGantt(); };

    loadResources();
    loadTasks();
    setInterval(()=>renderGantt(), 60000);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MAIN TASK FILTER ‚Äî persisted per project in localStorage
    // Multi-select checkbox picker: tick tasks you want to see
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const TASK_FILTER_KEY = `taskFilter_${projectId}`;
    // null = show all; Set of task docIds = show only those
    let selectedTaskIds = null; // null means "show all"

    function loadTaskFilterFromStorage() {
        const raw = localStorage.getItem(TASK_FILTER_KEY);
        if (raw === null || raw === 'ALL') { selectedTaskIds = null; return; }
        try { selectedTaskIds = new Set(JSON.parse(raw)); }
        catch(e) { selectedTaskIds = null; }
    }
    function saveTaskFilterToStorage() {
        if (selectedTaskIds === null) { localStorage.setItem(TASK_FILTER_KEY, 'ALL'); }
        else { localStorage.setItem(TASK_FILTER_KEY, JSON.stringify([...selectedTaskIds])); }
    }
    loadTaskFilterFromStorage();

    function applyTaskFilterCount() {
        const btn   = document.getElementById('taskFilterBtn');
        const badge = document.getElementById('taskFilterCount');
        if (selectedTaskIds !== null && selectedTaskIds.size > 0) {
            badge.textContent = selectedTaskIds.size;
            badge.style.display = 'inline';
            btn.classList.add('btn-active');
        } else {
            badge.style.display = 'none';
            btn.classList.remove('btn-active');
        }
    }
    applyTaskFilterCount();

    const taskFilterDropdown = document.getElementById('taskFilterDropdown');
    const taskFilterPanel    = document.getElementById('taskFilterPanel');
    const taskFilterBtn      = document.getElementById('taskFilterBtn');
    const tfpList            = document.getElementById('tfpList');
    const tfpSearch          = document.getElementById('tfpSearch');

    function positionTaskFilterPanel() {
        const rect = taskFilterBtn.getBoundingClientRect();
        taskFilterPanel.style.top  = (rect.bottom + 6) + 'px';
        taskFilterPanel.style.left = Math.max(8, rect.left - 20) + 'px';
    }

    function buildTfpList(filter = '') {
        tfpList.innerHTML = '';
        const tasks = allTasks.slice().sort((a,b)=>(a.taskLine||0)-(b.taskLine||0));
        tasks.forEach(t => {
            const desc = t.taskDescription || t.taskId || 'Unnamed';
            if (filter && !desc.toLowerCase().includes(filter.toLowerCase())) return;
            const checked = selectedTaskIds === null || selectedTaskIds.has(t.id);
            const item = document.createElement('div');
            item.className = 'tfp-item';
            item.innerHTML = `
                <input type="checkbox" id="tfp_${t.id}" data-id="${t.id}" ${checked ? 'checked' : ''}>
                <label class="tfp-item-label" for="tfp_${t.id}">${desc}</label>
                <span class="tfp-item-id">${t.taskId||''}</span>`;
            tfpList.appendChild(item);
        });
    }

    taskFilterBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        positionTaskFilterPanel();
        buildTfpList();
        taskFilterDropdown.classList.add('open');
    });

    document.getElementById('taskFilterBackdrop').addEventListener('click', () => {
        taskFilterDropdown.classList.remove('open');
    });

    tfpSearch.addEventListener('input', () => buildTfpList(tfpSearch.value));

    document.getElementById('tfpSelectAll').addEventListener('click', () => {
        tfpList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    });
    document.getElementById('tfpClearAll').addEventListener('click', () => {
        tfpList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    });
    document.getElementById('tfpClearFilter').addEventListener('click', () => {
        selectedTaskIds = null;
        saveTaskFilterToStorage();
        applyTaskFilterCount();
        renderTasks(filterTasks());
        renderGantt();
        taskFilterDropdown.classList.remove('open');
        tfpSearch.value = '';
    });
    document.getElementById('tfpApply').addEventListener('click', () => {
        const checked = [...tfpList.querySelectorAll('input[type="checkbox"]:checked')].map(cb => cb.dataset.id);
        // If all tasks checked (or none unchecked), treat as "show all"
        if (checked.length === allTasks.length) {
            selectedTaskIds = null;
        } else if (checked.length === 0) {
            selectedTaskIds = new Set(); // show nothing
        } else {
            selectedTaskIds = new Set(checked);
        }
        saveTaskFilterToStorage();
        applyTaskFilterCount();
        renderTasks(filterTasks());
        renderGantt();
        taskFilterDropdown.classList.remove('open');
        tfpSearch.value = '';
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NOTES PANEL ‚Äî floating, saved to Firebase + localStorage cache
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const NOTES_KEY      = `notes_${projectId}`;
    const notesFab       = document.getElementById('notesFab');
    const notesPanel     = document.getElementById('notesPanel');
    const notesDot       = document.getElementById('notesDot');
    const notesTextarea  = document.getElementById('notesTextarea');
    const notesSavedTxt  = document.getElementById('notesSavedTxt');

    // Load from localStorage immediately for instant display
    notesTextarea.value = localStorage.getItem(NOTES_KEY) || '';
    updateNotesDot();

    // Also load from Firebase (source of truth)
    (async () => {
        try {
            const notesSnap = await getDocs(query(collection(db, "projectNotes"), where("projectId","==",projectId)));
            if (!notesSnap.empty) {
                const data = notesSnap.docs[0].data();
                const fbText = data.notes || '';
                // Firebase wins if different
                if (fbText !== notesTextarea.value) {
                    notesTextarea.value = fbText;
                    localStorage.setItem(NOTES_KEY, fbText);
                    updateNotesDot();
                }
            }
        } catch(e) { console.warn('Notes load:', e); }
    })();

    let notesOpen      = false;
    let notesSaveTimer = null;
    let notesDocId     = null; // cached Firestore doc id for upsert

    // Pre-fetch doc ID for upsert
    (async () => {
        try {
            const snap = await getDocs(query(collection(db,"projectNotes"), where("projectId","==",projectId)));
            if (!snap.empty) notesDocId = snap.docs[0].id;
        } catch(e) {}
    })();

    notesFab.addEventListener('click', () => {
        notesOpen = !notesOpen;
        notesPanel.classList.toggle('open', notesOpen);
        notesFab.classList.toggle('panel-open', notesOpen);
        if (notesOpen) setTimeout(() => notesTextarea.focus(), 280);
    });
    document.getElementById('notesCloseBtn').addEventListener('click', () => {
        notesOpen = false;
        notesPanel.classList.remove('open');
        notesFab.classList.remove('panel-open');
    });

    notesTextarea.addEventListener('input', () => {
        updateNotesDot();
        // Save to localStorage immediately
        localStorage.setItem(NOTES_KEY, notesTextarea.value);
        // Debounced Firebase save
        clearTimeout(notesSaveTimer);
        notesSavedTxt.innerHTML = '<i class="fas fa-spinner fa-spin" style="color:#97adc9"></i> Saving‚Ä¶';
        notesSaveTimer = setTimeout(() => saveNotesToFirebase(), 800);
    });

    async function saveNotesToFirebase() {
        const text = notesTextarea.value;
        try {
            if (notesDocId) {
                await updateDoc(doc(db, "projectNotes", notesDocId), { notes: text, updatedAt: Timestamp.now() });
            } else {
                const ref = await addDoc(collection(db, "projectNotes"), {
                    projectId, notes: text, createdAt: Timestamp.now(), updatedAt: Timestamp.now()
                });
                notesDocId = ref.id;
            }
            localStorage.setItem(NOTES_KEY, text);
            notesSavedTxt.innerHTML = '<i class="fas fa-check-circle" style="color:#059669"></i> Saved';
        } catch(e) {
            console.error('Notes save:', e);
            notesSavedTxt.innerHTML = '<i class="fas fa-exclamation-circle" style="color:#cc3333"></i> Save failed';
        }
    }

    function updateNotesDot() {
        notesDot.classList.toggle('has-content', notesTextarea.value.length > 0);
    }

    window.clearNotes = async function() {
        if (!notesTextarea.value || confirm('Clear all notes?')) {
            notesTextarea.value = '';
            localStorage.setItem(NOTES_KEY, '');
            updateNotesDot();
            notesSavedTxt.innerHTML = '<i class="fas fa-spinner fa-spin" style="color:#97adc9"></i> Clearing‚Ä¶';
            await saveNotesToFirebase();
        }
    };
});
</script>
</body>
</html>
