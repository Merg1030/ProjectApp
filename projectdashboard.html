<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Dashboard | IMS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #0a1c2f;
            line-height: 1.6;
        }

        /* Panel Layout */
        .panel {
            height: 100vh; width: 100vw;
            display: flex; flex-direction: column;
            overflow: hidden; background: white;
        }

        .panel-heading {
            background: #0a1c2f; color: white;
            padding: 12px 20px; font-size: 1.1rem; font-weight: 600;
            display: flex; align-items: center; gap: 12px;
            flex-shrink: 0; min-height: 48px;
        }

        .back-link {
            color: white; text-decoration: none;
            padding: 0.4rem 0.8rem;
            border: 1px solid rgba(255,255,255,0.3); border-radius: 30px;
            font-size: 0.8rem; font-weight: 600;
            display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s;
        }
        .back-link:hover { background: rgba(255,255,255,0.1); border-color: white; }

        /* Summary Strip */
        .summary-strip {
            display: flex; gap: 10px; padding: 8px 20px;
            background: #f2f6fc; border-bottom: 1px solid #b3c7e0;
            flex-shrink: 0; flex-wrap: wrap; align-items: center;
        }
        .stat-pill {
            background: white; border: 1px solid #b3c7e0; border-radius: 30px;
            padding: 4px 14px; font-size: 0.72rem; font-weight: 600; color: #0a1c2f;
            white-space: nowrap;
        }
        .stat-pill span { color: #059669; font-weight: 700; }
        .stat-pill.projects span { color: #2b6cb0; }
        .stat-pill.active span { color: #059669; }
        .stat-pill.completed span { color: #c05621; }

        /* Filter Bar */
        .filter-bar {
            display: flex; flex-wrap: wrap; align-items: center;
            justify-content: space-between; gap: 10px;
            background: #f2f6fc; border-bottom: 1px solid #b3c7e0;
            padding: 10px 20px; flex-shrink: 0;
        }
        .filter-group { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

        .filter-label {
            font-weight: 600; color: #1f3d62; font-size: 0.72rem;
        }

        .filter-select {
            padding: 0.38rem 0.8rem; font-size: 0.72rem; border-radius: 30px;
            border: 1px solid #b3c7e0; background: white; color: #0a1c2f; font-weight: 500;
        }
        .filter-select:focus {
            outline: none; border-color: #2b4a73;
            box-shadow: 0 0 0 2px rgba(43,74,115,0.1);
        }

        /* Buttons */
        .btn {
            padding: 0.38rem 1.2rem;
            font-size: 0.72rem;
            border-radius: 30px;
            border: 1px solid #b3c7e0;
            background: white;
            color: #0a1c2f;
            cursor: pointer;
            font-weight: 600;
            transition: 0.15s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }
        .btn:hover {
            background: #e6efff;
            border-color: #2b4a73;
        }
        .btn-primary {
            background: #0a1c2f;
            border-color: #0a1c2f;
            color: white;
        }
        .btn-primary:hover {
            background: #1f3d62;
            border-color: #1f3d62;
        }
        .btn-success {
            background: #059669;
            border-color: #059669;
            color: white;
        }
        .btn-success:hover {
            background: #047857;
            border-color: #047857;
        }
        .btn-icon {
            padding: 0.38rem;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            justify-content: center;
        }

        /* Form Container */
        .form-container {
            background: #f2f6fc;
            border-bottom: 1px solid #b3c7e0;
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            flex-shrink: 0;
        }
        .form-container.visible {
            max-height: 500px;
            padding: 20px;
        }
        .form-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #1f3d62;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .form-group {
            margin-bottom: 12px;
        }
        .form-label {
            display: block;
            font-size: 0.72rem;
            font-weight: 600;
            color: #1f3d62;
            margin-bottom: 4px;
        }
        .form-control {
            width: 100%;
            padding: 0.5rem 0.8rem;
            font-size: 0.75rem;
            border: 1px solid #b3c7e0;
            border-radius: 8px;
            background: white;
            color: #0a1c2f;
        }
        .form-control:focus {
            outline: none;
            border-color: #2b4a73;
            box-shadow: 0 0 0 2px rgba(43,74,115,0.1);
        }
        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        /* Table Container */
        .table-responsive {
            flex: 1;
            overflow: auto;
            background: white;
            scrollbar-width: thin;
            scrollbar-color: #97adc9 #ecf2fa;
        }
        .table-responsive::-webkit-scrollbar { width: 10px; height: 10px; }
        .table-responsive::-webkit-scrollbar-track { background: #ecf2fa; }
        .table-responsive::-webkit-scrollbar-thumb { background: #97adc9; border-radius: 8px; }

        .projects-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 1000px;
            color: #0a1c2f;
        }

        th, td {
            padding: 12px 15px;
            font-size: 0.75rem;
            text-align: left;
            border: 1px solid #c7d6ec;
        }

        th {
            font-weight: 700;
            background: #d4e2f2;
            color: #0a1c2f;
            position: sticky;
            top: 0;
            z-index: 20;
            border-bottom: 2px solid #1f3d62;
            white-space: nowrap;
        }

        tr:hover td {
            background: #e3ecf7;
            cursor: pointer;
        }

        .project-name {
            font-weight: 600;
            color: #2b6cb0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .project-name i {
            color: #7f96b3;
            font-size: 0.9rem;
        }

        .project-client {
            color: #4a5568;
            font-size: 0.72rem;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.65rem;
            display: inline-block;
            text-transform: uppercase;
        }
        .status-active {
            background: #d1fae5;
            color: #065f46;
        }
        .status-completed {
            background: #dbeafe;
            color: #1e40af;
        }
        .status-hidden {
            background: #fed7d7;
            color: #991b1b;
        }

        /* Progress Bar */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .progress-bar {
            flex: 1;
            height: 6px;
            background: #e0e8f5;
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #059669, #2b6cb0);
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-text {
            font-size: 0.7rem;
            color: #4a5568;
            min-width: 40px;
            text-align: right;
        }

        /* Table Actions */
        .table-actions {
            display: flex;
            gap: 4px;
            justify-content: flex-end;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #7f96b3;
            font-size: 0.85rem;
        }
        .empty-state i {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 10px;
        }

        /* Text Utilities */
        .text-truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        .text-muted {
            color: #7f96b3;
        }

        /* Loading State */
        .loading-row td {
            text-align: center;
            color: #2b4a73;
            padding: 40px;
            font-style: italic;
        }
    </style>
</head>
<body>
<div class="panel">
    <!-- Panel Header -->
    <div class="panel-heading">
        <a href="javascript:history.back()" class="back-link">
            <i class="fas fa-arrow-left"></i> Back
        </a>
        <span style="flex:1"><i class="fas fa-project-diagram"></i> Project Dashboard</span>
        <span id="liveIndicator" style="font-size:0.65rem; opacity:0.6; display:flex; align-items:center; gap:4px;">
            <i class="fas fa-circle" style="color:#4ade80; font-size:0.55rem"></i> Live
        </span>
    </div>

    <!-- Summary Strip -->
    <div class="summary-strip">
        <div class="stat-pill projects">üìä Total Projects: <span id="statTotal">‚Äî</span></div>
        <div class="stat-pill active">‚úÖ Active: <span id="statActive">‚Äî</span></div>
        <div class="stat-pill completed">‚úîÔ∏è Completed: <span id="statCompleted">‚Äî</span></div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="filter-group">
            <span class="filter-label">Status:</span>
            <select id="statusFilter" class="filter-select">
                <option value="all">All Projects</option>
                <option value="active">Active Only</option>
                <option value="completed">Completed Only</option>
            </select>

            <span class="filter-label">Sort By:</span>
            <select id="sortFilter" class="filter-select">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="name">Project Name (A-Z)</option>
            </select>

            <button class="btn" id="toggleHiddenBtn">
                <i class="fas fa-eye"></i> Show Hidden
            </button>
            
            <button class="btn btn-primary" id="toggleFormBtn">
                <i class="fas fa-plus"></i> New Project
            </button>
            
            <button class="btn" id="toggleModeBtn">
                <i class="fas fa-moon"></i> Dark Mode
            </button>
        </div>
    </div>

    <!-- Form Container -->
    <div class="form-container" id="formContainer">
        <div class="form-title">
            <i class="fas fa-plus-circle" style="color:#059669"></i> Create New Project
        </div>
        <form id="projectForm">
            <div class="form-group">
                <label for="projectName" class="form-label">Project Name</label>
                <input type="text" id="projectName" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="client" class="form-label">Client</label>
                <input type="text" id="client" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="projectGoal" class="form-label">Project Goal</label>
                <textarea id="projectGoal" class="form-control" required></textarea>
            </div>
            
            <div class="form-actions">
                <button type="reset" class="btn" onclick="toggleFormBtn.click()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Create Project
                </button>
            </div>
        </form>
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="projects-table">
            <thead>
                <tr>
                    <th>Project</th>
                    <th>Client</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Created</th>
                    <th style="text-align:center">Actions</th>
                </tr>
            </thead>
            <tbody id="projectsTableBody">
                <tr class="loading-row">
                    <td colspan="6">
                        <i class="fas fa-circle-notch fa-spin"></i> Loading projects...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
        authDomain: "project-task-588c4.firebaseapp.com",
        projectId: "project-task-588c4",
        storageBucket: "project-task-588c4.appspot.com",
        messagingSenderId: "411882772509",
        appId: "1:411882772509:web:08d613186c101a99f38ef4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const projectsCollection = collection(db, "projectDashboard");

    // DOM Elements
    const toggleFormBtn = document.getElementById('toggleFormBtn');
    const toggleModeBtn = document.getElementById('toggleModeBtn');
    const formContainer = document.getElementById('formContainer');
    const projectForm = document.getElementById('projectForm');
    const projectsTableBody = document.getElementById('projectsTableBody');
    const body = document.body;
    const statusFilter = document.getElementById('statusFilter');
    const sortFilter = document.getElementById('sortFilter');
    const toggleHiddenBtn = document.getElementById('toggleHiddenBtn');

    // State
    let showHiddenProjects = false;
    let allProjects = [];

    // Toggle form visibility
    toggleFormBtn.addEventListener('click', function() {
        formContainer.classList.toggle('visible');
        if (formContainer.classList.contains('visible')) {
            this.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Form';
            document.getElementById('projectName').focus();
        } else {
            this.innerHTML = '<i class="fas fa-plus"></i> New Project';
            projectForm.reset();
        }
    });

    // Toggle dark/light mode
    function setTheme(isDark) {
        if (isDark) {
            document.documentElement.style.setProperty('--bg-color', '#0a1c2f');
            document.documentElement.style.setProperty('--text-color', 'white');
            document.querySelector('.panel').style.background = '#0a1c2f';
            toggleModeBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
        } else {
            document.documentElement.style.setProperty('--bg-color', '#f5f7fa');
            document.documentElement.style.setProperty('--text-color', '#0a1c2f');
            document.querySelector('.panel').style.background = 'white';
            toggleModeBtn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
        }
    }

    toggleModeBtn.addEventListener('click', function() {
        const isDark = document.querySelector('.panel').style.background !== '#0a1c2f';
        setTheme(isDark);
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    // Load saved theme
    if (localStorage.getItem('theme') === 'dark') {
        setTheme(true);
    }

    // Toggle hidden projects
    toggleHiddenBtn.addEventListener('click', function() {
        showHiddenProjects = !showHiddenProjects;
        this.innerHTML = showHiddenProjects 
            ? '<i class="fas fa-eye-slash"></i> Hide Hidden' 
            : '<i class="fas fa-eye"></i> Show Hidden';
        renderProjects();
    });

    // Filter and sort projects
    statusFilter.addEventListener('change', renderProjects);
    sortFilter.addEventListener('change', renderProjects);

    // Handle form submission
    projectForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        try {
            await addDoc(projectsCollection, {
                name: document.getElementById('projectName').value,
                client: document.getElementById('client').value,
                goal: document.getElementById('projectGoal').value,
                status: 'active',
                createdAt: new Date(),
                completedAt: null,
                tasks: [],
                objectives: [],
                hidden: false
            });
            
            this.reset();
            formContainer.classList.remove('visible');
            toggleFormBtn.innerHTML = '<i class="fas fa-plus"></i> New Project';
        } catch (error) {
            console.error("Error adding project: ", error);
            alert("Error adding project. Please try again.");
        }
    });

    // Format date
    function formatDate(dateString) {
        if (!dateString) return 'Not set';
        const date = dateString.toDate ? dateString.toDate() : new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
    }

    // Calculate progress percentage
    function calculateProgress(project) {
        if (project.status === 'completed') return 100;
        if (!project.tasks || project.tasks.length === 0) return 0;
        const completedTasks = project.tasks.filter(t => t.completed).length;
        return Math.round((completedTasks / project.tasks.length) * 100);
    }

    // Update stats
    function updateStats(projects) {
        const total = projects.length;
        const active = projects.filter(p => p.status === 'active').length;
        const completed = projects.filter(p => p.status === 'completed').length;
        
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statActive').textContent = active;
        document.getElementById('statCompleted').textContent = completed;
    }

    // Create project row
    function createProjectRow(id, project) {
        const isCompleted = project.status === 'completed';
        const isHidden = project.hidden;
        const progress = calculateProgress(project);
        
        const row = document.createElement('tr');
        row.dataset.id = id;
        
        if (isHidden && !showHiddenProjects) {
            row.style.display = 'none';
        }
        
        let statusClass = 'status-active';
        let statusText = 'Active';
        if (isCompleted) {
            statusClass = 'status-completed';
            statusText = 'Completed';
        } else if (isHidden) {
            statusClass = 'status-hidden';
            statusText = 'Hidden';
        }
        
        row.innerHTML = `
            <td>
                <div class="project-name">
                    <i class="fas fa-project-diagram"></i>
                    <span class="text-truncate">${project.name}</span>
                </div>
            </td>
            <td>
                <div class="project-client text-truncate">
                    ${project.client || 'No client'}
                </div>
            </td>
            <td>
                <span class="status-badge ${statusClass}">${statusText}</span>
            </td>
            <td>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <span class="progress-text">${progress}%</span>
                </div>
            </td>
            <td>
                <span class="text-muted">${formatDate(project.createdAt)}</span>
            </td>
            <td>
                <div class="table-actions">
                    ${!isCompleted ? `
                        <button class="btn btn-icon btn-success complete-btn" title="Complete Project">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                    <button class="btn btn-icon toggle-hidden-btn" title="${isHidden ? 'Show Project' : 'Hide Project'}">
                        <i class="fas ${isHidden ? 'fa-eye' : 'fa-eye-slash'}"></i>
                    </button>
                    <button class="btn btn-icon delete-btn" title="Delete Project">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        
        // Row click handler
        row.addEventListener('click', (e) => {
            if (!e.target.closest('button')) {
                window.location.href = `Projectworks.html?id=${id}`;
            }
        });
        
        // Complete button
        if (!isCompleted) {
            const completeBtn = row.querySelector('.complete-btn');
            completeBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (confirm('Mark this project as completed?')) {
                    try {
                        await updateDoc(doc(db, "projectDashboard", id), {
                            status: 'completed',
                            completedAt: new Date()
                        });
                    } catch (error) {
                        console.error("Error completing project: ", error);
                        alert("Error completing project. Please try again.");
                    }
                }
            });
        }
        
        // Toggle hidden button
        const toggleBtn = row.querySelector('.toggle-hidden-btn');
        toggleBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            try {
                await updateDoc(doc(db, "projectDashboard", id), {
                    hidden: !project.hidden
                });
            } catch (error) {
                console.error("Error toggling project visibility: ", error);
                alert("Error toggling project visibility. Please try again.");
            }
        });
        
        // Delete button
        const deleteBtn = row.querySelector('.delete-btn');
        deleteBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (confirm('Are you sure you want to delete this project?')) {
                try {
                    await deleteDoc(doc(db, "projectDashboard", id));
                } catch (error) {
                    console.error("Error deleting project: ", error);
                    alert("Error deleting project. Please try again.");
                }
            }
        });
        
        return row;
    }

    // Filter and sort projects
    function filterAndSortProjects() {
        let filtered = [...allProjects];
        
        const status = statusFilter.value;
        if (status === 'active') {
            filtered = filtered.filter(p => p.status === 'active');
        } else if (status === 'completed') {
            filtered = filtered.filter(p => p.status === 'completed');
        }
        
        if (!showHiddenProjects) {
            filtered = filtered.filter(p => !p.hidden);
        }
        
        const sort = sortFilter.value;
        if (sort === 'newest') {
            filtered.sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());
        } else if (sort === 'oldest') {
            filtered.sort((a, b) => a.createdAt?.toMillis() - b.createdAt?.toMillis());
        } else if (sort === 'name') {
            filtered.sort((a, b) => a.name.localeCompare(b.name));
        }
        
        return filtered;
    }

    // Render projects
    function renderProjects() {
        projectsTableBody.innerHTML = '';
        
        if (allProjects.length === 0) {
            projectsTableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <p>No projects found. Create your first project!</p>
                        <button class="btn btn-primary" id="emptyStateCreateBtn">
                            <i class="fas fa-plus"></i> Create Project
                        </button>
                    </td>
                </tr>
            `;
            
            document.getElementById('emptyStateCreateBtn')?.addEventListener('click', () => {
                formContainer.classList.add('visible');
                toggleFormBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Form';
            });
            
            return;
        }
        
        const filteredProjects = filterAndSortProjects();
        updateStats(allProjects);
        
        if (filteredProjects.length === 0) {
            projectsTableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>No projects match your filters</p>
                        <button class="btn" onclick="toggleHiddenBtn.click()">
                            ${showHiddenProjects ? 'Hide' : 'Show'} Hidden Projects
                        </button>
                    </td>
                </tr>
            `;
            return;
        }
        
        filteredProjects.forEach(project => {
            const row = createProjectRow(project.id, project);
            projectsTableBody.appendChild(row);
        });
    }

    // Load projects from Firestore
    onSnapshot(projectsCollection, (snapshot) => {
        allProjects = snapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data(),
            createdAt: doc.data().createdAt,
            completedAt: doc.data().completedAt
        }));
        
        renderProjects();
    }, (error) => {
        console.error("Error loading projects: ", error);
        projectsTableBody.innerHTML = `
            <tr>
                <td colspan="6" class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error loading projects. Please refresh the page.</p>
                    <button class="btn btn-primary" onclick="window.location.reload()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </td>
            </tr>
        `;
    });

    // Inactivity timeout
    let inactivityTimeout;
    function resetInactivityTimeout() {
        clearTimeout(inactivityTimeout);
        inactivityTimeout = setTimeout(() => {
            window.location.href = 'index.html';
        }, 600000);
    }

    resetInactivityTimeout();
    document.addEventListener('mousemove', resetInactivityTimeout);
    document.addEventListener('keypress', resetInactivityTimeout);
    document.addEventListener('click', resetInactivityTimeout);
    document.addEventListener('touchstart', resetInactivityTimeout);
</script>
</body>
</html>
