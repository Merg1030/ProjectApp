<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt ¬∑ Firebase ¬∑ light blue bars ¬∑ fixed</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- flatpickr for inline calendar -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #d3dfed;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: #0a1c2f;
            color: white;
            padding: 0.6rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            min-height: 60px;
        }
        
        .app-header h2 {
            font-weight: 500;
            font-size: 1.1rem;
        }
        
        .back-btn {
            background: white;
            color: #0b1f33;
            border: none;
            padding: 0.3rem 1.2rem;
            border-radius: 30px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .back-btn:hover {
            background: #e6efff;
        }
        
        .header-buttons {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }
        
        .add-btn, .resources-btn, .history-btn {
            background: white;
            color: #0b1f33;
            border: none;
            padding: 0.3rem 1.2rem;
            border-radius: 30px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .add-btn:hover, .resources-btn:hover, .history-btn:hover {
            background: #e6efff;
        }

        /* mini modal / inline form (no dates) */
        .task-form-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .task-form-card {
            background: white;
            width: 340px;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,20,40,0.5);
            padding: 1.8rem 1.8rem 1.5rem;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .task-form-card h3 {
            color: #0a1c2f;
            margin-bottom: 1.2rem;
            font-weight: 600;
            font-size: 1.3rem;
            border-left: 5px solid #2b4a73;
            padding-left: 0.8rem;
        }
        .task-form-card label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #1f3d62;
            font-weight: 600;
            display: block;
            margin: 0.7rem 0 0.2rem;
        }
        .task-form-card input, .task-form-card select {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid #b3c7e0;
            border-radius: 30px;
            font-size: 0.8rem;
            background: #f2f6fc;
            outline: none;
            margin-bottom: 0.5rem;
        }
        .task-form-card input:focus, .task-form-card select:focus {
            border-color: #1f3d62;
            background: white;
        }
        .row2 {
            display: flex;
            gap: 0.8rem;
        }
        .row2 > div {
            flex: 1;
        }
        .button-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            gap: 0.5rem;
        }
        .button-bar button {
            flex: 1;
            padding: 0.6rem;
            border-radius: 40px;
            border: none;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            background: white;
            border: 1px solid #2b4a73;
            color: #0a1c2f;
        }
        .button-bar button.primary {
            background: #0a1c2f;
            color: white;
            border: none;
        }
        .button-bar button.primary:hover {
            background: #1f3d62;
        }
        .button-bar button:hover {
            background: #e6efff;
        }
        .close-icon {
            position: absolute;
            top: 16px; right: 20px;
            font-size: 1.4rem;
            color: #7f96b3;
            cursor: pointer;
        }
        .close-icon:hover {
            color: #0a1c2f;
        }
        select[multiple] {
            height: auto;
            min-height: 80px;
            border-radius: 16px;
            padding: 0.4rem;
        }

        .gantt-panel {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            padding: 1rem 1.5rem 1.5rem 1.5rem;
            overflow: hidden;
            min-height: 0;
        }

        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f2f6fc;
            padding: 0.6rem 1.5rem;
            border-radius: 60px;
            border: 1px solid #b3c7e0;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }
        .info-tag {
            font-size: 0.8rem;
            font-weight: 500;
            color: #1d3a5c;
        }
        .info-tag i {
            margin-right: 6px;
        }
        .month-toggle-btn {
            background: white;
            border: 1px solid #2b4a73;
            border-radius: 30px;
            padding: 0.3rem 1.4rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
        }
        .month-toggle-btn:hover {
            background: #0b1f33;
            color: white;
        }

        .master-scroll {
            flex: 1;
            overflow: auto;
            border: 1px solid #a2b9d4;
            border-radius: 10px;
            background: white;
            scrollbar-width: thin;
            scrollbar-color: #97adc9 #ecf2fa;
            min-height: 0;
        }
        .master-scroll::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        .master-scroll::-webkit-scrollbar-track {
            background: #ecf2fa;
            border-radius: 8px;
        }
        .master-scroll::-webkit-scrollbar-thumb {
            background: #97adc9;
            border-radius: 8px;
            border: 2px solid #ecf2fa;
        }

        .gantt-rows-wrapper {
            display: flex;
            align-items: flex-start;
            min-width: max-content;
            height: 100%;
            position: relative;
        }

        /* LEFT FROZEN */
        .gantt-left-fixed {
            flex-shrink: 0;
            background: white;
            position: sticky;
            left: 0;
            z-index: 30;
            box-shadow: 4px 0 8px -4px rgba(0,20,40,0.2);
            border-right: 2px solid #1f3d62;
        }

        .gantt-left-fixed table {
            border-collapse: collapse;
        }

        .gantt-left-fixed thead {
            position: sticky;
            top: 0;
            z-index: 31;
            background: inherit;
        }

        .gantt-left-fixed th.task-management-header {
            background: #b8cde0;
            border: 1px solid #9bb1cc;
            border-right: 2px solid #1f3d62;
            border-bottom: 2px solid #1f3d62;
            font-size: 0.8rem;
            padding: 8px 5px;
            text-align: left;
            font-weight: 700;
            color: #0a1c2f;
        }
        .gantt-left-fixed th {
            background: #d4e2f2;
            border: 1px solid #9bb1cc;
            border-right: 2px solid #1f3d62;
            border-bottom: 2px solid #1f3d62;
            font-size: 0.7rem;
            padding: 10px 5px;
            white-space: nowrap;
        }
        .gantt-left-fixed td {
            background: white;
            border: 1px solid #c7d6ec;
            border-right: 2px solid #c7d6ec;
            padding: 10px 6px;
            font-size: 0.72rem;
            text-align: left;
        }
        .gantt-left-fixed td:hover {
            background: #e3ecf7;
        }

        .cost-cell {
            cursor: pointer;
            color: #2b4a73;
            font-weight: 600;
            background: #ffffff !important;
        }

        .cost-cell:hover {
            background: #fbcba5 !important;
        }

        /* Editable cells styling */
        .editable-cell {
            cursor: text;
            position: relative;
            min-width: 60px;
        }
        
        .editable-cell:hover {
            background: #e3ecf7 !important;
            outline: 2px solid #2b4a73;
            outline-offset: -2px;
        }
        
        .editable-cell input {
            width: 100%;
            padding: 4px 6px;
            border: 2px solid #2b4a73;
            border-radius: 4px;
            font-size: 0.72rem;
            background: white;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 100;
        }

        /* Budget exceeded styling - entire row turns red */
        tr.budget-exceeded {
            background-color: #ff6b6b !important;
        }
        
        tr.budget-exceeded td {
            background-color: #f22626 !important;
            color: rgb(0, 0, 0) !important;
            border-color:  #f22626;
        }
        
        tr.budget-exceeded .cost-cell {
            background-color: #ff5252 !important;
            color: white !important;
        }
        
        tr.budget-exceeded .status-badge {
            background: white !important;
            color: #ff6b6b !important;
            border-color: white !important;
        }

        /* RIGHT CALENDAR */
        .gantt-calendar {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }
        
        .gantt-calendar table {
            border-collapse: collapse;
            width: 100%;
            position: relative;
        }
        
        .gantt-calendar thead {
            position: sticky;
            top: 0;
            z-index: 25;
            background: #eef4fd;
            box-shadow: 0 2px 3px rgba(0,0,0,0.05);
        }

        .gantt-calendar th {
            background: #eef4fd;
            font-size: 0.68rem;
            padding: 8px 2px;
            text-align: center;
            white-space: nowrap;
            position: relative;
            z-index: 5;
            border: none;
        }

        .gantt-calendar tbody {
            position: relative;
        }
        
        .gantt-calendar td {
            padding: 8px 2px;
            text-align: center;
            white-space: nowrap;
            background: transparent;
            position: relative;
            border: none;
            cursor: pointer;
        }
        .gantt-calendar td:hover {
            background: rgba(30, 60, 100, 0.15);
        }

        /* week lines continuous */
        .gantt-calendar td.week-start::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -1px;
            height: 220px;
            background-color: #6b6b6b;
            pointer-events: none;
            z-index: 10;
        }
        
        .gantt-calendar td.week-end::after {
            content: '';
            position: absolute;
            top: -51px;
            right: -1px;
            width: 0.1px;
            height: 220px;
            background-color: #6b6b6b;
            pointer-events: none;
            z-index: 10;
        }

        .gantt-calendar th.week-start::before,
        .gantt-calendar th.week-end::after,
        .gantt-calendar th.week-start::after,
        .gantt-calendar th.week-end::before {
            display: none;
        }

        .today-highlight {
            background-color: #fce3cd !important;
            font-weight: 700;
        }

        .task-main {
            font-weight: 700;
            background-color: #ecf3fc;
        }
        .task-main td:first-child {
            padding-left: 8px !important;
        }
        
        .task-sub td:first-child {
            padding-left: 32px !important;
            position: relative;
        }
        .task-sub td:first-child::before {
            content: "‚Ü≥";
            position: absolute;
            left: 16px;
            color: #1f3d62;
            font-size: 0.8rem;
        }

        .blank-row td {
            background: #f9fcff;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 30px;
            font-size: 0.6rem;
            font-weight: 700;
            border: 1px solid;
            background: #e1ecfe;
            color: #1d3a5c;
            border-color: #9bb7da;
        }

        /* LIGHT BLUE BARS ‚Äì UNIFIED COLOR */
        .gantt-bar {
            height: 8px;
           width: 20px;
           margin: -12px;
            box-sizing: border-box;
            padding: 0px;
            
            background: #66c2ff;
        }
        .task-main .gantt-bar {
            height: 12px;
            margin-top: -1px;
        }
        .task-sub .gantt-bar {
            height: 8px;
            margin-top: 1px;
        }

        .task-num {
            display: inline-block;
            min-width: 32px;
            color: #4a6a8a;
            font-weight: 500;
            margin-right: 6px;
        }

        .hidden-date-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
            width: 0;
            height: 0;
        }
        .loading {
            padding: 20px;
            text-align: center;
            color: #1f3d62;
        }

        /* Simple Allocation Modal - just for assigning */
        .allocation-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .allocation-modal {
            background: white;
            width: 400px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,20,40,0.5);
            padding: 1.8rem;
            position: relative;
        }

        .allocation-modal h3 {
            color: #0a1c2f;
            margin-bottom: 1rem;
            font-weight: 600;
            font-size: 1.1rem;
            border-left: 5px solid #2b4a73;
            padding-left: 0.8rem;
        }

        .allocation-modal label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #1f3d62;
            font-weight: 600;
            display: block;
            margin: 0.8rem 0 0.3rem;
        }

        .allocation-modal select,
        .allocation-modal input {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid #b3c7e0;
            border-radius: 8px;
            font-size: 0.8rem;
            background: #f2f6fc;
            outline: none;
            margin-bottom: 0.8rem;
            box-sizing: border-box;
        }

        .allocation-modal select:focus,
        .allocation-modal input:focus {
            border-color: #1f3d62;
            background: white;
        }

        .stock-warning {
            color: #ff6b6b;
            font-size: 0.7rem;
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #ffe5e5;
            border-radius: 4px;
            display: none;
        }

        .modal-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .modal-buttons button {
            flex: 1;
            padding: 0.6rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .modal-buttons button.cancel {
            background: white;
            border: 1px solid #2b4a73;
            color: #0a1c2f;
        }

        .modal-buttons button.cancel:hover {
            background: #e6efff;
        }

        .modal-buttons button.primary {
            background: #059669;
            color: white;
        }

        .modal-buttons button.primary:hover {
            background: #047857;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 20px;
            font-size: 1.4rem;
            color: #7f96b3;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #0a1c2f;
        }

        .history-link {
            text-decoration: none;
            color: inherit;
        }
    </style>
</head>
<body>

    <div class="app-header">
        <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i> Back</button>
        <h2 id="projectTitle">construction project Management</h2>
        <div class="header-buttons">
            <button class="history-btn" onclick="goToHistory()"><i class="fas fa-history"></i> History</button>
            <button class="resources-btn" id="resourcesBtn" onclick="goToResources()"><i class="fas fa-boxes"></i> Resources</button>
            <button class="add-btn" id="addTaskBtn"><i class="fas fa-plus"></i> Add task</button>
        </div>
    </div>

    <!-- TASK FORM MODAL -->
    <div class="task-form-overlay" id="taskFormOverlay">
        <div class="task-form-card">
            <i class="fas fa-times close-icon" id="closeFormBtn"></i>
            <h3 id="formTitle">‚ûï add task</h3>
            <label>Task name</label>
            <input type="text" id="taskNameInput" placeholder="e.g. Excavation" value="New task">

            <div class="row2">
                <div>
                    <label>Duration (e.g., 12d)</label>
                    <input type="text" id="durationInput" value="10d">
                </div>
                <div>
                    <label>Budget</label>
                    <input type="number" id="budgetInput" value="0" min="0" step="100">
                </div>
            </div>

            <label>Predecessors (multi)</label>
            <select id="predMultiSelect" multiple size="3"></select>
            <div style="font-size:0.6rem; color:#1f3d62;">ctrl+click to select multiple</div>

            <label>Task type</label>
            <select id="taskTypeSelect">
                <option value="main">üîπ Main task</option>
                <option value="sub">üî∏ Subtask</option>
            </select>

            <div id="parentSelector" style="display:none; margin-top:0.8rem;">
                <label>Parent main task</label>
                <select id="parentTaskSelect"></select>
            </div>

            <div class="button-bar">
                <button id="cancelFormBtn">Cancel</button>
                <button class="primary" id="saveTaskBtn">Save task</button>
            </div>
            <div style="font-size:0.65rem; text-align:center; margin-top:1rem; color:#1f3d62;">
                ‚è∫ Double-click on TASK, BUDGET, or DUR cells to edit
            </div>
        </div>
    </div>

    <!-- SIMPLE MATERIAL ASSIGNMENT MODAL -->
    <div class="allocation-overlay" id="materialAllocOverlay">
        <div class="allocation-modal">
            <i class="fas fa-times modal-close" onclick="closeMaterialAllocModal()"></i>
            <h3>üì¶ Assign Material to <span id="taskNameMaterial">Task</span></h3>

            <label>Select Material</label>
            <select id="materialSelect"></select>

            <label>Quantity</label>
            <input type="number" id="materialQtyInput" placeholder="Enter quantity" min="0" step="0.01">

            <div id="stockWarning" class="stock-warning"></div>

            <div class="modal-buttons">
                <button class="cancel" onclick="closeMaterialAllocModal()">Cancel</button>
                <button class="primary" onclick="assignMaterial()">Assign Material</button>
            </div>
        </div>
    </div>

    <!-- SIMPLE LABOR ASSIGNMENT MODAL -->
    <div class="allocation-overlay" id="laborAllocOverlay">
        <div class="allocation-modal">
            <i class="fas fa-times modal-close" onclick="closeLaborAllocModal()"></i>
            <h3>üë∑ Assign Worker to <span id="taskNameLabor">Task</span></h3>

            <label>Select Worker</label>
            <select id="laborSelect"></select>

            <label>Hours</label>
            <input type="number" id="laborHoursInput" placeholder="Enter hours" min="0" step="0.5">

            <div class="modal-buttons">
                <button class="cancel" onclick="closeLaborAllocModal()">Cancel</button>
                <button class="primary" onclick="assignLabor()">Assign Worker</button>
            </div>
        </div>
    </div>

    <!-- hidden input for flatpickr -->
    <input type="text" id="hiddenDatePicker" class="hidden-date-input">

    <div class="gantt-panel">
        <div class="controls-bar">
            <span class="info-tag"></i>PENTA Construction</span>
            <button class="month-toggle-btn" id="currentMonthBtn">Current Month</button>
        </div>

        <div class="master-scroll" id="masterScroll">
            <div class="gantt-rows-wrapper">
                <div class="gantt-left-fixed">
                    <table>
                        <thead id="ganttHeadLeft"></thead>
                        <tbody id="ganttBodyLeft"></tbody>
                    </table>
                </div>
                <div class="gantt-calendar">
                    <table>
                        <thead id="ganttHeadRight"></thead>
                        <tbody id="ganttBodyRight"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics-compat.js"></script>
    <!-- flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        // ========== GET PROJECT ID FROM URL ==========
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('project');

        // Initialize Firebase (compat version)
        const firebaseConfig = {
            apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
            authDomain: "project-task-588c4.firebaseapp.com",
            projectId: "project-task-588c4",
            storageBucket: "project-task-588c4.firebasestorage.app",
            messagingSenderId: "411882772509",
            appId: "1:411882772509:web:08d613186c101a99f38ef4",
            measurementId: "G-JMFLFYEM0F"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // ========== GLOBAL STATE ==========
        let tasks = [];
        let materials = [];
        let labor = [];
        let showCurrentMonthOnly = false;
        const BLANK_ROWS = 30;
        let activeTaskId = null;
        let activeDateType = null;
        let currentProject = null;
        let currentAssigningTaskId = null;
        let currentAssignType = null;

        // DOM elements
        const headLeft = document.getElementById('ganttHeadLeft');
        const bodyLeft = document.getElementById('ganttBodyLeft');
        const headRight = document.getElementById('ganttHeadRight');
        const bodyRight = document.getElementById('ganttBodyRight');
        const addBtn = document.getElementById('addTaskBtn');
        const resourcesBtn = document.getElementById('resourcesBtn');
        const monthBtn = document.getElementById('currentMonthBtn');
        const hiddenPicker = document.getElementById('hiddenDatePicker');
        const projectTitle = document.getElementById('projectTitle');

        // Form elements
        const overlay = document.getElementById('taskFormOverlay');
        const closeFormBtn = document.getElementById('closeFormBtn');
        const cancelBtn = document.getElementById('cancelFormBtn');
        const saveBtn = document.getElementById('saveTaskBtn');
        const taskNameInput = document.getElementById('taskNameInput');
        const durationInput = document.getElementById('durationInput');
        const budgetInput = document.getElementById('budgetInput');
        const predMultiSelect = document.getElementById('predMultiSelect');
        const taskTypeSelect = document.getElementById('taskTypeSelect');
        const parentSelectorDiv = document.getElementById('parentSelector');
        const parentTaskSelect = document.getElementById('parentTaskSelect');
        const formTitle = document.getElementById('formTitle');

        // Material assignment
        const materialSelect = document.getElementById('materialSelect');
        const materialQtyInput = document.getElementById('materialQtyInput');
        const stockWarning = document.getElementById('stockWarning');

        // Labor assignment
        const laborSelect = document.getElementById('laborSelect');
        const laborHoursInput = document.getElementById('laborHoursInput');

        // ========== NAVIGATION FUNCTIONS ==========
        function goBack() {
            window.history.back();
        }

        function goToResources() {
            if (!projectId) {
                alert('No project selected');
                return;
            }
            window.location.href = `resources.html?project=${projectId}`;
        }

        function goToHistory() {
            if (!projectId) {
                alert('No project selected');
                return;
            }
            window.location.href = `history.html?project=${projectId}`;
        }

        // ========== LOAD PROJECT NAME ==========
        async function loadProjectName() {
            if (!projectId) return;
            try {
                const doc = await db.collection('projects').doc(projectId).get();
                if (doc.exists) {
                    currentProject = { id: projectId, ...doc.data() };
                    projectTitle.textContent = currentProject.name || 'Project Management';
                }
            } catch (error) {
                console.error('Error loading project:', error);
            }
        }

        // ========== LOAD RESOURCES ==========
        function loadResources() {
            if (!projectId) return;

            // Load materials
            db.collection('materials')
                .where('projectId', '==', projectId)
                .onSnapshot((snapshot) => {
                    materials = snapshot.docs.map(doc => ({
                        docId: doc.id,
                        ...doc.data()
                    }));
                    updateMaterialSelect();
                });

            // Load labor
            db.collection('labor')
                .where('projectId', '==', projectId)
                .onSnapshot((snapshot) => {
                    labor = snapshot.docs.map(doc => ({
                        docId: doc.id,
                        ...doc.data()
                    }));
                    updateLaborSelect();
                });
        }

        function updateMaterialSelect() {
            materialSelect.innerHTML = '<option value="">-- Select Material --</option>' +
                materials.map(m => {
                    const stock = m.availableStock || 0;
                    return `<option value="${m.docId}" data-cost="${m.unitCost || 0}" data-stock="${stock}">${m.name} (${(m.unitCost || 0).toFixed(2)}/${m.unit}) - Available: ${stock.toFixed(2)} ${m.unit}</option>`;
                }).join('');
        }

        function updateLaborSelect() {
            laborSelect.innerHTML = '<option value="">-- Select Worker --</option>' +
                labor.map(l => `<option value="${l.docId}" data-rate="${l.hourlyRate || 0}">${l.name} (${(l.hourlyRate || 0).toFixed(2)}/hr)</option>`).join('');
        }

        // ========== UPDATE MATERIAL STOCK ==========
        async function updateMaterialStock(materialId, qty, isAddition = true) {
            const material = materials.find(m => m.docId === materialId);
            if (!material) return false;

            const currentStock = material.availableStock || 0;
            const newStock = isAddition ? currentStock - qty : currentStock + qty;

            if (isAddition && newStock < 0) {
                alert(`Insufficient stock for ${material.name}. Available: ${currentStock.toFixed(2)} ${material.unit}`);
                return false;
            }

            try {
                await db.collection('materials').doc(materialId).update({
                    availableStock: newStock,
                    totalUsed: (material.totalUsed || 0) + (isAddition ? qty : -qty),
                    updatedAt: new Date()
                });
                return true;
            } catch (error) {
                console.error('Error updating material stock:', error);
                return false;
            }
        }

        // ========== UPDATE LABOR HOURS ==========
        async function updateLaborHours(workerId, hours, isAddition = true) {
            const worker = labor.find(l => l.docId === workerId);
            if (!worker) return false;

            const currentHours = worker.totalHoursAllocated || 0;
            const newHours = isAddition ? currentHours + hours : currentHours - hours;

            try {
                await db.collection('labor').doc(workerId).update({
                    totalHoursAllocated: newHours,
                    status: newHours > 0 ? 'busy' : worker.status,
                    updatedAt: new Date()
                });
                return true;
            } catch (error) {
                console.error('Error updating labor hours:', error);
                return false;
            }
        }

        // ========== ASSIGNMENT FUNCTIONS ==========
        function openMaterialAssign(taskId) {
            currentAssigningTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            document.getElementById('taskNameMaterial').textContent = task ? task.name : 'Task';
            
            materialQtyInput.value = '';
            stockWarning.style.display = 'none';
            document.getElementById('materialAllocOverlay').style.display = 'flex';
        }

        function openLaborAssign(taskId) {
            currentAssigningTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            document.getElementById('taskNameLabor').textContent = task ? task.name : 'Task';
            
            laborHoursInput.value = '';
            document.getElementById('laborAllocOverlay').style.display = 'flex';
        }

        function closeMaterialAllocModal() {
            document.getElementById('materialAllocOverlay').style.display = 'none';
            currentAssigningTaskId = null;
        }

        function closeLaborAllocModal() {
            document.getElementById('laborAllocOverlay').style.display = 'none';
            currentAssigningTaskId = null;
        }

        async function assignMaterial() {
            const materialId = materialSelect.value;
            const qty = parseFloat(materialQtyInput.value);

            if (!materialId || !qty || qty <= 0) {
                alert('Please select material and enter quantity');
                return;
            }

            const material = materials.find(m => m.docId === materialId);
            if (!material) return;
            
            // Check stock availability
            const currentStock = material.availableStock || 0;
            if (qty > currentStock) {
                stockWarning.textContent = `‚ö†Ô∏è Insufficient stock! Available: ${currentStock.toFixed(2)} ${material.unit}`;
                stockWarning.style.display = 'block';
                return;
            }

            // Update stock in materials collection
            const stockUpdated = await updateMaterialStock(materialId, qty, true);
            if (!stockUpdated) return;

            // Create allocation entry
            const cost = qty * (material.unitCost || 0);
            const now = new Date();
            const dateStr = now.toISOString();

            const task = tasks.find(t => t.id === currentAssigningTaskId);
            if (task) {
                // Get existing allocations or create new
                const materialAllocations = task.materialAllocations || {};
                
                if (!materialAllocations[materialId]) {
                    materialAllocations[materialId] = { 
                        material, 
                        entries: [],
                        totalQty: 0,
                        totalCost: 0
                    };
                }

                // Add new entry
                materialAllocations[materialId].entries.push({
                    date: dateStr,
                    qty: qty,
                    cost: cost,
                    unitCost: material.unitCost || 0
                });

                // Update totals
                materialAllocations[materialId].totalQty += qty;
                materialAllocations[materialId].totalCost += cost;

                // Calculate total material cost
                const totalMaterialCost = Object.values(materialAllocations).reduce((sum, a) => sum + a.totalCost, 0);

                // Save to Firestore
                await db.collection("tasks").doc(task.docId).update({
                    materialAllocations: materialAllocations,
                    materialCost: totalMaterialCost
                });

                closeMaterialAllocModal();
                updateMaterialSelect();
            }
        }

        async function assignLabor() {
            const laborId = laborSelect.value;
            const hours = parseFloat(laborHoursInput.value);

            if (!laborId || !hours || hours <= 0) {
                alert('Please select worker and enter hours');
                return;
            }

            const worker = labor.find(l => l.docId === laborId);
            if (!worker) return;
            
            // Update labor hours
            await updateLaborHours(laborId, hours, true);
            
            const cost = hours * (worker.hourlyRate || 0);
            const now = new Date();
            const dateStr = now.toISOString();

            const task = tasks.find(t => t.id === currentAssigningTaskId);
            if (task) {
                // Get existing allocations or create new
                const laborAllocations = task.laborAllocations || {};
                
                if (!laborAllocations[laborId]) {
                    laborAllocations[laborId] = { 
                        worker, 
                        entries: [],
                        totalHours: 0,
                        totalCost: 0
                    };
                }

                // Add new entry
                laborAllocations[laborId].entries.push({
                    date: dateStr,
                    hours: hours,
                    cost: cost,
                    hourlyRate: worker.hourlyRate || 0
                });

                // Update totals
                laborAllocations[laborId].totalHours += hours;
                laborAllocations[laborId].totalCost += cost;

                // Calculate total labor cost
                const totalLaborCost = Object.values(laborAllocations).reduce((sum, a) => sum + a.totalCost, 0);

                // Save to Firestore
                await db.collection("tasks").doc(task.docId).update({
                    laborAllocations: laborAllocations,
                    manCost: totalLaborCost
                });

                closeLaborAllocModal();
                updateLaborSelect();
            }
        }

        // ========== EDITABLE CELL FUNCTIONS ==========
        function makeEditable(cell, taskId, field) {
            if (cell.querySelector('input')) return;
            
            const currentValue = cell.textContent.trim();
            const input = document.createElement('input');
            
            if (field === 'budget') {
                input.type = 'number';
                input.value = parseFloat(currentValue) || 0;
                input.step = '100';
                input.min = '0';
            } else {
                input.type = 'text';
                input.value = field === 'name' ? currentValue.replace(/^\d+\s/, '') : currentValue;
            }
            
            input.style.width = '100%';
            input.style.padding = '4px';
            input.style.border = '2px solid #2b4a73';
            input.style.borderRadius = '4px';
            input.style.backgroundColor = 'white';
            input.style.fontSize = '0.72rem';
            
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();
            input.select();
            
            input.addEventListener('blur', async () => {
                const newValue = input.value.trim();
                const task = tasks.find(t => t.id === taskId);
                
                if (task) {
                    if (field === 'name') {
                        task.name = newValue || 'Unnamed';
                    } else if (field === 'budget') {
                        task.budget = parseFloat(newValue) || 0;
                    } else if (field === 'duration') {
                        task.duration = newValue || '‚Äî';
                    }
                    
                    const updateData = {};
                    if (field === 'name') updateData.name = task.name;
                    else if (field === 'budget') updateData.budget = task.budget;
                    else if (field === 'duration') updateData.duration = task.duration;
                    
                    await db.collection("tasks").doc(task.docId).update(updateData);
                }
                
                renderGantt();
            });
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            });
        }

        // ========== CHECK BUDGET EXCEEDED ==========
        function isBudgetExceeded(task) {
            const budget = task.budget || 0;
            const totalCost = (task.manCost || 0) + (task.materialCost || 0);
            return budget > 0 && totalCost > budget;
        }

        // ========== HELPER FUNCTIONS ==========
        function getNextMainNumber() {
            const mains = tasks.filter(t => t.main).map(t => parseInt(t.num)).filter(n => !isNaN(n));
            const maxMain = mains.length ? Math.max(...mains) : 0;
            return (maxMain + 1).toString();
        }

        function getNextSubNumber(parentId) {
            const parent = tasks.find(t => t.id === parentId);
            if (!parent) return '1';
            const subs = tasks.filter(t => t.parentId === parentId).map(t => {
                const parts = t.num.split('.');
                return parts.length > 1 ? parseInt(parts[1]) : 0;
            }).filter(n => !isNaN(n));
            const maxSub = subs.length ? Math.max(...subs) : 0;
            return `${parent.num}.${maxSub + 1}`;
        }

        function formatShort(dateStr) {
            if (!dateStr) return '‚Äî';
            const d = new Date(dateStr + 'T12:00:00');
            return d.toLocaleDateString('en-US', { month:'short', day:'numeric' });
        }

        function getDisplayOrder() {
            const ordered = [];
            tasks.filter(t => t.main).sort((a,b) => a.num.localeCompare(b.num)).forEach(main => {
                ordered.push(main);
                const subs = tasks.filter(t => t.parentId === main.id).sort((a,b) => a.num.localeCompare(b.num));
                ordered.push(...subs);
            });
            return ordered;
        }

        // ========== FLATPICKR INIT ==========
        const fp = flatpickr(hiddenPicker, {
            dateFormat: "Y-m-d",
            onChange: async function(selectedDates, dateStr) {
                if (activeTaskId && activeDateType) {
                    const task = tasks.find(t => t.id === activeTaskId);
                    if (task) {
                        if (activeDateType === 'start') {
                            task.start = dateStr;
                            if (!task.end) task.end = dateStr;
                        } else {
                            task.end = dateStr;
                            if (!task.start) task.start = dateStr;
                        }
                        await db.collection("tasks").doc(task.docId).update({
                            start: task.start,
                            end: task.end
                        });
                    }
                }
                activeTaskId = null;
                activeDateType = null;
            }
        });

        // ========== RENDER FROM TASKS ARRAY ==========
        function renderGantt() {
            const baseYear = 2026;
            renderLeftHeaders();
            const months = renderRightHeaders(baseYear);
            const orderedTasks = getDisplayOrder();

            bodyLeft.innerHTML = '';
            bodyRight.innerHTML = '';

            orderedTasks.forEach(t => {
                const isMain = t.main;
                const rowClass = isMain ? 'task-main' : 'task-sub';
                const budgetExceeded = isBudgetExceeded(t);
                const rowBudgetClass = budgetExceeded ? 'budget-exceeded' : '';

                const statusSpan = `<span class="status-badge">${t.status}</span>`;

                const leftRow = document.createElement('tr');
                leftRow.className = `${rowClass} ${rowBudgetClass}`;
                leftRow.setAttribute('data-id', t.id);
                
                leftRow.innerHTML = `
                    <td class="editable-cell" data-field="name" data-id="${t.id}"><span class="task-num">${t.num}</span> ${t.name}</td>
                    <td class="start-cell" data-id="${t.id}" data-type="start">${formatShort(t.start)}</td>
                    <td class="end-cell" data-id="${t.id}" data-type="end">${formatShort(t.end)}</td>
                    <td class="editable-cell" data-field="budget" data-id="${t.id}">${t.budget || 0}</td>
                    <td class="cost-cell" onclick="openLaborAssign(${t.id})" title="Click to assign workers">${(t.manCost || 0).toFixed(2)}</td>
                    <td class="cost-cell" onclick="openMaterialAssign(${t.id})" title="Click to assign materials">${(t.materialCost || 0).toFixed(2)}</td>
                    <td class="status-cell" data-id="${t.id}">${statusSpan}</td>
                    <td class="editable-cell" data-field="duration" data-id="${t.id}">${t.duration || '‚Äî'}</td>
                    <td>${t.pred}</td>
                `;
                bodyLeft.appendChild(leftRow);

                // Add double-click listeners for editable cells
                leftRow.querySelectorAll('.editable-cell').forEach(cell => {
                    const field = cell.dataset.field;
                    const taskId = parseInt(cell.dataset.id);
                    cell.addEventListener('dblclick', (e) => {
                        e.stopPropagation();
                        makeEditable(cell, taskId, field);
                    });
                });

                // Right row with bars
                const rightRow = document.createElement('tr');
                rightRow.setAttribute('data-id', t.id);
                rightRow.className = rowClass;
                let rightCells = '';
                
                const startDate = t.start ? new Date(t.start + 'T12:00:00') : null;
                const endDate = t.end ? new Date(t.end + 'T12:00:00') : null;
                
                const currentDate = new Date(baseYear, 0, 1, 12, 0, 0);
                
                for (let m = 0; m < months.length; m++) {
                    if (!showCurrentMonthOnly || (m === new Date().getMonth() && baseYear === new Date().getFullYear())) {
                        for (let d = 1; d <= months[m].days; d++) {
                            const cellDate = new Date(currentDate);
                            
                            let barHtml = '';
                            if (startDate && endDate && cellDate >= startDate && cellDate <= endDate) {
                                barHtml = `<div class="gantt-bar"></div>`;
                            }
                            
                            rightCells += `<td style="border:none;">${barHtml}</td>`;
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }
                }
                rightRow.innerHTML = rightCells;
                bodyRight.appendChild(rightRow);
            });

            // blank rows
            for (let b = 0; b < BLANK_ROWS; b++) {
                const leftBlank = document.createElement('tr');
                leftBlank.className = 'blank-row';
                leftBlank.innerHTML = '<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>';
                bodyLeft.appendChild(leftBlank);

                let blankCells = '';
                const currentDate = new Date(baseYear, 0, 1, 12, 0, 0);
                for (let m = 0; m < months.length; m++) {
                    if (!showCurrentMonthOnly || (m === new Date().getMonth() && baseYear === new Date().getFullYear())) {
                        for (let d = 1; d <= months[m].days; d++) {
                            blankCells += `<td style="border:none;"></td>`;
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }
                }
                const rightBlank = document.createElement('tr');
                rightBlank.className = 'blank-row';
                rightBlank.innerHTML = blankCells;
                bodyRight.appendChild(rightBlank);
            }

            const allRightRows = bodyRight.querySelectorAll('tr');
            allRightRows.forEach(row => {
                const cells = Array.from(row.cells);
                applyWeekBordersToRow(cells, baseYear, months);
            });

            // Click handlers for date cells
            document.querySelectorAll('.start-cell, .end-cell').forEach(cell => {
                cell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const taskId = parseInt(cell.dataset.id);
                    const type = cell.dataset.type;
                    const task = tasks.find(t => t.id === taskId);
                    if (!task) return;

                    activeTaskId = taskId;
                    activeDateType = type;

                    const currentDate = type === 'start' ? task.start : task.end;
                    if (currentDate) {
                        fp.setDate(currentDate, false);
                    } else {
                        fp.setDate(new Date(), false);
                    }
                    fp.open();
                });
            });

            // Right-click status change
            document.querySelectorAll('#ganttBodyLeft tr:not(.blank-row) .status-cell').forEach(cell => {
                cell.addEventListener('contextmenu', async (e) => {
                    e.preventDefault();
                    const id = cell.dataset.id;
                    const task = tasks.find(t => t.id == id);
                    if (task) {
                        const cycle = { 'PENDING':'ONGOING', 'ONGOING':'COMPLETED', 'COMPLETED':'PENDING' };
                        task.status = cycle[task.status] || 'PENDING';
                        await db.collection("tasks").doc(task.docId).update({
                            status: task.status
                        });
                    }
                });
            });
        }

        function renderLeftHeaders() {
            headLeft.innerHTML = `
                <tr><th class="task-management-header" colspan="9">üìã Task Management</th></tr>
                <tr>
                    <th style="min-width:180px">TASK</th>
                    <th style="min-width:60px">START</th>
                    <th style="min-width:60px">END</th>
                    <th style="min-width:70px">BUDGET</th>
                    <th style="min-width:80px">MAN COST</th>
                    <th style="min-width:100px">MATERIAL COST</th>
                    <th style="min-width:75px">STATUS</th>
                    <th style="min-width:50px">DUR</th>
                    <th style="min-width:65px">PRED</th>
                </tr>
            `;
        }

        function renderRightHeaders(baseYear) {
            const months = [
                {name:"Jan", days:31},{name:"Feb", days:28},{name:"Mar", days:31},{name:"Apr", days:30},
                {name:"May", days:31},{name:"Jun", days:30},{name:"Jul", days:31},{name:"Aug", days:31},
                {name:"Sep", days:30},{name:"Oct", days:31},{name:"Nov", days:30},{name:"Dec", days:31}
            ];
            if ((baseYear % 4 === 0 && baseYear % 100 !== 0) || baseYear % 400 === 0) months[1].days = 29;

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            let row1 = '<tr>';
            for (let m = 0; m < months.length; m++) {
                if (!showCurrentMonthOnly || (m === currentMonth && baseYear === currentYear)) {
                    row1 += `<th colspan="${months[m].days}" style="background:#eef4fd; border:none;">${months[m].name}</th>`;
                }
            }
            row1 += '</tr>';

            let row2 = '<tr>';
            for (let m = 0; m < months.length; m++) {
                if (!showCurrentMonthOnly || (m === currentMonth && baseYear === currentYear)) {
                    for (let d = 1; d <= months[m].days; d++) {
                        const dt = new Date(baseYear, m, d);
                        const wd = ["S","M","T","W","T","F","S"][dt.getDay()];
                        const isToday = (dt.getDate() === today.getDate() && dt.getMonth() === today.getMonth() && dt.getFullYear() === today.getFullYear());
                        row2 += `<th style="border:none; background:#eef4fd;" class="${isToday ? 'today-highlight' : ''}">${wd}</th>`;
                    }
                }
            }
            row2 += '</tr>';

            let row3 = '<tr>';
            for (let m = 0; m < months.length; m++) {
                if (!showCurrentMonthOnly || (m === currentMonth && baseYear === currentYear)) {
                    for (let d = 1; d <= months[m].days; d++) {
                        const dt = new Date(baseYear, m, d);
                        const isToday = (dt.getDate() === today.getDate() && dt.getMonth() === today.getMonth() && dt.getFullYear() === today.getFullYear());
                        row3 += `<th style="border:none; background:#eef4fd;" class="${isToday ? 'today-highlight' : ''}">${d}</th>`;
                    }
                }
            }
            row3 += '</tr>';

            headRight.innerHTML = row1 + row2 + row3;
            return months;
        }

        function applyWeekBordersToRow(cells, baseYear, months) {
            let dayIdx = 0;
            for (let m = 0; m < months.length; m++) {
                if (showCurrentMonthOnly && !(m === new Date().getMonth() && baseYear === new Date().getFullYear())) continue;
                for (let d = 1; d <= months[m].days; d++) {
                    if (cells[dayIdx]) {
                        const dt = new Date(baseYear, m, d);
                        const dow = dt.getDay();
                        cells[dayIdx].classList.remove('week-start', 'week-end');
                        if (dow === 1) cells[dayIdx].classList.add('week-start');
                        if (dow === 0) cells[dayIdx].classList.add('week-end');
                    }
                    dayIdx++;
                }
            }
        }

        // ========== FORM FUNCTIONS ==========
        function populatePredMulti() {
            const allTasks = tasks.map(t => `<option value="${t.id}">${t.num} ¬∑ ${t.name}</option>`).join('');
            predMultiSelect.innerHTML = allTasks;
        }

        taskTypeSelect.addEventListener('change', () => {
            if (taskTypeSelect.value === 'sub') {
                parentSelectorDiv.style.display = 'block';
                populateParentDropdown();
            } else {
                parentSelectorDiv.style.display = 'none';
            }
        });

        function populateParentDropdown() {
            const mainTasks = tasks.filter(t => t.main);
            parentTaskSelect.innerHTML = mainTasks.map(t => `<option value="${t.id}">${t.num} ¬∑ ${t.name}</option>`).join('');
        }

        function openAddForm() {
            formTitle.innerText = '‚ûï add task';
            taskNameInput.value = 'New task';
            durationInput.value = '10d';
            budgetInput.value = '0';
            populatePredMulti();
            Array.from(predMultiSelect.options).forEach(opt => opt.selected = false);
            taskTypeSelect.value = 'main';
            parentSelectorDiv.style.display = 'none';
            overlay.style.display = 'flex';
        }

        function closeForm() {
            overlay.style.display = 'none';
        }

        addBtn.addEventListener('click', openAddForm);
        closeFormBtn.addEventListener('click', closeForm);
        cancelBtn.addEventListener('click', closeForm);

        // ========== SAVE NEW TASK TO FIRESTORE ==========
        saveBtn.addEventListener('click', async () => {
            const name = taskNameInput.value.trim() || 'Unnamed';
            const duration = durationInput.value || '‚Äî';
            const budget = parseFloat(budgetInput.value) || 0;
            
            const selectedPreds = Array.from(predMultiSelect.selectedOptions).map(opt => opt.value);
            let predString = selectedPreds.length ? selectedPreds.map(id => {
                const t = tasks.find(tsk => tsk.id == id);
                return t ? t.num : '';
            }).filter(v => v).join(', ') : '‚Äî';
            
            const type = taskTypeSelect.value;

            let parentId = null;
            let mainFlag = true;
            let newNum = '';

            if (type === 'main') {
                mainFlag = true;
                parentId = null;
                newNum = getNextMainNumber();
            } else {
                mainFlag = false;
                parentId = parseInt(parentTaskSelect.value);
                if (!parentId) {
                    alert('Please select a parent main task');
                    return;
                }
                newNum = getNextSubNumber(parentId);
            }

            const newId = Date.now() + Math.floor(Math.random()*1000);

            const newTask = {
                id: newId,
                num: newNum,
                name: name,
                main: mainFlag,
                parentId: parentId,
                start: null,
                end: null,
                budget: budget,
                manCost: 0,
                materialCost: 0,
                status: 'PENDING',
                duration: duration,
                pred: predString,
                projectId: projectId,
                materialAllocations: {},
                laborAllocations: {}
            };

            await db.collection("tasks").add(newTask);
            closeForm();
        });

        // ========== REAL-TIME FIRESTORE LISTENER ==========
        if (projectId) {
            db.collection("tasks")
                .where("projectId", "==", projectId)
                .onSnapshot((snapshot) => {
                    tasks = snapshot.docs.map(doc => ({
                        docId: doc.id,
                        ...doc.data()
                    }));
                    renderGantt();
                });
        }

        // ========== MONTH TOGGLE ==========
        monthBtn.addEventListener('click', () => {
            showCurrentMonthOnly = !showCurrentMonthOnly;
            monthBtn.textContent = showCurrentMonthOnly ? 'All Months' : 'Current Month';
            renderGantt();
        });

        // ========== INITIALIZE ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadProjectName();
            loadResources();
        });
    </script>
</body>
</html>
