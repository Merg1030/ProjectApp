<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>IMS | Material Usage History</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; width: 100%; }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: white;
    }

    .panel {
      height: 100vh; width: 100vw;
      display: flex; flex-direction: column;
      overflow: hidden; background: white;
    }

    .panel-heading {
      background: #0a1c2f; color: white;
      padding: 12px 20px; font-size: 1.1rem; font-weight: 600;
      display: flex; align-items: center; gap: 12px;
      flex-shrink: 0; min-height: 48px;
    }

    .back-link {
      color: white; text-decoration: none;
      padding: 0.4rem 0.8rem;
      border: 1px solid rgba(255,255,255,0.3); border-radius: 30px;
      font-size: 0.8rem; font-weight: 600;
      display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s;
    }
    .back-link:hover { background: rgba(255,255,255,0.1); border-color: white; }

    /* ‚îÄ‚îÄ SUMMARY STRIP ‚îÄ‚îÄ */
    .summary-strip {
      display: flex; gap: 10px; padding: 8px 20px;
      background: #f2f6fc; border-bottom: 1px solid #b3c7e0;
      flex-shrink: 0; flex-wrap: wrap; align-items: center;
    }
    .stat-pill {
      background: white; border: 1px solid #b3c7e0; border-radius: 30px;
      padding: 4px 14px; font-size: 0.72rem; font-weight: 600; color: #0a1c2f;
      white-space: nowrap;
    }
    .stat-pill span { color: #059669; font-weight: 700; }
    .stat-pill.mat span  { color: #2b6cb0; }
    .stat-pill.count span { color: #c05621; }

    /* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
    .filter-bar {
      display: flex; flex-wrap: wrap; align-items: center;
      justify-content: space-between; gap: 10px;
      background: #f2f6fc; border-bottom: 1px solid #b3c7e0;
      padding: 10px 20px; flex-shrink: 0;
    }
    .filter-group { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

    .filter-label {
      font-weight: 600; color: #1f3d62; font-size: 0.72rem;
    }

    .filter-select, .filter-input {
      padding: 0.38rem 0.8rem; font-size: 0.72rem; border-radius: 30px;
      border: 1px solid #b3c7e0; background: white; color: #0a1c2f; font-weight: 500;
    }
    .filter-select:focus, .filter-input:focus {
      outline: none; border-color: #2b4a73;
      box-shadow: 0 0 0 2px rgba(43,74,115,0.1);
    }

    .search-bar {
      padding: 0.38rem 0.8rem; font-size: 0.72rem; border-radius: 30px;
      border: 1px solid #b3c7e0; background: white; color: #0a1c2f; min-width: 200px;
    }
    .search-bar::placeholder { color: #7f96b3; }

    /* ‚îÄ‚îÄ ACTIONS BUTTON ‚îÄ‚îÄ */
    .actions-container {
      position: relative;
      display: inline-block;
    }
    
    .actions-btn {
      padding: 0.38rem 1.2rem;
      font-size: 0.72rem;
      border-radius: 30px;
      border: 1px solid #0a1c2f;
      background: #0a1c2f;
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: 0.15s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .actions-btn:hover {
      background: #1f3d62;
      border-color: #1f3d62;
    }
    
    .actions-dropdown {
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 5px;
      background: white;
      border: 2px solid #0a1c2f;
      border-radius: 10px;
      min-width: 260px;
      z-index: 1000;
      display: none;
      box-shadow: 0 8px 20px rgba(0,20,40,0.25);
      padding: 15px;
    }
    .actions-dropdown.show {
      display: block;
    }
    
    .actions-section {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e0e8f5;
    }
    .actions-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .actions-section-title {
      font-size: 0.75rem;
      font-weight: 700;
      color: #1f3d62;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .date-input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .date-input {
      padding: 0.6rem;
      font-size: 0.75rem;
      border: 1px solid #b3c7e0;
      border-radius: 8px;
      background: white;
      color: #0a1c2f;
      width: 100%;
    }
    .date-input:focus {
      outline: none;
      border-color: #2b4a73;
      box-shadow: 0 0 0 2px rgba(43,74,115,0.1);
    }
    
    .week-select {
      width: 100%;
      padding: 0.6rem;
      font-size: 0.75rem;
      border: 1px solid #b3c7e0;
      border-radius: 8px;
      background: white;
      color: #0a1c2f;
      cursor: pointer;
    }
    .week-select:focus {
      outline: none;
      border-color: #2b4a73;
      box-shadow: 0 0 0 2px rgba(43,74,115,0.1);
    }
    
    .filter-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .filter-action-btn {
      flex: 1;
      padding: 0.6rem;
      font-size: 0.75rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: 0.15s;
    }
    .apply-filters {
      background: #059669;
      color: white;
    }
    .apply-filters:hover {
      background: #047857;
    }
    .clear-filters {
      background: white;
      border: 1px solid #b3c7e0 !important;
      color: #0a1c2f;
    }
    .clear-filters:hover {
      background: #e6efff;
    }
    
    .active-filter-badge {
      display: inline-block;
      background: #059669;
      color: white;
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: 20px;
      margin-left: 5px;
    }

    .show-reversed-btn {
      padding: 0.38rem 1rem; font-size: 0.72rem; border-radius: 30px;
      border: 1px solid #b3c7e0; background: white; color: #0a1c2f;
      cursor: pointer; font-weight: 600; transition: 0.15s; white-space: nowrap;
    }
    .show-reversed-btn.active { background: #0a1c2f; color: white; border-color: #0a1c2f; }
    .show-reversed-btn:hover:not(.active) { background: #e6efff; }

    /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
    .table-responsive {
      flex: 1; overflow: auto; background: white; position: relative;
      scrollbar-width: thin; scrollbar-color: #97adc9 #ecf2fa;
    }
    .table-responsive::-webkit-scrollbar { width: 10px; height: 10px; }
    .table-responsive::-webkit-scrollbar-track { background: #ecf2fa; }
    .table-responsive::-webkit-scrollbar-thumb { background: #97adc9; border-radius: 8px; }

    table {
      width: 100%; border-collapse: collapse; background: white;
      min-width: 1100px; color: #0a1c2f;
    }

    th, td { padding: 10px 12px; font-size: 0.72rem; text-align: left; border: 1px solid #c7d6ec; }

    th {
      font-weight: 700; background: #d4e2f2; color: #0a1c2f;
      position: sticky; top: 0; z-index: 20; border-bottom: 2px solid #1f3d62;
      white-space: nowrap;
    }

    tr:hover td { background: #e3ecf7; }
    tr.reversed-row td { opacity: 0.45; text-decoration: line-through; background: #fafafa; }
    tr.reversed-row td:last-child { opacity: 1; text-decoration: none; }
    tr.reversed-row:hover td { background: #f5f5f5; }

    .task-id-badge {
      background: #e6efff; color: #0a1c2f;
      padding: 2px 8px; border-radius: 20px;
      font-weight: 600; font-size: 0.68rem; display: inline-block;
    }

    .amount-cell { font-weight: 700; color: #059669; }

    /* ‚îÄ‚îÄ MENU ‚îÄ‚îÄ */
    .menu-container { position: relative; display: inline-block; }
    .menu-trigger {
      cursor: pointer; padding: 4px 8px; border: none;
      background: transparent; font-size: 15px; font-weight: bold;
      color: #2b4a73; border-radius: 4px; transition: all 0.2s;
    }
    .menu-trigger:hover { background: #e6efff; }
    .menu-dropdown {
      position: absolute; right: 0; top: 100%; background: white;
      border: 2px solid #1f3d62; border-radius: 6px; min-width: 120px;
      z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,20,40,0.2);
    }
    .menu-dropdown.show { display: block; }
    .menu-item {
      padding: 8px 12px; cursor: pointer; font-size: 0.72rem;
      border-bottom: 1px solid #e0e8f5;
      display: flex; align-items: center; gap: 6px;
      color: #0a1c2f; font-weight: 500; transition: all 0.2s;
    }
    .menu-item:last-child { border-bottom: none; }
    .menu-item:hover { background: #e6efff; }
    .menu-item.danger { color: #cc0000; }
    .menu-item.danger:hover { background: #ffe5e5; }
    .menu-item.disabled { opacity: 0.45; cursor: not-allowed; }
    .menu-item.disabled:hover { background: transparent; }

    /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
    .modal {
      display: none; position: fixed; z-index: 2000;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.45);
      align-items: center; justify-content: center;
    }
    .modal.active { display: flex; }

    .modal-content {
      background: white; border-radius: 14px;
      min-width: 440px; max-width: 96vw; max-height: 90vh;
      box-shadow: 0 24px 60px rgba(0,20,40,0.4);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .modal-header {
      background: #0a1c2f; color: white; padding: 1rem 1.4rem;
      display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
    }
    .modal-header h3 { font-size: 0.95rem; font-weight: 600; margin: 0; }
    .modal-close {
      background: none; border: none; font-size: 1.2rem;
      color: #97adc9; cursor: pointer; transition: color 0.15s;
    }
    .modal-close:hover { color: white; }

    .modal-body { flex: 1; overflow-y: auto; padding: 1.4rem; }
    .modal-body::-webkit-scrollbar { width: 6px; }
    .modal-body::-webkit-scrollbar-thumb { background: #97adc9; border-radius: 4px; }

    /* Detail section in modal */
    .detail-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
      background: #f4f8fd; border: 1px solid #d0dff0;
      border-radius: 8px; padding: 12px; margin-bottom: 16px;
      font-size: 0.75rem;
    }
    .detail-grid .dg-label { color: #7f96b3; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 2px; }
    .detail-grid .dg-value { font-weight: 600; color: #0a1c2f; }

    .form-group { margin-bottom: 14px; }
    .form-group label {
      font-size: 0.72rem; font-weight: 600; color: #1f3d62;
      display: block; margin-bottom: 5px;
    }
    .form-group input[type="datetime-local"] {
      width: 100%; padding: 8px; border: 1px solid #b3c7e0;
      border-radius: 6px; font-size: 0.78rem; color: #0a1c2f; background: white;
    }
    .form-group input[type="datetime-local"]:focus {
      outline: none; border-color: #2b4a73;
      box-shadow: 0 0 0 2px rgba(43,74,115,0.1);
    }

    #edit-modal-error {
      color: #cc0000; font-size: 0.72rem; margin-bottom: 10px;
      padding: 8px; background: #ffe5e5; border-left: 3px solid #cc0000;
      border-radius: 4px; display: none;
    }
    #edit-modal-error.show { display: block; }

    .modal-actions {
      display: flex; align-items: center; gap: 8px;
      padding: 12px 1.4rem; border-top: 1px solid #e0e8f5; flex-shrink: 0;
    }
    .modal-actions button {
      padding: 0.6rem 1rem; font-size: 0.72rem; border-radius: 8px;
      border: none; cursor: pointer; font-weight: 600; transition: all 0.2s;
    }
    .btn-cancel  { background: white; border: 1px solid #b3c7e0 !important; color: #0a1c2f; }
    .btn-cancel:hover  { background: #e6efff; }
    .btn-save    { background: #059669; color: white; }
    .btn-save:hover    { background: #047857; }
    .btn-reverse { background: #cc0000; color: white; margin-right: auto; }
    .btn-reverse:hover:not(:disabled) { background: #a60000; }
    .btn-reverse:disabled { background: #e0e8f5; color: #97adc9; cursor: not-allowed; }

    .empty-state {
      text-align: center; padding: 60px; color: #7f96b3; font-size: 0.85rem;
    }
    .empty-state i { font-size: 2.5rem; display: block; margin-bottom: 10px; }

    .loading-row td { text-align: center; color: #2b4a73; padding: 40px; font-style: italic; }
  </style>
</head>
<body>
<div class="panel">

  <!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
  <div class="panel-heading">
    <a href="javascript:history.back()" class="back-link">
      <i class="fas fa-arrow-left"></i> Back
    </a>
    <span style="flex:1">üì¶ Material Usage / Assignment History</span>
    <span id="liveIndicator" style="font-size:0.65rem; opacity:0.6; display:flex; align-items:center; gap:4px;">
      <i class="fas fa-circle" style="color:#4ade80; font-size:0.55rem"></i> Live
    </span>
  </div>

  <!-- ‚îÄ‚îÄ SUMMARY ‚îÄ‚îÄ -->
  <div class="summary-strip">
    <div class="stat-pill mat">üì¶ Total Material Cost: <span id="statMatCost">‚Äî</span></div>
    <div class="stat-pill count">üìã Records: <span id="statCount">‚Äî</span></div>
    <div class="stat-pill">üîÅ Reversed: <span id="statReversed">‚Äî</span></div>
    <div class="stat-pill">üì¶ Materials Used: <span id="statMaterials">‚Äî</span></div>
  </div>

  <!-- ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ -->
  <div class="filter-bar">
    <div class="filter-group">
      <span class="filter-label">Material:</span>
      <select id="materialFilter" class="filter-select">
        <option value="">All</option>
      </select>

      <span class="filter-label">Project:</span>
      <select id="projectFilter" class="filter-select">
        <option value="">All</option>
      </select>

      <span class="filter-label">Task ID:</span>
      <input id="taskIdFilter" class="filter-input" style="width:110px" placeholder="e.g. PRJ-1">

      <input id="searchBar" class="search-bar" type="text" placeholder="Search anything..." autocomplete="off">

      <button class="show-reversed-btn" id="toggleReversedBtn">
        <i class="fas fa-eye"></i> Show Reversed
      </button>
      
      <!-- ‚îÄ‚îÄ ACTIONS BUTTON WITH DROPDOWN ‚îÄ‚îÄ -->
      <div class="actions-container">
        <button class="actions-btn" onclick="toggleActionsDropdown()">
          <i class="fas fa-sliders-h"></i> Actions
          <span id="activeFilterBadge" class="active-filter-badge" style="display: none;">!</span>
        </button>
        <div class="actions-dropdown" id="actionsDropdown">
          <div class="actions-section">
            <div class="actions-section-title">
              <i class="fas fa-calendar-day"></i> Filter by Day
            </div>
            <div class="date-input-group">
              <input type="date" id="dayFilter" class="date-input" placeholder="Select date">
            </div>
          </div>
          
          <div class="actions-section">
            <div class="actions-section-title">
              <i class="fas fa-calendar-week"></i> Filter by Week
            </div>
            <select id="weekFilter" class="week-select">
              <option value="">All Weeks</option>
              <option value="1">Week 1</option>
              <option value="2">Week 2</option>
              <option value="3">Week 3</option>
              <option value="4">Week 4</option>
              <option value="5">Week 5</option>
            </select>
          </div>
          
          <div class="filter-actions">
            <button class="filter-action-btn apply-filters" onclick="applyAdvancedFilters()">
              <i class="fas fa-check"></i> Apply
            </button>
            <button class="filter-action-btn clear-filters" onclick="clearAdvancedFilters()">
              <i class="fas fa-times"></i> Clear
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ -->
  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Task ID</th>
          <th>Description</th>
          <th>Material</th>
          <th>Quantity</th>
          <th>Unit Price</th>
          <th>Amount</th>
          <th>Location</th>
          <th>Assigned At</th>
          <th style="min-width:60px; text-align:center">Actions</th>
        </tr>
      </thead>
      <tbody id="usageTableBody">
        <tr class="loading-row"><td colspan="10"><i class="fas fa-circle-notch fa-spin"></i> Loading records...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ‚îÄ‚îÄ EDIT / REVERSE MODAL ‚îÄ‚îÄ -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">üì¶ Material Assignment</h3>
      <button class="modal-close" onclick="hideModal()">√ó</button>
    </div>
    <div class="modal-body">
      <!-- Detail view -->
      <div class="detail-grid" id="modalDetailGrid"></div>
      <!-- Error -->
      <div id="edit-modal-error"></div>
      <!-- Edit date form -->
      <form id="editForm">
        <div class="form-group">
          <label for="editAssignedAt">Edit Assigned Date / Time:</label>
          <input type="datetime-local" id="editAssignedAt" required>
        </div>
      </form>
    </div>
    <div class="modal-actions">
      <button class="btn-reverse" id="btnReverse" onclick="doReverse()">
        <i class="fas fa-undo"></i> Reverse
      </button>
      <button class="btn-cancel" onclick="hideModal()">Cancel</button>
      <button class="btn-save" onclick="saveDate()">
        <i class="fas fa-save"></i> Save Date
      </button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import {
    getFirestore,
    collection, query, orderBy, where,
    onSnapshot, getDoc, getDocs, doc,
    updateDoc, runTransaction, Timestamp,
    limit, startAfter
} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

/* ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ */
const firebaseConfig = {
    apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
    authDomain: "project-task-588c4.firebaseapp.com",
    projectId: "project-task-588c4",
    storageBucket: "project-task-588c4.appspot.com",
    messagingSenderId: "411882772509",
    appId: "1:411882772509:web:08d613186c101a99f38ef4"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
let allUsages       = [];      // raw records from Firestore
let taskCache       = {};      // taskDocId ‚Üí { taskId, taskDescription, location }
let projectCache    = {};      // projectId ‚Üí name
let showReversed    = false;
let taskTreeReady   = false;   // flag to indicate task tree is loaded

// Advanced filter state
let selectedDay = '';
let selectedWeek = '';

/* DOM */
const tbody             = document.getElementById('usageTableBody');
const materialFilter    = document.getElementById('materialFilter');
const projectFilter     = document.getElementById('projectFilter');
const taskIdFilterEl    = document.getElementById('taskIdFilter');
const searchBarEl       = document.getElementById('searchBar');
const toggleRevBtn      = document.getElementById('toggleReversedBtn');
const dayFilterEl       = document.getElementById('dayFilter');
const weekFilterEl      = document.getElementById('weekFilter');
const activeFilterBadge = document.getElementById('activeFilterBadge');
const editModal         = document.getElementById('editModal');
const editAssignedAt    = document.getElementById('editAssignedAt');
const editError         = document.getElementById('edit-modal-error');
const btnReverse        = document.getElementById('btnReverse');
const modalDetailGrid   = document.getElementById('modalDetailGrid');

let currentDocId = null;
let currentRecord = null;

// Load saved filter state from localStorage
function loadFilterState() {
    const savedState = localStorage.getItem('materialUsageFilters');
    if (savedState) {
        try {
            const state = JSON.parse(savedState);
            materialFilter.value = state.material || '';
            projectFilter.value = state.project || '';
            taskIdFilterEl.value = state.taskId || '';
            searchBarEl.value = state.search || '';
            showReversed = state.showReversed || false;
            dayFilterEl.value = state.day || '';
            weekFilterEl.value = state.week || '';
            selectedDay = state.day || '';
            selectedWeek = state.week || '';
            
            toggleRevBtn.classList.toggle('active', showReversed);
            toggleRevBtn.innerHTML = showReversed
                ? '<i class="fas fa-eye-slash"></i> Hide Reversed'
                : '<i class="fas fa-eye"></i> Show Reversed';
        } catch (e) {
            console.warn('Failed to load filter state:', e);
        }
    }
}

// Save filter state to localStorage
function saveFilterState() {
    const state = {
        material: materialFilter.value,
        project: projectFilter.value,
        taskId: taskIdFilterEl.value,
        search: searchBarEl.value,
        showReversed: showReversed,
        day: dayFilterEl.value,
        week: weekFilterEl.value
    };
    localStorage.setItem('materialUsageFilters', JSON.stringify(state));
    
    // Update active filter badge
    const hasActiveFilters = Object.values(state).some(v => v && v !== '');
    activeFilterBadge.style.display = hasActiveFilters ? 'inline-block' : 'none';
}

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
const fmt = (n) => (+n||0).toFixed(2);
const fmtNum = (n) => new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}).format(+n||0);

function fmtDate(val) {
    if (!val) return '‚Äî';
    let d = val?.toDate ? val.toDate() : val?.seconds ? new Date(val.seconds*1000) : new Date(val);
    return isNaN(d) ? '‚Äî' : d.toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'});
}
function toInputDate(val) {
    if (!val) return '';
    let d = val?.toDate ? val.toDate() : val?.seconds ? new Date(val.seconds*1000) : new Date(val);
    if (isNaN(d)) return '';
    return d.toISOString().slice(0,16);
}

// Get week number of month (1-5)
function getWeekOfMonth(date) {
    if (!date) return null;
    const d = date?.toDate ? date.toDate() : date?.seconds ? new Date(date.seconds*1000) : new Date(date);
    if (isNaN(d)) return null;
    
    const firstDay = new Date(d.getFullYear(), d.getMonth(), 1);
    const firstDayWeek = firstDay.getDay(); // 0 = Sunday
    const dayOfMonth = d.getDate();
    
    return Math.ceil((dayOfMonth + firstDayWeek) / 7);
}

/* ‚îÄ‚îÄ OPTIMIZED TASK TREE LOADER ‚îÄ‚îÄ */
async function loadTaskTree() {
    if (taskTreeReady) return;
    taskTreeReady = true;

    try {
        const mainSnap = await getDocs(collection(db, "projectTasks"));
        
        // Parallel processing: collect all sub/subsub fetches
        const allFetches = [];

        for (const mainDoc of mainSnap.docs) {
            const md = mainDoc.data();
            taskCache[mainDoc.id] = {
                taskId:          md.taskId          || '',
                taskDescription: md.taskDescription || '',
                location:        md.location        || ''
            };

            // Queue subtask fetch (don't await yet)
            allFetches.push(
                getDocs(collection(db, "projectTasks", mainDoc.id, "subtasks"))
                    .then(subSnap => {
                        for (const subDoc of subSnap.docs) {
                            const sd = subDoc.data();
                            taskCache[subDoc.id] = {
                                taskId:          sd.taskId          || '',
                                taskDescription: sd.taskDescription || '',
                                location:        sd.location        || ''
                            };

                            // Sub-subtasks
                            return getDocs(
                                collection(db, "projectTasks", mainDoc.id, "subtasks", subDoc.id, "subsubtasks")
                            ).then(ssSnap => {
                                for (const ssDoc of ssSnap.docs) {
                                    const ssd = ssDoc.data();
                                    taskCache[ssDoc.id] = {
                                        taskId:          ssd.taskId          || '',
                                        taskDescription: ssd.taskDescription || '',
                                        location:        ssd.location        || ''
                                    };
                                }
                            }).catch(() => {});
                        }
                    })
                    .catch(() => {})
            );
        }

        // Wait for ALL fetches in parallel
        await Promise.all(allFetches);
    } catch(e) { 
        console.warn("loadTaskTree failed:", e); 
    }
}

async function resolveTask(taskDocId) {
    if (!taskDocId || taskCache[taskDocId]) return taskCache[taskDocId] || null;

    // Fast path ‚Äî top-level projectTasks (for new docs added after initial load)
    try {
        const snap = await getDoc(doc(db, "projectTasks", taskDocId));
        if (snap.exists()) {
            const d = snap.data();
            taskCache[taskDocId] = {
                taskId:          d.taskId          || '',
                taskDescription: d.taskDescription || '',
                location:        d.location        || ''
            };
            return taskCache[taskDocId];
        }
    } catch {}

    taskCache[taskDocId] = { taskId: '', taskDescription: '', location: '' };
    return taskCache[taskDocId];
}

/* ‚îÄ‚îÄ LOAD PROJECT NAME ‚îÄ‚îÄ */
async function resolveProject(projectId) {
    if (!projectId) return '‚Äî';
    if (projectCache[projectId]) return projectCache[projectId];
    try {
        for (const col of ['projects','projectDashboard']) {
            const snap = await getDoc(doc(db, col, projectId));
            if (snap.exists()) {
                projectCache[projectId] = snap.data().name || projectId;
                return projectCache[projectId];
            }
        }
    } catch {}
    projectCache[projectId] = projectId;
    return projectId;
}

/* ‚îÄ‚îÄ REAL-TIME LISTENER ‚îÄ‚îÄ */
let firstLoad = true;

onSnapshot(
    query(collection(db, "materialsUsage"), orderBy("assignedAt", "desc")),
    async (snapshot) => {
        // On first load, pre-warm caches in parallel
        if (firstLoad) {
            firstLoad = false;
            await loadTaskTree();
            loadFilterState(); // Load saved filters after task tree is ready
        }

        // Batch-resolve projects first (likely many are duplicates, so cache hits)
        const projectIds = [...new Set(snapshot.docs.map(d => d.data().projectId).filter(Boolean))];
        await Promise.all(projectIds.map(pid => resolveProject(pid)));

        // Build records with cached task info
        allUsages = snapshot.docs.map((docSnap) => {
            const u = docSnap.data();
            const taskInfo = taskCache[u.taskId];
            // If taskInfo not in cache yet, queue it for resolution
            if (!taskInfo) {
                resolveTask(u.taskId); // Fire and forget on first load, cache on next fire
            }
            return { _docId: docSnap.id, ...u };
        });

        refreshFilters();
        applyAndRender();
    },
    (err) => {
        console.error('onSnapshot error:', err);
        tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;color:red;padding:30px">
            Error loading data: ${err.message}</td></tr>`;
    }
);

/* ‚îÄ‚îÄ REFRESH DROPDOWN FILTERS ‚îÄ‚îÄ */
function refreshFilters() {
    const selMat  = materialFilter.value;
    const selProj = projectFilter.value;

    // Materials
    const mats = [...new Set(allUsages.map(u => u.materialName).filter(Boolean))].sort();
    materialFilter.innerHTML = '<option value="">All</option>' +
        mats.map(m => `<option value="${m}" ${m===selMat?'selected':''}>${m}</option>`).join('');

    // Projects (use cached names)
    const projs = [...new Set(allUsages.map(u => projectCache[u.projectId] || u.projectId).filter(Boolean))].sort();
    projectFilter.innerHTML = '<option value="">All</option>' +
        projs.map(p => `<option value="${p}" ${p===selProj?'selected':''}>${p}</option>`).join('');
}

/* ‚îÄ‚îÄ FILTER + RENDER ‚îÄ‚îÄ */
function applyAndRender() {
    const selMat    = materialFilter.value;
    const selProj   = projectFilter.value;
    const taskIdVal = taskIdFilterEl.value.trim().toLowerCase();
    const search    = searchBarEl.value.trim().toLowerCase();
    const day       = dayFilterEl.value;
    const week      = weekFilterEl.value;

    let filtered = allUsages.filter(u => {
        if (!showReversed && u.reversed) return false;

        const taskInfo = taskCache[u.taskId] || {};
        const projName = projectCache[u.projectId] || '';

        if (selMat  && u.materialName !== selMat)   return false;
        if (selProj && projName !== selProj)          return false;
        if (taskIdVal && !(taskInfo.taskId || '').toLowerCase().includes(taskIdVal)) return false;

        // Day filter
        if (day) {
            const assignedDate = u.assignedAt?.toDate ? u.assignedAt.toDate() : 
                                u.assignedAt?.seconds ? new Date(u.assignedAt.seconds * 1000) : null;
            if (assignedDate) {
                const assignedDateStr = assignedDate.toISOString().split('T')[0];
                if (assignedDateStr !== day) return false;
            }
        }

        // Week filter
        if (week) {
            const weekNum = getWeekOfMonth(u.assignedAt);
            if (weekNum !== parseInt(week)) return false;
        }

        if (search) {
            const hay = [
                taskInfo.taskId, taskInfo.taskDescription, taskInfo.location,
                u.materialName, u.quantity, u.unitPrice, projName, fmtDate(u.assignedAt)
            ].filter(Boolean).join(' ').toLowerCase();
            return hay.includes(search);
        }
        return true;
    });

    renderTable(filtered);
    updateStats(filtered);
    saveFilterState();
}

/* ‚îÄ‚îÄ RENDER TABLE ‚îÄ‚îÄ */
function renderTable(records) {
    if (!records.length) {
        tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:50px; color:#7f96b3">
            <i class="fas fa-inbox" style="font-size:2rem; display:block; margin-bottom:10px"></i>
            No records found.</td></tr>`;
        return;
    }

    tbody.innerHTML = '';
    let row = 1;
    for (const u of records) {
        const taskInfo  = taskCache[u.taskId]          || {};
        const projName  = projectCache[u.projectId]    || '‚Äî';
        const qty       = parseFloat(u.quantity)       || 0;
        const price     = parseFloat(u.unitPrice)      || 0;
        const amount    = qty * price;
        const isRev     = !!u.reversed;

        const tr = document.createElement('tr');
        if (isRev) tr.classList.add('reversed-row');
        tr.dataset.docId = u._docId;

        tr.innerHTML = `
            <td>${row++}</td>
            <td><span class="task-id-badge">${taskInfo.taskId || '‚Äî'}</span></td>
            <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap"
                title="${taskInfo.taskDescription||''}">${taskInfo.taskDescription || '‚Äî'}</td>
            <td style="font-weight:600">${u.materialName || '‚Äî'}</td>
            <td>${qty || '‚Äî'}</td>
            <td>${price ? fmtNum(price) : '‚Äî'}</td>
            <td class="amount-cell">${amount > 0 ? fmtNum(amount) : '‚Äî'}</td>
            <td>${taskInfo.location || u.location || '‚Äî'}</td>
            <td style="white-space:nowrap">${fmtDate(u.assignedAt)}</td>
            <td style="text-align:center">
                ${isRev
                    ? `<span style="font-size:0.62rem;background:#f5f5f5;color:#999;padding:2px 8px;border-radius:20px;border:1px solid #ddd">Reversed</span>`
                    : `<div class="menu-container">
                        <button class="menu-trigger" onclick="toggleMenu(this)">‚ãÆ</button>
                        <div class="menu-dropdown">
                            <div class="menu-item" onclick="openModal('${u._docId}')">
                                <i class="fas fa-edit"></i> Edit / Details
                            </div>
                            <div class="menu-item danger" onclick="quickReverse('${u._docId}')">
                                <i class="fas fa-undo"></i> Reverse
                            </div>
                        </div>
                       </div>`
                }
            </td>`;
        tbody.appendChild(tr);
    }
}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
function updateStats(filtered) {
    const active = filtered.filter(u => !u.reversed);
    const matCost = active.reduce((s,u) => {
        return s + (parseFloat(u.quantity)||0) * (parseFloat(u.unitPrice)||0);
    }, 0);
    const revCount = filtered.filter(u => u.reversed).length;
    const matNames = new Set(active.map(u => u.materialName).filter(Boolean));

    document.getElementById('statMatCost').textContent   = fmtNum(matCost);
    document.getElementById('statCount').textContent     = active.length;
    document.getElementById('statReversed').textContent  = revCount;
    document.getElementById('statMaterials').textContent = matNames.size;
}

/* ‚îÄ‚îÄ ACTIONS DROPDOWN FUNCTIONS ‚îÄ‚îÄ */
window.toggleActionsDropdown = function() {
    const dropdown = document.getElementById('actionsDropdown');
    dropdown.classList.toggle('show');
    
    // Close when clicking outside
    if (dropdown.classList.contains('show')) {
        setTimeout(() => {
            document.addEventListener('click', closeActionsDropdown);
        }, 0);
    }
};

function closeActionsDropdown(e) {
    const dropdown = document.getElementById('actionsDropdown');
    const actionsBtn = document.querySelector('.actions-btn');
    
    if (!dropdown.contains(e.target) && !actionsBtn.contains(e.target)) {
        dropdown.classList.remove('show');
        document.removeEventListener('click', closeActionsDropdown);
    }
}

window.applyAdvancedFilters = function() {
    selectedDay = dayFilterEl.value;
    selectedWeek = weekFilterEl.value;
    applyAndRender();
    document.getElementById('actionsDropdown').classList.remove('show');
};

window.clearAdvancedFilters = function() {
    dayFilterEl.value = '';
    weekFilterEl.value = '';
    selectedDay = '';
    selectedWeek = '';
    applyAndRender();
};

/* ‚îÄ‚îÄ MENU ‚îÄ‚îÄ */
window.toggleMenu = function(btn) {
    const menu = btn.nextElementSibling;
    document.querySelectorAll('.menu-dropdown.show').forEach(m => { if (m !== menu) m.classList.remove('show'); });
    menu.classList.toggle('show');
};
document.addEventListener('click', e => {
    if (!e.target.closest('.menu-container'))
        document.querySelectorAll('.menu-dropdown.show').forEach(m => m.classList.remove('show'));
});

// Toggle reversed visibility
document.getElementById('toggleReversedBtn').addEventListener('click', function() {
    showReversed = !showReversed;
    this.classList.toggle('active', showReversed);
    this.innerHTML = showReversed
        ? '<i class="fas fa-eye-slash"></i> Hide Reversed'
        : '<i class="fas fa-eye"></i> Show Reversed';
    applyAndRender();
});

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
window.openModal = function(docId) {
    currentDocId  = docId;
    currentRecord = allUsages.find(u => u._docId === docId);
    if (!currentRecord) return;

    const taskInfo = taskCache[currentRecord.taskId] || {};
    const qty      = parseFloat(currentRecord.quantity)  || 0;
    const price    = parseFloat(currentRecord.unitPrice) || 0;

    // Populate detail grid
    modalDetailGrid.innerHTML = `
        <div><div class="dg-label">Task ID</div><div class="dg-value">${taskInfo.taskId || currentRecord.taskId || '‚Äî'}</div></div>
        <div><div class="dg-label">Description</div><div class="dg-value">${taskInfo.taskDescription || '‚Äî'}</div></div>
        <div><div class="dg-label">Material</div><div class="dg-value">${currentRecord.materialName || '‚Äî'}</div></div>
        <div><div class="dg-label">Quantity</div><div class="dg-value">${qty}</div></div>
        <div><div class="dg-label">Unit Price</div><div class="dg-value">${fmtNum(price)}</div></div>
        <div><div class="dg-label">Amount</div><div class="dg-value" style="color:#059669;font-size:0.85rem">${fmtNum(qty*price)}</div></div>
        <div><div class="dg-label">Location</div><div class="dg-value">${taskInfo.location || currentRecord.location || '‚Äî'}</div></div>
        <div><div class="dg-label">Status</div><div class="dg-value">${currentRecord.reversed ? 'üîÅ Reversed' : '‚úÖ Active'}</div></div>
    `;

    editAssignedAt.value = toInputDate(currentRecord.assignedAt);
    editError.style.display = 'none';
    editError.textContent = '';
    btnReverse.disabled   = !!currentRecord.reversed;
    btnReverse.textContent = currentRecord.reversed ? '‚úì Already Reversed' : '‚Ü© Reverse';

    document.querySelectorAll('.menu-dropdown.show').forEach(m => m.classList.remove('show'));
    editModal.classList.add('active');
};

window.hideModal = function() {
    editModal.classList.remove('active');
    currentDocId  = null;
    currentRecord = null;
};
editModal.addEventListener('click', e => { if (e.target === editModal) hideModal(); });

/* ‚îÄ‚îÄ SAVE DATE ‚îÄ‚îÄ */
window.saveDate = async function() {
    if (!currentDocId) return;
    const val = editAssignedAt.value;
    if (!val) {
        editError.textContent = 'Please pick a date/time.';
        editError.style.display = 'block'; return;
    }
    try {
        await updateDoc(doc(db, "materialsUsage", currentDocId), {
            assignedAt: Timestamp.fromDate(new Date(val))
        });
        hideModal();
    } catch(e) {
        editError.textContent = 'Save failed: ' + e.message;
        editError.style.display = 'block';
    }
};

/* ‚îÄ‚îÄ REVERSE (from modal) ‚îÄ‚îÄ */
window.doReverse = async function() {
    if (!currentDocId || !currentRecord || currentRecord.reversed) return;
    if (!confirm(`Reverse this assignment?\n‚Ä¢ ${currentRecord.materialName}\n‚Ä¢ Qty: ${currentRecord.quantity}\n\nStock will be restored.`)) return;
    await performReversal(currentDocId, currentRecord.materialId, parseFloat(currentRecord.quantity)||0);
    hideModal();
};

/* ‚îÄ‚îÄ REVERSE (quick from table menu) ‚îÄ‚îÄ */
window.quickReverse = async function(docId) {
    const u = allUsages.find(r => r._docId === docId);
    if (!u || u.reversed) return;
    if (!confirm(`Reverse this assignment?\n‚Ä¢ ${u.materialName}\n‚Ä¢ Qty: ${u.quantity}\n\nStock will be restored.`)) return;
    await performReversal(docId, u.materialId, parseFloat(u.quantity)||0);
};

async function performReversal(docId, materialId, qty) {
    try {
        await runTransaction(db, async (tx) => {
            const usageRef = doc(db, "materialsUsage", docId);
            const usageSnap = await tx.get(usageRef);
            if (!usageSnap.exists()) throw new Error("Record not found");
            if (usageSnap.data().reversed) throw new Error("Already reversed");

            // Restore stock if materialId is set
            if (materialId) {
                const matRef  = doc(db, "materials", materialId);
                const matSnap = await tx.get(matRef);
                if (matSnap.exists()) {
                    tx.update(matRef, { quantity: (matSnap.data().quantity || 0) + qty });
                }
            }

            tx.update(usageRef, { reversed: true, reversedAt: Timestamp.now() });
        });
        alert('‚úÖ Reversed successfully! Stock has been restored.');
    } catch(e) {
        alert('‚ùå Reversal failed: ' + (e.message || e));
    }
}

/* ‚îÄ‚îÄ FILTER EVENTS ‚îÄ‚îÄ */
materialFilter.addEventListener('change', applyAndRender);
projectFilter.addEventListener('change',  applyAndRender);
taskIdFilterEl.addEventListener('input',  applyAndRender);
searchBarEl.addEventListener('input',     applyAndRender);

// Close actions dropdown when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('actionsDropdown');
    const actionsBtn = document.querySelector('.actions-btn');
    if (dropdown && actionsBtn && !dropdown.contains(e.target) && !actionsBtn.contains(e.target)) {
        dropdown.classList.remove('show');
    }
});
</script>
</body>
</html>
