<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employee Work Tracker</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Construction Theme Colors */
      --primary: #2a5f8a;
      --primary-light: #3a7cb9;
      --primary-dark: #1d4568;
      --secondary: #f7931e;
      --secondary-light: #ffae4d;
      --secondary-dark: #e07c0d;
      --success: #4CAF50;
      --danger: #F44336;
      --warning: #FF9800;
      --info: #2196F3;
      --text: #333;
      --light-bg: #f5f7fa;
      --card-bg: #fff;
      --border: #e0e4e9;
      --approved-color: #2e7d32;
      --resolved-color: #1565c0;
    }
    html, body {
      min-height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      background: var(--light-bg);
      color: var(--text);
      font-family: 'Segoe UI', Arial, sans-serif;
      box-sizing: border-box;
      font-size: 14px;
    }
    body {
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100vw;
      background: var(--card-bg);
      padding: 0;
    }
    .welcome {
      font-size: 1em;
      color: var(--primary);
      text-align: center;
      margin: 0;
      letter-spacing: 0.5px;
      font-weight: 600;
      width: 100vw;
      background: var(--light-bg);
      padding: 10px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .header-bar {
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--primary);
      color: white;
      padding: 0 3vw;
      margin-bottom: 0;
      min-height: 54px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .header-bar h2 {
      margin: 0;
      color: white;
      font-weight: 700;
      font-size: 1.2em;
      letter-spacing: 1px;
    }
    .header-controls {
      display: flex;
      gap: 10px;
    }
    .btn {
      background: var(--secondary);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 8px 16px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn i {
      font-size: 1em;
    }
    .btn-logout {
      background: var(--danger);
    }
    .btn-toggle:hover { background: var(--secondary-dark); }
    .btn-logout:hover { background: #c62828; }
    .btn-success {
      background: var(--success);
    }
    .btn-info {
      background: var(--info);
    }
    .form-container {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      max-width: 98vw;
      width: 460px;
      margin: 20px auto 10px;
      padding: 16px 12px 10px;
      color: var(--text);
      border: 1px solid var(--border);
    }
    label { 
      font-weight: bold; 
      margin-top: 10px; 
      display: block; 
      color: var(--primary);
      font-size: 0.9em;
    }
    input, textarea, select {
      width: 100%;
      padding: 9px 11px;
      margin-top: 4px;
      background: #f8fafc;
      border: 1.2px solid #b5c4d6;
      border-radius: 5px;
      font-size: 0.95em;
      color: var(--text);
      margin-bottom: 4px;
      transition: all 0.18s;
      box-sizing: border-box;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(42, 95, 138, 0.2);
    }
    textarea { 
      resize: vertical; 
      min-height: 42px; 
      font-family: inherit;
    }
    .btn-submit {
      margin-top: 18px;
      padding: 11px 0;
      width: 100%;
      background: var(--primary);
      border: none;
      color: #fff;
      font-size: 1.05em;
      border-radius: 7px;
      cursor: pointer;
      font-weight: 600;
      transition: all .18s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .btn-submit:hover { 
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    /* Improved Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 15px;
      margin: 0 auto 40px;
      max-width: 1400px;
      width: 100vw;
      padding: 0 4vw 20px;
    }
    
    /* Enhanced Card Design */
    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      width: 100%;
      min-width: 0;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      border-color: var(--primary-light);
    }
    .card.collapsed .card-details { display: none; }
    .card-summary {
      font-weight: bold;
      font-size: 1.05em;
      background: #f2f6fb;
      padding: 14px;
      border-bottom: 1px solid var(--border);
      color: var(--primary);
      letter-spacing: 0.5px;
      user-select: none;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }
    .card-summary .name {
      font-weight: 700;
      color: var(--primary);
      flex: 1;
      min-width: 120px;
      font-size: 0.95em;
    }
    .card-summary .location {
      color: #555;
      font-size: 0.9em;
      flex: 1;
      min-width: 100px;
    }
    .card-summary .hours {
      color: var(--success);
      font-size: 0.9em;
      font-weight: 500;
      white-space: nowrap;
    }
    
    /* Card Details Layout */
    .card-details {
      padding: 14px;
    }
    .detail-row {
      display: flex;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .detail-col {
      flex: 1;
      min-width: 150px;
      margin-right: 15px;
    }
    .detail-col:last-child {
      margin-right: 0;
    }
    .detail-row p {
      margin: 5px 0;
      font-size: 0.9em;
    }
    .detail-row b {
      color: var(--primary);
      font-size: 0.9em;
    }
    
    /* Statistics Section */
    .stats-container {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      margin: 15px auto;
      padding: 16px;
      max-width: 98vw;
      width: 460px;
      border: 1px solid var(--border);
    }
    .stats-title {
      font-weight: bold;
      color: var(--primary);
      text-align: center;
      margin-bottom: 15px;
      font-size: 1.1em;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .stat-card {
      background: #f2f6fb;
      border-radius: 6px;
      padding: 12px;
      text-align: center;
      border: 1px solid var(--border);
    }
    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary);
    }
    .stat-label {
      font-size: 0.85em;
      color: #666;
      margin-top: 5px;
    }
    
    /* Form Error */
    #formError {
      color: var(--danger);
      margin-top: 8px;
      font-size: 0.9em;
      padding: 8px;
      background: #ffebee;
      border-radius: 4px;
      border-left: 3px solid var(--danger);
    }
    
    /* Filter Controls */
    .filter-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85em;
    }
    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Date Filter Controls */
    .date-filter {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
      padding: 0 4vw;
    }
    .date-filter input {
      width: 150px;
      padding: 8px;
      font-size: 0.9em;
    }
    .date-filter button {
      padding: 8px 16px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background: var(--primary);
      color: white;
      cursor: pointer;
      font-size: 0.9em;
    }
    .date-filter button:hover {
      background: var(--primary-dark);
    }
    
    /* Loading indicator */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive Design */
    @media (max-width: 700px) {
      body {
        font-size: 13px;
      }
      .header-bar, .welcome {
        padding-left: 3vw;
        padding-right: 3vw;
      }
      .header-controls {
        gap: 6px;
      }
      .btn {
        padding: 7px 10px;
        font-size: 0.85em;
      }
      .form-container, .stats-container { 
        max-width: 94vw; 
        border-radius: 0; 
        padding: 10px 3vw 6px;
        box-shadow: none;
        border-left: none;
        border-right: none;
      }
      .grid { 
        padding: 0 3vw 16px; 
        gap: 12px; 
        grid-template-columns: 1fr;
      }
      .card { 
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      }
      .card-summary { 
        padding: 12px; 
        font-size: 0.95em;
        flex-direction: column;
        align-items: flex-start;
      }
      .card-summary .name,
      .card-summary .location {
        min-width: 100%;
      }
      input, textarea, select { 
        font-size: 0.95em;
        padding: 8px 10px;
      }
      .detail-col {
        min-width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
      }
      .filter-controls {
        gap: 6px;
      }
      .filter-btn {
        padding: 6px 12px;
        font-size: 0.8em;
      }
      .date-filter {
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      .date-filter input {
        width: 80%;
        max-width: 200px;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* Animation for form toggle */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .form-container, .stats-container {
      animation: fadeIn 0.3s ease-out;
    }
    
    .card.zoomed {
      z-index: 2;
      box-shadow: 0 0 0 2px var(--primary-light), 0 5px 30px rgba(0,0,0,0.23);
      transform: scale(1.01);
      background: #fff;
    }

    .card.blurred {
      filter: blur(3px) grayscale(40%);
      opacity: 0.7;
      pointer-events: none;
      transition: filter 0.2s, opacity 0.18s;
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <h2>EMPLOYEE WORK TRACKER</h2>
    <div class="header-controls">
      <button class="btn btn-toggle" id="addBtn" onclick="toggleForm()">
        <i class="fas fa-plus"></i> Add Task
      </button>
      <button class="btn btn-logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>
  <div class="welcome" id="welcome"></div>
  
  <div class="filter-controls" id="filterControls">
    <button class="filter-btn active" data-filter="all">All Tasks</button>
    <button class="filter-btn" data-filter="today">Today</button>
    <button class="filter-btn" data-filter="week">This Week</button>
    <button class="filter-btn" data-filter="month">This Month</button>
  </div>
  
  <div class="date-filter" id="dateFilter">
    <input type="date" id="startDate" placeholder="Start Date">
    <input type="date" id="endDate" placeholder="End Date">
    <button onclick="applyDateFilter()">Apply Date Filter</button>
    <button onclick="clearDateFilter()">Clear Filter</button>
  </div>
  
  <div class="stats-container" id="statsContainer">
    <div class="stats-title">Work Summary</div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalTasks">0</div>
        <div class="stat-label">Total Tasks</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalHours">0</div>
        <div class="stat-label">Total Hours</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgHours">0</div>
        <div class="stat-label">Avg Hours/Task</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="tasksThisMonth">0</div>
        <div class="stat-label">Tasks This Month</div>
      </div>
    </div>
  </div>
  
  <div id="userView">
    <div class="form-container" id="formContainer" style="display: none;">
      <form id="taskForm">
        <input type="hidden" id="taskId">
        <input type="hidden" id="originalUsername">
        
        <label>Name</label>
        <input type="text" id="name" required>
        
        <label>Location</label>
        <input type="text" id="location" required>
        
        <label>Job Done</label>
        <textarea id="job" required></textarea>
        
        <label>Hours Worked</label>
        <input type="number" id="hours" min="0.5" max="24" step="0.5" required>
        
        <label>Date</label>
        <input type="date" id="date" required>
        
        <div class="action-buttons">
          <button type="submit" class="btn btn-submit" id="submitBtn">
            <i class="fas fa-save"></i> Save Task
          </button>
          <button type="button" class="btn btn-danger" id="cancelEdit" style="display: none;" onclick="cancelEdit()">
            <i class="fas fa-times"></i> Cancel Edit
          </button>
        </div>
        <div id="formError" style="display: none;"></div>
      </form>
    </div>
    <div class="grid" id="tasks"></div>
  </div>

<script>
// ---- CONFIGURATION ----
const ADMIN_USERS = ['faiyaz mulla', 'christopher'];
const GENERAL_PASSWORD = '12345';

// ---- FIREBASE SETUP ----
const firebaseConfig = {
  apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
  authDomain: "project-task-588c4.firebaseapp.com",
  projectId: "project-task-588c4",
  storageBucket: "project-task-588c4.appspot.com",
  messagingSenderId: "411882772509",
  appId: "1:411882772509:web:08d613186c101a99f38ef4",
  measurementId: "G-JMFLFYEM0F"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---- USER MANAGEMENT ----
function getCurrentUser() {
  return localStorage.getItem('currentUser') || null;
}
function isAdmin(user) {
  if (!user) return false;
  return ADMIN_USERS.includes(user.toLowerCase());
}
function logout() {
  localStorage.removeItem('currentUser');
  localStorage.removeItem('currentFilter');
  localStorage.removeItem('dateFilter');
  location.href = "index.html";
}
function showWelcome(user) {
  let name = user.trim().split(" ");
  name = name.length === 1 ? name[0] : name.slice(-2).join(" ");
  document.getElementById('welcome').innerHTML = `WELCOME <span style="color:var(--primary)">${name.toUpperCase()}</span>`;
  if (isAdmin(user)) {
    document.getElementById('filterControls').style.display = 'flex';
    document.getElementById('dateFilter').style.display = 'flex';
  } else {
    document.getElementById('filterControls').style.display = 'none';
    document.getElementById('dateFilter').style.display = 'none';
  }
}

// ---- FORM TOGGLE ----
function toggleForm() {
  const fc = document.getElementById("formContainer");
  if (fc.style.display === "none") {
    resetForm();
    fc.style.display = "block";
    document.getElementById("addBtn").innerHTML = '<i class="fas fa-times"></i> Cancel';
  } else {
    fc.style.display = "none";
    document.getElementById("addBtn").innerHTML = '<i class="fas fa-plus"></i> Add Task';
  }
}
function resetForm() {
  document.getElementById("taskForm").reset();
  document.getElementById("taskId").value = "";
  document.getElementById("originalUsername").value = "";
  document.getElementById("date").valueAsDate = new Date();
  document.getElementById("cancelEdit").style.display = "none";
  document.getElementById("formError").style.display = "none";
}
function cancelEdit() {
  resetForm();
  toggleForm();
}

// ---- TASK CRUD ----
let allTasks = [];
let unsubscribe = null;
let currentFilter = localStorage.getItem('currentFilter') || 'all';
let dateFilter = JSON.parse(localStorage.getItem('dateFilter')) || {};

function listenTasks() {
  const user = getCurrentUser();
  if (!user) return;
  if (unsubscribe) unsubscribe();
  
  // Show loading state
  document.getElementById("tasks").innerHTML = `
    <div style="text-align:center; padding:20px; width:100%;">
      <div class="loading" style="border-top-color: var(--primary); margin:0 auto;"></div>
      <p style="color:#666; margin-top:10px;">Loading tasks...</p>
    </div>
  `;
  
  let query = db.collection("TASKS");
  // Only admins see all tasks
  if (!isAdmin(user)) {
    query = query.where("username", "==", user);
  }
  unsubscribe = query.onSnapshot(snapshot => {
    allTasks = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      data._id = doc.id;
      allTasks.push(data);
    });
    renderTasks();
    updateFilterButtons();
    updateDateFilterInputs();
    updateStatistics();
  }, error => {
    console.error("Error loading tasks:", error);
    document.getElementById("tasks").innerHTML = `
      <p style="text-align:center; padding:20px; color:var(--danger);">
        Error loading tasks. Please refresh the page.
      </p>
    `;
  });
}
function renderTasks() {
  const container = document.getElementById("tasks");
  container.innerHTML = "";
  let filteredTasks = filterTasks(allTasks);
  
  // Apply date filter if set
  if (dateFilter.startDate || dateFilter.endDate) {
    filteredTasks = applyDateFilterToTasks(filteredTasks);
  }
  
  if (filteredTasks.length === 0) {
    container.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">No tasks found</p>';
    return;
  }
  const sortedTasks = [...filteredTasks].sort((a, b) => {
    return (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0);
  });
  sortedTasks.forEach((task, index) => {
    container.appendChild(createTaskCard(task, index));
  });
}
function filterTasks(tasks) {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - today.getDay());
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  
  switch(currentFilter) {
    case 'today': 
      return tasks.filter(task => {
        const taskDate = task.date ? new Date(task.date) : task.createdAt?.toDate();
        return taskDate >= today;
      });
    case 'week': 
      return tasks.filter(task => {
        const taskDate = task.date ? new Date(task.date) : task.createdAt?.toDate();
        return taskDate >= weekStart;
      });
    case 'month': 
      return tasks.filter(task => {
        const taskDate = task.date ? new Date(task.date) : task.createdAt?.toDate();
        return taskDate >= monthStart;
      });
    default: return tasks;
  }
}
function applyDateFilterToTasks(tasks) {
  const startDate = dateFilter.startDate ? new Date(dateFilter.startDate) : null;
  const endDate = dateFilter.endDate ? new Date(dateFilter.endDate) : null;
  
  if (startDate) startDate.setHours(0, 0, 0, 0);
  if (endDate) endDate.setHours(23, 59, 59, 999);
  
  return tasks.filter(task => {
    const taskDate = task.date ? new Date(task.date) : task.createdAt?.toDate();
    
    if (startDate && taskDate < startDate) return false;
    if (endDate && taskDate > endDate) return false;
    
    return true;
  });
}
function updateFilterButtons() {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.filter === currentFilter) {
      btn.classList.add('active');
    }
  });
}
function updateDateFilterInputs() {
  if (dateFilter.startDate) {
    document.getElementById('startDate').value = dateFilter.startDate;
  }
  if (dateFilter.endDate) {
    document.getElementById('endDate').value = dateFilter.endDate;
  }
}
function createTaskCard(task, index) {
  const summary = document.createElement('div');
  summary.className = 'card-summary';
  summary.innerHTML = `
    <div class="name">${task.name || "No Name"}</div>
    <div class="location">${task.location || "No Location"}</div>
    <div class="hours">${task.hours || 0} hours</div>
  `;
  const card = document.createElement('div');
  card.className = 'card collapsed';
  card.id = `card-${index}`;
  // --- BLUR/ZOOM LOGIC ---
  card.addEventListener('click', function(e) {
    if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
    const cards = document.querySelectorAll('.card');
    if (!this.classList.contains('zoomed')) {
      cards.forEach(cardEl => {
        if (cardEl !== this) cardEl.classList.add('blurred');
        else cardEl.classList.add('zoomed');
      });
    } else {
      cards.forEach(cardEl => {
        cardEl.classList.remove('zoomed', 'blurred');
      });
    }
    this.classList.toggle('collapsed');
  });
  const details = document.createElement('div');
  details.className = 'card-details';
  const infoRow = document.createElement('div');
  infoRow.className = 'detail-row';
  infoRow.innerHTML = `
    <div class="detail-col">
      <p><b>Name:</b> ${task.name || "Unknown"}</p>
      <p><b>Location:</b> ${task.location || "None"}</p>
      <p><b>Date:</b> ${task.date || formatDate(task.createdAt?.toDate())}</p>
    </div>
    <div class="detail-col">
      <p><b>Hours Worked:</b> ${task.hours || 0}</p>
      <p><b>Added By:</b> ${task.username || "Unknown"}</p>
      <p><b>Added On:</b> ${formatDate(task.createdAt?.toDate())}</p>
    </div>
  `;
  details.appendChild(infoRow);

  // --- JOB DESCRIPTION ---
  const jobContainer = document.createElement('div');
  jobContainer.className = 'detail-row';
  jobContainer.innerHTML = `
    <div class="detail-col" style="min-width: 100%;">
      <p><b>Job Done:</b></p>
      <p>${task.job || "No description"}</p>
    </div>
  `;
  details.appendChild(jobContainer);

  // --- ACTION BUTTONS: everyone can edit their own tasks, admins can edit all ---
  const user = getCurrentUser();
  const actionButtons = document.createElement('div');
  actionButtons.className = 'action-buttons';
  actionButtons.innerHTML = `
    <button type="button" class="btn btn-primary" onclick="editTask('${task._id}', event)">
      <i class="fas fa-edit"></i> Edit
    </button>
    <button type="button" class="btn btn-danger" onclick="deleteTask('${task._id}', event)">
      <i class="fas fa-trash"></i> Delete
    </button>
  `;
  details.appendChild(actionButtons);

  card.appendChild(summary);
  card.appendChild(details);
  return card;
}
function formatDate(dateValue) {
  if (!dateValue) return '';
  try {
    const date = dateValue.toDate ? dateValue.toDate() : new Date(dateValue);
    return date.toLocaleDateString();
  } catch (e) {
    return dateValue;
  }
}

// ---- STATISTICS ----
function updateStatistics() {
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  
  // Total tasks
  document.getElementById('totalTasks').textContent = allTasks.length;
  
  // Total hours
  const totalHours = allTasks.reduce((sum, task) => sum + (parseFloat(task.hours) || 0), 0);
  document.getElementById('totalHours').textContent = totalHours.toFixed(1);
  
  // Average hours per task
  const avgHours = allTasks.length > 0 ? totalHours / allTasks.length : 0;
  document.getElementById('avgHours').textContent = avgHours.toFixed(1);
  
  // Tasks this month
  const tasksThisMonth = allTasks.filter(task => {
    const taskDate = task.date ? new Date(task.date) : task.createdAt?.toDate();
    return taskDate >= monthStart;
  }).length;
  document.getElementById('tasksThisMonth').textContent = tasksThisMonth;
}

// ---- DATE FILTER FUNCTIONS ----
function applyDateFilter() {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  
  // Validate dates
  if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
    alert('Start date cannot be after end date');
    return;
  }
  
  dateFilter = {
    startDate: startDate || null,
    endDate: endDate || null
  };
  
  // Save to localStorage
  localStorage.setItem('dateFilter', JSON.stringify(dateFilter));
  
  // Re-render tasks
  renderTasks();
}

function clearDateFilter() {
  dateFilter = {};
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  localStorage.removeItem('dateFilter');
  renderTasks();
}

// ---- TASK ACTIONS ----
async function editTask(docId, event) {
  event.stopPropagation();
  try {
    const doc = await db.collection("TASKS").doc(docId).get();
    if (!doc.exists) { alert("Task not found"); return; }
    const task = doc.data();
    document.getElementById("taskId").value = docId;
    document.getElementById("originalUsername").value = task.username || "";
    document.getElementById("name").value = task.name || "";
    document.getElementById("location").value = task.location || "";
    document.getElementById("job").value = task.job || "";
    document.getElementById("hours").value = task.hours || "";
    document.getElementById("date").value = task.date || formatDateForInput(task.createdAt?.toDate());
    document.getElementById("cancelEdit").style.display = "inline-block";
    document.getElementById("formContainer").style.display = "block";
    document.getElementById("addBtn").innerHTML = '<i class="fas fa-times"></i> Cancel';
    document.getElementById("formContainer").scrollIntoView({ behavior: 'smooth' });
  } catch (err) {
    console.error("Error editing task:", err);
    alert("Failed to load task for editing");
  }
}
function formatDateForInput(dateValue) {
  if (!dateValue) return '';
  try {
    const date = dateValue.toDate ? dateValue.toDate() : new Date(dateValue);
    // Format for date input: YYYY-MM-DD
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    
    return `${year}-${month}-${day}`;
  } catch (e) {
    return '';
  }
}
async function deleteTask(docId, event) {
  event.stopPropagation();
  if (!confirm("Are you sure you want to delete this task?")) return;
  try {
    await db.collection("TASKS").doc(docId).delete();
  } catch (err) {
    console.error("Error deleting task:", err);
    alert("Failed to delete task");
  }
}

// ---- FILTER CONTROLS ----
function setupFilterControls() {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      currentFilter = this.dataset.filter;
      localStorage.setItem('currentFilter', currentFilter);
      renderTasks();
      updateFilterButtons();
    });
  });
}

// ---- ADD/UPDATE TASK ----
document.getElementById("taskForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const user = getCurrentUser();
  if (!user) {
    alert("You must be logged in to submit a task");
    return;
  }
  
  // Show loading state on submit button
  const submitBtn = document.getElementById("submitBtn");
  const originalBtnText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<div class="loading"></div> Saving...';
  submitBtn.disabled = true;
  
  try {
    const formData = {
      name: document.getElementById("name").value,
      location: document.getElementById("location").value,
      job: document.getElementById("job").value,
      hours: parseFloat(document.getElementById("hours").value),
      date: document.getElementById("date").value,
      updatedAt: new Date()
    };
    
    const docId = document.getElementById("taskId").value;
    const originalUsername = document.getElementById("originalUsername").value;
    
    // Preserve the original username if editing (admin editing someone else's task)
    if (docId && originalUsername) {
      formData.username = originalUsername;
    } else {
      formData.username = user;
    }
    
    if (docId) {
      const doc = await db.collection("TASKS").doc(docId).get();
      if (doc.exists) {
        const existingData = doc.data();
        formData.createdAt = existingData.createdAt;
      }
    } else {
      formData.createdAt = new Date();
    }
    
    // Clean up data to ensure Firebase compatibility
    Object.keys(formData).forEach(key => {
      if (formData[key] === undefined || formData[key] === null) {
        delete formData[key];
      }
    });
    
    if (docId) {
      await db.collection("TASKS").doc(docId).set(formData, {merge: true});
    } else {
      await db.collection("TASKS").add(formData);
    }
    
    resetForm();
    document.getElementById("formContainer").style.display = "none";
    document.getElementById("addBtn").innerHTML = '<i class="fas fa-plus"></i> Add Task';
    document.getElementById("formError").style.display = "none";
    
  } catch (err) {
    const errorEl = document.getElementById("formError");
    errorEl.textContent = "Error saving task: " + (err.message || err);
    errorEl.style.display = 'block';
    console.error("Task submission error:", err);
  } finally {
    submitBtn.innerHTML = originalBtnText;
    submitBtn.disabled = false;
  }
});

// ---- INIT ----
window.onload = function() {
  const user = getCurrentUser();
  if (!user) { 
    location.href = "index.html"; 
    return; 
  }
  showWelcome(user);
  setupFilterControls();
  listenTasks();
}
</script>
</body>
</html>
