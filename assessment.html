<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Work Assessment Tracker</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
  <style>
    :root {
      /* Construction Theme Colors */
      --primary: #2a5f8a;
      --primary-light: #3a7cb9;
      --primary-dark: #1d4568;
      --secondary: #f7931e;
      --secondary-light: #ffae4d;
      --secondary-dark: #e07c0d;
      --success: #4CAF50;
      --danger: #F44336;
      --warning: #FF9800;
      --info: #2196F3;
      --text: #333;
      --light-bg: #f5f7fa;
      --card-bg: #fff;
      --border: #e0e4e9;
    }
    html, body {
      min-height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      background: var(--light-bg);
      color: var(--text);
      font-family: 'Segoe UI', Arial, sans-serif;
      box-sizing: border-box;
    }
    body {
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100vw;
      background: var(--card-bg);
      padding: 0;
    }
    .welcome {
      font-size: 1.1em;
      color: var(--primary);
      text-align: center;
      margin: 22px 0 8px;
      letter-spacing: 0.5px;
      font-weight: 600;
      width: 100vw;
      background: var(--light-bg);
      padding: 10px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .header-bar {
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--primary);
      color: white;
      padding: 0 3vw 0 3vw;
      margin-bottom: 0;
      min-height: 54px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .header-bar h2 {
      margin: 0;
      color: white;
      font-weight: 700;
      font-size: 1.25em;
      letter-spacing: 1px;
    }
    .btn-logout, .btn-toggle {
      background: var(--secondary);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 9px 18px;
      font-size: 0.95em;
      font-weight: 600;
      margin: 13px 0;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .btn-logout {
      background: var(--danger);
    }
    .btn-toggle:hover { background: var(--secondary-dark); }
    .btn-logout:hover { background: #c62828; }
    .form-container {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      max-width: 98vw;
      width: 460px;
      margin: 20px auto 10px;
      padding: 18px 14px 12px;
      color: var(--text);
      border: 1px solid var(--border);
    }
    label { 
      font-weight: bold; 
      margin-top: 10px; 
      display: block; 
      color: var(--primary);
      font-size: 0.95em;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      margin-top: 4px;
      background: #f8fafc;
      border: 1.2px solid #b5c4d6;
      border-radius: 5px;
      font-size: 1em;
      color: var(--text);
      margin-bottom: 4px;
      transition: border 0.18s;
      box-sizing: border-box;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(42, 95, 138, 0.2);
    }
    textarea { 
      resize: vertical; 
      min-height: 42px; 
      font-family: inherit;
    }
    .btn-submit {
      margin-top: 18px;
      padding: 12px 0;
      width: 100%;
      background: var(--primary);
      border: none;
      color: #fff;
      font-size: 1.07em;
      border-radius: 7px;
      cursor: pointer;
      font-weight: 600;
      transition: all .18s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .btn-submit:hover { 
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    /* Improved Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 15px;
      margin: 0 auto 40px;
      max-width: 1400px;
      width: 100vw;
      padding: 0 4vw 20px;
    }
    
    /* Enhanced Card Design */
    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      width: 100%;
      min-width: 0;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      border-color: var(--primary-light);
    }
    .card.collapsed .card-details { display: none; }
    .card-summary {
      font-weight: bold;
      font-size: 1.09em;
      background: #f2f6fb;
      padding: 15px;
      border-bottom: 1px solid var(--border);
      color: var(--primary);
      letter-spacing: 0.5px;
      user-select: none;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }
    .card-summary .company {
      font-weight: 700;
      color: var(--primary);
      flex: 1;
      min-width: 120px;
    }
    .card-summary .location {
      color: #555;
      font-size: 0.95em;
      flex: 1;
      min-width: 100px;
    }
    .card .deadline {
      color: var(--warning);
      font-size: 0.95em;
      font-weight: 500;
      white-space: nowrap;
    }
    .status {
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 4px;
      display: inline-block;
      margin-top: 0;
      font-size: 0.9em;
      letter-spacing: 0.5px;
      background: #e3f2fd;
      color: var(--primary);
      border: 1px solid #bcdffb;
      white-space: nowrap;
    }
    .Good { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
    .Fair { background: #fff8e1; color: #ff8f00; border-color: #ffe0b2; }
    .Bad { background: #ffebee; color: #c62828; border-color: #ffcdd2; }
    .VeryBad { background: #fce4ec; color: #ad1457; border-color: #f8bbd0; }
    
    /* Improved Image Gallery */
    .images-container {
      margin: 15px 0;
    }
    .images-section {
      margin-bottom: 15px;
    }
    .images-section h4 {
      margin: 0 0 8px 0;
      color: var(--primary);
      font-size: 0.95em;
    }
    .images-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .images-grid a {
      display: block;
      width: 100px;
      height: 80px;
      border-radius: 5px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: #f8fafc;
      position: relative;
      transition: all 0.2s;
    }
    .images-grid a:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    .images-grid a img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s;
    }
    .pdf-thumbnail {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f1f5f9;
      color: var(--primary);
      font-size: 0.8em;
      text-align: center;
      padding: 5px;
    }
    
    /* Card Details Layout */
    .card-details {
      padding: 15px;
    }
    .detail-row {
      display: flex;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .detail-col {
      flex: 1;
      min-width: 150px;
      margin-right: 15px;
    }
    .detail-col:last-child {
      margin-right: 0;
    }
    .detail-row p {
      margin: 5px 0;
      font-size: 0.95em;
    }
    .detail-row b {
      color: var(--primary);
    }
    
    /* Issues List */
    .issues-list {
      margin: 10px 0;
    }
    .issue-item {
      background: #f8fafc;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 8px;
      border-left: 3px solid var(--primary);
    }
    .issue-item h4 {
      margin: 0 0 5px 0;
      color: var(--primary);
      font-size: 0.95em;
    }
    .issue-item p {
      margin: 5px 0;
      font-size: 0.9em;
    }
    .add-issue-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      font-size: 0.9em;
      cursor: pointer;
      margin-top: 5px;
      display: inline-block;
      transition: all 0.2s;
    }
    .add-issue-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    /* Form Error */
    #formError {
      color: var(--danger);
      margin-top: 8px;
      font-size: 0.95em;
      padding: 8px;
      background: #ffebee;
      border-radius: 4px;
      border-left: 3px solid var(--danger);
    }
    
    /* Responsive Design */
    @media (max-width: 700px) {
      .header-bar, .welcome {
        padding-left: 3vw;
        padding-right: 3vw;
      }
      .form-container { 
        max-width: 94vw; 
        border-radius: 0; 
        padding: 12px 3vw 8px; 
        box-shadow: none;
        border-left: none;
        border-right: none;
      }
      .grid { 
        padding: 0 3vw 16px; 
        gap: 12px; 
        grid-template-columns: 1fr;
      }
      .card { 
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      }
      .card-summary { 
        padding: 12px; 
        font-size: 1em;
        flex-direction: column;
        align-items: flex-start;
      }
      .card-summary .company,
      .card-summary .location {
        min-width: 100%;
      }
      input, textarea, select { 
        font-size: 1em; 
        padding: 8px 10px;
      }
      .detail-col {
        min-width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
      }
      .btn-toggle, .btn-logout {
        padding: 8px 14px;
        font-size: 0.9em;
      }
    }
    
    /* Animation for form toggle */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .form-container {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <h2>Work Assessment</h2>
    <button class="btn-logout" onclick="logout()">Logout</button>
  </div>
  <div class="welcome" id="welcome"></div>
  
  <div id="userView">
    <button class="btn-toggle" id="addBtn" onclick="toggleForm()">+ Add New Assessment</button>
    <div class="form-container" id="formContainer" style="display: none;">
      <form id="assessmentForm">
        <label>Company</label>
        <input type="text" id="company" required>
        
        <label>Location</label>
        <input type="text" id="location" required>
        
        <label>Witness Name</label>
        <input type="text" id="witness" required>
        
        <label>Time of Assessment</label>
        <input type="datetime-local" id="time" required>
        
        <label>Deadline</label>
        <input type="date" id="deadline" required>
        
        <div id="issuesContainer">
          <div class="issue-input">
            <label>Issue</label>
            <textarea class="issue-text" required></textarea>
            
            <label>Impact on Users & Company</label>
            <textarea class="impact-text" required></textarea>
            
            <label>Status</label>
            <select class="status-select" required>
              <option value="Good">Good</option>
              <option value="Fair">Fair</option>
              <option value="Bad">Bad</option>
              <option value="VeryBad">Very Bad</option>
            </select>
          </div>
        </div>
        
        <button type="button" class="add-issue-btn" onclick="addIssueField()">+ Add Another Issue</button>
        
        <label>Upload Pictures (Optional)</label>
        <input type="file" id="images" multiple accept="image/*">
        
        <label>Situation Pictures (Optional, update anytime)</label>
        <input type="file" id="situationPics" multiple accept="image/*">
        
        <label>Quotations (Optional, update anytime)</label>
        <input type="file" id="quotations" multiple accept="image/*,application/pdf">
        
        <label>Comment (Optional)</label>
        <textarea id="comment"></textarea>
        
        <button type="submit" class="btn-submit">Save Assessment</button>
        <div id="formError" style="display: none;"></div>
      </form>
    </div>
    <div class="grid" id="assessments"></div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="modalImage">
  </div>

  <script>
    // ---- FIREBASE SETUP ----
    const firebaseConfig = {
      apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
      authDomain: "project-task-588c4.firebaseapp.com",
      projectId: "project-task-588c4",
      storageBucket: "project-task-588c4.appspot.com",
      messagingSenderId: "411882772509",
      appId: "1:411882772509:web:08d613186c101a99f38ef4",
      measurementId: "G-JMFLFYEM0F"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---- USER ----
    const TEAM_MEMBERS = [
      "brighton matolokosh", "caphas tembo", "clisha mambilima", "dabson daka",
      "danny mvula", "james daka", "joseph tembo", "luckson phiri", "micheal lobela",
      "obert siame", "dominic sakala", "peter mawere", "saviour phiri", "tembeya sakala", "kelvin siame"
    ];
    
    function getCurrentUser() {
      return localStorage.getItem('currentUser') || null;
    }
    
    function isTeamMember(user) {
      if (!user) return false;
      return TEAM_MEMBERS.includes(user.toLowerCase());
    }
    
    function logout() {
      localStorage.removeItem('currentUser');
      location.href = "index.html";
    }
    
    // ---- UI/UX ----
    function showWelcome(user) {
      let name = user.trim().split(" ");
      name = name.length === 1 ? name[0] : name.slice(-2).join(" ");
      document.getElementById('welcome').innerHTML = `WELCOME <span style="color:var(--primary)">${name.toUpperCase()}</span>`;
    }
    
    // ---- FORM TOGGLE ----
    function toggleForm() {
      const fc = document.getElementById("formContainer");
      fc.style.display = fc.style.display === "none" ? "block" : "none";
      if (fc.style.display === "block") {
        document.getElementById("addBtn").textContent = "- Cancel";
      } else {
        document.getElementById("addBtn").textContent = "+ Add New Assessment";
      }
    }
    
    // ---- MULTIPLE ISSUES SYSTEM ----
    function addIssueField() {
      const container = document.getElementById('issuesContainer');
      const newIssue = document.createElement('div');
      newIssue.className = 'issue-input';
      newIssue.innerHTML = `
        <label>Additional Issue</label>
        <textarea class="issue-text" required></textarea>
        
        <label>Impact on Users & Company</label>
        <textarea class="impact-text" required></textarea>
        
        <label>Status</label>
        <select class="status-select" required>
          <option value="Good">Good</option>
          <option value="Fair">Fair</option>
          <option value="Bad">Bad</option>
          <option value="VeryBad">Very Bad</option>
        </select>
        
        <button type="button" class="add-issue-btn" style="background: var(--danger);" 
                onclick="this.parentElement.remove()">- Remove Issue</button>
      `;
      container.appendChild(newIssue);
    }
    
    // ---- IMAGE HANDLING ----
    function dataUrlFromFile(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = e => resolve({
          data: e.target.result,
          type: file.type,
          name: file.name
        });
        reader.readAsDataURL(file);
      });
    }
    
    // Open image in modal
    function openImageModal(src) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      modal.style.display = "block";
      modalImg.src = src;
      
      // Add modal styles dynamically
      modal.style.position = 'fixed';
      modal.style.zIndex = '1000';
      modal.style.left = '0';
      modal.style.top = '0';
      modal.style.width = '100%';
      modal.style.height = '100%';
      modal.style.backgroundColor = 'rgba(0,0,0,0.9)';
      modal.style.overflow = 'auto';
      
      modalImg.style.margin = 'auto';
      modalImg.style.display = 'block';
      modalImg.style.maxWidth = '90%';
      modalImg.style.maxHeight = '90%';
      modalImg.style.position = 'absolute';
      modalImg.style.top = '50%';
      modalImg.style.left = '50%';
      modalImg.style.transform = 'translate(-50%, -50%)';
      
      const closeSpan = document.querySelector('.close');
      closeSpan.style.position = 'absolute';
      closeSpan.style.top = '15px';
      closeSpan.style.right = '35px';
      closeSpan.style.color = '#f1f1f1';
      closeSpan.style.fontSize = '40px';
      closeSpan.style.fontWeight = 'bold';
      closeSpan.style.transition = '0.3s';
      closeSpan.style.cursor = 'pointer';
    }
    
    function closeModal() {
      document.getElementById('imageModal').style.display = "none";
    }
    
    // Close modal when clicking outside image
    window.onclick = function(event) {
      const modal = document.getElementById('imageModal');
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }
    
    // ---- ASSESSMENT CRUD ----
    let allAssessments = [];
    let unsubscribe = null;
    
    function listenAssessments() {
      const user = getCurrentUser();
      if (!user) return;
      
      if (unsubscribe) unsubscribe();
      
      // Listen to all assessments for team members
      unsubscribe = db.collection("ASSESSMENTS")
        .onSnapshot(snapshot => {
          allAssessments = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            data._id = doc.id;
            processAssessmentData(data);
            allAssessments.push(data);
          });
          renderAssessments();
        });
    }
    
    function processAssessmentData(data) {
      // Ensure arrays exist and are properly formatted
      data.images = Array.isArray(data.images) ? data.images : [];
      data.situationPics = Array.isArray(data.situationPics) ? data.situationPics : [];
      data.quotations = Array.isArray(data.quotations) ? data.quotations : [];
      data.comments = Array.isArray(data.comments) ? data.comments : [];
      data.issues = Array.isArray(data.issues) ? data.issues : [];
      
      // For backward compatibility - migrate single issue to issues array
      if (data.issue && data.impact && data.status && data.issues.length === 0) {
        data.issues.push({
          issue: data.issue,
          impact: data.impact,
          status: data.status
        });
      }
      
      return data;
    }
    
    // ---- RENDER CARDS GRID ----
    function renderAssessments() {
      const container = document.getElementById("assessments");
      container.innerHTML = "";
      
      if (allAssessments.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">No assessments found</p>';
        return;
      }
      
      // Sort by newest first
      const sortedAssessments = [...allAssessments].sort((a, b) => {
        return (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0);
      });
      
      sortedAssessments.forEach((assessment, index) => {
        container.appendChild(createAssessmentCard(assessment, index));
      });
    }
    
    function createAssessmentCard(assessment, index) {
      // Process the assessment data
      assessment = processAssessmentData(assessment);
      
      // Summary line
      const summary = document.createElement('div');
      summary.className = 'card-summary';
      summary.innerHTML = `
        <div class="company">${assessment.company || "No Company"}</div>
        <div class="location">${assessment.location || "No Location"}</div>
        <div class="deadline">Deadline: ${assessment.deadline || "None"}</div>
        <div class="status ${getWorstStatus(assessment) || ""}">${getWorstStatus(assessment) || "No Status"}</div>
      `;
      
      // Create card element
      const card = document.createElement('div');
      card.className = 'card collapsed';
      card.id = `card-${index}`;
      
      // Add click handler to toggle details
      card.addEventListener('click', function(e) {
        // Don't toggle if clicking on a link or button
        if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
        this.classList.toggle('collapsed');
      });
      
      // Details section
      const details = document.createElement('div');
      details.className = 'card-details';
      
      // Basic info
      const infoRow = document.createElement('div');
      infoRow.className = 'detail-row';
      infoRow.innerHTML = `
        <div class="detail-col">
          <p><b>Assessed By:</b> ${assessment.username || "Unknown"}</p>
          <p><b>Witness:</b> ${assessment.witness || "None"}</p>
        </div>
        <div class="detail-col">
          <p><b>Time:</b> ${formatDateTime(assessment.time) || "Unknown"}</p>
          <p><b>Deadline:</b> ${assessment.deadline || "None"}</p>
        </div>
      `;
      details.appendChild(infoRow);
      
      // Issues list
      if (assessment.issues && assessment.issues.length > 0) {
        const issuesContainer = document.createElement('div');
        issuesContainer.className = 'issues-list';
        
        assessment.issues.forEach((issue, i) => {
          const issueElement = document.createElement('div');
          issueElement.className = 'issue-item';
          issueElement.innerHTML = `
            <h4>Issue #${i+1}</h4>
            <p><b>Description:</b> ${issue.issue || "No description"}</p>
            <p><b>Impact:</b> ${issue.impact || "No impact specified"}</p>
            <p><b>Status:</b> <span class="status ${issue.status || ""}">${issue.status || "Unknown"}</span></p>
          `;
          issuesContainer.appendChild(issueElement);
        });
        
        details.appendChild(issuesContainer);
      }
      
      // Images sections
      const imagesContainer = document.createElement('div');
      imagesContainer.className = 'images-container';
      
      // Initial images
      if (assessment.images && assessment.images.length > 0) {
        const imagesSection = document.createElement('div');
        imagesSection.className = 'images-section';
        imagesSection.innerHTML = '<h4>Initial Attachments</h4><div class="images-grid"></div>';
        
        assessment.images.forEach(img => {
          const imgLink = document.createElement('a');
          imgLink.href = '#';
          imgLink.onclick = (e) => { e.preventDefault(); openImageModal(img.data); };
          imgLink.innerHTML = `<img src="${img.data}" alt="Assessment Image">`;
          imagesSection.querySelector('.images-grid').appendChild(imgLink);
        });
        
        imagesContainer.appendChild(imagesSection);
      }
      
      // Situation pics
      if (assessment.situationPics && assessment.situationPics.length > 0) {
        const situationSection = document.createElement('div');
        situationSection.className = 'images-section';
        situationSection.innerHTML = '<h4>Situation Pictures</h4><div class="images-grid"></div>';
        
        assessment.situationPics.forEach(img => {
          const imgLink = document.createElement('a');
          imgLink.href = '#';
          imgLink.onclick = (e) => { e.preventDefault(); openImageModal(img.data); };
          imgLink.innerHTML = `<img src="${img.data}" alt="Situation Image">`;
          situationSection.querySelector('.images-grid').appendChild(imgLink);
        });
        
        imagesContainer.appendChild(situationSection);
      }
      
      // Quotations
      if (assessment.quotations && assessment.quotations.length > 0) {
        const quotationsSection = document.createElement('div');
        quotationsSection.className = 'images-section';
        quotationsSection.innerHTML = '<h4>Quotations</h4><div class="images-grid"></div>';
        
        assessment.quotations.forEach(quote => {
          const quoteElement = document.createElement('a');
          
          if (quote.type && quote.type.startsWith('image/')) {
            quoteElement.href = '#';
            quoteElement.onclick = (e) => { e.preventDefault(); openImageModal(quote.data); };
            quoteElement.innerHTML = `<img src="${quote.data}" alt="Quotation Image">`;
          } else if (quote.type && quote.type.includes('pdf')) {
            quoteElement.href = quote.data;
            quoteElement.target = '_blank';
            quoteElement.className = 'pdf-thumbnail';
            quoteElement.innerHTML = 'PDF Document<br>' + (quote.name || 'Quotation');
          } else {
            quoteElement.href = quote.data;
            quoteElement.target = '_blank';
            quoteElement.className = 'pdf-thumbnail';
            quoteElement.innerHTML = 'Document<br>' + (quote.name || 'Quotation');
          }
          
          quotationsSection.querySelector('.images-grid').appendChild(quoteElement);
        });
        
        imagesContainer.appendChild(quotationsSection);
      }
      
      details.appendChild(imagesContainer);
      
      // Add all elements to card
      card.appendChild(summary);
      card.appendChild(details);
      
      return card;
    }
    
    function getWorstStatus(assessment) {
      if (!assessment.issues || assessment.issues.length === 0) {
        return assessment.status || 'Good'; // Default if no status
      }
      
      const statusPriority = {
        'VeryBad': 4,
        'Bad': 3,
        'Fair': 2,
        'Good': 1
      };
      
      let worstStatus = 'Good';
      let highestPriority = 1;
      
      assessment.issues.forEach(issue => {
        const priority = statusPriority[issue.status] || 1;
        if (priority > highestPriority) {
          highestPriority = priority;
          worstStatus = issue.status;
        }
      });
      
      return worstStatus;
    }
    
    function formatDateTime(dateString) {
      if (!dateString) return '';
      
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      } catch (e) {
        return dateString;
      }
    }
    
    // ---- ADD ASSESSMENT ----
    document.getElementById("assessmentForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const user = getCurrentUser();
      if (!user) {
        alert("You must be logged in to submit an assessment");
        return;
      }
      
      // Collect form data
      const formData = {
        username: user,
        company: document.getElementById("company").value,
        location: document.getElementById("location").value,
        witness: document.getElementById("witness").value,
        time: document.getElementById("time").value,
        deadline: document.getElementById("deadline").value,
        comments: [],
        createdAt: new Date()
      };
      
      // Collect issues from all issue fields
      const issueInputs = document.querySelectorAll('.issue-input');
      formData.issues = [];
      
      for (let i = 0; i < issueInputs.length; i++) {
        const issue = issueInputs[i].querySelector('.issue-text').value;
        const impact = issueInputs[i].querySelector('.impact-text').value;
        const status = issueInputs[i].querySelector('.status-select').value;
        
        if (issue && impact && status) {
          formData.issues.push({
            issue,
            impact,
            status
          });
        }
      }
      
      // Check if we have at least one valid issue
      if (formData.issues.length === 0) {
        const errorEl = document.getElementById("formError");
        errorEl.textContent = "At least one valid issue is required";
        errorEl.style.display = 'block';
        return;
      }
      
      // Process file uploads
      const images = document.getElementById("images").files;
      const situationPics = document.getElementById("situationPics").files;
      const quotations = document.getElementById("quotations").files;
      const comment = document.getElementById("comment").value;
      
      // Add optional comment
      if (comment) {
        formData.comments.push(comment);
      }
      
      // Convert files to base64
      async function processFiles(fileList) {
        if (!fileList || fileList.length === 0) return [];
        const promises = [];
        for (let i = 0; i < fileList.length; i++) {
          promises.push(dataUrlFromFile(fileList[i]));
        }
        return await Promise.all(promises);
      }
      
      try {
        const [imagesData, situationData, quotationsData] = await Promise.all([
          processFiles(images),
          processFiles(situationPics),
          processFiles(quotations)
        ]);
        
        formData.images = imagesData;
        formData.situationPics = situationData;
        formData.quotations = quotationsData;
        
        // Save to Firestore
        await db.collection("ASSESSMENTS").add(formData);
        
        // Reset form
        document.getElementById("assessmentForm").reset();
        document.getElementById("issuesContainer").innerHTML = `
          <div class="issue-input">
            <label>Issue</label>
            <textarea class="issue-text" required></textarea>
            
            <label>Impact on Users & Company</label>
            <textarea class="impact-text" required></textarea>
            
            <label>Status</label>
            <select class="status-select" required>
              <option value="Good">Good</option>
              <option value="Fair">Fair</option>
              <option value="Bad">Bad</option>
              <option value="VeryBad">Very Bad</option>
            </select>
          </div>
        `;
        document.getElementById("formContainer").style.display = "none";
        document.getElementById("addBtn").textContent = "+ Add New Assessment";
        document.getElementById("formError").style.display = "none";
      } catch (err) {
        const errorEl = document.getElementById("formError");
        errorEl.textContent = "Error saving assessment: " + (err.message || err);
        errorEl.style.display = 'block';
        console.error("Assessment submission error:", err);
      }
    });
    
    // ---- INIT ----
    window.onload = function() {
      const user = getCurrentUser();
      if (!user) { 
        location.href = "index.html"; 
        return; 
      }
      
      showWelcome(user);
      listenAssessments();
      
      // Close modal with ESC key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeModal();
        }
      });
    }
  </script>
</body>

</html>
