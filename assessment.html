<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Assessment Tracker</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
  <style>
    html, body {
      min-height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      background: #f5f7fa;
      color: #222;
      font-family: 'Segoe UI', Arial, sans-serif;
      box-sizing: border-box;
    }
    body {
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100vw;
      background: #fff;
      padding: 0;
    }
    .welcome {
      font-size: 1.1em;
      color: #1976d2;
      text-align: center;
      margin: 22px 0 8px;
      letter-spacing: 0.5px;
      font-weight: 600;
      width: 100vw;
    }
    .header-bar {
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f5f7fa;
      box-shadow: 0 2px 8px #0001;
      padding: 0 3vw 0 3vw;
      margin-bottom: 0;
      min-height: 54px;
    }
    .header-bar h2 {
      margin: 0;
      color: #1976d2;
      font-weight: 700;
      font-size: 1.25em;
      letter-spacing: 1px;
    }
    .btn-logout, .btn-toggle {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 9px 28px;
      font-size: 1em;
      font-weight: 600;
      margin: 13px 8px;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 8px #0001;
    }
    .btn-logout {
      background: #b71c1c;
    }
    .btn-toggle:hover { background: #1358a7; }
    .btn-logout:hover { background: #7b1212; }
    .form-container {
      background: #fff;
      border-radius: 13px;
      box-shadow: 0 4px 28px #0002;
      max-width: 98vw;
      width: 460px;
      margin: 20px auto 10px;
      padding: 18px 14px 12px;
      color: #222;
      border: 1px solid #e0e4e9;
    }
    label { font-weight: bold; margin-top: 10px; display: block; color: #1976d2;}
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      margin-top: 4px;
      background: #f8fafc;
      border: 1.2px solid #b5c4d6;
      border-radius: 7px;
      font-size: 1em;
      color: #222;
      margin-bottom: 4px;
      transition: border 0.18s;
      box-sizing: border-box;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #1976d2;
      background: #fff;
    }
    textarea { resize: vertical; min-height: 42px; }
    .btn-submit {
      margin-top: 18px;
      padding: 12px 0;
      width: 100%;
      background: #1976d2;
      border: none;
      color: #fff;
      font-size: 1.07em;
      border-radius: 7px;
      cursor: pointer;
      font-weight: 600;
      transition: background .18s;
    }
    .btn-submit:hover { background: #1453a3; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(310px, 1fr));
      gap: 20px;
      margin: 0 auto 40px;
      max-width: 1200px;
      width: 100vw;
      padding: 0 4vw 20px;
    }
    .card {
      background: #fff;
      border-radius: 13px;
      box-shadow: 0 2px 18px 0 #0001;
      border: 1.5px solid #e0e4e9;
      color: #222;
      cursor: pointer;
      transition: box-shadow 0.18s, border 0.13s;
      position: relative;
      overflow: hidden;
      width: 100%;
      min-width: 0;
    }
    .card.collapsed .card-details { display: none; }
    .card-summary {
      font-weight: bold;
      font-size: 1.09em;
      background: #f2f6fb;
      padding: 17px 15px 10px;
      border-bottom: 1px solid #e0e4e9;
      color: #1976d2;
      letter-spacing: 0.5px;
      user-select: none;
    }
    .card-summary span {
      margin-right: 8px;
      color: #444;
      font-size: 0.98em;
      font-weight: 400;
    }
    .card .deadline {
      color: #c9821c;
      margin-left: 4px;
      font-size: 0.99em;
      font-weight: 500;
    }
    .status {
      font-weight: bold;
      padding: 4px 13px;
      border-radius: 6px;
      display: inline-block;
      margin-top: 8px;
      font-size: 0.99em;
      letter-spacing: 0.5px;
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bcdffb;
    }
    .Good { background: #e2fbe7; color: #1976d2; border-color: #bcebc6; }
    .Fair { background: #fffbe2; color: #a3921a; border-color: #fbeab7; }
    .Bad { background: #ffeaea; color: #a32d2d; border-color: #fbbcbc; }
    .VeryBad { background: #ffe7ec; color: #b71c1c; border-color: #ffb4c7; }
    .images img, .situation img, .quotations img {
      max-width: 99px;
      max-height: 80px;
      margin: 5px 7px 5px 0;
      border-radius: 7px;
      border: 1px solid #e0e4e9;
      background: #f8fafc;
    }
    .images, .situation, .quotations {
      margin-top: 9px;
      margin-bottom: 5px;
      overflow-x: auto;
      white-space: nowrap;
    }
    .comment-section { margin-top: 15px; border-top: 1px solid #e0e4e9; padding-top: 12px; }
    .comment-list { margin-bottom: 10px; }
    .comment-list p {
      margin: 3px 0;
      padding: 6px 12px;
      background: #f2f6fb;
      border-radius: 5px;
      font-size: 0.96em;
      color: #1976d2;
    }
    .comment-form textarea { width: 100%; min-height: 40px; margin-bottom: 7px; }
    .comment-form button {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 7px 22px;
      cursor: pointer;
      font-size: 0.97em;
      font-weight: 600;
      margin-top: 2px;
    }
    .comment-form button:hover { background: #1453a3;}
    @media (max-width: 700px) {
      .header-bar, .welcome {
        padding-left: 0;
        padding-right: 0;
        font-size: 0.95em;
      }
      .form-container { max-width: 99vw; border-radius: 0; padding: 12px 3vw 8px; }
      .grid { padding: 0 1vw 16px; gap: 13px; }
      .card { border-radius: 7px; }
      .card-summary { padding: 13px 11px 8px; font-size: 1em;}
      input, textarea, select { font-size: 1em; padding: 8px 7px;}
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <h2>Assessment Tracker</h2>
    <button class="btn-logout" onclick="logout()">Logout</button>
  </div>
  <div class="welcome" id="welcome"></div>
  <button class="btn-toggle" id="addBtn" onclick="toggleForm()">+ Add New Assessment</button>
  <div class="form-container" id="formContainer" style="display: none;">
    <form id="assessmentForm">
      <label>Company</label>
      <input type="text" id="company" required>
      <label>Location</label>
      <input type="text" id="location" required>
      <label>Assessed By</label>
      <input type="text" id="assessedBy" required>
      <label>Witness Name</label>
      <input type="text" id="witness" required>
      <label>Time of Assessment</label>
      <input type="datetime-local" id="time" required>
      <label>Deadline</label>
      <input type="date" id="deadline" required>
      <label>Issue</label>
      <textarea id="issue" required></textarea>
      <label>Impact on Users & Company</label>
      <textarea id="impact" required></textarea>
      <label>Status</label>
      <select id="status" required>
        <option value="Good">Good</option>
        <option value="Fair">Fair</option>
        <option value="Bad">Bad</option>
        <option value="VeryBad">Very Bad</option>
      </select>
      <label>Upload Pictures (Optional)</label>
      <input type="file" id="images" multiple accept="image/*">
      <label>Situation Pictures (Optional, update anytime)</label>
      <input type="file" id="situationPics" multiple accept="image/*">
      <label>Quotations (Optional, update anytime)</label>
      <input type="file" id="quotations" multiple accept="image/*,application/pdf">
      <label>Comment (Optional)</label>
      <textarea id="comment"></textarea>
      <button type="submit" class="btn-submit">Save Assessment</button>
      <div id="formError" style="color: #b71c1c; margin-top: 8px; font-size:0.99em;"></div>
    </form>
  </div>
  <div class="grid" id="assessments"></div>
  <script>
    // ---- FIREBASE SETUP ----
    const firebaseConfig = {
      apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
      authDomain: "project-task-588c4.firebaseapp.com",
      projectId: "project-task-588c4",
      storageBucket: "project-task-588c4.appspot.com",
      messagingSenderId: "411882772509",
      appId: "1:411882772509:web:08d613186c101a99f38ef4",
      measurementId: "G-JMFLFYEM0F"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---- USER ----
    function getCurrentUser() {
      return localStorage.getItem('currentUser') || null;
    }
    function logout() {
      localStorage.removeItem('currentUser');
      location.href = "login.html";
    }
    // ---- UI/UX ----
    function showWelcome(user) {
      let name = user.trim().split(" ");
      name = name.length === 1 ? name[0] : name.slice(-2).join(" ");
      document.getElementById('welcome').innerHTML = `WELCOME <span style="color:#1976d2">${name.toUpperCase()}</span>`;
    }
    // ---- FORM TOGGLE ----
    function toggleForm() {
      const fc = document.getElementById("formContainer");
      fc.style.display = fc.style.display === "none" ? "block" : "none";
    }

    // ---- IMAGE READ ----
    function dataUrlFromFile(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.readAsDataURL(file);
      });
    }

    // ---- ASSESSMENT CRUD ----
    let userAssessments = [];
    let unsubscribe = null;

    function listenAssessments() {
      const user = getCurrentUser();
      if (unsubscribe) unsubscribe();
      // DEBUG: Show all docs for this user in the console
      unsubscribe = db.collection("ASSEMEMNT NAME")
        .onSnapshot(snapshot => {
          userAssessments = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            data._id = doc.id;
            // Fix: ensure arrays are always arrays (for old records)
            data.images = Array.isArray(data.images) ? data.images : [];
            data.situationPics = Array.isArray(data.situationPics) ? data.situationPics : [];
            data.quotations = Array.isArray(data.quotations) ? data.quotations : [];
            data.comments = Array.isArray(data.comments) ? data.comments : [];
            // Only push if username matches (case-insensitive)
            if (data.username && user && data.username.toLowerCase() === user.toLowerCase()) {
              userAssessments.push(data);
            }
          });
          renderAssessments();
        });
    }

    // ---- RENDER CARDS GRID ----
    function renderAssessments() {
      const container = document.getElementById("assessments");
      container.innerHTML = "";
      userAssessments.forEach((a, index) => {
        // Summary line
        const summary = `
          <div class="card-summary">
            <span>${a.company || ""}</span>
            <span>${a.location || ""}</span>
            <span class="deadline">Deadline: ${a.deadline || ""}</span>
            <span class="status ${a.status ? a.status.replace(" ","") : ""}">${a.status || ""}</span>
          </div>
        `;
        // Details
        let imagesHTML = (a.images || []).map(url =>
          `<img src="${url}" alt="Assessment Image">`).join('');
        let situationHTML = (a.situationPics || []).map(url =>
          `<img src="${url}" alt="Situation Image">`).join('');
        let quotationsHTML = (a.quotations || []).map(q =>
          q.type && q.type.startsWith('image/') ?
            `<img src="${q.data}" alt="Quotation Image">`
            : (q.type && q.type.includes('pdf') ?
              `<a href="${q.data}" target="_blank">PDF Quotation</a>` : '')
        ).join('');
        const comments = a.comments || [];
        let commentsHTML = '<div class="comment-list">';
        comments.forEach(c => { commentsHTML += `<p>${c}</p>`; });
        commentsHTML += '</div>';
        let commentForm = `
          <form class="comment-form" onsubmit="return addComment('${a._id}', this);event.stopPropagation();">
            <textarea required placeholder="Add comment..."></textarea>
            <button type="submit">Add Comment</button>
          </form>
        `;
        const details = `
          <div class="card-details" style="padding: 15px 18px 7px;">
            <p><b>Assessed By:</b> ${a.assessedBy || ""}</p>
            <p><b>Witness:</b> ${a.witness || ""}</p>
            <p><b>Time:</b> ${a.time || ""}</p>
            <p><b>Deadline:</b> ${a.deadline || ""}</p>
            <p><b>Issue:</b> ${a.issue || ""}</p>
            <p><b>Impact:</b> ${a.impact || ""}</p>
            <p>
              <b>Status:</b>
              <span class="status ${a.status ? a.status.replace(" ","") : ""}">${a.status || ""}</span>
            </p>
            <div class="images"><b>Initial Attachments:</b><br>${imagesHTML}</div>
            <div class="situation"><b>Situation Pics:</b><br>${situationHTML}</div>
            <div class="quotations"><b>Quotations:</b><br>${quotationsHTML}</div>
            <div class="comment-section">
              <label>Comments</label>
              ${commentsHTML}
              ${commentForm}
            </div>
          </div>
        `;
        const card = `
          <div class="card collapsed" id="card-${index}" onclick="toggleCardDetails(${index})">
            ${summary}
            ${details}
          </div>
        `;
        container.insertAdjacentHTML("beforeend", card);
      });
      // Add collapsed class to all
      userAssessments.forEach((_,i) => {
        const card = document.getElementById('card-'+i);
        if(card) card.classList.add('collapsed');
      });
    }
    // Card expand/collapse logic
    function toggleCardDetails(idx) {
      const card = document.getElementById('card-'+idx);
      if(card) card.classList.toggle('collapsed');
    }
    window.toggleCardDetails = toggleCardDetails;

    // ---- ADD ASSESSMENT ----
    document.getElementById("assessmentForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const user = getCurrentUser();
      const company = document.getElementById("company").value;
      const location = document.getElementById("location").value;
      const assessedBy = document.getElementById("assessedBy").value;
      const witness = document.getElementById("witness").value;
      const time = document.getElementById("time").value;
      const deadline = document.getElementById("deadline").value;
      const issue = document.getElementById("issue").value;
      const impact = document.getElementById("impact").value;
      const status = document.getElementById("status").value;
      const images = document.getElementById("images").files;
      const situationPics = document.getElementById("situationPics").files;
      const quotations = document.getElementById("quotations").files;
      const comment = document.getElementById("comment").value;
      const formError = document.getElementById("formError");
      formError.textContent = "";

      // Convert files to base64
      async function filesToUrls(files) {
        if(!files.length) return [];
        let arr = [];
        for(let i=0; i<files.length; i++) {
          arr.push(await dataUrlFromFile(files[i]));
        }
        return arr;
      }
      async function filesToQuots(files) {
        if(!files.length) return [];
        let arr = [];
        for(let i=0; i<files.length; i++) {
          let url = await dataUrlFromFile(files[i]);
          arr.push({type: files[i].type, data: url});
        }
        return arr;
      }

      try {
        const [imgArr, sitArr, quotArr] = await Promise.all([
          filesToUrls(images),
          filesToUrls(situationPics),
          filesToQuots(quotations)
        ]);
        let assessment = {
          username: user,
          company, location, assessedBy, witness, time, deadline, issue, impact, status,
          images: imgArr, situationPics: sitArr, quotations: quotArr,
          comments: comment ? [comment] : [],
          createdAt: new Date()
        };
        await db.collection("ASSEMEMNT NAME").add(assessment);
        document.getElementById("assessmentForm").reset();
        document.getElementById("formContainer").style.display = "none";
      } catch (err) {
        formError.textContent = "Error saving assessment: " + (err.message || err);
      }
    });

    // ---- ADD COMMENT ----
    window.addComment = async function(docId, form) {
      const textarea = form.querySelector('textarea');
      const val = textarea.value.trim();
      if (!val) return false;
      try {
        const docRef = db.collection("ASSEMEMNT NAME").doc(docId);
        const doc = await docRef.get();
        let comments = doc.exists && doc.data().comments ? doc.data().comments : [];
        comments.push(val);
        await docRef.update({ comments });
        textarea.value = "";
      } catch (err) {
        alert("Failed to add comment: " + (err.message || err));
      }
      return false;
    }

    // ---- INIT ----
    window.onload = function() {
      const user = getCurrentUser();
      if (!user) { location.href = "login.html"; return; }
      showWelcome(user);
      listenAssessments();
    }
  </script>
</body>
</html>