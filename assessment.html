<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Work Assessment Tracker</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Construction Theme Colors */
      --primary: #2a5f8a;
      --primary-light: #3a7cb9;
      --primary-dark: #1d4568;
      --secondary: #f7931e;
      --secondary-light: #ffae4d;
      --secondary-dark: #e07c0d;
      --success: #4CAF50;
      --danger: #F44336;
      --warning: #FF9800;
      --info: #2196F3;
      --text: #333;
      --light-bg: #f5f7fa;
      --card-bg: #fff;
      --border: #e0e4e9;
      --approved-color: #2e7d32;
      --resolved-color: #1565c0;
    }
    html, body {
      min-height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      background: var(--light-bg);
      color: var(--text);
      font-family: 'Segoe UI', Arial, sans-serif;
      box-sizing: border-box;
      font-size: 14px; /* Slightly smaller base font size */
    }
    body {
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100vw;
      background: var(--card-bg);
      padding: 0;
    }
    .welcome {
      font-size: 1em; /* Reduced from 1.1em */
      color: var(--primary);
      text-align: center;
      margin: 0;
      letter-spacing: 0.5px;
      font-weight: 600;
      width: 100vw;
      background: var(--light-bg);
      padding: 10px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .header-bar {
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--primary);
      color: white;
      padding: 0 3vw;
      margin-bottom: 0;
      min-height: 54px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .header-bar h2 {
      margin: 0;
      color: white;
      font-weight: 700;
      font-size: 1.2em; /* Reduced from 1.25em */
      letter-spacing: 1px;
    }
    .header-controls {
      display: flex;
      gap: 10px;
    }
    .btn {
      background: var(--secondary);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 8px 16px; /* Slightly smaller padding */
      font-size: 0.9em; /* Reduced from 0.95em */
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn i {
      font-size: 1em; /* Reduced from 1.1em */
    }
    .btn-logout {
      background: var(--danger);
    }
    .btn-toggle:hover { background: var(--secondary-dark); }
    .btn-logout:hover { background: #c62828; }
    .btn-success {
      background: var(--success);
    }
    .btn-info {
      background: var(--info);
    }
    .form-container {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      max-width: 98vw;
      width: 460px;
      margin: 20px auto 10px;
      padding: 16px 12px 10px; /* Slightly reduced padding */
      color: var(--text);
      border: 1px solid var(--border);
    }
    label { 
      font-weight: bold; 
      margin-top: 10px; 
      display: block; 
      color: var(--primary);
      font-size: 0.9em; /* Reduced from 0.95em */
    }
    input, textarea, select {
      width: 100%;
      padding: 9px 11px; /* Slightly reduced padding */
      margin-top: 4px;
      background: #f8fafc;
      border: 1.2px solid #b5c4d6;
      border-radius: 5px;
      font-size: 0.95em; /* Slightly smaller font */
      color: var(--text);
      margin-bottom: 4px;
      transition: all 0.18s;
      box-sizing: border-box;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(42, 95, 138, 0.2);
    }
    textarea { 
      resize: vertical; 
      min-height: 42px; 
      font-family: inherit;
    }
    .btn-submit {
      margin-top: 18px;
      padding: 11px 0; /* Slightly reduced padding */
      width: 100%;
      background: var(--primary);
      border: none;
      color: #fff;
      font-size: 1.05em; /* Reduced from 1.07em */
      border-radius: 7px;
      cursor: pointer;
      font-weight: 600;
      transition: all .18s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .btn-submit:hover { 
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    /* Improved Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 15px;
      margin: 0 auto 40px;
      max-width: 1400px;
      width: 100vw;
      padding: 0 4vw 20px;
    }
    
    /* Enhanced Card Design */
    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      width: 100%;
      min-width: 0;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      border-color: var(--primary-light);
    }
    .card.collapsed .card-details { display: none; }
    .card-summary {
      font-weight: bold;
      font-size: 1.05em; /* Reduced from 1.09em */
      background: #f2f6fb;
      padding: 14px; /* Slightly reduced padding */
      border-bottom: 1px solid var(--border);
      color: var(--primary);
      letter-spacing: 0.5px;
      user-select: none;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }
    .card.approved {
      border-left: 4px solid var(--approved-color);
    }
    .card.resolved {
      border-left: 4px solid var(--resolved-color);
    }
    .card-summary .company {
      font-weight: 700;
      color: var(--primary);
      flex: 1;
      min-width: 120px;
      font-size: 0.95em; /* Added font size */
    }
    .card-summary .location {
      color: #555;
      font-size: 0.9em; /* Reduced from 0.95em */
      flex: 1;
      min-width: 100px;
    }
    .card .deadline {
      color: var(--warning);
      font-size: 0.9em; /* Reduced from 0.95em */
      font-weight: 500;
      white-space: nowrap;
    }
    .status {
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 4px;
      display: inline-block;
      margin-top: 0;
      font-size: 0.85em; /* Reduced from 0.9em */
      letter-spacing: 0.5px;
      background: #e3f2fd;
      color: var(--primary);
      border: 1px solid #bcdffb;
      white-space: nowrap;
    }
    .Good { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
    .Fair { background: #fff8e1; color: #ff8f00; border-color: #ffe0b2; }
    .Bad { background: #ffebee; color: #c62828; border-color: #ffcdd2; }
    .VeryBad { background: #fce4ec; color: #ad1457; border-color: #f8bbd0; }
    .approved-badge {
      background: #e8f5e9;
      color: var(--approved-color);
      border: 1px solid #c8e6c9;
    }
    .resolved-badge {
      background: #e3f2fd;
      color: var(--resolved-color);
      border: 1px solid #bbdefb;
    }
    
    /* Improved Image Gallery */
    .images-container {
      margin: 15px 0;
    }
    .images-section {
      margin-bottom: 15px;
    }
    .images-section h4 {
      margin: 0 0 8px 0;
      color: var(--primary);
      font-size: 0.9em; /* Reduced from 0.95em */
    }
    .images-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .images-grid a {
      display: block;
      width: 100px;
      height: 80px;
      border-radius: 5px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: #f8fafc;
      position: relative;
      transition: all 0.2s;
    }
    .images-grid a:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    .images-grid a img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s;
    }
    .pdf-thumbnail {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f1f5f9;
      color: var(--primary);
      font-size: 0.75em; /* Reduced from 0.8em */
      text-align: center;
      padding: 5px;
    }
    
    /* Card Details Layout */
    .card-details {
      padding: 14px; /* Slightly reduced padding */
    }
    .detail-row {
      display: flex;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .detail-col {
      flex: 1;
      min-width: 150px;
      margin-right: 15px;
    }
    .detail-col:last-child {
      margin-right: 0;
    }
    .detail-row p {
      margin: 5px 0;
      font-size: 0.9em; /* Reduced from 0.95em */
    }
    .detail-row b {
      color: var(--primary);
      font-size: 0.9em; /* Added font size */
    }
    
    /* Issues List */
    .issues-list {
      margin: 10px 0;
    }
    .issue-item {
      background: #f8fafc;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 8px;
      border-left: 3px solid var(--primary);
      transition: all 0.3s;
    }
    .issue-item.focused {
      background: white;
      box-shadow: 0 0 0 2px var(--primary-light);
      z-index: 10;
      position: relative;
    }
    .issue-item.blurred {
      opacity: 0.5;
      filter: blur(2px);
    }
    .issue-item h4 {
      margin: 0 0 5px 0;
      color: var(--primary);
      font-size: 0.9em; /* Reduced from 0.95em */
    }
    .issue-item p {
      margin: 5px 0;
      font-size: 0.85em; /* Reduced from 0.9em */
    }
    .add-issue-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      font-size: 0.85em; /* Reduced from 0.9em */
      cursor: pointer;
      margin-top: 5px;
      display: inline-block;
      transition: all 0.2s;
    }
    .add-issue-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .action-buttons button {
      padding: 6px 12px;
      font-size: 0.8em; /* Reduced from 0.85em */
    }
    
    /* Form Error */
    #formError {
      color: var(--danger);
      margin-top: 8px;
      font-size: 0.9em; /* Reduced from 0.95em */
      padding: 8px;
      background: #ffebee;
      border-radius: 4px;
      border-left: 3px solid var(--danger);
    }
    
    /* Filter Controls */
    .filter-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85em; /* Reduced from 0.9em */
    }
    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Date Filter Controls */
    .date-filter {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
      padding: 0 4vw;
    }
    .date-filter input {
      width: 150px;
      padding: 8px;
      font-size: 0.9em;
    }
    .date-filter button {
      padding: 8px 16px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background: var(--primary);
      color: white;
      cursor: pointer;
      font-size: 0.9em;
    }
    .date-filter button:hover {
      background: var(--primary-dark);
    }
    
    /* Modal for image viewing */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
      overflow: auto;
    }
    .modal-content {
      margin: auto;
      display: block;
      max-width: 90%;
      max-height: 90%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .close {
      position: absolute;
      top: 15px;
      right: 35px;
      color: #f1f1f1;
      font-size: 40px;
      font-weight: bold;
      transition: 0.3s;
      cursor: pointer;
    }
    .close:hover {
      color: #bbb;
    }
    
    /* Loading indicator */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive Design */
    @media (max-width: 700px) {
      body {
        font-size: 13px; /* Slightly smaller base font on mobile */
      }
      .header-bar, .welcome {
        padding-left: 3vw;
        padding-right: 3vw;
      }
      .header-controls {
        gap: 6px;
      }
      .btn {
        padding: 7px 10px; /* Slightly smaller padding on mobile */
        font-size: 0.85em; /* Reduced from 0.9em */
      }
      .form-container { 
        max-width: 94vw; 
        border-radius: 0; 
        padding: 10px 3vw 6px; /* Reduced padding on mobile */
        box-shadow: none;
        border-left: none;
        border-right: none;
      }
      .grid { 
        padding: 0 3vw 16px; 
        gap: 12px; 
        grid-template-columns: 1fr;
      }
      .card { 
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      }
      .card-summary { 
        padding: 12px; 
        font-size: 0.95em; /* Reduced from 1em */
        flex-direction: column;
        align-items: flex-start;
      }
      .card-summary .company,
      .card-summary .location {
        min-width: 100%;
      }
      input, textarea, select { 
        font-size: 0.95em; /* Reduced from 1em */
        padding: 8px 10px;
      }
      .detail-col {
        min-width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
      }
      .filter-controls {
        gap: 6px;
      }
      .filter-btn {
        padding: 6px 12px;
        font-size: 0.8em; /* Reduced from 0.85em */
      }
      .date-filter {
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      .date-filter input {
        width: 80%;
      max-width: 200px;
      }
    }
    
    /* Animation for form toggle */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .form-container {
      animation: fadeIn 0.3s ease-out;
    }
    
    /* Edit mode styles */
    .edit-mode .issue-item:not(.focused) {
      opacity: 0.5;
      filter: blur(2px);
    }
    .edit-mode .issue-item.focused {
      background: white;
      box-shadow: 0 0 0 2px var(--primary-light);
    }
    .card.zoomed {
      z-index: 2;
      box-shadow: 0 0 0 2px var(--primary-light), 0 5px 30px rgba(0,0,0,0.23);
      transform: scale(1.01);
      background: #fff;
    }

    .card.blurred {
      filter: blur(3px) grayscale(40%);
      opacity: 0.7;
      pointer-events: none;
      transition: filter 0.2s, opacity 0.18s;
    }
  </style>
</head>
<body>
  <div class="header-bar">
    
    <h2>PENTA CONSTRUCTION IMS</h2>
    <div class="header-controls">
      <button class="btn btn-toggle" id="addBtn" onclick="toggleForm()">
        <i class="fas fa-plus"></i> Add New
      </button>
      <button class="btn btn-logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>
  <div class="welcome" id="welcome"></div>
  
  <div class="filter-controls" id="filterControls">
    <button class="filter-btn active" data-filter="all">All Assessments</button>
    <button class="filter-btn" data-filter="pending">Pending</button>
    <button class="filter-btn" data-filter="approved">Approved</button>
    <button class="filter-btn" data-filter="resolved">Resolved</button>
  </div>
  
  <div class="date-filter" id="dateFilter">
    <input type="date" id="startDate" placeholder="Start Date">
    <input type="date" id="endDate" placeholder="End Date">
    <button onclick="applyDateFilter()">Apply Date Filter</button>
    <button onclick="clearDateFilter()">Clear Filter</button>
  </div>
  
  <div id="userView">
    <div class="form-container" id="formContainer" style="display: none;">
      <form id="assessmentForm">
        <input type="hidden" id="assessmentId">
        <input type="hidden" id="originalUsername">
        
        <label>Company</label>
        <input type="text" id="company" required>
        
        <label>Location</label>
        <input type="text" id="location" required>
        
        <label>Witness Name</label>
        <input type="text" id="witness" required>
        
        <label>Time of Assessment</label>
        <input type="datetime-local" id="time" required>
        
        <label>Deadline</label>
        <input type="date" id="deadline" required>
        
        <div id="issuesContainer">
          <!-- Issues will be added here -->
        </div>
        
        <button type="button" class="add-issue-btn" onclick="addIssueField()">
          <i class="fas fa-plus"></i> Add Another Issue
        </button>
        
        <label>Upload Pictures (Optional, max 15MB each)</label>
        <input type="file" id="images" multiple accept="image/*" onchange="validateFileSize(this)">
        
        <label>Situation Pictures (Optional, max 15MB each)</label>
        <input type="file" id="situationPics" multiple accept="image/*" onchange="validateFileSize(this)">
        
        <label>Quotations (Optional, max 15MB each)</label>
        <input type="file" id="quotations" multiple accept="image/*,application/pdf" onchange="validateFileSize(this)">
        
        <label>Comment (Optional)</label>
        <textarea id="comment"></textarea>
        
        <div class="action-buttons">
          <button type="submit" class="btn btn-submit" id="submitBtn">
            <i class="fas fa-save"></i> Save Assessment
          </button>
          <button type="button" class="btn btn-danger" id="cancelEdit" style="display: none;" onclick="cancelEdit()">
            <i class="fas fa-times"></i> Cancel Edit
          </button>
        </div>
        <div id="formError" style="display: none;"></div>
      </form>
    </div>
    <div class="grid" id="assessments"></div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="modalImage">
  </div>

<script>
// ---- CONFIGURATION ----
const ADMIN_USERS = ['faiyaz mulla', 'christopher'];
const GENERAL_PASSWORD = '12345';
const MAX_FILE_SIZE = 15 * 1024 * 1024; // 15MB in bytes

// ---- FIREBASE SETUP ----
const firebaseConfig = {
  apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
  authDomain: "project-task-588c4.firebaseapp.com",
  projectId: "project-task-588c4",
  storageBucket: "project-task-588c4.appspot.com",
  messagingSenderId: "411882772509",
  appId: "1:411882772509:web:08d613186c101a99f38ef4",
  measurementId: "G-JMFLFYEM0F"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---- USER MANAGEMENT ----
function getCurrentUser() {
  return localStorage.getItem('currentUser') || null;
}
function isAdmin(user) {
  if (!user) return false;
  return ADMIN_USERS.includes(user.toLowerCase());
}
function logout() {
  localStorage.removeItem('currentUser');
  localStorage.removeItem('currentFilter');
  localStorage.removeItem('dateFilter');
  location.href = "index.html";
}
function showWelcome(user) {
  let name = user.trim().split(" ");
  name = name.length === 1 ? name[0] : name.slice(-2).join(" ");
  document.getElementById('welcome').innerHTML = `WELCOME <span style="color:var(--primary)">${name.toUpperCase()}</span>`;
  if (isAdmin(user)) {
    document.getElementById('filterControls').style.display = 'flex';
    document.getElementById('dateFilter').style.display = 'flex';
  } else {
    document.getElementById('filterControls').style.display = 'none';
    document.getElementById('dateFilter').style.display = 'none';
  }
}

// ---- FORM TOGGLE ----
function toggleForm() {
  const fc = document.getElementById("formContainer");
  if (fc.style.display === "none") {
    resetForm();
    fc.style.display = "block";
    document.getElementById("addBtn").innerHTML = '<i class="fas fa-times"></i> Cancel';
  } else {
    fc.style.display = "none";
    document.getElementById("addBtn").innerHTML = '<i class="fas fa-plus"></i> Add New';
  }
}
function resetForm() {
  document.getElementById("assessmentForm").reset();
  document.getElementById("assessmentId").value = "";
  document.getElementById("originalUsername").value = "";
  document.getElementById("issuesContainer").innerHTML = `
    <div class="issue-input">
      <label>Issue</label>
      <textarea class="issue-text" required></textarea>
      <label>Impact on Users & Company</label>
      <textarea class="impact-text" required></textarea>
      <label>Status</label>
      <select class="status-select" required>
        <option value="Good">Good</option>
        <option value="Fair">Fair</option>
        <option value="Bad">Bad</option>
        <option value="VeryBad">Very Bad</option>
      </select>
    </div>
  `;
  document.getElementById("cancelEdit").style.display = "none";
  document.getElementById("formError").style.display = "none";
}
function cancelEdit() {
  resetForm();
  toggleForm();
}

// ---- FILE VALIDATION ----
function validateFileSize(input) {
  const files = input.files;
  for (let i = 0; i < files.length; i++) {
    if (files[i].size > MAX_FILE_SIZE) {
      alert(`File "${files[i].name}" exceeds the 15MB size limit. Please choose a smaller file.`);
      input.value = ''; // Clear the input
      return false;
    }
  }
  return true;
}

// ---- MULTIPLE ISSUES SYSTEM ----
function addIssueField(issueData = null) {
  const container = document.getElementById('issuesContainer');
  const newIssue = document.createElement('div');
  newIssue.className = 'issue-input';
  let issueValue = '';
  let impactValue = '';
  let statusValue = 'Good';
  if (issueData) {
    issueValue = issueData.issue || '';
    impactValue = issueData.impact || '';
    statusValue = issueData.status || 'Good';
  }
  newIssue.innerHTML = `
    <label>Additional Issue</label>
    <textarea class="issue-text" required>${issueValue}</textarea>
    <label>Impact on Users & Company</label>
    <textarea class="impact-text" required>${impactValue}</textarea>
    <label>Status</label>
    <select class="status-select" required>
      <option value="Good" ${statusValue === 'Good' ? 'selected' : ''}>Good</option>
      <option value="Fair" ${statusValue === 'Fair' ? 'selected' : ''}>Fair</option>
      <option value="Bad" ${statusValue === 'Bad' ? 'selected' : ''}>Bad</option>
      <option value="VeryBad" ${statusValue === 'VeryBad' ? 'selected' : ''}>Very Bad</option>
    </select>
    <button type="button" class="add-issue-btn" style="background: var(--danger);" 
            onclick="this.parentElement.remove()">
      <i class="fas fa-trash"></i> Remove Issue
    </button>
  `;
  container.appendChild(newIssue);
}

// ---- IMAGE HANDLING ----
function dataUrlFromFile(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = e => resolve({
      data: e.target.result,
      type: file.type,
      name: file.name
    });
    reader.readAsDataURL(file);
  });
}
function openImageModal(src) {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  modal.style.display = "block";
  modalImg.src = src;
}
function closeModal() {
  document.getElementById('imageModal').style.display = "none";
}
window.onclick = function(event) {
  const modal = document.getElementById('imageModal');
  if (event.target == modal) {
    modal.style.display = "none";
  }
}

// ---- ASSESSMENT CRUD ----
let allAssessments = [];
let unsubscribe = null;
let currentFilter = localStorage.getItem('currentFilter') || 'all';
let dateFilter = JSON.parse(localStorage.getItem('dateFilter')) || {};

function listenAssessments() {
  const user = getCurrentUser();
  if (!user) return;
  if (unsubscribe) unsubscribe();
  
  // Show loading state
  document.getElementById("assessments").innerHTML = `
    <div style="text-align:center; padding:20px; width:100%;">
      <div class="loading" style="border-top-color: var(--primary); margin:0 auto;"></div>
      <p style="color:#666; margin-top:10px;">Loading assessments...</p>
    </div>
  `;
  
  let query = db.collection("ASSESSMENTS");
  // Only admins see all assessments
  if (!isAdmin(user)) {
    query = query.where("username", "==", user);
  }
  unsubscribe = query.onSnapshot(snapshot => {
    allAssessments = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      data._id = doc.id;
      processAssessmentData(data);
      allAssessments.push(data);
    });
    renderAssessments();
    updateFilterButtons();
    updateDateFilterInputs();
  }, error => {
    console.error("Error loading assessments:", error);
    document.getElementById("assessments").innerHTML = `
      <p style="text-align:center; padding:20px; color:var(--danger);">
        Error loading assessments. Please refresh the page.
      </p>
    `;
  });
}
function processAssessmentData(data) {
  data.images = Array.isArray(data.images) ? data.images : [];
  data.situationPics = Array.isArray(data.situationPics) ? data.situationPics : [];
  data.quotations = Array.isArray(data.quotations) ? data.quotations : [];
  data.comments = Array.isArray(data.comments) ? data.comments : [];
  data.issues = Array.isArray(data.issues) ? data.issues : [];
  if (data.issue && data.impact && data.status && data.issues.length === 0) {
    data.issues.push({
      issue: data.issue,
      impact: data.impact,
      status: data.status
    });
  }
  if (!data.status) {
    data.status = getWorstStatus(data);
  }
  return data;
}
function renderAssessments() {
  const container = document.getElementById("assessments");
  container.innerHTML = "";
  let filteredAssessments = filterAssessments(allAssessments);
  
  // Apply date filter if set
  if (dateFilter.startDate || dateFilter.endDate) {
    filteredAssessments = applyDateFilterToAssessments(filteredAssessments);
  }
  
  if (filteredAssessments.length === 0) {
    container.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">No assessments found</p>';
    return;
  }
  const sortedAssessments = [...filteredAssessments].sort((a, b) => {
    return (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0);
  });
  sortedAssessments.forEach((assessment, index) => {
    container.appendChild(createAssessmentCard(assessment, index));
  });
}
function filterAssessments(assessments) {
  switch(currentFilter) {
    case 'pending': return assessments.filter(a => !a.approved && !a.resolved);
    case 'approved': return assessments.filter(a => a.approved && !a.resolved);
    case 'resolved': return assessments.filter(a => a.resolved);
    default: return assessments;
  }
}
function applyDateFilterToAssessments(assessments) {
  const startDate = dateFilter.startDate ? new Date(dateFilter.startDate) : null;
  const endDate = dateFilter.endDate ? new Date(dateFilter.endDate) : null;
  
  if (startDate) startDate.setHours(0, 0, 0, 0);
  if (endDate) endDate.setHours(23, 59, 59, 999);
  
  return assessments.filter(assessment => {
    const assessmentDate = assessment.createdAt?.toDate ? assessment.createdAt.toDate() : new Date(assessment.createdAt);
    
    if (startDate && assessmentDate < startDate) return false;
    if (endDate && assessmentDate > endDate) return false;
    
    return true;
  });
}
function updateFilterButtons() {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.filter === currentFilter) {
      btn.classList.add('active');
    }
  });
}
function updateDateFilterInputs() {
  if (dateFilter.startDate) {
    document.getElementById('startDate').value = dateFilter.startDate;
  }
  if (dateFilter.endDate) {
    document.getElementById('endDate').value = dateFilter.endDate;
  }
}
function createAssessmentCard(assessment, index) {
  assessment = processAssessmentData(assessment);
  const summary = document.createElement('div');
  summary.className = 'card-summary';
  let statusBadges = '';
  if (assessment.approved) statusBadges += '<span class="status approved-badge"><i class="fas fa-check-circle"></i> Approved</span> ';
  if (assessment.resolved) statusBadges += '<span class="status resolved-badge"><i class="fas fa-check-double"></i> Resolved</span> ';
  summary.innerHTML = `
    <div class="company">${assessment.company || "No Company"}</div>
    <div class="location">${assessment.location || "No Location"}</div>
    <div class="deadline">Deadline: ${assessment.deadline || "None"}</div>
    ${statusBadges}
    <span class="status ${getWorstStatus(assessment) || ""}">${getWorstStatus(assessment) || "No Status"}</span>
  `;
  const card = document.createElement('div');
  card.className = 'card collapsed';
  if (assessment.approved) card.classList.add('approved');
  if (assessment.resolved) card.classList.add('resolved');
  card.id = `card-${index}`;
  // --- BLUR/ZOOM LOGIC ---
  card.addEventListener('click', function(e) {
    if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
    const cards = document.querySelectorAll('.card');
    if (!this.classList.contains('zoomed')) {
      cards.forEach(cardEl => {
        if (cardEl !== this) cardEl.classList.add('blurred');
        else cardEl.classList.add('zoomed');
      });
    } else {
      cards.forEach(cardEl => {
        cardEl.classList.remove('zoomed', 'blurred');
      });
    }
    this.classList.toggle('collapsed');
  });
  const details = document.createElement('div');
  details.className = 'card-details';
  const infoRow = document.createElement('div');
  infoRow.className = 'detail-row';
  infoRow.innerHTML = `
    <div class="detail-col">
      <p><b>Assessed By:</b> ${assessment.username || "Unknown"}</p>
      <p><b>Witness:</b> ${assessment.witness || "None"}</p>
    </div>
    <div class="detail-col">
      <p><b>Time:</b> ${formatDateTime(assessment.time) || "Unknown"}</p>
      <p><b>Deadline:</b> ${assessment.deadline || "None"}</p>
    </div>
  `;
  details.appendChild(infoRow);

  // --- ISSUES ---
  if (assessment.issues && assessment.issues.length > 0) {
    const issuesContainer = document.createElement('div');
    issuesContainer.className = 'issues-list';
    assessment.issues.forEach((issue, i) => {
      const issueElement = document.createElement('div');
      issueElement.className = 'issue-item';
      issueElement.dataset.issueIndex = i;
      issueElement.innerHTML = `
        <h4>Issue #${i+1}</h4>
        <p><b>Description:</b> ${issue.issue || "No description"}</p>
        <p><b>Impact:</b> ${issue.impact || "No impact specified"}</p>
        <p><b>Status:</b> <span class="status ${issue.status || ""}">${issue.status || "Unknown"}</span></p>
      `;
      issuesContainer.appendChild(issueElement);
    });
    details.appendChild(issuesContainer);
  }

  // --- IMAGES, SITUATION PICS, QUOTATIONS ---
  const imagesContainer = document.createElement('div');
  imagesContainer.className = 'images-container';
  // Images
  if (assessment.images && assessment.images.length > 0) {
    const imagesSection = document.createElement('div');
    imagesSection.className = 'images-section';
    imagesSection.innerHTML = '<h4>Initial Attachments</h4><div class="images-grid"></div>';
    assessment.images.forEach(img => {
      if (!img || !img.data) return;
      const imgLink = document.createElement('a');
      imgLink.href = '#';
      imgLink.onclick = (e) => { e.preventDefault(); openImageModal(img.data); };
      imgLink.innerHTML = `<img src="${img.data}" alt="Assessment Image">`;
      imagesSection.querySelector('.images-grid').appendChild(imgLink);
    });
    imagesContainer.appendChild(imagesSection);
  }
  // Situation pics
  if (assessment.situationPics && assessment.situationPics.length > 0) {
    const situationSection = document.createElement('div');
    situationSection.className = 'images-section';
    situationSection.innerHTML = '<h4>Situation Pictures</h4><div class="images-grid"></div>';
    assessment.situationPics.forEach(img => {
      if (!img || !img.data) return;
      const imgLink = document.createElement('a');
      imgLink.href = '#';
      imgLink.onclick = (e) => { e.preventDefault(); openImageModal(img.data); };
      imgLink.innerHTML = `<img src="${img.data}" alt="Situation Image">`;
      situationSection.querySelector('.images-grid').appendChild(imgLink);
    });
    imagesContainer.appendChild(situationSection);
  }
  // Quotations
  if (assessment.quotations && assessment.quotations.length > 0) {
    const quotationsSection = document.createElement('div');
    quotationsSection.className = 'images-section';
    quotationsSection.innerHTML = '<h4>Quotations</h4><div class="images-grid"></div>';
    assessment.quotations.forEach(quote => {
      if (!quote || !quote.data) return;
      const quoteElement = document.createElement('a');
      if (quote.type && quote.type.startsWith('image/')) {
        quoteElement.href = '#';
        quoteElement.onclick = (e) => { e.preventDefault(); openImageModal(quote.data); };
        quoteElement.innerHTML = `<img src="${quote.data}" alt="Quotation Image">`;
      } else if (quote.type && quote.type.includes('pdf')) {
        quoteElement.href = quote.data;
        quoteElement.target = '_blank';
        quoteElement.className = 'pdf-thumbnail';
        quoteElement.innerHTML = 'PDF Document<br>' + (quote.name || 'Quotation');
      } else {
        quoteElement.href = quote.data;
        quoteElement.target = '_blank';
        quoteElement.className = 'pdf-thumbnail';
        quoteElement.innerHTML = 'Document<br>' + (quote.name || 'Quotation');
      }
      quotationsSection.querySelector('.images-grid').appendChild(quoteElement);
    });
    imagesContainer.appendChild(quotationsSection);
  }
  details.appendChild(imagesContainer);

  // --- ACTION BUTTONS: everyone can edit, only admins see approve/resolve (for any assessment) ---
  const user = getCurrentUser();
  const actionButtons = document.createElement('div');
  actionButtons.className = 'action-buttons';
  actionButtons.innerHTML = `
    <button type="button" class="btn btn-primary" onclick="editAssessment('${assessment._id}', event)">
      <i class="fas fa-edit"></i> Edit
    </button>
    ${isAdmin(user) && !assessment.approved ? `
    <button type="button" class="btn btn-success" onclick="approveAssessment('${assessment._id}', event)">
      <i class="fas fa-check"></i> Approve All
    </button>
    ` : ''}
    ${isAdmin(user) && assessment.approved ? `
    <button type="button" class="btn btn-info" onclick="resolveAssessment('${assessment._id}', event)">
      <i class="fas fa-check-double"></i> Resolve All
    </button>
    ` : ''}
  `;
  details.appendChild(actionButtons);

  card.appendChild(summary);
  card.appendChild(details);
  return card;
}
function getWorstStatus(assessment) {
  if (!assessment.issues || assessment.issues.length === 0) return assessment.status || 'Good';
  const statusPriority = { 'VeryBad': 4, 'Bad': 3, 'Fair': 2, 'Good': 1 };
  let worstStatus = 'Good', highestPriority = 1;
  assessment.issues.forEach(issue => {
    const priority = statusPriority[issue.status] || 1;
    if (priority > highestPriority) {
      highestPriority = priority;
      worstStatus = issue.status;
    }
  });
  return worstStatus;
}
function formatDateTime(dateString) {
  if (!dateString) return '';
  try {
    const date = dateString.toDate ? dateString.toDate() : new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  } catch (e) {
    return dateString;
  }
}

// ---- DATE FILTER FUNCTIONS ----
function applyDateFilter() {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  
  // Validate dates
  if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
    alert('Start date cannot be after end date');
    return;
  }
  
  dateFilter = {
    startDate: startDate || null,
    endDate: endDate || null
  };
  
  // Save to localStorage
  localStorage.setItem('dateFilter', JSON.stringify(dateFilter));
  
  // Re-render assessments
  renderAssessments();
}

function clearDateFilter() {
  dateFilter = {};
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  localStorage.removeItem('dateFilter');
  renderAssessments();
}

// ---- ASSESSMENT ACTIONS ----
async function editAssessment(docId, event) {
  event.stopPropagation();
  try {
    const doc = await db.collection("ASSESSMENTS").doc(docId).get();
    if (!doc.exists) { alert("Assessment not found"); return; }
    const assessment = doc.data();
    document.getElementById("assessmentId").value = docId;
    document.getElementById("originalUsername").value = assessment.username || "";
    document.getElementById("company").value = assessment.company || "";
    document.getElementById("location").value = assessment.location || "";
    document.getElementById("witness").value = assessment.witness || "";
    document.getElementById("time").value = formatDateTimeForInput(assessment.time) || "";
    document.getElementById("deadline").value = assessment.deadline || "";
    document.getElementById("comment").value = assessment.comments?.join("\n") || "";
    document.getElementById("issuesContainer").innerHTML = "";
    if (assessment.issues && assessment.issues.length > 0) {
      assessment.issues.forEach(issue => {
        addIssueField(issue);
      });
    } else {
      addIssueField();
    }
    document.getElementById("cancelEdit").style.display = "inline-block";
    document.getElementById("formContainer").style.display = "block";
    document.getElementById("addBtn").innerHTML = '<i class="fas fa-times"></i> Cancel';
    document.getElementById("formContainer").scrollIntoView({ behavior: 'smooth' });
  } catch (err) {
    console.error("Error editing assessment:", err);
    alert("Failed to load assessment for editing");
  }
}
function formatDateTimeForInput(dateValue) {
  if (!dateValue) return '';
  try {
    const date = dateValue.toDate ? dateValue.toDate() : new Date(dateValue);
    // Format for datetime-local input: YYYY-MM-DDTHH:MM
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  } catch (e) {
    return '';
  }
}
async function approveAssessment(docId, event) {
  event.stopPropagation();
  if (!confirm("Approve this assessment to commence work?")) return;
  const user = getCurrentUser();
  if (!user || !isAdmin(user)) {
    alert("Only admins can approve assessments");
    return;
  }
  try {
    await db.collection("ASSESSMENTS").doc(docId).update({
      approved: true,
      approvedBy: user,
      approvedOn: new Date()
    });
  } catch (err) {
    console.error("Error approving assessment:", err);
    alert("Failed to approve assessment");
  }
}
async function resolveAssessment(docId, event) {
  event.stopPropagation();
  if (!confirm("Mark this assessment as resolved?")) return;
  const user = getCurrentUser();
  if (!user || !isAdmin(user)) {
    alert("Only admins can resolve assessments");
    return;
  }
  try {
    await db.collection("ASSESSMENTS").doc(docId).update({
      resolved: true,
      resolvedBy: user,
      resolvedOn: new Date()
    });
  } catch (err) {
    console.error("Error resolving assessment:", err);
    alert("Failed to resolve assessment");
  }
}

// ---- FILTER CONTROLS ----
function setupFilterControls() {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      currentFilter = this.dataset.filter;
      localStorage.setItem('currentFilter', currentFilter);
      renderAssessments();
      updateFilterButtons();
    });
  });
}

// ---- ADD/UPDATE ASSESSMENT ----
document.getElementById("assessmentForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const user = getCurrentUser();
  if (!user) {
    alert("You must be logged in to submit an assessment");
    return;
  }
  
  // Show loading state on submit button
  const submitBtn = document.getElementById("submitBtn");
  const originalBtnText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<div class="loading"></div> Saving...';
  submitBtn.disabled = true;
  
  try {
    const formData = {
      company: document.getElementById("company").value,
      location: document.getElementById("location").value,
      witness: document.getElementById("witness").value,
      time: document.getElementById("time").value,
      deadline: document.getElementById("deadline").value,
      comments: [],
      updatedAt: new Date()
    };
    
    const docId = document.getElementById("assessmentId").value;
    const originalUsername = document.getElementById("originalUsername").value;
    
    // Preserve the original username if editing (admin editing someone else's assessment)
    if (docId && originalUsername) {
      formData.username = originalUsername;
    } else {
      formData.username = user;
    }
    
    if (docId) {
      const doc = await db.collection("ASSESSMENTS").doc(docId).get();
      if (doc.exists) {
        const existingData = doc.data();
        formData.createdAt = existingData.createdAt;
        formData.approved = !!existingData.approved;
        if (existingData.approvedBy !== undefined) formData.approvedBy = existingData.approvedBy;
        if (existingData.approvedOn !== undefined) formData.approvedOn = existingData.approvedOn;
        formData.resolved = !!existingData.resolved;
        if (existingData.resolvedBy !== undefined) formData.resolvedBy = existingData.resolvedBy;
        if (existingData.resolvedOn !== undefined) formData.resolvedOn = existingData.resolvedOn;
        formData.images = Array.isArray(existingData.images) ? existingData.images : [];
        formData.situationPics = Array.isArray(existingData.situationPics) ? existingData.situationPics : [];
        formData.quotations = Array.isArray(existingData.quotations) ? existingData.quotations : [];
      }
    } else {
      formData.createdAt = new Date();
      formData.approved = false;
      formData.resolved = false;
    }
    
    const issueInputs = document.querySelectorAll('.issue-input');
    formData.issues = [];
    for (let i = 0; i < issueInputs.length; i++) {
      const issue = issueInputs[i].querySelector('.issue-text').value;
      const impact = issueInputs[i].querySelector('.impact-text').value;
      const status = issueInputs[i].querySelector('.status-select').value;
      if (issue && impact && status) {
        formData.issues.push({ issue, impact, status });
      }
    }
    
    if (formData.issues.length === 0) {
      const errorEl = document.getElementById("formError");
      errorEl.textContent = "At least one valid issue is required";
      errorEl.style.display = 'block';
      submitBtn.innerHTML = originalBtnText;
      submitBtn.disabled = false;
      return;
    }
    
    const images = document.getElementById("images").files;
    const situationPics = document.getElementById("situationPics").files;
    const quotations = document.getElementById("quotations").files;
    const comment = document.getElementById("comment").value;
    
    if (comment) {
      formData.comments = comment.split("\n").filter(c => c.trim());
    }
    
    async function processFiles(fileList) {
      if (!fileList || fileList.length === 0) return [];
      const promises = [];
      for (let i = 0; i < fileList.length; i++) {
        // Check file size again before processing
        if (fileList[i].size > MAX_FILE_SIZE) {
          alert(`File "${fileList[i].name}" exceeds the 15MB size limit and will not be uploaded.`);
          continue;
        }
        promises.push(dataUrlFromFile(fileList[i]));
      }
      return await Promise.all(promises);
    }
    
    // Helper to filter image/file arrays and ensure they're Firebase-compatible
    function filterImageArray(arr) {
      if (!Array.isArray(arr)) return [];
      return arr
        .filter(x => x && typeof x === 'object' && 'data' in x && 'type' in x && 'name' in x)
        .map(x => ({ 
          data: String(x.data).substring(0, 1000000), // Limit size to prevent issues
          type: String(x.type || ''), 
          name: String(x.name || '') 
        }));
    }
    
    const [imagesData, situationData, quotationsData] = await Promise.all([
      processFiles(images),
      processFiles(situationPics),
      processFiles(quotations)
    ]);
    
    if (docId) {
      formData.images = filterImageArray([...(formData.images || []), ...imagesData]);
      formData.situationPics = filterImageArray([...(formData.situationPics || []), ...situationData]);
      formData.quotations = filterImageArray([...(formData.quotations || []), ...quotationsData]);
    } else {
      formData.images = filterImageArray(imagesData);
      formData.situationPics = filterImageArray(situationData);
      formData.quotations = filterImageArray(quotationsData);
    }
    
    // Clean up data to ensure Firebase compatibility
    Object.keys(formData).forEach(key => {
      if (formData[key] === undefined || formData[key] === null) {
        delete formData[key];
      } else if (Array.isArray(formData[key])) {
        // Ensure all array elements are plain objects
        formData[key] = formData[key].map(item => {
          if (item && typeof item === 'object') {
            const cleanItem = {};
            Object.keys(item).forEach(prop => {
              if (item[prop] !== undefined && item[prop] !== null) {
                cleanItem[prop] = item[prop];
              }
            });
            return cleanItem;
          }
          return item;
        });
      }
    });
    
    if (docId) {
      await db.collection("ASSESSMENTS").doc(docId).set(formData, {merge: true});
    } else {
      await db.collection("ASSESSMENTS").add(formData);
    }
    
    resetForm();
    document.getElementById("formContainer").style.display = "none";
    document.getElementById("addBtn").innerHTML = '<i class="fas fa-plus"></i> Add New';
    document.getElementById("formError").style.display = "none";
    
  } catch (err) {
    const errorEl = document.getElementById("formError");
    errorEl.textContent = "Error saving assessment: " + (err.message || err);
    errorEl.style.display = 'block';
    console.error("Assessment submission error:", err);
  } finally {
    submitBtn.innerHTML = originalBtnText;
    submitBtn.disabled = false;
  }
});

// ---- INIT ----
window.onload = function() {
  const user = getCurrentUser();
  if (!user) { 
    location.href = "index.html"; 
    return; 
  }
  showWelcome(user);
  setupFilterControls();
  listenAssessments();
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeModal();
    }
  });
}
</script>
</body>
</html>
