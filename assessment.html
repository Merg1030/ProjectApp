<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Work Assessment Tracker</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
  <style>
    :root {
      /* Construction Theme Colors */
      --primary: #2a5f8a;
      --primary-light: #3a7cb9;
      --primary-dark: #1d4568;
      --secondary: #f7931e;
      --secondary-light: #ffae4d;
      --secondary-dark: #e07c0d;
      --success: #4CAF50;
      --danger: #F44336;
      --warning: #FF9800;
      --info: #2196F3;
      --text: #333;
      --light-bg: #f5f7fa;
      --card-bg: #fff;
      --border: #e0e4e9;
      --approved-color: #2e7d32;
      --resolved-color: #1565c0;
    }
    html, body {
      min-height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      background: var(--light-bg);
      color: var(--text);
      font-family: 'Segoe UI', Arial, sans-serif;
      box-sizing: border-box;
    }
    body {
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100vw;
      background: var(--card-bg);
      padding: 0;
    }
    .welcome {
      font-size: 1.1em;
      color: var(--primary);
      text-align: center;
      margin: 0;
      letter-spacing: 0.5px;
      font-weight: 600;
      width: 100vw;
      background: var(--light-bg);
      padding: 10px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .header-bar {
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--primary);
      color: white;
      padding: 0 3vw;
      margin-bottom: 0;
      min-height: 54px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .header-bar h2 {
      margin: 0;
      color: white;
      font-weight: 700;
      font-size: 1.25em;
      letter-spacing: 1px;
    }
    .header-controls {
      display: flex;
      gap: 10px;
    }
    .btn {
      background: var(--secondary);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 9px 18px;
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn i {
      font-size: 1.1em;
    }
    .btn-logout {
      background: var(--danger);
    }
    .btn-toggle:hover { background: var(--secondary-dark); }
    .btn-logout:hover { background: #c62828; }
    .btn-success {
      background: var(--success);
    }
    .btn-info {
      background: var(--info);
    }
    .form-container {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      max-width: 98vw;
      width: 460px;
      margin: 20px auto 10px;
      padding: 18px 14px 12px;
      color: var(--text);
      border: 1px solid var(--border);
    }
    label { 
      font-weight: bold; 
      margin-top: 10px; 
      display: block; 
      color: var(--primary);
      font-size: 0.95em;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      margin-top: 4px;
      background: #f8fafc;
      border: 1.2px solid #b5c4d6;
      border-radius: 5px;
      font-size: 1em;
      color: var(--text);
      margin-bottom: 4px;
      transition: all 0.18s;
      box-sizing: border-box;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(42, 95, 138, 0.2);
    }
    textarea { 
      resize: vertical; 
      min-height: 42px; 
      font-family: inherit;
    }
    .btn-submit {
      margin-top: 18px;
      padding: 12px 0;
      width: 100%;
      background: var(--primary);
      border: none;
      color: #fff;
      font-size: 1.07em;
      border-radius: 7px;
      cursor: pointer;
      font-weight: 600;
      transition: all .18s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .btn-submit:hover { 
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    /* Improved Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 15px;
      margin: 0 auto 40px;
      max-width: 1400px;
      width: 100vw;
      padding: 0 4vw 20px;
    }
    
    /* Enhanced Card Design */
    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      width: 100%;
      min-width: 0;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      border-color: var(--primary-light);
    }
    .card.collapsed .card-details { display: none; }
    .card-summary {
      font-weight: bold;
      font-size: 1.09em;
      background: #f2f6fb;
      padding: 15px;
      border-bottom: 1px solid var(--border);
      color: var(--primary);
      letter-spacing: 0.5px;
      user-select: none;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }
    .card.approved {
      border-left: 4px solid var(--approved-color);
    }
    .card.resolved {
      border-left: 4px solid var(--resolved-color);
    }
    .card-summary .company {
      font-weight: 700;
      color: var(--primary);
      flex: 1;
      min-width: 120px;
    }
    .card-summary .location {
      color: #555;
      font-size: 0.95em;
      flex: 1;
      min-width: 100px;
    }
    .card .deadline {
      color: var(--warning);
      font-size: 0.95em;
      font-weight: 500;
      white-space: nowrap;
    }
    .status {
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 4px;
      display: inline-block;
      margin-top: 0;
      font-size: 0.9em;
      letter-spacing: 0.5px;
      background: #e3f2fd;
      color: var(--primary);
      border: 1px solid #bcdffb;
      white-space: nowrap;
    }
    .Good { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
    .Fair { background: #fff8e1; color: #ff8f00; border-color: #ffe0b2; }
    .Bad { background: #ffebee; color: #c62828; border-color: #ffcdd2; }
    .VeryBad { background: #fce4ec; color: #ad1457; border-color: #f8bbd0; }
    .approved-badge {
      background: #e8f5e9;
      color: var(--approved-color);
      border: 1px solid #c8e6c9;
    }
    .resolved-badge {
      background: #e3f2fd;
      color: var(--resolved-color);
      border: 1px solid #bbdefb;
    }
    
    /* Improved Image Gallery */
    .images-container {
      margin: 15px 0;
    }
    .images-section {
      margin-bottom: 15px;
    }
    .images-section h4 {
      margin: 0 0 8px 0;
      color: var(--primary);
      font-size: 0.95em;
    }
    .images-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .images-grid a {
      display: block;
      width: 100px;
      height: 80px;
      border-radius: 5px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: #f8fafc;
      position: relative;
      transition: all 0.2s;
    }
    .images-grid a:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    .images-grid a img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s;
    }
    .pdf-thumbnail {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f1f5f9;
      color: var(--primary);
      font-size: 0.8em;
      text-align: center;
      padding: 5px;
    }
    
    /* Card Details Layout */
    .card-details {
      padding: 15px;
    }
    .detail-row {
      display: flex;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .detail-col {
      flex: 1;
      min-width: 150px;
      margin-right: 15px;
    }
    .detail-col:last-child {
      margin-right: 0;
    }
    .detail-row p {
      margin: 5px 0;
      font-size: 0.95em;
    }
    .detail-row b {
      color: var(--primary);
    }
    
    /* Issues List */
    .issues-list {
      margin: 10px 0;
    }
    .issue-item {
      background: #f8fafc;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 8px;
      border-left: 3px solid var(--primary);
      transition: all 0.3s;
    }
    .issue-item.focused {
      background: white;
      box-shadow: 0 0 0 2px var(--primary-light);
      z-index: 10;
      position: relative;
    }
    .issue-item.blurred {
      opacity: 0.5;
      filter: blur(2px);
    }
    .issue-item h4 {
      margin: 0 0 5px 0;
      color: var(--primary);
      font-size: 0.95em;
    }
    .issue-item p {
      margin: 5px 0;
      font-size: 0.9em;
    }
    .add-issue-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      font-size: 0.9em;
      cursor: pointer;
      margin-top: 5px;
      display: inline-block;
      transition: all 0.2s;
    }
    .add-issue-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .action-buttons button {
      padding: 6px 12px;
      font-size: 0.85em;
    }
    
    /* Form Error */
    #formError {
      color: var(--danger);
      margin-top: 8px;
      font-size: 0.95em;
      padding: 8px;
      background: #ffebee;
      border-radius: 4px;
      border-left: 3px solid var(--danger);
    }
    
    /* Filter Controls */
    .filter-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9em;
    }
    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Modal for image viewing */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
      overflow: auto;
    }
    .modal-content {
      margin: auto;
      display: block;
      max-width: 90%;
      max-height: 90%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .close {
      position: absolute;
      top: 15px;
      right: 35px;
      color: #f1f1f1;
      font-size: 40px;
      font-weight: bold;
      transition: 0.3s;
      cursor: pointer;
    }
    .close:hover {
      color: #bbb;
    }
    
    /* Responsive Design */
    @media (max-width: 700px) {
      .header-bar, .welcome {
        padding-left: 3vw;
        padding-right: 3vw;
      }
      .header-controls {
        gap: 6px;
      }
      .btn {
        padding: 8px 12px;
        font-size: 0.9em;
      }
      .form-container { 
        max-width: 94vw; 
        border-radius: 0; 
        padding: 12px 3vw 8px; 
        box-shadow: none;
        border-left: none;
        border-right: none;
      }
      .grid { 
        padding: 0 3vw 16px; 
        gap: 12px; 
        grid-template-columns: 1fr;
      }
      .card { 
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      }
      .card-summary { 
        padding: 12px; 
        font-size: 1em;
        flex-direction: column;
        align-items: flex-start;
      }
      .card-summary .company,
      .card-summary .location {
        min-width: 100%;
      }
      input, textarea, select { 
        font-size: 1em; 
        padding: 8px 10px;
      }
      .detail-col {
        min-width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
      }
      .filter-controls {
        gap: 6px;
      }
      .filter-btn {
        padding: 6px 12px;
        font-size: 0.85em;
      }
    }
    
    /* Animation for form toggle */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .form-container {
      animation: fadeIn 0.3s ease-out;
    }
    
    /* Edit mode styles */
    .edit-mode .issue-item:not(.focused) {
      opacity: 0.5;
      filter: blur(2px);
    }
    .edit-mode .issue-item.focused {
      background: white;
      box-shadow: 0 0 0 2px var(--primary-light);
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <h2>Work Assessment</h2>
    <div class="header-controls">
      <button class="btn btn-toggle" id="addBtn" onclick="toggleForm()">
        <i class="fas fa-plus"></i> Add New
      </button>
      <button class="btn btn-logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>
  <div class="welcome" id="welcome"></div>
  
  <div class="filter-controls" id="filterControls">
    <button class="filter-btn active" data-filter="all">All Assessments</button>
    <button class="filter-btn" data-filter="pending">Pending</button>
    <button class="filter-btn" data-filter="approved">Approved</button>
    <button class="filter-btn" data-filter="resolved">Resolved</button>
  </div>
  
  <div id="userView">
    <div class="form-container" id="formContainer" style="display: none;">
      <form id="assessmentForm">
        <input type="hidden" id="assessmentId">
        
        <label>Company</label>
        <input type="text" id="company" required>
        
        <label>Location</label>
        <input type="text" id="location" required>
        
        <label>Witness Name</label>
        <input type="text" id="witness" required>
        
        <label>Time of Assessment</label>
        <input type="datetime-local" id="time" required>
        
        <label>Deadline</label>
        <input type="date" id="deadline" required>
        
        <div id="issuesContainer">
          <!-- Issues will be added here -->
        </div>
        
        <button type="button" class="add-issue-btn" onclick="addIssueField()">
          <i class="fas fa-plus"></i> Add Another Issue
        </button>
        
        <label>Upload Pictures (Optional)</label>
        <input type="file" id="images" multiple accept="image/*">
        
        <label>Situation Pictures (Optional, update anytime)</label>
        <input type="file" id="situationPics" multiple accept="image/*">
        
        <label>Quotations (Optional, update anytime)</label>
        <input type="file" id="quotations" multiple accept="image/*,application/pdf">
        
        <label>Comment (Optional)</label>
        <textarea id="comment"></textarea>
        
        <div class="action-buttons">
          <button type="submit" class="btn btn-submit">
            <i class="fas fa-save"></i> Save Assessment
          </button>
          <button type="button" class="btn btn-danger" id="cancelEdit" style="display: none;" onclick="cancelEdit()">
            <i class="fas fa-times"></i> Cancel Edit
          </button>
        </div>
        <div id="formError" style="display: none;"></div>
      </form>
    </div>
    <div class="grid" id="assessments"></div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="modalImage">
  </div>

  <script>
    // ---- CONFIGURATION ----
    const ADMIN_USERS = ['faiyaz mulla', 'chishela'];
    const GENERAL_PASSWORD = '12345'; // You can change this
    
    // ---- FIREBASE SETUP ----
    const firebaseConfig = {
      apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
      authDomain: "project-task-588c4.firebaseapp.com",
      projectId: "project-task-588c4",
      storageBucket: "project-task-588c4.appspot.com",
      messagingSenderId: "411882772509",
      appId: "1:411882772509:web:08d613186c101a99f38ef4",
      measurementId: "G-JMFLFYEM0F"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---- USER MANAGEMENT ----
    function getCurrentUser() {
      return localStorage.getItem('currentUser') || null;
    }
    function isAdmin(user) {
      if (!user) return false;
      return ADMIN_USERS.includes(user.toLowerCase());
    }
    function logout() {
      localStorage.removeItem('currentUser');
      localStorage.removeItem('currentFilter');
      location.href = "index.html";
    }
    function showWelcome(user) {
      let name = user.trim().split(" ");
      name = name.length === 1 ? name[0] : name.slice(-2).join(" ");
      document.getElementById('welcome').innerHTML = `WELCOME <span style="color:var(--primary)">${name.toUpperCase()}</span>`;
      if (isAdmin(user)) {
        document.getElementById('filterControls').style.display = 'flex';
      } else {
        document.getElementById('filterControls').style.display = 'none';
      }
    }

    // ---- FORM TOGGLE ----
    function toggleForm() {
      const fc = document.getElementById("formContainer");
      if (fc.style.display === "none") {
        resetForm();
        fc.style.display = "block";
        document.getElementById("addBtn").innerHTML = '<i class="fas fa-times"></i> Cancel';
      } else {
        fc.style.display = "none";
        document.getElementById("addBtn").innerHTML = '<i class="fas fa-plus"></i> Add New';
      }
    }
    function resetForm() {
      document.getElementById("assessmentForm").reset();
      document.getElementById("assessmentId").value = "";
      document.getElementById("issuesContainer").innerHTML = `
        <div class="issue-input">
          <label>Issue</label>
          <textarea class="issue-text" required></textarea>
          <label>Impact on Users & Company</label>
          <textarea class="impact-text" required></textarea>
          <label>Status</label>
          <select class="status-select" required>
            <option value="Good">Good</option>
            <option value="Fair">Fair</option>
            <option value="Bad">Bad</option>
            <option value="VeryBad">Very Bad</option>
          </select>
        </div>
      `;
      document.getElementById("cancelEdit").style.display = "none";
      document.getElementById("formError").style.display = "none";
    }
    function cancelEdit() {
      resetForm();
      toggleForm();
    }

    // ---- MULTIPLE ISSUES SYSTEM ----
    function addIssueField(issueData = null) {
      const container = document.getElementById('issuesContainer');
      const newIssue = document.createElement('div');
      newIssue.className = 'issue-input';
      let issueValue = '';
      let impactValue = '';
      let statusValue = 'Good';
      if (issueData) {
        issueValue = issueData.issue || '';
        impactValue = issueData.impact || '';
        statusValue = issueData.status || 'Good';
      }
      newIssue.innerHTML = `
        <label>Additional Issue</label>
        <textarea class="issue-text" required>${issueValue}</textarea>
        <label>Impact on Users & Company</label>
        <textarea class="impact-text" required>${impactValue}</textarea>
        <label>Status</label>
        <select class="status-select" required>
          <option value="Good" ${statusValue === 'Good' ? 'selected' : ''}>Good</option>
          <option value="Fair" ${statusValue === 'Fair' ? 'selected' : ''}>Fair</option>
          <option value="Bad" ${statusValue === 'Bad' ? 'selected' : ''}>Bad</option>
          <option value="VeryBad" ${statusValue === 'VeryBad' ? 'selected' : ''}>Very Bad</option>
        </select>
        <button type="button" class="add-issue-btn" style="background: var(--danger);" 
                onclick="this.parentElement.remove()">
          <i class="fas fa-trash"></i> Remove Issue
        </button>
      `;
      container.appendChild(newIssue);
    }

    // ---- IMAGE HANDLING ----
    function dataUrlFromFile(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = e => resolve({
          data: e.target.result,
          type: file.type,
          name: file.name
        });
        reader.readAsDataURL(file);
      });
    }
    function openImageModal(src) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      modal.style.display = "block";
      modalImg.src = src;
    }
    function closeModal() {
      document.getElementById('imageModal').style.display = "none";
    }
    window.onclick = function(event) {
      const modal = document.getElementById('imageModal');
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }

    // ---- ASSESSMENT CRUD ----
    let allAssessments = [];
    let unsubscribe = null;
    let currentFilter = localStorage.getItem('currentFilter') || 'all';
    function listenAssessments() {
      const user = getCurrentUser();
      if (!user) return;
      if (unsubscribe) unsubscribe();
      let query = db.collection("ASSESSMENTS");
      if (!isAdmin(user)) {
        query = query.where("username", "==", user);
      }
      unsubscribe = query.onSnapshot(snapshot => {
        allAssessments = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          data._id = doc.id;
          processAssessmentData(data);
          allAssessments.push(data);
        });
        renderAssessments();
        updateFilterButtons();
      });
    }
    function processAssessmentData(data) {
      data.images = Array.isArray(data.images) ? data.images : [];
      data.situationPics = Array.isArray(data.situationPics) ? data.situationPics : [];
      data.quotations = Array.isArray(data.quotations) ? data.quotations : [];
      data.comments = Array.isArray(data.comments) ? data.comments : [];
      data.issues = Array.isArray(data.issues) ? data.issues : [];
      if (data.issue && data.impact && data.status && data.issues.length === 0) {
        data.issues.push({
          issue: data.issue,
          impact: data.impact,
          status: data.status
        });
      }
      if (!data.status) {
        data.status = getWorstStatus(data);
      }
      return data;
    }
    function renderAssessments() {
      const container = document.getElementById("assessments");
      container.innerHTML = "";
      let filteredAssessments = filterAssessments(allAssessments);
      if (filteredAssessments.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">No assessments found</p>';
        return;
      }
      const sortedAssessments = [...filteredAssessments].sort((a, b) => {
        return (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0);
      });
      sortedAssessments.forEach((assessment, index) => {
        container.appendChild(createAssessmentCard(assessment, index));
      });
    }
    function filterAssessments(assessments) {
      switch(currentFilter) {
        case 'pending':
          return assessments.filter(a => !a.approved && !a.resolved);
        case 'approved':
          return assessments.filter(a => a.approved && !a.resolved);
        case 'resolved':
          return assessments.filter(a => a.resolved);
        default:
          return assessments;
      }
    }
    function updateFilterButtons() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === currentFilter) {
          btn.classList.add('active');
        }
      });
    }
    function createAssessmentCard(assessment, index) {
      assessment = processAssessmentData(assessment);
      const summary = document.createElement('div');
      summary.className = 'card-summary';
      let statusBadges = '';
      if (assessment.approved) {
        statusBadges += '<span class="status approved-badge"><i class="fas fa-check-circle"></i> Approved</span> ';
      }
      if (assessment.resolved) {
        statusBadges += '<span class="status resolved-badge"><i class="fas fa-check-double"></i> Resolved</span> ';
      }
      summary.innerHTML = `
        <div class="company">${assessment.company || "No Company"}</div>
        <div class="location">${assessment.location || "No Location"}</div>
        <div class="deadline">Deadline: ${assessment.deadline || "None"}</div>
        ${statusBadges}
        <span class="status ${getWorstStatus(assessment) || ""}">${getWorstStatus(assessment) || "No Status"}</span>
      `;
      const card = document.createElement('div');
      card.className = 'card collapsed';
      if (assessment.approved) card.classList.add('approved');
      if (assessment.resolved) card.classList.add('resolved');
      card.id = `card-${index}`;
      card.addEventListener('click', function(e) {
        if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
        this.classList.toggle('collapsed');
      });
      const details = document.createElement('div');
      details.className = 'card-details';
      const infoRow = document.createElement('div');
      infoRow.className = 'detail-row';
      infoRow.innerHTML = `
        <div class="detail-col">
          <p><b>Assessed By:</b> ${assessment.username || "Unknown"}</p>
          <p><b>Witness:</b> ${assessment.witness || "None"}</p>
        </div>
        <div class="detail-col">
          <p><b>Time:</b> ${formatDateTime(assessment.time) || "Unknown"}</p>
          <p><b>Deadline:</b> ${assessment.deadline || "None"}</p>
        </div>
      `;
      details.appendChild(infoRow);
      const user = getCurrentUser();
      if (isAdmin(user)) {
        const statusRow = document.createElement('div');
        statusRow.className = 'detail-row';
        let statusInfo = '';
        if (assessment.approved) {
          statusInfo += `<p><b>Approved By:</b> ${assessment.approvedBy || "Unknown"}</p>`;
          statusInfo += `<p><b>Approved On:</b> ${formatDateTime(assessment.approvedOn) || "Unknown"}</p>`;
        }
        if (assessment.resolved) {
          statusInfo += `<p><b>Resolved By:</b> ${assessment.resolvedBy || "Unknown"}</p>`;
          statusInfo += `<p><b>Resolved On:</b> ${formatDateTime(assessment.resolvedOn) || "Unknown"}</p>`;
        }
        statusRow.innerHTML = statusInfo;
        if (statusInfo) details.appendChild(statusRow);
      }
      if (assessment.issues && assessment.issues.length > 0) {
        const issuesContainer = document.createElement('div');
        issuesContainer.className = 'issues-list';
        assessment.issues.forEach((issue, i) => {
          const issueElement = document.createElement('div');
          issueElement.className = 'issue-item';
          issueElement.dataset.issueIndex = i;
          let adminControls = '';
          if (isAdmin(user) && !assessment.resolved) {
            adminControls = `
              <div class="action-buttons">
                <button type="button" class="btn btn-success" onclick="approveIssue('${assessment._id}', ${i}, event)">
                  <i class="fas fa-check"></i> Approve
                </button>
                ${!assessment.approved ? '' : `
                <button type="button" class="btn btn-info" onclick="resolveAssessment('${assessment._id}', event)">
                  <i class="fas fa-check-double"></i> Resolve All
                </button>
                `}
              </div>
            `;
          }
          issueElement.innerHTML = `
            <h4>Issue #${i+1}</h4>
            <p><b>Description:</b> ${issue.issue || "No description"}</p>
            <p><b>Impact:</b> ${issue.impact || "No impact specified"}</p>
            <p><b>Status:</b> <span class="status ${issue.status || ""}">${issue.status || "Unknown"}</span></p>
            ${adminControls}
          `;
          issueElement.addEventListener('click', function(e) {
            if (e.target.tagName === 'BUTTON') return;
            const card = this.closest('.card');
            const allIssues = card.querySelectorAll('.issue-item');
            allIssues.forEach(item => {
              if (item === this) {
                item.classList.toggle('focused');
              } else {
                item.classList.add('blurred');
              }
            });
            if (!card.querySelector('.issue-item.focused')) {
              allIssues.forEach(item => {
                item.classList.remove('blurred');
              });
            }
          });
          issuesContainer.appendChild(issueElement);
        });
        details.appendChild(issuesContainer);
      }
      const imagesContainer = document.createElement('div');
      imagesContainer.className = 'images-container';
      if (assessment.images && assessment.images.length > 0) {
        const imagesSection = document.createElement('div');
        imagesSection.className = 'images-section';
        imagesSection.innerHTML = '<h4>Initial Attachments</h4><div class="images-grid"></div>';
        assessment.images.forEach(img => {
          const imgLink = document.createElement('a');
          imgLink.href = '#';
          imgLink.onclick = (e) => { e.preventDefault(); openImageModal(img.data); };
          imgLink.innerHTML = `<img src="${img.data}" alt="Assessment Image">`;
          imagesSection.querySelector('.images-grid').appendChild(imgLink);
        });
        imagesContainer.appendChild(imagesSection);
      }
      if (assessment.situationPics && assessment.situationPics.length > 0) {
        const situationSection = document.createElement('div');
        situationSection.className = 'images-section';
        situationSection.innerHTML = '<h4>Situation Pictures</h4><div class="images-grid"></div>';
        assessment.situationPics.forEach(img => {
          const imgLink = document.createElement('a');
          imgLink.href = '#';
          imgLink.onclick = (e) => { e.preventDefault(); openImageModal(img.data); };
          imgLink.innerHTML = `<img src="${img.data}" alt="Situation Image">`;
          situationSection.querySelector('.images-grid').appendChild(imgLink);
        });
        imagesContainer.appendChild(situationSection);
      }
      if (assessment.quotations && assessment.quotations.length > 0) {
        const quotationsSection = document.createElement('div');
        quotationsSection.className = 'images-section';
        quotationsSection.innerHTML = '<h4>Quotations</h4><div class="images-grid"></div>';
        assessment.quotations.forEach(quote => {
          const quoteElement = document.createElement('a');
          if (quote.type && quote.type.startsWith('image/')) {
            quoteElement.href = '#';
            quoteElement.onclick = (e) => { e.preventDefault(); openImageModal(quote.data); };
            quoteElement.innerHTML = `<img src="${quote.data}" alt="Quotation Image">`;
          } else if (quote.type && quote.type.includes('pdf')) {
            quoteElement.href = quote.data;
            quoteElement.target = '_blank';
            quoteElement.className = 'pdf-thumbnail';
            quoteElement.innerHTML = 'PDF Document<br>' + (quote.name || 'Quotation');
          } else {
            quoteElement.href = quote.data;
            quoteElement.target = '_blank';
            quoteElement.className = 'pdf-thumbnail';
            quoteElement.innerHTML = 'Document<br>' + (quote.name || 'Quotation');
          }
          quotationsSection.querySelector('.images-grid').appendChild(quoteElement);
        });
        imagesContainer.appendChild(quotationsSection);
      }
      details.appendChild(imagesContainer);

      // Action buttons for editing (only for owner or admin)
      if ((assessment.username === user || isAdmin(user)) && !assessment.resolved) {
        const actionButtons = document.createElement('div');
        actionButtons.className = 'action-buttons';
        actionButtons.innerHTML = `
          <button type="button" class="btn btn-primary" onclick="editAssessment('${assessment._id}', event)">
            <i class="fas fa-edit"></i> Edit
          </button>
          ${isAdmin(user) && !assessment.approved ? `
          <button type="button" class="btn btn-success" onclick="approveAssessment('${assessment._id}', event)">
            <i class="fas fa-check"></i> Approve All
          </button>
          ` : ''}
          ${isAdmin(user) && assessment.approved ? `
          <button type="button" class="btn btn-info" onclick="resolveAssessment('${assessment._id}', event)">
            <i class="fas fa-check-double"></i> Resolve All
          </button>
          ` : ''}
        `;
        details.appendChild(actionButtons);
      }
      card.appendChild(summary);
      card.appendChild(details);
      return card;
    }
    function getWorstStatus(assessment) {
      if (!assessment.issues || assessment.issues.length === 0) {
        return assessment.status || 'Good';
      }
      const statusPriority = {
        'VeryBad': 4,
        'Bad': 3,
        'Fair': 2,
        'Good': 1
      };
      let worstStatus = 'Good';
      let highestPriority = 1;
      assessment.issues.forEach(issue => {
        const priority = statusPriority[issue.status] || 1;
        if (priority > highestPriority) {
          highestPriority = priority;
          worstStatus = issue.status;
        }
      });
      return worstStatus;
    }
    function formatDateTime(dateString) {
      if (!dateString) return '';
      try {
        const date = dateString.toDate ? dateString.toDate() : new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      } catch (e) {
        return dateString;
      }
    }
    // ---- ASSESSMENT ACTIONS ----
    async function editAssessment(docId, event) {
      event.stopPropagation();
      try {
        const doc = await db.collection("ASSESSMENTS").doc(docId).get();
        if (!doc.exists) {
          alert("Assessment not found");
          return;
        }
        const assessment = doc.data();
        document.getElementById("assessmentId").value = docId;
        document.getElementById("company").value = assessment.company || "";
        document.getElementById("location").value = assessment.location || "";
        document.getElementById("witness").value = assessment.witness || "";
        document.getElementById("time").value = assessment.time || "";
        document.getElementById("deadline").value = assessment.deadline || "";
        document.getElementById("comment").value = assessment.comments?.join("\n") || "";
        document.getElementById("issuesContainer").innerHTML = "";
        if (assessment.issues && assessment.issues.length > 0) {
          assessment.issues.forEach(issue => {
            addIssueField(issue);
          });
        } else {
          addIssueField();
        }
        document.getElementById("cancelEdit").style.display = "inline-block";
        document.getElementById("formContainer").style.display = "block";
        document.getElementById("addBtn").innerHTML = '<i class="fas fa-times"></i> Cancel';
        document.getElementById("formContainer").scrollIntoView({ behavior: 'smooth' });
      } catch (err) {
        console.error("Error editing assessment:", err);
        alert("Failed to load assessment for editing");
      }
    }
    async function approveAssessment(docId, event) {
      event.stopPropagation();
      if (!confirm("Approve this assessment to commence work?")) return;
      const user = getCurrentUser();
      if (!user || !isAdmin(user)) {
        alert("Only admins can approve assessments");
        return;
      }
      try {
        await db.collection("ASSESSMENTS").doc(docId).update({
          approved: true,
          approvedBy: user,
          approvedOn: new Date()
        });
      } catch (err) {
        console.error("Error approving assessment:", err);
        alert("Failed to approve assessment");
      }
    }
    async function approveIssue(docId, issueIndex, event) {
      event.stopPropagation();
      if (!confirm("Approve this specific issue?")) return;
      const user = getCurrentUser();
      if (!user || !isAdmin(user)) {
        alert("Only admins can approve issues");
        return;
      }
      try {
        const doc = await db.collection("ASSESSMENTS").doc(docId).get();
        if (!doc.exists) {
          alert("Assessment not found");
          return;
        }
        const assessment = doc.data();
        if (!assessment.issues || issueIndex >= assessment.issues.length) {
          alert("Issue not found");
          return;
        }
        const issues = [...assessment.issues];
        issues[issueIndex].approved = true;
        issues[issueIndex].approvedBy = user;
        issues[issueIndex].approvedOn = new Date();
        await db.collection("ASSESSMENTS").doc(docId).update({
          issues: issues
        });
      } catch (err) {
        console.error("Error approving issue:", err);
        alert("Failed to approve issue");
      }
    }
    async function resolveAssessment(docId, event) {
      event.stopPropagation();
      if (!confirm("Mark this assessment as resolved?")) return;
      const user = getCurrentUser();
      if (!user || !isAdmin(user)) {
        alert("Only admins can resolve assessments");
        return;
      }
      try {
        await db.collection("ASSESSMENTS").doc(docId).update({
          resolved: true,
          resolvedBy: user,
          resolvedOn: new Date()
        });
      } catch (err) {
        console.error("Error resolving assessment:", err);
        alert("Failed to resolve assessment");
      }
    }
    // ---- FILTER CONTROLS ----
    function setupFilterControls() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          currentFilter = this.dataset.filter;
          localStorage.setItem('currentFilter', currentFilter);
          renderAssessments();
          updateFilterButtons();
        });
      });
    }
    // ---- ADD/UPDATE ASSESSMENT ----
    document.getElementById("assessmentForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const user = getCurrentUser();
      if (!user) {
        alert("You must be logged in to submit an assessment");
        return;
      }
      const formData = {
        username: user,
        company: document.getElementById("company").value,
        location: document.getElementById("location").value,
        witness: document.getElementById("witness").value,
        time: document.getElementById("time").value,
        deadline: document.getElementById("deadline").value,
        comments: [],
        updatedAt: new Date()
      };
      const docId = document.getElementById("assessmentId").value;
      if (docId) {
        const doc = await db.collection("ASSESSMENTS").doc(docId).get();
        if (doc.exists) {
          const existingData = doc.data();
          formData.createdAt = existingData.createdAt;
          formData.approved = existingData.approved;
          formData.approvedBy = existingData.approvedBy;
          formData.approvedOn = existingData.approvedOn;
          formData.resolved = existingData.resolved;
          formData.resolvedBy = existingData.resolvedBy;
          formData.resolvedOn = existingData.resolvedOn;
          formData.images = existingData.images || [];
          formData.situationPics = existingData.situationPics || [];
          formData.quotations = existingData.quotations || [];
        }
      } else {
        formData.createdAt = new Date();
        formData.approved = false;
        formData.resolved = false;
      }
      const issueInputs = document.querySelectorAll('.issue-input');
      formData.issues = [];
      for (let i = 0; i < issueInputs.length; i++) {
        const issue = issueInputs[i].querySelector('.issue-text').value;
        const impact = issueInputs[i].querySelector('.impact-text').value;
        const status = issueInputs[i].querySelector('.status-select').value;
        if (issue && impact && status) {
          formData.issues.push({
            issue,
            impact,
            status
          });
        }
      }
      if (formData.issues.length === 0) {
        const errorEl = document.getElementById("formError");
        errorEl.textContent = "At least one valid issue is required";
        errorEl.style.display = 'block';
        return;
      }
      const images = document.getElementById("images").files;
      const situationPics = document.getElementById("situationPics").files;
      const quotations = document.getElementById("quotations").files;
      const comment = document.getElementById("comment").value;
      if (comment) {
        formData.comments = comment.split("\n").filter(c => c.trim());
      }
      async function processFiles(fileList) {
        if (!fileList || fileList.length === 0) return [];
        const promises = [];
        for (let i = 0; i < fileList.length; i++) {
          promises.push(dataUrlFromFile(fileList[i]));
        }
        return await Promise.all(promises);
      }
      try {
        const [imagesData, situationData, quotationsData] = await Promise.all([
          processFiles(images),
          processFiles(situationPics),
          processFiles(quotations)
        ]);
        if (docId) {
          formData.images = [...formData.images, ...imagesData];
          formData.situationPics = [...formData.situationPics, ...situationData];
          formData.quotations = [...formData.quotations, ...quotationsData];
        } else {
          formData.images = imagesData;
          formData.situationPics = situationData;
          formData.quotations = quotationsData;
        }
        if (docId) {
          await db.collection("ASSESSMENTS").doc(docId).update(formData);
        } else {
          await db.collection("ASSESSMENTS").add(formData);
        }
        resetForm();
        document.getElementById("formContainer").style.display = "none";
        document.getElementById("addBtn").innerHTML = '<i class="fas fa-plus"></i> Add New';
        document.getElementById("formError").style.display = "none";
      } catch (err) {
        const errorEl = document.getElementById("formError");
        errorEl.textContent = "Error saving assessment: " + (err.message || err);
        errorEl.style.display = 'block';
        console.error("Assessment submission error:", err);
      }
    });
    // ---- INIT ----
    window.onload = function() {
      const user = getCurrentUser();
      if (!user) { 
        location.href = "index.html"; 
        return; 
      }
      showWelcome(user);
      setupFilterControls();
      listenAssessments();
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeModal();
        }
      });
    }
  </script>
</body>
</html>
