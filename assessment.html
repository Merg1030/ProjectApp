<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employee Work Tracker</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Construction Theme Colors */
      --primary: #2a5f8a;
      --primary-light: #3a7cb9;
      --primary-dark: #1d4568;
      --secondary: #f7931e;
      --secondary-light: #ffae4d;
      --secondary-dark: #e07c0d;
      --success: #4CAF50;
      --danger: #F44336;
      --warning: #FF9800;
      --info: #2196F3;
      --text: #333;
      --light-bg: #f5f7fa;
      --card-bg: #fff;
      --border: #e0e4e9;
      --approved-color: #2e7d32;
      --resolved-color: #1565c0;
    }
    html, body {
      min-height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      background: var(--light-bg);
      color: var(--text);
      font-family: 'Segoe UI', Arial, sans-serif;
      box-sizing: border-box;
      font-size: 14px;
    }
    body {
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100vw;
      background: var(--card-bg);
      padding: 0;
    }
    .welcome {
      font-size: 1.2em;
      color: var(--primary);
      text-align: center;
      margin: 0;
      letter-spacing: 0.5px;
      font-weight: 600;
      width: 100vw;
      background: var(--light-bg);
      padding: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .header-bar {
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--primary);
      color: white;
      padding: 0 3vw;
      margin-bottom: 0;
      min-height: 54px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .header-bar h2 {
      margin: 0;
      color: white;
      font-weight: 700;
      font-size: 1.2em;
      letter-spacing: 1px;
    }
    .header-controls {
      display: flex;
      gap: 10px;
    }
    .btn {
      background: var(--secondary);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 8px 16px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn i {
      font-size: 1em;
    }
    .btn-logout {
      background: var(--danger);
    }
    .btn-toggle:hover { background: var(--secondary-dark); }
    .btn-logout:hover { background: #c62828; }
    .btn-success {
      background: var(--success);
    }
    .btn-info {
      background: var(--info);
    }
    .btn-absent {
      background: var(--warning);
    }
    .form-container {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      max-width: 98vw;
      width: 460px;
      margin: 20px auto 10px;
      padding: 16px 12px 10px;
      color: var(--text);
      border: 1px solid var(--border);
    }
    label { 
      font-weight: bold; 
      margin-top: 10px; 
      display: block; 
      color: var(--primary);
      font-size: 0.9em;
    }
    input, textarea, select {
      width: 100%;
      padding: 9px 11px;
      margin-top: 4px;
      background: #f8fafc;
      border: 1.2px solid #b5c4d6;
      border-radius: 5px;
      font-size: 0.95em;
      color: var(--text);
      margin-bottom: 4px;
      transition: all 0.18s;
      box-sizing: border-box;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(42, 95, 138, 0.2);
    }
    textarea { 
      resize: vertical; 
      min-height: 42px; 
      font-family: inherit;
    }
    .btn-submit {
      margin-top: 18px;
      padding: 11px 0;
      width: 100%;
      background: var(--primary);
      border: none;
      color: #fff;
      font-size: 1.05em;
      border-radius: 7px;
      cursor: pointer;
      font-weight: 600;
      transition: all .18s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .btn-submit:hover { 
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    /* Table Layout */
    .table-container {
      width: 100%;
      overflow-x: auto;
      margin: 0 auto 40px;
      padding: 0 4vw;
      box-sizing: border-box;
    }
    
    .tasks-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .tasks-table th {
      background: var(--primary);
      color: white;
      font-weight: 600;
      text-align: left;
      padding: 12px 15px;
      font-size: 0.9em;
      position: sticky;
      top: 0;
    }
    
    .tasks-table td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border);
      font-size: 0.9em;
      vertical-align: top;
    }
    
    .tasks-table tr:last-child td {
      border-bottom: none;
    }
    
    .tasks-table tr:hover {
      background: #f2f6fb;
    }
    
    .job-cell {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .job-cell.expanded {
      white-space: normal;
      max-width: none;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .action-btn {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .edit-btn {
      background: var(--info);
      color: white;
    }
    
    .delete-btn {
      background: var(--danger);
      color: white;
    }
    
    .expand-btn {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    
    /* Status Badges */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
      text-align: center;
      display: inline-block;
    }
    .status-start {
      background-color: #e3f2fd;
      color: #1976d2;
    }
    .status-ongoing {
      background-color: #fff3e0;
      color: #f57c00;
    }
    .status-completed {
      background-color: #e8f5e9;
      color: #388e3c;
    }
    .status-absent {
      background-color: #ffebee;
      color: #d32f2f;
    }
    
    /* Statistics Section */
    .stats-container {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      margin: 15px auto;
      padding: 16px;
      max-width: 98vw;
      width: 460px;
      border: 1px solid var(--border);
    }
    .stats-title {
      font-weight: bold;
      color: var(--primary);
      text-align: center;
      margin-bottom: 15px;
      font-size: 1.1em;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .stat-card {
      background: #f2f6fb;
      border-radius: 6px;
      padding: 12px;
      text-align: center;
      border: 1px solid var(--border);
    }
    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary);
    }
    .stat-label {
      font-size: 0.85em;
      color: #666;
      margin-top: 5px;
    }
    
    /* Unworked Hours Section */
    .unworked-container {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      margin: 15px auto;
      padding: 16px;
      max-width: 98vw;
      width: 460px;
      border: 1px solid var(--border);
    }
    .unworked-title {
      font-weight: bold;
      color: var(--primary);
      text-align: center;
      margin-bottom: 15px;
      font-size: 1.1em;
    }
    .unworked-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .unworked-card {
      background: #ffebee;
      border-radius: 6px;
      padding: 10px;
      border: 1px solid #ffcdd2;
    }
    .unworked-name {
      font-weight: bold;
      color: #d32f2f;
    }
    .unworked-hours {
      font-size: 1.2em;
      font-weight: bold;
      color: #d32f2f;
      margin-top: 5px;
    }
    
    /* Form Error */
    #formError {
      color: var(--danger);
      margin-top: 8px;
      font-size: 0.9em;
      padding: 8px;
      background: #ffebee;
      border-radius: 4px;
      border-left: 3px solid var(--danger);
    }
    
    /* Employee Cards */
    .employee-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
      margin: 15px 0;
      padding: 0 4vw;
      width: 100%;
      box-sizing: border-box;
    }
    
    .employee-card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .employee-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .employee-card.active {
      background: var(--primary);
      color: white;
    }
    
    .employee-name {
      font-weight: 600;
      font-size: 0.9em;
      margin-bottom: 5px;
    }
    
    .employee-hours {
      font-size: 1.1em;
      font-weight: bold;
      color: var(--primary);
    }
    
    .employee-card.active .employee-hours {
      color: white;
    }
    
    /* Toggle buttons for sections */
    .section-toggle {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
      padding: 0 4vw;
    }
    
    .toggle-btn {
      padding: 8px 16px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85em;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .toggle-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Filter Controls */
    .filter-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
      padding: 0 4vw;
    }
    
    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85em;
    }
    
    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Date Filter Controls */
    .date-filter {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
      padding: 0 4vw;
    }
    
    .date-filter input {
      width: 150px;
      padding: 8px;
      font-size: 0.9em;
    }
    
    .date-filter button {
      padding: 8px 16px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background: var(--primary);
      color: white;
      cursor: pointer;
      font-size: 0.9em;
    }
    
    .date-filter button:hover {
      background: var(--primary-dark);
    }
    
    /* Month Filter */
    .month-filter {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
      padding: 0 4vw;
    }
    
    .month-filter select {
      width: 150px;
      padding: 8px;
      font-size: 0.9em;
    }
    
    .month-filter button {
      padding: 8px 16px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background: var(--primary);
      color: white;
      cursor: pointer;
      font-size: 0.9em;
    }
    
    .month-filter button:hover {
      background: var(--primary-dark);
    }
    
    /* Person Filter */
    .person-filter {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
      padding: 0 4vw;
    }
    
    .person-filter select {
      width: 200px;
      padding: 8px;
      font-size: 0.9em;
    }
    
    .person-filter button {
      padding: 8px 16px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background: var(--primary);
      color: white;
      cursor: pointer;
      font-size: 0.9em;
    }
    
    .person-filter button:hover {
      background: var(--primary-dark);
    }
    
    /* Task ID Suggestions */
    .suggestions-container {
      position: relative;
    }
    
    .suggestions-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 5px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    
    .suggestion-item:hover {
      background: var(--light-bg);
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    /* Loading indicator */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        font-size: 13px;
      }
      .header-bar, .welcome {
        padding-left: 3vw;
        padding-right: 3vw;
      }
      .header-controls {
        gap: 6px;
      }
      .btn {
        padding: 7px 10px;
        font-size: 0.85em;
      }
      .form-container, .stats-container, .unworked-container { 
        max-width: 94vw; 
        border-radius: 0; 
        padding: 10px 3vw 6px;
        box-shadow: none;
        border-left: none;
        border-right: none;
      }
      .table-container { 
        padding: 0 3vw 16px; 
      }
      .tasks-table {
        font-size: 0.85em;
      }
      .tasks-table th, 
      .tasks-table td {
        padding: 8px 10px;
      }
      .filter-controls {
        gap: 6px;
      }
      .filter-btn {
        padding: 6px 12px;
        font-size: 0.8em;
      }
      .date-filter, .month-filter, .person-filter {
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      .date-filter input, .month-filter select, .person-filter select {
        width: 80%;
        max-width: 200px;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .action-buttons {
        flex-direction: column;
        gap: 5px;
      }
      .employee-cards {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 8px;
      }
    }
    
    /* Animation for form toggle */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .form-container, .stats-container, .unworked-container {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <h2>EMPLOYEE WORK TRACKER</h2>
    <div class="header-controls">
      <button class="btn btn-toggle" id="addBtn" onclick="toggleForm()">
        <i class="fas fa-plus"></i> Add Task
      </button>
      <button class="btn btn-absent" id="markAbsentBtn" onclick="toggleAbsentForm()">
        <i class="fas fa-user-times"></i> Mark Absent
      </button>
      <button class="btn btn-logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>
  <div class="welcome" id="welcome">WELCOME PENTA</div>
  
  <div class="section-toggle">
    <button class="toggle-btn active" data-section="employees" onclick="toggleSection('employees')">
      <i class="fas fa-users"></i> Employees
    </button>
    <button class="toggle-btn" data-section="filters" onclick="toggleSection('filters')">
      <i class="fas fa-filter"></i> Filters
    </button>
    <button class="toggle-btn" data-section="stats" onclick="toggleSection('stats')">
      <i class="fas fa-chart-bar"></i> Stats
    </button>
  </div>
  
  <div class="employee-cards" id="employeeCards">
    <!-- Employee cards will be populated here -->
  </div>
  
  <div class="filter-controls" id="filterControls" style="display: none;">
    <button class="filter-btn active" data-filter="all">All Tasks</button>
    <button class="filter-btn" data-filter="today">Today</button>
    <button class="filter-btn" data-filter="tomorrow">Tomorrow</button>
    <button class="filter-btn" data-filter="week">This Week</button>
    <button class="filter-btn" data-filter="month">This Month</button>
  </div>
  
  <div class="person-filter" id="personFilter" style="display: none;">
    <select id="personSelect">
      <option value="">All People</option>
      <!-- Options will be populated dynamically -->
    </select>
    <button onclick="applyPersonFilter()">Apply Person Filter</button>
    <button onclick="clearPersonFilter()">Clear Filter</button>
  </div>
  
  <div class="date-filter" id="dateFilter" style="display: none;">
    <input type="date" id="startDate" placeholder="Start Date">
    <input type="date" id="endDate" placeholder="End Date">
    <button onclick="applyDateFilter()">Apply Date Filter</button>
    <button onclick="clearDateFilter()">Clear Filter</button>
  </div>
  
  <div class="month-filter" id="monthFilter" style="display: none;">
    <select id="monthSelect">
      <option value="">Select Month</option>
      <option value="0">January</option>
      <option value="1">February</option>
      <option value="2">March</option>
      <option value="3">April</option>
      <option value="4">May</option>
      <option value="5">June</option>
      <option value="6">July</option>
      <option value="7">August</option>
      <option value="8">September</option>
      <option value="9">October</option>
      <option value="10">November</option>
      <option value="11">December</option>
    </select>
    <select id="yearSelect">
      <option value="">Select Year</option>
    </select>
    <button onclick="applyMonthFilter()">Apply Month Filter</button>
    <button onclick="clearMonthFilter()">Clear Filter</button>
  </div>
  
  <div class="unworked-container" id="unworkedContainer" style="display: none;">
    <div class="unworked-title">Absent Days</div>
    <div class="unworked-grid" id="unworkedGrid">
      <!-- Absent days will be populated here -->
    </div>
  </div>
  
  <div class="stats-container" id="statsContainer" style="display: none;">
    <div class="stats-title">Work Summary</div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalTasks">0</div>
        <div class="stat-label">Total Tasks</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalHours">0</div>
        <div class="stat-label">Total Hours</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgHours">0</div>
        <div class="stat-label">Avg Hours/Task</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="daysAbsent">0</div>
        <div class="stat-label">Days Absent</div>
      </div>
    </div>
  </div>
  
  <div id="userView">
    <div class="form-container" id="formContainer" style="display: none;">
      <form id="taskForm">
        <input type="hidden" id="taskId">
        <input type="hidden" id="originalUsername">
        
        <label>Task ID</label>
        <div class="suggestions-container">
          <input type="text" id="taskID" required list="taskIDSuggestions" autocomplete="off">
          <div class="suggestions-list" id="taskIDSuggestions" style="display: none;"></div>
        </div>
        <small style="color: #666;">Type to search existing Task IDs or enter a new one</small>
        
        <label>Name</label>
        <select id="name" required>
          <option value="">Select Name</option>
          <option value="BRIGHTON MATOLOKOSH">BRIGHTON MATOLOKOSH</option>
          <option value="CAPHAS TEMBO">CAPHAS TEMBO</option>
          <option value="CLISHA MAMBILIMA">CLISHA MAMBILIMA</option>
          <option value="DABSON DAKA">DABSON DAKA</option>
          <option value="DANNY MVULA">DANNY MVULA</option>
          <option value="JOSEPH TEMBO">JOSEPH TEMBO</option>
          <option value="LUCKSON PHIRI">LUCKSON PHIRI</option>
          <option value="MICHEAL LOBELA">MICHEAL LOBELA</option>
          <option value="OBERT SIAME">OBERT SIAME</option>
          <option value="DOMINIC SAKALA">DOMINIC SAKALA</option>
          <option value="PETER MAWERE">PETER MAWERE</option>
          <option value="SAVIOUR PHIRI">SAVIOUR PHIRI</option>
          <option value="TEMBEYA SAKALA">TEMBEYA SAKALA</option>
          <option value="KELVIN SIAME">KELVIN SIAME</option>
          <option value="ORSCAR MUSHIPEE">ORSCAR MUSHIPEE</option>
          <option value="NICKSON MUMBA">NICKSON MUMBA</option>
        </select>
        
        <label>Location</label>
        <input type="text" id="location" required>
        
        <label>Job Done</label>
        <textarea id="job" required></textarea>
        
        <label>Hours Worked</label>
        <input type="number" id="hours" min="0.5" max="24" step="0.5" required>
        
        <label>Date</label>
        <input type="date" id="date" required>
        
        <label>Status</label>
        <select id="status" required>
          <option value="start">Start</option>
          <option value="ongoing">Ongoing</option>
          <option value="completed">Completed</option>
        </select>
        
        <div class="action-buttons">
          <button type="submit" class="btn btn-submit" id="submitBtn">
            <i class="fas fa-save"></i> Save Task
          </button>
          <button type="button" class="btn btn-danger" id="cancelEdit" style="display: none;" onclick="cancelEdit()">
            <i class="fas fa-times"></i> Cancel Edit
          </button>
        </div>
        <div id="formError" style="display: none;"></div>
      </form>
    </div>
    
    <div class="form-container" id="absentFormContainer" style="display: none;">
      <form id="absentForm">
        <h3 style="text-align: center; color: var(--warning); margin-top: 0;">Mark Absence</h3>
        
        <label>Name</label>
        <select id="absentName" required>
          <option value="">Select Name</option>
          <option value="BRIGHTON MATOLOKOSH">BRIGHTON MATOLOKOSH</option>
          <option value="CAPHAS TEMBO">CAPHAS TEMBO</option>
          <option value="CLISHA MAMBILIMA">CLISHA MAMBILIMA</option>
          <option value="DABSON DAKA">DABSON DAKA</option>
          <option value="DANNY MVULA">DANNY MVULA</option>
          <option value="JOSEPH TEMBO">JOSEPH TEMBO</option>
          <option value="LUCKSON PHIRI">LUCKSON PHIRI</option>
          <option value="MICHEAL LOBELA">MICHEAL LOBELA</option>
          <option value="OBERT SIAME">OBERT SIAME</option>
          <option value="DOMINIC SAKALA">DOMINIC SAKALA</option>
          <option value="PETER MAWERE">PETER MAWERE</option>
          <option value="SAVIOUR PHIRI">SAVIOUR PHIRI</option>
          <option value="TEMBEYA SAKALA">TEMBEYA SAKALA</option>
          <option value="KELVIN SIAME">KELVIN SIAME</option>
          <option value="ORSCAR MUSHIPEE">ORSCAR MUSHIPEE</option>
          <option value="NICKSON MUMBA">NICKSON MUMBA</option>
        </select>
        
        <label>Date</label>
        <input type="date" id="absentDate" required>
        
        <label>Reason (Optional)</label>
        <textarea id="absentReason"></textarea>
        
        <div class="action-buttons">
          <button type="submit" class="btn btn-submit" id="submitAbsentBtn">
            <i class="fas fa-user-times"></i> Mark as Absent
          </button>
          <button type="button" class="btn btn-danger" onclick="toggleAbsentForm()">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
        <div id="absentFormError" style="display: none;"></div>
      </form>
    </div>
    
    <div class="table-container" id="tableContainer">
      <table class="tasks-table" id="tasksTable">
        <thead>
          <tr>
            <th>Task ID</th>
            <th>Name</th>
            <th>Location</th>
            <th>Job Done</th>
            <th>Hours</th>
            <th>Date</th>
            <th>Status</th>
            <th>Added By</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tasksTableBody">
          <!-- Tasks will be populated here -->
        </tbody>
      </table>
    </div>
  </div>

<script>
// ---- CONFIGURATION ----
const ADMIN_USERS = ['faiyaz mulla', 'christopher', 'chris', 'faiyaz', 'penta'];
const GENERAL_PASSWORD = '12345';
const EMPLOYEE_NAMES = [
  "BRIGHTON MATOLOKOSH",
  "CAPHAS TEMBO",
  "CLISHA MAMBILIMA",
  "DABSON DAKA",
  "DANNY MVULA",
  "JOSEPH TEMBO",
  "LUCKSON PHIRI",
  "MICHEAL LOBELA",
  "OBERT SIAME",
  "DOMINIC SAKALA",
  "PETER MAWERE",
  "SAVIOUR PHIRI",
  "TEMBEYA SAKALA",
  "KELVIN SIAME",
  "ORSCAR MUSHIPEE",
  "NICKSON MUMBA"
];

// ---- FIREBASE SETUP ----
const firebaseConfig = {
  apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
  authDomain: "project-task-588c4.firebaseapp.com",
  projectId: "project-task-588c4",
  storageBucket: "project-task-588c4.appspot.com",
  messagingSenderId: "411882772509",
  appId: "1:411882772509:web:08d613186c101a99f38ef4",
  measurementId: "G-JMFLFYEM0F"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---- USER MANAGEMENT ----
function getCurrentUser() {
  return localStorage.getItem('currentUser') || null;
}
function isAdmin(user) {
  if (!user) return false;
  return ADMIN_USERS.includes(user.toLowerCase());
}
function logout() {
  localStorage.removeItem('currentUser');
  localStorage.removeItem('currentFilter');
  localStorage.removeItem('dateFilter');
  localStorage.removeItem('monthFilter');
  localStorage.removeItem('personFilter');
  location.href = "index.html";
}
function showWelcome(user) {
  let name = user.trim().split(" ");
  name = name.length === 1 ? name[0] : name.slice(-2).join(" ");
  document.getElementById('welcome').innerHTML = `WELCOME <span style="color:var(--primary)">${name.toUpperCase()}</span>`;
}

// ---- FORM TOGGLE ----
function toggleForm() {
  const fc = document.getElementById("formContainer");
  const afc = document.getElementById("absentFormContainer");
  
  if (fc.style.display === "none") {
    resetForm();
    fc.style.display = "block";
    afc.style.display = "none";
    document.getElementById("addBtn").innerHTML = '<i class="fas fa-times"></i> Cancel';
  } else {
    fc.style.display = "none";
    document.getElementById("addBtn").innerHTML = '<i class="fas fa-plus"></i> Add Task';
  }
}

function toggleAbsentForm() {
  const fc = document.getElementById("formContainer");
  const afc = document.getElementById("absentFormContainer");
  
  if (afc.style.display === "none") {
    resetAbsentForm();
    afc.style.display = "block";
    fc.style.display = "none";
    document.getElementById("markAbsentBtn").innerHTML = '<i class="fas fa-times"></i> Cancel';
  } else {
    afc.style.display = "none";
    document.getElementById("markAbsentBtn").innerHTML = '<i class="fas fa-user-times"></i> Mark Absent';
  }
}

function resetForm() {
  document.getElementById("taskForm").reset();
  document.getElementById("taskId").value = "";
  document.getElementById("originalUsername").value = "";
  
  // Set default date to tomorrow
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  document.getElementById("date").valueAsDate = tomorrow;
  
  document.getElementById("status").value = "start";
  document.getElementById("cancelEdit").style.display = "none";
  document.getElementById("formError").style.display = "none";
  document.getElementById("taskIDSuggestions").style.display = "none";
  
  // Set the name to current user if they're in the employee list
  const user = getCurrentUser();
  if (user && EMPLOYEE_NAMES.includes(user.toUpperCase())) {
    document.getElementById("name").value = user.toUpperCase();
  }
}

function resetAbsentForm() {
  document.getElementById("absentForm").reset();
  
  // Set default date to tomorrow
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  document.getElementById("absentDate").valueAsDate = tomorrow;
  
  document.getElementById("absentFormError").style.display = "none";
  
  // Set the name to current user if they're in the employee list
  const user = getCurrentUser();
  if (user && EMPLOYEE_NAMES.includes(user.toUpperCase())) {
    document.getElementById("absentName").value = user.toUpperCase();
  }
}

function cancelEdit() {
  resetForm();
  toggleForm();
}

// ---- TASK CRUD ----
let allTasks = [];
let allTaskIDs = new Set();
let unsubscribe = null;
let currentFilter = localStorage.getItem('currentFilter') || 'all';
let dateFilter = JSON.parse(localStorage.getItem('dateFilter')) || {};
let monthFilter = JSON.parse(localStorage.getItem('monthFilter')) || {};
let personFilter = JSON.parse(localStorage.getItem('personFilter')) || {};

function listenTasks() {
  const user = getCurrentUser();
  if (!user) return;
  if (unsubscribe) unsubscribe();
  
  // Show loading state
  document.getElementById("tasksTableBody").innerHTML = `
    <tr>
      <td colspan="9" style="text-align:center; padding:20px;">
        <div class="loading" style="border-top-color: var(--primary); margin:0 auto;"></div>
        <p style="color:#666; margin-top:10px;">Loading tasks...</p>
      </td>
    </tr>
  `;
  
  let query = db.collection("TASKS");
  
  // Everyone can see all tasks now
  unsubscribe = query.onSnapshot(snapshot => {
    allTasks = [];
    allTaskIDs.clear();
    snapshot.forEach(doc => {
      const data = doc.data();
      data._id = doc.id;
      allTasks.push(data);
      // Collect all unique task IDs for auto-complete
      if (data.taskID) {
        allTaskIDs.add(data.taskID);
      }
    });
    renderTasks();
    updateFilterButtons();
    updateDateFilterInputs();
    updateMonthFilterInputs();
    updatePersonFilterInputs();
    updateStatistics();
    updateUnworkedHours();
    updateEmployeeCards();
  }, error => {
    console.error("Error loading tasks:", error);
    document.getElementById("tasksTableBody").innerHTML = `
      <tr>
        <td colspan="9" style="text-align:center; padding:20px; color:var(--danger);">
          Error loading tasks. Please refresh the page.
        </td>
      </tr>
    `;
  });
}

function renderTasks() {
  const tbody = document.getElementById("tasksTableBody");
  tbody.innerHTML = "";
  let filteredTasks = filterTasks(allTasks);
  
  // Apply date filter if set
  if (dateFilter.startDate || dateFilter.endDate) {
    filteredTasks = applyDateFilterToTasks(filteredTasks);
  }
  
  // Apply month filter if set
  if (monthFilter.month !== undefined || monthFilter.year) {
    filteredTasks = applyMonthFilterToTasks(filteredTasks);
  }
  
  // Apply person filter if set
  if (personFilter.person) {
    filteredTasks = applyPersonFilterToTasks(filteredTasks);
  }
  
  if (filteredTasks.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" style="text-align:center; padding:20px; color:#666;">
          No tasks found
        </td>
      </tr>
    `;
    return;
  }
  
  const sortedTasks = [...filteredTasks].sort((a, b) => {
    return (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0);
  });
  
  sortedTasks.forEach(task => {
    const row = createTaskRow(task);
    tbody.appendChild(row);
  });
}

function createTaskRow(task) {
  const row = document.createElement('tr');
  const jobCell = document.createElement('td');
  jobCell.className = 'job-cell';
  jobCell.textContent = task.job || "No description";
  
  // Add expand functionality for job description
  jobCell.addEventListener('click', function() {
    this.classList.toggle('expanded');
  });
  
  // Determine status badge class
  let statusClass = 'status-start';
  let statusText = 'Start';
  
  if (task.status === 'ongoing') {
    statusClass = 'status-ongoing';
    statusText = 'Ongoing';
  } else if (task.status === 'completed') {
    statusClass = 'status-completed';
    statusText = 'Completed';
  } else if (task.status === 'absent') {
    statusClass = 'status-absent';
    statusText = 'Absent';
  }
  
  row.innerHTML = `
    <td>${task.taskID || task._id.substring(0, 8)}</td>
    <td>${task.name || "Unknown"}</td>
    <td>${task.location || "None"}</td>
    <td class="job-cell">${task.job || "No description"}</td>
    <td>${task.status === 'absent' ? '0' : (task.hours || 0)}</td>
    <td>${task.date || formatDate(task.createdAt?.toDate())}</td>
    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
    <td>${task.username || "Unknown"}</td>
    <td>
      <div class="action-buttons">
        <button class="action-btn edit-btn" onclick="editTask('${task._id}', event)" ${!isAdmin(getCurrentUser()) ? 'disabled' : ''}>
          <i class="fas fa-edit"></i> Edit
        </button>
        <button class="action-btn delete-btn" onclick="deleteTask('${task._id}', event)" ${!isAdmin(getCurrentUser()) ? 'disabled' : ''}>
          <i class="fas fa-trash"></i> Delete
        </button>
      </div>
    </td>
  `;
  
  // Replace the job cell with our custom one
  row.replaceChild(jobCell, row.cells[3]);
  
  return row;
}

function filterTasks(tasks) {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate() + 1);
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - today.getDay());
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  
  switch(currentFilter) {
    case 'tomorrow': 
      return tasks.filter(task => {
        const taskDate = task.date ? new Date(task.date) : task.createdAt?.toDate();
        return taskDate >= tomorrow && taskDate < new Date(tomorrow.getTime() + 24 * 60 * 60 * 1000);
      });
    case 'today': 
      return tasks.filter(task => {
        const taskDate = task.date ? new Date(task.date) : task.createdAt?.toDate();
        return taskDate >= today && taskDate < tomorrow;
      });
    case 'week': 
      return tasks.filter(task => {
        const taskDate = task.date ? new Date(task.date) : task.createdAt?.toDate();
        return taskDate >= weekStart;
      });
    case 'month': 
      return tasks.filter(task => {
        const taskDate = task.date ? new Date(task.date) : task.createdAt?.toDate();
        return taskDate >= monthStart;
      });
    default: return tasks;
  }
}

function applyDateFilterToTasks(tasks) {
  const startDate = dateFilter.startDate ? new Date(dateFilter.startDate) : null;
  const endDate = dateFilter.endDate ? new Date(dateFilter.endDate) : null;
  
  if (startDate) startDate.setHours(0, 0, 0, 0);
  if (endDate) endDate.setHours(23, 59, 59, 999);
  
  return tasks.filter(task => {
    const taskDate = task.date ? new Date(task.date) : task.createdAt?.toDate();
    
    if (startDate && taskDate < startDate) return false;
    if (endDate && taskDate > endDate) return false;
    
    return true;
  });
}

function applyMonthFilterToTasks(tasks) {
  const month = monthFilter.month !== undefined ? parseInt(monthFilter.month) : null;
  const year = monthFilter.year ? parseInt(monthFilter.year) : null;
  
  return tasks.filter(task => {
    const taskDate = task.date ? new Date(task.date) : task.createdAt?.toDate();
    const taskMonth = taskDate.getMonth();
    const taskYear = taskDate.getFullYear();
    
    if (month !== null && taskMonth !== month) return false;
    if (year !== null && taskYear !== year) return false;
    
    return true;
  });
}

function applyPersonFilterToTasks(tasks) {
  const person = personFilter.person;
  
  if (!person) return tasks;
  
  return tasks.filter(task => {
    return task.name === person;
  });
}

function updateFilterButtons() {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.filter === currentFilter) {
      btn.classList.add('active');
    }
  });
}

function updateDateFilterInputs() {
  if (dateFilter.startDate) {
    document.getElementById('startDate').value = dateFilter.startDate;
  }
  if (dateFilter.endDate) {
    document.getElementById('endDate').value = dateFilter.endDate;
  }
}

function updateMonthFilterInputs() {
  if (monthFilter.month !== undefined) {
    document.getElementById('monthSelect').value = monthFilter.month;
  }
  if (monthFilter.year) {
    document.getElementById('yearSelect').value = monthFilter.year;
  }
}

function updatePersonFilterInputs() {
  if (personFilter.person) {
    document.getElementById('personSelect').value = personFilter.person;
  }
}

function formatDate(dateValue) {
  if (!dateValue) return '';
  try {
    const date = dateValue.toDate ? dateValue.toDate() : new Date(dateValue);
    return date.toLocaleDateString();
  } catch (e) {
    return dateValue;
  }
}

// ---- EMPLOYEE CARDS ----
function updateEmployeeCards() {
  const employeeCards = document.getElementById('employeeCards');
  employeeCards.innerHTML = '';
  
  // Calculate total hours for each employee
  const employeeHours = {};
  const employeeAbsentDays = {};
  
  EMPLOYEE_NAMES.forEach(name => {
    employeeHours[name] = 0;
    employeeAbsentDays[name] = 0;
  });
  
  allTasks.forEach(task => {
    if (EMPLOYEE_NAMES.includes(task.name)) {
      if (task.status === 'absent') {
        employeeAbsentDays[task.name]++;
      } else {
        employeeHours[task.name] += parseFloat(task.hours) || 0;
      }
    }
  });
  
  // Create cards for each employee
  EMPLOYEE_NAMES.forEach(name => {
    const card = document.createElement('div');
    card.className = 'employee-card';
    card.dataset.name = name;
    
    // Get first name for display
    const firstName = name.split(' ')[0];
    
    card.innerHTML = `
      <div class="employee-name">${firstName}</div>
      <div class="employee-hours">${employeeHours[name].toFixed(1)}h</div>
      <div style="font-size: 0.8em; margin-top: 5px; color: ${employeeAbsentDays[name] > 0 ? '#d32f2f' : '#666'}">
        Absent: ${employeeAbsentDays[name]} days
      </div>
    `;
    
    card.addEventListener('click', function() {
      // Toggle active state
      document.querySelectorAll('.employee-card').forEach(c => {
        c.classList.remove('active');
      });
      this.classList.add('active');
      
      // Apply person filter
      personFilter = {
        person: name
      };
      
      // Save to localStorage
      localStorage.setItem('personFilter', JSON.stringify(personFilter));
      
      // Re-render tasks
      renderTasks();
    });
    
    employeeCards.appendChild(card);
  });
}

// ---- SECTION TOGGLE ----
function toggleSection(section) {
  // Update toggle buttons
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.section === section) {
      btn.classList.add('active');
    }
  });
  
  // Show/hide sections
  const sections = {
    'employees': document.getElementById('employeeCards'),
    'filters': [
      document.getElementById('filterControls'),
      document.getElementById('dateFilter'),
      document.getElementById('monthFilter'),
      document.getElementById('personFilter')
    ],
    'stats': [
      document.getElementById('statsContainer'),
      document.getElementById('unworkedContainer')
    ]
  };
  
  // Hide all sections first
  Object.values(sections).forEach(section => {
    if (Array.isArray(section)) {
      section.forEach(el => el.style.display = 'none');
    } else {
      section.style.display = 'none';
    }
  });
  
  // Show selected section
  if (Array.isArray(sections[section])) {
    sections[section].forEach(el => el.style.display = 'flex');
  } else {
    sections[section].style.display = 'grid';
  }
}

// ---- TASK ID AUTO-COMPLETE ----
function setupTaskIDAutocomplete() {
  const taskIDInput = document.getElementById('taskID');
  const suggestionsContainer = document.getElementById('taskIDSuggestions');
  
  taskIDInput.addEventListener('input', function() {
    const value = this.value.toLowerCase();
    const suggestions = Array.from(allTaskIDs).filter(taskID => 
      taskID.toLowerCase().includes(value)
    );
    
    showSuggestions(suggestions);
  });
  
  taskIDInput.addEventListener('focus', function() {
    if (this.value) {
      const value = this.value.toLowerCase();
      const suggestions = Array.from(allTaskIDs).filter(taskID => 
        taskID.toLowerCase().includes(value)
      );
      showSuggestions(suggestions);
    } else {
      showSuggestions(Array.from(allTaskIDs).slice(0, 10));
    }
  });
  
  taskIDInput.addEventListener('blur', function() {
    // Hide suggestions after a short delay to allow clicking on them
    setTimeout(() => {
      suggestionsContainer.style.display = 'none';
    }, 200);
  });
  
  // Prevent form submission when selecting a suggestion
  taskIDInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && suggestionsContainer.style.display !== 'none') {
      e.preventDefault();
      const activeSuggestion = suggestionsContainer.querySelector('.suggestion-item:hover');
      if (activeSuggestion) {
        activeSuggestion.click();
      }
    }
  });
}

function showSuggestions(suggestions) {
  const suggestionsContainer = document.getElementById('taskIDSuggestions');
  
  if (suggestions.length === 0) {
    suggestionsContainer.style.display = 'none';
    return;
  }
  
  suggestionsContainer.innerHTML = '';
  suggestions.slice(0, 10).forEach(taskID => {
    const suggestionItem = document.createElement('div');
    suggestionItem.className = 'suggestion-item';
    suggestionItem.textContent = taskID;
    suggestionItem.addEventListener('mousedown', function() {
      document.getElementById('taskID').value = taskID;
      suggestionsContainer.style.display = 'none';
      // Auto-fill other fields if this task ID exists
      autoFillTaskDetails(taskID);
    });
    suggestionsContainer.appendChild(suggestionItem);
  });
  
  suggestionsContainer.style.display = 'block';
}

function autoFillTaskDetails(taskID) {
  // Find the most recent task with this ID to auto-fill details
  const tasksWithThisID = allTasks
    .filter(task => task.taskID === taskID && task.status !== 'absent')
    .sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
  
  if (tasksWithThisID.length > 0) {
    const latestTask = tasksWithThisID[0];
    document.getElementById('name').value = latestTask.name || '';
    document.getElementById('location').value = latestTask.location || '';
    document.getElementById('job').value = latestTask.job || '';
    document.getElementById('status').value = latestTask.status || 'start';
  }
}

// ---- STATISTICS ----
function updateStatistics() {
  // Count unique task IDs (excluding absent days)
  const taskIDs = new Set();
  const tasksWithHours = allTasks.filter(task => task.status !== 'absent');
  
  tasksWithHours.forEach(task => {
    if (task.taskID) {
      taskIDs.add(task.taskID);
    }
  });
  
  // Total unique tasks (by task ID)
  document.getElementById('totalTasks').textContent = taskIDs.size;
  
  // Total hours (excluding absent days)
  const totalHours = tasksWithHours.reduce((sum, task) => {
    return sum + (parseFloat(task.hours) || 0);
  }, 0);
  document.getElementById('totalHours').textContent = totalHours.toFixed(1);
  
  // Average hours per unique task
  const avgHours = taskIDs.size > 0 ? totalHours / taskIDs.size : 0;
  document.getElementById('avgHours').textContent = avgHours.toFixed(1);
  
  // Days absent
  const daysAbsent = allTasks.filter(task => task.status === 'absent').length;
  document.getElementById('daysAbsent').textContent = daysAbsent;
}

// ---- ABSENT DAYS CALCULATION ----
function updateUnworkedHours() {
  const unworkedGrid = document.getElementById('unworkedGrid');
  unworkedGrid.innerHTML = '';
  
  // Calculate absent days for each employee
  const employeeAbsentDays = {};
  
  // Initialize employee data
  EMPLOYEE_NAMES.forEach(name => {
    employeeAbsentDays[name] = 0;
  });
  
  // Calculate absent days
  allTasks.forEach(task => {
    if (EMPLOYEE_NAMES.includes(task.name) && task.status === 'absent') {
      employeeAbsentDays[task.name]++;
    }
  });
  
  // Create absent cards for employees with absent days
  const absentData = [];
  EMPLOYEE_NAMES.forEach(name => {
    const absentDays = employeeAbsentDays[name];
    
    if (absentDays > 0) {
      absentData.push({
        name: name,
        absentDays: absentDays
      });
    }
  });
  
  // Sort by absent days (descending)
  absentData.sort((a, b) => b.absentDays - a.absentDays);
  
  // Display absent days
  if (absentData.length === 0) {
    unworkedGrid.innerHTML = '<div style="text-align:center; color:#666; padding:10px;">No absent days recorded</div>';
    return;
  }
  
  absentData.forEach(employee => {
    const absentCard = document.createElement('div');
    absentCard.className = 'unworked-card';
    absentCard.innerHTML = `
      <div class="unworked-name">${employee.name}</div>
      <div class="unworked-hours">Absent: ${employee.absentDays} days</div>
    `;
    unworkedGrid.appendChild(absentCard);
  });
}

// ---- PERSON FILTER FUNCTIONS ----
function applyPersonFilter() {
  const person = document.getElementById('personSelect').value;
  
  personFilter = {
    person: person || null
  };
  
  // Save to localStorage
  localStorage.setItem('personFilter', JSON.stringify(personFilter));
  
  // Re-render tasks
  renderTasks();
}

function clearPersonFilter() {
  personFilter = {};
  document.getElementById('personSelect').value = '';
  localStorage.removeItem('personFilter');
  renderTasks();
}

// ---- DATE FILTER FUNCTIONS ----
function applyDateFilter() {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  
  // Validate dates
  if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
    alert('Start date cannot be after end date');
    return;
  }
  
  dateFilter = {
    startDate: startDate || null,
    endDate: endDate || null
  };
  
  // Save to localStorage
  localStorage.setItem('dateFilter', JSON.stringify(dateFilter));
  
  // Re-render tasks
  renderTasks();
}

function clearDateFilter() {
  dateFilter = {};
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  localStorage.removeItem('dateFilter');
  renderTasks();
}

// ---- MONTH FILTER FUNCTIONS ----
function applyMonthFilter() {
  const month = document.getElementById('monthSelect').value;
  const year = document.getElementById('yearSelect').value;
  
  monthFilter = {
    month: month !== "" ? month : null,
    year: year !== "" ? year : null
  };
  
  // Save to localStorage
  localStorage.setItem('monthFilter', JSON.stringify(monthFilter));
  
  // Re-render tasks
  renderTasks();
}

function clearMonthFilter() {
  monthFilter = {};
  document.getElementById('monthSelect').value = '';
  document.getElementById('yearSelect').value = '';
  localStorage.removeItem('monthFilter');
  renderTasks();
}

// ---- TASK ACTIONS ----
async function editTask(docId, event) {
  event.stopPropagation();
  
  // Check if user can edit this task - ONLY ADMINS
  const user = getCurrentUser();
  
  if (!isAdmin(user)) {
    alert("Only admins can edit tasks");
    return;
  }
  
  try {
    const doc = await db.collection("TASKS").doc(docId).get();
    if (!doc.exists) { alert("Task not found"); return; }
    const task = doc.data();
    document.getElementById("taskId").value = docId;
    document.getElementById("originalUsername").value = task.username || "";
    document.getElementById("taskID").value = task.taskID || "";
    document.getElementById("name").value = task.name || "";
    document.getElementById("location").value = task.location || "";
    document.getElementById("job").value = task.job || "";
    document.getElementById("hours").value = task.hours || "";
    document.getElementById("date").value = task.date || formatDateForInput(task.createdAt?.toDate());
    document.getElementById("status").value = task.status || "start";
    document.getElementById("cancelEdit").style.display = "inline-block";
    document.getElementById("formContainer").style.display = "block";
    document.getElementById("addBtn").innerHTML = '<i class="fas fa-times"></i> Cancel';
    document.getElementById("formContainer").scrollIntoView({ behavior: 'smooth' });
  } catch (err) {
    console.error("Error editing task:", err);
    alert("Failed to load task for editing");
  }
}

function formatDateForInput(dateValue) {
  if (!dateValue) return '';
  try {
    const date = dateValue.toDate ? dateValue.toDate() : new Date(dateValue);
    // Format for date input: YYYY-MM-DD
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    
    return `${year}-${month}-${day}`;
  } catch (e) {
    return '';
  }
}

async function deleteTask(docId, event) {
  event.stopPropagation();
  
  // Check if user can delete this task - ONLY ADMINS
  const user = getCurrentUser();
  
  if (!isAdmin(user)) {
    alert("Only admins can delete tasks");
    return;
  }
  
  if (!confirm("Are you sure you want to delete this task?")) return;
  try {
    await db.collection("TASKS").doc(docId).delete();
  } catch (err) {
    console.error("Error deleting task:", err);
    alert("Failed to delete task");
  }
}

// ---- FILTER CONTROLS ----
function setupFilterControls() {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      currentFilter = this.dataset.filter;
      localStorage.setItem('currentFilter', currentFilter);
      renderTasks();
      updateFilterButtons();
    });
  });
}

// ---- ADD/UPDATE TASK ----
document.getElementById("taskForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const user = getCurrentUser();
  if (!user) {
    alert("You must be logged in to submit a task");
    return;
  }
  
  // Show loading state on submit button
  const submitBtn = document.getElementById("submitBtn");
  const originalBtnText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<div class="loading"></div> Saving...';
  submitBtn.disabled = true;
  
  try {
    const formData = {
      taskID: document.getElementById("taskID").value,
      name: document.getElementById("name").value,
      location: document.getElementById("location").value,
      job: document.getElementById("job").value,
      hours: parseFloat(document.getElementById("hours").value),
      date: document.getElementById("date").value,
      status: document.getElementById("status").value,
      updatedAt: new Date()
    };
    
    const docId = document.getElementById("taskId").value;
    const originalUsername = document.getElementById("originalUsername").value;
    
    // Preserve the original username if editing (admin editing someone else's task)
    if (docId && originalUsername) {
      formData.username = originalUsername;
    } else {
      formData.username = user;
    }
    
    if (docId) {
      const doc = await db.collection("TASKS").doc(docId).get();
      if (doc.exists) {
        const existingData = doc.data();
        formData.createdAt = existingData.createdAt;
      }
    } else {
      formData.createdAt = new Date();
    }
    
    // Clean up data to ensure Firebase compatibility
    Object.keys(formData).forEach(key => {
      if (formData[key] === undefined || formData[key] === null) {
        delete formData[key];
      }
    });
    
    if (docId) {
      await db.collection("TASKS").doc(docId).set(formData, {merge: true});
    } else {
      await db.collection("TASKS").add(formData);
    }
    
    resetForm();
    document.getElementById("formContainer").style.display = "none";
    document.getElementById("addBtn").innerHTML = '<i class="fas fa-plus"></i> Add Task';
    document.getElementById("formError").style.display = "none";
    
  } catch (err) {
    const errorEl = document.getElementById("formError");
    errorEl.textContent = "Error saving task: " + (err.message || err);
    errorEl.style.display = 'block';
    console.error("Task submission error:", err);
  } finally {
    submitBtn.innerHTML = originalBtnText;
    submitBtn.disabled = false;
  }
});

// ---- MARK ABSENCE ----
document.getElementById("absentForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const user = getCurrentUser();
  if (!user) {
    alert("You must be logged in to mark absence");
    return;
  }
  
  // Show loading state on submit button
  const submitBtn = document.getElementById("submitAbsentBtn");
  const originalBtnText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<div class="loading"></div> Saving...';
  submitBtn.disabled = true;
  
  try {
    const formData = {
      name: document.getElementById("absentName").value,
      date: document.getElementById("absentDate").value,
      reason: document.getElementById("absentReason").value,
      status: 'absent',
      hours: 0,
      job: 'Absent',
      location: 'N/A',
      username: user,
      createdAt: new Date(),
      updatedAt: new Date()
    };
    
    // Check if absence already exists for this user on this date
    const existingAbsence = allTasks.find(task => 
      task.username === user && 
      task.date === formData.date && 
      task.status === 'absent'
    );
    
    if (existingAbsence) {
      alert("You have already marked yourself as absent for this date");
      return;
    }
    
    await db.collection("TASKS").add(formData);
    
    resetAbsentForm();
    document.getElementById("absentFormContainer").style.display = "none";
    document.getElementById("markAbsentBtn").innerHTML = '<i class="fas fa-user-times"></i> Mark Absent';
    document.getElementById("absentFormError").style.display = "none";
    
  } catch (err) {
    const errorEl = document.getElementById("absentFormError");
    errorEl.textContent = "Error marking absence: " + (err.message || err);
    errorEl.style.display = 'block';
    console.error("Absence submission error:", err);
  } finally {
    submitBtn.innerHTML = originalBtnText;
    submitBtn.disabled = false;
  }
});

// ---- INIT ----
function populateYearSelect() {
  const yearSelect = document.getElementById('yearSelect');
  const currentYear = new Date().getFullYear();
  
  // Add years from 2020 to current year + 1
  for (let year = 2020; year <= currentYear + 1; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    yearSelect.appendChild(option);
  }
}

function populatePersonSelect() {
  const personSelect = document.getElementById('personSelect');
  
  // Add all employee names to the person filter
  EMPLOYEE_NAMES.forEach(name => {
    const option = document.createElement('option');
    option.value = name;
    option.textContent = name;
    personSelect.appendChild(option);
  });
}

window.onload = function() {
  const user = getCurrentUser();
  if (!user) { 
    location.href = "index.html"; 
    return; 
  }
  showWelcome(user);
  setupFilterControls();
  setupTaskIDAutocomplete();
  populateYearSelect();
  populatePersonSelect();
  listenTasks();
}
</script>
</body>
</html>
