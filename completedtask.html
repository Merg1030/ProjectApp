<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completed Tasks</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #d3dfed; color: #0a1c2f; height: 100vh; overflow: hidden;
    }
    .page { height: 100vh; width: 100vw; display: flex; flex-direction: column; background: white; overflow: hidden; }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .page-header {
        padding: 6px 14px; background: #0a1c2f; color: white;
        border-bottom: 2px solid #1f3d62; display: flex; align-items: center;
        justify-content: space-between; flex-shrink: 0; min-height: 48px;
    }
    .header-left { display: flex; align-items: center; gap: 8px; }
    .header-left h2 { font-size: 14px; font-weight: 600; color: white; }
    .back-link {
        color: white; text-decoration: none; padding: 0.3rem 0.9rem;
        border: 1px solid rgba(255,255,255,0.3); border-radius: 30px; font-size: 0.72rem;
        font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s;
    }
    .back-link:hover { background: rgba(255,255,255,0.1); border-color: white; }

    /* ‚îÄ‚îÄ SUMMARY STRIP ‚îÄ‚îÄ */
    .summary-strip {
        display: flex; gap: 10px; padding: 6px 14px;
        background: #f2f6fc; border-bottom: 1px solid #b3c7e0;
        flex-shrink: 0; flex-wrap: wrap; align-items: center;
    }
    .stat-pill {
        background: white; border: 1px solid #b3c7e0; border-radius: 30px;
        padding: 3px 12px; font-size: 0.7rem; font-weight: 600; color: #0a1c2f; white-space: nowrap;
    }
    .stat-pill span { color: #059669; font-weight: 700; }

    /* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
    .filter-bar {
        padding: 6px 14px; background: #f2f6fc; border-bottom: 1px solid #b3c7e0;
        display: flex; flex-wrap: wrap; gap: 8px; align-items: center; flex-shrink: 0;
    }
    .search-box {
        display: flex; align-items: center; background: white;
        border: 1px solid #b3c7e0; border-radius: 30px; padding: 0.2rem 0.8rem;
    }
    .search-box input { border: none; padding: 2px 4px; width: 180px; outline: none; font-size: 11px; background: transparent; color: #0a1c2f; }
    .search-box input::placeholder { color: #7f96b3; }
    .filter-label { font-size: 11px; font-weight: 600; color: #1f3d62; }
    .filter-select {
        padding: 0.25rem 0.7rem; font-size: 0.7rem; border-radius: 30px;
        border: 1px solid #b3c7e0; background: white; color: #0a1c2f; font-weight: 500;
    }
    .filter-select:focus { outline: none; border-color: #2b4a73; }

    /* ‚îÄ‚îÄ SCROLL AREA ‚îÄ‚îÄ */
    .scroll-area {
        flex: 1; overflow: auto; background: #f0f4fa;
        scrollbar-width: thin; scrollbar-color: #97adc9 #ecf2fa;
        padding: 12px 14px;
    }
    .scroll-area::-webkit-scrollbar { width: 10px; height: 10px; background: #ecf2fa; }
    .scroll-area::-webkit-scrollbar-thumb { background: #97adc9; border-radius: 8px; }

    /* ‚îÄ‚îÄ GROUP CARD ‚îÄ‚îÄ */
    .group-card {
        background: white; border-radius: 10px; border: 1px solid #b3c7e0;
        box-shadow: 0 2px 8px rgba(10,28,47,0.07); margin-bottom: 16px; overflow: hidden;
    }

    /* Group heading ‚Äî main task name */
    .group-heading {
        background: #0a1c2f; color: white;
        padding: 8px 14px; display: flex; align-items: center; justify-content: space-between;
        flex-wrap: wrap; gap: 8px;
    }
    .group-heading-left { display: flex; align-items: center; gap: 10px; }
    .group-title { font-size: 0.85rem; font-weight: 700; }
    .group-taskid {
        background: rgba(255,255,255,0.15); padding: 2px 8px;
        border-radius: 20px; font-size: 0.65rem; font-weight: 600; color: #d4e2f2;
    }
    .group-meta { display: flex; gap: 8px; flex-wrap: wrap; }
    .group-badge {
        background: rgba(255,255,255,0.12); color: white;
        padding: 2px 8px; border-radius: 20px; font-size: 0.65rem; font-weight: 600;
    }
    .group-badge.green { background: rgba(5,150,105,0.5); }

    /* Main task status banner (if main task itself is not completed) */
    .main-status-banner {
        padding: 4px 14px; font-size: 0.68rem; font-weight: 600;
        display: flex; align-items: center; gap: 6px;
        background: #fef9e7; color: #92400e; border-bottom: 1px solid #fde68a;
    }
    .main-status-banner.ongoing { background: #eff6ff; color: #1e40af; border-bottom-color: #bfdbfe; }
    .main-status-banner.pending { background: #f9fafb; color: #6b7280; border-bottom-color: #e5e7eb; }

    /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
    .task-table-wrap { overflow-x: auto; }
    .task-table {
        width: 100%; border-collapse: collapse; font-size: 0.7rem; min-width: 1000px;
    }
    .task-table th {
        background: #d4e2f2; font-weight: 700; font-size: 0.62rem; padding: 7px 8px;
        border: 1px solid #9bb1cc; position: sticky; top: 0; z-index: 5;
        white-space: nowrap; text-align: center; color: #0a1c2f; border-bottom: 2px solid #1f3d62;
    }
    .task-table td {
        padding: 6px 8px; border: 1px solid #c7d6ec; white-space: nowrap;
        vertical-align: middle; color: #0a1c2f; font-size: 0.68rem;
    }
    .task-table tbody tr:hover td { background: #e3ecf7; }

    /* Row types */
    .row-sub    td { background: #f8fbff; }
    .row-subsub td { background: #f0f4fa; }
    .row-subsub td:first-child { padding-left: 36px; }

    .task-id-cell { font-size: 0.6rem; color: #4a6a8a; font-weight: 600; }

    .status-badge {
        display: inline-block; padding: 2px 7px; border-radius: 20px;
        font-size: 0.58rem; font-weight: 700; border: 1px solid;
    }
    .status-COMPLETED { background: #d1fae5; color: #065f46; border-color: #6ee7b7; }
    .status-ONGOING   { background: #dbeafe; color: #1e40af; border-color: #93c5fd; }
    .status-PENDING   { background: #f3f4f6; color: #374151; border-color: #d1d5db; }

    .cost-cell  { text-align: right; font-weight: 600; color: #059669; }
    .total-cell { text-align: right; font-weight: 700; color: #0a1c2f; }
    .hrs-cell   { text-align: center; color: #d97706; font-weight: 600; }

    /* Prefix arrows */
    .task-prefix { color: #4a6a8a; font-size: 0.7rem; margin-right: 4px; }

    /* Empty state */
    .empty-state {
        text-align: center; padding: 60px; color: #7f96b3; font-size: 0.8rem;
    }
    .empty-state i { font-size: 2.5rem; display: block; margin-bottom: 12px; color: #b3c7e0; }

    /* Loading */
    .loading { text-align: center; padding: 60px; color: #2b4a73; font-style: italic; font-size: 0.8rem; }
</style>
</head>
<body>
<div class="page">

    <!-- HEADER -->
    <div class="page-header">
        <div class="header-left">
            <i class="fas fa-check-circle" style="font-size:16px; color:#4ade80;"></i>
            <h2>Completed Tasks ‚Äî <span id="projectTitle">Project</span></h2>
        </div>
        <a href="javascript:history.back()" class="back-link">
            <i class="fas fa-arrow-left"></i> Back
        </a>
    </div>

    <!-- SUMMARY -->
    <div class="summary-strip">
        <div class="stat-pill">‚úÖ Groups: <span id="statGroups">‚Äî</span></div>
        <div class="stat-pill">üìã Completed Tasks: <span id="statCompleted">‚Äî</span></div>
        <div class="stat-pill">‚è± Total HRS: <span id="statHrs">‚Äî</span></div>
        <div class="stat-pill">üí∞ Total Cost: <span id="statCost">‚Äî</span></div>
    </div>

    <!-- FILTERS -->
    <div class="filter-bar">
        <div class="search-box">
            <i class="fas fa-search" style="color:#7f96b3; font-size:10px;"></i>
            <input type="text" id="searchInput" placeholder="Search tasks, description...">
        </div>
        <span class="filter-label">Main Task:</span>
        <select id="groupFilter" class="filter-select">
            <option value="">All</option>
        </select>
    </div>

    <!-- CONTENT -->
    <div class="scroll-area" id="scrollArea">
        <div class="loading" id="loadingState">
            <i class="fas fa-circle-notch fa-spin" style="font-size:1.5rem; display:block; margin-bottom:8px;"></i>
            Loading completed tasks...
        </div>
    </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import {
    getFirestore, collection, query, where, onSnapshot, getDocs
} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
    authDomain: "project-task-588c4.firebaseapp.com",
    projectId: "project-task-588c4",
    storageBucket: "project-task-588c4.appspot.com",
    messagingSenderId: "411882772509",
    appId: "1:411882772509:web:08d613186c101a99f38ef4"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

const urlParams  = new URLSearchParams(window.location.search);
const projectId  = urlParams.get('id');
if (!projectId) alert('Project ID missing!');

document.getElementById('projectTitle').textContent = `Project ${projectId?.slice(0,8) || ''}...`;

const scrollArea   = document.getElementById('scrollArea');
const loadingState = document.getElementById('loadingState');
const searchInput  = document.getElementById('searchInput');
const groupFilter  = document.getElementById('groupFilter');

let allTasks      = [];   // full task tree
let taskAssigned  = {};   // taskDocId ‚Üí "John, Jane" (first names from locationHistory)

const fmt     = n => (+(n||0)).toFixed(2);
const fmtDate = d => d ? new Date(d.toDate?d.toDate():d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';

// ‚îÄ‚îÄ Load assigned names from locationHistory ‚îÄ‚îÄ
async function loadAssignedNames() {
    try {
        const snap = await getDocs(query(collection(db,"locationHistory"), where("projectId","==",projectId)));
        const nameMap = {};
        snap.docs.forEach(d => {
            const x = d.data(); if (x.reversed) return;
            const tid = x.taskId || x.taskDocId; if (!tid) return;
            if (!nameMap[tid]) nameMap[tid] = new Set();
            const first = (x.employeeName||'').trim().split(' ')[0];
            if (first) nameMap[tid].add(first);
        });
        Object.keys(nameMap).forEach(tid => { taskAssigned[tid] = [...nameMap[tid]].join(', '); });
    } catch(e) { console.warn('loadAssignedNames:', e); }
}

// ‚îÄ‚îÄ Load full task tree ‚îÄ‚îÄ
async function loadTaskTree() {
    allTasks = [];
    const snap = await getDocs(query(collection(db,"projectTasks"), where("projectId","==",projectId)));

    const promises = snap.docs.map(async mainDoc => {
        const task = { id: mainDoc.id, ...mainDoc.data(), subTasks: [] };
        const subSnap = await getDocs(collection(db,"projectTasks",mainDoc.id,"subtasks"));
        const subPromises = subSnap.docs.map(async subDoc => {
            const sub = { id: subDoc.id, ...subDoc.data(), subSubtasks: [] };
            const ssSnap = await getDocs(collection(db,"projectTasks",mainDoc.id,"subtasks",subDoc.id,"subsubtasks"));
            sub.subSubtasks = ssSnap.docs.map(ssDoc => ({ id: ssDoc.id, ...ssDoc.data() }));
            return sub;
        });
        task.subTasks = await Promise.all(subPromises);
        return task;
    });

    allTasks = await Promise.all(promises);
    allTasks.sort((a,b) => (a.taskLine||0)-(b.taskLine||0));
}

// ‚îÄ‚îÄ Build group filter dropdown ‚îÄ‚îÄ
function buildGroupFilter() {
    const sel = groupFilter;
    const cur = sel.value;
    sel.innerHTML = '<option value="">All</option>';
    allTasks.forEach(t => {
        const hasCompleted = hasAnyCompleted(t);
        if (!hasCompleted) return;
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.taskDescription || t.taskId || t.id;
        if (opt.value === cur) opt.selected = true;
        sel.appendChild(opt);
    });
}

function hasAnyCompleted(task) {
    if (task.status === 'COMPLETED') return true;
    for (const sub of (task.subTasks||[])) {
        if (sub.status === 'COMPLETED') return true;
        for (const ss of (sub.subSubtasks||[])) {
            if (ss.status === 'COMPLETED') return true;
        }
    }
    return false;
}

// ‚îÄ‚îÄ Gather completed items for a task group ‚îÄ‚îÄ
// Returns array of row objects: { task, level, parentTask, parentSub }
function getCompletedRows(task) {
    const rows = [];
    // Main task itself if COMPLETED
    if (task.status === 'COMPLETED') {
        rows.push({ item: task, level: 'main', parentTask: null, parentSub: null });
    }
    for (const sub of (task.subTasks||[])) {
        if (sub.status === 'COMPLETED') {
            rows.push({ item: sub, level: 'sub', parentTask: task, parentSub: null });
        }
        for (const ss of (sub.subSubtasks||[])) {
            if (ss.status === 'COMPLETED') {
                rows.push({ item: ss, level: 'subsub', parentTask: task, parentSub: sub });
            }
        }
    }
    return rows;
}

// ‚îÄ‚îÄ Render everything ‚îÄ‚îÄ
function render() {
    const search  = searchInput.value.toLowerCase().trim();
    const selGroup = groupFilter.value;

    // Groups = main tasks that have at least one completed item
    const groups = allTasks.filter(t => {
        if (selGroup && t.id !== selGroup) return false;
        return hasAnyCompleted(t);
    });

    if (groups.length === 0) {
        scrollArea.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-check-circle"></i>
                No completed tasks found for this project.
            </div>`;
        updateStats([], 0);
        return;
    }

    let totalCompleted = 0, totalHrs = 0, totalCost = 0;
    const cards = [];

    groups.forEach(task => {
        let rows = getCompletedRows(task);

        // Apply search
        if (search) {
            rows = rows.filter(r => {
                const s = [r.item.taskId, r.item.taskDescription, r.item.location, r.item.assignedTo, taskAssigned[r.item.id]].filter(Boolean).join(' ').toLowerCase();
                return s.includes(search);
            });
        }
        if (!rows.length) return;

        totalCompleted += rows.length;
        rows.forEach(r => {
            totalHrs  += parseFloat(r.item.totalHours||r.item._hours||0);
            totalCost += (parseFloat(r.item.matCost||r.item._matCost||0) + parseFloat(r.item.labCost||r.item._labCost||0));
        });

        // Build card HTML
        const mainStatus = task.status || 'PENDING';
        const mainStatusClass = mainStatus === 'ONGOING' ? 'ongoing' : mainStatus === 'COMPLETED' ? '' : 'pending';
        const completedCount = rows.length;

        let bannerHtml = '';
        if (mainStatus !== 'COMPLETED') {
            bannerHtml = `
                <div class="main-status-banner ${mainStatusClass}">
                    <i class="fas fa-info-circle"></i>
                    Main task is <strong>${mainStatus}</strong> ‚Äî showing completed sub-tasks only
                </div>`;
        }

        let tableRows = '';
        rows.forEach(({ item, level }) => {
            const mat   = parseFloat(item.matCost||item._matCost||0);
            const lab   = parseFloat(item.labCost||item._labCost||0);
            const total = mat + lab;
            const hrs   = parseFloat(item.totalHours||item._hours||0);
            const assigned = taskAssigned[item.id] || item.assignedTo || '‚Äî';
            const descPrefix = level === 'sub' ? '<span class="task-prefix">‚Ü™</span>' : level === 'subsub' ? '<span class="task-prefix">‚Ü™‚Ü™</span>' : '';
            const rowClass   = level === 'sub' ? 'row-sub' : level === 'subsub' ? 'row-subsub' : '';

            tableRows += `
                <tr class="${rowClass}">
                    <td class="task-id-cell">${item.taskId||''}</td>
                    <td style="text-align:center">${item.taskLine||''}</td>
                    <td style="${level==='subsub'?'padding-left:35px':level==='sub'?'padding-left:20px':''}">${descPrefix}${item.taskDescription||'‚Äî'}</td>
                    <td>${assigned}</td>
                    <td><span class="status-badge status-${item.status||'PENDING'}">${item.status||'PENDING'}</span></td>
                    <td>${fmtDate(item.startDate)}</td>
                    <td>${fmtDate(item.endDate)}</td>
                    <td class="hrs-cell">${hrs>0?hrs:''}</td>
                    <td class="cost-cell">${mat>0?fmt(mat):''}</td>
                    <td class="cost-cell">${lab>0?fmt(lab):''}</td>
                    <td class="total-cell">${total>0?fmt(total):''}</td>
                    <td>${item.location||''}</td>
                </tr>`;
        });

        cards.push(`
            <div class="group-card">
                <div class="group-heading">
                    <div class="group-heading-left">
                        <span class="group-taskid">${task.taskId||''}</span>
                        <span class="group-title">${task.taskDescription || 'Unnamed Task'}</span>
                    </div>
                    <div class="group-meta">
                        <span class="group-badge green"><i class="fas fa-check"></i> ${completedCount} completed</span>
                        <span class="group-badge status-badge status-${mainStatus}" style="font-size:0.62rem;">${mainStatus}</span>
                    </div>
                </div>
                ${bannerHtml}
                <div class="task-table-wrap">
                    <table class="task-table">
                        <thead>
                            <tr>
                                <th>TASK ID</th>
                                <th>LINE</th>
                                <th>DESCRIPTION</th>
                                <th>ASSIGNED</th>
                                <th>STATUS</th>
                                <th>START</th>
                                <th>END</th>
                                <th>HRS</th>
                                <th>MAT COST</th>
                                <th>MAN COST</th>
                                <th>TOTAL</th>
                                <th>LOCATION</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>
            </div>`);
    });

    if (cards.length === 0) {
        scrollArea.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-search"></i>
                No results match your search.
            </div>`;
        updateStats([], 0);
        return;
    }

    scrollArea.innerHTML = cards.join('');
    updateStats(totalCompleted, totalHrs, totalCost, groups.length);
}

function updateStats(completed, hrs, cost, groups) {
    document.getElementById('statGroups').textContent    = groups || 0;
    document.getElementById('statCompleted').textContent = completed || 0;
    document.getElementById('statHrs').textContent       = (hrs||0).toFixed(1);
    document.getElementById('statCost').textContent      = fmt(cost||0);
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
(async () => {
    try {
        await Promise.all([loadAssignedNames(), loadTaskTree()]);
        buildGroupFilter();
        loadingState.remove();
        render();

        // Live re-listen: re-load and re-render when data changes
        onSnapshot(
            query(collection(db,"projectTasks"), where("projectId","==",projectId)),
            async () => {
                await Promise.all([loadAssignedNames(), loadTaskTree()]);
                buildGroupFilter();
                render();
            }
        );
    } catch(e) {
        console.error(e);
        loadingState.innerHTML = `<span style="color:red">Error loading: ${e.message}</span>`;
    }
})();

searchInput.addEventListener('input', render);
groupFilter.addEventListener('change', render);
</script>
</body>
</html>
