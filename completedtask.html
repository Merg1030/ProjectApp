<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completed Tasks | Task Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Color Palette */
            --primary: #4361ee;
            --primary-light: #4cc9f0;
            --primary-dark: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            
            /* Typography */
            --font-size-sm: 12px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 20px;
            --font-size-xxl: 24px;
            
            /* Border */
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-medium: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        /* Dark Mode Colors */
        .dark-mode {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --surface-hover: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.7);
            --text-disabled: rgba(255,255,255,0.5);
            --divider-color: rgba(255,255,255,0.12);
            --input-bg: #2d2d2d;
            --input-border: #444;
        }

        /* Light Mode Colors */
        .light-mode {
            --bg-color: #f5f7fa;
            --surface-color: #ffffff;
            --surface-hover: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-disabled: #adb5bd;
            --divider-color: #e9ecef;
            --input-bg: #ffffff;
            --input-border: #ced4da;
        }

        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color var(--transition-medium), color var(--transition-medium);
            padding: 0;
        }

        .container {
            margin: 0 auto;
            padding: var(--space-md);
            max-width: 1400px;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xl);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--divider-color);
        }

        .page-title {
            font-size: var(--font-size-xxl);
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .controls {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--border-radius-md);
            font-weight: 500;
            font-size: var(--font-size-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn i {
            font-size: var(--font-size-md);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--divider-color);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background-color: var(--surface-hover);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #38b2ac;
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        /* Project Info */
        .project-info {
            background-color: var(--surface-color);
            padding: var(--space-md);
            border-radius: var(--border-radius-md);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-sm);
        }

        .project-name {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--primary);
            margin-bottom: var(--space-xs);
        }

        .project-details {
            display: flex;
            gap: var(--space-lg);
            flex-wrap: wrap;
            color: var(--text-secondary);
            font-size: var(--font-size-md);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            background-color: var(--surface-color);
            padding: var(--space-lg);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
            text-align: center;
            border-left: 4px solid var(--success);
        }

        .stat-value {
            font-size: var(--font-size-xxl);
            font-weight: 700;
            color: var(--success);
            margin-bottom: var(--space-xs);
        }

        .stat-label {
            font-size: var(--font-size-md);
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Filters */
        .filters-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--surface-color);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-lg);
            border: 1px solid var(--divider-color);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .filter-label {
            font-size: var(--font-size-md);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .filter-select {
            background-color: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--input-border);
            border-radius: var(--border-radius-md);
            padding: var(--space-xs) var(--space-sm);
            font-size: var(--font-size-md);
            transition: all var(--transition-fast);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .search-container {
            display: flex;
            align-items: center;
            background: var(--input-bg);
            border-radius: var(--border-radius-md);
            padding: var(--space-xs) var(--space-sm);
            box-shadow: var(--shadow-sm);
            flex: 1 1 300px;
            max-width: 400px;
            border: 1px solid var(--input-border);
        }

        .search-input {
            border: none;
            background: transparent;
            padding: var(--space-xs);
            width: 100%;
            outline: none;
            color: var(--text-primary);
            font-size: var(--font-size-md);
        }

        /* Table Styles */
        .table-container {
            background-color: var(--surface-color);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            margin-bottom: var(--space-xl);
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }

        .completed-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-md);
        }

        .completed-table thead {
            background-color: var(--primary);
            color: white;
        }

        .completed-table th {
            padding: var(--space-md);
            text-align: left;
            font-weight: 600;
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .completed-table td {
            padding: var(--space-md);
            border-bottom: 1px solid var(--divider-color);
            vertical-align: middle;
        }

        .completed-table tr:last-child td {
            border-bottom: none;
        }

        .completed-table tr:hover {
            background-color: var(--surface-hover);
        }

        .status-badge {
            display: inline-block;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-sm);
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-completed {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .cost-badge {
            display: inline-block;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-sm);
            font-weight: 600;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }

        .text-truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
            text-align: center;
            background-color: var(--surface-color);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
        }

        .empty-state-icon {
            font-size: 48px;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }

        .empty-state-text {
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
            max-width: 400px;
        }

        /* Total Row */
        .total-row {
            font-weight: bold;
            background-color: var(--surface-hover) !important;
        }

        .total-row td {
            border-top: 2px solid var(--divider-color);
            font-weight: 600;
        }

        /* Progress Bar */
        .progress-container {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .progress-bar {
            flex-grow: 1;
            height: 6px;
            background-color: var(--input-bg);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #10b981);
            width: 100%;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-md);
            }
            
            .controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .filters-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-sm);
            }
            
            .search-container {
                max-width: 100%;
            }
            
            .project-details {
                flex-direction: column;
                gap: var(--space-sm);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Print Styles */
        @media print {
            .btn, .filters-bar, .stats-grid {
                display: none;
            }
            
            .table-container {
                box-shadow: none;
                border: 1px solid #000;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <div class="container">
        <div class="header">
            <h1 class="page-title">
                <i class="fas fa-check-circle"></i> Completed Tasks
            </h1>
            <div class="controls">
                <a href="#" class="btn btn-outline" id="backBtn">
                    <i class="fas fa-arrow-left"></i> Back to Tasks
                </a>
                <button class="btn btn-success" id="printBtn">
                    <i class="fas fa-print"></i> Print Report
                </button>
                <button class="btn btn-outline" id="toggleModeBtn">
                    <i class="fas fa-moon"></i> Light Mode
                </button>
            </div>
        </div>
        
        <div class="project-info" id="projectInfo">
            <div class="project-name" id="projectName">Loading project...</div>
            <div class="project-details">
                <span><i class="fas fa-user"></i> Project Manager: Christopher Chishela</span>
                <span><i class="fas fa-user-tie"></i> Supervisor: Orscar Mushimbi</span>
                <span><i class="fas fa-calendar"></i> Report Date: <span id="reportDate">Loading...</span></span>
            </div>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalCompleted">0</div>
                <div class="stat-label">Total Completed Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalHours">0</div>
                <div class="stat-label">Total Hours Worked</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalCost">ZMW 0</div>
                <div class="stat-label">Total Project Cost</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completionRate">0%</div>
                <div class="stat-label">Overall Completion</div>
            </div>
        </div>
        
        <div class="filters-bar">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="Search completed tasks...">
            </div>
            <div class="filter-group">
                <span class="filter-label">Category:</span>
                <select id="categoryFilter" class="filter-select">
                    <option value="">All Categories</option>
                    <option value="general">General Work</option>
                    <option value="electrical">Electrical Maintenance</option>
                    <option value="plumbing">Plumbing Maintenance</option>
                    <option value="carpentry">Carpentry Maintenance</option>
                    <option value="welding">Welding Maintenance</option>
                    <option value="networking">Networking & IT</option>
                    <option value="gardening">Plants & Gardening</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">Month:</span>
                <select id="monthFilter" class="filter-select">
                    <option value="">All Months</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">Year:</span>
                <select id="yearFilter" class="filter-select">
                    <option value="">All Years</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
            </div>
        </div>
        
        <div class="table-container">
            <div class="table-responsive">
                <table class="completed-table" id="completedTable">
                    <thead>
                        <tr>
                            <th>TASK ID</th>
                            <th>TASK LINE</th>
                            <th>DESCRIPTION</th>
                            <th>ASSIGNED</th>
                            <th>STATUS</th>
                            <th>START DATE</th>
                            <th>END DATE</th>
                            <th>GIVE TARGET</th>
                            <th>DURATION (Hrs)</th>
                            <th>MATERIAL COST</th>
                            <th>MAN COST</th>
                            <th>TOTAL COST</th>
                            <th>LOCATION</th>
                        </tr>
                    </thead>
                    <tbody id="completedTasksBody">
                        <tr>
                            <td colspan="13" class="empty-state">
                                <i class="fas fa-spinner fa-spin empty-state-icon"></i>
                                <p class="empty-state-text">Loading completed tasks...</p>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="8" style="text-align: right; font-weight: bold;">TOTALS:</td>
                            <td id="totalDuration">0</td>
                            <td id="totalMaterialCost">ZMW 0</td>
                            <td id="totalManCost">ZMW 0</td>
                            <td id="grandTotalCost">ZMW 0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, query, where, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
            authDomain: "project-task-588c4.firebaseapp.com",
            projectId: "project-task-588c4",
            storageBucket: "project-task-588c4.appspot.com",
            messagingSenderId: "411882772509",
            appId: "1:411882772509:web:08d613186c101a99f38ef4",
            measurementId: "G-JMFLFYEM0F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DOM Elements
        const toggleModeBtn = document.getElementById('toggleModeBtn');
        const backBtn = document.getElementById('backBtn');
        const printBtn = document.getElementById('printBtn');
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const monthFilter = document.getElementById('monthFilter');
        const yearFilter = document.getElementById('yearFilter');
        const completedTasksBody = document.getElementById('completedTasksBody');
        const projectInfo = document.getElementById('projectInfo');
        const projectName = document.getElementById('projectName');
        const reportDate = document.getElementById('reportDate');
        const body = document.body;

        // Stats elements
        const totalCompleted = document.getElementById('totalCompleted');
        const totalHours = document.getElementById('totalHours');
        const totalCost = document.getElementById('totalCost');
        const completionRate = document.getElementById('completionRate');

        // Total elements
        const totalDuration = document.getElementById('totalDuration');
        const totalMaterialCost = document.getElementById('totalMaterialCost');
        const totalManCost = document.getElementById('totalManCost');
        const grandTotalCost = document.getElementById('grandTotalCost');

        // State
        let projectId = null;
        let projectData = null;
        let allCompletedTasks = [];
        let allTasks = [];

        // Category definitions
        const categories = {
            'general': 'General Work',
            'electrical': 'Electrical Maintenance',
            'plumbing': 'Plumbing Maintenance',
            'carpentry': 'Carpentry Maintenance',
            'welding': 'Welding Maintenance',
            'networking': 'Networking & IT Maintenance',
            'gardening': 'Plants & Gardening Maintenance'
        };

        // Get project ID from URL
        function getProjectIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            
            if (!id) {
                alert("Project ID is missing from URL. Please access this page from the tasks page.");
                window.location.href = 'dashboard.html';
                return null;
            }
            
            return id;
        }

        // Toggle dark/light mode
        toggleModeBtn.addEventListener('click', function() {
            body.classList.toggle('light-mode');
            if (body.classList.contains('light-mode')) {
                this.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
                localStorage.setItem('theme', 'light');
            } else {
                this.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
                localStorage.setItem('theme', 'dark');
            }
        });

        // Check for saved theme preference
        if (localStorage.getItem('theme') === 'light') {
            body.classList.add('light-mode');
            toggleModeBtn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
        } else {
            toggleModeBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
        }

        // Set back button URL
        backBtn.href = `Projectworks.html?id=${projectId}`;

        // Print functionality
        printBtn.addEventListener('click', function() {
            window.print();
        });

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Not set';
            const date = dateString.toDate ? dateString.toDate() : new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Format currency
        function formatCurrency(amount, curr = 'ZMW') {
            if (!amount && amount !== 0) return 'ZMW 0';
            const formatter = new Intl.NumberFormat(undefined, {
                style: 'currency',
                currency: curr || 'ZMW',
                minimumFractionDigits: 2
            });
            return formatter.format(amount);
        }

        // Calculate task duration in hours
        function calculateTaskDuration(task) {
            if (task._durationHours !== undefined) return task._durationHours;
            return task.duration || 0;
        }

        // Calculate task costs
        function calculateTaskCosts(task) {
            const hours = calculateTaskDuration(task);
            const materialCost = task._materialCost || 0;
            const manCost = hours * 20; // Assuming ZMW 20 per hour
            const totalCost = manCost + materialCost;
            
            return {
                materialCost,
                manCost,
                totalCost
            };
        }

        // Load project data
        async function loadProjectData() {
            try {
                const projectDoc = await getDoc(doc(db, "projectDashboard", projectId));
                if (projectDoc.exists()) {
                    projectData = projectDoc.data();
                    projectName.textContent = projectData.name + " - Completed Tasks";
                    reportDate.textContent = new Date().toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } else {
                    projectName.textContent = 'Project Not Found';
                    projectInfo.style.display = 'none';
                }
            } catch (error) {
                console.error("Error loading project: ", error);
                projectName.textContent = 'Error Loading Project';
            }
        }

        // Get all tasks to calculate completion rate
        async function loadAllTasks() {
            const tasksQuery = query(
                collection(db, "projectTasks"), 
                where("projectId", "==", projectId)
            );
            
            try {
                const snapshot = await getDocs(tasksQuery);
                allTasks = [];
                
                if (snapshot.empty) {
                    updateStats();
                    return;
                }
                
                const promises = snapshot.docs.map(async (docSnap) => {
                    const taskData = { id: docSnap.id, ...docSnap.data() };
                    allTasks.push(taskData);
                    
                    // Load subtasks
                    const subtasksQuery = collection(db, "projectTasks", docSnap.id, "subtasks");
                    const subSnapshot = await getDocs(subtasksQuery);
                    
                    subSnapshot.forEach(subDoc => {
                        const subtaskData = { id: subDoc.id, ...subDoc.data() };
                        allTasks.push(subtaskData);
                        
                        // Load sub-subtasks
                        loadSubSubtasks(docSnap.id, subDoc.id);
                    });
                });
                
                await Promise.all(promises);
                updateStats();
            } catch (error) {
                console.error("Error loading all tasks: ", error);
            }
        }

        // Load sub-subtasks
        async function loadSubSubtasks(mainId, subtaskId) {
            try {
                const subsubtasksQuery = collection(db, "projectTasks", mainId, "subtasks", subtaskId, "subsubtasks");
                const subsubSnapshot = await getDocs(subsubtasksQuery);
                
                subsubSnapshot.forEach(subsubDoc => {
                    const subsubtaskData = { id: subsubDoc.id, ...subsubDoc.data() };
                    allTasks.push(subsubtaskData);
                });
                
                updateStats();
            } catch (error) {
                console.error("Error loading sub-subtasks: ", error);
            }
        }

        // Load completed tasks
        function loadCompletedTasks() {
            const tasksQuery = query(
                collection(db, "projectTasks"), 
                where("projectId", "==", projectId)
            );
            
            onSnapshot(tasksQuery, async (snapshot) => {
                allCompletedTasks = [];
                
                if (snapshot.empty) {
                    renderCompletedTasks([]);
                    updateStats();
                    return;
                }
                
                const promises = snapshot.docs.map(async (docSnap) => {
                    const taskData = { id: docSnap.id, ...docSnap.data() };
                    
                    // Only include completed tasks
                    if (taskData.status === 'COMPLETED') {
                        // Get hours and material costs
                        const [hours, materialCost] = await Promise.all([
                            getWorkedHoursForTaskId(taskData.taskId),
                            getMaterialCostForTaskId(taskData.taskId)
                        ]);
                        
                        taskData._durationHours = hours;
                        taskData._materialCost = materialCost;
                        allCompletedTasks.push(taskData);
                    }
                    
                    // Load completed subtasks
                    const subtasksQuery = collection(db, "projectTasks", docSnap.id, "subtasks");
                    const subSnapshot = await getDocs(subtasksQuery);
                    
                    const subPromises = subSnapshot.docs.map(async (subDoc) => {
                        const subtaskData = { id: subDoc.id, ...subDoc.data() };
                        
                        if (subtaskData.status === 'COMPLETED') {
                            const [subHours, subMaterialCost] = await Promise.all([
                                getWorkedHoursForTaskId(subtaskData.taskId),
                                getMaterialCostForTaskId(subtaskData.taskId)
                            ]);
                            
                            subtaskData._durationHours = subHours;
                            subtaskData._materialCost = subMaterialCost;
                            allCompletedTasks.push(subtaskData);
                        }
                        
                        // Load completed sub-subtasks
                        await loadCompletedSubSubtasks(docSnap.id, subDoc.id);
                    });
                    
                    await Promise.all(subPromises);
                });
                
                await Promise.all(promises);
                renderCompletedTasks(allCompletedTasks);
                updateStats();
            }, (error) => {
                console.error("Error loading completed tasks: ", error);
                completedTasksBody.innerHTML = `
                    <tr>
                        <td colspan="13" class="empty-state">
                            <i class="fas fa-exclamation-triangle empty-state-icon"></i>
                            <p class="empty-state-text">Error loading completed tasks. Please refresh the page.</p>
                            <button class="btn btn-primary" onclick="window.location.reload()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        // Load completed sub-subtasks
        async function loadCompletedSubSubtasks(mainId, subtaskId) {
            try {
                const subsubtasksQuery = collection(db, "projectTasks", mainId, "subtasks", subtaskId, "subsubtasks");
                const subsubSnapshot = await getDocs(subsubtasksQuery);
                
                const promises = subsubSnapshot.docs.map(async (subsubDoc) => {
                    const subsubtaskData = { id: subsubDoc.id, ...subsubDoc.data() };
                    
                    if (subsubtaskData.status === 'COMPLETED') {
                        const [subsubHours, subsubMaterialCost] = await Promise.all([
                            getWorkedHoursForTaskId(subsubtaskData.taskId),
                            getMaterialCostForTaskId(subsubtaskData.taskId)
                        ]);
                        
                        subsubtaskData._durationHours = subsubHours;
                        subsubtaskData._materialCost = subsubMaterialCost;
                        allCompletedTasks.push(subsubtaskData);
                    }
                });
                
                await Promise.all(promises);
            } catch (error) {
                console.error("Error loading completed sub-subtasks: ", error);
            }
        }

        // Get worked hours for task
        async function getWorkedHoursForTaskId(taskId) {
            if (!taskId) return 0;
            const q = query(collection(db, "locationHistory"), where("taskId", "==", taskId));
            let sum = 0;
            const snap = await getDocs(q);
            snap.forEach(doc => {
                const d = doc.data();
                if (d.mh && !isNaN(d.mh)) sum += Number(d.mh);
            });
            return sum;
        }

        // Get material cost for task
        async function getMaterialCostForTaskId(taskId) {
            if (!taskId) return 0;
            const q = query(collection(db, "materialsUsage"), where("taskId", "==", taskId));
            let sum = 0;
            const snap = await getDocs(q);
            
            // For inventory items
            const materialIds = new Set();
            snap.forEach(doc => {
                const d = doc.data();
                if (d.materialId) materialIds.add(d.materialId);
            });
            
            // Fetch prices for inventory items
            const materialPriceMap = {};
            await Promise.all([...materialIds].map(async materialId => {
                const matSnap = await getDoc(doc(db, "materials", materialId));
                if (matSnap.exists()) {
                    materialPriceMap[materialId] = matSnap.data().unitPrice || 0;
                }
            }));
            
            // Calculate total cost
            snap.forEach(doc => {
                const d = doc.data();
                if (!d.reversed) {
                    // Inventory items
                    if (d.quantity && d.materialId) {
                        const price = materialPriceMap[d.materialId] || 0;
                        sum += Number(d.quantity) * Number(price);
                    }
                    // Supplier items
                    else if (d.boughtFromSupplier && d.amount) {
                        sum += Number(d.amount);
                    }
                    // Backward compatibility
                    else if (d.quantity && d.unitPrice && !d.materialId) {
                        sum += Number(d.quantity) * Number(d.unitPrice);
                    }
                }
            });
            
            return sum;
        }

        // Filter completed tasks
        function filterCompletedTasks() {
            const searchVal = searchInput.value.toLowerCase();
            const categoryVal = categoryFilter.value;
            const monthVal = monthFilter.value;
            const yearVal = yearFilter.value;
            
            return allCompletedTasks.filter(task => {
                // Check search filter
                let matchesSearch = true;
                if (searchVal) {
                    matchesSearch = (
                        (task.taskId && task.taskId.toLowerCase().includes(searchVal)) ||
                        (task.taskDescription && task.taskDescription.toLowerCase().includes(searchVal)) ||
                        (task.assignedTo && task.assignedTo.toLowerCase().includes(searchVal)) ||
                        (task.location && task.location.toLowerCase().includes(searchVal))
                    );
                }
                
                // Check category filter
                let matchesCategory = true;
                if (categoryVal) {
                    matchesCategory = (task.category === categoryVal);
                }
                
                // Check month filter
                let matchesMonth = true;
                if (monthVal) {
                    const monthNum = parseInt(monthVal);
                    if (task.endDate) {
                        const date = task.endDate.toDate ? task.endDate.toDate() : new Date(task.endDate);
                        matchesMonth = date.getMonth() + 1 === monthNum;
                    } else {
                        matchesMonth = false;
                    }
                }
                
                // Check year filter
                let matchesYear = true;
                if (yearVal) {
                    const yearNum = parseInt(yearVal);
                    if (task.endDate) {
                        const date = task.endDate.toDate ? task.endDate.toDate() : new Date(task.endDate);
                        matchesYear = date.getFullYear() === yearNum;
                    } else {
                        matchesYear = false;
                    }
                }
                
                return matchesSearch && matchesCategory && matchesMonth && matchesYear;
            });
        }

        // Render completed tasks
        function renderCompletedTasks(tasks) {
            completedTasksBody.innerHTML = '';
            
            if (tasks.length === 0) {
                completedTasksBody.innerHTML = `
                    <tr>
                        <td colspan="13" class="empty-state">
                            <i class="fas fa-check-circle empty-state-icon"></i>
                            <p class="empty-state-text">No completed tasks found. Completed tasks will appear here automatically when marked as completed.</p>
                            <a href="Projectworks.html?id=${projectId}" class="btn btn-primary">
                                <i class="fas fa-tasks"></i> View Active Tasks
                            </a>
                        </td>
                    </tr>
                `;
                updateTotals([]);
                return;
            }
            
            // Sort by completion date (most recent first)
            tasks.sort((a, b) => {
                const dateA = a.endDate ? (a.endDate.toDate ? a.endDate.toDate() : new Date(a.endDate)) : new Date(0);
                const dateB = b.endDate ? (b.endDate.toDate ? b.endDate.toDate() : new Date(b.endDate)) : new Date(0);
                return dateB - dateA;
            });
            
            let grandTotalDuration = 0;
            let grandTotalMaterialCost = 0;
            let grandTotalManCost = 0;
            let grandTotalCost = 0;
            
            tasks.forEach(task => {
                const hours = calculateTaskDuration(task);
                const costs = calculateTaskCosts(task);
                
                grandTotalDuration += hours;
                grandTotalMaterialCost += costs.materialCost;
                grandTotalManCost += costs.manCost;
                grandTotalCost += costs.totalCost;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${task.taskId || ''}</td>
                    <td>${task.taskLine || ''}</td>
                    <td class="text-truncate" title="${task.taskDescription || ''}">${task.taskDescription || ''}</td>
                    <td>${task.assignedTo || ''}</td>
                    <td>
                        <span class="status-badge status-completed">Completed</span>
                    </td>
                    <td>${formatDate(task.startDate)}</td>
                    <td>${formatDate(task.endDate)}</td>
                    <td>${formatDate(task.giveTarget)}</td>
                    <td>${hours}</td>
                    <td><span class="cost-badge">${formatCurrency(costs.materialCost)}</span></td>
                    <td><span class="cost-badge">${formatCurrency(costs.manCost)}</span></td>
                    <td><span class="cost-badge">${formatCurrency(costs.totalCost)}</span></td>
                    <td>${task.location || ''}</td>
                `;
                completedTasksBody.appendChild(tr);
            });
            
            updateTotals({
                duration: grandTotalDuration,
                materialCost: grandTotalMaterialCost,
                manCost: grandTotalManCost,
                totalCost: grandTotalCost
            });
        }

        // Update totals
        function updateTotals(totals) {
            totalDuration.textContent = totals.duration || 0;
            totalMaterialCost.textContent = formatCurrency(totals.materialCost || 0);
            totalManCost.textContent = formatCurrency(totals.manCost || 0);
            grandTotalCost.textContent = formatCurrency(totals.totalCost || 0);
        }

        // Update statistics
        function updateStats() {
            const completedCount = allCompletedTasks.length;
            const totalTasks = allTasks.length;
            
            // Calculate total hours and costs from completed tasks
            let totalHours = 0;
            let totalProjectCost = 0;
            
            allCompletedTasks.forEach(task => {
                totalHours += calculateTaskDuration(task);
                const costs = calculateTaskCosts(task);
                totalProjectCost += costs.totalCost;
            });
            
            const completionPercentage = totalTasks > 0 ? Math.round((completedCount / totalTasks) * 100) : 0;
            
            totalCompleted.textContent = completedCount;
            totalHours.textContent = totalHours;
            totalCost.textContent = formatCurrency(totalProjectCost);
            completionRate.textContent = `${completionPercentage}%`;
        }

        // Initialize the page
        function init() {
            projectId = getProjectIdFromURL();
            if (projectId) {
                loadProjectData();
                loadAllTasks();
                loadCompletedTasks();
                
                // Set up event listeners for filters
                searchInput.addEventListener('input', () => {
                    renderCompletedTasks(filterCompletedTasks());
                });
                
                categoryFilter.addEventListener('change', () => {
                    renderCompletedTasks(filterCompletedTasks());
                });
                
                monthFilter.addEventListener('change', () => {
                    renderCompletedTasks(filterCompletedTasks());
                });
                
                yearFilter.addEventListener('change', () => {
                    renderCompletedTasks(filterCompletedTasks());
                });
            }
        }

        // Start the application
        init();

        // Inactivity timeout
        let inactivityTimeout;
        function resetInactivityTimeout() {
            clearTimeout(inactivityTimeout);
            inactivityTimeout = setTimeout(() => {
                window.location.href = 'index.html';
            }, 600000); // 10 minutes
        }

        // Set up inactivity timer
        resetInactivityTimeout();
        document.addEventListener('mousemove', resetInactivityTimeout);
        document.addEventListener('keypress', resetInactivityTimeout);
        document.addEventListener('click', resetInactivityTimeout);
        document.addEventListener('touchstart', resetInactivityTimeout);
    </script>
</body>
</html>
