<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completed Tasks | Task Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI','Roboto',sans-serif; background: #181a22; color: #e0e0e0; margin: 0; }
        .container { margin: 0 auto; padding: 8px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; gap: 10px; }
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 5px 13px; border-radius: 7px; font-weight: 500; cursor: pointer; text-decoration: none; border: none; font-size: 13px; transition: all 0.2s ease; }
        .btn-outline { background: none; border: 1.2px solid #33394c; color: #4361ee; }
        .btn-outline:hover { background: #23263a; }
        .btn-primary { background: #4361ee; color: #fff; }
        .btn-primary:hover { background: #3a56d4; }
        .project-title-sticky { font-size: 19px; font-weight: 700; color: #4cc9f0; margin-bottom: 2px; }
        .project-title { font-size: 24px; margin-bottom: 15px; color: #4361ee; font-weight: 600; }
        .filters-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 7px 10px; padding: 5px 5px 5px 8px; background: linear-gradient(90deg, #4361ee 0%, #4cc9f0 100%); border-radius: 7px; box-shadow: 0 1px 8px rgba(67,97,238,0.08); margin-bottom: 9px;}
        .filter-group { display: flex; align-items: center; gap: 4px; background: #23263a; border-radius: 16px; padding: 3.5px 9px 3.5px 7px; box-shadow: 0 1px 4px rgba(67,97,238,0.04); flex: 1 1 70px; min-width: 70px; max-width: 120px; }
        .filter-label { font-size: 10px; font-weight: 600; color: #4361ee; }
        select { border: 1.2px solid #4361ee; border-radius: 10px; padding: 2px 4px; background: #23263a; color: #e0e0e0; font-size: 11px; min-width: 40px; }
        select:focus { outline: none; border-color: #4cc9f0;}
        .main-table-wrap { display: flex; flex-direction: row; align-items: stretch; width: 100%; transition: all 0.3s; }
        .card { background: #23263a; padding: 7px 4px 2px 4px; border-radius: 7px 0 0 7px; border: 1px solid #33394c; box-shadow: 0 2px 10px rgba(67,97,238,0.07); margin-bottom: 0; flex: 1 1 65%; overflow-x: auto; transition: flex-basis 0.3s, width 0.3s; }
        .card.full-width { border-radius: 7px; flex: 1 1 100% !important; }
        .table-responsive { width: 100%; overflow-x: auto; }
        .task-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .task-table th, .task-table td { padding: 4px 2px; border-bottom: 1px solid #33394c; }
        .task-table th { background: #24263c; font-weight: 600; font-size: 10.5px; text-transform: uppercase; letter-spacing: 0.3px; position: sticky; top: 0; z-index: 1;}
        .task-table tr:nth-child(even) { background: #1f2233;}
        .task-table tr:hover { background: #2c314b;}
        .status-badge { display: inline-block; padding: 1.5px 5px; border-radius: 7px; font-size: 9.5px; font-weight: 600; }
        .status-completed { background: rgba(76,201,240,0.1); color: #4cc9f0; border: 1px solid #4cc9f0; }
        .status-ongoing { background: rgba(248,150,30,0.1); color: #f8961e; border: 1px solid #f8961e; }
        .status-pending { background: rgba(108,117,125,0.13); color: #6c757d; border: 1px solid #6c757d; }
        .editable { cursor: pointer; border-radius: 5px; }
        .editable:hover { background: rgba(67,97,238,0.09);}
        .editable-input, .editable-select { 
            width: 100%; 
            padding: 2px 3px !important; 
            border-radius: 6px; 
            border: 1.2px solid #4361ee; 
            background: #23263a; 
            color: #e0e0e0; 
            font-size: 11px; 
            text-align: center;
        }
        .editable-input[data-field="taskDescription"], 
        .editable-input[data-field="taskId"], 
        .editable-select[data-field="taskDescription"], 
        .editable-select[data-field="taskId"] {
            text-align: left !important;
        }
        .cost-badge { display: inline-block; padding: 1.5px 5px; border-radius: 7px; font-size: 10px; font-weight: 600; background: rgba(67,97,238,0.1); color: #4361ee; border: 1px solid #4361ee; }
        .empty-state { text-align: center; padding: 12px; color: #e0e0e0; opacity: 0.7; }
        .empty-state i { font-size: 20px; opacity: 0.5; }
        .gantt-table-card { background: #23263a; border-radius: 0 7px 7px 0; border-top: 1px solid #33394c; border-right: 1px solid #33394c; border-bottom: 1px solid #33394c; box-shadow: 0 2px 10px rgba(67,97,238,0.07); margin-bottom: 0; min-width: 220px; max-width: 100%; flex: 1 1 35%; display: flex; flex-direction: column; justify-content: stretch; transition: max-width 0.3s, min-width 0.3s;}
        .gantt-table-card.hide { display: none !important; }
        .gantt-table-header { padding: 4px 3px 2px 7px; display: flex; align-items: center; font-size: 12px; color: #4cc9f0; font-weight: 600; justify-content: space-between; }
        .gantt-table-toggle { color: #4361ee; background: none; border: none; font-size: 18px; cursor: pointer; margin-left: 7px;}
        .toggle-bar { position: absolute; left: 0; top: 100px; z-index: 50; background: #23263a; color: #4361ee; border: 1px solid #4361ee; border-radius: 0 6px 6px 0; padding: 5px 8px; font-size: 15px; cursor: pointer; min-width: 18px; text-align: center; }
        .toggle-bar:hover { background: #4361ee; color: #fff; }
        .gantt-table-scroll { overflow-x: auto; height: 100%; }
        .gantt-table { width: max-content; border-collapse: collapse; font-size: 10px; height: 100%; min-width: 400px;}
        .gantt-table th, .gantt-table td { border: 1px solid #33394c; padding: 2px 3px; text-align: center; background: #23263a;}
        .gantt-table th { background: #181a22; color: #e0e0e0; position: sticky; top: 0; z-index: 2; font-size:10px;}
        .gantt-bar { background: #4cc9f0; border-radius: 4px; height: 7px; width: 90%; margin: 0 auto;}
        .gantt-bar-empty { background: transparent; }
        .gantt-pct { font-weight: bold; font-size: 10px;}
        .gantt-table tr { height: 22px; }
        .hide { display: none !important; }
        .subtask-row td { background: #20223a !important; color: #b0e0ff !important; }
        .subtask-row td.subtask-desc { padding-left: 24px !important; }
        .subtask-arrow { text-align: left; padding-left: 10px; color: #4cc9f0; font-size: 15px; }
        .main-task-expand { cursor: pointer; color: #4361ee; margin-right: 6px; }
        .subsubtask-row td { background: #181a22 !important; color: #a0e0f0 !important; }
        .action-btn {
            background: #23263a;
            color: #4cc9f0;
            border: 1.5px solid #4cc9f0;
            border-radius: 7px;
            padding: 4px 13px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.18s, color 0.18s, border 0.18s;
            margin: 2px 0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 1px 4px rgba(76,201,240,0.06);
        }
        .action-btn i {
            font-size: 13px;
        }
        .action-btn:hover,
        .action-btn:focus {
            background: #4cc9f0;
            color: #23263a;
            border-color: #4361ee;
        }
        @media (max-width: 800px) {
            .main-table-wrap { flex-direction: column; }
            .gantt-table-card { max-width: 100%; min-width: 100%; border-radius: 0 0 7px 7px; }
            .card { border-radius: 7px 7px 0 0;}
        }
        .project-info-container {
            margin: 20px 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .project-header-card {
            background: #23263a;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .project-title-line {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4361ee;
        }
        .project-label {
            font-weight: bold;
            color: #e0e0e0;
            font-size: 14px;
        }
        .project-value {
            font-size: 16px;
            color: #ffffff;
        }
        .project-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .detail-item {
            display: flex;
            align-items: center;
        }
        .detail-value {
            color: #e0e0e0;
            margin-left: 5px;
        }
        .current-month-btn {
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
            margin-left: 5px;
        }
        .current-month-btn:hover {
            background: #3a56d4;
        }
        .fullscreen-btn {
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
            margin-left: 5px;
        }
        .fullscreen-btn:hover {
            background: #3a56d4;
        }
        .today-highlight {
            background-color: #ff9800 !important;
            color: #000 !important;
            font-weight: bold;
        }
        .current-month {
            background-color: rgba(67, 97, 238, 0.2) !important;
        }
    </style>
</head>
<body class="dark-mode">
    <div class="container">
        <div class="project-info-container">
            <div class="project-header-card">
                <div class="project-details-grid">
                    <div class="detail-item">
                        <a href="dashboard.html" class="btn btn-outline">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                        <span class="detail-label">PROJECT MANAGER:</span>
                        <span class="detail-value">Christopher chishela</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">SUPERVISOR:</span>
                        <span class="detail-value">Orscar mushimbi</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">DEADLINE:</span>
                        <span class="detail-value deadline">30 August 2025</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="header">
            <div class="actions">
                <a href="tasks.html?id=${projectId}" class="btn btn-outline action-btn">
                    <i class="fas fa-tasks"></i> View Active Tasks
                </a>
                <button class="btn btn-outline" id="toggleModeBtn">
                    <i class="fas fa-moon"></i> Light Mode
                </button>
            </div>
        </div>
        <div class="project-header" id="projectHeaderSticky">
            <div class="project-title-sticky" id="projectNameHeader">Completed Tasks</div>
        </div>
        <div class="filters-bar">
            <div class="filter-group"><span class="filter-label">Month:</span>
                <select id="monthFilter">
                    <option value="">All Months</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            <div class="filter-group"><span class="filter-label">Year:</span>
                <select id="yearFilter">
                    <option value="">All Years</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
            </div>
        </div>
        <div class="main-table-wrap" id="mainTableWrap" style="position:relative;">
            <div class="card" id="mainCard">
                <div class="card-header" style="padding: 3px 0 7px 0;">
                    <h2 class="card-title" style="font-size:13px; margin:0; color:#4361ee; font-weight:500">
                        <i class="fas fa-check-circle"></i> Completed Tasks
                    </h2>
                </div>
                <div class="table-responsive">
                    <table class="task-table" id="taskTable">
                        <thead>
                            <tr>
                                <th></th>
                                <th>TASK ID</th>
                                <th>TASK LINE</th>
                                <th>DESCRIPTION</th>
                                <th>ASSIGNED</th>
                                <th class="editable">STATUS</th>
                                <th>START DATE</th>
                                <th>END DATE</th>
                                <th>COMPLETED AT</th>
                                <th class="duration">DURATION (Hrs)</th>
                                <th>MATERIAL COST</th>
                                <th>MAN COST</th>
                                <th>TOTAL COST</th>
                                <th>LOCATION</th>
                            </tr>
                        </thead>
                        <tbody id="taskList">
                            <!-- Example rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="empty-state" id="emptyState" style="display:none;">
                    <i class="fas fa-check-circle"></i>
                    <p>No completed tasks found.</p>
                </div>
            </div>
            <!-- Table Gantt (side) -->
            <div class="gantt-table-card" id="ganttTableCard">
                <div class="gantt-table-header">
                    <span><i class="fas fa-calendar-alt"></i> Gantt Calendar</span>
                    <div>
                        <button class="current-month-btn" id="currentMonthBtn" title="Show current month">Current Month</button>
                        <button class="fullscreen-btn" id="fullscreenBtn" title="Toggle fullscreen"><i class="fas fa-expand"></i></button>
                        <button class="gantt-table-toggle action-btn" id="toggleGanttBtn" title="Show/hide calendar"><i class="fas fa-eye-slash"></i></button>
                    </div>
                </div>
                <div class="gantt-table-scroll" id="ganttTableScroll" style="height:100%">
                    <table class="gantt-table" style="height:100%">
                        <thead id="ganttCalendarHead"></thead>
                        <tbody id="ganttCalendarBody"></tbody>
                    </table>
                </div>
            </div>
            <button id="showGanttBtn" class="toggle-bar action-btn hide" title="Show Gantt Calendar"><i class="fas fa-calendar-alt"></i></button>
        </div>
    </div>

<script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getFirestore, doc, collection, query, where, onSnapshot, addDoc, updateDoc, getDocs, getDoc, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

// Debugging function
function debugLog(message, data = null) {
    console.log(`[DEBUG] ${message}`, data);
}

// Initialize Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
    authDomain: "project-task-588c4.firebaseapp.com",
    projectId: "project-task-588c4",
    storageBucket: "project-task-588c4.appspot.com",
    messagingSenderId: "411882772509",
    appId: "1:411882772509:web:08d613186c101a99f38ef4",
    measurementId: "G-JMFLFYEM0F"
};

let db;
try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    debugLog("Firebase initialized successfully");
} catch (e) {
    debugLog("Firebase initialization error", e);
    alert("Failed to initialize Firebase: " + e.message);
}

// Get project ID from URL
function getProjectIdFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('id');
    
    if (!projectId) {
        debugLog("No project ID found in URL");
        const errorMsg = "Project ID is missing from URL. Please access this page from the dashboard.";
        alert(errorMsg);
        throw new Error(errorMsg);
    }
    
    debugLog("Project ID from URL", projectId);
    return projectId;
}

const projectId = getProjectIdFromURL();

// DOM Elements
const ganttTableCard = document.getElementById('ganttTableCard');
const ganttTableScroll = document.getElementById('ganttTableScroll');
const toggleGanttBtn = document.getElementById('toggleGanttBtn');
const showGanttBtn = document.getElementById('showGanttBtn');
const mainCard = document.getElementById('mainCard');
const currentMonthBtn = document.getElementById('currentMonthBtn');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const monthFilter = document.getElementById('monthFilter');
const yearFilter = document.getElementById('yearFilter');
const taskList = document.getElementById('taskList');
const emptyState = document.getElementById('emptyState');
const ganttCalendarBody = document.getElementById('ganttCalendarBody');
const ganttCalendarHead = document.getElementById('ganttCalendarHead');
const toggleModeBtn = document.getElementById('toggleModeBtn');

// State variables
let ganttVisible = true;
let showCurrentMonthOnly = false;
let isFullscreen = false;
let allTasks = [];
let unsubMain = null;
let subUnsubs = {};
let expandedTasks = {};

// Helper functions
async function getProjectName(projectId) {
    const docRef = doc(db, "projectDashboard", projectId);
    const snap = await getDoc(docRef);
    return snap.exists() ? snap.data().name : "";
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = dateString.toDate ? dateString.toDate() : new Date(dateString);
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

function formatCurrency(amount, curr='ZMW') {
    if (!amount && amount !== 0) return '';
    const formatter = new Intl.NumberFormat(undefined, {
        style: 'currency',
        currency: curr || 'ZMW',
        minimumFractionDigits: 2
    });
    return formatter.format(amount);
}

function getStatusBadge(status) {
    if (!status) return '';
    status = status.toUpperCase();
    if (status === 'COMPLETED') return 'status-badge status-completed';
    if (status === 'ONGOING') return 'status-badge status-ongoing';
    return 'status-badge status-pending';
}

async function getWorkedHoursForTaskId(taskId) {
    if (!taskId) return 0;
    const q = query(collection(db, "locationHistory"), where("taskId", "==", taskId));
    let sum = 0;
    const snap = await getDocs(q);
    snap.forEach(doc => {
        const d = doc.data();
        if (d.mh && !isNaN(d.mh)) sum += Number(d.mh);
    });
    return sum;
}

async function getMaterialCostForTaskId(taskId) {
    if (!taskId) return 0;
    const q = query(collection(db, "materialsUsage"), where("taskId", "==", taskId));
    let sum = 0;
    const snap = await getDocs(q);
    
    const materialIds = new Set();
    snap.forEach(doc => {
        const d = doc.data();
        if (d.materialId) materialIds.add(d.materialId);
    });
    
    const materialPriceMap = {};
    await Promise.all([...materialIds].map(async materialId => {
        const matSnap = await getDoc(doc(db, "materials", materialId));
        if (matSnap.exists()) {
            materialPriceMap[materialId] = matSnap.data().unitPrice || 0;
        }
    }));
    
    snap.forEach(doc => {
        const d = doc.data();
        if (!d.reversed && d.quantity && d.materialId) {
            const price = materialPriceMap[d.materialId] || 0;
            sum += Number(d.quantity) * Number(price);
        }
    });
    
    return sum;
}

// Gantt visibility toggle
toggleGanttBtn.onclick = () => {
    ganttVisible = !ganttVisible;
    ganttTableCard.classList.toggle('hide', !ganttVisible);
    mainCard.classList.toggle('full-width', !ganttVisible);
    showGanttBtn.classList.toggle('hide', ganttVisible);
    toggleGanttBtn.innerHTML =
        ganttVisible
        ? `<i class="fas fa-eye-slash"></i>`
        : `<i class="fas fa-eye"></i>`;
};

showGanttBtn.onclick = () => {
    ganttVisible = true;
    ganttTableCard.classList.remove('hide');
    mainCard.classList.remove('full-width');
    showGanttBtn.classList.add('hide');
    toggleGanttBtn.innerHTML = `<i class="fas fa-eye-slash"></i>`;
};

// Current month toggle
currentMonthBtn.onclick = () => {
    showCurrentMonthOnly = !showCurrentMonthOnly;
    currentMonthBtn.textContent = showCurrentMonthOnly ? 'Full Year' : 'Current Month';
    renderGanttCalendar(filterTasks(allTasks));
};

// Fullscreen toggle
fullscreenBtn.onclick = () => {
    if (!isFullscreen) {
        if (ganttTableScroll.requestFullscreen) {
            ganttTableScroll.requestFullscreen();
        } else if (ganttTableScroll.webkitRequestFullscreen) {
            ganttTableScroll.webkitRequestFullscreen();
        } else if (ganttTableScroll.msRequestFullscreen) {
            ganttTableScroll.msRequestFullscreen();
        }
        fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
    }
    isFullscreen = !isFullscreen;
};

// Theme toggle
toggleModeBtn.addEventListener('click', function() {
    document.body.classList.toggle('light-mode');
    if (document.body.classList.contains('light-mode')) {
        this.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
        localStorage.setItem('theme', 'light');
    } else {
        this.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
        localStorage.setItem('theme', 'dark');
    }
});

if (localStorage.getItem('theme') === 'light') {
    document.body.classList.add('light-mode');
    toggleModeBtn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
} else {
    toggleModeBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
}

// Filter functions
function loadFilterStates() {
    const savedMonth = localStorage.getItem('completedMonthFilter');
    const savedYear = localStorage.getItem('completedYearFilter');
    
    if (savedMonth) monthFilter.value = savedMonth;
    if (savedYear) yearFilter.value = savedYear;
}

function saveFilterStates() {
    localStorage.setItem('completedMonthFilter', monthFilter.value);
    localStorage.setItem('completedYearFilter', yearFilter.value);
}

function loadExpandedTasks() {
    try {
        expandedTasks = JSON.parse(localStorage.getItem("expanded_completed_tasks") || "{}");
    } catch (e) { expandedTasks = {}; }
}

function saveExpandedTasks() {
    localStorage.setItem("expanded_completed_tasks", JSON.stringify(expandedTasks));
}

function filterTasks(tasks) {
    const monthVal = monthFilter.value;
    const yearVal = yearFilter.value;
    return tasks.filter(task => {
        let matchesMonth = true;
        if (monthVal) {
            const monthNum = parseInt(monthVal);
            if (task.completedAt) {
                const date = task.completedAt.toDate ? task.completedAt.toDate() : new Date(task.completedAt);
                matchesMonth = date.getMonth() + 1 === monthNum;
            } else {
                matchesMonth = false;
            }
        }
        let matchesYear = true;
        if (yearVal) {
            const yearNum = parseInt(yearVal);
            if (task.completedAt) {
                const date = task.completedAt.toDate ? task.completedAt.toDate() : new Date(task.completedAt);
                matchesYear = date.getFullYear() === yearNum;
            } else {
                matchesYear = false;
            }
        }
        return matchesMonth && matchesYear;
    });
}

function makeEditableSelect(cell, type, field) {
    if (cell.querySelector('select')) return;
    const val = cell.textContent.trim();
    const select = document.createElement('select');
    select.className = 'editable-select';
    select.setAttribute('data-field', field);
    select.style.textAlign = 'center';
    
    // Only allow changing from COMPLETED to ONGOING
    const options = ['COMPLETED', 'ONGOING'];
    
    options.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt;
        o.textContent = opt;
        if (val.toUpperCase() === opt) o.selected = true;
        select.appendChild(o);
    });
    
    cell.innerHTML = '';
    cell.appendChild(select);
    select.focus();
    select.onblur = async () => {
        const newStatus = select.value;
        await saveEditable(cell, type, field, newStatus);
    };
    select.onchange = () => select.blur();
}

// NEW: Move task back to main tasks when status changes to ONGOING
async function moveTaskBackToMain(task) {
    try {
        // Add back to main tasks collection
        await addDoc(collection(db, "projectTasks"), {
            ...task,
            status: 'ONGOING',
            updatedAt: new Date()
        });
        
        // Delete from completed tasks collection
        await deleteDoc(doc(db, "completedTasks", task.id));
        
        debugLog("Task moved back to main tasks successfully", task.taskId);
    } catch (e) {
        debugLog("Error moving task back to main tasks", e);
        alert("Error moving task back to main tasks: " + e.message);
    }
}

async function saveEditable(cell, type, field, newVal) {
    const taskId = cell.dataset.id;
    const task = allTasks.find(t => t.id === taskId);
    
    if (field === 'status' && newVal === 'ONGOING') {
        // Move task back to main tasks
        await moveTaskBackToMain(task);
    } else {
        // Update status in completed tasks (though we shouldn't normally change from COMPLETED)
        await updateDoc(doc(db, "completedTasks", taskId), { 
            [field]: newVal,
            updatedAt: new Date()
        });
    }
}

async function loadAllTasks() {
    debugLog("Starting to load completed tasks");
    
    try {
        if (unsubMain) {
            debugLog("Unsubscribing from previous listener");
            unsubMain();
        }
        
        allTasks = [];
        
        debugLog("Setting up completed tasks listener");
        unsubMain = onSnapshot(
            query(collection(db, "completedTasks"), where("projectId", "==", projectId)), 
            async (snapshot) => {
                debugLog("Completed tasks snapshot received", snapshot.size);
                
                allTasks = [];
                let promises = [];
                
                if (snapshot.empty) {
                    debugLog("No completed tasks found for project", projectId);
                    renderTasks([]);
                    renderGanttCalendar([]);
                    return;
                }
                
                snapshot.forEach(docSnap => {
                    const docData = { id: docSnap.id, ...docSnap.data() };
                    docData.expanded = expandedTasks[docSnap.id] || false;
                    allTasks.push(docData);
                    debugLog("Processing completed task", docData.taskId);
                });

                // Get hours and material costs for all tasks
                await Promise.all(allTasks.map(async (task) => {
                    const [hours, materialCost] = await Promise.all([
                        getWorkedHoursForTaskId(task.taskId),
                        getMaterialCostForTaskId(task.taskId)
                    ]);
                    task._durationHours = hours;
                    task._materialCost = materialCost;
                    debugLog(`Got task hours/costs for ${task.taskId}`, {hours, materialCost});
                }));

                debugLog("Rendering tasks and Gantt chart");
                renderTasks(filterTasks(allTasks));
                renderGanttCalendar(filterTasks(allTasks));
            },
            (error) => {
                debugLog("Error in completed tasks listener", error);
                alert("Error loading completed tasks: " + error.message);
            }
        );
    } catch (e) {
        debugLog("Error in loadAllTasks", e);
        alert("Failed to load completed tasks: " + e.message);
    }
}

function renderTasks(tasks) {
    taskList.innerHTML = '';
    let visibleCount = 0;
    tasks.sort((a, b) => {
        // Sort by completed date (newest first)
        const aDate = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt || 0);
        const bDate = b.completedAt?.toDate ? b.completedAt.toDate() : new Date(b.completedAt || 0);
        return bDate - aDate;
    });
    
    tasks.forEach(task => {
        visibleCount++;
        const hours = task._durationHours || 0;
        const materialCost = task._materialCost || 0;
        const manCost = hours * 20;
        const totalCost = manCost + materialCost;
        
        const tr = document.createElement('tr');
        tr.classList.add('main-task-row');
        tr.innerHTML = `
            <td>
                <span class="main-task-expand" data-id="${task.id}" style="font-size:17px">
                    <i class="fas fa-caret-right"></i>
                </span>
            </td>
            <td>${task.taskId || ''}</td>
            <td>${task.taskLine || ''}</td>
            <td>${task.taskDescription || ''}</td>
            <td>${task.assignedTo || ''}</td>
            <td class="editable" data-type="main" data-field="status" data-id="${task.id}">
                <span class="${getStatusBadge(task.status)}">${task.status || ''}</span>
            </td>
            <td>${formatDate(task.startDate) || ''}</td>
            <td>${formatDate(task.endDate) || ''}</td>
            <td>${formatDate(task.completedAt) || ''}</td>
            <td>${hours}</td>
            <td><span class="cost-badge">${formatCurrency(materialCost)}</span></td>
            <td><span class="cost-badge">${formatCurrency(manCost)}</span></td>
            <td><span class="cost-badge">${formatCurrency(totalCost)}</span></td>
            <td>${task.location || ''}</td>
        `;
        taskList.appendChild(tr);
    });

    emptyState.style.display = visibleCount === 0 ? 'block' : 'none';

    document.querySelectorAll('.main-task-expand').forEach(btn => {
        btn.onclick = () => {
            const mainId = btn.dataset.id;
            expandedTasks[mainId] = !expandedTasks[mainId];
            saveExpandedTasks();
            allTasks.find(t => t.id === mainId).expanded = expandedTasks[mainId];
            renderTasks(filterTasks(allTasks));
            renderGanttCalendar(filterTasks(allTasks));
        };
    });
    
    document.querySelectorAll('.editable').forEach(cell => {
        cell.onclick = function() {
            const type = this.dataset.type;
            const field = this.dataset.field;
            if (field === 'status') {
                makeEditableSelect(this, type, field);
            }
        };
    });
}

// Gantt chart functions
function buildGanttCalendarHeaders(baseYear, showCurrentMonthOnly) {
    const months = [
        {name: "Jan", days: 31},{name:"Feb",days:28},{name:"Mar",days:31},{name:"Apr",days:30},
        {name:"May",days:31},{name:"Jun",days:30},{name:"Jul",days:31},{name:"Aug",days:31},
        {name:"Sep",days:30},{name:"Oct",days:31},{name:"Nov",days:30},{name:"Dec",days:31}
    ];
    
    if ((baseYear % 4 === 0 && baseYear % 100 !== 0) || baseYear % 400 === 0) {
        months[1].days = 29;
    }
    
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    let row1 = `<tr><th rowspan="3" style="min-width:160px;text-align:left;">TASK</th>`;
    let row2 = "<tr>";
    let row3 = "<tr>";
    
    for (let m = 0; m < months.length; m++) {
        const month = months[m];
        const monthClass = (showCurrentMonthOnly && m === currentMonth && baseYear === currentYear) ? "current-month" : "";
        
        if (!showCurrentMonthOnly || (m === currentMonth && baseYear === currentYear)) {
            row1 += `<th colspan="${month.days}" class="${monthClass}">${month.name}</th>`;
            
            for(let d=1; d<=month.days; d++) {
                const dt = new Date(baseYear, m, d);
                const wd = ["S","M","T","W","R","F","S"][dt.getDay()];
                const isToday = dt.getDate() === today.getDate() && 
                                dt.getMonth() === today.getMonth() && 
                                dt.getFullYear() === today.getFullYear();
                const dayClass = isToday ? "today-highlight" : "";
                
                row2 += `<th class="${dayClass}">${d}</th>`;
                row3 += `<th class="${dayClass}">${wd}</th>`;
            }
        }
    }
    
    row1 += "</tr>";
    row2 += "</tr>";
    row3 += "</tr>";
    
    ganttCalendarHead.innerHTML = row1 + row2 + row3;
    return {months};
}

function renderGanttCalendar(tasks) {
    let allRows = [];
    let minYear = new Date().getFullYear();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    tasks.forEach(task => {
        allRows.push({
            description: task.taskDescription || '',
            status: task.status,
            startDate: task.startDate,
            endDate: task.endDate,
            completedAt: task.completedAt
        });
        
        if (task.startDate) {
            const y = (task.startDate?.toDate ? task.startDate.toDate() : new Date(task.startDate)).getFullYear();
            if (y < minYear) minYear = y;
        }
    });
    
    const { months } = buildGanttCalendarHeaders(minYear, showCurrentMonthOnly);
    ganttCalendarBody.innerHTML = "";
    
    allRows.forEach(rowTask => {
        let pct = "100%"; // All tasks here are completed
        
        let desc = `<span style="font-weight:bold;color:#4cc9f0;">${rowTask.description}</span>`;
        
        let row = `<tr><td style="text-align:left">${desc}</td>`;
        let start = null, end = null;
        
        if (rowTask.startDate) {
            start = rowTask.startDate.toDate ? rowTask.startDate.toDate() : new Date(rowTask.startDate);
            start = new Date(start.getFullYear(), start.getMonth(), start.getDate());
            
            if (rowTask.endDate) {
                end = rowTask.endDate.toDate ? rowTask.endDate.toDate() : new Date(rowTask.endDate);
                end = new Date(end.getFullYear(), end.getMonth(), end.getDate());
            } else if (rowTask.completedAt) {
                end = rowTask.completedAt.toDate ? rowTask.completedAt.toDate() : new Date(rowTask.completedAt);
                end = new Date(end.getFullYear(), end.getMonth(), end.getDate());
            }
        }
        
        let colDate = new Date(minYear, 0, 1);
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        
        for (let m = 0; m < months.length; m++) {
            const month = months[m];
            
            if (showCurrentMonthOnly && (m !== currentMonth || minYear !== currentYear)) {
                colDate.setMonth(colDate.getMonth() + 1);
                colDate.setDate(1);
                continue;
            }
            
            for (let d = 1; d <= month.days; d++) {
                let bar = '';
                
                if (start) {
                    let testDate = new Date(colDate.getFullYear(), colDate.getMonth(), colDate.getDate());
                    
                    if (testDate >= start && (!end || testDate <= end)) {
                        const isToday = testDate.getTime() === today.getTime();
                        const isPast = testDate < today;
                        
                        if (pct === "100%") {
                            if (isToday) {
                                bar = '<div class="gantt-bar" style="background:#4cc9f0"></div>';
                            } else {
                                bar = '<div class="gantt-bar" style="background:#4cc9f0;opacity:.7"></div>';
                            }
                        }
                    }
                }
                
                row += `<td>${bar}</td>`;
                colDate.setDate(colDate.getDate() + 1);
            }
        }
        
        row += `</tr>`;
        ganttCalendarBody.innerHTML += row;
    });
}

// Event listeners
monthFilter.addEventListener('change', () => {
    saveFilterStates();
    renderTasks(filterTasks(allTasks));
    renderGanttCalendar(filterTasks(allTasks));
});

yearFilter.addEventListener('change', () => {
    saveFilterStates();
    renderTasks(filterTasks(allTasks));
    renderGanttCalendar(filterTasks(allTasks));
});

// Fullscreen event listeners
document.addEventListener('fullscreenchange', () => {
    isFullscreen = !!document.fullscreenElement;
    fullscreenBtn.innerHTML = isFullscreen ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
});

document.addEventListener('webkitfullscreenchange', () => {
    isFullscreen = !!document.webkitFullscreenElement;
    fullscreenBtn.innerHTML = isFullscreen ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
});

document.addEventListener('msfullscreenchange', () => {
    isFullscreen = !!document.msFullscreenElement;
    fullscreenBtn.innerHTML = isFullscreen ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
});

// Initialize
loadFilterStates();
loadExpandedTasks();

// Load tasks
loadAllTasks();

// Refresh the calendar every minute to update the live ticking
setInterval(() => {
    renderGanttCalendar(filterTasks(allTasks));
}, 60000);
</script>
</body>
</html>
