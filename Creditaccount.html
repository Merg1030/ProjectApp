<!DOCTYPE html>
<html>
<head>
  <title>Account Sheet</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }
    
    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
    
    body {
      background: #fff;
    }
    
    #sheet-container {
      width: 100vw;
      height: 100vh;
      padding: 0;
      overflow: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      table-layout: fixed;
    }
    
    th {
      background: #f2f2f2;
      padding: 12px 8px;
      border: 1px solid #ddd;
      font-weight: normal;
      font-size: 14px;
      color: #333;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    td {
      padding: 0;
      border: 1px solid #e0e0e0;
      height: 35px;
    }
    
    input {
      width: 100%;
      height: 100%;
      padding: 0 8px;
      border: none;
      outline: none;
      font-size: 14px;
      background: transparent;
      color: #000;
    }
    
    input:focus {
      background: #f8fdff;
      box-shadow: inset 0 0 0 1px #4d90fe;
    }
    
    .balance-cell {
      padding: 0 8px;
      text-align: right;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #000;
      background: transparent;
      line-height: 35px;
    }
    
    .total-row {
      background: #f5f5f5;
      font-weight: bold;
    }
    
    .total-row td {
      padding: 8px;
      border-top: 2px solid #666;
    }
    
    .add-row-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 10px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .add-row-btn:hover {
      background: #45a049;
    }
    
    .date-col { width: 120px; }
    .trans-col { width: 250px; }
    .ref-col { width: 200px; }
    .cashin-col { width: 150px; }
    .cashout-col { width: 150px; }
    .balance-col { width: 150px; }
  </style>
</head>
<body>
  <div id="sheet-container">
    <table>
      <thead>
        <tr>
          <th class="date-col">Date</th>
          <th class="trans-col">Transaction</th>
          <th class="ref-col">Reference</th>
          <th class="cashin-col">Cash In</th>
          <th class="cashout-col">Cash Out</th>
          <th class="balance-col">Balance</th>
        </tr>
      </thead>
      <tbody id="sheet">
        <!-- Rows will be added here -->
      </tbody>
    </table>
    <button class="add-row-btn" onclick="addNewRow()">+ Add New Row</button>
  </div>

  <script>
    // Start with your sample data only
    let data = [
      { date: '23 Jan', trans: 'top up float', ref: 'chris - hazida', cashin: '5000', cashout: '' },
      { date: '23 Jan', trans: 'purchase of steel', ref: 'dominic', cashin: '', cashout: '500' },
      { date: '23 Jan', trans: 'transport and lunch rations', ref: 'dabson', cashin: '', cashout: '400' }
    ];
    
    // Add one empty row for typing
    data.push({ date: '', trans: '', ref: '', cashin: '', cashout: '' });
    
    // Try to load saved data
    try {
      const saved = localStorage.getItem('accountSheetData');
      if (saved) {
        const parsed = JSON.parse(saved);
        if (parsed && parsed.length > 0) {
          data = parsed;
          // Ensure we have at least one empty row
          if (data.length === 0 || (data[data.length - 1].date || data[data.length - 1].trans)) {
            data.push({ date: '', trans: '', ref: '', cashin: '', cashout: '' });
          }
        }
      }
    } catch (e) {
      console.log('No saved data found');
    }
    
    function renderSheet() {
      const sheet = document.getElementById('sheet');
      sheet.innerHTML = '';
      
      let runningBalance = 0;
      let totalIn = 0;
      let totalOut = 0;
      
      // Calculate balances first
      const calculatedBalances = [];
      data.forEach(row => {
        const cashIn = parseFloat(row.cashin) || 0;
        const cashOut = parseFloat(row.cashout) || 0;
        
        runningBalance = runningBalance + cashIn - cashOut;
        calculatedBalances.push(runningBalance);
        
        totalIn += cashIn;
        totalOut += cashOut;
      });
      
      // Render rows
      data.forEach((row, index) => {
        const tr = document.createElement('tr');
        
        // Date cell
        const tdDate = document.createElement('td');
        const inputDate = document.createElement('input');
        inputDate.type = 'text';
        inputDate.value = row.date;
        inputDate.dataset.row = index;
        inputDate.dataset.col = 'date';
        tdDate.appendChild(inputDate);
        tr.appendChild(tdDate);
        
        // Transaction cell
        const tdTrans = document.createElement('td');
        const inputTrans = document.createElement('input');
        inputTrans.type = 'text';
        inputTrans.value = row.trans;
        inputTrans.dataset.row = index;
        inputTrans.dataset.col = 'trans';
        tdTrans.appendChild(inputTrans);
        tr.appendChild(tdTrans);
        
        // Reference cell
        const tdRef = document.createElement('td');
        const inputRef = document.createElement('input');
        inputRef.type = 'text';
        inputRef.value = row.ref;
        inputRef.dataset.row = index;
        inputRef.dataset.col = 'ref';
        tdRef.appendChild(inputRef);
        tr.appendChild(tdRef);
        
        // Cash In cell
        const tdIn = document.createElement('td');
        const inputIn = document.createElement('input');
        inputIn.type = 'text';
        inputIn.value = row.cashin;
        inputIn.dataset.row = index;
        inputIn.dataset.col = 'cashin';
        tdIn.appendChild(inputIn);
        tr.appendChild(tdIn);
        
        // Cash Out cell
        const tdOut = document.createElement('td');
        const inputOut = document.createElement('input');
        inputOut.type = 'text';
        inputOut.value = row.cashout;
        inputOut.dataset.row = index;
        inputOut.dataset.col = 'cashout';
        tdOut.appendChild(inputOut);
        tr.appendChild(tdOut);
        
        // Balance cell - ONLY show if there's a transaction above this row
        const tdBalance = document.createElement('td');
        tdBalance.className = 'balance-cell';
        
        const balance = calculatedBalances[index];
        // Only show balance if it's not zero AND there's some data in this row
        const hasData = row.date || row.trans || row.ref || row.cashin || row.cashout;
        if (balance !== 0 && hasData) {
          tdBalance.textContent = balance.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
        }
        // Otherwise leave it blank
        
        tr.appendChild(tdBalance);
        sheet.appendChild(tr);
        
        // Add event listeners
        [inputDate, inputTrans, inputRef, inputIn, inputOut].forEach(input => {
          input.addEventListener('input', handleInput);
          input.addEventListener('keydown', handleKeyDown);
        });
      });
      
      // Add total row only if there are actual totals
      if (totalIn > 0 || totalOut > 0) {
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        
        const finalBalance = calculatedBalances[calculatedBalances.length - 1] || 0;
        
        totalRow.innerHTML = `
          <td colspan="3">TOTAL</td>
          <td>${totalIn === 0 ? '' : totalIn.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })}</td>
          <td>${totalOut === 0 ? '' : totalOut.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })}</td>
          <td class="balance-cell">${finalBalance === 0 ? '' : finalBalance.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })}</td>
        `;
        
        sheet.appendChild(totalRow);
      }
      
      // Auto-save
      saveData();
    }
    
    function handleInput(e) {
      const row = parseInt(e.target.dataset.row);
      const col = e.target.dataset.col;
      const value = e.target.value;
      
      // Update data
      data[row][col] = value;
      
      // If this is the last row and something was entered, add a new empty row
      if (row === data.length - 1 && value.trim() !== '') {
        // Check if we should add a new row
        const hasOtherData = Object.values(data[row]).some(val => val && val.trim() !== '');
        if (hasOtherData) {
          // Add new empty row
          data.push({ date: '', trans: '', ref: '', cashin: '', cashout: '' });
        }
      }
      
      // Remove completely empty rows (except the last one)
      cleanupEmptyRows();
      
      // Re-render
      renderSheet();
      
      // Focus back on the current input
      setTimeout(() => {
        const currentInput = document.querySelector(`input[data-row="${row}"][data-col="${col}"]`);
        if (currentInput) {
          currentInput.focus();
          currentInput.select();
        }
      }, 10);
    }
    
    function cleanupEmptyRows() {
      // Keep the last row even if empty, but remove other empty rows
      const cleanedData = [];
      
      for (let i = 0; i < data.length; i++) {
        const row = data[i];
        const isEmpty = !row.date && !row.trans && !row.ref && !row.cashin && !row.cashout;
        
        // Keep if not empty OR if it's the last row
        if (!isEmpty || i === data.length - 1) {
          cleanedData.push(row);
        }
      }
      
      data = cleanedData;
      
      // Always ensure at least one empty row at the end
      if (data.length === 0 || (data[data.length - 1].date || data[data.length - 1].trans)) {
        data.push({ date: '', trans: '', ref: '', cashin: '', cashout: '' });
      }
    }
    
    function handleKeyDown(e) {
      const row = parseInt(e.target.dataset.row);
      const col = e.target.dataset.col;
      
      // Enter key - move down
      if (e.key === 'Enter') {
        e.preventDefault();
        
        // If we're at the last row, ensure there's an empty row below
        if (row === data.length - 1) {
          // Add new empty row if last row has data
          const hasData = Object.values(data[row]).some(val => val && val.trim() !== '');
          if (hasData) {
            data.push({ date: '', trans: '', ref: '', cashin: '', cashout: '' });
            renderSheet();
          }
        }
        
        // Move to same column in next row
        setTimeout(() => {
          const nextInput = document.querySelector(`input[data-row="${row + 1}"][data-col="${col}"]`);
          if (nextInput) {
            nextInput.focus();
            nextInput.select();
          }
        }, 10);
      }
      
      // Tab key
      else if (e.key === 'Tab') {
        // Let default behavior happen, but handle edge case
        setTimeout(() => {
          // If we're at last cell of last row with data, ensure new row
          const allInputs = Array.from(document.querySelectorAll('input'));
          const currentIndex = allInputs.indexOf(e.target);
          
          if (currentIndex === allInputs.length - 1 && !e.shiftKey) {
            // Check if last row has data
            const lastRow = data[data.length - 1];
            const hasData = Object.values(lastRow).some(val => val && val.trim() !== '');
            
            if (hasData) {
              data.push({ date: '', trans: '', ref: '', cashin: '', cashout: '' });
              renderSheet();
              
              setTimeout(() => {
                const newInputs = document.querySelectorAll('input');
                if (newInputs[currentIndex + 1]) {
                  newInputs[currentIndex + 1].focus();
                  newInputs[currentIndex + 1].select();
                }
              }, 10);
            }
          }
        }, 10);
      }
      
      // Delete row with Ctrl+Delete
      else if (e.key === 'Delete' && e.ctrlKey) {
        e.preventDefault();
        if (data.length > 1) {
          data.splice(row, 1);
          cleanupEmptyRows();
          renderSheet();
        }
      }
      
      // Today's date with Ctrl+T
      else if (e.key === 't' && e.ctrlKey && col === 'date') {
        e.preventDefault();
        const today = new Date();
        const day = today.getDate();
        const month = today.toLocaleString('default', { month: 'short' });
        e.target.value = `${day} ${month}`;
        e.target.dispatchEvent(new Event('input'));
        e.target.select();
      }
    }
    
    function addNewRow() {
      // Always add at the end
      data.push({ date: '', trans: '', ref: '', cashin: '', cashout: '' });
      renderSheet();
      
      // Focus on the new row's date cell
      setTimeout(() => {
        const newRowIndex = data.length - 1;
        const dateInput = document.querySelector(`input[data-row="${newRowIndex}"][data-col="date"]`);
        if (dateInput) {
          dateInput.focus();
          dateInput.select();
        }
      }, 10);
    }
    
    function saveData() {
      localStorage.setItem('accountSheetData', JSON.stringify(data));
    }
    
    // Initial render
    renderSheet();
    
    // Focus first cell
    setTimeout(() => {
      const firstInput = document.querySelector('input[data-row="0"][data-col="date"]');
      if (firstInput) {
        firstInput.focus();
        firstInput.select();
      }
    }, 100);
    
    // Auto-save every 30 seconds
    setInterval(saveData, 30000);
    
    // Save before page closes
    window.addEventListener('beforeunload', saveData);
  </script>
</body>
</html>
