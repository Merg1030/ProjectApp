<!DOCTYPE html>
<html>
<head>
  <title>General Expenses Tracker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }
    
    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
    
    body {
      background: #f5f5f5;
    }
    
    .header {
      background: #2c3e50;
      color: white;
      padding: 15px 20px;
      border-bottom: 3px solid #3498db;
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: normal;
    }
    
    .header p {
      font-size: 14px;
      color: #ecf0f1;
      margin-top: 5px;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 80px);
    }
    
    .controls {
      background: white;
      padding: 10px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .control-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 8px 15px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .control-btn:hover {
      background: #2980b9;
    }
    
    .delete-btn {
      background: #e74c3c;
    }
    
    .delete-btn:hover {
      background: #c0392b;
    }
    
    .save-btn {
      background: #27ae60;
    }
    
    .save-btn:hover {
      background: #219653;
    }
    
    #sheet-container {
      flex: 1;
      overflow: auto;
      background: white;
      margin: 0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    
    th {
      background: #f8f9fa;
      padding: 12px 8px;
      border: 1px solid #dee2e6;
      font-weight: 600;
      font-size: 14px;
      color: #2c3e50;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    td {
      padding: 0;
      border: 1px solid #dee2e6;
      height: 40px;
      min-height: 40px;
    }
    
    input {
      width: 100%;
      height: 100%;
      padding: 0 10px;
      border: none;
      outline: none;
      font-size: 14px;
      background: transparent;
      color: #2c3e50;
    }
    
    input:focus {
      background: #e8f4fc;
      box-shadow: inset 0 0 0 2px #3498db;
    }
    
    .balance-cell {
      padding: 0 10px;
      text-align: right;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #2c3e50;
      background: transparent;
      line-height: 40px;
      font-weight: bold;
    }
    
    .total-row {
      background: #f8f9fa;
      font-weight: bold;
    }
    
    .total-row td {
      padding: 10px;
      border-top: 2px solid #2c3e50;
      border-bottom: 2px solid #2c3e50;
    }
    
    .row-controls {
      width: 60px;
      text-align: center;
    }
    
    .delete-row-btn {
      background: #e74c3c;
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      line-height: 24px;
      margin: 0 auto;
      display: block;
    }
    
    .delete-row-btn:hover {
      background: #c0392b;
    }
    
    .empty-message {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>General Expenses Tracker</h1>
    <p>Click any cell to type. Balance calculates automatically. Add/remove rows as needed.</p>
  </div>
  
  <div class="container">
    <div class="controls">
      <button class="control-btn" onclick="addRowAtTop()">+ Add Row at Top</button>
      <button class="control-btn" onclick="addRowAtBottom()">+ Add Row at Bottom</button>
      <button class="control-btn delete-btn" onclick="deleteSelectedRows()">Delete Selected</button>
      <button class="control-btn save-btn" onclick="saveData()">Save Data</button>
      <span style="margin-left: auto; font-size: 12px; color: #7f8c8d;">
        Press Enter to add new row • Ctrl+S to save
      </span>
    </div>
    
    <div id="sheet-container">
      <table id="expensesTable">
        <thead>
          <tr>
            <th width="60px"></th>
            <th width="120px">Date</th>
            <th width="250px">Transaction</th>
            <th width="200px">Reference</th>
            <th width="150px">Cash In</th>
            <th width="150px">Cash Out</th>
            <th width="150px">Balance</th>
          </tr>
        </thead>
        <tbody id="sheet">
          <!-- Rows will be added here -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Initialize with your sample data
    let data = [
      { date: '23 Jan', transaction: 'top up float', reference: 'chris - hazida', cashIn: '5000', cashOut: '', selected: false },
      { date: '23 Jan', transaction: 'purchase of steel', reference: 'dominic', cashIn: '', cashOut: '500', selected: false },
      { date: '23 Jan', transaction: 'transport and lunch rations', reference: 'dabson', cashIn: '', cashOut: '400', selected: false }
    ];
    
    // Load saved data if exists
    function loadSavedData() {
      try {
        const saved = localStorage.getItem('generalExpensesData');
        if (saved) {
          const parsed = JSON.parse(saved);
          if (parsed && parsed.length > 0) {
            data = parsed;
          }
        }
      } catch (e) {
        console.log('No saved data found');
      }
    }
    
    function renderSheet() {
      const sheet = document.getElementById('sheet');
      sheet.innerHTML = '';
      
      let runningBalance = 0;
      let totalIn = 0;
      let totalOut = 0;
      
      // Calculate balances first
      const calculatedBalances = [];
      data.forEach(row => {
        const cashIn = parseFloat(row.cashIn) || 0;
        const cashOut = parseFloat(row.cashOut) || 0;
        
        runningBalance = runningBalance + cashIn - cashOut;
        calculatedBalances.push(runningBalance);
        
        totalIn += cashIn;
        totalOut += cashOut;
      });
      
      // Render rows
      data.forEach((row, index) => {
        const tr = document.createElement('tr');
        
        // Delete checkbox column
        const tdCheck = document.createElement('td');
        tdCheck.className = 'row-controls';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = row.selected;
        checkbox.onclick = (e) => {
          e.stopPropagation();
          data[index].selected = checkbox.checked;
        };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-row-btn';
        deleteBtn.innerHTML = '×';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteRow(index);
        };
        
        tdCheck.appendChild(checkbox);
        tdCheck.appendChild(document.createElement('br'));
        tdCheck.appendChild(deleteBtn);
        tr.appendChild(tdCheck);
        
        // Date cell
        const tdDate = document.createElement('td');
        const inputDate = document.createElement('input');
        inputDate.type = 'text';
        inputDate.value = row.date;
        inputDate.placeholder = 'DD MMM';
        inputDate.dataset.index = index;
        inputDate.dataset.field = 'date';
        tdDate.appendChild(inputDate);
        tr.appendChild(tdDate);
        
        // Transaction cell
        const tdTrans = document.createElement('td');
        const inputTrans = document.createElement('input');
        inputTrans.type = 'text';
        inputTrans.value = row.transaction;
        inputTrans.placeholder = 'Enter transaction';
        inputTrans.dataset.index = index;
        inputTrans.dataset.field = 'transaction';
        tdTrans.appendChild(inputTrans);
        tr.appendChild(tdTrans);
        
        // Reference cell
        const tdRef = document.createElement('td');
        const inputRef = document.createElement('input');
        inputRef.type = 'text';
        inputRef.value = row.reference;
        inputRef.placeholder = 'Enter reference';
        inputRef.dataset.index = index;
        inputRef.dataset.field = 'reference';
        tdRef.appendChild(inputRef);
        tr.appendChild(tdRef);
        
        // Cash In cell
        const tdIn = document.createElement('td');
        const inputIn = document.createElement('input');
        inputIn.type = 'number';
        inputIn.step = '0.01';
        inputIn.value = row.cashIn;
        inputIn.placeholder = '0.00';
        inputIn.dataset.index = index;
        inputIn.dataset.field = 'cashIn';
        tdIn.appendChild(inputIn);
        tr.appendChild(tdIn);
        
        // Cash Out cell
        const tdOut = document.createElement('td');
        const inputOut = document.createElement('input');
        inputOut.type = 'number';
        inputOut.step = '0.01';
        inputOut.value = row.cashOut;
        inputOut.placeholder = '0.00';
        inputOut.dataset.index = index;
        inputOut.dataset.field = 'cashOut';
        tdOut.appendChild(inputOut);
        tr.appendChild(tdOut);
        
        // Balance cell
        const tdBalance = document.createElement('td');
        tdBalance.className = 'balance-cell';
        
        const balance = calculatedBalances[index];
        if (balance !== 0) {
          tdBalance.textContent = balance.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
        }
        
        tr.appendChild(tdBalance);
        sheet.appendChild(tr);
        
        // Add event listeners for typing
        [inputDate, inputTrans, inputRef, inputIn, inputOut].forEach(input => {
          input.addEventListener('input', handleInput);
          input.addEventListener('keydown', handleKeyDown);
          input.addEventListener('focus', handleFocus);
        });
      });
      
      // Add total row only if there are totals
      if (totalIn > 0 || totalOut > 0) {
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        
        const finalBalance = calculatedBalances[calculatedBalances.length - 1] || 0;
        
        totalRow.innerHTML = `
          <td colspan="4" style="text-align: right;">TOTAL:</td>
          <td>${totalIn === 0 ? '' : totalIn.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })}</td>
          <td>${totalOut === 0 ? '' : totalOut.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })}</td>
          <td class="balance-cell">${finalBalance === 0 ? '' : finalBalance.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })}</td>
        `;
        
        sheet.appendChild(totalRow);
      }
    }
    
    function handleFocus(e) {
      e.target.select();
    }
    
    function handleInput(e) {
      const index = parseInt(e.target.dataset.index);
      const field = e.target.dataset.field;
      const value = e.target.value;
      
      // Update data
      data[index][field] = value;
      
      // Re-render to update balances
      renderSheet();
      
      // Focus back on the current input
      setTimeout(() => {
        const currentInput = document.querySelector(`input[data-index="${index}"][data-field="${field}"]`);
        if (currentInput) {
          currentInput.focus();
          currentInput.select();
        }
      }, 10);
    }
    
    function handleKeyDown(e) {
      const index = parseInt(e.target.dataset.index);
      const field = e.target.dataset.field;
      
      // Enter key - add new row at bottom and move to it
      if (e.key === 'Enter') {
        e.preventDefault();
        
        // Add new row at bottom
        data.push({ date: '', transaction: '', reference: '', cashIn: '', cashOut: '', selected: false });
        renderSheet();
        
        // Focus on first cell of new row
        setTimeout(() => {
          const newIndex = data.length - 1;
          const firstInput = document.querySelector(`input[data-index="${newIndex}"][data-field="date"]`);
          if (firstInput) {
            firstInput.focus();
            firstInput.select();
          }
        }, 10);
      }
      
      // Tab key - normal behavior
      else if (e.key === 'Tab') {
        // Let tab work normally
        setTimeout(() => {
          const allInputs = Array.from(document.querySelectorAll('input[type="text"], input[type="number"]'));
          const currentIndex = allInputs.indexOf(e.target);
          
          // If we're at last input, add new row
          if (currentIndex === allInputs.length - 1 && !e.shiftKey) {
            data.push({ date: '', transaction: '', reference: '', cashIn: '', cashOut: '', selected: false });
            renderSheet();
            
            setTimeout(() => {
              const newInputs = document.querySelectorAll('input[type="text"], input[type="number"]');
              if (newInputs[currentIndex + 1]) {
                newInputs[currentIndex + 1].focus();
                newInputs[currentIndex + 1].select();
              }
            }, 10);
          }
        }, 10);
      }
      
      // Arrow keys for navigation
      else if (e.key === 'ArrowDown') {
        e.preventDefault();
        const fields = ['date', 'transaction', 'reference', 'cashIn', 'cashOut'];
        const fieldIndex = fields.indexOf(field);
        const nextInput = document.querySelector(`input[data-index="${index + 1}"][data-field="${field}"]`);
        if (nextInput) {
          nextInput.focus();
          nextInput.select();
        }
      }
      else if (e.key === 'ArrowUp') {
        e.preventDefault();
        const fields = ['date', 'transaction', 'reference', 'cashIn', 'cashOut'];
        const fieldIndex = fields.indexOf(field);
        const prevInput = document.querySelector(`input[data-index="${index - 1}"][data-field="${field}"]`);
        if (prevInput) {
          prevInput.focus();
          prevInput.select();
        }
      }
      
      // Save with Ctrl+S
      else if (e.key === 's' && e.ctrlKey) {
        e.preventDefault();
        saveData();
        showMessage('Data saved!');
      }
      
      // Today's date with Ctrl+T
      else if (e.key === 't' && e.ctrlKey) {
        e.preventDefault();
        const today = new Date();
        const day = today.getDate();
        const month = today.toLocaleString('default', { month: 'short' });
        e.target.value = `${day} ${month}`;
        e.target.dispatchEvent(new Event('input'));
        e.target.select();
      }
    }
    
    // Row management functions
    function addRowAtTop() {
      data.unshift({ date: '', transaction: '', reference: '', cashIn: '', cashOut: '', selected: false });
      renderSheet();
      
      // Focus on first cell of new row
      setTimeout(() => {
        const firstInput = document.querySelector(`input[data-index="0"][data-field="date"]`);
        if (firstInput) {
          firstInput.focus();
          firstInput.select();
        }
      }, 10);
    }
    
    function addRowAtBottom() {
      data.push({ date: '', transaction: '', reference: '', cashIn: '', cashOut: '', selected: false });
      renderSheet();
      
      // Focus on first cell of new row
      setTimeout(() => {
        const newIndex = data.length - 1;
        const firstInput = document.querySelector(`input[data-index="${newIndex}"][data-field="date"]`);
        if (firstInput) {
          firstInput.focus();
          firstInput.select();
        }
      }, 10);
    }
    
    function deleteRow(index) {
      if (data.length > 1) {
        data.splice(index, 1);
        renderSheet();
      } else {
        // If it's the last row, just clear it
        data[0] = { date: '', transaction: '', reference: '', cashIn: '', cashOut: '', selected: false };
        renderSheet();
      }
    }
    
    function deleteSelectedRows() {
      const selectedIndices = [];
      data.forEach((row, index) => {
        if (row.selected) {
          selectedIndices.push(index);
        }
      });
      
      if (selectedIndices.length === 0) {
        showMessage('No rows selected');
        return;
      }
      
      // Delete from highest index to lowest to avoid index shifting issues
      selectedIndices.sort((a, b) => b - a).forEach(index => {
        data.splice(index, 1);
      });
      
      // If all rows were deleted, add one empty row
      if (data.length === 0) {
        data.push({ date: '', transaction: '', reference: '', cashIn: '', cashOut: '', selected: false });
      }
      
      renderSheet();
      showMessage(`Deleted ${selectedIndices.length} row(s)`);
    }
    
    function saveData() {
      localStorage.setItem('generalExpensesData', JSON.stringify(data));
      showMessage('Data saved successfully!');
    }
    
    function showMessage(text) {
      // Remove existing message
      const existingMsg = document.querySelector('.message');
      if (existingMsg) existingMsg.remove();
      
      const msg = document.createElement('div');
      msg.className = 'message';
      msg.textContent = text;
      msg.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(46, 204, 113, 0.95);
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        font-size: 14px;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      `;
      document.body.appendChild(msg);
      
      setTimeout(() => {
        msg.style.opacity = '0';
        msg.style.transition = 'opacity 0.3s';
        setTimeout(() => msg.remove(), 300);
      }, 2000);
    }
    
    // Initialize
    window.onload = function() {
      loadSavedData();
      renderSheet();
      
      // Add one empty row if no data
      if (data.length === 0) {
        data.push({ date: '', transaction: '', reference: '', cashIn: '', cashOut: '', selected: false });
      }
      
      renderSheet();
      
      // Focus first cell
      setTimeout(() => {
        const firstInput = document.querySelector('input[data-index="0"][data-field="date"]');
        if (firstInput) {
          firstInput.focus();
          firstInput.select();
        }
      }, 100);
    };
    
    // Auto-save every 30 seconds
    setInterval(saveData, 30000);
    
    // Save before page closes
    window.addEventListener('beforeunload', saveData);
  </script>
</body>
</html>
