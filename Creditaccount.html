<!DOCTYPE html>
<html>
<head>
  <title>Account Sheet</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }
    
    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
    
    body {
      background: #f0f0f0;
    }
    
    #sheet-container {
      width: 100vw;
      height: 100vh;
      padding: 0;
      overflow: auto;
    }
    
    table {
      width: 100%;
      height: 100%;
      border-collapse: collapse;
      background: white;
      table-layout: fixed;
    }
    
    th {
      background: #f2f2f2;
      padding: 12px 8px;
      border: 1px solid #ccc;
      font-weight: normal;
      font-size: 14px;
      color: #333;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    td {
      padding: 0;
      border: 1px solid #e0e0e0;
      height: 32px;
    }
    
    input {
      width: 100%;
      height: 100%;
      padding: 0 8px;
      border: none;
      outline: none;
      font-size: 14px;
      background: transparent;
      color: #000;
    }
    
    input:focus {
      background: #f8fdff;
      box-shadow: inset 0 0 0 1px #4d90fe;
    }
    
    .balance-cell {
      padding: 0 8px;
      text-align: right;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #000;
      background: transparent;
      line-height: 32px;
    }
    
    .total-row {
      background: #f5f5f5;
    }
    
    .total-row td {
      padding: 8px;
      border-top: 2px solid #888;
      font-weight: normal;
    }
    
    .date-col { width: 120px; }
    .trans-col { width: 250px; }
    .ref-col { width: 200px; }
    .cashin-col { width: 150px; }
    .cashout-col { width: 150px; }
    .balance-col { width: 150px; }
  </style>
</head>
<body>
  <div id="sheet-container">
    <table>
      <thead>
        <tr>
          <th class="date-col">Date</th>
          <th class="trans-col">Transaction</th>
          <th class="ref-col">Reference</th>
          <th class="cashin-col">Cash In</th>
          <th class="cashout-col">Cash Out</th>
          <th class="balance-col">Balance</th>
        </tr>
      </thead>
      <tbody id="sheet">
        <!-- Rows generated by JavaScript -->
      </tbody>
    </table>
  </div>

  <script>
    // Empty data - completely blank
    let data = [];
    
    // Create 50 blank rows to start
    for (let i = 0; i < 50; i++) {
      data.push({ 
        date: '', 
        trans: '', 
        ref: '', 
        cashin: '', 
        cashout: '', 
        balance: '' 
      });
    }
    
    // Try to load saved data
    try {
      const saved = localStorage.getItem('accountSheetFull');
      if (saved) {
        const parsed = JSON.parse(saved);
        if (parsed && parsed.length > 0) {
          data = parsed;
          // Ensure we have at least 50 rows
          while (data.length < 50) {
            data.push({ date: '', trans: '', ref: '', cashin: '', cashout: '', balance: '' });
          }
        }
      }
    } catch (e) {
      console.log('No saved data found');
    }
    
    let calculatedBalances = [];
    
    function renderSheet() {
      const sheet = document.getElementById('sheet');
      sheet.innerHTML = '';
      
      calculatedBalances = [];
      let runningBalance = 0;
      let totalIn = 0;
      let totalOut = 0;
      
      data.forEach((row, index) => {
        // Calculate cash values
        const cashIn = parseFloat(row.cashin) || 0;
        const cashOut = parseFloat(row.cashout) || 0;
        
        // Update running totals
        totalIn += cashIn;
        totalOut += cashOut;
        
        // Calculate balance if there's cash activity
        if (cashIn > 0 || cashOut > 0) {
          runningBalance = runningBalance + cashIn - cashOut;
        }
        
        // Store calculated balance
        calculatedBalances[index] = runningBalance;
        
        const tr = document.createElement('tr');
        
        // Date cell
        const tdDate = document.createElement('td');
        const inputDate = document.createElement('input');
        inputDate.type = 'text';
        inputDate.value = row.date;
        inputDate.dataset.row = index;
        inputDate.dataset.col = 'date';
        tdDate.appendChild(inputDate);
        tr.appendChild(tdDate);
        
        // Transaction cell
        const tdTrans = document.createElement('td');
        const inputTrans = document.createElement('input');
        inputTrans.type = 'text';
        inputTrans.value = row.trans;
        inputTrans.dataset.row = index;
        inputTrans.dataset.col = 'trans';
        tdTrans.appendChild(inputTrans);
        tr.appendChild(tdTrans);
        
        // Reference cell
        const tdRef = document.createElement('td');
        const inputRef = document.createElement('input');
        inputRef.type = 'text';
        inputRef.value = row.ref;
        inputRef.dataset.row = index;
        inputRef.dataset.col = 'ref';
        tdRef.appendChild(inputRef);
        tr.appendChild(tdRef);
        
        // Cash In cell
        const tdIn = document.createElement('td');
        const inputIn = document.createElement('input');
        inputIn.type = 'text';
        inputIn.value = row.cashin;
        inputIn.dataset.row = index;
        inputIn.dataset.col = 'cashin';
        tdIn.appendChild(inputIn);
        tr.appendChild(tdIn);
        
        // Cash Out cell
        const tdOut = document.createElement('td');
        const inputOut = document.createElement('input');
        inputOut.type = 'text';
        inputOut.value = row.cashout;
        inputOut.dataset.row = index;
        inputOut.dataset.col = 'cashout';
        tdOut.appendChild(inputOut);
        tr.appendChild(tdOut);
        
        // Balance cell (readonly - completely blank if no value)
        const tdBalance = document.createElement('td');
        tdBalance.className = 'balance-cell';
        
        // Only show balance if there's a calculated value
        if (runningBalance !== 0) {
          tdBalance.textContent = runningBalance.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
        } else {
          tdBalance.textContent = ''; // Completely blank
        }
        
        tr.appendChild(tdBalance);
        sheet.appendChild(tr);
        
        // Add event listeners
        [inputDate, inputTrans, inputRef, inputIn, inputOut].forEach(input => {
          input.addEventListener('input', handleInput);
          input.addEventListener('keydown', handleKeyDown);
          input.addEventListener('focus', handleFocus);
        });
      });
      
      // Add total row
      const totalRow = document.createElement('tr');
      totalRow.className = 'total-row';
      
      // Only show totals if there are values
      const totalInDisplay = totalIn === 0 ? '' : totalIn.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      
      const totalOutDisplay = totalOut === 0 ? '' : totalOut.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      
      const finalBalance = calculatedBalances.length > 0 
        ? calculatedBalances[calculatedBalances.length - 1] 
        : 0;
      
      const finalBalanceDisplay = finalBalance === 0 ? '' : finalBalance.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      
      totalRow.innerHTML = `
        <td colspan="3">TOTAL</td>
        <td>${totalInDisplay}</td>
        <td>${totalOutDisplay}</td>
        <td class="balance-cell">${finalBalanceDisplay}</td>
      `;
      
      sheet.appendChild(totalRow);
      
      // Auto-save
      autoSave();
    }
    
    function handleFocus(e) {
      e.target.select();
    }
    
    function handleInput(e) {
      const row = parseInt(e.target.dataset.row);
      const col = e.target.dataset.col;
      let value = e.target.value;
      
      // Update data
      data[row][col] = value;
      
      // If cash in/out changed, recalculate all balances
      if (col === 'cashin' || col === 'cashout') {
        // Trigger recalculation
        recalculateAllBalances();
        renderSheet();
      } else {
        // For other columns, just update this row
        updateRowDisplay(row);
      }
    }
    
    function recalculateAllBalances() {
      calculatedBalances = [];
      let runningBalance = 0;
      
      data.forEach((row, index) => {
        const cashIn = parseFloat(row.cashin) || 0;
        const cashOut = parseFloat(row.cashout) || 0;
        
        runningBalance = runningBalance + cashIn - cashOut;
        calculatedBalances[index] = runningBalance;
      });
    }
    
    function updateRowDisplay(row) {
      const balanceCell = document.querySelector(`tr:nth-child(${row + 1}) .balance-cell`);
      if (balanceCell && calculatedBalances[row] !== undefined) {
        balanceCell.textContent = calculatedBalances[row] === 0 
          ? '' 
          : calculatedBalances[row].toLocaleString('en-US', {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            });
      }
    }
    
    function handleKeyDown(e) {
      const row = parseInt(e.target.dataset.row);
      const col = e.target.dataset.col;
      const allInputs = Array.from(document.querySelectorAll('input'));
      const currentIndex = allInputs.indexOf(e.target);
      
      // Enter key - move down or add rows
      if (e.key === 'Enter') {
        e.preventDefault();
        
        // Move down, add new row if at bottom
        const nextRowInput = document.querySelector(`input[data-row="${row + 1}"][data-col="${col}"]`);
        if (nextRowInput) {
          nextRowInput.focus();
          nextRowInput.select();
        } else {
          // Add new blank row at the end
          data.push({ date: '', trans: '', ref: '', cashin: '', cashout: '', balance: '' });
          renderSheet();
          
          setTimeout(() => {
            const newInput = document.querySelector(`input[data-row="${row + 1}"][data-col="${col}"]`);
            if (newInput) {
              newInput.focus();
              newInput.select();
            }
          }, 10);
        }
      }
      
      // Tab key
      else if (e.key === 'Tab') {
        e.preventDefault();
        
        if (e.shiftKey) {
          // Shift+Tab - move left
          if (currentIndex > 0) {
            allInputs[currentIndex - 1].focus();
            allInputs[currentIndex - 1].select();
          }
        } else {
          // Tab - move right
          if (currentIndex < allInputs.length - 1) {
            allInputs[currentIndex + 1].focus();
            allInputs[currentIndex + 1].select();
          }
        }
      }
      
      // Arrow keys
      else if (e.key === 'ArrowDown') {
        e.preventDefault();
        const nextInput = document.querySelector(`input[data-row="${row + 1}"][data-col="${col}"]`);
        if (nextInput) {
          nextInput.focus();
          nextInput.select();
        }
      }
      else if (e.key === 'ArrowUp') {
        e.preventDefault();
        const prevInput = document.querySelector(`input[data-row="${row - 1}"][data-col="${col}"]`);
        if (prevInput) {
          prevInput.focus();
          prevInput.select();
        }
      }
      else if (e.key === 'ArrowLeft') {
        if (e.target.selectionStart === 0) {
          e.preventDefault();
          if (currentIndex > 0) {
            allInputs[currentIndex - 1].focus();
            allInputs[currentIndex - 1].select();
          }
        }
      }
      else if (e.key === 'ArrowRight') {
        if (e.target.selectionStart === e.target.value.length) {
          e.preventDefault();
          if (currentIndex < allInputs.length - 1) {
            allInputs[currentIndex + 1].focus();
            allInputs[currentIndex + 1].select();
          }
        }
      }
      
      // Delete row with Ctrl+D
      else if (e.key === 'd' && e.ctrlKey) {
        e.preventDefault();
        if (data.length > 1) {
          data.splice(row, 1);
          recalculateAllBalances();
          renderSheet();
          
          // Focus appropriate cell after deletion
          setTimeout(() => {
            const focusRow = Math.min(row, data.length - 1);
            const focusInput = document.querySelector(`input[data-row="${focusRow}"][data-col="${col}"]`);
            if (focusInput) {
              focusInput.focus();
              focusInput.select();
            }
          }, 10);
        }
      }
      
      // Save with Ctrl+S
      else if (e.key === 's' && e.ctrlKey) {
        e.preventDefault();
        autoSave();
        showMessage('Saved');
      }
      
      // Today's date with Ctrl+T
      else if (e.key === 't' && e.ctrlKey) {
        e.preventDefault();
        const today = new Date();
        const day = today.getDate();
        const month = today.toLocaleString('default', { month: 'short' });
        e.target.value = `${day} ${month}`;
        e.target.dispatchEvent(new Event('input'));
        e.target.select();
      }
      
      // Clear cell with Escape
      else if (e.key === 'Escape') {
        e.target.value = '';
        e.target.dispatchEvent(new Event('input'));
      }
    }
    
    function autoSave() {
      localStorage.setItem('accountSheetFull', JSON.stringify(data));
    }
    
    function showMessage(text) {
      const msg = document.createElement('div');
      msg.textContent = text;
      msg.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 13px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s;
      `;
      document.body.appendChild(msg);
      
      setTimeout(() => msg.style.opacity = '1', 10);
      setTimeout(() => {
        msg.style.opacity = '0';
        setTimeout(() => msg.remove(), 300);
      }, 1500);
    }
    
    // Initialize with sample data if completely empty
    let hasData = false;
    for (let row of data) {
      if (row.date || row.trans || row.ref || row.cashin || row.cashout) {
        hasData = true;
        break;
      }
    }
    
    if (!hasData) {
      // Add your sample data as first 3 rows
      data[0] = { date: '23 Jan', trans: 'top up float', ref: 'chris - hazida', cashin: '5000', cashout: '', balance: '5000' };
      data[1] = { date: '23 Jan', trans: 'purchase of steel', ref: 'dominic', cashin: '', cashout: '500', balance: '4500' };
      data[2] = { date: '23 Jan', trans: 'transport and lunch rations', ref: 'dabson', cashin: '', cashout: '400', balance: '4100' };
      
      // Clear the rest
      for (let i = 3; i < data.length; i++) {
        data[i] = { date: '', trans: '', ref: '', cashin: '', cashout: '', balance: '' };
      }
    }
    
    // Initial render
    recalculateAllBalances();
    renderSheet();
    
    // Focus first cell
    setTimeout(() => {
      const firstInput = document.querySelector('input[data-row="0"][data-col="date"]');
      if (firstInput) {
        firstInput.focus();
        firstInput.select();
      }
    }, 100);
    
    // Auto-save every 30 seconds
    setInterval(autoSave, 30000);
    
    // Handle window resize
    window.addEventListener('resize', () => {
      // Force reflow to ensure proper sizing
      document.getElementById('sheet-container').style.height = window.innerHeight + 'px';
    });
  </script>
</body>
</html>
